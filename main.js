/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var nw=Object.defineProperty;var zY=Object.getOwnPropertyDescriptor;var UY=Object.getOwnPropertyNames;var VY=Object.prototype.hasOwnProperty;var GY=(s,e,t)=>e in s?nw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var WY=(s,e)=>()=>(s&&(e=s(s=0)),e);var sw=(s,e)=>{for(var t in e)nw(s,t,{get:e[t],enumerable:!0})},HY=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of UY(e))!VY.call(s,i)&&i!==t&&nw(s,i,{get:()=>e[i],enumerable:!(n=zY(e,i))||n.enumerable});return s};var jY=s=>HY(nw({},"__esModule",{value:!0}),s);var Z=(s,e,t)=>(GY(s,typeof e!="symbol"?e+"":e,t),t),OC=(s,e,t)=>{if(!e.has(s))throw TypeError("Cannot "+t)};var m=(s,e,t)=>(OC(s,e,"read from private field"),t?t.call(s):e.get(s)),L=(s,e,t)=>{if(e.has(s))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(s):e.set(s,t)},N=(s,e,t,n)=>(OC(s,e,"write to private field"),n?n.call(s,t):e.set(s,t),t);var Ii=(s,e,t,n)=>({set _(i){N(s,e,i,t)},get _(){return m(s,e,n)}}),K=(s,e,t)=>(OC(s,e,"access private method"),t);var GC={};sw(GC,{DEFAULT_CHUNK_OVERLAP:()=>ud,DEFAULT_CHUNK_SIZE:()=>dd,DEFAULT_FEEDBACK_STORE:()=>Bm,DEFAULT_SETTINGS:()=>cd,DEFAULT_USAGE_STORAGE:()=>Bh,DEFAULT_USER_PREFERENCES:()=>iw,GEMINI_PRICING:()=>ow,MIN_CHUNK_SIZE:()=>rw,PARAGRAPH_SPLIT_REGEX:()=>BC,SECTION_SPLIT_REGEX:()=>$C,USAGE_FEATURE_LABELS:()=>zC,USAGE_FILE_DESKTOP:()=>zm,USAGE_FILE_MOBILE:()=>aw,USAGE_FILE_NAME:()=>VC,USAGE_STORAGE_MODE_OPTIONS:()=>UC,createEmptyDailySummary:()=>Um});function Um(s){return{date:s,totalInputTokens:0,totalOutputTokens:0,totalCalls:0,callsByFeature:{classify:0,ocr:0,youtube:0,webpage:0,zk:0,related:0,chat:0,embedding:0,review:0,meeting:0,schedule:0,split:0,focus:0,other:0},estimatedCostUSD:0}}var cd,iw,Bm,dd,ud,rw,$C,BC,ow,zC,UC,VC,zm,aw,Bh,Yo=WY(()=>{cd={geminiApiKey:"",inboxFolder:"00 _Inbox",projectsFolder:"01 Projects",libraryFolder:"02 Library",archivesFolder:"03 Archives",zettelFolder:"10 Zettelkasten",autoWatch:!0,triggerTag:"#\uC644\uB8CC",language:"ko",ocrEnabled:!0,ocrAutoProcess:!1,ocrMoveOriginal:!0,ocrOriginalFolder:"03 Archives/OCR_\uC6D0\uBCF8",ocrMinTextThreshold:50,ocrMaxPages:20,ocrMaxFileSizeMB:10,ocrDailyLimit:50,detailedSummary:!1,zkIdType:"date-sequence",zkMergeThreshold:.8,timezone:"auto",dateFormat:"local",scheduleDetectionEnabled:!0,dailyNotesFolder:"00 _Inbox",googleCalendarEnabled:!1,useOwnApiKey:!1,googleClientId:"",googleClientSecret:"",googleAccessToken:"",googleRefreshToken:"",googleTokenExpiry:0,calendarEnabled:!0,calendarDefaultView:"month",calendarFirstDayOfWeek:0,showMiniCalendar:!0,calendarEngine:"fullcalendar",embeddingEnabled:!1,embeddingSimilarityThreshold:.7,autoEmbeddingEnabled:!0,embeddingChunkSize:500,embeddingChunkOverlap:50,ragEnabled:!0,ragTopK:5,ragMaxContextLength:8e3,onboardingCompleted:!1,preset:"custom",lastNotifiedVersion:void 0,dataStorageLocation:"plugin",dataFolderPath:".zfb-data",youtubeTemplate:`---
type: youtube
source: "{{url}}"
title: "{{escapedTitle}}"
created: {{date}}
---

# {{title}}

{{iframe}}

## \uC694\uC57D
{{summary}}

## \uD575\uC2EC \uD3EC\uC778\uD2B8
{{keyPoints}}
`,webpageTemplate:`---
type: webpage
source: "{{url}}"
title: "{{escapedTitle}}"
created: {{date}}
---

# {{title}}

{{bookmark}}

{{iframe}}

## \uC694\uC57D
{{summary}}

## \uD575\uC2EC \uD3EC\uC778\uD2B8
{{keyPoints}}
`,usageTrackingEnabled:!1,usageStorageMode:"daily30",usageShowStatusBar:!0},iw={version:1,feedback:{referenceLocation:{toLibrary:0,toProject:0,preference:"neutral"},scheduleDetection:{accepted:0,rejected:0,falsePositivePatterns:[]},projectClassification:{corrections:[]}},restructure:{accepted:0,rejected:0,preferredFormats:[],preference:"neutral"},embedding:{acceptedPairs:[],rejectedPairs:[],similarityThresholdAdjustment:0},rag:{frequentQuestions:[],preferredNotes:[],feedbackOnAnswers:{helpful:0,notHelpful:0}}},Bm={version:1,entries:[],preferences:iw,lastUpdated:new Date().toISOString()},dd=500,ud=50,rw=100,$C=/(?=^## )/m,BC=/\n\n+/,ow={"gemini-3-flash-preview":{inputPer1M:.5,outputPer1M:3},"gemini-2.0-flash":{inputPer1M:.1,outputPer1M:.4},"gemini-2.0-flash-lite":{inputPer1M:.075,outputPer1M:.3},"gemini-1.5-flash":{inputPer1M:.075,outputPer1M:.3},"gemini-1.5-pro":{inputPer1M:1.25,outputPer1M:5},"text-embedding-004":{inputPer1M:0,outputPer1M:0},"gemini-embedding-001":{inputPer1M:.15,outputPer1M:0}},zC={classify:"\uBD84\uB958",ocr:"OCR",youtube:"YouTube",webpage:"\uC6F9\uD398\uC774\uC9C0",zk:"ZK \uCD94\uCD9C",related:"\uAD00\uB828 \uB178\uD2B8",chat:"\uCC57\uBD07",embedding:"\uC784\uBCA0\uB529",review:"\uD68C\uACE0",meeting:"\uD68C\uC758\uB85D",schedule:"\uC77C\uC815",split:"\uBD84\uB9AC",focus:"Focus",other:"\uAE30\uD0C0"},UC=[{value:"today",label:"\uC624\uB298\uB9CC",desc:"\uC571 \uC7AC\uC2DC\uC791 \uC2DC \uCD08\uAE30\uD654"},{value:"daily30",label:"\uC77C\uBCC4 30\uC77C",desc:"\uCD5C\uADFC 30\uC77C \uB370\uC774\uD130 \uBCF4\uAD00"},{value:"daily90",label:"\uC77C\uBCC4 90\uC77C",desc:"\uCD5C\uADFC 90\uC77C \uB370\uC774\uD130 \uBCF4\uAD00"},{value:"monthly12",label:"\uC6D4\uBCC4 12\uAC1C\uC6D4",desc:"\uC6D4\uBCC4 \uC9D1\uACC4 12\uAC1C\uC6D4 \uBCF4\uAD00"}],VC="usage.json",zm="usage-desktop.json",aw="usage-mobile.json",Bh={version:1,storageMode:"daily30",dailySummaries:[],monthlySummaries:[],lastUpdated:new Date().toISOString()}});var Zae={};sw(Zae,{default:()=>lS});module.exports=jY(Zae);var we=require("obsidian");Yo();var kB=require("obsidian");Yo();var lw=class{constructor(e,t,n){this.statusBarEl=null;this.saveDebounceTimer=null;this.app=e,this.settings=t,this.getDataPath=n,this.storage={...Bh},this.mergedStorage={...Bh}}getCurrentPlatformFileName(){return kB.Platform.isMobile?aw:zm}setStatusBarEl(e){this.statusBarEl=e,this.updateStatusBar()}updateSettings(e){this.settings=e}recordUsage(e,t,n,i){if(!this.settings.usageTrackingEnabled)return;let r=this.getTodayDate(),o=this.calculateCost(t,n,i);this.updateDailySummary(this.storage,r,e,t,n,o),this.updateDailySummary(this.mergedStorage,r,e,t,n,o),this.updateStatusBar(),this.debouncedSave()}updateDailySummary(e,t,n,i,r,o){let a=e.dailySummaries.find(l=>l.date===t);a||(a=Um(t),e.dailySummaries.push(a)),a.totalInputTokens+=i,a.totalOutputTokens+=r,a.totalCalls+=1,a.callsByFeature[n]=(a.callsByFeature[n]||0)+1,a.estimatedCostUSD+=o}getTodayUsage(){let e=this.getTodayDate();return this.mergedStorage.dailySummaries.find(t=>t.date===e)||null}getThisMonthUsage(){let e=this.getTodayDate().substring(0,7),t=this.mergedStorage.dailySummaries.filter(n=>n.date.startsWith(e));return{inputTokens:t.reduce((n,i)=>n+i.totalInputTokens,0),outputTokens:t.reduce((n,i)=>n+i.totalOutputTokens,0),calls:t.reduce((n,i)=>n+i.totalCalls,0),cost:t.reduce((n,i)=>n+i.estimatedCostUSD,0)}}getUsageHistory(e){let t=new Date;t.setDate(t.getDate()-e);let n=t.toISOString().split("T")[0];return this.mergedStorage.dailySummaries.filter(i=>i.date>=n).sort((i,r)=>r.date.localeCompare(i.date))}calculateCost(e,t,n){let i=ow[n]||ow["gemini-3-flash-preview"],r=e/1e6*i.inputPer1M,o=t/1e6*i.outputPer1M;return r+o}updateStatusBar(){if(!this.statusBarEl||!this.settings.usageShowStatusBar){this.statusBarEl&&this.statusBarEl.empty();return}let e=this.getTodayUsage();if(!e){this.statusBarEl.setText("\u{1F9E0} 0/0");return}let t=r=>r>=1e3?(r/1e3).toFixed(1)+"K":r.toString(),n=t(e.totalInputTokens),i=t(e.totalOutputTokens);this.statusBarEl.setText(`\u{1F9E0} ${n}/${i}`)}pruneOldData(){let e=this.settings.usageStorageMode,t=new Date;switch(e){case"today":let n=this.getTodayDate();this.storage.dailySummaries=this.storage.dailySummaries.filter(c=>c.date===n);break;case"daily30":let i=new Date(t);i.setDate(i.getDate()-30),this.storage.dailySummaries=this.storage.dailySummaries.filter(c=>c.date>=i.toISOString().split("T")[0]);break;case"daily90":let r=new Date(t);r.setDate(r.getDate()-90),this.storage.dailySummaries=this.storage.dailySummaries.filter(c=>c.date>=r.toISOString().split("T")[0]);break;case"monthly12":this.aggregateToMonthly();let o=new Date(t);o.setMonth(o.getMonth()-12);let a=o.toISOString().substring(0,7);this.storage.monthlySummaries=(this.storage.monthlySummaries||[]).filter(c=>c.month>=a);let l=t.toISOString().substring(0,7);this.storage.dailySummaries=this.storage.dailySummaries.filter(c=>c.date.startsWith(l));break}this.storage.storageMode=e}async saveUsage(){let e=this.getDataPath(),t=this.getCurrentPlatformFileName(),n=`${e}/${t}`;this.storage.lastUpdated=new Date().toISOString();try{await this.app.vault.adapter.write(n,JSON.stringify(this.storage,null,2))}catch(i){console.error("[UsageTracker] \uC800\uC7A5 \uC2E4\uD328:",i)}}async loadUsage(){let e=this.getDataPath(),t=this.app.vault.adapter;await this.migrateLegacyFile(e);let n=await this.loadPlatformFile(e,zm),i=await this.loadPlatformFile(e,aw),r=this.getCurrentPlatformFileName();this.storage=r===zm?n:i,this.mergedStorage=this.mergeDailyData(n,i),this.storage.storageMode!==this.settings.usageStorageMode&&this.pruneOldData(),this.updateStatusBar()}async migrateLegacyFile(e){let t=this.app.vault.adapter,n=`${e}/${VC}`,i=`${e}/${this.getCurrentPlatformFileName()}`;try{if(await t.exists(n)&&!await t.exists(i)){let r=await t.read(n);await t.write(i,r),await t.remove(n),console.log("[UsageTracker] \uB808\uAC70\uC2DC \uD30C\uC77C \uB9C8\uC774\uADF8\uB808\uC774\uC158 \uC644\uB8CC")}}catch(r){console.error("[UsageTracker] \uB9C8\uC774\uADF8\uB808\uC774\uC158 \uC2E4\uD328:",r)}}async loadPlatformFile(e,t){let n=this.app.vault.adapter,i=`${e}/${t}`;try{if(await n.exists(i)){let r=await n.read(i);return JSON.parse(r)}}catch(r){console.error(`[UsageTracker] ${t} \uB85C\uB4DC \uC2E4\uD328:`,r)}return{...Bh}}mergeDailyData(e,t){let n={version:1,storageMode:this.settings.usageStorageMode,dailySummaries:[],monthlySummaries:[],lastUpdated:new Date().toISOString()},i=new Set;e.dailySummaries.forEach(r=>i.add(r.date)),t.dailySummaries.forEach(r=>i.add(r.date));for(let r of i){let o=e.dailySummaries.find(c=>c.date===r),a=t.dailySummaries.find(c=>c.date===r),l=Um(r);if(o){l.totalInputTokens+=o.totalInputTokens,l.totalOutputTokens+=o.totalOutputTokens,l.totalCalls+=o.totalCalls,l.estimatedCostUSD+=o.estimatedCostUSD;for(let[c,d]of Object.entries(o.callsByFeature))l.callsByFeature[c]=(l.callsByFeature[c]||0)+d}if(a){l.totalInputTokens+=a.totalInputTokens,l.totalOutputTokens+=a.totalOutputTokens,l.totalCalls+=a.totalCalls,l.estimatedCostUSD+=a.estimatedCostUSD;for(let[c,d]of Object.entries(a.callsByFeature))l.callsByFeature[c]=(l.callsByFeature[c]||0)+d}n.dailySummaries.push(l)}return n.dailySummaries.sort((r,o)=>o.date.localeCompare(r.date)),n}async resetUsage(){this.storage={...Bh},this.storage.storageMode=this.settings.usageStorageMode,await this.saveUsage(),await this.loadUsage()}exportToCSV(){let e=["Date","Input Tokens","Output Tokens","Total Calls","Estimated Cost (USD)","classify","ocr","youtube","webpage","zk","related","chat","embedding","review","meeting","schedule","split","focus","other"],t=this.mergedStorage.dailySummaries.map(n=>[n.date,n.totalInputTokens,n.totalOutputTokens,n.totalCalls,n.estimatedCostUSD.toFixed(6),n.callsByFeature.classify||0,n.callsByFeature.ocr||0,n.callsByFeature.youtube||0,n.callsByFeature.webpage||0,n.callsByFeature.zk||0,n.callsByFeature.related||0,n.callsByFeature.chat||0,n.callsByFeature.embedding||0,n.callsByFeature.review||0,n.callsByFeature.meeting||0,n.callsByFeature.schedule||0,n.callsByFeature.split||0,n.callsByFeature.focus||0,n.callsByFeature.other||0]);return[e.join(","),...t.map(n=>n.join(","))].join(`
`)}getTodayDate(){return new Date().toISOString().split("T")[0]}debouncedSave(){this.saveDebounceTimer&&clearTimeout(this.saveDebounceTimer),this.saveDebounceTimer=setTimeout(()=>{this.saveUsage(),this.saveDebounceTimer=null},5e3)}aggregateToMonthly(){let e=new Map;for(let n of this.storage.dailySummaries){let i=n.date.substring(0,7),r=e.get(i);r||(r={month:i,totalInputTokens:0,totalOutputTokens:0,totalCalls:0,callsByFeature:{...Um("").callsByFeature},estimatedCostUSD:0,dailyAverage:{inputTokens:0,outputTokens:0,calls:0}},e.set(i,r)),r.totalInputTokens+=n.totalInputTokens,r.totalOutputTokens+=n.totalOutputTokens,r.totalCalls+=n.totalCalls,r.estimatedCostUSD+=n.estimatedCostUSD;for(let[o,a]of Object.entries(n.callsByFeature))r.callsByFeature[o]=(r.callsByFeature[o]||0)+a}for(let n of e.values()){let i=this.storage.dailySummaries.filter(r=>r.date.startsWith(n.month)).length;i>0&&(n.dailyAverage={inputTokens:Math.round(n.totalInputTokens/i),outputTokens:Math.round(n.totalOutputTokens/i),calls:Math.round(n.totalCalls/i)})}let t=new Map((this.storage.monthlySummaries||[]).map(n=>[n.month,n]));for(let[n,i]of e)t.set(n,i);this.storage.monthlySummaries=Array.from(t.values()).sort((n,i)=>i.month.localeCompare(n.month))}};var ft=require("obsidian");var RB=[{value:"auto",label:"\uC790\uB3D9 \uAC10\uC9C0"},{value:"Asia/Seoul",label:"\uD55C\uAD6D (KST, UTC+9)"},{value:"Asia/Tokyo",label:"\uC77C\uBCF8 (JST, UTC+9)"},{value:"Asia/Shanghai",label:"\uC911\uAD6D (CST, UTC+8)"},{value:"America/New_York",label:"\uBBF8\uAD6D \uB3D9\uBD80 (EST/EDT)"},{value:"America/Los_Angeles",label:"\uBBF8\uAD6D \uC11C\uBD80 (PST/PDT)"},{value:"Europe/London",label:"\uC601\uAD6D (GMT/BST)"},{value:"UTC",label:"UTC"}],FB=[{value:"iso",label:"ISO \uD615\uC2DD (2026-01-05T16:24:45+09:00)"},{value:"local",label:"\uB85C\uCEEC \uD615\uC2DD (2026-01-05 16:24:45)"},{value:"friendly",label:"\uCE5C\uADFC\uD55C \uD615\uC2DD (2026\uB144 1\uC6D4 5\uC77C 16:24)"}];function cw(s){return s==="auto"?Intl.DateTimeFormat().resolvedOptions().timeZone:s}function WC(s,e,t){let n=cw(e);switch(t){case"iso":return qY(s,n);case"local":return IB(s,n);case"friendly":return KY(s,n);default:return IB(s,n)}}function qY(s,e){let t={timeZone:e,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1},n=new Intl.DateTimeFormat("en-CA",t).formatToParts(s),i=h=>n.find(p=>p.type===h)?.value||"",r=i("year"),o=i("month"),a=i("day"),l=i("hour"),c=i("minute"),d=i("second"),u=YY(s,e);return`${r}-${o}-${a}T${l}:${c}:${d}${u}`}function IB(s,e){let t={timeZone:e,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1},n=new Intl.DateTimeFormat("en-CA",t).formatToParts(s),i=u=>n.find(h=>h.type===u)?.value||"",r=i("year"),o=i("month"),a=i("day"),l=i("hour"),c=i("minute"),d=i("second");return`${r}-${o}-${a} ${l}:${c}:${d}`}function KY(s,e){let t={timeZone:e,year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1};return new Intl.DateTimeFormat("ko-KR",t).format(s)}function YY(s,e){let t=new Date(s.toLocaleString("en-US",{timeZone:"UTC"})),i=(new Date(s.toLocaleString("en-US",{timeZone:e})).getTime()-t.getTime())/(1e3*60);if(i===0)return"Z";let r=i>=0?"+":"-",o=Math.abs(i),a=Math.floor(o/60),l=o%60;return`${r}${String(a).padStart(2,"0")}:${String(l).padStart(2,"0")}`}function $s(s,e){let n={timeZone:cw(e),year:"numeric",month:"2-digit",day:"2-digit"},i=new Intl.DateTimeFormat("en-CA",n).formatToParts(s),r=o=>i.find(a=>a.type===o)?.value||"";return`${r("year")}-${r("month")}-${r("day")}`}function Ps(s,e){return WC(new Date,s,e)}function Xo(s){return $s(new Date,s)}function Vm(s,e){let t=cw(e),n=new Date;switch(s){case"today":return DB(n,t);case"week":return XY(n,t);case"month":return QY(n,t);default:return DB(n,t)}}function DB(s,e){let t=HC(s,e),n=jC(s,e);return{start:t,end:n,label:"\uC624\uB298"}}function XY(s,e){let t=s.getDay(),n=t===0?6:t-1,i=new Date(s);i.setDate(i.getDate()-n);let r=new Date(i);return r.setDate(r.getDate()+6),{start:HC(i,e),end:jC(r,e),label:"\uC774\uBC88 \uC8FC"}}function QY(s,e){let t=new Date(s.getFullYear(),s.getMonth(),1),n=new Date(s.getFullYear(),s.getMonth()+1,0);return{start:HC(t,e),end:jC(n,e),label:"\uC774\uBC88 \uB2EC"}}function HC(s,e){let t=new Date(s);return t.setHours(0,0,0,0),t}function jC(s,e){let t=new Date(s);return t.setHours(23,59,59,999),t}function LB(s,e){return s>=e.start&&s<=e.end}function qC(s){let e=new Date(Date.UTC(s.getFullYear(),s.getMonth(),s.getDate())),t=e.getUTCDay()||7;e.setUTCDate(e.getUTCDate()+4-t);let n=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e.getTime()-n.getTime())/864e5+1)/7)}function NB(s,e,t){let n=cw(t);switch(s){case"today":return`${$s(e,n)} \uC77C\uC77C \uD68C\uACE0.md`;case"week":let i=qC(e);return`${e.getFullYear()}-W${String(i).padStart(2,"0")} \uC8FC\uAC04 \uD68C\uACE0.md`;case"month":return`${$s(e,n).substring(0,7)} \uC6D4\uAC04 \uD68C\uACE0.md`;default:return`${$s(e,n)} \uD68C\uACE0.md`}}function OB(s){let t=new Date().getTime()-s.getTime(),n=Math.floor(t/(1e3*60)),i=Math.floor(t/(1e3*60*60)),r=Math.floor(t/(1e3*60*60*24));return n<1?"\uBC29\uAE08 \uC804":n<60?`${n}\uBD84 \uC804`:i<24?`${i}\uC2DC\uAC04 \uC804`:r===1?"\uC5B4\uC81C":r<7?`${r}\uC77C \uC804`:r<30?`${Math.floor(r/7)}\uC8FC \uC804`:`${Math.floor(r/30)}\uAC1C\uC6D4 \uC804`}var KC=4,$B="https://aistudio.google.com/app/apikey",dw={basic:{autoWatch:!1,ocrEnabled:!0,embeddingEnabled:!1,ragEnabled:!1,calendarEnabled:!1,scheduleDetectionEnabled:!1,googleCalendarEnabled:!1,showMiniCalendar:!1},power:{autoWatch:!0,ocrEnabled:!0,embeddingEnabled:!0,ragEnabled:!0,calendarEnabled:!0,scheduleDetectionEnabled:!0,googleCalendarEnabled:!1,showMiniCalendar:!0},experimental:{autoWatch:!0,ocrEnabled:!0,embeddingEnabled:!0,ragEnabled:!0,calendarEnabled:!0,scheduleDetectionEnabled:!0,googleCalendarEnabled:!1,showMiniCalendar:!0},custom:{}},Vi={basic:{icon:"\u{1F680}",label:"\uAE30\uBCF8 \uBAA8\uB4DC",shortDesc:"\uBD84\uB958 + URL \uC694\uC57D",longDesc:`\uB178\uD2B8 \uBD84\uB958 + URL \uC694\uC57D
\uAC00\uBCCD\uAC8C \uC2DC\uC791\uD558\uAE30 \uC88B\uC544\uC694`},power:{icon:"\u{1F4AA}",label:"\uD30C\uC6CC \uBAA8\uB4DC (\uAD8C\uC7A5)",shortDesc:"\uC804\uCCB4 \uAE30\uB2A5",longDesc:`\uC804\uCCB4 \uAE30\uB2A5 \uD65C\uC131\uD654
Embedding, RAG \uCC57\uBD07, \uCE98\uB9B0\uB354`},experimental:{icon:"\u{1F9EA}",label:"\uC2E4\uD5D8 \uBAA8\uB4DC",shortDesc:"Beta \uD3EC\uD568",longDesc:`Beta \uAE30\uB2A5 \uD3EC\uD568
\uC0C8\uB85C\uC6B4 \uAE30\uB2A5\uC744 \uBA3C\uC800 \uCCB4\uD5D8`},custom:{icon:"\u2699\uFE0F",label:"\uC0AC\uC6A9\uC790 \uC815\uC758",shortDesc:"\uC9C1\uC811 \uC124\uC815",longDesc:"\uAC1C\uBCC4 \uC124\uC815\uC744 \uC9C1\uC811 \uC870\uC815\uD569\uB2C8\uB2E4"}},uw=["geminiApiKey","googleAccessToken","googleRefreshToken","googleClientId","googleClientSecret","googleTokenExpiry","inboxFolder","projectsFolder","libraryFolder","archivesFolder","zettelFolder","dailyNotesFolder","ocrOriginalFolder","timezone","dateFormat","zkIdType","onboardingCompleted","lastNotifiedVersion","language","dataStorageLocation","dataFolderPath","autoEmbeddingEnabled"],ws="ZFB: ",Dr={EMBEDDINGS:"embeddings.json",EMBEDDINGS_DESKTOP:"embeddings-desktop.json",EMBEDDINGS_MOBILE:"embeddings-mobile.json",CHATS:"chats.json",FEEDBACK:"feedback.json"},zh=".obsidian/plugins/zero-friction-brain";Yo();var hw=class extends ft.PluginSettingTab{constructor(t,n){super(t,n);this.showAdvancedSettings=!1;this.plugin=n}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Zero Friction Brain \uC124\uC815"}),t.createEl("h3",{text:"\uBE60\uB978 \uC2DC\uC791"});let n=this.plugin.settings.preset||"custom";new ft.Setting(t).setName("\uC124\uC815 \uD504\uB9AC\uC14B").setDesc("\uC0AC\uC6A9 \uD328\uD134\uC5D0 \uB9DE\uB294 \uD504\uB9AC\uC14B\uC744 \uC120\uD0DD\uD558\uC138\uC694").addDropdown(a=>a.addOption("basic",`${Vi.basic.icon} ${Vi.basic.label}`).addOption("power",`${Vi.power.icon} ${Vi.power.label}`).addOption("experimental",`${Vi.experimental.icon} ${Vi.experimental.label}`).addOption("custom",`${Vi.custom.icon} ${Vi.custom.label}`).setValue(n).onChange(async l=>{let c=l;c!=="custom"?(this.applyPreset(c),new ft.Notice(`${Vi[c].icon} ${Vi[c].label} \uC801\uC6A9\uB428`)):(this.plugin.settings.preset="custom",await this.plugin.saveSettings()),this.display()}));let i=t.createDiv({cls:"zfb-preset-description"});if(this.renderPresetDescription(i,n),n!=="custom"&&(new ft.Setting(t).setName("\uACE0\uAE09 \uC124\uC815 \uD45C\uC2DC").setDesc("\uC138\uBD80 \uC124\uC815\uC744 \uC9C1\uC811 \uC870\uC815\uD569\uB2C8\uB2E4").addToggle(a=>a.setValue(this.showAdvancedSettings).onChange(l=>{this.showAdvancedSettings=l,this.display()})),!this.showAdvancedSettings))return;if(t.createEl("hr"),t.createEl("h3",{text:"API \uC124\uC815"}),new ft.Setting(t).setName("Gemini API \uD0A4").setDesc(createFragment(a=>{a.appendText("Gemini API \uD0A4\uB97C \uC785\uB825\uD558\uC138\uC694. "),a.createEl("a",{text:"API \uD0A4 \uBC1C\uAE09\uBC1B\uAE30",href:"https://aistudio.google.com/apikey"})})).addText(a=>a.setPlaceholder("AIzaSy...").setValue(this.plugin.settings.geminiApiKey).onChange(async l=>{this.plugin.settings.geminiApiKey=l,await this.plugin.saveSettings()})),t.createEl("h3",{text:"\uD3F4\uB354 \uC124\uC815"}),new ft.Setting(t).setName("Inbox \uD3F4\uB354").setDesc("\uC0C8 \uB178\uD2B8\uAC00 \uC800\uC7A5\uB418\uB294 \uD3F4\uB354").addText(a=>a.setPlaceholder("00 _Inbox").setValue(this.plugin.settings.inboxFolder).onChange(async l=>{this.plugin.settings.inboxFolder=l,await this.plugin.saveSettings()})),new ft.Setting(t).setName("Projects \uD3F4\uB354").setDesc("\uD504\uB85C\uC81D\uD2B8\uBCC4 \uD558\uC704 \uD3F4\uB354\uAC00 \uC0DD\uC131\uB429\uB2C8\uB2E4").addText(a=>a.setPlaceholder("01 Projects").setValue(this.plugin.settings.projectsFolder).onChange(async l=>{this.plugin.settings.projectsFolder=l,await this.plugin.saveSettings()})),new ft.Setting(t).setName("Library \uD3F4\uB354").setDesc("\uD504\uB85C\uC81D\uD2B8\uC5D0 \uC18D\uD558\uC9C0 \uC54A\uB294 \uCC38\uACE0 \uC790\uB8CC").addText(a=>a.setPlaceholder("02 Library").setValue(this.plugin.settings.libraryFolder).onChange(async l=>{this.plugin.settings.libraryFolder=l,await this.plugin.saveSettings()})),new ft.Setting(t).setName("Archives \uD3F4\uB354").setDesc("\uC644\uB8CC\uB41C \uD504\uB85C\uC81D\uD2B8 (\uD1B5\uC9F8\uB85C \uC774\uB3D9)").addText(a=>a.setPlaceholder("03 Archives").setValue(this.plugin.settings.archivesFolder).onChange(async l=>{this.plugin.settings.archivesFolder=l,await this.plugin.saveSettings()})),new ft.Setting(t).setName("Zettelkasten \uD3F4\uB354").setDesc("ZK \uC601\uAD6C \uB178\uD2B8 \uC800\uC7A5 \uC704\uCE58").addText(a=>a.setPlaceholder("10 Zettelkasten").setValue(this.plugin.settings.zettelFolder).onChange(async l=>{this.plugin.settings.zettelFolder=l,await this.plugin.saveSettings()})),new ft.Setting(t).setName("\uD3F4\uB354 \uAD6C\uC870 \uC0DD\uC131").setDesc("\uC704\uC5D0 \uC124\uC815\uB41C \uD3F4\uB354\uB4E4\uC744 \uC790\uB3D9\uC73C\uB85C \uC0DD\uC131\uD569\uB2C8\uB2E4").addButton(a=>a.setButtonText("\uD3F4\uB354 \uC0DD\uC131").setCta().onClick(async()=>{await this.createFolderStructure()})),t.createEl("h3",{text:"\uC635\uC158"}),new ft.Setting(t).setName("Inbox \uC790\uB3D9 \uAC10\uC2DC").setDesc("Inbox \uD3F4\uB354\uC758 \uD30C\uC77C\uC744 \uC790\uB3D9\uC73C\uB85C \uAC10\uC2DC\uD558\uC5EC \uBD84\uB958").addToggle(a=>a.setValue(this.plugin.settings.autoWatch).onChange(async l=>{this.plugin.settings.autoWatch=l,await this.plugin.saveSettings(),l?this.plugin.startWatcher():this.plugin.stopWatcher()})),new ft.Setting(t).setName("\uD2B8\uB9AC\uAC70 \uD0DC\uADF8").setDesc("\uC774 \uD0DC\uADF8\uAC00 \uC788\uB294 \uB178\uD2B8\uB9CC \uC790\uB3D9 \uBD84\uB958 (\uC608: #\uC644\uB8CC)").addText(a=>a.setPlaceholder("#\uC644\uB8CC").setValue(this.plugin.settings.triggerTag).onChange(async l=>{this.plugin.settings.triggerTag=l,await this.plugin.saveSettings()})),t.createEl("h3",{text:"OCR \uC124\uC815"}),new ft.Setting(t).setName("OCR \uAE30\uB2A5 \uD65C\uC131\uD654").setDesc("\uC774\uBBF8\uC9C0 \uBC0F PDF\uC5D0\uC11C \uD14D\uC2A4\uD2B8 \uCD94\uCD9C").addToggle(a=>a.setValue(this.plugin.settings.ocrEnabled).onChange(async l=>{this.plugin.settings.ocrEnabled=l,await this.plugin.saveSettings()})),new ft.Setting(t).setName("OCR \uD6C4 \uC6D0\uBCF8 \uC774\uB3D9").setDesc("OCR \uCC98\uB9AC \uD6C4 \uC6D0\uBCF8 \uD30C\uC77C\uC744 \uC9C0\uC815 \uD3F4\uB354\uB85C \uC774\uB3D9").addToggle(a=>a.setValue(this.plugin.settings.ocrMoveOriginal).onChange(async l=>{this.plugin.settings.ocrMoveOriginal=l,await this.plugin.saveSettings()})),new ft.Setting(t).setName("\uC6D0\uBCF8 \uD30C\uC77C \uC774\uB3D9 \uD3F4\uB354").setDesc("OCR \uCC98\uB9AC \uD6C4 \uC6D0\uBCF8 \uD30C\uC77C\uC774 \uC774\uB3D9\uB420 \uD3F4\uB354").addText(a=>a.setPlaceholder("03 Archives/OCR_\uC6D0\uBCF8").setValue(this.plugin.settings.ocrOriginalFolder).onChange(async l=>{this.plugin.settings.ocrOriginalFolder=l,await this.plugin.saveSettings()})),t.createEl("h3",{text:"OCR \uC81C\uD55C (API \uC694\uAE08 \uBCF4\uD638)"}),new ft.Setting(t).setName("\uCD5C\uB300 \uD398\uC774\uC9C0 \uC218").setDesc("\uD55C \uBC88\uC5D0 \uCC98\uB9AC\uD560 \uC218 \uC788\uB294 \uCD5C\uB300 PDF \uD398\uC774\uC9C0 \uC218").addSlider(a=>a.setLimits(1,100,1).setValue(this.plugin.settings.ocrMaxPages).setDynamicTooltip().onChange(async l=>{this.plugin.settings.ocrMaxPages=l,await this.plugin.saveSettings()})).addExtraButton(a=>a.setIcon("reset").setTooltip("\uAE30\uBCF8\uAC12 (20)").onClick(async()=>{this.plugin.settings.ocrMaxPages=20,await this.plugin.saveSettings(),this.display()})),new ft.Setting(t).setName("\uCD5C\uB300 \uD30C\uC77C \uD06C\uAE30 (MB)").setDesc("\uCC98\uB9AC\uD560 \uC218 \uC788\uB294 \uCD5C\uB300 \uD30C\uC77C \uD06C\uAE30").addSlider(a=>a.setLimits(1,50,1).setValue(this.plugin.settings.ocrMaxFileSizeMB).setDynamicTooltip().onChange(async l=>{this.plugin.settings.ocrMaxFileSizeMB=l,await this.plugin.saveSettings()})).addExtraButton(a=>a.setIcon("reset").setTooltip("\uAE30\uBCF8\uAC12 (10)").onClick(async()=>{this.plugin.settings.ocrMaxFileSizeMB=10,await this.plugin.saveSettings(),this.display()})),new ft.Setting(t).setName("\uC77C\uC77C \uCC98\uB9AC \uD55C\uB3C4 (\uD398\uC774\uC9C0)").setDesc("\uD558\uB8E8\uC5D0 OCR \uCC98\uB9AC\uD560 \uC218 \uC788\uB294 \uCD5C\uB300 \uD398\uC774\uC9C0 \uC218").addSlider(a=>a.setLimits(10,500,10).setValue(this.plugin.settings.ocrDailyLimit).setDynamicTooltip().onChange(async l=>{this.plugin.settings.ocrDailyLimit=l,await this.plugin.saveSettings()})).addExtraButton(a=>a.setIcon("reset").setTooltip("\uAE30\uBCF8\uAC12 (50)").onClick(async()=>{this.plugin.settings.ocrDailyLimit=50,await this.plugin.saveSettings(),this.display()})),t.createDiv({cls:"ocr-usage-info"}).createEl("p",{text:`\uC624\uB298 \uC0AC\uC6A9\uB7C9: ${this.plugin.getOCRDailyUsage().pagesProcessed}/${this.plugin.settings.ocrDailyLimit} \uD398\uC774\uC9C0`,cls:"setting-item-description"}),t.createEl("h3",{text:"AI \uC694\uC57D \uC124\uC815"}),new ft.Setting(t).setName("\uC0C1\uC138 \uC694\uC57D").setDesc("\uD65C\uC131\uD654 \uC2DC \uB354 \uAE34 \uC694\uC57D(8-15\uBB38\uC7A5)\uACFC \uB354 \uB9CE\uC740 \uD575\uC2EC \uD3EC\uC778\uD2B8(10-20\uAC1C)\uB97C \uC0DD\uC131\uD569\uB2C8\uB2E4. OCR, YouTube, \uC6F9\uD398\uC774\uC9C0 \uC694\uC57D\uC5D0 \uC801\uC6A9\uB429\uB2C8\uB2E4.").addToggle(a=>a.setValue(this.plugin.settings.detailedSummary).onChange(async l=>{this.plugin.settings.detailedSummary=l,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Zettelkasten \uC124\uC815"}),new ft.Setting(t).setName("ZK \uB178\uD2B8 ID \uD615\uC2DD").setDesc("ZK \uB178\uD2B8 \uD30C\uC77C\uBA85\uC5D0 \uC0AC\uC6A9\uD560 ID \uD615\uC2DD").addDropdown(a=>a.addOption("timestamp","\uD0C0\uC784\uC2A4\uD0EC\uD504 (1735789200000)").addOption("date-sequence","\uB0A0\uC9DC+\uC21C\uBC88 (20260102-001)").addOption("luhmann","\uB8E8\uB9CC \uC2A4\uD0C0\uC77C (1a1b)").setValue(this.plugin.settings.zkIdType).onChange(async l=>{this.plugin.settings.zkIdType=l,await this.plugin.saveSettings()})),new ft.Setting(t).setName("\uC720\uC0AC \uB178\uD2B8 \uBCD1\uD569 \uC784\uACC4\uAC12").setDesc("\uC774 \uAC12 \uC774\uC0C1\uC758 \uC720\uC0AC\uB3C4\uB97C \uAC00\uC9C4 \uB178\uD2B8\uAC00 \uC788\uC73C\uBA74 \uBCD1\uD569 \uC81C\uC548 (0.5~1.0)").addSlider(a=>a.setLimits(.5,1,.05).setValue(this.plugin.settings.zkMergeThreshold).setDynamicTooltip().onChange(async l=>{this.plugin.settings.zkMergeThreshold=l,await this.plugin.saveSettings()})).addExtraButton(a=>a.setIcon("reset").setTooltip("\uAE30\uBCF8\uAC12 (0.8)").onClick(async()=>{this.plugin.settings.zkMergeThreshold=.8,await this.plugin.saveSettings(),this.display()})),t.createEl("h3",{text:"\uC2DC\uAC04\uB300 \uBC0F \uB0A0\uC9DC \uD615\uC2DD"}),new ft.Setting(t).setName("\uC2DC\uAC04\uB300").setDesc("\uD0C0\uC784\uC2A4\uD0EC\uD504\uC5D0 \uC0AC\uC6A9\uD560 \uC2DC\uAC04\uB300").addDropdown(a=>{RB.forEach(l=>{a.addOption(l.value,l.label)}),a.setValue(this.plugin.settings.timezone).onChange(async l=>{this.plugin.settings.timezone=l,await this.plugin.saveSettings()})}),new ft.Setting(t).setName("\uB0A0\uC9DC \uD615\uC2DD").setDesc("\uD0C0\uC784\uC2A4\uD0EC\uD504 \uD45C\uC2DC \uD615\uC2DD").addDropdown(a=>{FB.forEach(l=>{a.addOption(l.value,l.label)}),a.setValue(this.plugin.settings.dateFormat).onChange(async l=>{this.plugin.settings.dateFormat=l,await this.plugin.saveSettings()})}),t.createEl("h3",{text:"\uC77C\uC815 \uAC10\uC9C0"}),new ft.Setting(t).setName("\uC77C\uC815 \uC790\uB3D9 \uAC10\uC9C0").setDesc("\uB178\uD2B8 \uBD84\uB958 \uC2DC \uC77C\uC815/\uD560\uC77C/\uC57D\uC18D\uC744 \uC790\uB3D9\uC73C\uB85C \uAC10\uC9C0").addToggle(a=>a.setValue(this.plugin.settings.scheduleDetectionEnabled).onChange(async l=>{this.plugin.settings.scheduleDetectionEnabled=l,await this.plugin.saveSettings()})),new ft.Setting(t).setName("Daily Notes \uD3F4\uB354").setDesc("\uC77C\uC815\uC774 \uC800\uC7A5\uB420 Daily Notes \uD3F4\uB354").addText(a=>a.setPlaceholder("00 _Inbox").setValue(this.plugin.settings.dailyNotesFolder).onChange(async l=>{this.plugin.settings.dailyNotesFolder=l,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Google Calendar \uC5F0\uB3D9"}),new ft.Setting(t).setName("Google Calendar \uD65C\uC131\uD654").setDesc("\uC77C\uC815\uC744 Google Calendar\uC5D0\uB3C4 \uC800\uC7A5\uD569\uB2C8\uB2E4").addToggle(a=>a.setValue(this.plugin.settings.googleCalendarEnabled).onChange(async l=>{this.plugin.settings.googleCalendarEnabled=l,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.googleCalendarEnabled){let a=!!this.plugin.settings.googleRefreshToken,l=a?"\uC5F0\uACB0\uB428 \u2713":"\uC5F0\uACB0 \uC548\uB428";if(new ft.Setting(t).setName("Google \uACC4\uC815").setDesc(l).addButton(c=>c.setButtonText(a?"\uC7AC\uC5F0\uACB0":"\uC5F0\uACB0\uD558\uAE30").setCta().onClick(async()=>{await this.plugin.connectGoogleCalendar()})).addButton(c=>(a&&c.setButtonText("\uC5F0\uACB0 \uD574\uC81C").onClick(async()=>{await this.plugin.disconnectGoogleCalendar(),this.display()}),c)),new ft.Setting(t).setName("\uC790\uCCB4 API \uD0A4 \uC0AC\uC6A9 (Advanced)").setDesc("\uC9C1\uC811 Google Cloud Console\uC5D0\uC11C \uC0DD\uC131\uD55C Client ID\uB97C \uC0AC\uC6A9\uD569\uB2C8\uB2E4").addToggle(c=>c.setValue(this.plugin.settings.useOwnApiKey).onChange(async d=>{this.plugin.settings.useOwnApiKey=d,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.useOwnApiKey){new ft.Setting(t).setName("Google Client ID").setDesc("Google Cloud Console\uC5D0\uC11C \uC0DD\uC131\uD55C OAuth 2.0 Client ID").addText(d=>d.setPlaceholder("xxxxx.apps.googleusercontent.com").setValue(this.plugin.settings.googleClientId).onChange(async u=>{this.plugin.settings.googleClientId=u,await this.plugin.saveSettings()})),new ft.Setting(t).setName("Google Client Secret").setDesc("OAuth 2.0 Client Secret").addText(d=>d.setPlaceholder("GOCSPX-...").setValue(this.plugin.settings.googleClientSecret).onChange(async u=>{this.plugin.settings.googleClientSecret=u,await this.plugin.saveSettings()}));let c=t.createDiv({cls:"setting-item-description"});c.createEl("p",{text:"Google Cloud Console\uC5D0\uC11C OAuth 2.0 \uD074\uB77C\uC774\uC5B8\uD2B8 ID\uB97C \uC0DD\uC131\uD558\uC138\uC694:"}),c.createEl("a",{text:"Google Cloud Console \uC5F4\uAE30",href:"https://console.cloud.google.com/apis/credentials"}),c.createEl("p",{text:"\uB9AC\uB514\uB809\uC158 URI: http://127.0.0.1:42813/callback",cls:"setting-item-description"}).style.fontFamily="monospace"}}if(t.createEl("h3",{text:"\uCE98\uB9B0\uB354 \uBDF0"}),new ft.Setting(t).setName("\uCE98\uB9B0\uB354 \uBDF0 \uD65C\uC131\uD654").setDesc("\uB178\uD2B8, \uC77C\uC815, \uD68C\uC758\uB85D\uC744 \uCE98\uB9B0\uB354\uB85C \uD655\uC778\uD569\uB2C8\uB2E4").addToggle(a=>a.setValue(this.plugin.settings.calendarEnabled).onChange(async l=>{this.plugin.settings.calendarEnabled=l,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.calendarEnabled&&(new ft.Setting(t).setName("\uAE30\uBCF8 \uBDF0").setDesc("\uCE98\uB9B0\uB354\uB97C \uC5F4 \uB54C \uAE30\uBCF8\uC73C\uB85C \uD45C\uC2DC\uD560 \uBDF0").addDropdown(a=>a.addOption("month","\uC6D4\uAC04").addOption("week","\uC8FC\uAC04").addOption("day","\uC77C\uAC04").addOption("list","\uBAA9\uB85D").setValue(this.plugin.settings.calendarDefaultView).onChange(async l=>{this.plugin.settings.calendarDefaultView=l,await this.plugin.saveSettings()})),new ft.Setting(t).setName("\uC8FC \uC2DC\uC791\uC77C").setDesc("\uCE98\uB9B0\uB354\uC758 \uCCAB \uBC88\uC9F8 \uC694\uC77C").addDropdown(a=>a.addOption("0","\uC77C\uC694\uC77C").addOption("1","\uC6D4\uC694\uC77C").setValue(String(this.plugin.settings.calendarFirstDayOfWeek)).onChange(async l=>{this.plugin.settings.calendarFirstDayOfWeek=parseInt(l),await this.plugin.saveSettings()})),new ft.Setting(t).setName("\uC0AC\uC774\uB4DC\uBC14 \uBBF8\uB2C8 \uCE98\uB9B0\uB354").setDesc("\uC624\uB978\uCABD \uC0AC\uC774\uB4DC\uBC14\uC5D0 \uBBF8\uB2C8 \uCE98\uB9B0\uB354\uB97C \uD45C\uC2DC\uD569\uB2C8\uB2E4").addToggle(a=>a.setValue(this.plugin.settings.showMiniCalendar).onChange(async l=>{this.plugin.settings.showMiniCalendar=l,await this.plugin.saveSettings(),l&&await this.plugin.toggleMiniCalendar()})),new ft.Setting(t).setName("\uCE98\uB9B0\uB354 \uC5D4\uC9C4").setDesc(createFragment(a=>{a.appendText("FullCalendar.js (\uD480\uAE30\uB2A5) \uB610\uB294 \uC790\uCCB4 \uAD6C\uD604 (\uACBD\uB7C9) \uC120\uD0DD"),a.createEl("br"),a.createEl("span",{text:"\u{1F4A1} \uC5D4\uC9C4 \uBCC0\uACBD \uD6C4 \uC544\uB798 '\uCE98\uB9B0\uB354 \uBDF0 \uC7AC\uC2DC\uC791' \uBC84\uD2BC\uC744 \uD074\uB9AD\uD558\uC138\uC694",cls:"setting-item-description"}).style.color="var(--text-accent)"})).addDropdown(a=>a.addOption("fullcalendar","FullCalendar.js (\uD480\uAE30\uB2A5)").addOption("native","\uC790\uCCB4 \uAD6C\uD604 (\uACBD\uB7C9)").setValue(this.plugin.settings.calendarEngine).onChange(async l=>{this.plugin.settings.calendarEngine=l,await this.plugin.saveSettings()})),new ft.Setting(t).setName("\uCE98\uB9B0\uB354 \uBDF0 \uC7AC\uC2DC\uC791").setDesc("\uC5D4\uC9C4 \uBCC0\uACBD \uD6C4 \uCE98\uB9B0\uB354 \uBDF0\uB97C \uB2E4\uC2DC \uC5F4\uC5B4 \uC801\uC6A9\uD569\uB2C8\uB2E4").addButton(a=>a.setButtonText("\uCE98\uB9B0\uB354 \uBDF0 \uC7AC\uC2DC\uC791").onClick(async()=>{await this.plugin.restartCalendarView(),new ft.Notice("\uCE98\uB9B0\uB354 \uBDF0\uAC00 \uC7AC\uC2DC\uC791\uB418\uC5C8\uC2B5\uB2C8\uB2E4")})),new ft.Setting(t).setName("\uCE98\uB9B0\uB354 \uC5F4\uAE30").setDesc("Ctrl+Shift+C \uB610\uB294 \uB9AC\uBCF8 \uC544\uC774\uCF58\uC73C\uB85C\uB3C4 \uC5F4 \uC218 \uC788\uC2B5\uB2C8\uB2E4").addButton(a=>a.setButtonText("\uCE98\uB9B0\uB354 \uC5F4\uAE30").setCta().onClick(async()=>{await this.plugin.openCalendarView()}))),t.createEl("h3",{text:"Embedding \uAE30\uBC18 \uAC80\uC0C9 (Beta)"}),new ft.Setting(t).setName("Embedding \uD65C\uC131\uD654").setDesc(createFragment(a=>{a.appendText("\uD0A4\uC6CC\uB4DC \uB300\uC2E0 \uC758\uBBF8 \uAE30\uBC18 \uC720\uC0AC\uB3C4\uB85C \uAD00\uB828 \uB178\uD2B8\uB97C \uCC3E\uC2B5\uB2C8\uB2E4. "),a.createEl("br"),a.appendText("\uD65C\uC131\uD654 \uC2DC \uBAA8\uB4E0 \uB178\uD2B8\uC758 \uC784\uBCA0\uB529\uC744 \uC0DD\uC131\uD569\uB2C8\uB2E4 (\uC2DC\uAC04\uC774 \uAC78\uB9B4 \uC218 \uC788\uC74C).")})).addToggle(a=>a.setValue(this.plugin.settings.embeddingEnabled).onChange(async l=>{this.plugin.settings.embeddingEnabled=l,await this.plugin.saveSettings(),this.display(),l&&(new ft.Notice("Embedding \uC778\uB371\uC2A4 \uAD6C\uCD95\uC744 \uC2DC\uC791\uD569\uB2C8\uB2E4..."),this.plugin.embeddingManager&&(await this.plugin.embeddingManager.buildFullIndex((c,d,u)=>{(c%10===0||c===d)&&new ft.Notice(`Embedding: ${c}/${d}`)}),new ft.Notice("Embedding \uC778\uB371\uC2A4 \uAD6C\uCD95 \uC644\uB8CC!")))})),this.plugin.settings.embeddingEnabled){new ft.Setting(t).setName("\uC720\uC0AC\uB3C4 \uC784\uACC4\uAC12").setDesc("\uC774 \uAC12 \uC774\uC0C1\uC758 \uC720\uC0AC\uB3C4\uB97C \uAC00\uC9C4 \uB178\uD2B8\uB9CC \uCD94\uCC9C\uD569\uB2C8\uB2E4 (0.5~0.95)").addSlider(l=>l.setLimits(.5,.95,.05).setValue(this.plugin.settings.embeddingSimilarityThreshold).setDynamicTooltip().onChange(async c=>{this.plugin.settings.embeddingSimilarityThreshold=c,await this.plugin.saveSettings()})).addExtraButton(l=>l.setIcon("reset").setTooltip("\uAE30\uBCF8\uAC12 (0.7)").onClick(async()=>{this.plugin.settings.embeddingSimilarityThreshold=.7,await this.plugin.saveSettings(),this.display()})),new ft.Setting(t).setName("\uC790\uB3D9 \uC784\uBCA0\uB529").setDesc(createFragment(l=>{l.appendText("\uB178\uD2B8 \uC0DD\uC131/\uC218\uC815 \uC2DC \uC790\uB3D9\uC73C\uB85C \uC784\uBCA0\uB529\uC744 \uC5C5\uB370\uC774\uD2B8\uD569\uB2C8\uB2E4. "),l.createEl("br"),l.createEl("strong",{text:"\u{1F4A1} \uB3D9\uAE30\uD654 \uD301: "}),l.appendText("PC\uC5D0\uC11C\uB9CC \uCF1C\uACE0, \uBAA8\uBC14\uC77C\uC5D0\uC11C\uB294 \uB044\uC138\uC694.")})).addToggle(l=>l.setValue(this.plugin.settings.autoEmbeddingEnabled).onChange(async c=>{this.plugin.settings.autoEmbeddingEnabled=c,await this.plugin.saveSettings()}));let a=t.createEl("details",{cls:"zfb-chunk-settings"});if(a.createEl("summary",{text:"\u{1F4E6} \uCCAD\uD06C \uBD84\uD560 \uC124\uC815 (\uACE0\uAE09)"}),new ft.Setting(a).setName("\uCCAD\uD06C \uD06C\uAE30").setDesc("\uB178\uD2B8\uB97C \uBD84\uD560\uD558\uB294 \uB2E8\uC704 \uD06C\uAE30 (200~1000\uC790)").addText(l=>l.setPlaceholder("500").setValue(String(this.plugin.settings.embeddingChunkSize||500)).onChange(async c=>{let d=parseInt(c);d>=200&&d<=1e3&&(this.plugin.settings.embeddingChunkSize=d,await this.plugin.saveSettings())})),new ft.Setting(a).setName("\uCCAD\uD06C \uC624\uBC84\uB7A9").setDesc("\uCCAD\uD06C \uAC04 \uC911\uBCF5 \uC601\uC5ED (0~100\uC790)").addText(l=>l.setPlaceholder("50").setValue(String(this.plugin.settings.embeddingChunkOverlap||50)).onChange(async c=>{let d=parseInt(c);d>=0&&d<=100&&(this.plugin.settings.embeddingChunkOverlap=d,await this.plugin.saveSettings())})),a.createEl("p",{text:"\u26A0\uFE0F \uC124\uC815 \uBCC0\uACBD \uC2DC \uC778\uB371\uC2A4 \uC7AC\uAD6C\uCD95 \uD544\uC694",cls:"setting-item-description"}),this.plugin.embeddingManager){let l=this.plugin.embeddingManager.getStats(),c=t.createDiv({cls:"embedding-stats-info"});c.createEl("p",{text:`\uC778\uB371\uC2F1\uB41C \uB178\uD2B8: ${l.totalNotes}\uAC1C`,cls:"setting-item-description"}),l.totalChunks!==void 0&&c.createEl("p",{text:`\uCD1D \uCCAD\uD06C: ${l.totalChunks}\uAC1C`,cls:"setting-item-description"}),l.lastFullScan&&c.createEl("p",{text:`\uB9C8\uC9C0\uB9C9 \uC804\uCCB4 \uC2A4\uCE94: ${new Date(l.lastFullScan).toLocaleString()}`,cls:"setting-item-description"})}new ft.Setting(t).setName("\uC778\uB371\uC2A4 \uC7AC\uAD6C\uCD95").setDesc("\uBAA8\uB4E0 \uB178\uD2B8\uC758 \uC784\uBCA0\uB529\uC744 \uB2E4\uC2DC \uC0DD\uC131\uD569\uB2C8\uB2E4 (\uC2DC\uAC04\uC774 \uAC78\uB9B4 \uC218 \uC788\uC74C)").addButton(l=>l.setButtonText("\uC7AC\uAD6C\uCD95").onClick(async()=>{if(this.plugin.embeddingManager){new ft.Notice("Embedding \uC778\uB371\uC2A4 \uC7AC\uAD6C\uCD95 \uC2DC\uC791..."),await this.plugin.embeddingManager.clearIndex();let c=await this.plugin.embeddingManager.buildFullIndex((d,u)=>{(d%10===0||d===u)&&new ft.Notice(`Embedding: ${d}/${u}`)});new ft.Notice(`\uC7AC\uAD6C\uCD95 \uC644\uB8CC! \uC131\uACF5: ${c.success}, \uC2A4\uD0B5: ${c.skipped}, \uC2E4\uD328: ${c.failed}`),this.display()}})),new ft.Setting(t).setName("\uC0AD\uC81C\uB41C \uD30C\uC77C \uC784\uBCA0\uB529 \uC815\uB9AC").setDesc("\uC0AD\uC81C\uB41C \uB178\uD2B8\uC758 \uC784\uBCA0\uB529\uC744 \uC815\uB9AC\uD569\uB2C8\uB2E4").addButton(l=>l.setButtonText("\uC815\uB9AC").onClick(async()=>{if(this.plugin.embeddingManager){let c=await this.plugin.embeddingManager.cleanupOrphanedEmbeddings();new ft.Notice(`${c}\uAC1C\uC758 \uBBF8\uC0AC\uC6A9 \uC784\uBCA0\uB529\uC774 \uC815\uB9AC\uB418\uC5C8\uC2B5\uB2C8\uB2E4`),this.display()}}))}if(t.createEl("h3",{text:"RAG \uCC57\uBD07"}),new ft.Setting(t).setName("RAG \uCC57\uBD07 \uD65C\uC131\uD654").setDesc(createFragment(a=>{a.appendText("\uB178\uD2B8 \uAE30\uBC18 Q&A \uCC57\uBD07\uC744 \uD65C\uC131\uD654\uD569\uB2C8\uB2E4. "),a.createEl("br"),a.appendText("Embedding\uC774 \uD65C\uC131\uD654\uB418\uC5B4 \uC788\uC5B4\uC57C \uD569\uB2C8\uB2E4.")})).addToggle(a=>a.setValue(this.plugin.settings.ragEnabled).setDisabled(!this.plugin.settings.embeddingEnabled).onChange(async l=>{this.plugin.settings.ragEnabled=l,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.embeddingEnabled||t.createDiv({cls:"setting-item-description"}).createEl("p",{text:"\u26A0\uFE0F RAG \uCC57\uBD07\uC744 \uC0AC\uC6A9\uD558\uB824\uBA74 \uBA3C\uC800 Embedding\uC744 \uD65C\uC131\uD654\uD558\uC138\uC694.",cls:"mod-warning"}),this.plugin.settings.ragEnabled&&this.plugin.settings.embeddingEnabled&&(new ft.Setting(t).setName("\uAC80\uC0C9\uD560 \uB178\uD2B8 \uC218 (Top-K)").setDesc("\uC9C8\uBB38\uACFC \uAD00\uB828\uB41C \uB178\uD2B8\uB97C \uBA87 \uAC1C\uAE4C\uC9C0 \uAC80\uC0C9\uD560\uC9C0 \uC124\uC815\uD569\uB2C8\uB2E4").addSlider(a=>a.setLimits(1,10,1).setValue(this.plugin.settings.ragTopK).setDynamicTooltip().onChange(async l=>{this.plugin.settings.ragTopK=l,await this.plugin.saveSettings()})).addExtraButton(a=>a.setIcon("reset").setTooltip("\uAE30\uBCF8\uAC12 (5)").onClick(async()=>{this.plugin.settings.ragTopK=5,await this.plugin.saveSettings(),this.display()})),new ft.Setting(t).setName("\uCEE8\uD14D\uC2A4\uD2B8 \uCD5C\uB300 \uAE38\uC774").setDesc("AI\uC5D0\uAC8C \uC804\uB2EC\uD560 \uB178\uD2B8 \uB0B4\uC6A9\uC758 \uCD5C\uB300 \uAE00\uC790 \uC218 (1000~10000)").addSlider(a=>a.setLimits(1e3,1e4,500).setValue(this.plugin.settings.ragMaxContextLength).setDynamicTooltip().onChange(async l=>{this.plugin.settings.ragMaxContextLength=l,await this.plugin.saveSettings()})).addExtraButton(a=>a.setIcon("reset").setTooltip("\uAE30\uBCF8\uAC12 (4000)").onClick(async()=>{this.plugin.settings.ragMaxContextLength=4e3,await this.plugin.saveSettings(),this.display()})),new ft.Setting(t).setName("\uCC57\uBD07 \uC5F4\uAE30").setDesc("Ctrl+Shift+' \uB610\uB294 \uB9AC\uBCF8 \uC544\uC774\uCF58\uC73C\uB85C\uB3C4 \uC5F4 \uC218 \uC788\uC2B5\uB2C8\uB2E4").addButton(a=>a.setButtonText("\uCC57\uBD07 \uC5F4\uAE30").setCta().onClick(async()=>{await this.plugin.toggleChatbot()}))),t.createEl("h3",{text:"\uB370\uC774\uD130 \uB3D9\uAE30\uD654"}),new ft.Setting(t).setName("\uB370\uC774\uD130 \uC800\uC7A5 \uC704\uCE58").setDesc(createFragment(a=>{a.appendText("\uBCFC\uD2B8 \uB0B4\uBD80\uC5D0 \uC800\uC7A5\uD558\uBA74 Obsidian Sync\uB85C \uB3D9\uAE30\uD654\uB429\uB2C8\uB2E4."),a.createEl("br"),a.appendText("\uBCC0\uACBD \uD6C4 \uD50C\uB7EC\uADF8\uC778 \uC7AC\uC2DC\uC791\uC774 \uD544\uC694\uD569\uB2C8\uB2E4.")})).addDropdown(a=>a.addOption("plugin","\uD50C\uB7EC\uADF8\uC778 \uD3F4\uB354 (\uAE30\uBCF8)").addOption("vault","\uBCFC\uD2B8 \uB0B4\uBD80 (.zfb-data)").setValue(this.plugin.settings.dataStorageLocation).onChange(async l=>{this.plugin.settings.dataStorageLocation=l,await this.plugin.saveSettings(),new ft.Notice(`\uB370\uC774\uD130 \uC800\uC7A5 \uC704\uCE58\uAC00 \uBCC0\uACBD\uB418\uC5C8\uC2B5\uB2C8\uB2E4.
\uD50C\uB7EC\uADF8\uC778\uC744 \uC7AC\uC2DC\uC791\uD558\uBA74 \uC801\uC6A9\uB429\uB2C8\uB2E4.`)})),this.plugin.settings.dataStorageLocation==="vault"){new ft.Setting(t).setName("\uB370\uC774\uD130 \uD3F4\uB354 \uACBD\uB85C").setDesc("\uBCFC\uD2B8 \uB0B4 \uB370\uC774\uD130 \uC800\uC7A5 \uD3F4\uB354 (embeddings, chats, feedback)").addText(l=>l.setPlaceholder(".zfb-data").setValue(this.plugin.settings.dataFolderPath).onChange(async c=>{this.plugin.settings.dataFolderPath=c||".zfb-data",await this.plugin.saveSettings()}));let a=t.createDiv({cls:"setting-item-description"});a.createEl("p",{text:`\uC800\uC7A5 \uACBD\uB85C: ${this.plugin.settings.dataFolderPath}/`}),a.createEl("p",{text:"\u2022 embeddings.json (Embedding \uC778\uB371\uC2A4)",cls:"setting-item-description"}),a.createEl("p",{text:"\u2022 chats.json (\uCC57\uBD07 \uB300\uD654)",cls:"setting-item-description"}),a.createEl("p",{text:"\u2022 feedback.json (\uD53C\uB4DC\uBC31 \uB370\uC774\uD130)",cls:"setting-item-description"})}t.createEl("h3",{text:"\uD15C\uD50C\uB9BF"});let o=t.createDiv({cls:"setting-item-description"});o.createEl("p",{text:"\uC0AC\uC6A9 \uAC00\uB2A5\uD55C \uBCC0\uC218:"}),o.innerHTML+=`
			<code>{{title}}</code> \uC81C\uBAA9 &nbsp;
			<code>{{url}}</code> URL &nbsp;
			<code>{{summary}}</code> \uC694\uC57D &nbsp;
			<code>{{keyPoints}}</code> \uD575\uC2EC \uD3EC\uC778\uD2B8 &nbsp;
			<code>{{date}}</code> \uB0A0\uC9DC &nbsp;
			<code>{{iframe}}</code> \uC784\uBCA0\uB4DC
		`,new ft.Setting(t).setName("YouTube \uD15C\uD50C\uB9BF").setDesc("YouTube \uC601\uC0C1 \uB178\uD2B8 \uC0DD\uC131 \uC2DC \uC0AC\uC6A9\uD560 \uD15C\uD50C\uB9BF").addTextArea(a=>{a.inputEl.rows=12,a.inputEl.cols=50,a.inputEl.addClass("zfb-template-textarea"),a.setValue(this.plugin.settings.youtubeTemplate).onChange(async l=>{this.plugin.settings.youtubeTemplate=l,await this.plugin.saveSettings()})}).addExtraButton(a=>a.setIcon("reset").setTooltip("\uAE30\uBCF8\uAC12\uC73C\uB85C \uCD08\uAE30\uD654").onClick(async()=>{let{DEFAULT_SETTINGS:l}=await Promise.resolve().then(()=>(Yo(),GC));this.plugin.settings.youtubeTemplate=l.youtubeTemplate,await this.plugin.saveSettings(),this.display()})),new ft.Setting(t).setName("\uC6F9\uD398\uC774\uC9C0 \uD15C\uD50C\uB9BF").setDesc("\uC6F9\uD398\uC774\uC9C0 \uB178\uD2B8 \uC0DD\uC131 \uC2DC \uC0AC\uC6A9\uD560 \uD15C\uD50C\uB9BF").addTextArea(a=>{a.inputEl.rows=12,a.inputEl.cols=50,a.inputEl.addClass("zfb-template-textarea"),a.setValue(this.plugin.settings.webpageTemplate).onChange(async l=>{this.plugin.settings.webpageTemplate=l,await this.plugin.saveSettings()})}).addExtraButton(a=>a.setIcon("reset").setTooltip("\uAE30\uBCF8\uAC12\uC73C\uB85C \uCD08\uAE30\uD654").onClick(async()=>{let{DEFAULT_SETTINGS:l}=await Promise.resolve().then(()=>(Yo(),GC));this.plugin.settings.webpageTemplate=l.webpageTemplate,await this.plugin.saveSettings(),this.display()})),t.createEl("h3",{text:"API \uC0AC\uC6A9\uB7C9 \uCD94\uC801"}),new ft.Setting(t).setName("\uC0AC\uC6A9\uB7C9 \uCD94\uC801").setDesc("Gemini API \uD1A0\uD070 \uC0AC\uC6A9\uB7C9\uC744 \uCD94\uC801\uD569\uB2C8\uB2E4").addToggle(a=>a.setValue(this.plugin.settings.usageTrackingEnabled).onChange(async l=>{this.plugin.settings.usageTrackingEnabled=l,await this.plugin.saveSettings(),await this.plugin.toggleUsageTracker(l),this.display()})),this.plugin.settings.usageTrackingEnabled&&this.renderUsageSettings(t)}async renderUsageSettings(t){await this.plugin.usageTracker?.loadUsage(),new ft.Setting(t).setName("\uC800\uC7A5 \uAE30\uAC04").setDesc("\uC0AC\uC6A9\uB7C9 \uB370\uC774\uD130 \uBCF4\uAD00 \uAE30\uAC04").addDropdown(n=>{UC.forEach(i=>{n.addOption(i.value,`${i.label} - ${i.desc}`)}),n.setValue(this.plugin.settings.usageStorageMode).onChange(async i=>{this.plugin.settings.usageStorageMode=i,await this.plugin.saveSettings(),this.plugin.usageTracker&&(this.plugin.usageTracker.pruneOldData(),await this.plugin.usageTracker.saveUsage())})}),new ft.Setting(t).setName("\uC0C1\uD0DC\uBC14 \uD45C\uC2DC").setDesc("\uD558\uB2E8 \uC0C1\uD0DC\uBC14\uC5D0 \uC624\uB298 \uC0AC\uC6A9\uB7C9\uC744 \uD45C\uC2DC\uD569\uB2C8\uB2E4").addToggle(n=>n.setValue(this.plugin.settings.usageShowStatusBar).onChange(async i=>{this.plugin.settings.usageShowStatusBar=i,await this.plugin.saveSettings(),this.plugin.usageTracker&&this.plugin.usageTracker.updateStatusBar()})),this.renderTodayUsage(t),this.renderMonthUsage(t),this.renderUsageButtons(t)}renderTodayUsage(t){let n=this.plugin.usageTracker?.getTodayUsage(),i=t.createDiv({cls:"zfb-usage-section"});if(i.createEl("h4",{text:"\uC624\uB298 \uC0AC\uC6A9\uB7C9"}),!n){i.createEl("p",{text:"\uC624\uB298 \uC0AC\uC6A9 \uAE30\uB85D\uC774 \uC5C6\uC2B5\uB2C8\uB2E4.",cls:"zfb-usage-empty"});return}let r=this.plugin.usageTracker?.calculateCost(n.totalInputTokens,n.totalOutputTokens,"gemini-3-flash-preview")??0,o=i.createDiv({cls:"zfb-usage-stats-grid"});this.createStatItem(o,"\uC785\uB825 \uD1A0\uD070",n.totalInputTokens.toLocaleString()),this.createStatItem(o,"\uCD9C\uB825 \uD1A0\uD070",n.totalOutputTokens.toLocaleString()),this.createStatItem(o,"\uCD1D \uD638\uCD9C",n.totalCalls.toString()),this.createStatItem(o,"\uC608\uC0C1 \uBE44\uC6A9",`$${r.toFixed(4)}`);let a=i.createDiv({cls:"zfb-usage-features"});a.createEl("strong",{text:"\uAE30\uB2A5\uBCC4 \uD638\uCD9C:"});let l=a.createDiv({cls:"zfb-usage-feature-list"});Object.entries(n.callsByFeature).filter(([c,d])=>d>0).sort((c,d)=>d[1]-c[1]).forEach(([c,d])=>{let u=zC[c]||c;l.createSpan({text:`${u}: ${d}`,cls:"zfb-usage-feature-item"})})}renderMonthUsage(t){let n=this.plugin.usageTracker?.getThisMonthUsage();if(!n||n.inputTokens===0&&n.outputTokens===0)return;let i=this.plugin.usageTracker?.calculateCost(n.inputTokens,n.outputTokens,"gemini-3-flash-preview")??0,r=t.createDiv({cls:"zfb-usage-section"});r.createEl("h4",{text:"\uC774\uBC88 \uB2EC \uB204\uC801"});let o=r.createDiv({cls:"zfb-usage-stats-grid"});this.createStatItem(o,"\uC785\uB825 \uD1A0\uD070",n.inputTokens.toLocaleString()),this.createStatItem(o,"\uCD9C\uB825 \uD1A0\uD070",n.outputTokens.toLocaleString()),this.createStatItem(o,"\uCD1D \uD638\uCD9C",n.calls.toString()),this.createStatItem(o,"\uC608\uC0C1 \uBE44\uC6A9",`$${i.toFixed(4)}`)}renderUsageButtons(t){let n=t.createDiv({cls:"zfb-usage-buttons"});new ft.Setting(n).addButton(i=>i.setButtonText("\uB370\uC774\uD130 \uCD08\uAE30\uD654").setWarning().onClick(async()=>{confirm("\uBAA8\uB4E0 \uC0AC\uC6A9\uB7C9 \uB370\uC774\uD130\uB97C \uC0AD\uC81C\uD558\uC2DC\uACA0\uC2B5\uB2C8\uAE4C?")&&(await this.plugin.usageTracker?.resetUsage(),new ft.Notice("\uC0AC\uC6A9\uB7C9 \uB370\uC774\uD130\uAC00 \uCD08\uAE30\uD654\uB418\uC5C8\uC2B5\uB2C8\uB2E4."),this.display())})),new ft.Setting(n).addButton(i=>i.setButtonText("CSV \uB0B4\uBCF4\uB0B4\uAE30").onClick(async()=>{let r=this.plugin.usageTracker?.exportToCSV();if(r){let o=`zfb-usage-${new Date().toISOString().split("T")[0]}.csv`,a=new Blob([r],{type:"text/csv"}),l=URL.createObjectURL(a),c=document.createElement("a");c.href=l,c.download=o,c.click(),URL.revokeObjectURL(l),new ft.Notice("CSV \uD30C\uC77C\uC774 \uB2E4\uC6B4\uB85C\uB4DC\uB418\uC5C8\uC2B5\uB2C8\uB2E4.")}}))}createStatItem(t,n,i){let r=t.createDiv({cls:"zfb-usage-stat-item"});r.createSpan({text:n,cls:"stat-label"}),r.createSpan({text:i,cls:"stat-value"})}async createFolderStructure(){let t=[this.plugin.settings.inboxFolder,this.plugin.settings.projectsFolder,this.plugin.settings.libraryFolder,this.plugin.settings.archivesFolder,this.plugin.settings.zettelFolder],n=0,i=0;for(let r of t){if(!r)continue;if(this.app.vault.getAbstractFileByPath(r))i++;else try{await this.app.vault.createFolder(r),n++}catch(a){console.error(`\uD3F4\uB354 \uC0DD\uC131 \uC2E4\uD328: ${r}`,a)}}n>0?new ft.Notice(`${n}\uAC1C \uD3F4\uB354 \uC0DD\uC131\uB428, ${i}\uAC1C \uC774\uBBF8 \uC874\uC7AC`):new ft.Notice(`\uBAA8\uB4E0 \uD3F4\uB354\uAC00 \uC774\uBBF8 \uC874\uC7AC\uD569\uB2C8\uB2E4 (${i}\uAC1C)`)}renderPresetDescription(t,n){t.empty();let i=Vi[n],r=t.createDiv({cls:"preset-desc-content"});r.createEl("strong",{text:`${i.icon} ${i.label}`});let o=r.createDiv({cls:"preset-details"});switch(n){case"basic":o.innerHTML=`
					<p>\uD575\uC2EC \uAE30\uB2A5\uB9CC \uD65C\uC131\uD654\uD558\uC5EC \uAC00\uBCCD\uAC8C \uC2DC\uC791\uD569\uB2C8\uB2E4.</p>
					<ul>
						<li>\u2705 \uD504\uB85C\uC81D\uD2B8 \uBD84\uB958 (Ctrl+Shift+G)</li>
						<li>\u2705 URL \uC694\uC57D (Ctrl+Shift+U)</li>
						<li>\u2705 OCR \uCD94\uCD9C (Ctrl+Shift+O)</li>
						<li>\u274C Embedding/RAG \uCC57\uBD07</li>
						<li>\u274C \uCE98\uB9B0\uB354/\uC77C\uC815 \uAC10\uC9C0</li>
					</ul>
				`;break;case"power":o.innerHTML=`
					<p>\uC804\uCCB4 \uAE30\uB2A5\uC744 \uD65C\uC131\uD654\uD569\uB2C8\uB2E4. (\uAD8C\uC7A5)</p>
					<ul>
						<li>\u2705 \uBAA8\uB4E0 \uAE30\uBCF8 \uAE30\uB2A5</li>
						<li>\u2705 Embedding \uAE30\uBC18 \uAC80\uC0C9</li>
						<li>\u2705 RAG \uCC57\uBD07</li>
						<li>\u2705 \uCE98\uB9B0\uB354 \uBDF0</li>
						<li>\u2705 \uC77C\uC815 \uC790\uB3D9 \uAC10\uC9C0</li>
					</ul>
				`;break;case"experimental":o.innerHTML=`
					<p>Beta \uAE30\uB2A5\uC744 \uD3EC\uD568\uD55C \uC804\uCCB4 \uAE30\uB2A5\uC744 \uD65C\uC131\uD654\uD569\uB2C8\uB2E4.</p>
					<ul>
						<li>\u2705 \uBAA8\uB4E0 \uD30C\uC6CC \uBAA8\uB4DC \uAE30\uB2A5</li>
						<li>\u{1F9EA} \uC0C8\uB85C\uC6B4 \uC2E4\uD5D8 \uAE30\uB2A5</li>
					</ul>
				`;break;default:o.innerHTML="<p>\uAC1C\uBCC4 \uC124\uC815\uC744 \uC9C1\uC811 \uC870\uC815\uD569\uB2C8\uB2E4.</p>"}}async applyPreset(t){this.plugin.settings.preset=t;let n=dw[t];for(let[i,r]of Object.entries(n))uw.includes(i)||(this.plugin.settings[i]=r);await this.plugin.saveSettings()}};var JY,ZY;function eX(){return{geminiUrl:JY,vertexUrl:ZY}}function tX(s,e,t,n){var i,r;if(!s?.baseUrl){let o=eX();return e?(i=o.vertexUrl)!==null&&i!==void 0?i:t:(r=o.geminiUrl)!==null&&r!==void 0?r:n}return s.baseUrl}var oo=class{};function mt(s,e){let t=/\{([^}]+)\}/g;return s.replace(t,(n,i)=>{if(Object.prototype.hasOwnProperty.call(e,i)){let r=e[i];return r!=null?String(r):""}else throw new Error(`Key '${i}' not found in valueMap.`)})}function v(s,e,t){for(let r=0;r<e.length-1;r++){let o=e[r];if(o.endsWith("[]")){let a=o.slice(0,-2);if(!(a in s))if(Array.isArray(t))s[a]=Array.from({length:t.length},()=>({}));else throw new Error(`Value must be a list given an array path ${o}`);if(Array.isArray(s[a])){let l=s[a];if(Array.isArray(t))for(let c=0;c<l.length;c++){let d=l[c];v(d,e.slice(r+1),t[c])}else for(let c of l)v(c,e.slice(r+1),t)}return}else if(o.endsWith("[0]")){let a=o.slice(0,-3);a in s||(s[a]=[{}]);let l=s[a];v(l[0],e.slice(r+1),t);return}(!s[o]||typeof s[o]!="object")&&(s[o]={}),s=s[o]}let n=e[e.length-1],i=s[n];if(i!==void 0){if(!t||typeof t=="object"&&Object.keys(t).length===0||t===i)return;if(typeof i=="object"&&typeof t=="object"&&i!==null&&t!==null)Object.assign(i,t);else throw new Error(`Cannot set value for an existing key. Key: ${n}`)}else n==="_self"&&typeof t=="object"&&t!==null&&!Array.isArray(t)?Object.assign(s,t):s[n]=t}function g(s,e,t=void 0){try{if(e.length===1&&e[0]==="_self")return s;for(let n=0;n<e.length;n++){if(typeof s!="object"||s===null)return t;let i=e[n];if(i.endsWith("[]")){let r=i.slice(0,-2);if(r in s){let o=s[r];return Array.isArray(o)?o.map(a=>g(a,e.slice(n+1),t)):t}else return t}else s=s[i]}return s}catch(n){if(n instanceof TypeError)return t;throw n}}function nX(s,e){for(let[t,n]of Object.entries(e)){let i=t.split("."),r=n.split("."),o=new Set,a=-1;for(let l=0;l<i.length;l++)if(i[l]==="*"){a=l;break}if(a!==-1&&r.length>a)for(let l=a;l<r.length;l++){let c=r[l];c!=="*"&&!c.endsWith("[]")&&!c.endsWith("[0]")&&o.add(c)}QC(s,i,r,0,o)}}function QC(s,e,t,n,i){if(n>=e.length||typeof s!="object"||s===null)return;let r=e[n];if(r.endsWith("[]")){let o=r.slice(0,-2),a=s;if(o in a&&Array.isArray(a[o]))for(let l of a[o])QC(l,e,t,n+1,i)}else if(r==="*"){if(typeof s=="object"&&s!==null&&!Array.isArray(s)){let o=s,a=Object.keys(o).filter(c=>!c.startsWith("_")&&!i.has(c)),l={};for(let c of a)l[c]=o[c];for(let[c,d]of Object.entries(l)){let u=[];for(let h of t.slice(n))h==="*"?u.push(c):u.push(h);v(o,u,d)}for(let c of a)delete o[c]}}else{let o=s;r in o&&QC(o[r],e,t,n+1,i)}}function YA(s){if(typeof s!="string")throw new Error("fromImageBytes must be a string");return s}function sX(s){let e={},t=g(s,["operationName"]);t!=null&&v(e,["operationName"],t);let n=g(s,["resourceName"]);return n!=null&&v(e,["_url","resourceName"],n),e}function iX(s){let e={},t=g(s,["name"]);t!=null&&v(e,["name"],t);let n=g(s,["metadata"]);n!=null&&v(e,["metadata"],n);let i=g(s,["done"]);i!=null&&v(e,["done"],i);let r=g(s,["error"]);r!=null&&v(e,["error"],r);let o=g(s,["response","generateVideoResponse"]);return o!=null&&v(e,["response"],oX(o)),e}function rX(s){let e={},t=g(s,["name"]);t!=null&&v(e,["name"],t);let n=g(s,["metadata"]);n!=null&&v(e,["metadata"],n);let i=g(s,["done"]);i!=null&&v(e,["done"],i);let r=g(s,["error"]);r!=null&&v(e,["error"],r);let o=g(s,["response"]);return o!=null&&v(e,["response"],aX(o)),e}function oX(s){let e={},t=g(s,["generatedSamples"]);if(t!=null){let r=t;Array.isArray(r)&&(r=r.map(o=>lX(o))),v(e,["generatedVideos"],r)}let n=g(s,["raiMediaFilteredCount"]);n!=null&&v(e,["raiMediaFilteredCount"],n);let i=g(s,["raiMediaFilteredReasons"]);return i!=null&&v(e,["raiMediaFilteredReasons"],i),e}function aX(s){let e={},t=g(s,["videos"]);if(t!=null){let r=t;Array.isArray(r)&&(r=r.map(o=>cX(o))),v(e,["generatedVideos"],r)}let n=g(s,["raiMediaFilteredCount"]);n!=null&&v(e,["raiMediaFilteredCount"],n);let i=g(s,["raiMediaFilteredReasons"]);return i!=null&&v(e,["raiMediaFilteredReasons"],i),e}function lX(s){let e={},t=g(s,["video"]);return t!=null&&v(e,["video"],mX(t)),e}function cX(s){let e={},t=g(s,["_self"]);return t!=null&&v(e,["video"],gX(t)),e}function dX(s){let e={},t=g(s,["operationName"]);return t!=null&&v(e,["_url","operationName"],t),e}function uX(s){let e={},t=g(s,["operationName"]);return t!=null&&v(e,["_url","operationName"],t),e}function hX(s){let e={},t=g(s,["name"]);t!=null&&v(e,["name"],t);let n=g(s,["metadata"]);n!=null&&v(e,["metadata"],n);let i=g(s,["done"]);i!=null&&v(e,["done"],i);let r=g(s,["error"]);r!=null&&v(e,["error"],r);let o=g(s,["response"]);return o!=null&&v(e,["response"],pX(o)),e}function pX(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["parent"]);n!=null&&v(e,["parent"],n);let i=g(s,["documentName"]);return i!=null&&v(e,["documentName"],i),e}function lU(s){let e={},t=g(s,["name"]);t!=null&&v(e,["name"],t);let n=g(s,["metadata"]);n!=null&&v(e,["metadata"],n);let i=g(s,["done"]);i!=null&&v(e,["done"],i);let r=g(s,["error"]);r!=null&&v(e,["error"],r);let o=g(s,["response"]);return o!=null&&v(e,["response"],fX(o)),e}function fX(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["parent"]);n!=null&&v(e,["parent"],n);let i=g(s,["documentName"]);return i!=null&&v(e,["documentName"],i),e}function mX(s){let e={},t=g(s,["uri"]);t!=null&&v(e,["uri"],t);let n=g(s,["encodedVideo"]);n!=null&&v(e,["videoBytes"],YA(n));let i=g(s,["encoding"]);return i!=null&&v(e,["mimeType"],i),e}function gX(s){let e={},t=g(s,["gcsUri"]);t!=null&&v(e,["uri"],t);let n=g(s,["bytesBase64Encoded"]);n!=null&&v(e,["videoBytes"],YA(n));let i=g(s,["mimeType"]);return i!=null&&v(e,["mimeType"],i),e}var BB;(function(s){s.OUTCOME_UNSPECIFIED="OUTCOME_UNSPECIFIED",s.OUTCOME_OK="OUTCOME_OK",s.OUTCOME_FAILED="OUTCOME_FAILED",s.OUTCOME_DEADLINE_EXCEEDED="OUTCOME_DEADLINE_EXCEEDED"})(BB||(BB={}));var zB;(function(s){s.LANGUAGE_UNSPECIFIED="LANGUAGE_UNSPECIFIED",s.PYTHON="PYTHON"})(zB||(zB={}));var UB;(function(s){s.SCHEDULING_UNSPECIFIED="SCHEDULING_UNSPECIFIED",s.SILENT="SILENT",s.WHEN_IDLE="WHEN_IDLE",s.INTERRUPT="INTERRUPT"})(UB||(UB={}));var Ul;(function(s){s.TYPE_UNSPECIFIED="TYPE_UNSPECIFIED",s.STRING="STRING",s.NUMBER="NUMBER",s.INTEGER="INTEGER",s.BOOLEAN="BOOLEAN",s.ARRAY="ARRAY",s.OBJECT="OBJECT",s.NULL="NULL"})(Ul||(Ul={}));var VB;(function(s){s.MODE_UNSPECIFIED="MODE_UNSPECIFIED",s.MODE_DYNAMIC="MODE_DYNAMIC"})(VB||(VB={}));var GB;(function(s){s.API_SPEC_UNSPECIFIED="API_SPEC_UNSPECIFIED",s.SIMPLE_SEARCH="SIMPLE_SEARCH",s.ELASTIC_SEARCH="ELASTIC_SEARCH"})(GB||(GB={}));var WB;(function(s){s.AUTH_TYPE_UNSPECIFIED="AUTH_TYPE_UNSPECIFIED",s.NO_AUTH="NO_AUTH",s.API_KEY_AUTH="API_KEY_AUTH",s.HTTP_BASIC_AUTH="HTTP_BASIC_AUTH",s.GOOGLE_SERVICE_ACCOUNT_AUTH="GOOGLE_SERVICE_ACCOUNT_AUTH",s.OAUTH="OAUTH",s.OIDC_AUTH="OIDC_AUTH"})(WB||(WB={}));var HB;(function(s){s.HTTP_IN_UNSPECIFIED="HTTP_IN_UNSPECIFIED",s.HTTP_IN_QUERY="HTTP_IN_QUERY",s.HTTP_IN_HEADER="HTTP_IN_HEADER",s.HTTP_IN_PATH="HTTP_IN_PATH",s.HTTP_IN_BODY="HTTP_IN_BODY",s.HTTP_IN_COOKIE="HTTP_IN_COOKIE"})(HB||(HB={}));var jB;(function(s){s.PHISH_BLOCK_THRESHOLD_UNSPECIFIED="PHISH_BLOCK_THRESHOLD_UNSPECIFIED",s.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",s.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",s.BLOCK_HIGH_AND_ABOVE="BLOCK_HIGH_AND_ABOVE",s.BLOCK_HIGHER_AND_ABOVE="BLOCK_HIGHER_AND_ABOVE",s.BLOCK_VERY_HIGH_AND_ABOVE="BLOCK_VERY_HIGH_AND_ABOVE",s.BLOCK_ONLY_EXTREMELY_HIGH="BLOCK_ONLY_EXTREMELY_HIGH"})(jB||(jB={}));var qB;(function(s){s.THINKING_LEVEL_UNSPECIFIED="THINKING_LEVEL_UNSPECIFIED",s.LOW="LOW",s.MEDIUM="MEDIUM",s.HIGH="HIGH",s.MINIMAL="MINIMAL"})(qB||(qB={}));var KB;(function(s){s.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",s.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",s.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",s.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",s.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",s.HARM_CATEGORY_CIVIC_INTEGRITY="HARM_CATEGORY_CIVIC_INTEGRITY",s.HARM_CATEGORY_IMAGE_HATE="HARM_CATEGORY_IMAGE_HATE",s.HARM_CATEGORY_IMAGE_DANGEROUS_CONTENT="HARM_CATEGORY_IMAGE_DANGEROUS_CONTENT",s.HARM_CATEGORY_IMAGE_HARASSMENT="HARM_CATEGORY_IMAGE_HARASSMENT",s.HARM_CATEGORY_IMAGE_SEXUALLY_EXPLICIT="HARM_CATEGORY_IMAGE_SEXUALLY_EXPLICIT",s.HARM_CATEGORY_JAILBREAK="HARM_CATEGORY_JAILBREAK"})(KB||(KB={}));var YB;(function(s){s.HARM_BLOCK_METHOD_UNSPECIFIED="HARM_BLOCK_METHOD_UNSPECIFIED",s.SEVERITY="SEVERITY",s.PROBABILITY="PROBABILITY"})(YB||(YB={}));var XB;(function(s){s.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",s.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",s.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",s.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",s.BLOCK_NONE="BLOCK_NONE",s.OFF="OFF"})(XB||(XB={}));var QB;(function(s){s.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",s.STOP="STOP",s.MAX_TOKENS="MAX_TOKENS",s.SAFETY="SAFETY",s.RECITATION="RECITATION",s.LANGUAGE="LANGUAGE",s.OTHER="OTHER",s.BLOCKLIST="BLOCKLIST",s.PROHIBITED_CONTENT="PROHIBITED_CONTENT",s.SPII="SPII",s.MALFORMED_FUNCTION_CALL="MALFORMED_FUNCTION_CALL",s.IMAGE_SAFETY="IMAGE_SAFETY",s.UNEXPECTED_TOOL_CALL="UNEXPECTED_TOOL_CALL",s.IMAGE_PROHIBITED_CONTENT="IMAGE_PROHIBITED_CONTENT",s.NO_IMAGE="NO_IMAGE",s.IMAGE_RECITATION="IMAGE_RECITATION",s.IMAGE_OTHER="IMAGE_OTHER"})(QB||(QB={}));var JB;(function(s){s.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",s.NEGLIGIBLE="NEGLIGIBLE",s.LOW="LOW",s.MEDIUM="MEDIUM",s.HIGH="HIGH"})(JB||(JB={}));var ZB;(function(s){s.HARM_SEVERITY_UNSPECIFIED="HARM_SEVERITY_UNSPECIFIED",s.HARM_SEVERITY_NEGLIGIBLE="HARM_SEVERITY_NEGLIGIBLE",s.HARM_SEVERITY_LOW="HARM_SEVERITY_LOW",s.HARM_SEVERITY_MEDIUM="HARM_SEVERITY_MEDIUM",s.HARM_SEVERITY_HIGH="HARM_SEVERITY_HIGH"})(ZB||(ZB={}));var ez;(function(s){s.URL_RETRIEVAL_STATUS_UNSPECIFIED="URL_RETRIEVAL_STATUS_UNSPECIFIED",s.URL_RETRIEVAL_STATUS_SUCCESS="URL_RETRIEVAL_STATUS_SUCCESS",s.URL_RETRIEVAL_STATUS_ERROR="URL_RETRIEVAL_STATUS_ERROR",s.URL_RETRIEVAL_STATUS_PAYWALL="URL_RETRIEVAL_STATUS_PAYWALL",s.URL_RETRIEVAL_STATUS_UNSAFE="URL_RETRIEVAL_STATUS_UNSAFE"})(ez||(ez={}));var tz;(function(s){s.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",s.SAFETY="SAFETY",s.OTHER="OTHER",s.BLOCKLIST="BLOCKLIST",s.PROHIBITED_CONTENT="PROHIBITED_CONTENT",s.IMAGE_SAFETY="IMAGE_SAFETY",s.MODEL_ARMOR="MODEL_ARMOR",s.JAILBREAK="JAILBREAK"})(tz||(tz={}));var nz;(function(s){s.TRAFFIC_TYPE_UNSPECIFIED="TRAFFIC_TYPE_UNSPECIFIED",s.ON_DEMAND="ON_DEMAND",s.PROVISIONED_THROUGHPUT="PROVISIONED_THROUGHPUT"})(nz||(nz={}));var bw;(function(s){s.MODALITY_UNSPECIFIED="MODALITY_UNSPECIFIED",s.TEXT="TEXT",s.IMAGE="IMAGE",s.AUDIO="AUDIO"})(bw||(bw={}));var sz;(function(s){s.MEDIA_RESOLUTION_UNSPECIFIED="MEDIA_RESOLUTION_UNSPECIFIED",s.MEDIA_RESOLUTION_LOW="MEDIA_RESOLUTION_LOW",s.MEDIA_RESOLUTION_MEDIUM="MEDIA_RESOLUTION_MEDIUM",s.MEDIA_RESOLUTION_HIGH="MEDIA_RESOLUTION_HIGH"})(sz||(sz={}));var iz;(function(s){s.TUNING_MODE_UNSPECIFIED="TUNING_MODE_UNSPECIFIED",s.TUNING_MODE_FULL="TUNING_MODE_FULL",s.TUNING_MODE_PEFT_ADAPTER="TUNING_MODE_PEFT_ADAPTER"})(iz||(iz={}));var rz;(function(s){s.ADAPTER_SIZE_UNSPECIFIED="ADAPTER_SIZE_UNSPECIFIED",s.ADAPTER_SIZE_ONE="ADAPTER_SIZE_ONE",s.ADAPTER_SIZE_TWO="ADAPTER_SIZE_TWO",s.ADAPTER_SIZE_FOUR="ADAPTER_SIZE_FOUR",s.ADAPTER_SIZE_EIGHT="ADAPTER_SIZE_EIGHT",s.ADAPTER_SIZE_SIXTEEN="ADAPTER_SIZE_SIXTEEN",s.ADAPTER_SIZE_THIRTY_TWO="ADAPTER_SIZE_THIRTY_TWO"})(rz||(rz={}));var JC;(function(s){s.JOB_STATE_UNSPECIFIED="JOB_STATE_UNSPECIFIED",s.JOB_STATE_QUEUED="JOB_STATE_QUEUED",s.JOB_STATE_PENDING="JOB_STATE_PENDING",s.JOB_STATE_RUNNING="JOB_STATE_RUNNING",s.JOB_STATE_SUCCEEDED="JOB_STATE_SUCCEEDED",s.JOB_STATE_FAILED="JOB_STATE_FAILED",s.JOB_STATE_CANCELLING="JOB_STATE_CANCELLING",s.JOB_STATE_CANCELLED="JOB_STATE_CANCELLED",s.JOB_STATE_PAUSED="JOB_STATE_PAUSED",s.JOB_STATE_EXPIRED="JOB_STATE_EXPIRED",s.JOB_STATE_UPDATING="JOB_STATE_UPDATING",s.JOB_STATE_PARTIALLY_SUCCEEDED="JOB_STATE_PARTIALLY_SUCCEEDED"})(JC||(JC={}));var oz;(function(s){s.TUNING_TASK_UNSPECIFIED="TUNING_TASK_UNSPECIFIED",s.TUNING_TASK_I2V="TUNING_TASK_I2V",s.TUNING_TASK_T2V="TUNING_TASK_T2V",s.TUNING_TASK_R2V="TUNING_TASK_R2V"})(oz||(oz={}));var az;(function(s){s.MEDIA_RESOLUTION_UNSPECIFIED="MEDIA_RESOLUTION_UNSPECIFIED",s.MEDIA_RESOLUTION_LOW="MEDIA_RESOLUTION_LOW",s.MEDIA_RESOLUTION_MEDIUM="MEDIA_RESOLUTION_MEDIUM",s.MEDIA_RESOLUTION_HIGH="MEDIA_RESOLUTION_HIGH",s.MEDIA_RESOLUTION_ULTRA_HIGH="MEDIA_RESOLUTION_ULTRA_HIGH"})(az||(az={}));var lz;(function(s){s.FEATURE_SELECTION_PREFERENCE_UNSPECIFIED="FEATURE_SELECTION_PREFERENCE_UNSPECIFIED",s.PRIORITIZE_QUALITY="PRIORITIZE_QUALITY",s.BALANCED="BALANCED",s.PRIORITIZE_COST="PRIORITIZE_COST"})(lz||(lz={}));var cz;(function(s){s.UNSPECIFIED="UNSPECIFIED",s.BLOCKING="BLOCKING",s.NON_BLOCKING="NON_BLOCKING"})(cz||(cz={}));var dz;(function(s){s.MODE_UNSPECIFIED="MODE_UNSPECIFIED",s.MODE_DYNAMIC="MODE_DYNAMIC"})(dz||(dz={}));var uz;(function(s){s.ENVIRONMENT_UNSPECIFIED="ENVIRONMENT_UNSPECIFIED",s.ENVIRONMENT_BROWSER="ENVIRONMENT_BROWSER"})(uz||(uz={}));var hz;(function(s){s.MODE_UNSPECIFIED="MODE_UNSPECIFIED",s.AUTO="AUTO",s.ANY="ANY",s.NONE="NONE",s.VALIDATED="VALIDATED"})(hz||(hz={}));var pz;(function(s){s.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",s.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",s.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",s.BLOCK_NONE="BLOCK_NONE"})(pz||(pz={}));var fz;(function(s){s.DONT_ALLOW="DONT_ALLOW",s.ALLOW_ADULT="ALLOW_ADULT",s.ALLOW_ALL="ALLOW_ALL"})(fz||(fz={}));var mz;(function(s){s.auto="auto",s.en="en",s.ja="ja",s.ko="ko",s.hi="hi",s.zh="zh",s.pt="pt",s.es="es"})(mz||(mz={}));var gz;(function(s){s.MASK_MODE_DEFAULT="MASK_MODE_DEFAULT",s.MASK_MODE_USER_PROVIDED="MASK_MODE_USER_PROVIDED",s.MASK_MODE_BACKGROUND="MASK_MODE_BACKGROUND",s.MASK_MODE_FOREGROUND="MASK_MODE_FOREGROUND",s.MASK_MODE_SEMANTIC="MASK_MODE_SEMANTIC"})(gz||(gz={}));var _z;(function(s){s.CONTROL_TYPE_DEFAULT="CONTROL_TYPE_DEFAULT",s.CONTROL_TYPE_CANNY="CONTROL_TYPE_CANNY",s.CONTROL_TYPE_SCRIBBLE="CONTROL_TYPE_SCRIBBLE",s.CONTROL_TYPE_FACE_MESH="CONTROL_TYPE_FACE_MESH"})(_z||(_z={}));var yz;(function(s){s.SUBJECT_TYPE_DEFAULT="SUBJECT_TYPE_DEFAULT",s.SUBJECT_TYPE_PERSON="SUBJECT_TYPE_PERSON",s.SUBJECT_TYPE_ANIMAL="SUBJECT_TYPE_ANIMAL",s.SUBJECT_TYPE_PRODUCT="SUBJECT_TYPE_PRODUCT"})(yz||(yz={}));var vz;(function(s){s.EDIT_MODE_DEFAULT="EDIT_MODE_DEFAULT",s.EDIT_MODE_INPAINT_REMOVAL="EDIT_MODE_INPAINT_REMOVAL",s.EDIT_MODE_INPAINT_INSERTION="EDIT_MODE_INPAINT_INSERTION",s.EDIT_MODE_OUTPAINT="EDIT_MODE_OUTPAINT",s.EDIT_MODE_CONTROLLED_EDITING="EDIT_MODE_CONTROLLED_EDITING",s.EDIT_MODE_STYLE="EDIT_MODE_STYLE",s.EDIT_MODE_BGSWAP="EDIT_MODE_BGSWAP",s.EDIT_MODE_PRODUCT_IMAGE="EDIT_MODE_PRODUCT_IMAGE"})(vz||(vz={}));var bz;(function(s){s.FOREGROUND="FOREGROUND",s.BACKGROUND="BACKGROUND",s.PROMPT="PROMPT",s.SEMANTIC="SEMANTIC",s.INTERACTIVE="INTERACTIVE"})(bz||(bz={}));var wz;(function(s){s.ASSET="ASSET",s.STYLE="STYLE"})(wz||(wz={}));var Mz;(function(s){s.INSERT="INSERT",s.REMOVE="REMOVE",s.REMOVE_STATIC="REMOVE_STATIC",s.OUTPAINT="OUTPAINT"})(Mz||(Mz={}));var Tz;(function(s){s.OPTIMIZED="OPTIMIZED",s.LOSSLESS="LOSSLESS"})(Tz||(Tz={}));var Ez;(function(s){s.SUPERVISED_FINE_TUNING="SUPERVISED_FINE_TUNING",s.PREFERENCE_TUNING="PREFERENCE_TUNING"})(Ez||(Ez={}));var xz;(function(s){s.STATE_UNSPECIFIED="STATE_UNSPECIFIED",s.STATE_PENDING="STATE_PENDING",s.STATE_ACTIVE="STATE_ACTIVE",s.STATE_FAILED="STATE_FAILED"})(xz||(xz={}));var Sz;(function(s){s.STATE_UNSPECIFIED="STATE_UNSPECIFIED",s.PROCESSING="PROCESSING",s.ACTIVE="ACTIVE",s.FAILED="FAILED"})(Sz||(Sz={}));var Cz;(function(s){s.SOURCE_UNSPECIFIED="SOURCE_UNSPECIFIED",s.UPLOADED="UPLOADED",s.GENERATED="GENERATED"})(Cz||(Cz={}));var Az;(function(s){s.TURN_COMPLETE_REASON_UNSPECIFIED="TURN_COMPLETE_REASON_UNSPECIFIED",s.MALFORMED_FUNCTION_CALL="MALFORMED_FUNCTION_CALL",s.RESPONSE_REJECTED="RESPONSE_REJECTED",s.NEED_MORE_INPUT="NEED_MORE_INPUT"})(Az||(Az={}));var Pz;(function(s){s.MODALITY_UNSPECIFIED="MODALITY_UNSPECIFIED",s.TEXT="TEXT",s.IMAGE="IMAGE",s.VIDEO="VIDEO",s.AUDIO="AUDIO",s.DOCUMENT="DOCUMENT"})(Pz||(Pz={}));var kz;(function(s){s.VAD_SIGNAL_TYPE_UNSPECIFIED="VAD_SIGNAL_TYPE_UNSPECIFIED",s.VAD_SIGNAL_TYPE_SOS="VAD_SIGNAL_TYPE_SOS",s.VAD_SIGNAL_TYPE_EOS="VAD_SIGNAL_TYPE_EOS"})(kz||(kz={}));var Iz;(function(s){s.START_SENSITIVITY_UNSPECIFIED="START_SENSITIVITY_UNSPECIFIED",s.START_SENSITIVITY_HIGH="START_SENSITIVITY_HIGH",s.START_SENSITIVITY_LOW="START_SENSITIVITY_LOW"})(Iz||(Iz={}));var Dz;(function(s){s.END_SENSITIVITY_UNSPECIFIED="END_SENSITIVITY_UNSPECIFIED",s.END_SENSITIVITY_HIGH="END_SENSITIVITY_HIGH",s.END_SENSITIVITY_LOW="END_SENSITIVITY_LOW"})(Dz||(Dz={}));var Rz;(function(s){s.ACTIVITY_HANDLING_UNSPECIFIED="ACTIVITY_HANDLING_UNSPECIFIED",s.START_OF_ACTIVITY_INTERRUPTS="START_OF_ACTIVITY_INTERRUPTS",s.NO_INTERRUPTION="NO_INTERRUPTION"})(Rz||(Rz={}));var Fz;(function(s){s.TURN_COVERAGE_UNSPECIFIED="TURN_COVERAGE_UNSPECIFIED",s.TURN_INCLUDES_ONLY_ACTIVITY="TURN_INCLUDES_ONLY_ACTIVITY",s.TURN_INCLUDES_ALL_INPUT="TURN_INCLUDES_ALL_INPUT"})(Fz||(Fz={}));var Lz;(function(s){s.SCALE_UNSPECIFIED="SCALE_UNSPECIFIED",s.C_MAJOR_A_MINOR="C_MAJOR_A_MINOR",s.D_FLAT_MAJOR_B_FLAT_MINOR="D_FLAT_MAJOR_B_FLAT_MINOR",s.D_MAJOR_B_MINOR="D_MAJOR_B_MINOR",s.E_FLAT_MAJOR_C_MINOR="E_FLAT_MAJOR_C_MINOR",s.E_MAJOR_D_FLAT_MINOR="E_MAJOR_D_FLAT_MINOR",s.F_MAJOR_D_MINOR="F_MAJOR_D_MINOR",s.G_FLAT_MAJOR_E_FLAT_MINOR="G_FLAT_MAJOR_E_FLAT_MINOR",s.G_MAJOR_E_MINOR="G_MAJOR_E_MINOR",s.A_FLAT_MAJOR_F_MINOR="A_FLAT_MAJOR_F_MINOR",s.A_MAJOR_G_FLAT_MINOR="A_MAJOR_G_FLAT_MINOR",s.B_FLAT_MAJOR_G_MINOR="B_FLAT_MAJOR_G_MINOR",s.B_MAJOR_A_FLAT_MINOR="B_MAJOR_A_FLAT_MINOR"})(Lz||(Lz={}));var Nz;(function(s){s.MUSIC_GENERATION_MODE_UNSPECIFIED="MUSIC_GENERATION_MODE_UNSPECIFIED",s.QUALITY="QUALITY",s.DIVERSITY="DIVERSITY",s.VOCALIZATION="VOCALIZATION"})(Nz||(Nz={}));var Vh;(function(s){s.PLAYBACK_CONTROL_UNSPECIFIED="PLAYBACK_CONTROL_UNSPECIFIED",s.PLAY="PLAY",s.PAUSE="PAUSE",s.STOP="STOP",s.RESET_CONTEXT="RESET_CONTEXT"})(Vh||(Vh={}));var Hm=class{constructor(e){let t={};for(let n of e.headers.entries())t[n[0]]=n[1];this.headers=t,this.responseInternal=e}json(){return this.responseInternal.json()}};var pd=class{get text(){var e,t,n,i,r,o,a,l;if(((i=(n=(t=(e=this.candidates)===null||e===void 0?void 0:e[0])===null||t===void 0?void 0:t.content)===null||n===void 0?void 0:n.parts)===null||i===void 0?void 0:i.length)===0)return;this.candidates&&this.candidates.length>1&&console.warn("there are multiple candidates in the response, returning text from the first one.");let c="",d=!1,u=[];for(let h of(l=(a=(o=(r=this.candidates)===null||r===void 0?void 0:r[0])===null||o===void 0?void 0:o.content)===null||a===void 0?void 0:a.parts)!==null&&l!==void 0?l:[]){for(let[p,f]of Object.entries(h))p!=="text"&&p!=="thought"&&p!=="thoughtSignature"&&(f!==null||f!==void 0)&&u.push(p);if(typeof h.text=="string"){if(typeof h.thought=="boolean"&&h.thought)continue;d=!0,c+=h.text}}return u.length>0&&console.warn(`there are non-text parts ${u} in the response, returning concatenation of all text parts. Please refer to the non text parts for a full response from model.`),d?c:void 0}get data(){var e,t,n,i,r,o,a,l;if(((i=(n=(t=(e=this.candidates)===null||e===void 0?void 0:e[0])===null||t===void 0?void 0:t.content)===null||n===void 0?void 0:n.parts)===null||i===void 0?void 0:i.length)===0)return;this.candidates&&this.candidates.length>1&&console.warn("there are multiple candidates in the response, returning data from the first one.");let c="",d=[];for(let u of(l=(a=(o=(r=this.candidates)===null||r===void 0?void 0:r[0])===null||o===void 0?void 0:o.content)===null||a===void 0?void 0:a.parts)!==null&&l!==void 0?l:[]){for(let[h,p]of Object.entries(u))h!=="inlineData"&&(p!==null||p!==void 0)&&d.push(h);u.inlineData&&typeof u.inlineData.data=="string"&&(c+=atob(u.inlineData.data))}return d.length>0&&console.warn(`there are non-data parts ${d} in the response, returning concatenation of all data parts. Please refer to the non data parts for a full response from model.`),c.length>0?btoa(c):void 0}get functionCalls(){var e,t,n,i,r,o,a,l;if(((i=(n=(t=(e=this.candidates)===null||e===void 0?void 0:e[0])===null||t===void 0?void 0:t.content)===null||n===void 0?void 0:n.parts)===null||i===void 0?void 0:i.length)===0)return;this.candidates&&this.candidates.length>1&&console.warn("there are multiple candidates in the response, returning function calls from the first one.");let c=(l=(a=(o=(r=this.candidates)===null||r===void 0?void 0:r[0])===null||o===void 0?void 0:o.content)===null||a===void 0?void 0:a.parts)===null||l===void 0?void 0:l.filter(d=>d.functionCall).map(d=>d.functionCall).filter(d=>d!==void 0);if(c?.length!==0)return c}get executableCode(){var e,t,n,i,r,o,a,l,c;if(((i=(n=(t=(e=this.candidates)===null||e===void 0?void 0:e[0])===null||t===void 0?void 0:t.content)===null||n===void 0?void 0:n.parts)===null||i===void 0?void 0:i.length)===0)return;this.candidates&&this.candidates.length>1&&console.warn("there are multiple candidates in the response, returning executable code from the first one.");let d=(l=(a=(o=(r=this.candidates)===null||r===void 0?void 0:r[0])===null||o===void 0?void 0:o.content)===null||a===void 0?void 0:a.parts)===null||l===void 0?void 0:l.filter(u=>u.executableCode).map(u=>u.executableCode).filter(u=>u!==void 0);if(d?.length!==0)return(c=d?.[0])===null||c===void 0?void 0:c.code}get codeExecutionResult(){var e,t,n,i,r,o,a,l,c;if(((i=(n=(t=(e=this.candidates)===null||e===void 0?void 0:e[0])===null||t===void 0?void 0:t.content)===null||n===void 0?void 0:n.parts)===null||i===void 0?void 0:i.length)===0)return;this.candidates&&this.candidates.length>1&&console.warn("there are multiple candidates in the response, returning code execution result from the first one.");let d=(l=(a=(o=(r=this.candidates)===null||r===void 0?void 0:r[0])===null||o===void 0?void 0:o.content)===null||a===void 0?void 0:a.parts)===null||l===void 0?void 0:l.filter(u=>u.codeExecutionResult).map(u=>u.codeExecutionResult).filter(u=>u!==void 0);if(d?.length!==0)return(c=d?.[0])===null||c===void 0?void 0:c.output}},ww=class{},Mw=class{},ZC=class{},eA=class{},tA=class{},nA=class{},Tw=class{},Ew=class{},xw=class{},sA=class{};var Sw=class s{_fromAPIResponse({apiResponse:e,_isVertexAI:t}){let n=new s,i,r=e;return t?i=rX(r):i=iX(r),Object.assign(n,i),n}},Cw=class{},Aw=class{},Pw=class{},kw=class{},iA=class{},rA=class{},oA=class{};var aA=class s{_fromAPIResponse({apiResponse:e,_isVertexAI:t}){let n=new s,r=hX(e);return Object.assign(n,r),n}},lA=class{},cA=class{},dA=class{};var Iw=class{};var uA=class{get text(){var e,t,n;let i="",r=!1,o=[];for(let a of(n=(t=(e=this.serverContent)===null||e===void 0?void 0:e.modelTurn)===null||t===void 0?void 0:t.parts)!==null&&n!==void 0?n:[]){for(let[l,c]of Object.entries(a))l!=="text"&&l!=="thought"&&c!==null&&o.push(l);if(typeof a.text=="string"){if(typeof a.thought=="boolean"&&a.thought)continue;r=!0,i+=a.text}}return o.length>0&&console.warn(`there are non-text parts ${o} in the response, returning concatenation of all text parts. Please refer to the non text parts for a full response from model.`),r?i:void 0}get data(){var e,t,n;let i="",r=[];for(let o of(n=(t=(e=this.serverContent)===null||e===void 0?void 0:e.modelTurn)===null||t===void 0?void 0:t.parts)!==null&&n!==void 0?n:[]){for(let[a,l]of Object.entries(o))a!=="inlineData"&&l!==null&&r.push(a);o.inlineData&&typeof o.inlineData.data=="string"&&(i+=atob(o.inlineData.data))}return r.length>0&&console.warn(`there are non-data parts ${r} in the response, returning concatenation of all data parts. Please refer to the non data parts for a full response from model.`),i.length>0?btoa(i):void 0}};var hA=class{get audioChunk(){if(this.serverContent&&this.serverContent.audioChunks&&this.serverContent.audioChunks.length>0)return this.serverContent.audioChunks[0]}};var pA=class s{_fromAPIResponse({apiResponse:e,_isVertexAI:t}){let n=new s,r=lU(e);return Object.assign(n,r),n}};function xn(s,e){if(!e||typeof e!="string")throw new Error("model is required and must be a string");if(e.includes("..")||e.includes("?")||e.includes("&"))throw new Error("invalid model parameter");if(s.isVertexAI()){if(e.startsWith("publishers/")||e.startsWith("projects/")||e.startsWith("models/"))return e;if(e.indexOf("/")>=0){let t=e.split("/",2);return`publishers/${t[0]}/models/${t[1]}`}else return`publishers/google/models/${e}`}else return e.startsWith("models/")||e.startsWith("tunedModels/")?e:`models/${e}`}function cU(s,e){let t=xn(s,e);return t?t.startsWith("publishers/")&&s.isVertexAI()?`projects/${s.getProject()}/locations/${s.getLocation()}/${t}`:t.startsWith("models/")&&s.isVertexAI()?`projects/${s.getProject()}/locations/${s.getLocation()}/publishers/google/${t}`:t:""}function dU(s){return Array.isArray(s)?s.map(e=>Dw(e)):[Dw(s)]}function Dw(s){if(typeof s=="object"&&s!==null)return s;throw new Error(`Could not parse input as Blob. Unsupported blob type: ${typeof s}`)}function uU(s){let e=Dw(s);if(e.mimeType&&e.mimeType.startsWith("image/"))return e;throw new Error(`Unsupported mime type: ${e.mimeType}`)}function hU(s){let e=Dw(s);if(e.mimeType&&e.mimeType.startsWith("audio/"))return e;throw new Error(`Unsupported mime type: ${e.mimeType}`)}function Oz(s){if(s==null)throw new Error("PartUnion is required");if(typeof s=="object")return s;if(typeof s=="string")return{text:s};throw new Error(`Unsupported part type: ${typeof s}`)}function pU(s){if(s==null||Array.isArray(s)&&s.length===0)throw new Error("PartListUnion is required");return Array.isArray(s)?s.map(e=>Oz(e)):[Oz(s)]}function fA(s){return s!=null&&typeof s=="object"&&"parts"in s&&Array.isArray(s.parts)}function $z(s){return s!=null&&typeof s=="object"&&"functionCall"in s}function Bz(s){return s!=null&&typeof s=="object"&&"functionResponse"in s}function gi(s){if(s==null)throw new Error("ContentUnion is required");return fA(s)?s:{role:"user",parts:pU(s)}}function XA(s,e){if(!e)return[];if(s.isVertexAI()&&Array.isArray(e))return e.flatMap(t=>{let n=gi(t);return n.parts&&n.parts.length>0&&n.parts[0].text!==void 0?[n.parts[0].text]:[]});if(s.isVertexAI()){let t=gi(e);return t.parts&&t.parts.length>0&&t.parts[0].text!==void 0?[t.parts[0].text]:[]}return Array.isArray(e)?e.map(t=>gi(t)):[gi(e)]}function Rr(s){if(s==null||Array.isArray(s)&&s.length===0)throw new Error("contents are required");if(!Array.isArray(s)){if($z(s)||Bz(s))throw new Error("To specify functionCall or functionResponse parts, please wrap them in a Content object, specifying the role for them");return[gi(s)]}let e=[],t=[],n=fA(s[0]);for(let i of s){let r=fA(i);if(r!=n)throw new Error("Mixing Content and Parts is not supported, please group the parts into a the appropriate Content objects and specify the roles for them");if(r)e.push(i);else{if($z(i)||Bz(i))throw new Error("To specify functionCall or functionResponse parts, please wrap them, and any other parts, in Content objects as appropriate, specifying the role for them");t.push(i)}}return n||e.push({role:"user",parts:pU(t)}),e}function _X(s,e){s.includes("null")&&(e.nullable=!0);let t=s.filter(n=>n!=="null");if(t.length===1)e.type=Object.values(Ul).includes(t[0].toUpperCase())?t[0].toUpperCase():Ul.TYPE_UNSPECIFIED;else{e.anyOf=[];for(let n of t)e.anyOf.push({type:Object.values(Ul).includes(n.toUpperCase())?n.toUpperCase():Ul.TYPE_UNSPECIFIED})}}function Gh(s){let e={},t=["items"],n=["anyOf"],i=["properties"];if(s.type&&s.anyOf)throw new Error("type and anyOf cannot be both populated.");let r=s.anyOf;r!=null&&r.length==2&&(r[0].type==="null"?(e.nullable=!0,s=r[1]):r[1].type==="null"&&(e.nullable=!0,s=r[0])),s.type instanceof Array&&_X(s.type,e);for(let[o,a]of Object.entries(s))if(a!=null)if(o=="type"){if(a==="null")throw new Error("type: null can not be the only possible type for the field.");if(a instanceof Array)continue;e.type=Object.values(Ul).includes(a.toUpperCase())?a.toUpperCase():Ul.TYPE_UNSPECIFIED}else if(t.includes(o))e[o]=Gh(a);else if(n.includes(o)){let l=[];for(let c of a){if(c.type=="null"){e.nullable=!0;continue}l.push(Gh(c))}e[o]=l}else if(i.includes(o)){let l={};for(let[c,d]of Object.entries(a))l[c]=Gh(d);e[o]=l}else{if(o==="additionalProperties")continue;e[o]=a}return e}function QA(s){return Gh(s)}function JA(s){if(typeof s=="object")return s;if(typeof s=="string")return{voiceConfig:{prebuiltVoiceConfig:{voiceName:s}}};throw new Error(`Unsupported speechConfig type: ${typeof s}`)}function ZA(s){if("multiSpeakerVoiceConfig"in s)throw new Error("multiSpeakerVoiceConfig is not supported in the live API.");return s}function qh(s){if(s.functionDeclarations)for(let e of s.functionDeclarations)e.parameters&&(Object.keys(e.parameters).includes("$schema")?e.parametersJsonSchema||(e.parametersJsonSchema=e.parameters,delete e.parameters):e.parameters=Gh(e.parameters)),e.response&&(Object.keys(e.response).includes("$schema")?e.responseJsonSchema||(e.responseJsonSchema=e.response,delete e.response):e.response=Gh(e.response));return s}function Kh(s){if(s==null)throw new Error("tools is required");if(!Array.isArray(s))throw new Error("tools is required and must be an array of Tools");let e=[];for(let t of s)e.push(t);return e}function yX(s,e,t,n=1){let i=!e.startsWith(`${t}/`)&&e.split("/").length===n;return s.isVertexAI()?e.startsWith("projects/")?e:e.startsWith("locations/")?`projects/${s.getProject()}/${e}`:e.startsWith(`${t}/`)?`projects/${s.getProject()}/locations/${s.getLocation()}/${e}`:i?`projects/${s.getProject()}/locations/${s.getLocation()}/${t}/${e}`:e:i?`${t}/${e}`:e}function Ua(s,e){if(typeof e!="string")throw new Error("name must be a string");return yX(s,e,"cachedContents")}function fU(s){switch(s){case"STATE_UNSPECIFIED":return"JOB_STATE_UNSPECIFIED";case"CREATING":return"JOB_STATE_RUNNING";case"ACTIVE":return"JOB_STATE_SUCCEEDED";case"FAILED":return"JOB_STATE_FAILED";default:return s}}function Vl(s){return YA(s)}function vX(s){return s!=null&&typeof s=="object"&&"name"in s}function bX(s){return s!=null&&typeof s=="object"&&"video"in s}function wX(s){return s!=null&&typeof s=="object"&&"uri"in s}function mU(s){var e;let t;if(vX(s)&&(t=s.name),!(wX(s)&&(t=s.uri,t===void 0))&&!(bX(s)&&(t=(e=s.video)===null||e===void 0?void 0:e.uri,t===void 0))){if(typeof s=="string"&&(t=s),t===void 0)throw new Error("Could not extract file name from the provided input.");if(t.startsWith("https://")){let i=t.split("files/")[1].match(/[a-z0-9]+/);if(i===null)throw new Error(`Could not extract file name from URI ${t}`);t=i[0]}else t.startsWith("files/")&&(t=t.split("files/")[1]);return t}}function gU(s,e){let t;return s.isVertexAI()?t=e?"publishers/google/models":"models":t=e?"models":"tunedModels",t}function _U(s){for(let e of["models","tunedModels","publisherModels"])if(MX(s,e))return s[e];return[]}function MX(s,e){return s!==null&&typeof s=="object"&&e in s}function TX(s,e={}){let t=s,n={name:t.name,description:t.description,parametersJsonSchema:t.inputSchema};return t.outputSchema&&(n.responseJsonSchema=t.outputSchema),e.behavior&&(n.behavior=e.behavior),{functionDeclarations:[n]}}function EX(s,e={}){let t=[],n=new Set;for(let i of s){let r=i.name;if(n.has(r))throw new Error(`Duplicate function name ${r} found in MCP tools. Please ensure function names are unique.`);n.add(r);let o=TX(i,e);o.functionDeclarations&&t.push(...o.functionDeclarations)}return{functionDeclarations:t}}function yU(s,e){let t;if(typeof e=="string")if(s.isVertexAI())if(e.startsWith("gs://"))t={format:"jsonl",gcsUri:[e]};else if(e.startsWith("bq://"))t={format:"bigquery",bigqueryUri:e};else throw new Error(`Unsupported string source for Vertex AI: ${e}`);else if(e.startsWith("files/"))t={fileName:e};else throw new Error(`Unsupported string source for Gemini API: ${e}`);else if(Array.isArray(e)){if(s.isVertexAI())throw new Error("InlinedRequest[] is not supported in Vertex AI.");t={inlinedRequests:e}}else t=e;let n=[t.gcsUri,t.bigqueryUri].filter(Boolean).length,i=[t.inlinedRequests,t.fileName].filter(Boolean).length;if(s.isVertexAI()){if(i>0||n!==1)throw new Error("Exactly one of `gcsUri` or `bigqueryUri` must be set for Vertex AI.")}else if(n>0||i!==1)throw new Error("Exactly one of `inlinedRequests`, `fileName`, must be set for Gemini API.");return t}function xX(s){if(typeof s!="string")return s;let e=s;if(e.startsWith("gs://"))return{format:"jsonl",gcsUri:e};if(e.startsWith("bq://"))return{format:"bigquery",bigqueryUri:e};throw new Error(`Unsupported destination: ${e}`)}function vU(s){if(typeof s!="object"||s===null)return{};let e=s,t=e.inlinedResponses;if(typeof t!="object"||t===null)return s;let i=t.inlinedResponses;if(!Array.isArray(i)||i.length===0)return s;let r=!1;for(let o of i){if(typeof o!="object"||o===null)continue;let l=o.response;if(typeof l!="object"||l===null)continue;if(l.embedding!==void 0){r=!0;break}}return r&&(e.inlinedEmbedContentResponses=e.inlinedResponses,delete e.inlinedResponses),s}function Yh(s,e){let t=e;if(!s.isVertexAI()){if(/batches\/[^/]+$/.test(t))return t.split("/").pop();throw new Error(`Invalid batch job name: ${t}.`)}if(/^projects\/[^/]+\/locations\/[^/]+\/batchPredictionJobs\/[^/]+$/.test(t))return t.split("/").pop();if(/^\d+$/.test(t))return t;throw new Error(`Invalid batch job name: ${t}.`)}function bU(s){let e=s;return e==="BATCH_STATE_UNSPECIFIED"?"JOB_STATE_UNSPECIFIED":e==="BATCH_STATE_PENDING"?"JOB_STATE_PENDING":e==="BATCH_STATE_RUNNING"?"JOB_STATE_RUNNING":e==="BATCH_STATE_SUCCEEDED"?"JOB_STATE_SUCCEEDED":e==="BATCH_STATE_FAILED"?"JOB_STATE_FAILED":e==="BATCH_STATE_CANCELLED"?"JOB_STATE_CANCELLED":e==="BATCH_STATE_EXPIRED"?"JOB_STATE_EXPIRED":e}function SX(s){let e={},t=g(s,["responsesFile"]);t!=null&&v(e,["fileName"],t);let n=g(s,["inlinedResponses","inlinedResponses"]);if(n!=null){let r=n;Array.isArray(r)&&(r=r.map(o=>oQ(o))),v(e,["inlinedResponses"],r)}let i=g(s,["inlinedEmbedContentResponses","inlinedResponses"]);if(i!=null){let r=i;Array.isArray(r)&&(r=r.map(o=>o)),v(e,["inlinedEmbedContentResponses"],r)}return e}function CX(s){let e={},t=g(s,["predictionsFormat"]);t!=null&&v(e,["format"],t);let n=g(s,["gcsDestination","outputUriPrefix"]);n!=null&&v(e,["gcsUri"],n);let i=g(s,["bigqueryDestination","outputUri"]);return i!=null&&v(e,["bigqueryUri"],i),e}function AX(s){let e={},t=g(s,["format"]);t!=null&&v(e,["predictionsFormat"],t);let n=g(s,["gcsUri"]);n!=null&&v(e,["gcsDestination","outputUriPrefix"],n);let i=g(s,["bigqueryUri"]);if(i!=null&&v(e,["bigqueryDestination","outputUri"],i),g(s,["fileName"])!==void 0)throw new Error("fileName parameter is not supported in Vertex AI.");if(g(s,["inlinedResponses"])!==void 0)throw new Error("inlinedResponses parameter is not supported in Vertex AI.");if(g(s,["inlinedEmbedContentResponses"])!==void 0)throw new Error("inlinedEmbedContentResponses parameter is not supported in Vertex AI.");return e}function yw(s){let e={},t=g(s,["name"]);t!=null&&v(e,["name"],t);let n=g(s,["metadata","displayName"]);n!=null&&v(e,["displayName"],n);let i=g(s,["metadata","state"]);i!=null&&v(e,["state"],bU(i));let r=g(s,["metadata","createTime"]);r!=null&&v(e,["createTime"],r);let o=g(s,["metadata","endTime"]);o!=null&&v(e,["endTime"],o);let a=g(s,["metadata","updateTime"]);a!=null&&v(e,["updateTime"],a);let l=g(s,["metadata","model"]);l!=null&&v(e,["model"],l);let c=g(s,["metadata","output"]);return c!=null&&v(e,["dest"],SX(vU(c))),e}function mA(s){let e={},t=g(s,["name"]);t!=null&&v(e,["name"],t);let n=g(s,["displayName"]);n!=null&&v(e,["displayName"],n);let i=g(s,["state"]);i!=null&&v(e,["state"],bU(i));let r=g(s,["error"]);r!=null&&v(e,["error"],r);let o=g(s,["createTime"]);o!=null&&v(e,["createTime"],o);let a=g(s,["startTime"]);a!=null&&v(e,["startTime"],a);let l=g(s,["endTime"]);l!=null&&v(e,["endTime"],l);let c=g(s,["updateTime"]);c!=null&&v(e,["updateTime"],c);let d=g(s,["model"]);d!=null&&v(e,["model"],d);let u=g(s,["inputConfig"]);u!=null&&v(e,["src"],PX(u));let h=g(s,["outputConfig"]);h!=null&&v(e,["dest"],CX(vU(h)));let p=g(s,["completionStats"]);return p!=null&&v(e,["completionStats"],p),e}function PX(s){let e={},t=g(s,["instancesFormat"]);t!=null&&v(e,["format"],t);let n=g(s,["gcsSource","uris"]);n!=null&&v(e,["gcsUri"],n);let i=g(s,["bigquerySource","inputUri"]);return i!=null&&v(e,["bigqueryUri"],i),e}function kX(s,e){let t={};if(g(e,["format"])!==void 0)throw new Error("format parameter is not supported in Gemini API.");if(g(e,["gcsUri"])!==void 0)throw new Error("gcsUri parameter is not supported in Gemini API.");if(g(e,["bigqueryUri"])!==void 0)throw new Error("bigqueryUri parameter is not supported in Gemini API.");let n=g(e,["fileName"]);n!=null&&v(t,["fileName"],n);let i=g(e,["inlinedRequests"]);if(i!=null){let r=i;Array.isArray(r)&&(r=r.map(o=>rQ(s,o))),v(t,["requests","requests"],r)}return t}function IX(s){let e={},t=g(s,["format"]);t!=null&&v(e,["instancesFormat"],t);let n=g(s,["gcsUri"]);n!=null&&v(e,["gcsSource","uris"],n);let i=g(s,["bigqueryUri"]);if(i!=null&&v(e,["bigquerySource","inputUri"],i),g(s,["fileName"])!==void 0)throw new Error("fileName parameter is not supported in Vertex AI.");if(g(s,["inlinedRequests"])!==void 0)throw new Error("inlinedRequests parameter is not supported in Vertex AI.");return e}function DX(s){let e={},t=g(s,["data"]);if(t!=null&&v(e,["data"],t),g(s,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");let n=g(s,["mimeType"]);return n!=null&&v(e,["mimeType"],n),e}function RX(s,e){let t={},n=g(e,["name"]);return n!=null&&v(t,["_url","name"],Yh(s,n)),t}function FX(s,e){let t={},n=g(e,["name"]);return n!=null&&v(t,["_url","name"],Yh(s,n)),t}function LX(s){let e={},t=g(s,["content"]);t!=null&&v(e,["content"],t);let n=g(s,["citationMetadata"]);n!=null&&v(e,["citationMetadata"],NX(n));let i=g(s,["tokenCount"]);i!=null&&v(e,["tokenCount"],i);let r=g(s,["finishReason"]);r!=null&&v(e,["finishReason"],r);let o=g(s,["avgLogprobs"]);o!=null&&v(e,["avgLogprobs"],o);let a=g(s,["groundingMetadata"]);a!=null&&v(e,["groundingMetadata"],a);let l=g(s,["index"]);l!=null&&v(e,["index"],l);let c=g(s,["logprobsResult"]);c!=null&&v(e,["logprobsResult"],c);let d=g(s,["safetyRatings"]);if(d!=null){let h=d;Array.isArray(h)&&(h=h.map(p=>p)),v(e,["safetyRatings"],h)}let u=g(s,["urlContextMetadata"]);return u!=null&&v(e,["urlContextMetadata"],u),e}function NX(s){let e={},t=g(s,["citationSources"]);if(t!=null){let n=t;Array.isArray(n)&&(n=n.map(i=>i)),v(e,["citations"],n)}return e}function wU(s){let e={},t=g(s,["parts"]);if(t!=null){let i=t;Array.isArray(i)&&(i=i.map(r=>pQ(r))),v(e,["parts"],i)}let n=g(s,["role"]);return n!=null&&v(e,["role"],n),e}function OX(s,e){let t={},n=g(s,["displayName"]);if(e!==void 0&&n!=null&&v(e,["batch","displayName"],n),g(s,["dest"])!==void 0)throw new Error("dest parameter is not supported in Gemini API.");return t}function $X(s,e){let t={},n=g(s,["displayName"]);e!==void 0&&n!=null&&v(e,["displayName"],n);let i=g(s,["dest"]);return e!==void 0&&i!=null&&v(e,["outputConfig"],AX(xX(i))),t}function zz(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["_url","model"],xn(s,n));let i=g(e,["src"]);i!=null&&v(t,["batch","inputConfig"],kX(s,yU(s,i)));let r=g(e,["config"]);return r!=null&&OX(r,t),t}function BX(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["model"],xn(s,n));let i=g(e,["src"]);i!=null&&v(t,["inputConfig"],IX(yU(s,i)));let r=g(e,["config"]);return r!=null&&$X(r,t),t}function zX(s,e){let t={},n=g(s,["displayName"]);return e!==void 0&&n!=null&&v(e,["batch","displayName"],n),t}function UX(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["_url","model"],xn(s,n));let i=g(e,["src"]);i!=null&&v(t,["batch","inputConfig"],KX(s,i));let r=g(e,["config"]);return r!=null&&zX(r,t),t}function VX(s,e){let t={},n=g(e,["name"]);return n!=null&&v(t,["_url","name"],Yh(s,n)),t}function GX(s,e){let t={},n=g(e,["name"]);return n!=null&&v(t,["_url","name"],Yh(s,n)),t}function WX(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["name"]);n!=null&&v(e,["name"],n);let i=g(s,["done"]);i!=null&&v(e,["done"],i);let r=g(s,["error"]);return r!=null&&v(e,["error"],r),e}function HX(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["name"]);n!=null&&v(e,["name"],n);let i=g(s,["done"]);i!=null&&v(e,["done"],i);let r=g(s,["error"]);return r!=null&&v(e,["error"],r),e}function jX(s,e){let t={},n=g(e,["contents"]);if(n!=null){let r=XA(s,n);Array.isArray(r)&&(r=r.map(o=>o)),v(t,["requests[]","request","content"],r)}let i=g(e,["config"]);return i!=null&&(v(t,["_self"],qX(i,t)),nX(t,{"requests[].*":"requests[].request.*"})),t}function qX(s,e){let t={},n=g(s,["taskType"]);e!==void 0&&n!=null&&v(e,["requests[]","taskType"],n);let i=g(s,["title"]);e!==void 0&&i!=null&&v(e,["requests[]","title"],i);let r=g(s,["outputDimensionality"]);if(e!==void 0&&r!=null&&v(e,["requests[]","outputDimensionality"],r),g(s,["mimeType"])!==void 0)throw new Error("mimeType parameter is not supported in Gemini API.");if(g(s,["autoTruncate"])!==void 0)throw new Error("autoTruncate parameter is not supported in Gemini API.");return t}function KX(s,e){let t={},n=g(e,["fileName"]);n!=null&&v(t,["file_name"],n);let i=g(e,["inlinedRequests"]);return i!=null&&v(t,["requests"],jX(s,i)),t}function YX(s){let e={};if(g(s,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");let t=g(s,["fileUri"]);t!=null&&v(e,["fileUri"],t);let n=g(s,["mimeType"]);return n!=null&&v(e,["mimeType"],n),e}function XX(s){let e={},t=g(s,["id"]);t!=null&&v(e,["id"],t);let n=g(s,["args"]);n!=null&&v(e,["args"],n);let i=g(s,["name"]);if(i!=null&&v(e,["name"],i),g(s,["partialArgs"])!==void 0)throw new Error("partialArgs parameter is not supported in Gemini API.");if(g(s,["willContinue"])!==void 0)throw new Error("willContinue parameter is not supported in Gemini API.");return e}function QX(s){let e={},t=g(s,["mode"]);t!=null&&v(e,["mode"],t);let n=g(s,["allowedFunctionNames"]);if(n!=null&&v(e,["allowedFunctionNames"],n),g(s,["streamFunctionCallArguments"])!==void 0)throw new Error("streamFunctionCallArguments parameter is not supported in Gemini API.");return e}function JX(s,e,t){let n={},i=g(e,["systemInstruction"]);t!==void 0&&i!=null&&v(t,["systemInstruction"],wU(gi(i)));let r=g(e,["temperature"]);r!=null&&v(n,["temperature"],r);let o=g(e,["topP"]);o!=null&&v(n,["topP"],o);let a=g(e,["topK"]);a!=null&&v(n,["topK"],a);let l=g(e,["candidateCount"]);l!=null&&v(n,["candidateCount"],l);let c=g(e,["maxOutputTokens"]);c!=null&&v(n,["maxOutputTokens"],c);let d=g(e,["stopSequences"]);d!=null&&v(n,["stopSequences"],d);let u=g(e,["responseLogprobs"]);u!=null&&v(n,["responseLogprobs"],u);let h=g(e,["logprobs"]);h!=null&&v(n,["logprobs"],h);let p=g(e,["presencePenalty"]);p!=null&&v(n,["presencePenalty"],p);let f=g(e,["frequencyPenalty"]);f!=null&&v(n,["frequencyPenalty"],f);let _=g(e,["seed"]);_!=null&&v(n,["seed"],_);let b=g(e,["responseMimeType"]);b!=null&&v(n,["responseMimeType"],b);let y=g(e,["responseSchema"]);y!=null&&v(n,["responseSchema"],QA(y));let w=g(e,["responseJsonSchema"]);if(w!=null&&v(n,["responseJsonSchema"],w),g(e,["routingConfig"])!==void 0)throw new Error("routingConfig parameter is not supported in Gemini API.");if(g(e,["modelSelectionConfig"])!==void 0)throw new Error("modelSelectionConfig parameter is not supported in Gemini API.");let C=g(e,["safetySettings"]);if(t!==void 0&&C!=null){let z=C;Array.isArray(z)&&(z=z.map(ne=>fQ(ne))),v(t,["safetySettings"],z)}let M=g(e,["tools"]);if(t!==void 0&&M!=null){let z=Kh(M);Array.isArray(z)&&(z=z.map(ne=>gQ(qh(ne)))),v(t,["tools"],z)}let S=g(e,["toolConfig"]);if(t!==void 0&&S!=null&&v(t,["toolConfig"],mQ(S)),g(e,["labels"])!==void 0)throw new Error("labels parameter is not supported in Gemini API.");let k=g(e,["cachedContent"]);t!==void 0&&k!=null&&v(t,["cachedContent"],Ua(s,k));let T=g(e,["responseModalities"]);T!=null&&v(n,["responseModalities"],T);let P=g(e,["mediaResolution"]);P!=null&&v(n,["mediaResolution"],P);let R=g(e,["speechConfig"]);if(R!=null&&v(n,["speechConfig"],JA(R)),g(e,["audioTimestamp"])!==void 0)throw new Error("audioTimestamp parameter is not supported in Gemini API.");let O=g(e,["thinkingConfig"]);O!=null&&v(n,["thinkingConfig"],O);let H=g(e,["imageConfig"]);H!=null&&v(n,["imageConfig"],iQ(H));let X=g(e,["enableEnhancedCivicAnswers"]);return X!=null&&v(n,["enableEnhancedCivicAnswers"],X),n}function ZX(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["candidates"]);if(n!=null){let l=n;Array.isArray(l)&&(l=l.map(c=>LX(c))),v(e,["candidates"],l)}let i=g(s,["modelVersion"]);i!=null&&v(e,["modelVersion"],i);let r=g(s,["promptFeedback"]);r!=null&&v(e,["promptFeedback"],r);let o=g(s,["responseId"]);o!=null&&v(e,["responseId"],o);let a=g(s,["usageMetadata"]);return a!=null&&v(e,["usageMetadata"],a),e}function eQ(s,e){let t={},n=g(e,["name"]);return n!=null&&v(t,["_url","name"],Yh(s,n)),t}function tQ(s,e){let t={},n=g(e,["name"]);return n!=null&&v(t,["_url","name"],Yh(s,n)),t}function nQ(s){let e={};if(g(s,["authConfig"])!==void 0)throw new Error("authConfig parameter is not supported in Gemini API.");let t=g(s,["enableWidget"]);return t!=null&&v(e,["enableWidget"],t),e}function sQ(s){let e={};if(g(s,["excludeDomains"])!==void 0)throw new Error("excludeDomains parameter is not supported in Gemini API.");if(g(s,["blockingConfidence"])!==void 0)throw new Error("blockingConfidence parameter is not supported in Gemini API.");let t=g(s,["timeRangeFilter"]);return t!=null&&v(e,["timeRangeFilter"],t),e}function iQ(s){let e={},t=g(s,["aspectRatio"]);t!=null&&v(e,["aspectRatio"],t);let n=g(s,["imageSize"]);if(n!=null&&v(e,["imageSize"],n),g(s,["outputMimeType"])!==void 0)throw new Error("outputMimeType parameter is not supported in Gemini API.");if(g(s,["outputCompressionQuality"])!==void 0)throw new Error("outputCompressionQuality parameter is not supported in Gemini API.");return e}function rQ(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["request","model"],xn(s,n));let i=g(e,["contents"]);if(i!=null){let a=Rr(i);Array.isArray(a)&&(a=a.map(l=>wU(l))),v(t,["request","contents"],a)}let r=g(e,["metadata"]);r!=null&&v(t,["metadata"],r);let o=g(e,["config"]);return o!=null&&v(t,["request","generationConfig"],JX(s,o,g(t,["request"],{}))),t}function oQ(s){let e={},t=g(s,["response"]);t!=null&&v(e,["response"],ZX(t));let n=g(s,["error"]);return n!=null&&v(e,["error"],n),e}function aQ(s,e){let t={},n=g(s,["pageSize"]);e!==void 0&&n!=null&&v(e,["_query","pageSize"],n);let i=g(s,["pageToken"]);if(e!==void 0&&i!=null&&v(e,["_query","pageToken"],i),g(s,["filter"])!==void 0)throw new Error("filter parameter is not supported in Gemini API.");return t}function lQ(s,e){let t={},n=g(s,["pageSize"]);e!==void 0&&n!=null&&v(e,["_query","pageSize"],n);let i=g(s,["pageToken"]);e!==void 0&&i!=null&&v(e,["_query","pageToken"],i);let r=g(s,["filter"]);return e!==void 0&&r!=null&&v(e,["_query","filter"],r),t}function cQ(s){let e={},t=g(s,["config"]);return t!=null&&aQ(t,e),e}function dQ(s){let e={},t=g(s,["config"]);return t!=null&&lQ(t,e),e}function uQ(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["nextPageToken"]);n!=null&&v(e,["nextPageToken"],n);let i=g(s,["operations"]);if(i!=null){let r=i;Array.isArray(r)&&(r=r.map(o=>yw(o))),v(e,["batchJobs"],r)}return e}function hQ(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["nextPageToken"]);n!=null&&v(e,["nextPageToken"],n);let i=g(s,["batchPredictionJobs"]);if(i!=null){let r=i;Array.isArray(r)&&(r=r.map(o=>mA(o))),v(e,["batchJobs"],r)}return e}function pQ(s){let e={},t=g(s,["mediaResolution"]);t!=null&&v(e,["mediaResolution"],t);let n=g(s,["codeExecutionResult"]);n!=null&&v(e,["codeExecutionResult"],n);let i=g(s,["executableCode"]);i!=null&&v(e,["executableCode"],i);let r=g(s,["fileData"]);r!=null&&v(e,["fileData"],YX(r));let o=g(s,["functionCall"]);o!=null&&v(e,["functionCall"],XX(o));let a=g(s,["functionResponse"]);a!=null&&v(e,["functionResponse"],a);let l=g(s,["inlineData"]);l!=null&&v(e,["inlineData"],DX(l));let c=g(s,["text"]);c!=null&&v(e,["text"],c);let d=g(s,["thought"]);d!=null&&v(e,["thought"],d);let u=g(s,["thoughtSignature"]);u!=null&&v(e,["thoughtSignature"],u);let h=g(s,["videoMetadata"]);return h!=null&&v(e,["videoMetadata"],h),e}function fQ(s){let e={},t=g(s,["category"]);if(t!=null&&v(e,["category"],t),g(s,["method"])!==void 0)throw new Error("method parameter is not supported in Gemini API.");let n=g(s,["threshold"]);return n!=null&&v(e,["threshold"],n),e}function mQ(s){let e={},t=g(s,["functionCallingConfig"]);t!=null&&v(e,["functionCallingConfig"],QX(t));let n=g(s,["retrievalConfig"]);return n!=null&&v(e,["retrievalConfig"],n),e}function gQ(s){let e={},t=g(s,["functionDeclarations"]);if(t!=null){let d=t;Array.isArray(d)&&(d=d.map(u=>u)),v(e,["functionDeclarations"],d)}if(g(s,["retrieval"])!==void 0)throw new Error("retrieval parameter is not supported in Gemini API.");let n=g(s,["googleSearchRetrieval"]);n!=null&&v(e,["googleSearchRetrieval"],n);let i=g(s,["computerUse"]);i!=null&&v(e,["computerUse"],i);let r=g(s,["fileSearch"]);r!=null&&v(e,["fileSearch"],r);let o=g(s,["codeExecution"]);if(o!=null&&v(e,["codeExecution"],o),g(s,["enterpriseWebSearch"])!==void 0)throw new Error("enterpriseWebSearch parameter is not supported in Gemini API.");let a=g(s,["googleMaps"]);a!=null&&v(e,["googleMaps"],nQ(a));let l=g(s,["googleSearch"]);l!=null&&v(e,["googleSearch"],sQ(l));let c=g(s,["urlContext"]);return c!=null&&v(e,["urlContext"],c),e}var Ba;(function(s){s.PAGED_ITEM_BATCH_JOBS="batchJobs",s.PAGED_ITEM_MODELS="models",s.PAGED_ITEM_TUNING_JOBS="tuningJobs",s.PAGED_ITEM_FILES="files",s.PAGED_ITEM_CACHED_CONTENTS="cachedContents",s.PAGED_ITEM_FILE_SEARCH_STORES="fileSearchStores",s.PAGED_ITEM_DOCUMENTS="documents"})(Ba||(Ba={}));var za=class{constructor(e,t,n,i){this.pageInternal=[],this.paramsInternal={},this.requestInternal=t,this.init(e,n,i)}init(e,t,n){var i,r;this.nameInternal=e,this.pageInternal=t[this.nameInternal]||[],this.sdkHttpResponseInternal=t?.sdkHttpResponse,this.idxInternal=0;let o={config:{}};!n||Object.keys(n).length===0?o={config:{}}:typeof n=="object"?o=Object.assign({},n):o=n,o.config&&(o.config.pageToken=t.nextPageToken),this.paramsInternal=o,this.pageInternalSize=(r=(i=o.config)===null||i===void 0?void 0:i.pageSize)!==null&&r!==void 0?r:this.pageInternal.length}initNextPage(e){this.init(this.nameInternal,e,this.paramsInternal)}get page(){return this.pageInternal}get name(){return this.nameInternal}get pageSize(){return this.pageInternalSize}get sdkHttpResponse(){return this.sdkHttpResponseInternal}get params(){return this.paramsInternal}get pageLength(){return this.pageInternal.length}getItem(e){return this.pageInternal[e]}[Symbol.asyncIterator](){return{next:async()=>{if(this.idxInternal>=this.pageLength)if(this.hasNextPage())await this.nextPage();else return{value:void 0,done:!0};let e=this.getItem(this.idxInternal);return this.idxInternal+=1,{value:e,done:!1}},return:async()=>({value:void 0,done:!0})}}async nextPage(){if(!this.hasNextPage())throw new Error("No more pages to fetch.");let e=await this.requestInternal(this.params);return this.initNextPage(e),this.page}hasNextPage(){var e;return((e=this.params.config)===null||e===void 0?void 0:e.pageToken)!==void 0}};var gA=class extends oo{constructor(e){super(),this.apiClient=e,this.list=async(t={})=>new za(Ba.PAGED_ITEM_BATCH_JOBS,n=>this.listInternal(n),await this.listInternal(t),t),this.create=async t=>(this.apiClient.isVertexAI()&&(t.config=this.formatDestination(t.src,t.config)),this.createInternal(t)),this.createEmbeddings=async t=>{if(console.warn("batches.createEmbeddings() is experimental and may change without notice."),this.apiClient.isVertexAI())throw new Error("Vertex AI does not support batches.createEmbeddings.");return this.createEmbeddingsInternal(t)}}createInlinedGenerateContentRequest(e){let t=zz(this.apiClient,e),n=t._url,i=mt("{model}:batchGenerateContent",n),a=t.batch.inputConfig.requests,l=a.requests,c=[];for(let d of l){let u=Object.assign({},d);if(u.systemInstruction){let h=u.systemInstruction;delete u.systemInstruction;let p=u.request;p.systemInstruction=h,u.request=p}c.push(u)}return a.requests=c,delete t.config,delete t._url,delete t._query,{path:i,body:t}}getGcsUri(e){if(typeof e=="string")return e.startsWith("gs://")?e:void 0;if(!Array.isArray(e)&&e.gcsUri&&e.gcsUri.length>0)return e.gcsUri[0]}getBigqueryUri(e){if(typeof e=="string")return e.startsWith("bq://")?e:void 0;if(!Array.isArray(e))return e.bigqueryUri}formatDestination(e,t){let n=t?Object.assign({},t):{},i=Date.now().toString();if(n.displayName||(n.displayName=`genaiBatchJob_${i}`),n.dest===void 0){let r=this.getGcsUri(e),o=this.getBigqueryUri(e);if(r)r.endsWith(".jsonl")?n.dest=`${r.slice(0,-6)}/dest`:n.dest=`${r}_dest_${i}`;else if(o)n.dest=`${o}_dest_${i}`;else throw new Error("Unsupported source for Vertex AI: No GCS or BigQuery URI found.")}return n}async createInternal(e){var t,n,i,r;let o,a="",l={};if(this.apiClient.isVertexAI()){let c=BX(this.apiClient,e);return a=mt("batchPredictionJobs",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(d=>d.json()),o.then(d=>mA(d))}else{let c=zz(this.apiClient,e);return a=mt("{model}:batchGenerateContent",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json()),o.then(d=>yw(d))}}async createEmbeddingsInternal(e){var t,n;let i,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{let a=UX(this.apiClient,e);return r=mt("{model}:asyncBatchEmbedContent",a._url),o=a._query,delete a._url,delete a._query,i=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(l=>l.json()),i.then(l=>yw(l))}}async get(e){var t,n,i,r;let o,a="",l={};if(this.apiClient.isVertexAI()){let c=tQ(this.apiClient,e);return a=mt("batchPredictionJobs/{name}",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(d=>d.json()),o.then(d=>mA(d))}else{let c=eQ(this.apiClient,e);return a=mt("batches/{name}",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json()),o.then(d=>yw(d))}}async cancel(e){var t,n,i,r;let o="",a={};if(this.apiClient.isVertexAI()){let l=FX(this.apiClient,e);o=mt("batchPredictionJobs/{name}:cancel",l._url),a=l._query,delete l._url,delete l._query,await this.apiClient.request({path:o,queryParams:a,body:JSON.stringify(l),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal})}else{let l=RX(this.apiClient,e);o=mt("batches/{name}:cancel",l._url),a=l._query,delete l._url,delete l._query,await this.apiClient.request({path:o,queryParams:a,body:JSON.stringify(l),httpMethod:"POST",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal})}}async listInternal(e){var t,n,i,r;let o,a="",l={};if(this.apiClient.isVertexAI()){let c=dQ(e);return a=mt("batchPredictionJobs",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>{let u=hQ(d),h=new Iw;return Object.assign(h,u),h})}else{let c=cQ(e);return a=mt("batches",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>{let u=uQ(d),h=new Iw;return Object.assign(h,u),h})}}async delete(e){var t,n,i,r;let o,a="",l={};if(this.apiClient.isVertexAI()){let c=GX(this.apiClient,e);return a=mt("batchPredictionJobs/{name}",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"DELETE",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>HX(d))}else{let c=VX(this.apiClient,e);return a=mt("batches/{name}",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"DELETE",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>WX(d))}}};function _Q(s){let e={},t=g(s,["data"]);if(t!=null&&v(e,["data"],t),g(s,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");let n=g(s,["mimeType"]);return n!=null&&v(e,["mimeType"],n),e}function Uz(s){let e={},t=g(s,["parts"]);if(t!=null){let i=t;Array.isArray(i)&&(i=i.map(r=>zQ(r))),v(e,["parts"],i)}let n=g(s,["role"]);return n!=null&&v(e,["role"],n),e}function yQ(s,e){let t={},n=g(s,["ttl"]);e!==void 0&&n!=null&&v(e,["ttl"],n);let i=g(s,["expireTime"]);e!==void 0&&i!=null&&v(e,["expireTime"],i);let r=g(s,["displayName"]);e!==void 0&&r!=null&&v(e,["displayName"],r);let o=g(s,["contents"]);if(e!==void 0&&o!=null){let d=Rr(o);Array.isArray(d)&&(d=d.map(u=>Uz(u))),v(e,["contents"],d)}let a=g(s,["systemInstruction"]);e!==void 0&&a!=null&&v(e,["systemInstruction"],Uz(gi(a)));let l=g(s,["tools"]);if(e!==void 0&&l!=null){let d=l;Array.isArray(d)&&(d=d.map(u=>VQ(u))),v(e,["tools"],d)}let c=g(s,["toolConfig"]);if(e!==void 0&&c!=null&&v(e,["toolConfig"],UQ(c)),g(s,["kmsKeyName"])!==void 0)throw new Error("kmsKeyName parameter is not supported in Gemini API.");return t}function vQ(s,e){let t={},n=g(s,["ttl"]);e!==void 0&&n!=null&&v(e,["ttl"],n);let i=g(s,["expireTime"]);e!==void 0&&i!=null&&v(e,["expireTime"],i);let r=g(s,["displayName"]);e!==void 0&&r!=null&&v(e,["displayName"],r);let o=g(s,["contents"]);if(e!==void 0&&o!=null){let u=Rr(o);Array.isArray(u)&&(u=u.map(h=>h)),v(e,["contents"],u)}let a=g(s,["systemInstruction"]);e!==void 0&&a!=null&&v(e,["systemInstruction"],gi(a));let l=g(s,["tools"]);if(e!==void 0&&l!=null){let u=l;Array.isArray(u)&&(u=u.map(h=>GQ(h))),v(e,["tools"],u)}let c=g(s,["toolConfig"]);e!==void 0&&c!=null&&v(e,["toolConfig"],c);let d=g(s,["kmsKeyName"]);return e!==void 0&&d!=null&&v(e,["encryption_spec","kmsKeyName"],d),t}function bQ(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["model"],cU(s,n));let i=g(e,["config"]);return i!=null&&yQ(i,t),t}function wQ(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["model"],cU(s,n));let i=g(e,["config"]);return i!=null&&vQ(i,t),t}function MQ(s,e){let t={},n=g(e,["name"]);return n!=null&&v(t,["_url","name"],Ua(s,n)),t}function TQ(s,e){let t={},n=g(e,["name"]);return n!=null&&v(t,["_url","name"],Ua(s,n)),t}function EQ(s){let e={},t=g(s,["sdkHttpResponse"]);return t!=null&&v(e,["sdkHttpResponse"],t),e}function xQ(s){let e={},t=g(s,["sdkHttpResponse"]);return t!=null&&v(e,["sdkHttpResponse"],t),e}function SQ(s){let e={};if(g(s,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");let t=g(s,["fileUri"]);t!=null&&v(e,["fileUri"],t);let n=g(s,["mimeType"]);return n!=null&&v(e,["mimeType"],n),e}function CQ(s){let e={},t=g(s,["id"]);t!=null&&v(e,["id"],t);let n=g(s,["args"]);n!=null&&v(e,["args"],n);let i=g(s,["name"]);if(i!=null&&v(e,["name"],i),g(s,["partialArgs"])!==void 0)throw new Error("partialArgs parameter is not supported in Gemini API.");if(g(s,["willContinue"])!==void 0)throw new Error("willContinue parameter is not supported in Gemini API.");return e}function AQ(s){let e={},t=g(s,["mode"]);t!=null&&v(e,["mode"],t);let n=g(s,["allowedFunctionNames"]);if(n!=null&&v(e,["allowedFunctionNames"],n),g(s,["streamFunctionCallArguments"])!==void 0)throw new Error("streamFunctionCallArguments parameter is not supported in Gemini API.");return e}function PQ(s){let e={};if(g(s,["behavior"])!==void 0)throw new Error("behavior parameter is not supported in Vertex AI.");let t=g(s,["description"]);t!=null&&v(e,["description"],t);let n=g(s,["name"]);n!=null&&v(e,["name"],n);let i=g(s,["parameters"]);i!=null&&v(e,["parameters"],i);let r=g(s,["parametersJsonSchema"]);r!=null&&v(e,["parametersJsonSchema"],r);let o=g(s,["response"]);o!=null&&v(e,["response"],o);let a=g(s,["responseJsonSchema"]);return a!=null&&v(e,["responseJsonSchema"],a),e}function kQ(s,e){let t={},n=g(e,["name"]);return n!=null&&v(t,["_url","name"],Ua(s,n)),t}function IQ(s,e){let t={},n=g(e,["name"]);return n!=null&&v(t,["_url","name"],Ua(s,n)),t}function DQ(s){let e={};if(g(s,["authConfig"])!==void 0)throw new Error("authConfig parameter is not supported in Gemini API.");let t=g(s,["enableWidget"]);return t!=null&&v(e,["enableWidget"],t),e}function RQ(s){let e={};if(g(s,["excludeDomains"])!==void 0)throw new Error("excludeDomains parameter is not supported in Gemini API.");if(g(s,["blockingConfidence"])!==void 0)throw new Error("blockingConfidence parameter is not supported in Gemini API.");let t=g(s,["timeRangeFilter"]);return t!=null&&v(e,["timeRangeFilter"],t),e}function FQ(s,e){let t={},n=g(s,["pageSize"]);e!==void 0&&n!=null&&v(e,["_query","pageSize"],n);let i=g(s,["pageToken"]);return e!==void 0&&i!=null&&v(e,["_query","pageToken"],i),t}function LQ(s,e){let t={},n=g(s,["pageSize"]);e!==void 0&&n!=null&&v(e,["_query","pageSize"],n);let i=g(s,["pageToken"]);return e!==void 0&&i!=null&&v(e,["_query","pageToken"],i),t}function NQ(s){let e={},t=g(s,["config"]);return t!=null&&FQ(t,e),e}function OQ(s){let e={},t=g(s,["config"]);return t!=null&&LQ(t,e),e}function $Q(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["nextPageToken"]);n!=null&&v(e,["nextPageToken"],n);let i=g(s,["cachedContents"]);if(i!=null){let r=i;Array.isArray(r)&&(r=r.map(o=>o)),v(e,["cachedContents"],r)}return e}function BQ(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["nextPageToken"]);n!=null&&v(e,["nextPageToken"],n);let i=g(s,["cachedContents"]);if(i!=null){let r=i;Array.isArray(r)&&(r=r.map(o=>o)),v(e,["cachedContents"],r)}return e}function zQ(s){let e={},t=g(s,["mediaResolution"]);t!=null&&v(e,["mediaResolution"],t);let n=g(s,["codeExecutionResult"]);n!=null&&v(e,["codeExecutionResult"],n);let i=g(s,["executableCode"]);i!=null&&v(e,["executableCode"],i);let r=g(s,["fileData"]);r!=null&&v(e,["fileData"],SQ(r));let o=g(s,["functionCall"]);o!=null&&v(e,["functionCall"],CQ(o));let a=g(s,["functionResponse"]);a!=null&&v(e,["functionResponse"],a);let l=g(s,["inlineData"]);l!=null&&v(e,["inlineData"],_Q(l));let c=g(s,["text"]);c!=null&&v(e,["text"],c);let d=g(s,["thought"]);d!=null&&v(e,["thought"],d);let u=g(s,["thoughtSignature"]);u!=null&&v(e,["thoughtSignature"],u);let h=g(s,["videoMetadata"]);return h!=null&&v(e,["videoMetadata"],h),e}function UQ(s){let e={},t=g(s,["functionCallingConfig"]);t!=null&&v(e,["functionCallingConfig"],AQ(t));let n=g(s,["retrievalConfig"]);return n!=null&&v(e,["retrievalConfig"],n),e}function VQ(s){let e={},t=g(s,["functionDeclarations"]);if(t!=null){let d=t;Array.isArray(d)&&(d=d.map(u=>u)),v(e,["functionDeclarations"],d)}if(g(s,["retrieval"])!==void 0)throw new Error("retrieval parameter is not supported in Gemini API.");let n=g(s,["googleSearchRetrieval"]);n!=null&&v(e,["googleSearchRetrieval"],n);let i=g(s,["computerUse"]);i!=null&&v(e,["computerUse"],i);let r=g(s,["fileSearch"]);r!=null&&v(e,["fileSearch"],r);let o=g(s,["codeExecution"]);if(o!=null&&v(e,["codeExecution"],o),g(s,["enterpriseWebSearch"])!==void 0)throw new Error("enterpriseWebSearch parameter is not supported in Gemini API.");let a=g(s,["googleMaps"]);a!=null&&v(e,["googleMaps"],DQ(a));let l=g(s,["googleSearch"]);l!=null&&v(e,["googleSearch"],RQ(l));let c=g(s,["urlContext"]);return c!=null&&v(e,["urlContext"],c),e}function GQ(s){let e={},t=g(s,["functionDeclarations"]);if(t!=null){let u=t;Array.isArray(u)&&(u=u.map(h=>PQ(h))),v(e,["functionDeclarations"],u)}let n=g(s,["retrieval"]);n!=null&&v(e,["retrieval"],n);let i=g(s,["googleSearchRetrieval"]);i!=null&&v(e,["googleSearchRetrieval"],i);let r=g(s,["computerUse"]);if(r!=null&&v(e,["computerUse"],r),g(s,["fileSearch"])!==void 0)throw new Error("fileSearch parameter is not supported in Vertex AI.");let o=g(s,["codeExecution"]);o!=null&&v(e,["codeExecution"],o);let a=g(s,["enterpriseWebSearch"]);a!=null&&v(e,["enterpriseWebSearch"],a);let l=g(s,["googleMaps"]);l!=null&&v(e,["googleMaps"],l);let c=g(s,["googleSearch"]);c!=null&&v(e,["googleSearch"],c);let d=g(s,["urlContext"]);return d!=null&&v(e,["urlContext"],d),e}function WQ(s,e){let t={},n=g(s,["ttl"]);e!==void 0&&n!=null&&v(e,["ttl"],n);let i=g(s,["expireTime"]);return e!==void 0&&i!=null&&v(e,["expireTime"],i),t}function HQ(s,e){let t={},n=g(s,["ttl"]);e!==void 0&&n!=null&&v(e,["ttl"],n);let i=g(s,["expireTime"]);return e!==void 0&&i!=null&&v(e,["expireTime"],i),t}function jQ(s,e){let t={},n=g(e,["name"]);n!=null&&v(t,["_url","name"],Ua(s,n));let i=g(e,["config"]);return i!=null&&WQ(i,t),t}function qQ(s,e){let t={},n=g(e,["name"]);n!=null&&v(t,["_url","name"],Ua(s,n));let i=g(e,["config"]);return i!=null&&HQ(i,t),t}var _A=class extends oo{constructor(e){super(),this.apiClient=e,this.list=async(t={})=>new za(Ba.PAGED_ITEM_CACHED_CONTENTS,n=>this.listInternal(n),await this.listInternal(t),t)}async create(e){var t,n,i,r;let o,a="",l={};if(this.apiClient.isVertexAI()){let c=wQ(this.apiClient,e);return a=mt("cachedContents",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(d=>d.json()),o.then(d=>d)}else{let c=bQ(this.apiClient,e);return a=mt("cachedContents",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json()),o.then(d=>d)}}async get(e){var t,n,i,r;let o,a="",l={};if(this.apiClient.isVertexAI()){let c=IQ(this.apiClient,e);return a=mt("{name}",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(d=>d.json()),o.then(d=>d)}else{let c=kQ(this.apiClient,e);return a=mt("{name}",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json()),o.then(d=>d)}}async delete(e){var t,n,i,r;let o,a="",l={};if(this.apiClient.isVertexAI()){let c=TQ(this.apiClient,e);return a=mt("{name}",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"DELETE",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>{let u=xQ(d),h=new Pw;return Object.assign(h,u),h})}else{let c=MQ(this.apiClient,e);return a=mt("{name}",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"DELETE",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>{let u=EQ(d),h=new Pw;return Object.assign(h,u),h})}}async update(e){var t,n,i,r;let o,a="",l={};if(this.apiClient.isVertexAI()){let c=qQ(this.apiClient,e);return a=mt("{name}",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"PATCH",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(d=>d.json()),o.then(d=>d)}else{let c=jQ(this.apiClient,e);return a=mt("{name}",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"PATCH",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json()),o.then(d=>d)}}async listInternal(e){var t,n,i,r;let o,a="",l={};if(this.apiClient.isVertexAI()){let c=OQ(e);return a=mt("cachedContents",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>{let u=BQ(d),h=new kw;return Object.assign(h,u),h})}else{let c=NQ(e);return a=mt("cachedContents",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>{let u=$Q(d),h=new kw;return Object.assign(h,u),h})}}};function Rw(s,e){var t={};for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&e.indexOf(n)<0&&(t[n]=s[n]);if(s!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,n=Object.getOwnPropertySymbols(s);i<n.length;i++)e.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(s,n[i])&&(t[n[i]]=s[n[i]]);return t}function Vz(s){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&s[e],n=0;if(t)return t.call(s);if(s&&typeof s.length=="number")return{next:function(){return s&&n>=s.length&&(s=void 0),{value:s&&s[n++],done:!s}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function Yt(s){return this instanceof Yt?(this.v=s,this):new Yt(s)}function io(s,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=t.apply(s,e||[]),i,r=[];return i=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),a("next"),a("throw"),a("return",o),i[Symbol.asyncIterator]=function(){return this},i;function o(p){return function(f){return Promise.resolve(f).then(p,u)}}function a(p,f){n[p]&&(i[p]=function(_){return new Promise(function(b,y){r.push([p,_,b,y])>1||l(p,_)})},f&&(i[p]=f(i[p])))}function l(p,f){try{c(n[p](f))}catch(_){h(r[0][3],_)}}function c(p){p.value instanceof Yt?Promise.resolve(p.value.v).then(d,u):h(r[0][2],p)}function d(p){l("next",p)}function u(p){l("throw",p)}function h(p,f){p(f),r.shift(),r.length&&l(r[0][0],r[0][1])}}function ro(s){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=s[Symbol.asyncIterator],t;return e?e.call(s):(s=typeof Vz=="function"?Vz(s):s[Symbol.iterator](),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(r){t[r]=s[r]&&function(o){return new Promise(function(a,l){o=s[r](o),i(a,l,o.done,o.value)})}}function i(r,o,a,l){Promise.resolve(l).then(function(c){r({value:c,done:a})},o)}}function KQ(s){var e;if(s.candidates==null||s.candidates.length===0)return!1;let t=(e=s.candidates[0])===null||e===void 0?void 0:e.content;return t===void 0?!1:MU(t)}function MU(s){if(s.parts===void 0||s.parts.length===0)return!1;for(let e of s.parts)if(e===void 0||Object.keys(e).length===0)return!1;return!0}function YQ(s){if(s.length!==0){for(let e of s)if(e.role!=="user"&&e.role!=="model")throw new Error(`Role must be user or model, but got ${e.role}.`)}}function Gz(s){if(s===void 0||s.length===0)return[];let e=[],t=s.length,n=0;for(;n<t;)if(s[n].role==="user")e.push(s[n]),n++;else{let i=[],r=!0;for(;n<t&&s[n].role==="model";)i.push(s[n]),r&&!MU(s[n])&&(r=!1),n++;r?e.push(...i):e.pop()}return e}var yA=class{constructor(e,t){this.modelsModule=e,this.apiClient=t}create(e){return new vA(this.apiClient,this.modelsModule,e.model,e.config,structuredClone(e.history))}},vA=class{constructor(e,t,n,i={},r=[]){this.apiClient=e,this.modelsModule=t,this.model=n,this.config=i,this.history=r,this.sendPromise=Promise.resolve(),YQ(r)}async sendMessage(e){var t;await this.sendPromise;let n=gi(e.message),i=this.modelsModule.generateContent({model:this.model,contents:this.getHistory(!0).concat(n),config:(t=e.config)!==null&&t!==void 0?t:this.config});return this.sendPromise=(async()=>{var r,o,a;let l=await i,c=(o=(r=l.candidates)===null||r===void 0?void 0:r[0])===null||o===void 0?void 0:o.content,d=l.automaticFunctionCallingHistory,u=this.getHistory(!0).length,h=[];d!=null&&(h=(a=d.slice(u))!==null&&a!==void 0?a:[]);let p=c?[c]:[];this.recordHistory(n,p,h)})(),await this.sendPromise.catch(()=>{this.sendPromise=Promise.resolve()}),i}async sendMessageStream(e){var t;await this.sendPromise;let n=gi(e.message),i=this.modelsModule.generateContentStream({model:this.model,contents:this.getHistory(!0).concat(n),config:(t=e.config)!==null&&t!==void 0?t:this.config});this.sendPromise=i.then(()=>{}).catch(()=>{});let r=await i;return this.processStreamResponse(r,n)}getHistory(e=!1){let t=e?Gz(this.history):this.history;return structuredClone(t)}processStreamResponse(e,t){return io(this,arguments,function*(){var i,r,o,a,l,c;let d=[];try{for(var u=!0,h=ro(e),p;p=yield Yt(h.next()),i=p.done,!i;u=!0){a=p.value,u=!1;let f=a;if(KQ(f)){let _=(c=(l=f.candidates)===null||l===void 0?void 0:l[0])===null||c===void 0?void 0:c.content;_!==void 0&&d.push(_)}yield yield Yt(f)}}catch(f){r={error:f}}finally{try{!u&&!i&&(o=h.return)&&(yield Yt(o.call(h)))}finally{if(r)throw r.error}}this.recordHistory(t,d)})}recordHistory(e,t,n){let i=[];t.length>0&&t.every(r=>r.role!==void 0)?i=t:i.push({role:"model",parts:[]}),n&&n.length>0?this.history.push(...Gz(n)):this.history.push(e),this.history.push(...i)}};var Fw=class s extends Error{constructor(e){super(e.message),this.name="ApiError",this.status=e.status,Object.setPrototypeOf(this,s.prototype)}};function XQ(s){let e={},t=g(s,["file"]);return t!=null&&v(e,["file"],t),e}function QQ(s){let e={},t=g(s,["sdkHttpResponse"]);return t!=null&&v(e,["sdkHttpResponse"],t),e}function JQ(s){let e={},t=g(s,["name"]);return t!=null&&v(e,["_url","file"],mU(t)),e}function ZQ(s){let e={},t=g(s,["sdkHttpResponse"]);return t!=null&&v(e,["sdkHttpResponse"],t),e}function eJ(s){let e={},t=g(s,["name"]);return t!=null&&v(e,["_url","file"],mU(t)),e}function tJ(s,e){let t={},n=g(s,["pageSize"]);e!==void 0&&n!=null&&v(e,["_query","pageSize"],n);let i=g(s,["pageToken"]);return e!==void 0&&i!=null&&v(e,["_query","pageToken"],i),t}function nJ(s){let e={},t=g(s,["config"]);return t!=null&&tJ(t,e),e}function sJ(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["nextPageToken"]);n!=null&&v(e,["nextPageToken"],n);let i=g(s,["files"]);if(i!=null){let r=i;Array.isArray(r)&&(r=r.map(o=>o)),v(e,["files"],r)}return e}var bA=class extends oo{constructor(e){super(),this.apiClient=e,this.list=async(t={})=>new za(Ba.PAGED_ITEM_FILES,n=>this.listInternal(n),await this.listInternal(t),t)}async upload(e){if(this.apiClient.isVertexAI())throw new Error("Vertex AI does not support uploading files. You can share files through a GCS bucket.");return this.apiClient.uploadFile(e.file,e.config).then(t=>t)}async download(e){await this.apiClient.downloadFile(e)}async listInternal(e){var t,n;let i,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{let a=nJ(e);return r=mt("files",a._url),o=a._query,delete a._url,delete a._query,i=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(l=>l.json().then(c=>{let d=c;return d.sdkHttpResponse={headers:l.headers},d})),i.then(l=>{let c=sJ(l),d=new lA;return Object.assign(d,c),d})}}async createInternal(e){var t,n;let i,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{let a=XQ(e);return r=mt("upload/v1beta/files",a._url),o=a._query,delete a._url,delete a._query,i=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(l=>l.json()),i.then(l=>{let c=QQ(l),d=new cA;return Object.assign(d,c),d})}}async get(e){var t,n;let i,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{let a=eJ(e);return r=mt("files/{file}",a._url),o=a._query,delete a._url,delete a._query,i=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(l=>l.json()),i.then(l=>l)}}async delete(e){var t,n;let i,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{let a=JQ(e);return r=mt("files/{file}",a._url),o=a._query,delete a._url,delete a._query,i=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"DELETE",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(l=>l.json().then(c=>{let d=c;return d.sdkHttpResponse={headers:l.headers},d})),i.then(l=>{let c=ZQ(l),d=new dA;return Object.assign(d,c),d})}}};function vw(s){let e={},t=g(s,["data"]);if(t!=null&&v(e,["data"],t),g(s,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");let n=g(s,["mimeType"]);return n!=null&&v(e,["mimeType"],n),e}function iJ(s){let e={},t=g(s,["parts"]);if(t!=null){let i=t;Array.isArray(i)&&(i=i.map(r=>bJ(r))),v(e,["parts"],i)}let n=g(s,["role"]);return n!=null&&v(e,["role"],n),e}function rJ(s){let e={};if(g(s,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");let t=g(s,["fileUri"]);t!=null&&v(e,["fileUri"],t);let n=g(s,["mimeType"]);return n!=null&&v(e,["mimeType"],n),e}function oJ(s){let e={},t=g(s,["id"]);t!=null&&v(e,["id"],t);let n=g(s,["args"]);n!=null&&v(e,["args"],n);let i=g(s,["name"]);if(i!=null&&v(e,["name"],i),g(s,["partialArgs"])!==void 0)throw new Error("partialArgs parameter is not supported in Gemini API.");if(g(s,["willContinue"])!==void 0)throw new Error("willContinue parameter is not supported in Gemini API.");return e}function aJ(s){let e={};if(g(s,["behavior"])!==void 0)throw new Error("behavior parameter is not supported in Vertex AI.");let t=g(s,["description"]);t!=null&&v(e,["description"],t);let n=g(s,["name"]);n!=null&&v(e,["name"],n);let i=g(s,["parameters"]);i!=null&&v(e,["parameters"],i);let r=g(s,["parametersJsonSchema"]);r!=null&&v(e,["parametersJsonSchema"],r);let o=g(s,["response"]);o!=null&&v(e,["response"],o);let a=g(s,["responseJsonSchema"]);return a!=null&&v(e,["responseJsonSchema"],a),e}function lJ(s){let e={},t=g(s,["modelSelectionConfig"]);t!=null&&v(e,["modelConfig"],t);let n=g(s,["responseJsonSchema"]);n!=null&&v(e,["responseJsonSchema"],n);let i=g(s,["audioTimestamp"]);i!=null&&v(e,["audioTimestamp"],i);let r=g(s,["candidateCount"]);r!=null&&v(e,["candidateCount"],r);let o=g(s,["enableAffectiveDialog"]);o!=null&&v(e,["enableAffectiveDialog"],o);let a=g(s,["frequencyPenalty"]);a!=null&&v(e,["frequencyPenalty"],a);let l=g(s,["logprobs"]);l!=null&&v(e,["logprobs"],l);let c=g(s,["maxOutputTokens"]);c!=null&&v(e,["maxOutputTokens"],c);let d=g(s,["mediaResolution"]);d!=null&&v(e,["mediaResolution"],d);let u=g(s,["presencePenalty"]);u!=null&&v(e,["presencePenalty"],u);let h=g(s,["responseLogprobs"]);h!=null&&v(e,["responseLogprobs"],h);let p=g(s,["responseMimeType"]);p!=null&&v(e,["responseMimeType"],p);let f=g(s,["responseModalities"]);f!=null&&v(e,["responseModalities"],f);let _=g(s,["responseSchema"]);_!=null&&v(e,["responseSchema"],_);let b=g(s,["routingConfig"]);b!=null&&v(e,["routingConfig"],b);let y=g(s,["seed"]);y!=null&&v(e,["seed"],y);let w=g(s,["speechConfig"]);w!=null&&v(e,["speechConfig"],w);let C=g(s,["stopSequences"]);C!=null&&v(e,["stopSequences"],C);let M=g(s,["temperature"]);M!=null&&v(e,["temperature"],M);let S=g(s,["thinkingConfig"]);S!=null&&v(e,["thinkingConfig"],S);let k=g(s,["topK"]);k!=null&&v(e,["topK"],k);let T=g(s,["topP"]);if(T!=null&&v(e,["topP"],T),g(s,["enableEnhancedCivicAnswers"])!==void 0)throw new Error("enableEnhancedCivicAnswers parameter is not supported in Vertex AI.");return e}function cJ(s){let e={};if(g(s,["authConfig"])!==void 0)throw new Error("authConfig parameter is not supported in Gemini API.");let t=g(s,["enableWidget"]);return t!=null&&v(e,["enableWidget"],t),e}function dJ(s){let e={};if(g(s,["excludeDomains"])!==void 0)throw new Error("excludeDomains parameter is not supported in Gemini API.");if(g(s,["blockingConfidence"])!==void 0)throw new Error("blockingConfidence parameter is not supported in Gemini API.");let t=g(s,["timeRangeFilter"]);return t!=null&&v(e,["timeRangeFilter"],t),e}function uJ(s,e){let t={},n=g(s,["generationConfig"]);e!==void 0&&n!=null&&v(e,["setup","generationConfig"],n);let i=g(s,["responseModalities"]);e!==void 0&&i!=null&&v(e,["setup","generationConfig","responseModalities"],i);let r=g(s,["temperature"]);e!==void 0&&r!=null&&v(e,["setup","generationConfig","temperature"],r);let o=g(s,["topP"]);e!==void 0&&o!=null&&v(e,["setup","generationConfig","topP"],o);let a=g(s,["topK"]);e!==void 0&&a!=null&&v(e,["setup","generationConfig","topK"],a);let l=g(s,["maxOutputTokens"]);e!==void 0&&l!=null&&v(e,["setup","generationConfig","maxOutputTokens"],l);let c=g(s,["mediaResolution"]);e!==void 0&&c!=null&&v(e,["setup","generationConfig","mediaResolution"],c);let d=g(s,["seed"]);e!==void 0&&d!=null&&v(e,["setup","generationConfig","seed"],d);let u=g(s,["speechConfig"]);e!==void 0&&u!=null&&v(e,["setup","generationConfig","speechConfig"],ZA(u));let h=g(s,["thinkingConfig"]);e!==void 0&&h!=null&&v(e,["setup","generationConfig","thinkingConfig"],h);let p=g(s,["enableAffectiveDialog"]);e!==void 0&&p!=null&&v(e,["setup","generationConfig","enableAffectiveDialog"],p);let f=g(s,["systemInstruction"]);e!==void 0&&f!=null&&v(e,["setup","systemInstruction"],iJ(gi(f)));let _=g(s,["tools"]);if(e!==void 0&&_!=null){let k=Kh(_);Array.isArray(k)&&(k=k.map(T=>MJ(qh(T)))),v(e,["setup","tools"],k)}let b=g(s,["sessionResumption"]);e!==void 0&&b!=null&&v(e,["setup","sessionResumption"],wJ(b));let y=g(s,["inputAudioTranscription"]);e!==void 0&&y!=null&&v(e,["setup","inputAudioTranscription"],y);let w=g(s,["outputAudioTranscription"]);e!==void 0&&w!=null&&v(e,["setup","outputAudioTranscription"],w);let C=g(s,["realtimeInputConfig"]);e!==void 0&&C!=null&&v(e,["setup","realtimeInputConfig"],C);let M=g(s,["contextWindowCompression"]);e!==void 0&&M!=null&&v(e,["setup","contextWindowCompression"],M);let S=g(s,["proactivity"]);if(e!==void 0&&S!=null&&v(e,["setup","proactivity"],S),g(s,["explicitVadSignal"])!==void 0)throw new Error("explicitVadSignal parameter is not supported in Gemini API.");return t}function hJ(s,e){let t={},n=g(s,["generationConfig"]);e!==void 0&&n!=null&&v(e,["setup","generationConfig"],lJ(n));let i=g(s,["responseModalities"]);e!==void 0&&i!=null&&v(e,["setup","generationConfig","responseModalities"],i);let r=g(s,["temperature"]);e!==void 0&&r!=null&&v(e,["setup","generationConfig","temperature"],r);let o=g(s,["topP"]);e!==void 0&&o!=null&&v(e,["setup","generationConfig","topP"],o);let a=g(s,["topK"]);e!==void 0&&a!=null&&v(e,["setup","generationConfig","topK"],a);let l=g(s,["maxOutputTokens"]);e!==void 0&&l!=null&&v(e,["setup","generationConfig","maxOutputTokens"],l);let c=g(s,["mediaResolution"]);e!==void 0&&c!=null&&v(e,["setup","generationConfig","mediaResolution"],c);let d=g(s,["seed"]);e!==void 0&&d!=null&&v(e,["setup","generationConfig","seed"],d);let u=g(s,["speechConfig"]);e!==void 0&&u!=null&&v(e,["setup","generationConfig","speechConfig"],ZA(u));let h=g(s,["thinkingConfig"]);e!==void 0&&h!=null&&v(e,["setup","generationConfig","thinkingConfig"],h);let p=g(s,["enableAffectiveDialog"]);e!==void 0&&p!=null&&v(e,["setup","generationConfig","enableAffectiveDialog"],p);let f=g(s,["systemInstruction"]);e!==void 0&&f!=null&&v(e,["setup","systemInstruction"],gi(f));let _=g(s,["tools"]);if(e!==void 0&&_!=null){let T=Kh(_);Array.isArray(T)&&(T=T.map(P=>TJ(qh(P)))),v(e,["setup","tools"],T)}let b=g(s,["sessionResumption"]);e!==void 0&&b!=null&&v(e,["setup","sessionResumption"],b);let y=g(s,["inputAudioTranscription"]);e!==void 0&&y!=null&&v(e,["setup","inputAudioTranscription"],y);let w=g(s,["outputAudioTranscription"]);e!==void 0&&w!=null&&v(e,["setup","outputAudioTranscription"],w);let C=g(s,["realtimeInputConfig"]);e!==void 0&&C!=null&&v(e,["setup","realtimeInputConfig"],C);let M=g(s,["contextWindowCompression"]);e!==void 0&&M!=null&&v(e,["setup","contextWindowCompression"],M);let S=g(s,["proactivity"]);e!==void 0&&S!=null&&v(e,["setup","proactivity"],S);let k=g(s,["explicitVadSignal"]);return e!==void 0&&k!=null&&v(e,["setup","explicitVadSignal"],k),t}function pJ(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["setup","model"],xn(s,n));let i=g(e,["config"]);return i!=null&&v(t,["config"],uJ(i,t)),t}function fJ(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["setup","model"],xn(s,n));let i=g(e,["config"]);return i!=null&&v(t,["config"],hJ(i,t)),t}function mJ(s){let e={},t=g(s,["musicGenerationConfig"]);return t!=null&&v(e,["musicGenerationConfig"],t),e}function gJ(s){let e={},t=g(s,["weightedPrompts"]);if(t!=null){let n=t;Array.isArray(n)&&(n=n.map(i=>i)),v(e,["weightedPrompts"],n)}return e}function _J(s){let e={},t=g(s,["media"]);if(t!=null){let c=dU(t);Array.isArray(c)&&(c=c.map(d=>vw(d))),v(e,["mediaChunks"],c)}let n=g(s,["audio"]);n!=null&&v(e,["audio"],vw(hU(n)));let i=g(s,["audioStreamEnd"]);i!=null&&v(e,["audioStreamEnd"],i);let r=g(s,["video"]);r!=null&&v(e,["video"],vw(uU(r)));let o=g(s,["text"]);o!=null&&v(e,["text"],o);let a=g(s,["activityStart"]);a!=null&&v(e,["activityStart"],a);let l=g(s,["activityEnd"]);return l!=null&&v(e,["activityEnd"],l),e}function yJ(s){let e={},t=g(s,["media"]);if(t!=null){let c=dU(t);Array.isArray(c)&&(c=c.map(d=>d)),v(e,["mediaChunks"],c)}let n=g(s,["audio"]);n!=null&&v(e,["audio"],hU(n));let i=g(s,["audioStreamEnd"]);i!=null&&v(e,["audioStreamEnd"],i);let r=g(s,["video"]);r!=null&&v(e,["video"],uU(r));let o=g(s,["text"]);o!=null&&v(e,["text"],o);let a=g(s,["activityStart"]);a!=null&&v(e,["activityStart"],a);let l=g(s,["activityEnd"]);return l!=null&&v(e,["activityEnd"],l),e}function vJ(s){let e={},t=g(s,["setupComplete"]);t!=null&&v(e,["setupComplete"],t);let n=g(s,["serverContent"]);n!=null&&v(e,["serverContent"],n);let i=g(s,["toolCall"]);i!=null&&v(e,["toolCall"],i);let r=g(s,["toolCallCancellation"]);r!=null&&v(e,["toolCallCancellation"],r);let o=g(s,["usageMetadata"]);o!=null&&v(e,["usageMetadata"],EJ(o));let a=g(s,["goAway"]);a!=null&&v(e,["goAway"],a);let l=g(s,["sessionResumptionUpdate"]);l!=null&&v(e,["sessionResumptionUpdate"],l);let c=g(s,["voiceActivityDetectionSignal"]);return c!=null&&v(e,["voiceActivityDetectionSignal"],c),e}function bJ(s){let e={},t=g(s,["mediaResolution"]);t!=null&&v(e,["mediaResolution"],t);let n=g(s,["codeExecutionResult"]);n!=null&&v(e,["codeExecutionResult"],n);let i=g(s,["executableCode"]);i!=null&&v(e,["executableCode"],i);let r=g(s,["fileData"]);r!=null&&v(e,["fileData"],rJ(r));let o=g(s,["functionCall"]);o!=null&&v(e,["functionCall"],oJ(o));let a=g(s,["functionResponse"]);a!=null&&v(e,["functionResponse"],a);let l=g(s,["inlineData"]);l!=null&&v(e,["inlineData"],vw(l));let c=g(s,["text"]);c!=null&&v(e,["text"],c);let d=g(s,["thought"]);d!=null&&v(e,["thought"],d);let u=g(s,["thoughtSignature"]);u!=null&&v(e,["thoughtSignature"],u);let h=g(s,["videoMetadata"]);return h!=null&&v(e,["videoMetadata"],h),e}function wJ(s){let e={},t=g(s,["handle"]);if(t!=null&&v(e,["handle"],t),g(s,["transparent"])!==void 0)throw new Error("transparent parameter is not supported in Gemini API.");return e}function MJ(s){let e={},t=g(s,["functionDeclarations"]);if(t!=null){let d=t;Array.isArray(d)&&(d=d.map(u=>u)),v(e,["functionDeclarations"],d)}if(g(s,["retrieval"])!==void 0)throw new Error("retrieval parameter is not supported in Gemini API.");let n=g(s,["googleSearchRetrieval"]);n!=null&&v(e,["googleSearchRetrieval"],n);let i=g(s,["computerUse"]);i!=null&&v(e,["computerUse"],i);let r=g(s,["fileSearch"]);r!=null&&v(e,["fileSearch"],r);let o=g(s,["codeExecution"]);if(o!=null&&v(e,["codeExecution"],o),g(s,["enterpriseWebSearch"])!==void 0)throw new Error("enterpriseWebSearch parameter is not supported in Gemini API.");let a=g(s,["googleMaps"]);a!=null&&v(e,["googleMaps"],cJ(a));let l=g(s,["googleSearch"]);l!=null&&v(e,["googleSearch"],dJ(l));let c=g(s,["urlContext"]);return c!=null&&v(e,["urlContext"],c),e}function TJ(s){let e={},t=g(s,["functionDeclarations"]);if(t!=null){let u=t;Array.isArray(u)&&(u=u.map(h=>aJ(h))),v(e,["functionDeclarations"],u)}let n=g(s,["retrieval"]);n!=null&&v(e,["retrieval"],n);let i=g(s,["googleSearchRetrieval"]);i!=null&&v(e,["googleSearchRetrieval"],i);let r=g(s,["computerUse"]);if(r!=null&&v(e,["computerUse"],r),g(s,["fileSearch"])!==void 0)throw new Error("fileSearch parameter is not supported in Vertex AI.");let o=g(s,["codeExecution"]);o!=null&&v(e,["codeExecution"],o);let a=g(s,["enterpriseWebSearch"]);a!=null&&v(e,["enterpriseWebSearch"],a);let l=g(s,["googleMaps"]);l!=null&&v(e,["googleMaps"],l);let c=g(s,["googleSearch"]);c!=null&&v(e,["googleSearch"],c);let d=g(s,["urlContext"]);return d!=null&&v(e,["urlContext"],d),e}function EJ(s){let e={},t=g(s,["promptTokenCount"]);t!=null&&v(e,["promptTokenCount"],t);let n=g(s,["cachedContentTokenCount"]);n!=null&&v(e,["cachedContentTokenCount"],n);let i=g(s,["candidatesTokenCount"]);i!=null&&v(e,["responseTokenCount"],i);let r=g(s,["toolUsePromptTokenCount"]);r!=null&&v(e,["toolUsePromptTokenCount"],r);let o=g(s,["thoughtsTokenCount"]);o!=null&&v(e,["thoughtsTokenCount"],o);let a=g(s,["totalTokenCount"]);a!=null&&v(e,["totalTokenCount"],a);let l=g(s,["promptTokensDetails"]);if(l!=null){let p=l;Array.isArray(p)&&(p=p.map(f=>f)),v(e,["promptTokensDetails"],p)}let c=g(s,["cacheTokensDetails"]);if(c!=null){let p=c;Array.isArray(p)&&(p=p.map(f=>f)),v(e,["cacheTokensDetails"],p)}let d=g(s,["candidatesTokensDetails"]);if(d!=null){let p=d;Array.isArray(p)&&(p=p.map(f=>f)),v(e,["responseTokensDetails"],p)}let u=g(s,["toolUsePromptTokensDetails"]);if(u!=null){let p=u;Array.isArray(p)&&(p=p.map(f=>f)),v(e,["toolUsePromptTokensDetails"],p)}let h=g(s,["trafficType"]);return h!=null&&v(e,["trafficType"],h),e}function xJ(s){let e={},t=g(s,["data"]);if(t!=null&&v(e,["data"],t),g(s,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");let n=g(s,["mimeType"]);return n!=null&&v(e,["mimeType"],n),e}function SJ(s){let e={},t=g(s,["content"]);t!=null&&v(e,["content"],t);let n=g(s,["citationMetadata"]);n!=null&&v(e,["citationMetadata"],CJ(n));let i=g(s,["tokenCount"]);i!=null&&v(e,["tokenCount"],i);let r=g(s,["finishReason"]);r!=null&&v(e,["finishReason"],r);let o=g(s,["avgLogprobs"]);o!=null&&v(e,["avgLogprobs"],o);let a=g(s,["groundingMetadata"]);a!=null&&v(e,["groundingMetadata"],a);let l=g(s,["index"]);l!=null&&v(e,["index"],l);let c=g(s,["logprobsResult"]);c!=null&&v(e,["logprobsResult"],c);let d=g(s,["safetyRatings"]);if(d!=null){let h=d;Array.isArray(h)&&(h=h.map(p=>p)),v(e,["safetyRatings"],h)}let u=g(s,["urlContextMetadata"]);return u!=null&&v(e,["urlContextMetadata"],u),e}function CJ(s){let e={},t=g(s,["citationSources"]);if(t!=null){let n=t;Array.isArray(n)&&(n=n.map(i=>i)),v(e,["citations"],n)}return e}function AJ(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["_url","model"],xn(s,n));let i=g(e,["contents"]);if(i!=null){let r=Rr(i);Array.isArray(r)&&(r=r.map(o=>o)),v(t,["contents"],r)}return t}function PJ(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["tokensInfo"]);if(n!=null){let i=n;Array.isArray(i)&&(i=i.map(r=>r)),v(e,["tokensInfo"],i)}return e}function kJ(s){let e={},t=g(s,["values"]);t!=null&&v(e,["values"],t);let n=g(s,["statistics"]);return n!=null&&v(e,["statistics"],IJ(n)),e}function IJ(s){let e={},t=g(s,["truncated"]);t!=null&&v(e,["truncated"],t);let n=g(s,["token_count"]);return n!=null&&v(e,["tokenCount"],n),e}function Qw(s){let e={},t=g(s,["parts"]);if(t!=null){let i=t;Array.isArray(i)&&(i=i.map(r=>zZ(r))),v(e,["parts"],i)}let n=g(s,["role"]);return n!=null&&v(e,["role"],n),e}function DJ(s){let e={},t=g(s,["controlType"]);t!=null&&v(e,["controlType"],t);let n=g(s,["enableControlImageComputation"]);return n!=null&&v(e,["computeControl"],n),e}function RJ(s){let e={};if(g(s,["systemInstruction"])!==void 0)throw new Error("systemInstruction parameter is not supported in Gemini API.");if(g(s,["tools"])!==void 0)throw new Error("tools parameter is not supported in Gemini API.");if(g(s,["generationConfig"])!==void 0)throw new Error("generationConfig parameter is not supported in Gemini API.");return e}function FJ(s,e){let t={},n=g(s,["systemInstruction"]);e!==void 0&&n!=null&&v(e,["systemInstruction"],gi(n));let i=g(s,["tools"]);if(e!==void 0&&i!=null){let o=i;Array.isArray(o)&&(o=o.map(a=>SU(a))),v(e,["tools"],o)}let r=g(s,["generationConfig"]);return e!==void 0&&r!=null&&v(e,["generationConfig"],xZ(r)),t}function LJ(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["_url","model"],xn(s,n));let i=g(e,["contents"]);if(i!=null){let o=Rr(i);Array.isArray(o)&&(o=o.map(a=>Qw(a))),v(t,["contents"],o)}let r=g(e,["config"]);return r!=null&&RJ(r),t}function NJ(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["_url","model"],xn(s,n));let i=g(e,["contents"]);if(i!=null){let o=Rr(i);Array.isArray(o)&&(o=o.map(a=>a)),v(t,["contents"],o)}let r=g(e,["config"]);return r!=null&&FJ(r,t),t}function OJ(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["totalTokens"]);n!=null&&v(e,["totalTokens"],n);let i=g(s,["cachedContentTokenCount"]);return i!=null&&v(e,["cachedContentTokenCount"],i),e}function $J(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["totalTokens"]);return n!=null&&v(e,["totalTokens"],n),e}function BJ(s,e){let t={},n=g(e,["model"]);return n!=null&&v(t,["_url","name"],xn(s,n)),t}function zJ(s,e){let t={},n=g(e,["model"]);return n!=null&&v(t,["_url","name"],xn(s,n)),t}function UJ(s){let e={},t=g(s,["sdkHttpResponse"]);return t!=null&&v(e,["sdkHttpResponse"],t),e}function VJ(s){let e={},t=g(s,["sdkHttpResponse"]);return t!=null&&v(e,["sdkHttpResponse"],t),e}function GJ(s,e){let t={},n=g(s,["outputGcsUri"]);e!==void 0&&n!=null&&v(e,["parameters","storageUri"],n);let i=g(s,["negativePrompt"]);e!==void 0&&i!=null&&v(e,["parameters","negativePrompt"],i);let r=g(s,["numberOfImages"]);e!==void 0&&r!=null&&v(e,["parameters","sampleCount"],r);let o=g(s,["aspectRatio"]);e!==void 0&&o!=null&&v(e,["parameters","aspectRatio"],o);let a=g(s,["guidanceScale"]);e!==void 0&&a!=null&&v(e,["parameters","guidanceScale"],a);let l=g(s,["seed"]);e!==void 0&&l!=null&&v(e,["parameters","seed"],l);let c=g(s,["safetyFilterLevel"]);e!==void 0&&c!=null&&v(e,["parameters","safetySetting"],c);let d=g(s,["personGeneration"]);e!==void 0&&d!=null&&v(e,["parameters","personGeneration"],d);let u=g(s,["includeSafetyAttributes"]);e!==void 0&&u!=null&&v(e,["parameters","includeSafetyAttributes"],u);let h=g(s,["includeRaiReason"]);e!==void 0&&h!=null&&v(e,["parameters","includeRaiReason"],h);let p=g(s,["language"]);e!==void 0&&p!=null&&v(e,["parameters","language"],p);let f=g(s,["outputMimeType"]);e!==void 0&&f!=null&&v(e,["parameters","outputOptions","mimeType"],f);let _=g(s,["outputCompressionQuality"]);e!==void 0&&_!=null&&v(e,["parameters","outputOptions","compressionQuality"],_);let b=g(s,["addWatermark"]);e!==void 0&&b!=null&&v(e,["parameters","addWatermark"],b);let y=g(s,["labels"]);e!==void 0&&y!=null&&v(e,["labels"],y);let w=g(s,["editMode"]);e!==void 0&&w!=null&&v(e,["parameters","editMode"],w);let C=g(s,["baseSteps"]);return e!==void 0&&C!=null&&v(e,["parameters","editConfig","baseSteps"],C),t}function WJ(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["_url","model"],xn(s,n));let i=g(e,["prompt"]);i!=null&&v(t,["instances[0]","prompt"],i);let r=g(e,["referenceImages"]);if(r!=null){let a=r;Array.isArray(a)&&(a=a.map(l=>jZ(l))),v(t,["instances[0]","referenceImages"],a)}let o=g(e,["config"]);return o!=null&&GJ(o,t),t}function HJ(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["predictions"]);if(n!=null){let i=n;Array.isArray(i)&&(i=i.map(r=>Jw(r))),v(e,["generatedImages"],i)}return e}function jJ(s,e){let t={},n=g(s,["taskType"]);e!==void 0&&n!=null&&v(e,["requests[]","taskType"],n);let i=g(s,["title"]);e!==void 0&&i!=null&&v(e,["requests[]","title"],i);let r=g(s,["outputDimensionality"]);if(e!==void 0&&r!=null&&v(e,["requests[]","outputDimensionality"],r),g(s,["mimeType"])!==void 0)throw new Error("mimeType parameter is not supported in Gemini API.");if(g(s,["autoTruncate"])!==void 0)throw new Error("autoTruncate parameter is not supported in Gemini API.");return t}function qJ(s,e){let t={},n=g(s,["taskType"]);e!==void 0&&n!=null&&v(e,["instances[]","task_type"],n);let i=g(s,["title"]);e!==void 0&&i!=null&&v(e,["instances[]","title"],i);let r=g(s,["outputDimensionality"]);e!==void 0&&r!=null&&v(e,["parameters","outputDimensionality"],r);let o=g(s,["mimeType"]);e!==void 0&&o!=null&&v(e,["instances[]","mimeType"],o);let a=g(s,["autoTruncate"]);return e!==void 0&&a!=null&&v(e,["parameters","autoTruncate"],a),t}function KJ(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["_url","model"],xn(s,n));let i=g(e,["contents"]);if(i!=null){let a=XA(s,i);Array.isArray(a)&&(a=a.map(l=>l)),v(t,["requests[]","content"],a)}let r=g(e,["config"]);r!=null&&jJ(r,t);let o=g(e,["model"]);return o!==void 0&&v(t,["requests[]","model"],xn(s,o)),t}function YJ(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["_url","model"],xn(s,n));let i=g(e,["contents"]);if(i!=null){let o=XA(s,i);Array.isArray(o)&&(o=o.map(a=>a)),v(t,["instances[]","content"],o)}let r=g(e,["config"]);return r!=null&&qJ(r,t),t}function XJ(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["embeddings"]);if(n!=null){let r=n;Array.isArray(r)&&(r=r.map(o=>o)),v(e,["embeddings"],r)}let i=g(s,["metadata"]);return i!=null&&v(e,["metadata"],i),e}function QJ(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["predictions[]","embeddings"]);if(n!=null){let r=n;Array.isArray(r)&&(r=r.map(o=>kJ(o))),v(e,["embeddings"],r)}let i=g(s,["metadata"]);return i!=null&&v(e,["metadata"],i),e}function JJ(s){let e={},t=g(s,["endpoint"]);t!=null&&v(e,["name"],t);let n=g(s,["deployedModelId"]);return n!=null&&v(e,["deployedModelId"],n),e}function ZJ(s){let e={};if(g(s,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");let t=g(s,["fileUri"]);t!=null&&v(e,["fileUri"],t);let n=g(s,["mimeType"]);return n!=null&&v(e,["mimeType"],n),e}function eZ(s){let e={},t=g(s,["id"]);t!=null&&v(e,["id"],t);let n=g(s,["args"]);n!=null&&v(e,["args"],n);let i=g(s,["name"]);if(i!=null&&v(e,["name"],i),g(s,["partialArgs"])!==void 0)throw new Error("partialArgs parameter is not supported in Gemini API.");if(g(s,["willContinue"])!==void 0)throw new Error("willContinue parameter is not supported in Gemini API.");return e}function tZ(s){let e={},t=g(s,["mode"]);t!=null&&v(e,["mode"],t);let n=g(s,["allowedFunctionNames"]);if(n!=null&&v(e,["allowedFunctionNames"],n),g(s,["streamFunctionCallArguments"])!==void 0)throw new Error("streamFunctionCallArguments parameter is not supported in Gemini API.");return e}function nZ(s){let e={};if(g(s,["behavior"])!==void 0)throw new Error("behavior parameter is not supported in Vertex AI.");let t=g(s,["description"]);t!=null&&v(e,["description"],t);let n=g(s,["name"]);n!=null&&v(e,["name"],n);let i=g(s,["parameters"]);i!=null&&v(e,["parameters"],i);let r=g(s,["parametersJsonSchema"]);r!=null&&v(e,["parametersJsonSchema"],r);let o=g(s,["response"]);o!=null&&v(e,["response"],o);let a=g(s,["responseJsonSchema"]);return a!=null&&v(e,["responseJsonSchema"],a),e}function sZ(s,e,t){let n={},i=g(e,["systemInstruction"]);t!==void 0&&i!=null&&v(t,["systemInstruction"],Qw(gi(i)));let r=g(e,["temperature"]);r!=null&&v(n,["temperature"],r);let o=g(e,["topP"]);o!=null&&v(n,["topP"],o);let a=g(e,["topK"]);a!=null&&v(n,["topK"],a);let l=g(e,["candidateCount"]);l!=null&&v(n,["candidateCount"],l);let c=g(e,["maxOutputTokens"]);c!=null&&v(n,["maxOutputTokens"],c);let d=g(e,["stopSequences"]);d!=null&&v(n,["stopSequences"],d);let u=g(e,["responseLogprobs"]);u!=null&&v(n,["responseLogprobs"],u);let h=g(e,["logprobs"]);h!=null&&v(n,["logprobs"],h);let p=g(e,["presencePenalty"]);p!=null&&v(n,["presencePenalty"],p);let f=g(e,["frequencyPenalty"]);f!=null&&v(n,["frequencyPenalty"],f);let _=g(e,["seed"]);_!=null&&v(n,["seed"],_);let b=g(e,["responseMimeType"]);b!=null&&v(n,["responseMimeType"],b);let y=g(e,["responseSchema"]);y!=null&&v(n,["responseSchema"],QA(y));let w=g(e,["responseJsonSchema"]);if(w!=null&&v(n,["responseJsonSchema"],w),g(e,["routingConfig"])!==void 0)throw new Error("routingConfig parameter is not supported in Gemini API.");if(g(e,["modelSelectionConfig"])!==void 0)throw new Error("modelSelectionConfig parameter is not supported in Gemini API.");let C=g(e,["safetySettings"]);if(t!==void 0&&C!=null){let z=C;Array.isArray(z)&&(z=z.map(ne=>qZ(ne))),v(t,["safetySettings"],z)}let M=g(e,["tools"]);if(t!==void 0&&M!=null){let z=Kh(M);Array.isArray(z)&&(z=z.map(ne=>e9(qh(ne)))),v(t,["tools"],z)}let S=g(e,["toolConfig"]);if(t!==void 0&&S!=null&&v(t,["toolConfig"],ZZ(S)),g(e,["labels"])!==void 0)throw new Error("labels parameter is not supported in Gemini API.");let k=g(e,["cachedContent"]);t!==void 0&&k!=null&&v(t,["cachedContent"],Ua(s,k));let T=g(e,["responseModalities"]);T!=null&&v(n,["responseModalities"],T);let P=g(e,["mediaResolution"]);P!=null&&v(n,["mediaResolution"],P);let R=g(e,["speechConfig"]);if(R!=null&&v(n,["speechConfig"],JA(R)),g(e,["audioTimestamp"])!==void 0)throw new Error("audioTimestamp parameter is not supported in Gemini API.");let O=g(e,["thinkingConfig"]);O!=null&&v(n,["thinkingConfig"],O);let H=g(e,["imageConfig"]);H!=null&&v(n,["imageConfig"],kZ(H));let X=g(e,["enableEnhancedCivicAnswers"]);return X!=null&&v(n,["enableEnhancedCivicAnswers"],X),n}function iZ(s,e,t){let n={},i=g(e,["systemInstruction"]);t!==void 0&&i!=null&&v(t,["systemInstruction"],gi(i));let r=g(e,["temperature"]);r!=null&&v(n,["temperature"],r);let o=g(e,["topP"]);o!=null&&v(n,["topP"],o);let a=g(e,["topK"]);a!=null&&v(n,["topK"],a);let l=g(e,["candidateCount"]);l!=null&&v(n,["candidateCount"],l);let c=g(e,["maxOutputTokens"]);c!=null&&v(n,["maxOutputTokens"],c);let d=g(e,["stopSequences"]);d!=null&&v(n,["stopSequences"],d);let u=g(e,["responseLogprobs"]);u!=null&&v(n,["responseLogprobs"],u);let h=g(e,["logprobs"]);h!=null&&v(n,["logprobs"],h);let p=g(e,["presencePenalty"]);p!=null&&v(n,["presencePenalty"],p);let f=g(e,["frequencyPenalty"]);f!=null&&v(n,["frequencyPenalty"],f);let _=g(e,["seed"]);_!=null&&v(n,["seed"],_);let b=g(e,["responseMimeType"]);b!=null&&v(n,["responseMimeType"],b);let y=g(e,["responseSchema"]);y!=null&&v(n,["responseSchema"],QA(y));let w=g(e,["responseJsonSchema"]);w!=null&&v(n,["responseJsonSchema"],w);let C=g(e,["routingConfig"]);C!=null&&v(n,["routingConfig"],C);let M=g(e,["modelSelectionConfig"]);M!=null&&v(n,["modelConfig"],M);let S=g(e,["safetySettings"]);if(t!==void 0&&S!=null){let Y=S;Array.isArray(Y)&&(Y=Y.map(se=>se)),v(t,["safetySettings"],Y)}let k=g(e,["tools"]);if(t!==void 0&&k!=null){let Y=Kh(k);Array.isArray(Y)&&(Y=Y.map(se=>SU(qh(se)))),v(t,["tools"],Y)}let T=g(e,["toolConfig"]);t!==void 0&&T!=null&&v(t,["toolConfig"],T);let P=g(e,["labels"]);t!==void 0&&P!=null&&v(t,["labels"],P);let R=g(e,["cachedContent"]);t!==void 0&&R!=null&&v(t,["cachedContent"],Ua(s,R));let O=g(e,["responseModalities"]);O!=null&&v(n,["responseModalities"],O);let H=g(e,["mediaResolution"]);H!=null&&v(n,["mediaResolution"],H);let X=g(e,["speechConfig"]);X!=null&&v(n,["speechConfig"],JA(X));let z=g(e,["audioTimestamp"]);z!=null&&v(n,["audioTimestamp"],z);let ne=g(e,["thinkingConfig"]);ne!=null&&v(n,["thinkingConfig"],ne);let re=g(e,["imageConfig"]);if(re!=null&&v(n,["imageConfig"],IZ(re)),g(e,["enableEnhancedCivicAnswers"])!==void 0)throw new Error("enableEnhancedCivicAnswers parameter is not supported in Vertex AI.");return n}function Wz(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["_url","model"],xn(s,n));let i=g(e,["contents"]);if(i!=null){let o=Rr(i);Array.isArray(o)&&(o=o.map(a=>Qw(a))),v(t,["contents"],o)}let r=g(e,["config"]);return r!=null&&v(t,["generationConfig"],sZ(s,r,t)),t}function Hz(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["_url","model"],xn(s,n));let i=g(e,["contents"]);if(i!=null){let o=Rr(i);Array.isArray(o)&&(o=o.map(a=>a)),v(t,["contents"],o)}let r=g(e,["config"]);return r!=null&&v(t,["generationConfig"],iZ(s,r,t)),t}function jz(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["candidates"]);if(n!=null){let l=n;Array.isArray(l)&&(l=l.map(c=>SJ(c))),v(e,["candidates"],l)}let i=g(s,["modelVersion"]);i!=null&&v(e,["modelVersion"],i);let r=g(s,["promptFeedback"]);r!=null&&v(e,["promptFeedback"],r);let o=g(s,["responseId"]);o!=null&&v(e,["responseId"],o);let a=g(s,["usageMetadata"]);return a!=null&&v(e,["usageMetadata"],a),e}function qz(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["candidates"]);if(n!=null){let c=n;Array.isArray(c)&&(c=c.map(d=>d)),v(e,["candidates"],c)}let i=g(s,["createTime"]);i!=null&&v(e,["createTime"],i);let r=g(s,["modelVersion"]);r!=null&&v(e,["modelVersion"],r);let o=g(s,["promptFeedback"]);o!=null&&v(e,["promptFeedback"],o);let a=g(s,["responseId"]);a!=null&&v(e,["responseId"],a);let l=g(s,["usageMetadata"]);return l!=null&&v(e,["usageMetadata"],l),e}function rZ(s,e){let t={};if(g(s,["outputGcsUri"])!==void 0)throw new Error("outputGcsUri parameter is not supported in Gemini API.");if(g(s,["negativePrompt"])!==void 0)throw new Error("negativePrompt parameter is not supported in Gemini API.");let n=g(s,["numberOfImages"]);e!==void 0&&n!=null&&v(e,["parameters","sampleCount"],n);let i=g(s,["aspectRatio"]);e!==void 0&&i!=null&&v(e,["parameters","aspectRatio"],i);let r=g(s,["guidanceScale"]);if(e!==void 0&&r!=null&&v(e,["parameters","guidanceScale"],r),g(s,["seed"])!==void 0)throw new Error("seed parameter is not supported in Gemini API.");let o=g(s,["safetyFilterLevel"]);e!==void 0&&o!=null&&v(e,["parameters","safetySetting"],o);let a=g(s,["personGeneration"]);e!==void 0&&a!=null&&v(e,["parameters","personGeneration"],a);let l=g(s,["includeSafetyAttributes"]);e!==void 0&&l!=null&&v(e,["parameters","includeSafetyAttributes"],l);let c=g(s,["includeRaiReason"]);e!==void 0&&c!=null&&v(e,["parameters","includeRaiReason"],c);let d=g(s,["language"]);e!==void 0&&d!=null&&v(e,["parameters","language"],d);let u=g(s,["outputMimeType"]);e!==void 0&&u!=null&&v(e,["parameters","outputOptions","mimeType"],u);let h=g(s,["outputCompressionQuality"]);if(e!==void 0&&h!=null&&v(e,["parameters","outputOptions","compressionQuality"],h),g(s,["addWatermark"])!==void 0)throw new Error("addWatermark parameter is not supported in Gemini API.");if(g(s,["labels"])!==void 0)throw new Error("labels parameter is not supported in Gemini API.");let p=g(s,["imageSize"]);if(e!==void 0&&p!=null&&v(e,["parameters","sampleImageSize"],p),g(s,["enhancePrompt"])!==void 0)throw new Error("enhancePrompt parameter is not supported in Gemini API.");return t}function oZ(s,e){let t={},n=g(s,["outputGcsUri"]);e!==void 0&&n!=null&&v(e,["parameters","storageUri"],n);let i=g(s,["negativePrompt"]);e!==void 0&&i!=null&&v(e,["parameters","negativePrompt"],i);let r=g(s,["numberOfImages"]);e!==void 0&&r!=null&&v(e,["parameters","sampleCount"],r);let o=g(s,["aspectRatio"]);e!==void 0&&o!=null&&v(e,["parameters","aspectRatio"],o);let a=g(s,["guidanceScale"]);e!==void 0&&a!=null&&v(e,["parameters","guidanceScale"],a);let l=g(s,["seed"]);e!==void 0&&l!=null&&v(e,["parameters","seed"],l);let c=g(s,["safetyFilterLevel"]);e!==void 0&&c!=null&&v(e,["parameters","safetySetting"],c);let d=g(s,["personGeneration"]);e!==void 0&&d!=null&&v(e,["parameters","personGeneration"],d);let u=g(s,["includeSafetyAttributes"]);e!==void 0&&u!=null&&v(e,["parameters","includeSafetyAttributes"],u);let h=g(s,["includeRaiReason"]);e!==void 0&&h!=null&&v(e,["parameters","includeRaiReason"],h);let p=g(s,["language"]);e!==void 0&&p!=null&&v(e,["parameters","language"],p);let f=g(s,["outputMimeType"]);e!==void 0&&f!=null&&v(e,["parameters","outputOptions","mimeType"],f);let _=g(s,["outputCompressionQuality"]);e!==void 0&&_!=null&&v(e,["parameters","outputOptions","compressionQuality"],_);let b=g(s,["addWatermark"]);e!==void 0&&b!=null&&v(e,["parameters","addWatermark"],b);let y=g(s,["labels"]);e!==void 0&&y!=null&&v(e,["labels"],y);let w=g(s,["imageSize"]);e!==void 0&&w!=null&&v(e,["parameters","sampleImageSize"],w);let C=g(s,["enhancePrompt"]);return e!==void 0&&C!=null&&v(e,["parameters","enhancePrompt"],C),t}function aZ(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["_url","model"],xn(s,n));let i=g(e,["prompt"]);i!=null&&v(t,["instances[0]","prompt"],i);let r=g(e,["config"]);return r!=null&&rZ(r,t),t}function lZ(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["_url","model"],xn(s,n));let i=g(e,["prompt"]);i!=null&&v(t,["instances[0]","prompt"],i);let r=g(e,["config"]);return r!=null&&oZ(r,t),t}function cZ(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["predictions"]);if(n!=null){let r=n;Array.isArray(r)&&(r=r.map(o=>wZ(o))),v(e,["generatedImages"],r)}let i=g(s,["positivePromptSafetyAttributes"]);return i!=null&&v(e,["positivePromptSafetyAttributes"],EU(i)),e}function dZ(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["predictions"]);if(n!=null){let r=n;Array.isArray(r)&&(r=r.map(o=>Jw(o))),v(e,["generatedImages"],r)}let i=g(s,["positivePromptSafetyAttributes"]);return i!=null&&v(e,["positivePromptSafetyAttributes"],xU(i)),e}function uZ(s,e){let t={},n=g(s,["numberOfVideos"]);if(e!==void 0&&n!=null&&v(e,["parameters","sampleCount"],n),g(s,["outputGcsUri"])!==void 0)throw new Error("outputGcsUri parameter is not supported in Gemini API.");if(g(s,["fps"])!==void 0)throw new Error("fps parameter is not supported in Gemini API.");let i=g(s,["durationSeconds"]);if(e!==void 0&&i!=null&&v(e,["parameters","durationSeconds"],i),g(s,["seed"])!==void 0)throw new Error("seed parameter is not supported in Gemini API.");let r=g(s,["aspectRatio"]);e!==void 0&&r!=null&&v(e,["parameters","aspectRatio"],r);let o=g(s,["resolution"]);e!==void 0&&o!=null&&v(e,["parameters","resolution"],o);let a=g(s,["personGeneration"]);if(e!==void 0&&a!=null&&v(e,["parameters","personGeneration"],a),g(s,["pubsubTopic"])!==void 0)throw new Error("pubsubTopic parameter is not supported in Gemini API.");let l=g(s,["negativePrompt"]);e!==void 0&&l!=null&&v(e,["parameters","negativePrompt"],l);let c=g(s,["enhancePrompt"]);if(e!==void 0&&c!=null&&v(e,["parameters","enhancePrompt"],c),g(s,["generateAudio"])!==void 0)throw new Error("generateAudio parameter is not supported in Gemini API.");let d=g(s,["lastFrame"]);e!==void 0&&d!=null&&v(e,["instances[0]","lastFrame"],Zw(d));let u=g(s,["referenceImages"]);if(e!==void 0&&u!=null){let h=u;Array.isArray(h)&&(h=h.map(p=>p9(p))),v(e,["instances[0]","referenceImages"],h)}if(g(s,["mask"])!==void 0)throw new Error("mask parameter is not supported in Gemini API.");if(g(s,["compressionQuality"])!==void 0)throw new Error("compressionQuality parameter is not supported in Gemini API.");return t}function hZ(s,e){let t={},n=g(s,["numberOfVideos"]);e!==void 0&&n!=null&&v(e,["parameters","sampleCount"],n);let i=g(s,["outputGcsUri"]);e!==void 0&&i!=null&&v(e,["parameters","storageUri"],i);let r=g(s,["fps"]);e!==void 0&&r!=null&&v(e,["parameters","fps"],r);let o=g(s,["durationSeconds"]);e!==void 0&&o!=null&&v(e,["parameters","durationSeconds"],o);let a=g(s,["seed"]);e!==void 0&&a!=null&&v(e,["parameters","seed"],a);let l=g(s,["aspectRatio"]);e!==void 0&&l!=null&&v(e,["parameters","aspectRatio"],l);let c=g(s,["resolution"]);e!==void 0&&c!=null&&v(e,["parameters","resolution"],c);let d=g(s,["personGeneration"]);e!==void 0&&d!=null&&v(e,["parameters","personGeneration"],d);let u=g(s,["pubsubTopic"]);e!==void 0&&u!=null&&v(e,["parameters","pubsubTopic"],u);let h=g(s,["negativePrompt"]);e!==void 0&&h!=null&&v(e,["parameters","negativePrompt"],h);let p=g(s,["enhancePrompt"]);e!==void 0&&p!=null&&v(e,["parameters","enhancePrompt"],p);let f=g(s,["generateAudio"]);e!==void 0&&f!=null&&v(e,["parameters","generateAudio"],f);let _=g(s,["lastFrame"]);e!==void 0&&_!=null&&v(e,["instances[0]","lastFrame"],ao(_));let b=g(s,["referenceImages"]);if(e!==void 0&&b!=null){let C=b;Array.isArray(C)&&(C=C.map(M=>f9(M))),v(e,["instances[0]","referenceImages"],C)}let y=g(s,["mask"]);e!==void 0&&y!=null&&v(e,["instances[0]","mask"],h9(y));let w=g(s,["compressionQuality"]);return e!==void 0&&w!=null&&v(e,["parameters","compressionQuality"],w),t}function pZ(s){let e={},t=g(s,["name"]);t!=null&&v(e,["name"],t);let n=g(s,["metadata"]);n!=null&&v(e,["metadata"],n);let i=g(s,["done"]);i!=null&&v(e,["done"],i);let r=g(s,["error"]);r!=null&&v(e,["error"],r);let o=g(s,["response","generateVideoResponse"]);return o!=null&&v(e,["response"],_Z(o)),e}function fZ(s){let e={},t=g(s,["name"]);t!=null&&v(e,["name"],t);let n=g(s,["metadata"]);n!=null&&v(e,["metadata"],n);let i=g(s,["done"]);i!=null&&v(e,["done"],i);let r=g(s,["error"]);r!=null&&v(e,["error"],r);let o=g(s,["response"]);return o!=null&&v(e,["response"],yZ(o)),e}function mZ(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["_url","model"],xn(s,n));let i=g(e,["prompt"]);i!=null&&v(t,["instances[0]","prompt"],i);let r=g(e,["image"]);r!=null&&v(t,["instances[0]","image"],Zw(r));let o=g(e,["video"]);o!=null&&v(t,["instances[0]","video"],CU(o));let a=g(e,["source"]);a!=null&&vZ(a,t);let l=g(e,["config"]);return l!=null&&uZ(l,t),t}function gZ(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["_url","model"],xn(s,n));let i=g(e,["prompt"]);i!=null&&v(t,["instances[0]","prompt"],i);let r=g(e,["image"]);r!=null&&v(t,["instances[0]","image"],ao(r));let o=g(e,["video"]);o!=null&&v(t,["instances[0]","video"],AU(o));let a=g(e,["source"]);a!=null&&bZ(a,t);let l=g(e,["config"]);return l!=null&&hZ(l,t),t}function _Z(s){let e={},t=g(s,["generatedSamples"]);if(t!=null){let r=t;Array.isArray(r)&&(r=r.map(o=>TZ(o))),v(e,["generatedVideos"],r)}let n=g(s,["raiMediaFilteredCount"]);n!=null&&v(e,["raiMediaFilteredCount"],n);let i=g(s,["raiMediaFilteredReasons"]);return i!=null&&v(e,["raiMediaFilteredReasons"],i),e}function yZ(s){let e={},t=g(s,["videos"]);if(t!=null){let r=t;Array.isArray(r)&&(r=r.map(o=>EZ(o))),v(e,["generatedVideos"],r)}let n=g(s,["raiMediaFilteredCount"]);n!=null&&v(e,["raiMediaFilteredCount"],n);let i=g(s,["raiMediaFilteredReasons"]);return i!=null&&v(e,["raiMediaFilteredReasons"],i),e}function vZ(s,e){let t={},n=g(s,["prompt"]);e!==void 0&&n!=null&&v(e,["instances[0]","prompt"],n);let i=g(s,["image"]);e!==void 0&&i!=null&&v(e,["instances[0]","image"],Zw(i));let r=g(s,["video"]);return e!==void 0&&r!=null&&v(e,["instances[0]","video"],CU(r)),t}function bZ(s,e){let t={},n=g(s,["prompt"]);e!==void 0&&n!=null&&v(e,["instances[0]","prompt"],n);let i=g(s,["image"]);e!==void 0&&i!=null&&v(e,["instances[0]","image"],ao(i));let r=g(s,["video"]);return e!==void 0&&r!=null&&v(e,["instances[0]","video"],AU(r)),t}function wZ(s){let e={},t=g(s,["_self"]);t!=null&&v(e,["image"],DZ(t));let n=g(s,["raiFilteredReason"]);n!=null&&v(e,["raiFilteredReason"],n);let i=g(s,["_self"]);return i!=null&&v(e,["safetyAttributes"],EU(i)),e}function Jw(s){let e={},t=g(s,["_self"]);t!=null&&v(e,["image"],TU(t));let n=g(s,["raiFilteredReason"]);n!=null&&v(e,["raiFilteredReason"],n);let i=g(s,["_self"]);i!=null&&v(e,["safetyAttributes"],xU(i));let r=g(s,["prompt"]);return r!=null&&v(e,["enhancedPrompt"],r),e}function MZ(s){let e={},t=g(s,["_self"]);t!=null&&v(e,["mask"],TU(t));let n=g(s,["labels"]);if(n!=null){let i=n;Array.isArray(i)&&(i=i.map(r=>r)),v(e,["labels"],i)}return e}function TZ(s){let e={},t=g(s,["video"]);return t!=null&&v(e,["video"],d9(t)),e}function EZ(s){let e={},t=g(s,["_self"]);return t!=null&&v(e,["video"],u9(t)),e}function xZ(s){let e={},t=g(s,["modelSelectionConfig"]);t!=null&&v(e,["modelConfig"],t);let n=g(s,["responseJsonSchema"]);n!=null&&v(e,["responseJsonSchema"],n);let i=g(s,["audioTimestamp"]);i!=null&&v(e,["audioTimestamp"],i);let r=g(s,["candidateCount"]);r!=null&&v(e,["candidateCount"],r);let o=g(s,["enableAffectiveDialog"]);o!=null&&v(e,["enableAffectiveDialog"],o);let a=g(s,["frequencyPenalty"]);a!=null&&v(e,["frequencyPenalty"],a);let l=g(s,["logprobs"]);l!=null&&v(e,["logprobs"],l);let c=g(s,["maxOutputTokens"]);c!=null&&v(e,["maxOutputTokens"],c);let d=g(s,["mediaResolution"]);d!=null&&v(e,["mediaResolution"],d);let u=g(s,["presencePenalty"]);u!=null&&v(e,["presencePenalty"],u);let h=g(s,["responseLogprobs"]);h!=null&&v(e,["responseLogprobs"],h);let p=g(s,["responseMimeType"]);p!=null&&v(e,["responseMimeType"],p);let f=g(s,["responseModalities"]);f!=null&&v(e,["responseModalities"],f);let _=g(s,["responseSchema"]);_!=null&&v(e,["responseSchema"],_);let b=g(s,["routingConfig"]);b!=null&&v(e,["routingConfig"],b);let y=g(s,["seed"]);y!=null&&v(e,["seed"],y);let w=g(s,["speechConfig"]);w!=null&&v(e,["speechConfig"],w);let C=g(s,["stopSequences"]);C!=null&&v(e,["stopSequences"],C);let M=g(s,["temperature"]);M!=null&&v(e,["temperature"],M);let S=g(s,["thinkingConfig"]);S!=null&&v(e,["thinkingConfig"],S);let k=g(s,["topK"]);k!=null&&v(e,["topK"],k);let T=g(s,["topP"]);if(T!=null&&v(e,["topP"],T),g(s,["enableEnhancedCivicAnswers"])!==void 0)throw new Error("enableEnhancedCivicAnswers parameter is not supported in Vertex AI.");return e}function SZ(s,e){let t={},n=g(e,["model"]);return n!=null&&v(t,["_url","name"],xn(s,n)),t}function CZ(s,e){let t={},n=g(e,["model"]);return n!=null&&v(t,["_url","name"],xn(s,n)),t}function AZ(s){let e={};if(g(s,["authConfig"])!==void 0)throw new Error("authConfig parameter is not supported in Gemini API.");let t=g(s,["enableWidget"]);return t!=null&&v(e,["enableWidget"],t),e}function PZ(s){let e={};if(g(s,["excludeDomains"])!==void 0)throw new Error("excludeDomains parameter is not supported in Gemini API.");if(g(s,["blockingConfidence"])!==void 0)throw new Error("blockingConfidence parameter is not supported in Gemini API.");let t=g(s,["timeRangeFilter"]);return t!=null&&v(e,["timeRangeFilter"],t),e}function kZ(s){let e={},t=g(s,["aspectRatio"]);t!=null&&v(e,["aspectRatio"],t);let n=g(s,["imageSize"]);if(n!=null&&v(e,["imageSize"],n),g(s,["outputMimeType"])!==void 0)throw new Error("outputMimeType parameter is not supported in Gemini API.");if(g(s,["outputCompressionQuality"])!==void 0)throw new Error("outputCompressionQuality parameter is not supported in Gemini API.");return e}function IZ(s){let e={},t=g(s,["aspectRatio"]);t!=null&&v(e,["aspectRatio"],t);let n=g(s,["imageSize"]);n!=null&&v(e,["imageSize"],n);let i=g(s,["outputMimeType"]);i!=null&&v(e,["imageOutputOptions","mimeType"],i);let r=g(s,["outputCompressionQuality"]);return r!=null&&v(e,["imageOutputOptions","compressionQuality"],r),e}function DZ(s){let e={},t=g(s,["bytesBase64Encoded"]);t!=null&&v(e,["imageBytes"],Vl(t));let n=g(s,["mimeType"]);return n!=null&&v(e,["mimeType"],n),e}function TU(s){let e={},t=g(s,["gcsUri"]);t!=null&&v(e,["gcsUri"],t);let n=g(s,["bytesBase64Encoded"]);n!=null&&v(e,["imageBytes"],Vl(n));let i=g(s,["mimeType"]);return i!=null&&v(e,["mimeType"],i),e}function Zw(s){let e={};if(g(s,["gcsUri"])!==void 0)throw new Error("gcsUri parameter is not supported in Gemini API.");let t=g(s,["imageBytes"]);t!=null&&v(e,["bytesBase64Encoded"],Vl(t));let n=g(s,["mimeType"]);return n!=null&&v(e,["mimeType"],n),e}function ao(s){let e={},t=g(s,["gcsUri"]);t!=null&&v(e,["gcsUri"],t);let n=g(s,["imageBytes"]);n!=null&&v(e,["bytesBase64Encoded"],Vl(n));let i=g(s,["mimeType"]);return i!=null&&v(e,["mimeType"],i),e}function RZ(s,e,t){let n={},i=g(e,["pageSize"]);t!==void 0&&i!=null&&v(t,["_query","pageSize"],i);let r=g(e,["pageToken"]);t!==void 0&&r!=null&&v(t,["_query","pageToken"],r);let o=g(e,["filter"]);t!==void 0&&o!=null&&v(t,["_query","filter"],o);let a=g(e,["queryBase"]);return t!==void 0&&a!=null&&v(t,["_url","models_url"],gU(s,a)),n}function FZ(s,e,t){let n={},i=g(e,["pageSize"]);t!==void 0&&i!=null&&v(t,["_query","pageSize"],i);let r=g(e,["pageToken"]);t!==void 0&&r!=null&&v(t,["_query","pageToken"],r);let o=g(e,["filter"]);t!==void 0&&o!=null&&v(t,["_query","filter"],o);let a=g(e,["queryBase"]);return t!==void 0&&a!=null&&v(t,["_url","models_url"],gU(s,a)),n}function LZ(s,e){let t={},n=g(e,["config"]);return n!=null&&RZ(s,n,t),t}function NZ(s,e){let t={},n=g(e,["config"]);return n!=null&&FZ(s,n,t),t}function OZ(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["nextPageToken"]);n!=null&&v(e,["nextPageToken"],n);let i=g(s,["_self"]);if(i!=null){let r=_U(i);Array.isArray(r)&&(r=r.map(o=>wA(o))),v(e,["models"],r)}return e}function $Z(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["nextPageToken"]);n!=null&&v(e,["nextPageToken"],n);let i=g(s,["_self"]);if(i!=null){let r=_U(i);Array.isArray(r)&&(r=r.map(o=>MA(o))),v(e,["models"],r)}return e}function BZ(s){let e={},t=g(s,["maskMode"]);t!=null&&v(e,["maskMode"],t);let n=g(s,["segmentationClasses"]);n!=null&&v(e,["maskClasses"],n);let i=g(s,["maskDilation"]);return i!=null&&v(e,["dilation"],i),e}function wA(s){let e={},t=g(s,["name"]);t!=null&&v(e,["name"],t);let n=g(s,["displayName"]);n!=null&&v(e,["displayName"],n);let i=g(s,["description"]);i!=null&&v(e,["description"],i);let r=g(s,["version"]);r!=null&&v(e,["version"],r);let o=g(s,["_self"]);o!=null&&v(e,["tunedModelInfo"],t9(o));let a=g(s,["inputTokenLimit"]);a!=null&&v(e,["inputTokenLimit"],a);let l=g(s,["outputTokenLimit"]);l!=null&&v(e,["outputTokenLimit"],l);let c=g(s,["supportedGenerationMethods"]);c!=null&&v(e,["supportedActions"],c);let d=g(s,["temperature"]);d!=null&&v(e,["temperature"],d);let u=g(s,["maxTemperature"]);u!=null&&v(e,["maxTemperature"],u);let h=g(s,["topP"]);h!=null&&v(e,["topP"],h);let p=g(s,["topK"]);p!=null&&v(e,["topK"],p);let f=g(s,["thinking"]);return f!=null&&v(e,["thinking"],f),e}function MA(s){let e={},t=g(s,["name"]);t!=null&&v(e,["name"],t);let n=g(s,["displayName"]);n!=null&&v(e,["displayName"],n);let i=g(s,["description"]);i!=null&&v(e,["description"],i);let r=g(s,["versionId"]);r!=null&&v(e,["version"],r);let o=g(s,["deployedModels"]);if(o!=null){let u=o;Array.isArray(u)&&(u=u.map(h=>JJ(h))),v(e,["endpoints"],u)}let a=g(s,["labels"]);a!=null&&v(e,["labels"],a);let l=g(s,["_self"]);l!=null&&v(e,["tunedModelInfo"],n9(l));let c=g(s,["defaultCheckpointId"]);c!=null&&v(e,["defaultCheckpointId"],c);let d=g(s,["checkpoints"]);if(d!=null){let u=d;Array.isArray(u)&&(u=u.map(h=>h)),v(e,["checkpoints"],u)}return e}function zZ(s){let e={},t=g(s,["mediaResolution"]);t!=null&&v(e,["mediaResolution"],t);let n=g(s,["codeExecutionResult"]);n!=null&&v(e,["codeExecutionResult"],n);let i=g(s,["executableCode"]);i!=null&&v(e,["executableCode"],i);let r=g(s,["fileData"]);r!=null&&v(e,["fileData"],ZJ(r));let o=g(s,["functionCall"]);o!=null&&v(e,["functionCall"],eZ(o));let a=g(s,["functionResponse"]);a!=null&&v(e,["functionResponse"],a);let l=g(s,["inlineData"]);l!=null&&v(e,["inlineData"],xJ(l));let c=g(s,["text"]);c!=null&&v(e,["text"],c);let d=g(s,["thought"]);d!=null&&v(e,["thought"],d);let u=g(s,["thoughtSignature"]);u!=null&&v(e,["thoughtSignature"],u);let h=g(s,["videoMetadata"]);return h!=null&&v(e,["videoMetadata"],h),e}function UZ(s){let e={},t=g(s,["productImage"]);return t!=null&&v(e,["image"],ao(t)),e}function VZ(s,e){let t={},n=g(s,["numberOfImages"]);e!==void 0&&n!=null&&v(e,["parameters","sampleCount"],n);let i=g(s,["baseSteps"]);e!==void 0&&i!=null&&v(e,["parameters","baseSteps"],i);let r=g(s,["outputGcsUri"]);e!==void 0&&r!=null&&v(e,["parameters","storageUri"],r);let o=g(s,["seed"]);e!==void 0&&o!=null&&v(e,["parameters","seed"],o);let a=g(s,["safetyFilterLevel"]);e!==void 0&&a!=null&&v(e,["parameters","safetySetting"],a);let l=g(s,["personGeneration"]);e!==void 0&&l!=null&&v(e,["parameters","personGeneration"],l);let c=g(s,["addWatermark"]);e!==void 0&&c!=null&&v(e,["parameters","addWatermark"],c);let d=g(s,["outputMimeType"]);e!==void 0&&d!=null&&v(e,["parameters","outputOptions","mimeType"],d);let u=g(s,["outputCompressionQuality"]);e!==void 0&&u!=null&&v(e,["parameters","outputOptions","compressionQuality"],u);let h=g(s,["enhancePrompt"]);e!==void 0&&h!=null&&v(e,["parameters","enhancePrompt"],h);let p=g(s,["labels"]);return e!==void 0&&p!=null&&v(e,["labels"],p),t}function GZ(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["_url","model"],xn(s,n));let i=g(e,["source"]);i!=null&&HZ(i,t);let r=g(e,["config"]);return r!=null&&VZ(r,t),t}function WZ(s){let e={},t=g(s,["predictions"]);if(t!=null){let n=t;Array.isArray(n)&&(n=n.map(i=>Jw(i))),v(e,["generatedImages"],n)}return e}function HZ(s,e){let t={},n=g(s,["prompt"]);e!==void 0&&n!=null&&v(e,["instances[0]","prompt"],n);let i=g(s,["personImage"]);e!==void 0&&i!=null&&v(e,["instances[0]","personImage","image"],ao(i));let r=g(s,["productImages"]);if(e!==void 0&&r!=null){let o=r;Array.isArray(o)&&(o=o.map(a=>UZ(a))),v(e,["instances[0]","productImages"],o)}return t}function jZ(s){let e={},t=g(s,["referenceImage"]);t!=null&&v(e,["referenceImage"],ao(t));let n=g(s,["referenceId"]);n!=null&&v(e,["referenceId"],n);let i=g(s,["referenceType"]);i!=null&&v(e,["referenceType"],i);let r=g(s,["maskImageConfig"]);r!=null&&v(e,["maskImageConfig"],BZ(r));let o=g(s,["controlImageConfig"]);o!=null&&v(e,["controlImageConfig"],DJ(o));let a=g(s,["styleImageConfig"]);a!=null&&v(e,["styleImageConfig"],a);let l=g(s,["subjectImageConfig"]);return l!=null&&v(e,["subjectImageConfig"],l),e}function EU(s){let e={},t=g(s,["safetyAttributes","categories"]);t!=null&&v(e,["categories"],t);let n=g(s,["safetyAttributes","scores"]);n!=null&&v(e,["scores"],n);let i=g(s,["contentType"]);return i!=null&&v(e,["contentType"],i),e}function xU(s){let e={},t=g(s,["safetyAttributes","categories"]);t!=null&&v(e,["categories"],t);let n=g(s,["safetyAttributes","scores"]);n!=null&&v(e,["scores"],n);let i=g(s,["contentType"]);return i!=null&&v(e,["contentType"],i),e}function qZ(s){let e={},t=g(s,["category"]);if(t!=null&&v(e,["category"],t),g(s,["method"])!==void 0)throw new Error("method parameter is not supported in Gemini API.");let n=g(s,["threshold"]);return n!=null&&v(e,["threshold"],n),e}function KZ(s){let e={},t=g(s,["image"]);return t!=null&&v(e,["image"],ao(t)),e}function YZ(s,e){let t={},n=g(s,["mode"]);e!==void 0&&n!=null&&v(e,["parameters","mode"],n);let i=g(s,["maxPredictions"]);e!==void 0&&i!=null&&v(e,["parameters","maxPredictions"],i);let r=g(s,["confidenceThreshold"]);e!==void 0&&r!=null&&v(e,["parameters","confidenceThreshold"],r);let o=g(s,["maskDilation"]);e!==void 0&&o!=null&&v(e,["parameters","maskDilation"],o);let a=g(s,["binaryColorThreshold"]);e!==void 0&&a!=null&&v(e,["parameters","binaryColorThreshold"],a);let l=g(s,["labels"]);return e!==void 0&&l!=null&&v(e,["labels"],l),t}function XZ(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["_url","model"],xn(s,n));let i=g(e,["source"]);i!=null&&JZ(i,t);let r=g(e,["config"]);return r!=null&&YZ(r,t),t}function QZ(s){let e={},t=g(s,["predictions"]);if(t!=null){let n=t;Array.isArray(n)&&(n=n.map(i=>MZ(i))),v(e,["generatedMasks"],n)}return e}function JZ(s,e){let t={},n=g(s,["prompt"]);e!==void 0&&n!=null&&v(e,["instances[0]","prompt"],n);let i=g(s,["image"]);e!==void 0&&i!=null&&v(e,["instances[0]","image"],ao(i));let r=g(s,["scribbleImage"]);return e!==void 0&&r!=null&&v(e,["instances[0]","scribble"],KZ(r)),t}function ZZ(s){let e={},t=g(s,["functionCallingConfig"]);t!=null&&v(e,["functionCallingConfig"],tZ(t));let n=g(s,["retrievalConfig"]);return n!=null&&v(e,["retrievalConfig"],n),e}function e9(s){let e={},t=g(s,["functionDeclarations"]);if(t!=null){let d=t;Array.isArray(d)&&(d=d.map(u=>u)),v(e,["functionDeclarations"],d)}if(g(s,["retrieval"])!==void 0)throw new Error("retrieval parameter is not supported in Gemini API.");let n=g(s,["googleSearchRetrieval"]);n!=null&&v(e,["googleSearchRetrieval"],n);let i=g(s,["computerUse"]);i!=null&&v(e,["computerUse"],i);let r=g(s,["fileSearch"]);r!=null&&v(e,["fileSearch"],r);let o=g(s,["codeExecution"]);if(o!=null&&v(e,["codeExecution"],o),g(s,["enterpriseWebSearch"])!==void 0)throw new Error("enterpriseWebSearch parameter is not supported in Gemini API.");let a=g(s,["googleMaps"]);a!=null&&v(e,["googleMaps"],AZ(a));let l=g(s,["googleSearch"]);l!=null&&v(e,["googleSearch"],PZ(l));let c=g(s,["urlContext"]);return c!=null&&v(e,["urlContext"],c),e}function SU(s){let e={},t=g(s,["functionDeclarations"]);if(t!=null){let u=t;Array.isArray(u)&&(u=u.map(h=>nZ(h))),v(e,["functionDeclarations"],u)}let n=g(s,["retrieval"]);n!=null&&v(e,["retrieval"],n);let i=g(s,["googleSearchRetrieval"]);i!=null&&v(e,["googleSearchRetrieval"],i);let r=g(s,["computerUse"]);if(r!=null&&v(e,["computerUse"],r),g(s,["fileSearch"])!==void 0)throw new Error("fileSearch parameter is not supported in Vertex AI.");let o=g(s,["codeExecution"]);o!=null&&v(e,["codeExecution"],o);let a=g(s,["enterpriseWebSearch"]);a!=null&&v(e,["enterpriseWebSearch"],a);let l=g(s,["googleMaps"]);l!=null&&v(e,["googleMaps"],l);let c=g(s,["googleSearch"]);c!=null&&v(e,["googleSearch"],c);let d=g(s,["urlContext"]);return d!=null&&v(e,["urlContext"],d),e}function t9(s){let e={},t=g(s,["baseModel"]);t!=null&&v(e,["baseModel"],t);let n=g(s,["createTime"]);n!=null&&v(e,["createTime"],n);let i=g(s,["updateTime"]);return i!=null&&v(e,["updateTime"],i),e}function n9(s){let e={},t=g(s,["labels","google-vertex-llm-tuning-base-model-id"]);t!=null&&v(e,["baseModel"],t);let n=g(s,["createTime"]);n!=null&&v(e,["createTime"],n);let i=g(s,["updateTime"]);return i!=null&&v(e,["updateTime"],i),e}function s9(s,e){let t={},n=g(s,["displayName"]);e!==void 0&&n!=null&&v(e,["displayName"],n);let i=g(s,["description"]);e!==void 0&&i!=null&&v(e,["description"],i);let r=g(s,["defaultCheckpointId"]);return e!==void 0&&r!=null&&v(e,["defaultCheckpointId"],r),t}function i9(s,e){let t={},n=g(s,["displayName"]);e!==void 0&&n!=null&&v(e,["displayName"],n);let i=g(s,["description"]);e!==void 0&&i!=null&&v(e,["description"],i);let r=g(s,["defaultCheckpointId"]);return e!==void 0&&r!=null&&v(e,["defaultCheckpointId"],r),t}function r9(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["_url","name"],xn(s,n));let i=g(e,["config"]);return i!=null&&s9(i,t),t}function o9(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["_url","model"],xn(s,n));let i=g(e,["config"]);return i!=null&&i9(i,t),t}function a9(s,e){let t={},n=g(s,["outputGcsUri"]);e!==void 0&&n!=null&&v(e,["parameters","storageUri"],n);let i=g(s,["safetyFilterLevel"]);e!==void 0&&i!=null&&v(e,["parameters","safetySetting"],i);let r=g(s,["personGeneration"]);e!==void 0&&r!=null&&v(e,["parameters","personGeneration"],r);let o=g(s,["includeRaiReason"]);e!==void 0&&o!=null&&v(e,["parameters","includeRaiReason"],o);let a=g(s,["outputMimeType"]);e!==void 0&&a!=null&&v(e,["parameters","outputOptions","mimeType"],a);let l=g(s,["outputCompressionQuality"]);e!==void 0&&l!=null&&v(e,["parameters","outputOptions","compressionQuality"],l);let c=g(s,["enhanceInputImage"]);e!==void 0&&c!=null&&v(e,["parameters","upscaleConfig","enhanceInputImage"],c);let d=g(s,["imagePreservationFactor"]);e!==void 0&&d!=null&&v(e,["parameters","upscaleConfig","imagePreservationFactor"],d);let u=g(s,["labels"]);e!==void 0&&u!=null&&v(e,["labels"],u);let h=g(s,["numberOfImages"]);e!==void 0&&h!=null&&v(e,["parameters","sampleCount"],h);let p=g(s,["mode"]);return e!==void 0&&p!=null&&v(e,["parameters","mode"],p),t}function l9(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["_url","model"],xn(s,n));let i=g(e,["image"]);i!=null&&v(t,["instances[0]","image"],ao(i));let r=g(e,["upscaleFactor"]);r!=null&&v(t,["parameters","upscaleConfig","upscaleFactor"],r);let o=g(e,["config"]);return o!=null&&a9(o,t),t}function c9(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["predictions"]);if(n!=null){let i=n;Array.isArray(i)&&(i=i.map(r=>Jw(r))),v(e,["generatedImages"],i)}return e}function d9(s){let e={},t=g(s,["uri"]);t!=null&&v(e,["uri"],t);let n=g(s,["encodedVideo"]);n!=null&&v(e,["videoBytes"],Vl(n));let i=g(s,["encoding"]);return i!=null&&v(e,["mimeType"],i),e}function u9(s){let e={},t=g(s,["gcsUri"]);t!=null&&v(e,["uri"],t);let n=g(s,["bytesBase64Encoded"]);n!=null&&v(e,["videoBytes"],Vl(n));let i=g(s,["mimeType"]);return i!=null&&v(e,["mimeType"],i),e}function h9(s){let e={},t=g(s,["image"]);t!=null&&v(e,["_self"],ao(t));let n=g(s,["maskMode"]);return n!=null&&v(e,["maskMode"],n),e}function p9(s){let e={},t=g(s,["image"]);t!=null&&v(e,["image"],Zw(t));let n=g(s,["referenceType"]);return n!=null&&v(e,["referenceType"],n),e}function f9(s){let e={},t=g(s,["image"]);t!=null&&v(e,["image"],ao(t));let n=g(s,["referenceType"]);return n!=null&&v(e,["referenceType"],n),e}function CU(s){let e={},t=g(s,["uri"]);t!=null&&v(e,["uri"],t);let n=g(s,["videoBytes"]);n!=null&&v(e,["encodedVideo"],Vl(n));let i=g(s,["mimeType"]);return i!=null&&v(e,["encoding"],i),e}function AU(s){let e={},t=g(s,["uri"]);t!=null&&v(e,["gcsUri"],t);let n=g(s,["videoBytes"]);n!=null&&v(e,["bytesBase64Encoded"],Vl(n));let i=g(s,["mimeType"]);return i!=null&&v(e,["mimeType"],i),e}function m9(s,e){let t={},n=g(s,["displayName"]);return e!==void 0&&n!=null&&v(e,["displayName"],n),t}function g9(s){let e={},t=g(s,["config"]);return t!=null&&m9(t,e),e}function _9(s,e){let t={},n=g(s,["force"]);return e!==void 0&&n!=null&&v(e,["_query","force"],n),t}function y9(s){let e={},t=g(s,["name"]);t!=null&&v(e,["_url","name"],t);let n=g(s,["config"]);return n!=null&&_9(n,e),e}function v9(s){let e={},t=g(s,["name"]);return t!=null&&v(e,["_url","name"],t),e}function b9(s,e){let t={},n=g(s,["customMetadata"]);if(e!==void 0&&n!=null){let r=n;Array.isArray(r)&&(r=r.map(o=>o)),v(e,["customMetadata"],r)}let i=g(s,["chunkingConfig"]);return e!==void 0&&i!=null&&v(e,["chunkingConfig"],i),t}function w9(s){let e={},t=g(s,["name"]);t!=null&&v(e,["name"],t);let n=g(s,["metadata"]);n!=null&&v(e,["metadata"],n);let i=g(s,["done"]);i!=null&&v(e,["done"],i);let r=g(s,["error"]);r!=null&&v(e,["error"],r);let o=g(s,["response"]);return o!=null&&v(e,["response"],T9(o)),e}function M9(s){let e={},t=g(s,["fileSearchStoreName"]);t!=null&&v(e,["_url","file_search_store_name"],t);let n=g(s,["fileName"]);n!=null&&v(e,["fileName"],n);let i=g(s,["config"]);return i!=null&&b9(i,e),e}function T9(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["parent"]);n!=null&&v(e,["parent"],n);let i=g(s,["documentName"]);return i!=null&&v(e,["documentName"],i),e}function E9(s,e){let t={},n=g(s,["pageSize"]);e!==void 0&&n!=null&&v(e,["_query","pageSize"],n);let i=g(s,["pageToken"]);return e!==void 0&&i!=null&&v(e,["_query","pageToken"],i),t}function x9(s){let e={},t=g(s,["config"]);return t!=null&&E9(t,e),e}function S9(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["nextPageToken"]);n!=null&&v(e,["nextPageToken"],n);let i=g(s,["fileSearchStores"]);if(i!=null){let r=i;Array.isArray(r)&&(r=r.map(o=>o)),v(e,["fileSearchStores"],r)}return e}function PU(s,e){let t={},n=g(s,["mimeType"]);e!==void 0&&n!=null&&v(e,["mimeType"],n);let i=g(s,["displayName"]);e!==void 0&&i!=null&&v(e,["displayName"],i);let r=g(s,["customMetadata"]);if(e!==void 0&&r!=null){let a=r;Array.isArray(a)&&(a=a.map(l=>l)),v(e,["customMetadata"],a)}let o=g(s,["chunkingConfig"]);return e!==void 0&&o!=null&&v(e,["chunkingConfig"],o),t}function C9(s){let e={},t=g(s,["fileSearchStoreName"]);t!=null&&v(e,["_url","file_search_store_name"],t);let n=g(s,["config"]);return n!=null&&PU(n,e),e}function A9(s){let e={},t=g(s,["sdkHttpResponse"]);return t!=null&&v(e,["sdkHttpResponse"],t),e}var P9="Content-Type",k9="X-Server-Timeout",I9="User-Agent",TA="x-goog-api-client",D9="1.34.0",R9=`google-genai-sdk/${D9}`,F9="v1beta1",L9="v1beta",EA=class{constructor(e){var t,n;this.clientOptions=Object.assign(Object.assign({},e),{project:e.project,location:e.location,apiKey:e.apiKey,vertexai:e.vertexai});let i={};this.clientOptions.vertexai?(i.apiVersion=(t=this.clientOptions.apiVersion)!==null&&t!==void 0?t:F9,i.baseUrl=this.baseUrlFromProjectLocation(),this.normalizeAuthParameters()):(i.apiVersion=(n=this.clientOptions.apiVersion)!==null&&n!==void 0?n:L9,i.baseUrl="https://generativelanguage.googleapis.com/"),i.headers=this.getDefaultHeaders(),this.clientOptions.httpOptions=i,e.httpOptions&&(this.clientOptions.httpOptions=this.patchHttpOptions(i,e.httpOptions))}baseUrlFromProjectLocation(){return this.clientOptions.project&&this.clientOptions.location&&this.clientOptions.location!=="global"?`https://${this.clientOptions.location}-aiplatform.googleapis.com/`:"https://aiplatform.googleapis.com/"}normalizeAuthParameters(){if(this.clientOptions.project&&this.clientOptions.location){this.clientOptions.apiKey=void 0;return}this.clientOptions.project=void 0,this.clientOptions.location=void 0}isVertexAI(){var e;return(e=this.clientOptions.vertexai)!==null&&e!==void 0?e:!1}getProject(){return this.clientOptions.project}getLocation(){return this.clientOptions.location}async getAuthHeaders(){let e=new Headers;return await this.clientOptions.auth.addAuthHeaders(e),e}getApiVersion(){if(this.clientOptions.httpOptions&&this.clientOptions.httpOptions.apiVersion!==void 0)return this.clientOptions.httpOptions.apiVersion;throw new Error("API version is not set.")}getBaseUrl(){if(this.clientOptions.httpOptions&&this.clientOptions.httpOptions.baseUrl!==void 0)return this.clientOptions.httpOptions.baseUrl;throw new Error("Base URL is not set.")}getRequestUrl(){return this.getRequestUrlInternal(this.clientOptions.httpOptions)}getHeaders(){if(this.clientOptions.httpOptions&&this.clientOptions.httpOptions.headers!==void 0)return this.clientOptions.httpOptions.headers;throw new Error("Headers are not set.")}getRequestUrlInternal(e){if(!e||e.baseUrl===void 0||e.apiVersion===void 0)throw new Error("HTTP options are not correctly set.");let n=[e.baseUrl.endsWith("/")?e.baseUrl.slice(0,-1):e.baseUrl];return e.apiVersion&&e.apiVersion!==""&&n.push(e.apiVersion),n.join("/")}getBaseResourcePath(){return`projects/${this.clientOptions.project}/locations/${this.clientOptions.location}`}getApiKey(){return this.clientOptions.apiKey}getWebsocketBaseUrl(){let e=this.getBaseUrl(),t=new URL(e);return t.protocol=t.protocol=="http:"?"ws":"wss",t.toString()}setBaseUrl(e){if(this.clientOptions.httpOptions)this.clientOptions.httpOptions.baseUrl=e;else throw new Error("HTTP options are not correctly set.")}constructUrl(e,t,n){let i=[this.getRequestUrlInternal(t)];return n&&i.push(this.getBaseResourcePath()),e!==""&&i.push(e),new URL(`${i.join("/")}`)}shouldPrependVertexProjectPath(e){return!(this.clientOptions.apiKey||!this.clientOptions.vertexai||e.path.startsWith("projects/")||e.httpMethod==="GET"&&e.path.startsWith("publishers/google/models"))}async request(e){let t=this.clientOptions.httpOptions;e.httpOptions&&(t=this.patchHttpOptions(this.clientOptions.httpOptions,e.httpOptions));let n=this.shouldPrependVertexProjectPath(e),i=this.constructUrl(e.path,t,n);if(e.queryParams)for(let[o,a]of Object.entries(e.queryParams))i.searchParams.append(o,String(a));let r={};if(e.httpMethod==="GET"){if(e.body&&e.body!=="{}")throw new Error("Request body should be empty for GET request, but got non empty request body")}else r.body=e.body;return r=await this.includeExtraHttpOptionsToRequestInit(r,t,i.toString(),e.abortSignal),this.unaryApiCall(i,r,e.httpMethod)}patchHttpOptions(e,t){let n=JSON.parse(JSON.stringify(e));for(let[i,r]of Object.entries(t))typeof r=="object"?n[i]=Object.assign(Object.assign({},n[i]),r):r!==void 0&&(n[i]=r);return n}async requestStream(e){let t=this.clientOptions.httpOptions;e.httpOptions&&(t=this.patchHttpOptions(this.clientOptions.httpOptions,e.httpOptions));let n=this.shouldPrependVertexProjectPath(e),i=this.constructUrl(e.path,t,n);(!i.searchParams.has("alt")||i.searchParams.get("alt")!=="sse")&&i.searchParams.set("alt","sse");let r={};return r.body=e.body,r=await this.includeExtraHttpOptionsToRequestInit(r,t,i.toString(),e.abortSignal),this.streamApiCall(i,r,e.httpMethod)}async includeExtraHttpOptionsToRequestInit(e,t,n,i){if(t&&t.timeout||i){let r=new AbortController,o=r.signal;if(t.timeout&&t?.timeout>0){let a=setTimeout(()=>r.abort(),t.timeout);a&&typeof a.unref=="function"&&a.unref()}i&&i.addEventListener("abort",()=>{r.abort()}),e.signal=o}return t&&t.extraBody!==null&&N9(e,t.extraBody),e.headers=await this.getHeadersInternal(t,n),e}async unaryApiCall(e,t,n){return this.apiCall(e.toString(),Object.assign(Object.assign({},t),{method:n})).then(async i=>(await Kz(i),new Hm(i))).catch(i=>{throw i instanceof Error?i:new Error(JSON.stringify(i))})}async streamApiCall(e,t,n){return this.apiCall(e.toString(),Object.assign(Object.assign({},t),{method:n})).then(async i=>(await Kz(i),this.processStreamResponse(i))).catch(i=>{throw i instanceof Error?i:new Error(JSON.stringify(i))})}processStreamResponse(e){return io(this,arguments,function*(){var n;let i=(n=e?.body)===null||n===void 0?void 0:n.getReader(),r=new TextDecoder("utf-8");if(!i)throw new Error("Response body is empty");try{let o="",a="data:",l=[`

`,"\r\r",`\r
\r
`];for(;;){let{done:c,value:d}=yield Yt(i.read());if(c){if(o.trim().length>0)throw new Error("Incomplete JSON segment at the end");break}let u=r.decode(d,{stream:!0});try{let f=JSON.parse(u);if("error"in f){let _=JSON.parse(JSON.stringify(f.error)),b=_.status,y=_.code,w=`got status: ${b}. ${JSON.stringify(f)}`;if(y>=400&&y<600)throw new Fw({message:w,status:y})}}catch(f){if(f.name==="ApiError")throw f}o+=u;let h=-1,p=0;for(;;){h=-1,p=0;for(let b of l){let y=o.indexOf(b);y!==-1&&(h===-1||y<h)&&(h=y,p=b.length)}if(h===-1)break;let f=o.substring(0,h);o=o.substring(h+p);let _=f.trim();if(_.startsWith(a)){let b=_.substring(a.length).trim();try{let y=new Response(b,{headers:e?.headers,status:e?.status,statusText:e?.statusText});yield yield Yt(new Hm(y))}catch(y){throw new Error(`exception parsing stream chunk ${b}. ${y}`)}}}}}finally{i.releaseLock()}})}async apiCall(e,t){return fetch(e,t).catch(n=>{throw new Error(`exception ${n} sending request`)})}getDefaultHeaders(){let e={},t=R9+" "+this.clientOptions.userAgentExtra;return e[I9]=t,e[TA]=t,e[P9]="application/json",e}async getHeadersInternal(e,t){let n=new Headers;if(e&&e.headers){for(let[i,r]of Object.entries(e.headers))n.append(i,r);e.timeout&&e.timeout>0&&n.append(k9,String(Math.ceil(e.timeout/1e3)))}return await this.clientOptions.auth.addAuthHeaders(n,t),n}getFileName(e){var t;let n="";return typeof e=="string"&&(n=e.replace(/[/\\]+$/,""),n=(t=n.split(/[/\\]/).pop())!==null&&t!==void 0?t:""),n}async uploadFile(e,t){var n;let i={};t!=null&&(i.mimeType=t.mimeType,i.name=t.name,i.displayName=t.displayName),i.name&&!i.name.startsWith("files/")&&(i.name=`files/${i.name}`);let r=this.clientOptions.uploader,o=await r.stat(e);i.sizeBytes=String(o.size);let a=(n=t?.mimeType)!==null&&n!==void 0?n:o.type;if(a===void 0||a==="")throw new Error("Can not determine mimeType. Please provide mimeType in the config.");i.mimeType=a;let l={file:i},c=this.getFileName(e),d=mt("upload/v1beta/files",l._url),u=await this.fetchUploadUrl(d,i.sizeBytes,i.mimeType,c,l,t?.httpOptions);return r.upload(e,u,this)}async uploadFileToFileSearchStore(e,t,n){var i;let r=this.clientOptions.uploader,o=await r.stat(t),a=String(o.size),l=(i=n?.mimeType)!==null&&i!==void 0?i:o.type;if(l===void 0||l==="")throw new Error("Can not determine mimeType. Please provide mimeType in the config.");let c=`upload/v1beta/${e}:uploadToFileSearchStore`,d=this.getFileName(t),u={};n!=null&&PU(n,u);let h=await this.fetchUploadUrl(c,a,l,d,u,n?.httpOptions);return r.uploadToFileSearchStore(t,h,this)}async downloadFile(e){await this.clientOptions.downloader.download(e,this)}async fetchUploadUrl(e,t,n,i,r,o){var a;let l={};o?l=o:l={apiVersion:"",headers:Object.assign({"Content-Type":"application/json","X-Goog-Upload-Protocol":"resumable","X-Goog-Upload-Command":"start","X-Goog-Upload-Header-Content-Length":`${t}`,"X-Goog-Upload-Header-Content-Type":`${n}`},i?{"X-Goog-Upload-File-Name":i}:{})};let c=await this.request({path:e,body:JSON.stringify(r),httpMethod:"POST",httpOptions:l});if(!c||!c?.headers)throw new Error("Server did not return an HttpResponse or the returned HttpResponse did not have headers.");let d=(a=c?.headers)===null||a===void 0?void 0:a["x-goog-upload-url"];if(d===void 0)throw new Error("Failed to get upload url. Server did not return the x-google-upload-url in the headers");return d}};async function Kz(s){var e;if(s===void 0)throw new Error("response is undefined");if(!s.ok){let t=s.status,n;!((e=s.headers.get("content-type"))===null||e===void 0)&&e.includes("application/json")?n=await s.json():n={error:{message:await s.text(),code:s.status,status:s.statusText}};let i=JSON.stringify(n);throw t>=400&&t<600?new Fw({message:i,status:t}):new Error(i)}}function N9(s,e){if(!e||Object.keys(e).length===0)return;if(s.body instanceof Blob){console.warn("includeExtraBodyToRequestInit: extraBody provided but current request body is a Blob. extraBody will be ignored as merging is not supported for Blob bodies.");return}let t={};if(typeof s.body=="string"&&s.body.length>0)try{let r=JSON.parse(s.body);if(typeof r=="object"&&r!==null&&!Array.isArray(r))t=r;else{console.warn("includeExtraBodyToRequestInit: Original request body is valid JSON but not a non-array object. Skip applying extraBody to the request body.");return}}catch{console.warn("includeExtraBodyToRequestInit: Original request body is not valid JSON. Skip applying extraBody to the request body.");return}function n(r,o){let a=Object.assign({},r);for(let l in o)if(Object.prototype.hasOwnProperty.call(o,l)){let c=o[l],d=a[l];c&&typeof c=="object"&&!Array.isArray(c)&&d&&typeof d=="object"&&!Array.isArray(d)?a[l]=n(d,c):(d&&c&&typeof d!=typeof c&&console.warn(`includeExtraBodyToRequestInit:deepMerge: Type mismatch for key "${l}". Original type: ${typeof d}, New type: ${typeof c}. Overwriting.`),a[l]=c)}return a}let i=n(t,e);s.body=JSON.stringify(i)}var O9="mcp_used/unknown",$9=!1;function kU(s){for(let e of s)if(B9(e)||typeof e=="object"&&"inputSchema"in e)return!0;return $9}function IU(s){var e;let t=(e=s[TA])!==null&&e!==void 0?e:"";s[TA]=(t+` ${O9}`).trimStart()}function B9(s){return s!==null&&typeof s=="object"&&s instanceof xA}function z9(s){return io(this,arguments,function*(t,n=100){let i,r=0;for(;r<n;){let o=yield Yt(t.listTools({cursor:i}));for(let a of o.tools)yield yield Yt(a),r++;if(!o.nextCursor)break;i=o.nextCursor}})}var xA=class s{constructor(e=[],t){this.mcpTools=[],this.functionNameToMcpClient={},this.mcpClients=e,this.config=t}static create(e,t){return new s(e,t)}async initialize(){var e,t,n,i;if(this.mcpTools.length>0)return;let r={},o=[];for(let d of this.mcpClients)try{for(var a=!0,l=(t=void 0,ro(z9(d))),c;c=await l.next(),e=c.done,!e;a=!0){i=c.value,a=!1;let u=i;o.push(u);let h=u.name;if(r[h])throw new Error(`Duplicate function name ${h} found in MCP tools. Please ensure function names are unique.`);r[h]=d}}catch(u){t={error:u}}finally{try{!a&&!e&&(n=l.return)&&await n.call(l)}finally{if(t)throw t.error}}this.mcpTools=o,this.functionNameToMcpClient=r}async tool(){return await this.initialize(),EX(this.mcpTools,this.config)}async callTool(e){await this.initialize();let t=[];for(let n of e)if(n.name in this.functionNameToMcpClient){let i=this.functionNameToMcpClient[n.name],r;this.config.timeout&&(r={timeout:this.config.timeout});let o=await i.callTool({name:n.name,arguments:n.args},void 0,r);t.push({functionResponse:{name:n.name,response:o.isError?{error:o}:o}})}return t}};async function U9(s,e,t){let n=new hA,i;t.data instanceof Blob?i=JSON.parse(await t.data.text()):i=JSON.parse(t.data),Object.assign(n,i),e(n)}var SA=class{constructor(e,t,n){this.apiClient=e,this.auth=t,this.webSocketFactory=n}async connect(e){var t,n;if(this.apiClient.isVertexAI())throw new Error("Live music is not supported for Vertex AI.");console.warn("Live music generation is experimental and may change in future versions.");let i=this.apiClient.getWebsocketBaseUrl(),r=this.apiClient.getApiVersion(),o=G9(this.apiClient.getDefaultHeaders()),a=this.apiClient.getApiKey(),l=`${i}/ws/google.ai.generativelanguage.${r}.GenerativeService.BidiGenerateMusic?key=${a}`,c=()=>{},d=new Promise(C=>{c=C}),u=e.callbacks,h=function(){c({})},p=this.apiClient,f={onopen:h,onmessage:C=>{U9(p,u.onmessage,C)},onerror:(t=u?.onerror)!==null&&t!==void 0?t:function(C){},onclose:(n=u?.onclose)!==null&&n!==void 0?n:function(C){}},_=this.webSocketFactory.create(l,V9(o),f);_.connect(),await d;let w={setup:{model:xn(this.apiClient,e.model)}};return _.send(JSON.stringify(w)),new CA(_,this.apiClient)}},CA=class{constructor(e,t){this.conn=e,this.apiClient=t}async setWeightedPrompts(e){if(!e.weightedPrompts||Object.keys(e.weightedPrompts).length===0)throw new Error("Weighted prompts must be set and contain at least one entry.");let t=gJ(e);this.conn.send(JSON.stringify({clientContent:t}))}async setMusicGenerationConfig(e){e.musicGenerationConfig||(e.musicGenerationConfig={});let t=mJ(e);this.conn.send(JSON.stringify(t))}sendPlaybackControl(e){let t={playbackControl:e};this.conn.send(JSON.stringify(t))}play(){this.sendPlaybackControl(Vh.PLAY)}pause(){this.sendPlaybackControl(Vh.PAUSE)}stop(){this.sendPlaybackControl(Vh.STOP)}resetContext(){this.sendPlaybackControl(Vh.RESET_CONTEXT)}close(){this.conn.close()}};function V9(s){let e={};return s.forEach((t,n)=>{e[n]=t}),e}function G9(s){let e=new Headers;for(let[t,n]of Object.entries(s))e.append(t,n);return e}var W9="FunctionResponse request must have an `id` field from the response of a ToolCall.FunctionalCalls in Google AI.";async function H9(s,e,t){let n=new uA,i;t.data instanceof Blob?i=await t.data.text():t.data instanceof ArrayBuffer?i=new TextDecoder().decode(t.data):i=t.data;let r=JSON.parse(i);if(s.isVertexAI()){let o=vJ(r);Object.assign(n,o)}else Object.assign(n,r);e(n)}var AA=class{constructor(e,t,n){this.apiClient=e,this.auth=t,this.webSocketFactory=n,this.music=new SA(this.apiClient,this.auth,this.webSocketFactory)}async connect(e){var t,n,i,r,o,a;if(e.config&&e.config.httpOptions)throw new Error("The Live module does not support httpOptions at request-level in LiveConnectConfig yet. Please use the client-level httpOptions configuration instead.");let l=this.apiClient.getWebsocketBaseUrl(),c=this.apiClient.getApiVersion(),d,u=this.apiClient.getHeaders();e.config&&e.config.tools&&kU(e.config.tools)&&IU(u);let h=K9(u);if(this.apiClient.isVertexAI())d=`${l}/ws/google.cloud.aiplatform.${c}.LlmBidiService/BidiGenerateContent`,await this.auth.addAuthHeaders(h,d);else{let R=this.apiClient.getApiKey(),O="BidiGenerateContent",H="key";R?.startsWith("auth_tokens/")&&(console.warn("Warning: Ephemeral token support is experimental and may change in future versions."),c!=="v1alpha"&&console.warn("Warning: The SDK's ephemeral token support is in v1alpha only. Please use const ai = new GoogleGenAI({apiKey: token.name, httpOptions: { apiVersion: 'v1alpha' }}); before session connection."),O="BidiGenerateContentConstrained",H="access_token"),d=`${l}/ws/google.ai.generativelanguage.${c}.GenerativeService.${O}?${H}=${R}`}let p=()=>{},f=new Promise(R=>{p=R}),_=e.callbacks,b=function(){var R;(R=_?.onopen)===null||R===void 0||R.call(_),p({})},y=this.apiClient,w={onopen:b,onmessage:R=>{H9(y,_.onmessage,R)},onerror:(t=_?.onerror)!==null&&t!==void 0?t:function(R){},onclose:(n=_?.onclose)!==null&&n!==void 0?n:function(R){}},C=this.webSocketFactory.create(d,q9(h),w);C.connect(),await f;let M=xn(this.apiClient,e.model);if(this.apiClient.isVertexAI()&&M.startsWith("publishers/")){let R=this.apiClient.getProject(),O=this.apiClient.getLocation();M=`projects/${R}/locations/${O}/`+M}let S={};this.apiClient.isVertexAI()&&((i=e.config)===null||i===void 0?void 0:i.responseModalities)===void 0&&(e.config===void 0?e.config={responseModalities:[bw.AUDIO]}:e.config.responseModalities=[bw.AUDIO]),!((r=e.config)===null||r===void 0)&&r.generationConfig&&console.warn("Setting `LiveConnectConfig.generation_config` is deprecated, please set the fields on `LiveConnectConfig` directly. This will become an error in a future version (not before Q3 2025).");let k=(a=(o=e.config)===null||o===void 0?void 0:o.tools)!==null&&a!==void 0?a:[],T=[];for(let R of k)if(this.isCallableTool(R)){let O=R;T.push(await O.tool())}else T.push(R);T.length>0&&(e.config.tools=T);let P={model:M,config:e.config,callbacks:e.callbacks};return this.apiClient.isVertexAI()?S=fJ(this.apiClient,P):S=pJ(this.apiClient,P),delete S.config,C.send(JSON.stringify(S)),new PA(C,this.apiClient)}isCallableTool(e){return"callTool"in e&&typeof e.callTool=="function"}},j9={turnComplete:!0},PA=class{constructor(e,t){this.conn=e,this.apiClient=t}tLiveClientContent(e,t){if(t.turns!==null&&t.turns!==void 0){let n=[];try{n=Rr(t.turns),e.isVertexAI()||(n=n.map(i=>Qw(i)))}catch{throw new Error(`Failed to parse client content "turns", type: '${typeof t.turns}'`)}return{clientContent:{turns:n,turnComplete:t.turnComplete}}}return{clientContent:{turnComplete:t.turnComplete}}}tLiveClienttToolResponse(e,t){let n=[];if(t.functionResponses==null)throw new Error("functionResponses is required.");if(Array.isArray(t.functionResponses)?n=t.functionResponses:n=[t.functionResponses],n.length===0)throw new Error("functionResponses is required.");for(let r of n){if(typeof r!="object"||r===null||!("name"in r)||!("response"in r))throw new Error(`Could not parse function response, type '${typeof r}'.`);if(!e.isVertexAI()&&!("id"in r))throw new Error(W9)}return{toolResponse:{functionResponses:n}}}sendClientContent(e){e=Object.assign(Object.assign({},j9),e);let t=this.tLiveClientContent(this.apiClient,e);this.conn.send(JSON.stringify(t))}sendRealtimeInput(e){let t={};this.apiClient.isVertexAI()?t={realtimeInput:yJ(e)}:t={realtimeInput:_J(e)},this.conn.send(JSON.stringify(t))}sendToolResponse(e){if(e.functionResponses==null)throw new Error("Tool response parameters are required.");let t=this.tLiveClienttToolResponse(this.apiClient,e);this.conn.send(JSON.stringify(t))}close(){this.conn.close()}};function q9(s){let e={};return s.forEach((t,n)=>{e[n]=t}),e}function K9(s){let e=new Headers;for(let[t,n]of Object.entries(s))e.append(t,n);return e}var Yz=10;function Xz(s){var e,t,n;if(!((e=s?.automaticFunctionCalling)===null||e===void 0)&&e.disable)return!0;let i=!1;for(let o of(t=s?.tools)!==null&&t!==void 0?t:[])if(Wh(o)){i=!0;break}if(!i)return!0;let r=(n=s?.automaticFunctionCalling)===null||n===void 0?void 0:n.maximumRemoteCalls;return r&&(r<0||!Number.isInteger(r))||r==0?(console.warn("Invalid maximumRemoteCalls value provided for automatic function calling. Disabled automatic function calling. Please provide a valid integer value greater than 0. maximumRemoteCalls provided:",r),!0):!1}function Wh(s){return"callTool"in s&&typeof s.callTool=="function"}function Y9(s){var e,t,n;return(n=(t=(e=s.config)===null||e===void 0?void 0:e.tools)===null||t===void 0?void 0:t.some(i=>Wh(i)))!==null&&n!==void 0?n:!1}function Qz(s){var e;let t=[];return!((e=s?.config)===null||e===void 0)&&e.tools&&s.config.tools.forEach((n,i)=>{if(Wh(n))return;let r=n;r.functionDeclarations&&r.functionDeclarations.length>0&&t.push(i)}),t}function Jz(s){var e;return!(!((e=s?.automaticFunctionCalling)===null||e===void 0)&&e.ignoreCallHistory)}var kA=class extends oo{constructor(e){super(),this.apiClient=e,this.generateContent=async t=>{var n,i,r,o,a;let l=await this.processParamsMaybeAddMcpUsage(t);if(this.maybeMoveToResponseJsonSchem(t),!Y9(t)||Xz(t.config))return await this.generateContentInternal(l);let c=Qz(t);if(c.length>0){let _=c.map(b=>`tools[${b}]`).join(", ");throw new Error(`Automatic function calling with CallableTools (or MCP objects) and basic FunctionDeclarations is not yet supported. Incompatible tools found at ${_}.`)}let d,u,h=Rr(l.contents),p=(r=(i=(n=l.config)===null||n===void 0?void 0:n.automaticFunctionCalling)===null||i===void 0?void 0:i.maximumRemoteCalls)!==null&&r!==void 0?r:Yz,f=0;for(;f<p&&(d=await this.generateContentInternal(l),!(!d.functionCalls||d.functionCalls.length===0));){let _=d.candidates[0].content,b=[];for(let y of(a=(o=t.config)===null||o===void 0?void 0:o.tools)!==null&&a!==void 0?a:[])if(Wh(y)){let C=await y.callTool(d.functionCalls);b.push(...C)}f++,u={role:"user",parts:b},l.contents=Rr(l.contents),l.contents.push(_),l.contents.push(u),Jz(l.config)&&(h.push(_),h.push(u))}return Jz(l.config)&&(d.automaticFunctionCallingHistory=h),d},this.generateContentStream=async t=>{var n,i,r,o,a;if(this.maybeMoveToResponseJsonSchem(t),Xz(t.config)){let u=await this.processParamsMaybeAddMcpUsage(t);return await this.generateContentStreamInternal(u)}let l=Qz(t);if(l.length>0){let u=l.map(h=>`tools[${h}]`).join(", ");throw new Error(`Incompatible tools found at ${u}. Automatic function calling with CallableTools (or MCP objects) and basic FunctionDeclarations" is not yet supported.`)}let c=(r=(i=(n=t?.config)===null||n===void 0?void 0:n.toolConfig)===null||i===void 0?void 0:i.functionCallingConfig)===null||r===void 0?void 0:r.streamFunctionCallArguments,d=(a=(o=t?.config)===null||o===void 0?void 0:o.automaticFunctionCalling)===null||a===void 0?void 0:a.disable;if(c&&!d)throw new Error("Running in streaming mode with 'streamFunctionCallArguments' enabled, this feature is not compatible with automatic function calling (AFC). Please set 'config.automaticFunctionCalling.disable' to true to disable AFC or leave 'config.toolConfig.functionCallingConfig.streamFunctionCallArguments' to be undefined or set to false to disable streaming function call arguments feature.");return await this.processAfcStream(t)},this.generateImages=async t=>await this.generateImagesInternal(t).then(n=>{var i;let r,o=[];if(n?.generatedImages)for(let l of n.generatedImages)l&&l?.safetyAttributes&&((i=l?.safetyAttributes)===null||i===void 0?void 0:i.contentType)==="Positive Prompt"?r=l?.safetyAttributes:o.push(l);let a;return r?a={generatedImages:o,positivePromptSafetyAttributes:r,sdkHttpResponse:n.sdkHttpResponse}:a={generatedImages:o,sdkHttpResponse:n.sdkHttpResponse},a}),this.list=async t=>{var n;let o={config:Object.assign(Object.assign({},{queryBase:!0}),t?.config)};if(this.apiClient.isVertexAI()&&!o.config.queryBase){if(!((n=o.config)===null||n===void 0)&&n.filter)throw new Error("Filtering tuned models list for Vertex AI is not currently supported");o.config.filter="labels.tune-type:*"}return new za(Ba.PAGED_ITEM_MODELS,a=>this.listInternal(a),await this.listInternal(o),o)},this.editImage=async t=>{let n={model:t.model,prompt:t.prompt,referenceImages:[],config:t.config};return t.referenceImages&&t.referenceImages&&(n.referenceImages=t.referenceImages.map(i=>i.toReferenceImageAPI())),await this.editImageInternal(n)},this.upscaleImage=async t=>{let n={numberOfImages:1,mode:"upscale"};t.config&&(n=Object.assign(Object.assign({},n),t.config));let i={model:t.model,image:t.image,upscaleFactor:t.upscaleFactor,config:n};return await this.upscaleImageInternal(i)},this.generateVideos=async t=>{var n,i,r,o,a,l;if((t.prompt||t.image||t.video)&&t.source)throw new Error("Source and prompt/image/video are mutually exclusive. Please only use source.");return this.apiClient.isVertexAI()||(!((n=t.video)===null||n===void 0)&&n.uri&&(!((i=t.video)===null||i===void 0)&&i.videoBytes)?t.video={uri:t.video.uri,mimeType:t.video.mimeType}:!((o=(r=t.source)===null||r===void 0?void 0:r.video)===null||o===void 0)&&o.uri&&(!((l=(a=t.source)===null||a===void 0?void 0:a.video)===null||l===void 0)&&l.videoBytes)&&(t.source.video={uri:t.source.video.uri,mimeType:t.source.video.mimeType})),await this.generateVideosInternal(t)}}maybeMoveToResponseJsonSchem(e){e.config&&e.config.responseSchema&&(e.config.responseJsonSchema||Object.keys(e.config.responseSchema).includes("$schema")&&(e.config.responseJsonSchema=e.config.responseSchema,delete e.config.responseSchema))}async processParamsMaybeAddMcpUsage(e){var t,n,i;let r=(t=e.config)===null||t===void 0?void 0:t.tools;if(!r)return e;let o=await Promise.all(r.map(async l=>Wh(l)?await l.tool():l)),a={model:e.model,contents:e.contents,config:Object.assign(Object.assign({},e.config),{tools:o})};if(a.config.tools=o,e.config&&e.config.tools&&kU(e.config.tools)){let l=(i=(n=e.config.httpOptions)===null||n===void 0?void 0:n.headers)!==null&&i!==void 0?i:{},c=Object.assign({},l);Object.keys(c).length===0&&(c=this.apiClient.getDefaultHeaders()),IU(c),a.config.httpOptions=Object.assign(Object.assign({},e.config.httpOptions),{headers:c})}return a}async initAfcToolsMap(e){var t,n,i;let r=new Map;for(let o of(n=(t=e.config)===null||t===void 0?void 0:t.tools)!==null&&n!==void 0?n:[])if(Wh(o)){let a=o,l=await a.tool();for(let c of(i=l.functionDeclarations)!==null&&i!==void 0?i:[]){if(!c.name)throw new Error("Function declaration name is required.");if(r.has(c.name))throw new Error(`Duplicate tool declaration name: ${c.name}`);r.set(c.name,a)}}return r}async processAfcStream(e){var t,n,i;let r=(i=(n=(t=e.config)===null||t===void 0?void 0:t.automaticFunctionCalling)===null||n===void 0?void 0:n.maximumRemoteCalls)!==null&&i!==void 0?i:Yz,o=!1,a=0,l=await this.initAfcToolsMap(e);return function(c,d,u){return io(this,arguments,function*(){for(var h,p,f,_,b,y;a<r;){o&&(a++,o=!1);let S=yield Yt(c.processParamsMaybeAddMcpUsage(u)),k=yield Yt(c.generateContentStreamInternal(S)),T=[],P=[];try{for(var w=!0,C=(p=void 0,ro(k)),M;M=yield Yt(C.next()),h=M.done,!h;w=!0){_=M.value,w=!1;let R=_;if(yield yield Yt(R),R.candidates&&(!((b=R.candidates[0])===null||b===void 0)&&b.content)){P.push(R.candidates[0].content);for(let O of(y=R.candidates[0].content.parts)!==null&&y!==void 0?y:[])if(a<r&&O.functionCall){if(!O.functionCall.name)throw new Error("Function call name was not returned by the model.");if(d.has(O.functionCall.name)){let H=yield Yt(d.get(O.functionCall.name).callTool([O.functionCall]));T.push(...H)}else throw new Error(`Automatic function calling was requested, but not all the tools the model used implement the CallableTool interface. Available tools: ${d.keys()}, mising tool: ${O.functionCall.name}`)}}}}catch(R){p={error:R}}finally{try{!w&&!h&&(f=C.return)&&(yield Yt(f.call(C)))}finally{if(p)throw p.error}}if(T.length>0){o=!0;let R=new pd;R.candidates=[{content:{role:"user",parts:T}}],yield yield Yt(R);let O=[];O.push(...P),O.push({role:"user",parts:T});let H=Rr(u.contents).concat(O);u.contents=H}else break}})}(this,l,e)}async generateContentInternal(e){var t,n,i,r;let o,a="",l={};if(this.apiClient.isVertexAI()){let c=Hz(this.apiClient,e);return a=mt("{model}:generateContent",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>{let u=qz(d),h=new pd;return Object.assign(h,u),h})}else{let c=Wz(this.apiClient,e);return a=mt("{model}:generateContent",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>{let u=jz(d),h=new pd;return Object.assign(h,u),h})}}async generateContentStreamInternal(e){var t,n,i,r;let o,a="",l={};if(this.apiClient.isVertexAI()){let c=Hz(this.apiClient,e);return a=mt("{model}:streamGenerateContent?alt=sse",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.requestStream({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}),o.then(function(u){return io(this,arguments,function*(){var h,p,f,_;try{for(var b=!0,y=ro(u),w;w=yield Yt(y.next()),h=w.done,!h;b=!0){_=w.value,b=!1;let C=_,M=qz(yield Yt(C.json()));M.sdkHttpResponse={headers:C.headers};let S=new pd;Object.assign(S,M),yield yield Yt(S)}}catch(C){p={error:C}}finally{try{!b&&!h&&(f=y.return)&&(yield Yt(f.call(y)))}finally{if(p)throw p.error}}})})}else{let c=Wz(this.apiClient,e);return a=mt("{model}:streamGenerateContent?alt=sse",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.requestStream({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}),o.then(function(u){return io(this,arguments,function*(){var h,p,f,_;try{for(var b=!0,y=ro(u),w;w=yield Yt(y.next()),h=w.done,!h;b=!0){_=w.value,b=!1;let C=_,M=jz(yield Yt(C.json()));M.sdkHttpResponse={headers:C.headers};let S=new pd;Object.assign(S,M),yield yield Yt(S)}}catch(C){p={error:C}}finally{try{!b&&!h&&(f=y.return)&&(yield Yt(f.call(y)))}finally{if(p)throw p.error}}})})}}async embedContent(e){var t,n,i,r;let o,a="",l={};if(this.apiClient.isVertexAI()){let c=YJ(this.apiClient,e);return a=mt("{model}:predict",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>{let u=QJ(d),h=new ww;return Object.assign(h,u),h})}else{let c=KJ(this.apiClient,e);return a=mt("{model}:batchEmbedContents",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>{let u=XJ(d),h=new ww;return Object.assign(h,u),h})}}async generateImagesInternal(e){var t,n,i,r;let o,a="",l={};if(this.apiClient.isVertexAI()){let c=lZ(this.apiClient,e);return a=mt("{model}:predict",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>{let u=dZ(d),h=new Mw;return Object.assign(h,u),h})}else{let c=aZ(this.apiClient,e);return a=mt("{model}:predict",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>{let u=cZ(d),h=new Mw;return Object.assign(h,u),h})}}async editImageInternal(e){var t,n;let i,r="",o={};if(this.apiClient.isVertexAI()){let a=WJ(this.apiClient,e);return r=mt("{model}:predict",a._url),o=a._query,delete a._url,delete a._query,i=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(l=>l.json().then(c=>{let d=c;return d.sdkHttpResponse={headers:l.headers},d})),i.then(l=>{let c=HJ(l),d=new ZC;return Object.assign(d,c),d})}else throw new Error("This method is only supported by the Vertex AI.")}async upscaleImageInternal(e){var t,n;let i,r="",o={};if(this.apiClient.isVertexAI()){let a=l9(this.apiClient,e);return r=mt("{model}:predict",a._url),o=a._query,delete a._url,delete a._query,i=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(l=>l.json().then(c=>{let d=c;return d.sdkHttpResponse={headers:l.headers},d})),i.then(l=>{let c=c9(l),d=new eA;return Object.assign(d,c),d})}else throw new Error("This method is only supported by the Vertex AI.")}async recontextImage(e){var t,n;let i,r="",o={};if(this.apiClient.isVertexAI()){let a=GZ(this.apiClient,e);return r=mt("{model}:predict",a._url),o=a._query,delete a._url,delete a._query,i=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(l=>l.json()),i.then(l=>{let c=WZ(l),d=new tA;return Object.assign(d,c),d})}else throw new Error("This method is only supported by the Vertex AI.")}async segmentImage(e){var t,n;let i,r="",o={};if(this.apiClient.isVertexAI()){let a=XZ(this.apiClient,e);return r=mt("{model}:predict",a._url),o=a._query,delete a._url,delete a._query,i=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(l=>l.json()),i.then(l=>{let c=QZ(l),d=new nA;return Object.assign(d,c),d})}else throw new Error("This method is only supported by the Vertex AI.")}async get(e){var t,n,i,r;let o,a="",l={};if(this.apiClient.isVertexAI()){let c=CZ(this.apiClient,e);return a=mt("{name}",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(d=>d.json()),o.then(d=>MA(d))}else{let c=SZ(this.apiClient,e);return a=mt("{name}",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json()),o.then(d=>wA(d))}}async listInternal(e){var t,n,i,r;let o,a="",l={};if(this.apiClient.isVertexAI()){let c=NZ(this.apiClient,e);return a=mt("{models_url}",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>{let u=$Z(d),h=new Tw;return Object.assign(h,u),h})}else{let c=LZ(this.apiClient,e);return a=mt("{models_url}",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>{let u=OZ(d),h=new Tw;return Object.assign(h,u),h})}}async update(e){var t,n,i,r;let o,a="",l={};if(this.apiClient.isVertexAI()){let c=o9(this.apiClient,e);return a=mt("{model}",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"PATCH",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(d=>d.json()),o.then(d=>MA(d))}else{let c=r9(this.apiClient,e);return a=mt("{name}",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"PATCH",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json()),o.then(d=>wA(d))}}async delete(e){var t,n,i,r;let o,a="",l={};if(this.apiClient.isVertexAI()){let c=zJ(this.apiClient,e);return a=mt("{name}",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"DELETE",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>{let u=VJ(d),h=new Ew;return Object.assign(h,u),h})}else{let c=BJ(this.apiClient,e);return a=mt("{name}",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"DELETE",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>{let u=UJ(d),h=new Ew;return Object.assign(h,u),h})}}async countTokens(e){var t,n,i,r;let o,a="",l={};if(this.apiClient.isVertexAI()){let c=NJ(this.apiClient,e);return a=mt("{model}:countTokens",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>{let u=$J(d),h=new xw;return Object.assign(h,u),h})}else{let c=LJ(this.apiClient,e);return a=mt("{model}:countTokens",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>{let u=OJ(d),h=new xw;return Object.assign(h,u),h})}}async computeTokens(e){var t,n;let i,r="",o={};if(this.apiClient.isVertexAI()){let a=AJ(this.apiClient,e);return r=mt("{model}:computeTokens",a._url),o=a._query,delete a._url,delete a._query,i=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(l=>l.json().then(c=>{let d=c;return d.sdkHttpResponse={headers:l.headers},d})),i.then(l=>{let c=PJ(l),d=new sA;return Object.assign(d,c),d})}else throw new Error("This method is only supported by the Vertex AI.")}async generateVideosInternal(e){var t,n,i,r;let o,a="",l={};if(this.apiClient.isVertexAI()){let c=gZ(this.apiClient,e);return a=mt("{model}:predictLongRunning",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(d=>d.json()),o.then(d=>{let u=fZ(d),h=new Sw;return Object.assign(h,u),h})}else{let c=mZ(this.apiClient,e);return a=mt("{model}:predictLongRunning",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json()),o.then(d=>{let u=pZ(d),h=new Sw;return Object.assign(h,u),h})}}};var IA=class extends oo{constructor(e){super(),this.apiClient=e}async getVideosOperation(e){let t=e.operation,n=e.config;if(t.name===void 0||t.name==="")throw new Error("Operation name is required.");if(this.apiClient.isVertexAI()){let i=t.name.split("/operations/")[0],r;n&&"httpOptions"in n&&(r=n.httpOptions);let o=await this.fetchPredictVideosOperationInternal({operationName:t.name,resourceName:i,config:{httpOptions:r}});return t._fromAPIResponse({apiResponse:o,_isVertexAI:!0})}else{let i=await this.getVideosOperationInternal({operationName:t.name,config:n});return t._fromAPIResponse({apiResponse:i,_isVertexAI:!1})}}async get(e){let t=e.operation,n=e.config;if(t.name===void 0||t.name==="")throw new Error("Operation name is required.");if(this.apiClient.isVertexAI()){let i=t.name.split("/operations/")[0],r;n&&"httpOptions"in n&&(r=n.httpOptions);let o=await this.fetchPredictVideosOperationInternal({operationName:t.name,resourceName:i,config:{httpOptions:r}});return t._fromAPIResponse({apiResponse:o,_isVertexAI:!0})}else{let i=await this.getVideosOperationInternal({operationName:t.name,config:n});return t._fromAPIResponse({apiResponse:i,_isVertexAI:!1})}}async getVideosOperationInternal(e){var t,n,i,r;let o,a="",l={};if(this.apiClient.isVertexAI()){let c=uX(e);return a=mt("{operationName}",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(d=>d.json()),o}else{let c=dX(e);return a=mt("{operationName}",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json()),o}}async fetchPredictVideosOperationInternal(e){var t,n;let i,r="",o={};if(this.apiClient.isVertexAI()){let a=sX(e);return r=mt("{resourceName}:fetchPredictOperation",a._url),o=a._query,delete a._url,delete a._query,i=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(l=>l.json()),i}else throw new Error("This method is only supported by the Vertex AI.")}};function X9(s){let e={},t=g(s,["data"]);if(t!=null&&v(e,["data"],t),g(s,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");let n=g(s,["mimeType"]);return n!=null&&v(e,["mimeType"],n),e}function Q9(s){let e={},t=g(s,["parts"]);if(t!=null){let i=t;Array.isArray(i)&&(i=i.map(r=>o7(r))),v(e,["parts"],i)}let n=g(s,["role"]);return n!=null&&v(e,["role"],n),e}function J9(s,e,t){let n={},i=g(e,["expireTime"]);t!==void 0&&i!=null&&v(t,["expireTime"],i);let r=g(e,["newSessionExpireTime"]);t!==void 0&&r!=null&&v(t,["newSessionExpireTime"],r);let o=g(e,["uses"]);t!==void 0&&o!=null&&v(t,["uses"],o);let a=g(e,["liveConnectConstraints"]);t!==void 0&&a!=null&&v(t,["bidiGenerateContentSetup"],r7(s,a));let l=g(e,["lockAdditionalFields"]);return t!==void 0&&l!=null&&v(t,["fieldMask"],l),n}function Z9(s,e){let t={},n=g(e,["config"]);return n!=null&&v(t,["config"],J9(s,n,t)),t}function e7(s){let e={};if(g(s,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");let t=g(s,["fileUri"]);t!=null&&v(e,["fileUri"],t);let n=g(s,["mimeType"]);return n!=null&&v(e,["mimeType"],n),e}function t7(s){let e={},t=g(s,["id"]);t!=null&&v(e,["id"],t);let n=g(s,["args"]);n!=null&&v(e,["args"],n);let i=g(s,["name"]);if(i!=null&&v(e,["name"],i),g(s,["partialArgs"])!==void 0)throw new Error("partialArgs parameter is not supported in Gemini API.");if(g(s,["willContinue"])!==void 0)throw new Error("willContinue parameter is not supported in Gemini API.");return e}function n7(s){let e={};if(g(s,["authConfig"])!==void 0)throw new Error("authConfig parameter is not supported in Gemini API.");let t=g(s,["enableWidget"]);return t!=null&&v(e,["enableWidget"],t),e}function s7(s){let e={};if(g(s,["excludeDomains"])!==void 0)throw new Error("excludeDomains parameter is not supported in Gemini API.");if(g(s,["blockingConfidence"])!==void 0)throw new Error("blockingConfidence parameter is not supported in Gemini API.");let t=g(s,["timeRangeFilter"]);return t!=null&&v(e,["timeRangeFilter"],t),e}function i7(s,e){let t={},n=g(s,["generationConfig"]);e!==void 0&&n!=null&&v(e,["setup","generationConfig"],n);let i=g(s,["responseModalities"]);e!==void 0&&i!=null&&v(e,["setup","generationConfig","responseModalities"],i);let r=g(s,["temperature"]);e!==void 0&&r!=null&&v(e,["setup","generationConfig","temperature"],r);let o=g(s,["topP"]);e!==void 0&&o!=null&&v(e,["setup","generationConfig","topP"],o);let a=g(s,["topK"]);e!==void 0&&a!=null&&v(e,["setup","generationConfig","topK"],a);let l=g(s,["maxOutputTokens"]);e!==void 0&&l!=null&&v(e,["setup","generationConfig","maxOutputTokens"],l);let c=g(s,["mediaResolution"]);e!==void 0&&c!=null&&v(e,["setup","generationConfig","mediaResolution"],c);let d=g(s,["seed"]);e!==void 0&&d!=null&&v(e,["setup","generationConfig","seed"],d);let u=g(s,["speechConfig"]);e!==void 0&&u!=null&&v(e,["setup","generationConfig","speechConfig"],ZA(u));let h=g(s,["thinkingConfig"]);e!==void 0&&h!=null&&v(e,["setup","generationConfig","thinkingConfig"],h);let p=g(s,["enableAffectiveDialog"]);e!==void 0&&p!=null&&v(e,["setup","generationConfig","enableAffectiveDialog"],p);let f=g(s,["systemInstruction"]);e!==void 0&&f!=null&&v(e,["setup","systemInstruction"],Q9(gi(f)));let _=g(s,["tools"]);if(e!==void 0&&_!=null){let k=Kh(_);Array.isArray(k)&&(k=k.map(T=>l7(qh(T)))),v(e,["setup","tools"],k)}let b=g(s,["sessionResumption"]);e!==void 0&&b!=null&&v(e,["setup","sessionResumption"],a7(b));let y=g(s,["inputAudioTranscription"]);e!==void 0&&y!=null&&v(e,["setup","inputAudioTranscription"],y);let w=g(s,["outputAudioTranscription"]);e!==void 0&&w!=null&&v(e,["setup","outputAudioTranscription"],w);let C=g(s,["realtimeInputConfig"]);e!==void 0&&C!=null&&v(e,["setup","realtimeInputConfig"],C);let M=g(s,["contextWindowCompression"]);e!==void 0&&M!=null&&v(e,["setup","contextWindowCompression"],M);let S=g(s,["proactivity"]);if(e!==void 0&&S!=null&&v(e,["setup","proactivity"],S),g(s,["explicitVadSignal"])!==void 0)throw new Error("explicitVadSignal parameter is not supported in Gemini API.");return t}function r7(s,e){let t={},n=g(e,["model"]);n!=null&&v(t,["setup","model"],xn(s,n));let i=g(e,["config"]);return i!=null&&v(t,["config"],i7(i,t)),t}function o7(s){let e={},t=g(s,["mediaResolution"]);t!=null&&v(e,["mediaResolution"],t);let n=g(s,["codeExecutionResult"]);n!=null&&v(e,["codeExecutionResult"],n);let i=g(s,["executableCode"]);i!=null&&v(e,["executableCode"],i);let r=g(s,["fileData"]);r!=null&&v(e,["fileData"],e7(r));let o=g(s,["functionCall"]);o!=null&&v(e,["functionCall"],t7(o));let a=g(s,["functionResponse"]);a!=null&&v(e,["functionResponse"],a);let l=g(s,["inlineData"]);l!=null&&v(e,["inlineData"],X9(l));let c=g(s,["text"]);c!=null&&v(e,["text"],c);let d=g(s,["thought"]);d!=null&&v(e,["thought"],d);let u=g(s,["thoughtSignature"]);u!=null&&v(e,["thoughtSignature"],u);let h=g(s,["videoMetadata"]);return h!=null&&v(e,["videoMetadata"],h),e}function a7(s){let e={},t=g(s,["handle"]);if(t!=null&&v(e,["handle"],t),g(s,["transparent"])!==void 0)throw new Error("transparent parameter is not supported in Gemini API.");return e}function l7(s){let e={},t=g(s,["functionDeclarations"]);if(t!=null){let d=t;Array.isArray(d)&&(d=d.map(u=>u)),v(e,["functionDeclarations"],d)}if(g(s,["retrieval"])!==void 0)throw new Error("retrieval parameter is not supported in Gemini API.");let n=g(s,["googleSearchRetrieval"]);n!=null&&v(e,["googleSearchRetrieval"],n);let i=g(s,["computerUse"]);i!=null&&v(e,["computerUse"],i);let r=g(s,["fileSearch"]);r!=null&&v(e,["fileSearch"],r);let o=g(s,["codeExecution"]);if(o!=null&&v(e,["codeExecution"],o),g(s,["enterpriseWebSearch"])!==void 0)throw new Error("enterpriseWebSearch parameter is not supported in Gemini API.");let a=g(s,["googleMaps"]);a!=null&&v(e,["googleMaps"],n7(a));let l=g(s,["googleSearch"]);l!=null&&v(e,["googleSearch"],s7(l));let c=g(s,["urlContext"]);return c!=null&&v(e,["urlContext"],c),e}function c7(s){let e=[];for(let t in s)if(Object.prototype.hasOwnProperty.call(s,t)){let n=s[t];if(typeof n=="object"&&n!=null&&Object.keys(n).length>0){let i=Object.keys(n).map(r=>`${t}.${r}`);e.push(...i)}else e.push(t)}return e.join(",")}function d7(s,e){let t=null,n=s.bidiGenerateContentSetup;if(typeof n=="object"&&n!==null&&"setup"in n){let r=n.setup;typeof r=="object"&&r!==null?(s.bidiGenerateContentSetup=r,t=r):delete s.bidiGenerateContentSetup}else n!==void 0&&delete s.bidiGenerateContentSetup;let i=s.fieldMask;if(t){let r=c7(t);if(Array.isArray(e?.lockAdditionalFields)&&e?.lockAdditionalFields.length===0)r?s.fieldMask=r:delete s.fieldMask;else if(e?.lockAdditionalFields&&e.lockAdditionalFields.length>0&&i!==null&&Array.isArray(i)&&i.length>0){let o=["temperature","topK","topP","maxOutputTokens","responseModalities","seed","speechConfig"],a=[];i.length>0&&(a=i.map(c=>o.includes(c)?`generationConfig.${c}`:c));let l=[];r&&l.push(r),a.length>0&&l.push(...a),l.length>0?s.fieldMask=l.join(","):delete s.fieldMask}else delete s.fieldMask}else i!==null&&Array.isArray(i)&&i.length>0?s.fieldMask=i.join(","):delete s.fieldMask;return s}var DA=class extends oo{constructor(e){super(),this.apiClient=e}async create(e){var t,n;let i,r="",o={};if(this.apiClient.isVertexAI())throw new Error("The client.tokens.create method is only supported by the Gemini Developer API.");{let a=Z9(this.apiClient,e);r=mt("auth_tokens",a._url),o=a._query,delete a.config,delete a._url,delete a._query;let l=d7(a,e.config);return i=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(l),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(c=>c.json()),i.then(c=>c)}}};function u7(s,e){let t={},n=g(s,["force"]);return e!==void 0&&n!=null&&v(e,["_query","force"],n),t}function h7(s){let e={},t=g(s,["name"]);t!=null&&v(e,["_url","name"],t);let n=g(s,["config"]);return n!=null&&u7(n,e),e}function p7(s){let e={},t=g(s,["name"]);return t!=null&&v(e,["_url","name"],t),e}function f7(s,e){let t={},n=g(s,["pageSize"]);e!==void 0&&n!=null&&v(e,["_query","pageSize"],n);let i=g(s,["pageToken"]);return e!==void 0&&i!=null&&v(e,["_query","pageToken"],i),t}function m7(s){let e={},t=g(s,["parent"]);t!=null&&v(e,["_url","parent"],t);let n=g(s,["config"]);return n!=null&&f7(n,e),e}function g7(s){let e={},t=g(s,["sdkHttpResponse"]);t!=null&&v(e,["sdkHttpResponse"],t);let n=g(s,["nextPageToken"]);n!=null&&v(e,["nextPageToken"],n);let i=g(s,["documents"]);if(i!=null){let r=i;Array.isArray(r)&&(r=r.map(o=>o)),v(e,["documents"],r)}return e}var RA=class extends oo{constructor(e){super(),this.apiClient=e,this.list=async t=>new za(Ba.PAGED_ITEM_DOCUMENTS,n=>this.listInternal({parent:t.parent,config:n.config}),await this.listInternal(t),t)}async get(e){var t,n;let i,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{let a=p7(e);return r=mt("{name}",a._url),o=a._query,delete a._url,delete a._query,i=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(l=>l.json()),i.then(l=>l)}}async delete(e){var t,n;let i="",r={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{let o=h7(e);i=mt("{name}",o._url),r=o._query,delete o._url,delete o._query,await this.apiClient.request({path:i,queryParams:r,body:JSON.stringify(o),httpMethod:"DELETE",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal})}}async listInternal(e){var t,n;let i,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{let a=m7(e);return r=mt("{parent}/documents",a._url),o=a._query,delete a._url,delete a._query,i=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(l=>l.json()),i.then(l=>{let c=g7(l),d=new iA;return Object.assign(d,c),d})}}};var FA=class extends oo{constructor(e,t=new RA(e)){super(),this.apiClient=e,this.documents=t,this.list=async(n={})=>new za(Ba.PAGED_ITEM_FILE_SEARCH_STORES,i=>this.listInternal(i),await this.listInternal(n),n)}async uploadToFileSearchStore(e){if(this.apiClient.isVertexAI())throw new Error("Vertex AI does not support uploading files to a file search store.");return this.apiClient.uploadFileToFileSearchStore(e.fileSearchStoreName,e.file,e.config)}async create(e){var t,n;let i,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{let a=g9(e);return r=mt("fileSearchStores",a._url),o=a._query,delete a._url,delete a._query,i=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(l=>l.json()),i.then(l=>l)}}async get(e){var t,n;let i,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{let a=v9(e);return r=mt("{name}",a._url),o=a._query,delete a._url,delete a._query,i=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(l=>l.json()),i.then(l=>l)}}async delete(e){var t,n;let i="",r={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{let o=y9(e);i=mt("{name}",o._url),r=o._query,delete o._url,delete o._query,await this.apiClient.request({path:i,queryParams:r,body:JSON.stringify(o),httpMethod:"DELETE",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal})}}async listInternal(e){var t,n;let i,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{let a=x9(e);return r=mt("fileSearchStores",a._url),o=a._query,delete a._url,delete a._query,i=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(l=>l.json()),i.then(l=>{let c=S9(l),d=new rA;return Object.assign(d,c),d})}}async uploadToFileSearchStoreInternal(e){var t,n;let i,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{let a=C9(e);return r=mt("upload/v1beta/{file_search_store_name}:uploadToFileSearchStore",a._url),o=a._query,delete a._url,delete a._query,i=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(l=>l.json()),i.then(l=>{let c=A9(l),d=new oA;return Object.assign(d,c),d})}}async importFile(e){var t,n;let i,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{let a=M9(e);return r=mt("{file_search_store_name}:importFile",a._url),o=a._query,delete a._url,delete a._query,i=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(l=>l.json()),i.then(l=>{let c=w9(l),d=new aA;return Object.assign(d,c),d})}}};var DU=function(){let{crypto:s}=globalThis;if(s?.randomUUID)return DU=s.randomUUID.bind(s),s.randomUUID();let e=new Uint8Array(1),t=s?()=>s.getRandomValues(e)[0]:()=>Math.random()*255&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,n=>(+n^t()&15>>+n/4).toString(16))},_7=()=>DU();function LA(s){return typeof s=="object"&&s!==null&&("name"in s&&s.name==="AbortError"||"message"in s&&String(s.message).includes("FetchRequestCanceledException"))}var NA=s=>{if(s instanceof Error)return s;if(typeof s=="object"&&s!==null){try{if(Object.prototype.toString.call(s)==="[object Error]"){let e=new Error(s.message,s.cause?{cause:s.cause}:{});return s.stack&&(e.stack=s.stack),s.cause&&!e.cause&&(e.cause=s.cause),s.name&&(e.name=s.name),e}}catch{}try{return new Error(JSON.stringify(s))}catch{}}return new Error(s)};var Gi=class extends Error{},Wi=class s extends Gi{constructor(e,t,n,i){super(`${s.makeMessage(e,t,n)}`),this.status=e,this.headers=i,this.error=t}static makeMessage(e,t,n){let i=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&i?`${e} ${i}`:e?`${e} status code (no body)`:i||"(no status code or body)"}static generate(e,t,n,i){if(!e||!i)return new Hh({message:n,cause:NA(t)});let r=t;return e===400?new Nw(e,r,n,i):e===401?new Ow(e,r,n,i):e===403?new $w(e,r,n,i):e===404?new Bw(e,r,n,i):e===409?new zw(e,r,n,i):e===422?new Uw(e,r,n,i):e===429?new Vw(e,r,n,i):e>=500?new Gw(e,r,n,i):new s(e,r,n,i)}},jm=class extends Wi{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},Hh=class extends Wi{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},Lw=class extends Hh{constructor({message:e}={}){super({message:e??"Request timed out."})}},Nw=class extends Wi{},Ow=class extends Wi{},$w=class extends Wi{},Bw=class extends Wi{},zw=class extends Wi{},Uw=class extends Wi{},Vw=class extends Wi{},Gw=class extends Wi{};var y7=/^[a-z][a-z0-9+.-]*:/i,v7=s=>y7.test(s),OA=s=>(OA=Array.isArray,OA(s)),b7=OA,w7=b7,Zz=w7;function M7(s){if(!s)return!0;for(let e in s)return!1;return!0}function T7(s,e){return Object.prototype.hasOwnProperty.call(s,e)}var E7=(s,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new Gi(`${s} must be an integer`);if(e<0)throw new Gi(`${s} must be a positive integer`);return e},x7=s=>{try{return JSON.parse(s)}catch{return}};var S7=s=>new Promise(e=>setTimeout(e,s));var Uh="0.0.1";function C7(){return typeof Deno<"u"&&Deno.build!=null?"deno":typeof EdgeRuntime<"u"?"edge":Object.prototype.toString.call(typeof globalThis.process<"u"?globalThis.process:0)==="[object process]"?"node":"unknown"}var A7=()=>{var s,e,t,n,i;let r=C7();if(r==="deno")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Uh,"X-Stainless-OS":tU(Deno.build.os),"X-Stainless-Arch":eU(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:(e=(s=Deno.version)===null||s===void 0?void 0:s.deno)!==null&&e!==void 0?e:"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Uh,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if(r==="node")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Uh,"X-Stainless-OS":tU((t=globalThis.process.platform)!==null&&t!==void 0?t:"unknown"),"X-Stainless-Arch":eU((n=globalThis.process.arch)!==null&&n!==void 0?n:"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":(i=globalThis.process.version)!==null&&i!==void 0?i:"unknown"};let o=P7();return o?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Uh,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${o.browser}`,"X-Stainless-Runtime-Version":o.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Uh,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function P7(){if(typeof navigator>"u"||!navigator)return null;let s=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of s){let n=t.exec(navigator.userAgent);if(n){let i=n[1]||0,r=n[2]||0,o=n[3]||0;return{browser:e,version:`${i}.${r}.${o}`}}}return null}var eU=s=>s==="x32"?"x32":s==="x86_64"||s==="x64"?"x64":s==="arm"?"arm":s==="aarch64"||s==="arm64"?"arm64":s?`other:${s}`:"unknown",tU=s=>(s=s.toLowerCase(),s.includes("ios")?"iOS":s==="android"?"Android":s==="darwin"?"MacOS":s==="win32"?"Windows":s==="freebsd"?"FreeBSD":s==="openbsd"?"OpenBSD":s==="linux"?"Linux":s?`Other:${s}`:"Unknown"),pw,k7=()=>pw??(pw=A7());function I7(){if(typeof fetch<"u")return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new GeminiNextGenAPIClient({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}function RU(...s){let e=globalThis.ReadableStream;if(typeof e>"u")throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new e(...s)}function D7(s){let e=Symbol.asyncIterator in s?s[Symbol.asyncIterator]():s[Symbol.iterator]();return RU({start(){},async pull(t){let{done:n,value:i}=await e.next();n?t.close():t.enqueue(i)},async cancel(){var t;await((t=e.return)===null||t===void 0?void 0:t.call(e))}})}function FU(s){if(s[Symbol.asyncIterator])return s;let e=s.getReader();return{async next(){try{let t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function R7(s){var e,t;if(s===null||typeof s!="object")return;if(s[Symbol.asyncIterator]){await((t=(e=s[Symbol.asyncIterator]()).return)===null||t===void 0?void 0:t.call(e));return}let n=s.getReader(),i=n.cancel();n.releaseLock(),await i}var F7=({headers:s,body:e})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(e)});var LU=()=>{var s;if(typeof File>"u"){let{process:e}=globalThis,t=typeof((s=e?.versions)===null||s===void 0?void 0:s.node)=="string"&&parseInt(e.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(t?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function YC(s,e,t){return LU(),new File(s,e??"unknown_file",t)}function L7(s){return(typeof s=="object"&&s!==null&&("name"in s&&s.name&&String(s.name)||"url"in s&&s.url&&String(s.url)||"filename"in s&&s.filename&&String(s.filename)||"path"in s&&s.path&&String(s.path))||"").split(/[\\/]/).pop()||void 0}var N7=s=>s!=null&&typeof s=="object"&&typeof s[Symbol.asyncIterator]=="function";var NU=s=>s!=null&&typeof s=="object"&&typeof s.size=="number"&&typeof s.type=="string"&&typeof s.text=="function"&&typeof s.slice=="function"&&typeof s.arrayBuffer=="function",O7=s=>s!=null&&typeof s=="object"&&typeof s.name=="string"&&typeof s.lastModified=="number"&&NU(s),$7=s=>s!=null&&typeof s=="object"&&typeof s.url=="string"&&typeof s.blob=="function";async function B7(s,e,t){if(LU(),s=await s,O7(s))return s instanceof File?s:YC([await s.arrayBuffer()],s.name);if($7(s)){let i=await s.blob();return e||(e=new URL(s.url).pathname.split(/[\\/]/).pop()),YC(await $A(i),e,t)}let n=await $A(s);if(e||(e=L7(s)),!t?.type){let i=n.find(r=>typeof r=="object"&&"type"in r&&r.type);typeof i=="string"&&(t=Object.assign(Object.assign({},t),{type:i}))}return YC(n,e,t)}async function $A(s){var e,t,n,i,r;let o=[];if(typeof s=="string"||ArrayBuffer.isView(s)||s instanceof ArrayBuffer)o.push(s);else if(NU(s))o.push(s instanceof Blob?s:await s.arrayBuffer());else if(N7(s))try{for(var a=!0,l=ro(s),c;c=await l.next(),e=c.done,!e;a=!0){i=c.value,a=!1;let d=i;o.push(...await $A(d))}}catch(d){t={error:d}}finally{try{!a&&!e&&(n=l.return)&&await n.call(l)}finally{if(t)throw t.error}}else{let d=(r=s?.constructor)===null||r===void 0?void 0:r.name;throw new Error(`Unexpected data type: ${typeof s}${d?`; constructor: ${d}`:""}${z7(s)}`)}return o}function z7(s){return typeof s!="object"||s===null?"":`; props: [${Object.getOwnPropertyNames(s).map(t=>`"${t}"`).join(", ")}]`}var Ww=class{constructor(e){this._client=e}};Ww._key=[];function OU(s){return s.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}var nU=Object.freeze(Object.create(null)),U7=(s=OU)=>function(t,...n){if(t.length===1)return t[0];let i=!1,r=[],o=t.reduce((d,u,h)=>{var p,f,_;/[?#]/.test(u)&&(i=!0);let b=n[h],y=(i?encodeURIComponent:s)(""+b);return h!==n.length&&(b==null||typeof b=="object"&&b.toString===((_=Object.getPrototypeOf((f=Object.getPrototypeOf((p=b.hasOwnProperty)!==null&&p!==void 0?p:nU))!==null&&f!==void 0?f:nU))===null||_===void 0?void 0:_.toString))&&(y=b+"",r.push({start:d.length+u.length,length:y.length,error:`Value of type ${Object.prototype.toString.call(b).slice(8,-1)} is not a valid path parameter`})),d+u+(h===n.length?"":y)},""),a=o.split(/[?#]/,1)[0],l=/(?<=^|\/)(?:\.|%2e){1,2}(?=\/|$)/gi,c;for(;(c=l.exec(a))!==null;)r.push({start:c.index,length:c[0].length,error:`Value "${c[0]}" can't be safely passed as a path parameter`});if(r.sort((d,u)=>d.start-u.start),r.length>0){let d=0,u=r.reduce((h,p)=>{let f=" ".repeat(p.start-d),_="^".repeat(p.length);return d=p.start+p.length,h+f+_},"");throw new Gi(`Path parameters result in path with invalid segments:
${r.map(h=>h.error).join(`
`)}
${o}
${u}`)}return o},fw=U7(OU);var Hw=class extends Ww{create(e,t){var n;let{api_version:i=this._client.apiVersion}=e,r=Rw(e,["api_version"]);if("model"in r&&"agent_config"in r)throw new Gi("Invalid request: specified `model` and `agent_config`. If specifying `model`, use `generation_config`.");if("agent"in r&&"generation_config"in r)throw new Gi("Invalid request: specified `agent` and `generation_config`. If specifying `agent`, use `agent_config`.");return this._client.post(fw`/${i}/interactions`,Object.assign(Object.assign({body:r},t),{stream:(n=e.stream)!==null&&n!==void 0?n:!1}))}delete(e,t={},n){let{api_version:i=this._client.apiVersion}=t??{};return this._client.delete(fw`/${i}/interactions/${e}`,n)}cancel(e,t={},n){let{api_version:i=this._client.apiVersion}=t??{};return this._client.post(fw`/${i}/interactions/${e}/cancel`,n)}get(e,t={},n){var i;let r=t??{},{api_version:o=this._client.apiVersion}=r,a=Rw(r,["api_version"]);return this._client.get(fw`/${o}/interactions/${e}`,Object.assign(Object.assign({query:a},n),{stream:(i=t?.stream)!==null&&i!==void 0?i:!1}))}};Hw._key=Object.freeze(["interactions"]);var jw=class extends Hw{};function V7(s){let e=0;for(let i of s)e+=i.length;let t=new Uint8Array(e),n=0;for(let i of s)t.set(i,n),n+=i.length;return t}var mw;function eP(s){let e;return(mw??(e=new globalThis.TextEncoder,mw=e.encode.bind(e)))(s)}var gw;function sU(s){let e;return(gw??(e=new globalThis.TextDecoder,gw=e.decode.bind(e)))(s)}var jh=class{constructor(){this.buffer=new Uint8Array,this.carriageReturnIndex=null}decode(e){if(e==null)return[];let t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?eP(e):e;this.buffer=V7([this.buffer,t]);let n=[],i;for(;(i=G7(this.buffer,this.carriageReturnIndex))!=null;){if(i.carriage&&this.carriageReturnIndex==null){this.carriageReturnIndex=i.index;continue}if(this.carriageReturnIndex!=null&&(i.index!==this.carriageReturnIndex+1||i.carriage)){n.push(sU(this.buffer.subarray(0,this.carriageReturnIndex-1))),this.buffer=this.buffer.subarray(this.carriageReturnIndex),this.carriageReturnIndex=null;continue}let r=this.carriageReturnIndex!==null?i.preceding-1:i.preceding,o=sU(this.buffer.subarray(0,r));n.push(o),this.buffer=this.buffer.subarray(i.index),this.carriageReturnIndex=null}return n}flush(){return this.buffer.length?this.decode(`
`):[]}};jh.NEWLINE_CHARS=new Set([`
`,"\r"]);jh.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function G7(s,e){for(let i=e??0;i<s.length;i++){if(s[i]===10)return{preceding:i,index:i+1,carriage:!1};if(s[i]===13)return{preceding:i,index:i+1,carriage:!0}}return null}function W7(s){for(let n=0;n<s.length-1;n++){if(s[n]===10&&s[n+1]===10||s[n]===13&&s[n+1]===13)return n+2;if(s[n]===13&&s[n+1]===10&&n+3<s.length&&s[n+2]===13&&s[n+3]===10)return n+4}return-1}var qw={off:0,error:200,warn:300,info:400,debug:500},iU=(s,e,t)=>{if(s){if(T7(qw,s))return s;Di(t).warn(`${e} was set to ${JSON.stringify(s)}, expected one of ${JSON.stringify(Object.keys(qw))}`)}};function Wm(){}function _w(s,e,t){return!e||qw[s]>qw[t]?Wm:e[s].bind(e)}var H7={error:Wm,warn:Wm,info:Wm,debug:Wm},rU=new WeakMap;function Di(s){var e;let t=s.logger,n=(e=s.logLevel)!==null&&e!==void 0?e:"off";if(!t)return H7;let i=rU.get(t);if(i&&i[0]===n)return i[1];let r={error:_w("error",t,n),warn:_w("warn",t,n),info:_w("info",t,n),debug:_w("debug",t,n)};return rU.set(t,[n,r]),r}var hd=s=>(s.options&&(s.options=Object.assign({},s.options),delete s.options.headers),s.headers&&(s.headers=Object.fromEntries((s.headers instanceof Headers?[...s.headers]:Object.entries(s.headers)).map(([e,t])=>[e,e.toLowerCase()==="x-goog-api-key"||e.toLowerCase()==="authorization"||e.toLowerCase()==="cookie"||e.toLowerCase()==="set-cookie"?"***":t]))),"retryOfRequestLogID"in s&&(s.retryOfRequestLogID&&(s.retryOf=s.retryOfRequestLogID),delete s.retryOfRequestLogID),s);var BA=class s{constructor(e,t,n){this.iterator=e,this.controller=t,this.client=n}static fromSSEResponse(e,t,n){let i=!1,r=n?Di(n):console;function o(){return io(this,arguments,function*(){var l,c,d,u;if(i)throw new Gi("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");i=!0;let h=!1;try{try{for(var p=!0,f=ro(j7(e,t)),_;_=yield Yt(f.next()),l=_.done,!l;p=!0){u=_.value,p=!1;let b=u;if(!h)if(b.data.startsWith("[DONE]")){h=!0;continue}else try{yield yield Yt(JSON.parse(b.data))}catch(y){throw r.error("Could not parse message into JSON:",b.data),r.error("From chunk:",b.raw),y}}}catch(b){c={error:b}}finally{try{!p&&!l&&(d=f.return)&&(yield Yt(d.call(f)))}finally{if(c)throw c.error}}h=!0}catch(b){if(LA(b))return yield Yt(void 0);throw b}finally{h||t.abort()}})}return new s(o,t,n)}static fromReadableStream(e,t,n){let i=!1;function r(){return io(this,arguments,function*(){var l,c,d,u;let h=new jh,p=FU(e);try{for(var f=!0,_=ro(p),b;b=yield Yt(_.next()),l=b.done,!l;f=!0){u=b.value,f=!1;let y=u;for(let w of h.decode(y))yield yield Yt(w)}}catch(y){c={error:y}}finally{try{!f&&!l&&(d=_.return)&&(yield Yt(d.call(_)))}finally{if(c)throw c.error}}for(let y of h.flush())yield yield Yt(y)})}function o(){return io(this,arguments,function*(){var l,c,d,u;if(i)throw new Gi("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");i=!0;let h=!1;try{try{for(var p=!0,f=ro(r()),_;_=yield Yt(f.next()),l=_.done,!l;p=!0){u=_.value,p=!1;let b=u;h||b&&(yield yield Yt(JSON.parse(b)))}}catch(b){c={error:b}}finally{try{!p&&!l&&(d=f.return)&&(yield Yt(d.call(f)))}finally{if(c)throw c.error}}h=!0}catch(b){if(LA(b))return yield Yt(void 0);throw b}finally{h||t.abort()}})}return new s(o,t,n)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],t=[],n=this.iterator(),i=r=>({next:()=>{if(r.length===0){let o=n.next();e.push(o),t.push(o)}return r.shift()}});return[new s(()=>i(e),this.controller,this.client),new s(()=>i(t),this.controller,this.client)]}toReadableStream(){let e=this,t;return RU({async start(){t=e[Symbol.asyncIterator]()},async pull(n){try{let{value:i,done:r}=await t.next();if(r)return n.close();let o=eP(JSON.stringify(i)+`
`);n.enqueue(o)}catch(i){n.error(i)}},async cancel(){var n;await((n=t.return)===null||n===void 0?void 0:n.call(t))}})}};function j7(s,e){return io(this,arguments,function*(){var n,i,r,o;if(!s.body)throw e.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new Gi("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new Gi("Attempted to iterate over a response with no body");let a=new zA,l=new jh,c=FU(s.body);try{for(var d=!0,u=ro(q7(c)),h;h=yield Yt(u.next()),n=h.done,!n;d=!0){o=h.value,d=!1;let p=o;for(let f of l.decode(p)){let _=a.decode(f);_&&(yield yield Yt(_))}}}catch(p){i={error:p}}finally{try{!d&&!n&&(r=u.return)&&(yield Yt(r.call(u)))}finally{if(i)throw i.error}}for(let p of l.flush()){let f=a.decode(p);f&&(yield yield Yt(f))}})}function q7(s){return io(this,arguments,function*(){var t,n,i,r;let o=new Uint8Array;try{for(var a=!0,l=ro(s),c;c=yield Yt(l.next()),t=c.done,!t;a=!0){r=c.value,a=!1;let d=r;if(d==null)continue;let u=d instanceof ArrayBuffer?new Uint8Array(d):typeof d=="string"?eP(d):d,h=new Uint8Array(o.length+u.length);h.set(o),h.set(u,o.length),o=h;let p;for(;(p=W7(o))!==-1;)yield yield Yt(o.slice(0,p)),o=o.slice(p)}}catch(d){n={error:d}}finally{try{!a&&!t&&(i=l.return)&&(yield Yt(i.call(l)))}finally{if(n)throw n.error}}o.length>0&&(yield yield Yt(o))})}var zA=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let r={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],r}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,i]=K7(e,":");return i.startsWith(" ")&&(i=i.substring(1)),t==="event"?this.event=i:t==="data"&&this.data.push(i),null}};function K7(s,e){let t=s.indexOf(e);return t!==-1?[s.substring(0,t),e,s.substring(t+e.length)]:[s,"",""]}async function Y7(s,e){let{response:t,requestLogID:n,retryOfRequestLogID:i,startTime:r}=e,o=await(async()=>{var a;if(e.options.stream)return Di(s).debug("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller,s):BA.fromSSEResponse(t,e.controller,s);if(t.status===204)return null;if(e.options.__binaryResponse)return t;let l=t.headers.get("content-type"),c=(a=l?.split(";")[0])===null||a===void 0?void 0:a.trim();return c?.includes("application/json")||c?.endsWith("+json")?await t.json():await t.text()})();return Di(s).debug(`[${n}] response parsed`,hd({retryOfRequestLogID:i,url:t.url,status:t.status,body:o,durationMs:Date.now()-r})),o}var UA=class s extends Promise{constructor(e,t,n=Y7){super(i=>{i(null)}),this.responsePromise=t,this.parseResponse=n,this.client=e}_thenUnwrap(e){return new s(this.client,this.responsePromise,async(t,n)=>e(await this.parseResponse(t,n),n))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(this.client,e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}};var $U=Symbol("brand.privateNullableHeaders");function*X7(s){if(!s)return;if($U in s){let{values:n,nulls:i}=s;yield*n.entries();for(let r of i)yield[r,null];return}let e=!1,t;s instanceof Headers?t=s.entries():Zz(s)?t=s:(e=!0,t=Object.entries(s??{}));for(let n of t){let i=n[0];if(typeof i!="string")throw new TypeError("expected header name to be a string");let r=Zz(n[1])?n[1]:[n[1]],o=!1;for(let a of r)a!==void 0&&(e&&!o&&(o=!0,yield[i,null]),yield[i,a])}}var Gm=s=>{let e=new Headers,t=new Set;for(let n of s){let i=new Set;for(let[r,o]of X7(n)){let a=r.toLowerCase();i.has(a)||(e.delete(r),i.add(a)),o===null?(e.delete(r),t.add(a)):(e.append(r,o),t.delete(a))}}return{[$U]:!0,values:e,nulls:t}};var XC=s=>{var e,t,n,i,r,o;if(typeof globalThis.process<"u")return(n=(t=(e=globalThis.process.env)===null||e===void 0?void 0:e[s])===null||t===void 0?void 0:t.trim())!==null&&n!==void 0?n:void 0;if(typeof globalThis.Deno<"u")return(o=(r=(i=globalThis.Deno.env)===null||i===void 0?void 0:i.get)===null||r===void 0?void 0:r.call(i,s))===null||o===void 0?void 0:o.trim()};var BU,Kw=class s{constructor(e){var t,n,i,r,o,a,l,{baseURL:c=XC("GEMINI_NEXT_GEN_API_BASE_URL"),apiKey:d=(t=XC("GEMINI_API_KEY"))!==null&&t!==void 0?t:null,apiVersion:u="v1beta"}=e,h=Rw(e,["baseURL","apiKey","apiVersion"]);let p=Object.assign(Object.assign({apiKey:d,apiVersion:u},h),{baseURL:c||"https://generativelanguage.googleapis.com"});this.baseURL=p.baseURL,this.timeout=(n=p.timeout)!==null&&n!==void 0?n:s.DEFAULT_TIMEOUT,this.logger=(i=p.logger)!==null&&i!==void 0?i:console;let f="warn";this.logLevel=f,this.logLevel=(o=(r=iU(p.logLevel,"ClientOptions.logLevel",this))!==null&&r!==void 0?r:iU(XC("GEMINI_NEXT_GEN_API_LOG"),"process.env['GEMINI_NEXT_GEN_API_LOG']",this))!==null&&o!==void 0?o:f,this.fetchOptions=p.fetchOptions,this.maxRetries=(a=p.maxRetries)!==null&&a!==void 0?a:2,this.fetch=(l=p.fetch)!==null&&l!==void 0?l:I7(),this.encoder=F7,this._options=p,this.apiKey=d,this.apiVersion=u,this.clientAdapter=p.clientAdapter}withOptions(e){return new this.constructor(Object.assign(Object.assign(Object.assign({},this._options),{baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,apiVersion:this.apiVersion}),e))}baseURLOverridden(){return this.baseURL!=="https://generativelanguage.googleapis.com"}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){if(!(e.has("authorization")||e.has("x-goog-api-key"))&&!(this.apiKey&&e.get("x-goog-api-key"))&&!t.has("x-goog-api-key"))throw new Error('Could not resolve authentication method. Expected the apiKey to be set. Or for the "x-goog-api-key" headers to be explicitly omitted')}async authHeaders(e){let t=Gm([e.headers]);if(!(t.values.has("authorization")||t.values.has("x-goog-api-key"))){if(this.apiKey)return Gm([{"x-goog-api-key":this.apiKey}]);if(this.clientAdapter.isVertexAI())return Gm([await this.clientAdapter.getAuthHeaders()])}}stringifyQuery(e){return Object.entries(e).filter(([t,n])=>typeof n<"u").map(([t,n])=>{if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(n)}`;if(n===null)return`${encodeURIComponent(t)}=`;throw new Gi(`Cannot stringify type ${typeof n}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}getUserAgent(){return`${this.constructor.name}/JS ${Uh}`}defaultIdempotencyKey(){return`stainless-node-retry-${_7()}`}makeStatusError(e,t,n,i){return Wi.generate(e,t,n,i)}buildURL(e,t,n){let i=!this.baseURLOverridden()&&n||this.baseURL,r=v7(e)?new URL(e):new URL(i+(i.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),o=this.defaultQuery();return M7(o)||(t=Object.assign(Object.assign({},o),t)),typeof t=="object"&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}async prepareOptions(e){if(this.clientAdapter&&this.clientAdapter.isVertexAI()&&!e.path.startsWith(`/${this.apiVersion}/projects/`)){let t=e.path.slice(this.apiVersion.length+1);e.path=`/${this.apiVersion}/projects/${this.clientAdapter.getProject()}/locations/${this.clientAdapter.getLocation()}${t}`}}async prepareRequest(e,{url:t,options:n}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then(i=>Object.assign({method:e,path:t},i)))}request(e,t=null){return new UA(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,n){var i,r,o;let a=await e,l=(i=a.maxRetries)!==null&&i!==void 0?i:this.maxRetries;t==null&&(t=l),await this.prepareOptions(a);let{req:c,url:d,timeout:u}=await this.buildRequest(a,{retryCount:l-t});await this.prepareRequest(c,{url:d,options:a});let h="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),p=n===void 0?"":`, retryOf: ${n}`,f=Date.now();if(Di(this).debug(`[${h}] sending request`,hd({retryOfRequestLogID:n,method:a.method,url:d,options:a,headers:c.headers})),!((r=a.signal)===null||r===void 0)&&r.aborted)throw new jm;let _=new AbortController,b=await this.fetchWithTimeout(d,c,u,_).catch(NA),y=Date.now();if(b instanceof globalThis.Error){let C=`retrying, ${t} attempts remaining`;if(!((o=a.signal)===null||o===void 0)&&o.aborted)throw new jm;let M=LA(b)||/timed? ?out/i.test(String(b)+("cause"in b?String(b.cause):""));if(t)return Di(this).info(`[${h}] connection ${M?"timed out":"failed"} - ${C}`),Di(this).debug(`[${h}] connection ${M?"timed out":"failed"} (${C})`,hd({retryOfRequestLogID:n,url:d,durationMs:y-f,message:b.message})),this.retryRequest(a,t,n??h);throw Di(this).info(`[${h}] connection ${M?"timed out":"failed"} - error; no more retries left`),Di(this).debug(`[${h}] connection ${M?"timed out":"failed"} (error; no more retries left)`,hd({retryOfRequestLogID:n,url:d,durationMs:y-f,message:b.message})),M?new Lw:new Hh({cause:b})}let w=`[${h}${p}] ${c.method} ${d} ${b.ok?"succeeded":"failed"} with status ${b.status} in ${y-f}ms`;if(!b.ok){let C=await this.shouldRetry(b);if(t&&C){let R=`retrying, ${t} attempts remaining`;return await R7(b.body),Di(this).info(`${w} - ${R}`),Di(this).debug(`[${h}] response error (${R})`,hd({retryOfRequestLogID:n,url:b.url,status:b.status,headers:b.headers,durationMs:y-f})),this.retryRequest(a,t,n??h,b.headers)}let M=C?"error; no more retries left":"error; not retryable";Di(this).info(`${w} - ${M}`);let S=await b.text().catch(R=>NA(R).message),k=x7(S),T=k?void 0:S;throw Di(this).debug(`[${h}] response error (${M})`,hd({retryOfRequestLogID:n,url:b.url,status:b.status,headers:b.headers,message:T,durationMs:Date.now()-f})),this.makeStatusError(b.status,k,T,b.headers)}return Di(this).info(w),Di(this).debug(`[${h}] response start`,hd({retryOfRequestLogID:n,url:b.url,status:b.status,headers:b.headers,durationMs:y-f})),{response:b,options:a,controller:_,requestLogID:h,retryOfRequestLogID:n,startTime:f}}async fetchWithTimeout(e,t,n,i){let r=t||{},{signal:o,method:a}=r,l=Rw(r,["signal","method"]);o&&o.addEventListener("abort",()=>i.abort());let c=setTimeout(()=>i.abort(),n),d=globalThis.ReadableStream&&l.body instanceof globalThis.ReadableStream||typeof l.body=="object"&&l.body!==null&&Symbol.asyncIterator in l.body,u=Object.assign(Object.assign(Object.assign({signal:i.signal},d?{duplex:"half"}:{}),{method:"GET"}),l);a&&(u.method=a.toUpperCase());try{return await this.fetch.call(void 0,e,u)}finally{clearTimeout(c)}}async shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,n,i){var r;let o,a=i?.get("retry-after-ms");if(a){let c=parseFloat(a);Number.isNaN(c)||(o=c)}let l=i?.get("retry-after");if(l&&!o){let c=parseFloat(l);Number.isNaN(c)?o=Date.parse(l)-Date.now():o=c*1e3}if(!(o&&0<=o&&o<60*1e3)){let c=(r=e.maxRetries)!==null&&r!==void 0?r:this.maxRetries;o=this.calculateDefaultRetryTimeoutMillis(t,c)}return await S7(o),this.makeRequest(e,t-1,n)}calculateDefaultRetryTimeoutMillis(e,t){let r=t-e,o=Math.min(.5*Math.pow(2,r),8),a=1-Math.random()*.25;return o*a*1e3}async buildRequest(e,{retryCount:t=0}={}){var n,i,r;let o=Object.assign({},e),{method:a,path:l,query:c,defaultBaseURL:d}=o,u=this.buildURL(l,c,d);"timeout"in o&&E7("timeout",o.timeout),o.timeout=(n=o.timeout)!==null&&n!==void 0?n:this.timeout;let{bodyHeaders:h,body:p}=this.buildBody({options:o}),f=await this.buildHeaders({options:e,method:a,bodyHeaders:h,retryCount:t});return{req:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({method:a,headers:f},o.signal&&{signal:o.signal}),globalThis.ReadableStream&&p instanceof globalThis.ReadableStream&&{duplex:"half"}),p&&{body:p}),(i=this.fetchOptions)!==null&&i!==void 0?i:{}),(r=o.fetchOptions)!==null&&r!==void 0?r:{}),url:u,timeout:o.timeout}}async buildHeaders({options:e,method:t,bodyHeaders:n,retryCount:i}){let r={};this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),r[this.idempotencyHeader]=e.idempotencyKey);let o=await this.authHeaders(e),a=Gm([r,Object.assign(Object.assign({Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(i)},e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{}),k7()),this._options.defaultHeaders,n,e.headers,o]);return this.validateHeaders(a),a.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};let n=Gm([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||typeof e=="string"&&n.values.has("content-type")||globalThis.Blob&&e instanceof globalThis.Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:typeof e=="object"&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&typeof e.next=="function")?{bodyHeaders:void 0,body:D7(e)}:this.encoder({body:e,headers:n})}};Kw.DEFAULT_TIMEOUT=6e4;var ks=class extends Kw{constructor(){super(...arguments),this.interactions=new jw(this)}};BU=ks;ks.GeminiNextGenAPIClient=BU;ks.GeminiNextGenAPIClientError=Gi;ks.APIError=Wi;ks.APIConnectionError=Hh;ks.APIConnectionTimeoutError=Lw;ks.APIUserAbortError=jm;ks.NotFoundError=Bw;ks.ConflictError=zw;ks.RateLimitError=Vw;ks.BadRequestError=Nw;ks.AuthenticationError=Ow;ks.InternalServerError=Gw;ks.PermissionDeniedError=$w;ks.UnprocessableEntityError=Uw;ks.toFile=B7;ks.Interactions=jw;function Q7(s,e){let t={},n=g(s,["name"]);return n!=null&&v(t,["_url","name"],n),t}function J7(s,e){let t={},n=g(s,["name"]);return n!=null&&v(t,["_url","name"],n),t}function Z7(s,e){let t={},n=g(s,["sdkHttpResponse"]);return n!=null&&v(t,["sdkHttpResponse"],n),t}function eee(s,e){let t={},n=g(s,["sdkHttpResponse"]);return n!=null&&v(t,["sdkHttpResponse"],n),t}function tee(s,e,t){let n={};if(g(s,["validationDataset"])!==void 0)throw new Error("validationDataset parameter is not supported in Gemini API.");let i=g(s,["tunedModelDisplayName"]);if(e!==void 0&&i!=null&&v(e,["displayName"],i),g(s,["description"])!==void 0)throw new Error("description parameter is not supported in Gemini API.");let r=g(s,["epochCount"]);e!==void 0&&r!=null&&v(e,["tuningTask","hyperparameters","epochCount"],r);let o=g(s,["learningRateMultiplier"]);if(o!=null&&v(n,["tuningTask","hyperparameters","learningRateMultiplier"],o),g(s,["exportLastCheckpointOnly"])!==void 0)throw new Error("exportLastCheckpointOnly parameter is not supported in Gemini API.");if(g(s,["preTunedModelCheckpointId"])!==void 0)throw new Error("preTunedModelCheckpointId parameter is not supported in Gemini API.");if(g(s,["adapterSize"])!==void 0)throw new Error("adapterSize parameter is not supported in Gemini API.");let a=g(s,["batchSize"]);e!==void 0&&a!=null&&v(e,["tuningTask","hyperparameters","batchSize"],a);let l=g(s,["learningRate"]);if(e!==void 0&&l!=null&&v(e,["tuningTask","hyperparameters","learningRate"],l),g(s,["labels"])!==void 0)throw new Error("labels parameter is not supported in Gemini API.");if(g(s,["beta"])!==void 0)throw new Error("beta parameter is not supported in Gemini API.");return n}function nee(s,e,t){let n={},i=g(t,["config","method"]);if(i===void 0&&(i="SUPERVISED_FINE_TUNING"),i==="SUPERVISED_FINE_TUNING"){let p=g(s,["validationDataset"]);e!==void 0&&p!=null&&v(e,["supervisedTuningSpec"],oU(p))}else if(i==="PREFERENCE_TUNING"){let p=g(s,["validationDataset"]);e!==void 0&&p!=null&&v(e,["preferenceOptimizationSpec"],oU(p))}let r=g(s,["tunedModelDisplayName"]);e!==void 0&&r!=null&&v(e,["tunedModelDisplayName"],r);let o=g(s,["description"]);e!==void 0&&o!=null&&v(e,["description"],o);let a=g(t,["config","method"]);if(a===void 0&&(a="SUPERVISED_FINE_TUNING"),a==="SUPERVISED_FINE_TUNING"){let p=g(s,["epochCount"]);e!==void 0&&p!=null&&v(e,["supervisedTuningSpec","hyperParameters","epochCount"],p)}else if(a==="PREFERENCE_TUNING"){let p=g(s,["epochCount"]);e!==void 0&&p!=null&&v(e,["preferenceOptimizationSpec","hyperParameters","epochCount"],p)}let l=g(t,["config","method"]);if(l===void 0&&(l="SUPERVISED_FINE_TUNING"),l==="SUPERVISED_FINE_TUNING"){let p=g(s,["learningRateMultiplier"]);e!==void 0&&p!=null&&v(e,["supervisedTuningSpec","hyperParameters","learningRateMultiplier"],p)}else if(l==="PREFERENCE_TUNING"){let p=g(s,["learningRateMultiplier"]);e!==void 0&&p!=null&&v(e,["preferenceOptimizationSpec","hyperParameters","learningRateMultiplier"],p)}let c=g(t,["config","method"]);if(c===void 0&&(c="SUPERVISED_FINE_TUNING"),c==="SUPERVISED_FINE_TUNING"){let p=g(s,["exportLastCheckpointOnly"]);e!==void 0&&p!=null&&v(e,["supervisedTuningSpec","exportLastCheckpointOnly"],p)}else if(c==="PREFERENCE_TUNING"){let p=g(s,["exportLastCheckpointOnly"]);e!==void 0&&p!=null&&v(e,["preferenceOptimizationSpec","exportLastCheckpointOnly"],p)}let d=g(t,["config","method"]);if(d===void 0&&(d="SUPERVISED_FINE_TUNING"),d==="SUPERVISED_FINE_TUNING"){let p=g(s,["adapterSize"]);e!==void 0&&p!=null&&v(e,["supervisedTuningSpec","hyperParameters","adapterSize"],p)}else if(d==="PREFERENCE_TUNING"){let p=g(s,["adapterSize"]);e!==void 0&&p!=null&&v(e,["preferenceOptimizationSpec","hyperParameters","adapterSize"],p)}if(g(s,["batchSize"])!==void 0)throw new Error("batchSize parameter is not supported in Vertex AI.");if(g(s,["learningRate"])!==void 0)throw new Error("learningRate parameter is not supported in Vertex AI.");let u=g(s,["labels"]);e!==void 0&&u!=null&&v(e,["labels"],u);let h=g(s,["beta"]);return e!==void 0&&h!=null&&v(e,["preferenceOptimizationSpec","hyperParameters","beta"],h),n}function see(s,e){let t={},n=g(s,["baseModel"]);n!=null&&v(t,["baseModel"],n);let i=g(s,["preTunedModel"]);i!=null&&v(t,["preTunedModel"],i);let r=g(s,["trainingDataset"]);r!=null&&fee(r);let o=g(s,["config"]);return o!=null&&tee(o,t),t}function iee(s,e){let t={},n=g(s,["baseModel"]);n!=null&&v(t,["baseModel"],n);let i=g(s,["preTunedModel"]);i!=null&&v(t,["preTunedModel"],i);let r=g(s,["trainingDataset"]);r!=null&&mee(r,t,e);let o=g(s,["config"]);return o!=null&&nee(o,t,e),t}function ree(s,e){let t={},n=g(s,["name"]);return n!=null&&v(t,["_url","name"],n),t}function oee(s,e){let t={},n=g(s,["name"]);return n!=null&&v(t,["_url","name"],n),t}function aee(s,e,t){let n={},i=g(s,["pageSize"]);e!==void 0&&i!=null&&v(e,["_query","pageSize"],i);let r=g(s,["pageToken"]);e!==void 0&&r!=null&&v(e,["_query","pageToken"],r);let o=g(s,["filter"]);return e!==void 0&&o!=null&&v(e,["_query","filter"],o),n}function lee(s,e,t){let n={},i=g(s,["pageSize"]);e!==void 0&&i!=null&&v(e,["_query","pageSize"],i);let r=g(s,["pageToken"]);e!==void 0&&r!=null&&v(e,["_query","pageToken"],r);let o=g(s,["filter"]);return e!==void 0&&o!=null&&v(e,["_query","filter"],o),n}function cee(s,e){let t={},n=g(s,["config"]);return n!=null&&aee(n,t),t}function dee(s,e){let t={},n=g(s,["config"]);return n!=null&&lee(n,t),t}function uee(s,e){let t={},n=g(s,["sdkHttpResponse"]);n!=null&&v(t,["sdkHttpResponse"],n);let i=g(s,["nextPageToken"]);i!=null&&v(t,["nextPageToken"],i);let r=g(s,["tunedModels"]);if(r!=null){let o=r;Array.isArray(o)&&(o=o.map(a=>zU(a))),v(t,["tuningJobs"],o)}return t}function hee(s,e){let t={},n=g(s,["sdkHttpResponse"]);n!=null&&v(t,["sdkHttpResponse"],n);let i=g(s,["nextPageToken"]);i!=null&&v(t,["nextPageToken"],i);let r=g(s,["tuningJobs"]);if(r!=null){let o=r;Array.isArray(o)&&(o=o.map(a=>VA(a))),v(t,["tuningJobs"],o)}return t}function pee(s,e){let t={},n=g(s,["name"]);n!=null&&v(t,["model"],n);let i=g(s,["name"]);return i!=null&&v(t,["endpoint"],i),t}function fee(s,e){let t={};if(g(s,["gcsUri"])!==void 0)throw new Error("gcsUri parameter is not supported in Gemini API.");if(g(s,["vertexDatasetResource"])!==void 0)throw new Error("vertexDatasetResource parameter is not supported in Gemini API.");let n=g(s,["examples"]);if(n!=null){let i=n;Array.isArray(i)&&(i=i.map(r=>r)),v(t,["examples","examples"],i)}return t}function mee(s,e,t){let n={},i=g(t,["config","method"]);if(i===void 0&&(i="SUPERVISED_FINE_TUNING"),i==="SUPERVISED_FINE_TUNING"){let o=g(s,["gcsUri"]);e!==void 0&&o!=null&&v(e,["supervisedTuningSpec","trainingDatasetUri"],o)}else if(i==="PREFERENCE_TUNING"){let o=g(s,["gcsUri"]);e!==void 0&&o!=null&&v(e,["preferenceOptimizationSpec","trainingDatasetUri"],o)}let r=g(t,["config","method"]);if(r===void 0&&(r="SUPERVISED_FINE_TUNING"),r==="SUPERVISED_FINE_TUNING"){let o=g(s,["vertexDatasetResource"]);e!==void 0&&o!=null&&v(e,["supervisedTuningSpec","trainingDatasetUri"],o)}else if(r==="PREFERENCE_TUNING"){let o=g(s,["vertexDatasetResource"]);e!==void 0&&o!=null&&v(e,["preferenceOptimizationSpec","trainingDatasetUri"],o)}if(g(s,["examples"])!==void 0)throw new Error("examples parameter is not supported in Vertex AI.");return n}function zU(s,e){let t={},n=g(s,["sdkHttpResponse"]);n!=null&&v(t,["sdkHttpResponse"],n);let i=g(s,["name"]);i!=null&&v(t,["name"],i);let r=g(s,["state"]);r!=null&&v(t,["state"],fU(r));let o=g(s,["createTime"]);o!=null&&v(t,["createTime"],o);let a=g(s,["tuningTask","startTime"]);a!=null&&v(t,["startTime"],a);let l=g(s,["tuningTask","completeTime"]);l!=null&&v(t,["endTime"],l);let c=g(s,["updateTime"]);c!=null&&v(t,["updateTime"],c);let d=g(s,["description"]);d!=null&&v(t,["description"],d);let u=g(s,["baseModel"]);u!=null&&v(t,["baseModel"],u);let h=g(s,["_self"]);return h!=null&&v(t,["tunedModel"],pee(h)),t}function VA(s,e){let t={},n=g(s,["sdkHttpResponse"]);n!=null&&v(t,["sdkHttpResponse"],n);let i=g(s,["name"]);i!=null&&v(t,["name"],i);let r=g(s,["state"]);r!=null&&v(t,["state"],fU(r));let o=g(s,["createTime"]);o!=null&&v(t,["createTime"],o);let a=g(s,["startTime"]);a!=null&&v(t,["startTime"],a);let l=g(s,["endTime"]);l!=null&&v(t,["endTime"],l);let c=g(s,["updateTime"]);c!=null&&v(t,["updateTime"],c);let d=g(s,["error"]);d!=null&&v(t,["error"],d);let u=g(s,["description"]);u!=null&&v(t,["description"],u);let h=g(s,["baseModel"]);h!=null&&v(t,["baseModel"],h);let p=g(s,["tunedModel"]);p!=null&&v(t,["tunedModel"],p);let f=g(s,["preTunedModel"]);f!=null&&v(t,["preTunedModel"],f);let _=g(s,["supervisedTuningSpec"]);_!=null&&v(t,["supervisedTuningSpec"],_);let b=g(s,["preferenceOptimizationSpec"]);b!=null&&v(t,["preferenceOptimizationSpec"],b);let y=g(s,["tuningDataStats"]);y!=null&&v(t,["tuningDataStats"],y);let w=g(s,["encryptionSpec"]);w!=null&&v(t,["encryptionSpec"],w);let C=g(s,["partnerModelTuningSpec"]);C!=null&&v(t,["partnerModelTuningSpec"],C);let M=g(s,["customBaseModel"]);M!=null&&v(t,["customBaseModel"],M);let S=g(s,["experiment"]);S!=null&&v(t,["experiment"],S);let k=g(s,["labels"]);k!=null&&v(t,["labels"],k);let T=g(s,["outputUri"]);T!=null&&v(t,["outputUri"],T);let P=g(s,["pipelineJob"]);P!=null&&v(t,["pipelineJob"],P);let R=g(s,["serviceAccount"]);R!=null&&v(t,["serviceAccount"],R);let O=g(s,["tunedModelDisplayName"]);O!=null&&v(t,["tunedModelDisplayName"],O);let H=g(s,["veoTuningSpec"]);return H!=null&&v(t,["veoTuningSpec"],H),t}function gee(s,e){let t={},n=g(s,["sdkHttpResponse"]);n!=null&&v(t,["sdkHttpResponse"],n);let i=g(s,["name"]);i!=null&&v(t,["name"],i);let r=g(s,["metadata"]);r!=null&&v(t,["metadata"],r);let o=g(s,["done"]);o!=null&&v(t,["done"],o);let a=g(s,["error"]);return a!=null&&v(t,["error"],a),t}function oU(s,e){let t={},n=g(s,["gcsUri"]);n!=null&&v(t,["validationDatasetUri"],n);let i=g(s,["vertexDatasetResource"]);return i!=null&&v(t,["validationDatasetUri"],i),t}var GA=class extends oo{constructor(e){super(),this.apiClient=e,this.list=async(t={})=>new za(Ba.PAGED_ITEM_TUNING_JOBS,n=>this.listInternal(n),await this.listInternal(t),t),this.get=async t=>await this.getInternal(t),this.tune=async t=>{var n;if(this.apiClient.isVertexAI())if(t.baseModel.startsWith("projects/")){let i={tunedModelName:t.baseModel};!((n=t.config)===null||n===void 0)&&n.preTunedModelCheckpointId&&(i.checkpointId=t.config.preTunedModelCheckpointId);let r=Object.assign(Object.assign({},t),{preTunedModel:i});return r.baseModel=void 0,await this.tuneInternal(r)}else{let i=Object.assign({},t);return await this.tuneInternal(i)}else{let i=Object.assign({},t),r=await this.tuneMldevInternal(i),o="";return r.metadata!==void 0&&r.metadata.tunedModel!==void 0?o=r.metadata.tunedModel:r.name!==void 0&&r.name.includes("/operations/")&&(o=r.name.split("/operations/")[0]),{name:o,state:JC.JOB_STATE_QUEUED}}}}async getInternal(e){var t,n,i,r;let o,a="",l={};if(this.apiClient.isVertexAI()){let c=oee(e);return a=mt("{name}",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>VA(d))}else{let c=ree(e);return a=mt("{name}",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>zU(d))}}async listInternal(e){var t,n,i,r;let o,a="",l={};if(this.apiClient.isVertexAI()){let c=dee(e);return a=mt("tuningJobs",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>{let u=hee(d),h=new Cw;return Object.assign(h,u),h})}else{let c=cee(e);return a=mt("tunedModels",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>{let u=uee(d),h=new Cw;return Object.assign(h,u),h})}}async cancel(e){var t,n,i,r;let o,a="",l={};if(this.apiClient.isVertexAI()){let c=J7(e);return a=mt("{name}:cancel",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>{let u=eee(d),h=new Aw;return Object.assign(h,u),h})}else{let c=Q7(e);return a=mt("{name}:cancel",c._url),l=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:a,queryParams:l,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(i=e.config)===null||i===void 0?void 0:i.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json().then(u=>{let h=u;return h.sdkHttpResponse={headers:d.headers},h})),o.then(d=>{let u=Z7(d),h=new Aw;return Object.assign(h,u),h})}}async tuneInternal(e){var t,n;let i,r="",o={};if(this.apiClient.isVertexAI()){let a=iee(e,e);return r=mt("tuningJobs",a._url),o=a._query,delete a._url,delete a._query,i=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(l=>l.json().then(c=>{let d=c;return d.sdkHttpResponse={headers:l.headers},d})),i.then(l=>VA(l))}else throw new Error("This method is only supported by the Vertex AI.")}async tuneMldevInternal(e){var t,n;let i,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{let a=see(e);return r=mt("tunedModels",a._url),o=a._query,delete a._url,delete a._query,i=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(n=e.config)===null||n===void 0?void 0:n.abortSignal}).then(l=>l.json().then(c=>{let d=c;return d.sdkHttpResponse={headers:l.headers},d})),i.then(l=>gee(l))}}};var WA=class{async download(e,t){throw new Error("Download to file is not supported in the browser, please use a browser compliant download like an <a> tag.")}},_ee=1024*1024*8,yee=3,vee=1e3,bee=2,Yw="x-goog-upload-status";async function wee(s,e,t){var n;let i=await UU(s,e,t),r=await i?.json();if(((n=i?.headers)===null||n===void 0?void 0:n[Yw])!=="final")throw new Error("Failed to upload file: Upload status is not finalized.");return r.file}async function Mee(s,e,t){var n;let i=await UU(s,e,t),r=await i?.json();if(((n=i?.headers)===null||n===void 0?void 0:n[Yw])!=="final")throw new Error("Failed to upload file: Upload status is not finalized.");let o=lU(r),a=new pA;return Object.assign(a,o),a}async function UU(s,e,t){var n,i;let r=0,o=0,a=new Hm(new Response),l="upload";for(r=s.size;o<r;){let c=Math.min(_ee,r-o),d=s.slice(o,o+c);o+c>=r&&(l+=", finalize");let u=0,h=vee;for(;u<yee&&(a=await t.request({path:"",body:d,httpMethod:"POST",httpOptions:{apiVersion:"",baseUrl:e,headers:{"X-Goog-Upload-Command":l,"X-Goog-Upload-Offset":String(o),"Content-Length":String(c)}}}),!(!((n=a?.headers)===null||n===void 0)&&n[Yw]));)u++,await Eee(h),h=h*bee;if(o+=c,((i=a?.headers)===null||i===void 0?void 0:i[Yw])!=="active")break;if(r<=o)throw new Error("All content has been uploaded, but the upload status is not finalized.")}return a}async function Tee(s){return{size:s.size,type:s.type}}function Eee(s){return new Promise(e=>setTimeout(e,s))}var HA=class{async upload(e,t,n){if(typeof e=="string")throw new Error("File path is not supported in browser uploader.");return await wee(e,t,n)}async uploadToFileSearchStore(e,t,n){if(typeof e=="string")throw new Error("File path is not supported in browser uploader.");return await Mee(e,t,n)}async stat(e){if(typeof e=="string")throw new Error("File path is not supported in browser uploader.");return await Tee(e)}};var jA=class{create(e,t,n){return new qA(e,t,n)}},qA=class{constructor(e,t,n){this.url=e,this.headers=t,this.callbacks=n}connect(){this.ws=new WebSocket(this.url),this.ws.onopen=this.callbacks.onopen,this.ws.onerror=this.callbacks.onerror,this.ws.onclose=this.callbacks.onclose,this.ws.onmessage=this.callbacks.onmessage}send(e){if(this.ws===void 0)throw new Error("WebSocket is not connected");this.ws.send(e)}close(){if(this.ws===void 0)throw new Error("WebSocket is not connected");this.ws.close()}};var aU="x-goog-api-key",KA=class{constructor(e){this.apiKey=e}async addAuthHeaders(e,t){if(e.get(aU)===null){if(this.apiKey.startsWith("auth_tokens/"))throw new Error("Ephemeral tokens are only supported by the live API.");if(!this.apiKey)throw new Error("API key is missing. Please provide a valid API key.");e.append(aU,this.apiKey)}}};var xee="gl-node/",Xw=class{get interactions(){if(this._interactions!==void 0)return this._interactions;console.warn("GoogleGenAI.interactions: Interactions usage is experimental and may change in future versions.");let e=this.httpOptions;e?.extraBody&&console.warn("GoogleGenAI.interactions: Client level httpOptions.extraBody is not supported by the interactions client and will be ignored.");let t=new ks({baseURL:this.apiClient.getBaseUrl(),apiKey:this.apiKey,apiVersion:this.apiClient.getApiVersion(),clientAdapter:this.apiClient,defaultHeaders:this.apiClient.getDefaultHeaders(),timeout:e?.timeout});return this._interactions=t.interactions,this._interactions}constructor(e){var t;if(e.apiKey==null)throw new Error("An API Key must be set when running in a browser");if(e.project||e.location)throw new Error("Vertex AI project based authentication is not supported on browser runtimes. Please do not provide a project or location.");this.vertexai=(t=e.vertexai)!==null&&t!==void 0?t:!1,this.apiKey=e.apiKey;let n=tX(e.httpOptions,e.vertexai,void 0,void 0);n&&(e.httpOptions?e.httpOptions.baseUrl=n:e.httpOptions={baseUrl:n}),this.apiVersion=e.apiVersion,this.httpOptions=e.httpOptions;let i=new KA(this.apiKey);this.apiClient=new EA({auth:i,apiVersion:this.apiVersion,apiKey:this.apiKey,vertexai:this.vertexai,httpOptions:this.httpOptions,userAgentExtra:xee+"web",uploader:new HA,downloader:new WA}),this.models=new kA(this.apiClient),this.live=new AA(this.apiClient,i,new jA),this.batches=new gA(this.apiClient),this.chats=new yA(this.models,this.apiClient),this.caches=new _A(this.apiClient),this.files=new bA(this.apiClient),this.operations=new IA(this.apiClient),this.authTokens=new DA(this.apiClient),this.tunings=new GA(this.apiClient),this.fileSearchStores=new FA(this.apiClient)}};var VU=`You are my assistant for classifying notes by project and restructuring content when needed.

## \uAE30\uC874 \uD504\uB85C\uC81D\uD2B8 \uBAA9\uB85D
{projects}

## \uB178\uD2B8 \uB0B4\uC6A9
{content}

## \uBD84\uB958 \uADDC\uCE59 (\uC911\uC694\uB3C4 \uC21C)

### 1. \uD504\uB85C\uC81D\uD2B8 \uC0B0\uCD9C\uBB3C (contentType: "artifact")
\uD504\uB85C\uC81D\uD2B8 \uD3F4\uB354\uC5D0 \uC9C1\uC811 \uC800\uC7A5\uD574\uC57C \uD560 \uAC83:
- \uC9C1\uC811 \uC791\uC131\uD55C \uBB38\uC11C, \uACC4\uD68D\uC11C, \uD68C\uC758\uB85D
- \uD504\uB85C\uC81D\uD2B8\uB97C \uC704\uD574 \uB9CC\uB4E0 \uCF54\uB4DC, \uC124\uACC4\uC11C
- \uD504\uB85C\uC81D\uD2B8 \uC9C4\uD589 \uAD00\uB828 \uBA54\uBAA8

### 2. \uD504\uB85C\uC81D\uD2B8 \uCC38\uACE0\uC790\uB8CC (contentType: "reference")
Library\uC5D0 \uC800\uC7A5\uD558\uB418 \uD504\uB85C\uC81D\uD2B8\uC640 \uB9C1\uD06C\uD574\uC57C \uD560 \uAC83:
- \uC678\uBD80 \uD29C\uD1A0\uB9AC\uC5BC, \uC608\uC81C \uCF54\uB4DC, \uBB38\uC11C
- \uC6F9\uD398\uC774\uC9C0 \uC2A4\uD06C\uB7A9, \uC544\uD2F0\uD074
- \uB2E4\uB978 \uD504\uB85C\uC81D\uD2B8\uC5D0\uC11C\uB3C4 \uC7AC\uC0AC\uC6A9 \uAC00\uB2A5\uD55C \uC790\uB8CC
- \uC608: "ESP32 \uC608\uC81C" \u2192 \uD30C\uCE20\uD31C\uC5D0 \uC720\uC6A9\uD558\uC9C0\uB9CC Library\uC5D0 \uC800\uC7A5

### 3. \uC77C\uBC18 \uCC38\uACE0\uC790\uB8CC (targetType: "library", contentType: "general")
- \uD2B9\uC815 \uD504\uB85C\uC81D\uD2B8\uC640 \uAD00\uB828 \uC5C6\uB294 \uC77C\uBC18 \uC815\uBCF4
- \uB274\uC2A4, \uACF5\uACE0, \uC77C\uBC18 \uC544\uD2F0\uD074

### 4. archive
- \uC644\uB8CC\uB41C \uB0B4\uC6A9, \uB354 \uC774\uC0C1 \uD544\uC694\uC5C6\uB294 \uAC83

## \uD310\uB2E8 \uAE30\uC900
- "\uC774\uAC74 \uB0B4\uAC00 \uC9C1\uC811 \uB9CC\uB4E0 \uC0B0\uCD9C\uBB3C\uC778\uAC00?" \u2192 artifact
- "\uC774\uAC74 \uC678\uBD80 \uC790\uB8CC\uC778\uB370 \uD504\uB85C\uC81D\uD2B8\uC5D0 \uC720\uC6A9\uD55C\uAC00?" \u2192 reference
- "\uC774\uAC74 \uADF8\uB0E5 \uC77C\uBC18 \uCC38\uACE0\uC790\uB8CC\uC778\uAC00?" \u2192 general
- "\uD504\uB85C\uC81D\uD2B8 \uB05D\uB098\uB3C4 \uACC4\uC18D \uCC38\uACE0\uD560 \uC790\uB8CC\uC778\uAC00?" \u2192 reference (Library)

## \uCF58\uD150\uCE20 \uC7AC\uAD6C\uC131 (Phase 2)

\uB178\uD2B8\uAC00 \uC815\uB9AC\uB418\uC9C0 \uC54A\uC740 \uC6D0\uC2DC \uD615\uD0DC\uB77C\uBA74 \uC7AC\uAD6C\uC131\uC744 \uC81C\uC548\uD574\uB77C:

### \uC7AC\uAD6C\uC131 \uD544\uC694 \uC5EC\uBD80 \uD310\uB2E8
- \uAD6C\uC870\uD654\uB418\uC9C0 \uC54A\uC740 \uBA54\uBAA8 (\uC904\uAE00, \uB098\uC5F4, \uD0A4\uC6CC\uB4DC\uB9CC)
- \uD68C\uC758/\uBBF8\uD305 \uB0B4\uC6A9\uC778\uB370 \uC815\uB9AC \uC548 \uB428
- \uD559\uC2B5 \uB0B4\uC6A9\uC778\uB370 \uCCB4\uACC4 \uC5C6\uC74C
- \uC544\uC774\uB514\uC5B4\uC778\uB370 \uC124\uBA85 \uBD80\uC871

### \uC7AC\uAD6C\uC131 \uC720\uD615\uBCC4 \uD15C\uD50C\uB9BF

**meeting (\uD68C\uC758/\uBBF8\uD305)**:
\`\`\`
## \uD68C\uC758 \uC694\uC57D
- \uC77C\uC2DC: [\uB0A0\uC9DC]
- \uCC38\uC11D\uC790: [\uCD94\uB860 \uAC00\uB2A5\uD558\uBA74]
- \uC8FC\uC81C: [\uD575\uC2EC \uC8FC\uC81C]

## \uB17C\uC758 \uB0B4\uC6A9
- [\uD575\uC2EC \uB17C\uC758 1]
- [\uD575\uC2EC \uB17C\uC758 2]

## \uACB0\uC815\uC0AC\uD56D
- [\uACB0\uC815 1]

## \uC561\uC158 \uC544\uC774\uD15C
- [ ] [\uD560 \uC77C]
\`\`\`

**idea (\uC544\uC774\uB514\uC5B4/\uBE0C\uB808\uC778\uC2A4\uD1A0\uBC0D)**:
\`\`\`
## \uD575\uC2EC \uC544\uC774\uB514\uC5B4
[\uC544\uC774\uB514\uC5B4 1\uC904 \uC694\uC57D]

## \uC0C1\uC138 \uC124\uBA85
[\uC544\uC774\uB514\uC5B4 \uC124\uBA85]

## \uC65C \uC911\uC694\uD55C\uAC00?
[\uC774\uC720]

## \uB2E4\uC74C \uB2E8\uACC4
- [ ] [\uAC80\uC99D/\uC2E4\uD589 \uBC29\uBC95]
\`\`\`

**learning (\uD559\uC2B5/\uC5F0\uAD6C)**:
\`\`\`
## \uC8FC\uC81C
[\uD559\uC2B5 \uC8FC\uC81C]

## \uD575\uC2EC \uAC1C\uB150
- [\uAC1C\uB150 1]
- [\uAC1C\uB150 2]

## \uBC30\uC6B4 \uC810
[\uC778\uC0AC\uC774\uD2B8]

## \uC801\uC6A9 \uBC29\uBC95
- [\uC2E4\uC81C \uC801\uC6A9 \uC608\uC2DC]
\`\`\`

**general (\uC77C\uBC18 \uC815\uB9AC)**:
\`\`\`
## \uC694\uC57D
[\uD575\uC2EC \uB0B4\uC6A9 2-3\uBB38\uC7A5]

## \uC8FC\uC694 \uB0B4\uC6A9
- [\uD3EC\uC778\uD2B8 1]
- [\uD3EC\uC778\uD2B8 2]

## \uAD00\uB828 \uC815\uBCF4
- [\uCC38\uACE0 \uC0AC\uD56D]
\`\`\`

## \uCD9C\uB825 \uD615\uC2DD (JSON\uC73C\uB85C \uC751\uB2F5)
{
  "targetType": "project \uB610\uB294 library \uB610\uB294 archive",
  "contentType": "artifact \uB610\uB294 reference \uB610\uB294 general",
  "projectName": "\uD504\uB85C\uC81D\uD2B8\uBA85 (project \uB610\uB294 reference\uC77C \uB54C)",
  "isNewProject": true/false,
  "confidence": "high \uB610\uB294 medium \uB610\uB294 low",
  "reason": "\uC774 \uBD84\uB958\uB97C \uC120\uD0DD\uD55C \uC774\uC720 (1\uC904)",
  "title": "\uB178\uD2B8 \uC81C\uBAA9",
  "summary": "2-3\uBB38\uC7A5 \uC694\uC57D",
  "nextAction": "\uB2E4\uC74C \uD589\uB3D9 \uB610\uB294 null",
  "shouldRestructure": true/false,
  "restructureType": "meeting \uB610\uB294 idea \uB610\uB294 learning \uB610\uB294 general (\uC7AC\uAD6C\uC131 \uD544\uC694\uC2DC)",
  "restructuredContent": "\uC7AC\uAD6C\uC131\uB41C \uB9C8\uD06C\uB2E4\uC6B4 \uB0B4\uC6A9 (shouldRestructure\uAC00 true\uC77C \uB54C)"
}

**\uC911\uC694**: shouldRestructure\uAC00 false\uBA74 restructureType\uACFC restructuredContent\uB294 \uC0DD\uB7B5
`,GU=`\uB108\uB294 \uC81C\uD154\uCE74\uC2A4\uD150(Zettelkasten) \uBC29\uC2DD\uC758 \uC601\uAD6C \uB178\uD2B8\uB97C \uB9CC\uB4DC\uB294 \uBE44\uC11C\uB2E4.
\uC544\uB798 \uB178\uD2B8\uC5D0\uC11C \uC81C\uD154\uCE74\uC2A4\uD150\uC6A9 \uC601\uAD6C \uB178\uD2B8 \uD6C4\uBCF4 \uC544\uC774\uB514\uC5B4\uB4E4\uC744 \uCD94\uCD9C\uD574\uB77C.

## \uADDC\uCE59
- \uD55C \uB178\uD2B8\uC5D0\uB294 \uD558\uB098\uC758 \uC544\uC774\uB514\uC5B4\uB9CC \uB2F4\uB294\uB2E4 (atomic note)
- \uAC01 \uC544\uC774\uB514\uC5B4\uB294 3-5\uBB38\uC7A5\uC73C\uB85C \uC124\uBA85\uD55C\uB2E4
- \uC65C \uC774 \uC544\uC774\uB514\uC5B4\uAC00 \uC911\uC694\uD55C\uC9C0 \uD55C \uC904\uB85C \uC124\uBA85\uD574\uB77C
- \uC774 \uC544\uC774\uB514\uC5B4\uAC00 \uC5F0\uACB0\uB420 \uC218 \uC788\uB294 \uAC1C\uB150 2-3\uAC1C\uB97C \uC81C\uC548\uD574\uB77C
- \uC544\uC774\uB514\uC5B4\uB9C8\uB2E4 \uC5F0\uAD00 \uD0A4\uC6CC\uB4DC\uB97C \uD568\uAED8 \uC801\uC5B4\uB77C

## \uB178\uD2B8 \uB0B4\uC6A9
{content}

## \uCD9C\uB825 \uD615\uC2DD (JSON \uBC30\uC5F4\uB85C \uC751\uB2F5)
[
  {
    "title": "\uC544\uC774\uB514\uC5B4\uB97C \uD55C \uBB38\uC7A5\uC73C\uB85C \uC124\uBA85\uD558\uB294 \uC81C\uBAA9",
    "body": "3-5\uBB38\uC7A5\uC758 \uC124\uBA85",
    "importance": "\uC65C \uC774 \uC544\uC774\uB514\uC5B4\uAC00 \uC911\uC694\uD55C\uAC00? (1\uC904)",
    "relatedConcepts": ["\uAC1C\uB1501", "\uAC1C\uB1502", "\uAC1C\uB1503"],
    "keywords": ["\uD0A4\uC6CC\uB4DC1", "\uD0A4\uC6CC\uB4DC2", "\uD0A4\uC6CC\uB4DC3"]
  }
]

\uC544\uC774\uB514\uC5B4\uAC00 \uC5C6\uC73C\uBA74 \uBE48 \uBC30\uC5F4 []\uC744 \uBC18\uD658\uD574\uB77C.
`,WU=`\uB108\uB294 \uB098\uC758 \uC791\uC5C5 \uC6B0\uC120\uC21C\uC704 \uCF54\uCE58\uB2E4.
\uC544\uB798 \uD504\uB85C\uC81D\uD2B8 \uBAA9\uB85D\uC744 \uBCF4\uACE0, \uC9C0\uAE08 \uB0B4\uAC00 \uC9D1\uC911\uD574\uC57C \uD560 \uC0C1\uC704 3\uAC1C\uB9CC \uACE8\uB77C\uB77C.

## \uD504\uB85C\uC81D\uD2B8 \uBAA9\uB85D
{projects}

## \uAC01 \uD504\uB85C\uC81D\uD2B8\uC5D0 \uB300\uD574 \uB2E4\uC74C\uC744 \uC81C\uACF5\uD574\uB77C
- title: \uD504\uB85C\uC81D\uD2B8 \uC774\uB984
- why: \uC65C \uC9C0\uAE08 \uC911\uC694\uD55C\uC9C0 \uD55C \uC904 \uC124\uBA85
- next_action: \uC624\uB298 \uB2F9\uC7A5 \uD560 \uC218 \uC788\uB294 \uAC00\uC7A5 \uC791\uC740 \uB2E4\uC74C \uD589\uB3D9

## \uCD9C\uB825 \uD615\uC2DD (JSON \uBC30\uC5F4\uB85C \uC751\uB2F5)
[
  {
    "title": "\uD504\uB85C\uC81D\uD2B8 \uC774\uB984",
    "why": "\uC911\uC694\uD55C \uC774\uC720",
    "next_action": "\uB2E4\uC74C \uD589\uB3D9"
  }
]
`,HU=`\uC774 \uC774\uBBF8\uC9C0\uC5D0\uC11C \uD14D\uC2A4\uD2B8\uB97C \uCD94\uCD9C\uD574\uB77C.
\uC190\uAE00\uC528, \uC778\uC1C4\uBB3C, \uC2A4\uCE94 \uBB38\uC11C \uB4F1 \uBAA8\uB4E0 \uD615\uD0DC\uC758 \uD14D\uC2A4\uD2B8\uB97C \uC77D\uC5B4\uB77C.

## \uADDC\uCE59
- \uC774\uBBF8\uC9C0\uC5D0 \uBCF4\uC774\uB294 \uBAA8\uB4E0 \uD14D\uC2A4\uD2B8\uB97C \uADF8\uB300\uB85C \uCD94\uCD9C
- \uC6D0\uBCF8\uC758 \uC904\uBC14\uAFC8\uACFC \uAD6C\uC870\uB97C \uCD5C\uB300\uD55C \uC720\uC9C0
- \uD45C\uAC00 \uC788\uC73C\uBA74 \uB9C8\uD06C\uB2E4\uC6B4 \uD45C\uB85C \uBCC0\uD658
- \uC77D\uC744 \uC218 \uC5C6\uB294 \uBD80\uBD84\uC740 [\uBD88\uBA85\uD655] \uC73C\uB85C \uD45C\uC2DC
- \uD14D\uC2A4\uD2B8\uB9CC \uCD9C\uB825\uD558\uACE0 \uB2E4\uB978 \uC124\uBA85\uC740 \uD558\uC9C0 \uB9C8\uB77C
`,jU=`\uB178\uD2B8 \uB0B4\uC6A9\uC744 \uBD84\uC11D\uD558\uC5EC \uD575\uC2EC \uD0A4\uC6CC\uB4DC 5-10\uAC1C\uB97C \uCD94\uCD9C\uD574\uB77C.

## \uADDC\uCE59
- \uAE30\uC220 \uC6A9\uC5B4, \uD504\uB85C\uC81D\uD2B8\uBA85, \uC8FC\uC694 \uAC1C\uB150 \uC704\uC8FC\uB85C \uCD94\uCD9C
- \uB108\uBB34 \uC77C\uBC18\uC801\uC778 \uB2E8\uC5B4 (\uC608: \uBC29\uBC95, \uB0B4\uC6A9, \uC815\uBCF4)\uB294 \uC81C\uC678
- \uD55C\uAE00/\uC601\uC5B4 \uBAA8\uB450 \uAC00\uB2A5
- \uBCF5\uD569 \uBA85\uC0AC\uB294 \uBD84\uB9AC\uD558\uC9C0 \uB9D0\uACE0 \uADF8\uB300\uB85C (\uC608: "\uC2A4\uB9C8\uD2B8\uD31C", "API\uD0A4")

## \uB178\uD2B8 \uB0B4\uC6A9
{content}

## \uCD9C\uB825 \uD615\uC2DD (JSON \uBC30\uC5F4\uB85C\uB9CC \uC751\uB2F5)
["\uD0A4\uC6CC\uB4DC1", "\uD0A4\uC6CC\uB4DC2", "\uD0A4\uC6CC\uB4DC3", ...]
`,qU=`\uC0C8 \uB178\uD2B8\uC640 \uAE30\uC874 \uB178\uD2B8 \uD6C4\uBCF4\uB4E4\uC758 \uAD00\uB828\uC131\uC744 \uBD84\uC11D\uD574\uB77C.

## \uC0C8 \uB178\uD2B8
\uC81C\uBAA9: {newTitle}
\uD0A4\uC6CC\uB4DC: {newKeywords}

## \uAE30\uC874 \uB178\uD2B8 \uD6C4\uBCF4\uB4E4
{candidates}

## \uADDC\uCE59
- \uAC01 \uD6C4\uBCF4 \uB178\uD2B8\uC5D0 \uB300\uD574 \uAD00\uB828\uB3C4 \uC810\uC218(0.0~1.0)\uB97C \uB9E4\uACA8\uB77C
- 0.5 \uC774\uC0C1\uC778 \uB178\uD2B8\uB9CC \uBC18\uD658
- \uCD5C\uB300 5\uAC1C\uAE4C\uC9C0\uB9CC \uBC18\uD658
- \uAD00\uB828\uB3C4 \uB192\uC740 \uC21C\uC73C\uB85C \uC815\uB82C
- \uAC01 \uC5F0\uACB0\uC758 "\uC774\uC720"\uB97C \uD55C \uC904\uB85C \uC124\uBA85\uD574\uB77C (\uC65C \uAD00\uB828\uC788\uB294\uAC00?)
- \uC5F0\uACB0 \uC720\uD615 \uBD84\uB958: \uD655\uC7A5|\uBC18\uBC15|\uC608\uC2DC|\uC804\uC81C|\uC751\uC6A9 \uC911 \uD558\uB098

## \uCD9C\uB825 \uD615\uC2DD (JSON \uBC30\uC5F4\uB85C\uB9CC \uC751\uB2F5)
[
  {
    "index": 0,
    "relevance": 0.8,
    "reason": "\uC774 \uB178\uD2B8\uC640 \uAD00\uB828\uC788\uB294 \uAD6C\uCCB4\uC801 \uC774\uC720",
    "type": "\uD655\uC7A5"
  }
]
`,KU=`\uC0C8 \uB178\uD2B8\uAC00 \uC5B4\uB5A4 \uD504\uB85C\uC81D\uD2B8\uC640 \uAD00\uB828\uC788\uB294\uC9C0 **\uC2E0\uC911\uD558\uAC8C** \uD310\uB2E8\uD574\uB77C.

## \uC0C8 \uB178\uD2B8
\uC81C\uBAA9: {noteTitle}
\uD0A4\uC6CC\uB4DC: {noteKeywords}

## \uAE30\uC874 \uD504\uB85C\uC81D\uD2B8 \uBAA9\uB85D
{projects}

## \uADDC\uCE59 (\uC5C4\uACA9\uD558\uAC8C \uC801\uC6A9)
- \uB178\uD2B8\uC758 **\uD575\uC2EC \uC8FC\uC81C**\uAC00 \uD504\uB85C\uC81D\uD2B8\uC758 **\uD575\uC2EC \uBAA9\uD45C/\uD65C\uB3D9**\uACFC **\uC9C1\uC811** \uAD00\uB828\uB420 \uB54C\uB9CC \uD504\uB85C\uC81D\uD2B8 \uC120\uD0DD
- \uB2E8\uC21C\uD788 \uD0A4\uC6CC\uB4DC\uAC00 \uACB9\uCE58\uB294 \uAC83\uC740 \uBD88\uCDA9\uBD84
- **\uD655\uC2E4\uD558\uC9C0 \uC54A\uC73C\uBA74 "None" \uBC18\uD658** (\uC798\uBABB\uB41C \uBD84\uB958\uBCF4\uB2E4 \uB098\uC74C)
- \uC77C\uBC18\uC801\uC778 \uCC38\uACE0\uC790\uB8CC, \uB274\uC2A4, \uC815\uBCF4\uC131 \uCF58\uD150\uCE20 \u2192 "None"
- \uC0C8\uB85C\uC6B4 \uD504\uB85C\uC81D\uD2B8\uB85C \uBCF4\uC774\uBA74 "NEW: \uD504\uB85C\uC81D\uD2B8\uBA85" \uD615\uC2DD\uC73C\uB85C \uBC18\uD658

## \uCD9C\uB825 \uD615\uC2DD (\uD504\uB85C\uC81D\uD2B8\uBA85\uB9CC \uC751\uB2F5)
\uD504\uB85C\uC81D\uD2B8\uBA85 \uB610\uB294 None \uB610\uB294 NEW: \uC0C8\uD504\uB85C\uC81D\uD2B8\uBA85
`,YU=`\uC720\uD29C\uBE0C \uC601\uC0C1\uC758 \uC790\uB9C9\uC744 \uBD84\uC11D\uD558\uC5EC \uC694\uC57D\uD574\uB77C.

## \uC790\uB9C9 \uB0B4\uC6A9
{content}

## \uADDC\uCE59
- \uC601\uC0C1\uC758 \uD575\uC2EC \uC8FC\uC81C\uB97C \uD30C\uC545\uD574\uB77C
- \uC8FC\uC694 \uB0B4\uC6A9\uC744 3-5\uBB38\uC7A5\uC73C\uB85C \uC694\uC57D\uD574\uB77C
- \uD575\uC2EC \uD3EC\uC778\uD2B8\uB97C 3-7\uAC1C\uC758 bullet point\uB85C \uC815\uB9AC\uD574\uB77C
- \uC804\uBB38 \uC6A9\uC5B4\uB098 \uC911\uC694\uD55C \uAC1C\uB150\uC740 \uADF8\uB300\uB85C \uC720\uC9C0\uD574\uB77C

## \uCD9C\uB825 \uD615\uC2DD (JSON\uC73C\uB85C \uC751\uB2F5)
{
  "title": "\uC601\uC0C1 \uB0B4\uC6A9\uC744 \uB300\uD45C\uD558\uB294 \uC81C\uBAA9",
  "summary": "3-5\uBB38\uC7A5 \uC694\uC57D",
  "keyPoints": ["\uD575\uC2EC \uD3EC\uC778\uD2B81", "\uD575\uC2EC \uD3EC\uC778\uD2B82", ...]
}
`,XU=`\uC6F9\uD398\uC774\uC9C0 \uBCF8\uBB38\uC744 \uBD84\uC11D\uD558\uC5EC \uC694\uC57D\uD574\uB77C.

## \uBCF8\uBB38 \uB0B4\uC6A9
{content}

## \uADDC\uCE59
- \uAE00\uC758 \uD575\uC2EC \uC8FC\uC81C\uB97C \uD30C\uC545\uD574\uB77C
- \uC8FC\uC694 \uB0B4\uC6A9\uC744 3-5\uBB38\uC7A5\uC73C\uB85C \uC694\uC57D\uD574\uB77C
- \uD575\uC2EC \uD3EC\uC778\uD2B8\uB97C 3-7\uAC1C\uC758 bullet point\uB85C \uC815\uB9AC\uD574\uB77C
- \uC804\uBB38 \uC6A9\uC5B4\uB098 \uC911\uC694\uD55C \uAC1C\uB150\uC740 \uADF8\uB300\uB85C \uC720\uC9C0\uD574\uB77C
- \uAD11\uACE0\uB098 \uAD00\uB828 \uC5C6\uB294 \uB0B4\uC6A9\uC740 \uBB34\uC2DC\uD574\uB77C

## \uCD9C\uB825 \uD615\uC2DD (JSON\uC73C\uB85C \uC751\uB2F5)
{
  "title": "\uB0B4\uC6A9\uC744 \uB300\uD45C\uD558\uB294 \uC81C\uBAA9",
  "summary": "3-5\uBB38\uC7A5 \uC694\uC57D",
  "keyPoints": ["\uD575\uC2EC \uD3EC\uC778\uD2B81", "\uD575\uC2EC \uD3EC\uC778\uD2B82", ...]
}
`,QU=`\uB108\uB294 \uBA54\uBAA8\uB97C \uBD84\uC11D\uD558\uC5EC \uD504\uB85C\uC81D\uD2B8/\uC8FC\uC81C\uBCC4\uB85C \uBD84\uB9AC\uD558\uB294 \uBE44\uC11C\uB2E4.
\uD558\uB098\uC758 \uBA54\uBAA8\uC5D0 \uC5EC\uB7EC \uC8FC\uC81C\uB098 \uD504\uB85C\uC81D\uD2B8 \uAD00\uB828 \uB0B4\uC6A9\uC774 \uC11E\uC5EC \uC788\uC744 \uC218 \uC788\uB2E4.
\uAC01\uAC01\uC744 \uB3C5\uB9BD\uC801\uC778 \uB178\uD2B8\uB85C \uBD84\uB9AC\uD574\uB77C.

## \uAE30\uC874 \uD504\uB85C\uC81D\uD2B8 \uBAA9\uB85D (\uCC38\uACE0\uC6A9)
{projects}

## \uBA54\uBAA8 \uB0B4\uC6A9
{content}

## \uBD84\uB9AC \uADDC\uCE59
- \uC11C\uB85C \uB2E4\uB978 \uD504\uB85C\uC81D\uD2B8/\uC8FC\uC81C\uB294 \uBC18\uB4DC\uC2DC \uBD84\uB9AC\uD574\uB77C
- \uD55C \uC904\uC9DC\uB9AC \uBA54\uBAA8\uB3C4 \uC758\uBBF8\uAC00 \uC788\uC73C\uBA74 \uBD84\uB9AC \uB300\uC0C1\uC774\uB2E4
- \uAD00\uB828 \uB0B4\uC6A9\uC740 \uD558\uB098\uB85C \uBB36\uC5B4\uB77C (\uACFC\uB3C4\uD55C \uBD84\uB9AC \uAE08\uC9C0)
- \uAC01 \uC139\uC158\uC5D0 \uC801\uC808\uD55C \uC81C\uBAA9\uC744 \uBD99\uC5EC\uB77C

## \uBD84\uB958 \uADDC\uCE59 (\uC5C4\uACA9\uD558\uAC8C \uC801\uC6A9)
- **project**: \uAE30\uC874 \uD504\uB85C\uC81D\uD2B8\uC758 **\uD575\uC2EC \uBAA9\uD45C/\uD65C\uB3D9**\uACFC **\uC9C1\uC811** \uAD00\uB828\uB41C \uB0B4\uC6A9\uB9CC
  - \uB2E8\uC21C\uD788 \uD0A4\uC6CC\uB4DC\uAC00 \uACB9\uCE58\uB294 \uAC83\uC740 \uBD88\uCDA9\uBD84
  - \uC608: "\uC2A4\uB9C8\uD2B8\uD31C" \uD504\uB85C\uC81D\uD2B8\uAC00 \uC788\uC5B4\uB3C4 "\uB18D\uC5C5 \uB274\uC2A4"\uB294 library
- **library**: \uC77C\uBC18 \uCC38\uACE0\uC790\uB8CC, \uB274\uC2A4, \uC815\uBCF4\uC131 \uCF58\uD150\uCE20 (**\uC560\uB9E4\uD558\uBA74 library**)
- **archive**: \uC644\uB8CC\uB41C \uB0B4\uC6A9, \uB354 \uC774\uC0C1 \uD544\uC694\uC5C6\uB294 \uAC83
- \uC0C8 \uD504\uB85C\uC81D\uD2B8: \uBA85\uD655\uD55C \uBAA9\uD45C\uAC00 \uC788\uB294 \uC0C8\uB85C\uC6B4 \uC791\uC5C5\uC77C \uB54C\uB9CC isNewProject: true

## \uCD9C\uB825 \uD615\uC2DD (JSON \uBC30\uC5F4\uB85C \uC751\uB2F5)
[
  {
    "title": "\uBD84\uB9AC\uB41C \uC139\uC158\uC758 \uC81C\uBAA9",
    "content": "\uD574\uB2F9 \uC139\uC158\uC758 \uC6D0\uBCF8 \uB0B4\uC6A9 (\uC815\uB9AC\uD558\uC9C0 \uB9D0\uACE0 \uADF8\uB300\uB85C)",
    "targetType": "project",
    "projectName": "\uC2A4\uB9C8\uD2B8\uD31C",
    "isNewProject": false,
    "keywords": ["\uC13C\uC11C", "\uB370\uC774\uD130", "IoT"],
    "isAtomic": false
  }
]

\uBD84\uB9AC\uD560 \uB0B4\uC6A9\uC774 \uC5C6\uC73C\uBA74 \uC804\uCCB4\uB97C \uD558\uB098\uC758 \uC139\uC158\uC73C\uB85C \uBC18\uD658\uD574\uB77C.
`,JU=`\uC8FC\uC81C\uC5D0 \uC18D\uD55C ZK \uB178\uD2B8\uB4E4\uC744 \uBD84\uC11D\uD558\uC5EC \uAD6C\uC870\uD654\uB41C \uC124\uBA85\uC744 \uC0DD\uC131\uD574\uB77C.

## \uC8FC\uC81C
{topic}

## \uB178\uD2B8 \uBAA9\uB85D
{notes}

## \uADDC\uCE59
- \uC8FC\uC81C\uC5D0 \uB300\uD55C 1-2\uC904 \uC124\uBA85 \uC791\uC131
- \uAC01 \uB178\uD2B8\uC758 \uC5ED\uD560/\uC704\uCE58 \uC124\uBA85 (\uAE30\uCD08, \uC2EC\uD654, \uC751\uC6A9, \uC608\uC2DC \uC911 \uD558\uB098)
- \uB178\uD2B8 \uAC04 \uAD00\uACC4 \uD45C\uC2DC (\uBC1C\uC804, \uAE30\uBC18, \uAD00\uB828 \uC911 \uD558\uB098)
- \uAD00\uB828 \uC8FC\uC81C 2-3\uAC1C \uC81C\uC548

## \uCD9C\uB825 \uD615\uC2DD (JSON\uC73C\uB85C \uC751\uB2F5)
{
  "description": "\uC8FC\uC81C\uC5D0 \uB300\uD55C 1-2\uC904 \uC124\uBA85",
  "notes": [
    {
      "title": "\uB178\uD2B8 \uC81C\uBAA9",
      "role": "\uAE30\uCD08",
      "relations": [{"target": "\uB2E4\uB978\uB178\uD2B8\uC81C\uBAA9", "type": "\uBC1C\uC804"}]
    }
  ],
  "relatedTopics": ["\uAD00\uB828\uC8FC\uC81C1", "\uAD00\uB828\uC8FC\uC81C2"]
}
`,ZU=`PDF/\uC774\uBBF8\uC9C0 \uBB38\uC11C \uB0B4\uC6A9\uC744 \uBD84\uC11D\uD558\uC5EC \uC694\uC57D\uD574\uB77C.

## \uBB38\uC11C \uB0B4\uC6A9
{content}

## \uADDC\uCE59
- \uBB38\uC11C\uC758 \uD575\uC2EC \uC8FC\uC81C\uB97C \uD30C\uC545\uD574\uB77C
- \uC8FC\uC694 \uB0B4\uC6A9\uC744 3-5\uBB38\uC7A5\uC73C\uB85C \uC694\uC57D\uD574\uB77C
- \uD575\uC2EC \uD3EC\uC778\uD2B8\uB97C 3-7\uAC1C\uC758 bullet point\uB85C \uC815\uB9AC\uD574\uB77C
- \uC804\uBB38 \uC6A9\uC5B4\uB098 \uC911\uC694\uD55C \uAC1C\uB150\uC740 \uADF8\uB300\uB85C \uC720\uC9C0\uD574\uB77C
- \uD398\uC774\uC9C0 \uAD6C\uBD84\uC740 \uBB34\uC2DC\uD558\uACE0 \uC804\uCCB4 \uB0B4\uC6A9\uC744 \uD1B5\uD569\uD574\uC11C \uBD84\uC11D\uD574\uB77C

## \uCD9C\uB825 \uD615\uC2DD (JSON\uC73C\uB85C \uC751\uB2F5)
{
  "title": "\uBB38\uC11C \uB0B4\uC6A9\uC744 \uB300\uD45C\uD558\uB294 \uC81C\uBAA9",
  "summary": "3-5\uBB38\uC7A5 \uC694\uC57D",
  "keyPoints": ["\uD575\uC2EC \uD3EC\uC778\uD2B81", "\uD575\uC2EC \uD3EC\uC778\uD2B82", ...]
}
`,e3=`PDF/\uC774\uBBF8\uC9C0 \uBB38\uC11C \uB0B4\uC6A9\uC744 \uBD84\uC11D\uD558\uC5EC \uC0C1\uC138\uD558\uAC8C \uC694\uC57D\uD574\uB77C.

## \uBB38\uC11C \uB0B4\uC6A9
{content}

## \uADDC\uCE59
- \uBB38\uC11C\uC758 \uD575\uC2EC \uC8FC\uC81C\uB97C \uD30C\uC545\uD574\uB77C
- \uC8FC\uC694 \uB0B4\uC6A9\uC744 8-15\uBB38\uC7A5\uC73C\uB85C **\uC0C1\uC138\uD558\uAC8C** \uC694\uC57D\uD574\uB77C
- \uD575\uC2EC \uD3EC\uC778\uD2B8\uB97C 10-20\uAC1C\uC758 bullet point\uB85C **\uBE60\uC9D0\uC5C6\uC774** \uC815\uB9AC\uD574\uB77C
- \uC804\uBB38 \uC6A9\uC5B4\uB098 \uC911\uC694\uD55C \uAC1C\uB150\uC740 \uADF8\uB300\uB85C \uC720\uC9C0\uD574\uB77C
- \uC138\uBD80 \uC0AC\uD56D, \uC608\uC2DC, \uC218\uCE58 \uB370\uC774\uD130\uAC00 \uC788\uC73C\uBA74 \uD3EC\uD568\uD574\uB77C
- \uD398\uC774\uC9C0 \uAD6C\uBD84\uC740 \uBB34\uC2DC\uD558\uACE0 \uC804\uCCB4 \uB0B4\uC6A9\uC744 \uD1B5\uD569\uD574\uC11C \uBD84\uC11D\uD574\uB77C

## \uCD9C\uB825 \uD615\uC2DD (JSON\uC73C\uB85C \uC751\uB2F5)
{
  "title": "\uBB38\uC11C \uB0B4\uC6A9\uC744 \uB300\uD45C\uD558\uB294 \uC81C\uBAA9",
  "summary": "8-15\uBB38\uC7A5 \uC0C1\uC138 \uC694\uC57D",
  "keyPoints": ["\uD575\uC2EC \uD3EC\uC778\uD2B81", "\uD575\uC2EC \uD3EC\uC778\uD2B82", ... (10-20\uAC1C)]
}
`,t3=`\uD68C\uC758 \uB179\uC74C\uC744 \uBD84\uC11D\uD558\uC5EC \uD68C\uC758\uB85D\uC744 \uC791\uC131\uD574\uB77C.

## \uADDC\uCE59
1. **\uC804\uC0AC(Transcription)**: \uC74C\uC131\uC744 \uD14D\uC2A4\uD2B8\uB85C \uBCC0\uD658. \uD654\uC790 \uAD6C\uBD84\uC774 \uAC00\uB2A5\uD558\uBA74 "\uD654\uC7901:", "\uD654\uC7902:" \uD615\uC2DD\uC73C\uB85C \uD45C\uC2DC
2. **\uC694\uC57D**: \uD68C\uC758 \uB0B4\uC6A9\uC744 3-5\uBB38\uC7A5\uC73C\uB85C \uC694\uC57D
3. **\uC561\uC158 \uC544\uC774\uD15C**: \uB204\uAC00 \uBB34\uC5C7\uC744 \uC5B8\uC81C\uAE4C\uC9C0 \uD560\uC9C0 \uCD94\uCD9C. \uBA85\uC2DC\uB418\uC9C0 \uC54A\uC740 \uD56D\uBAA9\uC740 null
4. **\uACB0\uC815\uC0AC\uD56D**: \uD68C\uC758\uC5D0\uC11C \uACB0\uC815\uB41C \uC0AC\uD56D\uB4E4
5. **\uB2E4\uC74C \uD68C\uC758 \uC548\uAC74**: \uD6C4\uC18D \uB17C\uC758\uAC00 \uD544\uC694\uD55C \uC8FC\uC81C

## \uCD9C\uB825 \uD615\uC2DD (JSON\uC73C\uB85C \uC751\uB2F5)
{
  "title": "\uD68C\uC758 \uC81C\uBAA9 (\uC8FC\uC81C \uAE30\uBC18\uC73C\uB85C \uC0DD\uC131)",
  "transcription": "\uC804\uCCB4 \uB300\uD654 \uB0B4\uC6A9 (\uD654\uC790 \uAD6C\uBD84 \uD3EC\uD568)",
  "summary": "3-5\uBB38\uC7A5 \uC694\uC57D",
  "actionItems": [
    {"task": "\uD560 \uC77C", "assignee": "\uB2F4\uB2F9\uC790 \uB610\uB294 null", "deadline": "\uAE30\uD55C \uB610\uB294 null"}
  ],
  "decisions": ["\uACB0\uC815\uC0AC\uD56D1", "\uACB0\uC815\uC0AC\uD56D2"],
  "nextAgenda": ["\uB2E4\uC74C \uC548\uAC741", "\uB2E4\uC74C \uC548\uAC742"]
}

\uC561\uC158 \uC544\uC774\uD15C, \uACB0\uC815\uC0AC\uD56D, \uB2E4\uC74C \uC548\uAC74\uC774 \uC5C6\uC73C\uBA74 \uBE48 \uBC30\uC5F4 []\uB85C \uBC18\uD658\uD574\uB77C.
`,n3=`\uB108\uB294 \uB098\uC758 \uC0DD\uC0B0\uC131 \uCF54\uCE58\uB2E4.
\uC8FC\uC5B4\uC9C4 \uAE30\uAC04 \uB3D9\uC548\uC758 \uC791\uC5C5 \uB0B4\uC6A9\uC744 \uBD84\uC11D\uD558\uC5EC \uD68C\uACE0 \uB9AC\uD3EC\uD2B8\uB97C \uC791\uC131\uD574\uB77C.

## \uAE30\uAC04
{period} ({dateRange})

## \uD504\uB85C\uC81D\uD2B8\uBCC4 \uC791\uC5C5 \uB0B4\uC6A9
{projectData}

## \uBD84\uC11D \uADDC\uCE59
1. \uC804\uCCB4 \uC694\uC57D: \uC774 \uAE30\uAC04\uC758 \uC791\uC5C5\uC744 2-3\uBB38\uC7A5\uC73C\uB85C \uC694\uC57D
2. \uC8FC\uC694 \uC8FC\uC81C: \uB2E4\uB8EC \uD575\uC2EC \uC8FC\uC81C 3-5\uAC1C \uCD94\uCD9C
3. \uC778\uC0AC\uC774\uD2B8: \uBC1C\uACAC\uD55C \uC810, \uBC30\uC6B4 \uC810, \uD328\uD134 3-5\uAC1C
4. \uB2E4\uC74C \uC561\uC158: \uD6C4\uC18D\uC73C\uB85C \uD574\uC57C \uD560 \uAD6C\uCCB4\uC801\uC778 \uD589\uB3D9 3-5\uAC1C
5. \uC791\uC5C5 \uD328\uD134: \uC791\uC5C5 \uBC29\uC2DD\uC5D0\uC11C \uBC1C\uACAC\uB41C \uD328\uD134 (\uC120\uD0DD)

## \uCD9C\uB825 \uD615\uC2DD (JSON\uC73C\uB85C \uC751\uB2F5)
{
  "summary": "\uC804\uCCB4 \uC694\uC57D (2-3\uBB38\uC7A5)",
  "mainTopics": ["\uC8FC\uC81C1", "\uC8FC\uC81C2", "\uC8FC\uC81C3"],
  "insights": ["\uC778\uC0AC\uC774\uD2B81", "\uC778\uC0AC\uC774\uD2B82", "\uC778\uC0AC\uC774\uD2B83"],
  "nextActions": ["\uC561\uC1581", "\uC561\uC1582", "\uC561\uC1583"],
  "patterns": "\uC791\uC5C5 \uD328\uD134 \uBD84\uC11D (\uC120\uD0DD, \uC5C6\uC73C\uBA74 null)"
}
`,s3=`\uB178\uD2B8 \uB0B4\uC6A9\uC5D0\uC11C \uC77C\uC815/\uD560\uC77C/\uC57D\uC18D\uC744 \uCD94\uCD9C\uD574\uB77C.

## \uB178\uD2B8 \uB0B4\uC6A9
{content}

## \uC624\uB298 \uB0A0\uC9DC
{today}

## \uCD94\uCD9C \uADDC\uCE59
- \uB0A0\uC9DC/\uC2DC\uAC04\uC774 \uC5B8\uAE09\uB41C \uBAA8\uB4E0 \uC77C\uC815 \uCD94\uCD9C
- \uC0C1\uB300\uC801 \uB0A0\uC9DC\uB97C \uC808\uB300 \uB0A0\uC9DC\uB85C \uBCC0\uD658:
  - "\uB0B4\uC77C" \u2192 \uC624\uB298 + 1\uC77C
  - "\uBAA8\uB808" \u2192 \uC624\uB298 + 2\uC77C
  - "\uB2E4\uC74C \uC8FC \uC6D4\uC694\uC77C" \u2192 \uB2E4\uC74C \uC8FC \uC6D4\uC694\uC77C \uB0A0\uC9DC
  - "\uC774\uBC88 \uC8FC \uAE08\uC694\uC77C" \u2192 \uC774\uBC88 \uC8FC \uAE08\uC694\uC77C \uB0A0\uC9DC
  - "\uB2E4\uC74C \uB2EC" \u2192 \uB2E4\uC74C \uB2EC 1\uC77C
- \uC2DC\uAC04\uC774 \uC5C6\uC73C\uBA74 time\uC744 null\uB85C
- type \uAD6C\uBD84:
  - "event": \uC57D\uC18D, \uBBF8\uD305, \uD68C\uC758, \uBC1C\uD45C, \uBC29\uBB38 \uB4F1 \uD2B9\uC815 \uC2DC\uC810\uC758 \uD65C\uB3D9
  - "task": \uB9C8\uAC10\uC77C, \uC81C\uCD9C, \uC644\uB8CC\uD574\uC57C \uD560 \uC77C

## \uCD9C\uB825 \uD615\uC2DD (JSON \uBC30\uC5F4)
[
  {
    "title": "\uC77C\uC815 \uC81C\uBAA9",
    "date": "2026-01-15",
    "time": "14:00",
    "type": "event"
  },
  {
    "title": "\uBCF4\uACE0\uC11C \uC81C\uCD9C",
    "date": "2026-01-17",
    "time": null,
    "type": "task"
  }
]

\uC77C\uC815\uC774 \uC5C6\uC73C\uBA74 \uBE48 \uBC30\uC5F4 [] \uBC18\uD658.
`;var See=1e3,Cee=3,Aee=2e3,vn="gemini-3-flash-preview",eM=class{constructor(e){this.lastRequestTime=0;this.minDelayMs=See;this.usageTracker=null;this.ai=new Xw({apiKey:e})}setUsageTracker(e){this.usageTracker=e}recordUsage(e,t,n){if(!this.usageTracker)return;let i=t.usageMetadata;i&&this.usageTracker.recordUsage(e,i.promptTokenCount??0,i.candidatesTokenCount??0,n)}async waitForRateLimit(){let t=Date.now()-this.lastRequestTime;if(t<this.minDelayMs){let n=this.minDelayMs-t;await this.delay(n)}this.lastRequestTime=Date.now()}delay(e){return new Promise(t=>setTimeout(t,e))}async callWithRetry(e,t=Cee){await this.waitForRateLimit();for(let n=0;n<=t;n++)try{return await e()}catch(i){if(i instanceof Error&&(i.message.includes("429")||i.message.includes("RESOURCE_EXHAUSTED")||i.message.includes("quota"))&&n<t){let o=Aee*Math.pow(2,n);console.log(`Rate limit hit, retrying in ${o/1e3}s... (attempt ${n+1}/${t})`),await this.delay(o),this.minDelayMs=Math.min(this.minDelayMs*1.5,5e3)}else throw i}throw new Error("Max retries exceeded")}async classifyProject(e,t,n){let i=t.length>0?t.map((l,c)=>`${c+1}. ${l}`).join(`
`):"(\uAE30\uC874 \uD504\uB85C\uC81D\uD2B8 \uC5C6\uC74C)",r=VU.replace("{projects}",i).replace("{content}",e);n&&(r=r.replace("## \uCD9C\uB825 \uD615\uC2DD",`${n}

## \uCD9C\uB825 \uD615\uC2DD`));let o=await this.callWithRetry(async()=>await this.ai.models.generateContent({model:vn,contents:r}));this.recordUsage("classify",o,vn);let a=o.text??"";return this.parseProjectResponse(a)}async extractZK(e){let t=GU.replace("{content}",e),n=await this.callWithRetry(async()=>await this.ai.models.generateContent({model:vn,contents:t}));this.recordUsage("zk",n,vn);let i=n.text??"";return this.parseZKResponse(i)}async getFocus(e){let t=WU.replace("{projects}",e),n=await this.callWithRetry(async()=>await this.ai.models.generateContent({model:vn,contents:t}));this.recordUsage("focus",n,vn);let i=n.text??"";return this.parseFocusResponse(i)}parseProjectResponse(e){let t=e.match(/\{[\s\S]*\}/);if(!t)throw new Error("\uD504\uB85C\uC81D\uD2B8 \uBD84\uB958 \uC751\uB2F5 \uD30C\uC2F1 \uC2E4\uD328: JSON \uC5C6\uC74C");try{let n=JSON.parse(t[0]);return{targetType:this.validateTargetType(n.targetType),projectName:n.projectName||void 0,isNewProject:n.isNewProject??!1,title:n.title||"Untitled",summary:n.summary||"",nextAction:n.nextAction||null}}catch{throw new Error("\uD504\uB85C\uC81D\uD2B8 \uBD84\uB958 \uC751\uB2F5 \uD30C\uC2F1 \uC2E4\uD328: "+e)}}parseZKResponse(e){let t=e.match(/\[[\s\S]*\]/);if(!t)return[];try{return JSON.parse(t[0]).map(i=>({title:i.title,body:i.body,keywords:i.keywords||[],importance:i.importance||"",relatedConcepts:i.relatedConcepts||[]}))}catch{return console.error("ZK \uC751\uB2F5 \uD30C\uC2F1 \uC2E4\uD328:",e),[]}}parseFocusResponse(e){let t=e.match(/\[[\s\S]*\]/);if(!t)return[];try{return JSON.parse(t[0]).map(i=>({title:i.title,why:i.why,nextAction:i.next_action}))}catch{return console.error("Focus \uC751\uB2F5 \uD30C\uC2F1 \uC2E4\uD328:",e),[]}}async extractTextFromImage(e,t){let n=await this.callWithRetry(async()=>await this.ai.models.generateContent({model:vn,contents:[{role:"user",parts:[{text:HU},{inlineData:{mimeType:t,data:e}}]}]}));return this.recordUsage("ocr",n,vn),n.text??""}async extractTextFromImages(e,t){let n=[];for(let i=0;i<e.length;i++){let r=e[i];t&&t(i+1,e.length);let o=await this.extractTextFromImage(r.base64,r.mimeType);n.push(o),i<e.length-1&&await this.delay(500)}return n}async extractKeywords(e){let t=jU.replace("{content}",e),n=await this.callWithRetry(async()=>await this.ai.models.generateContent({model:vn,contents:t}));this.recordUsage("other",n,vn);let i=n.text??"";return this.parseKeywordsResponse(i)}async findRelatedNotes(e,t,n){let i=qU.replace("{newTitle}",e).replace("{newKeywords}",t.join(", ")).replace("{candidates}",n),r=await this.callWithRetry(async()=>await this.ai.models.generateContent({model:vn,contents:i}));this.recordUsage("related",r,vn);let o=r.text??"";return this.parseRelatedNotesResponse(o)}async detectProject(e,t,n){if(n.length===0)return null;let i=KU.replace("{noteTitle}",e).replace("{noteKeywords}",t.join(", ")).replace("{projects}",n.map((l,c)=>`${c+1}. ${l}`).join(`
`)),r=await this.callWithRetry(async()=>await this.ai.models.generateContent({model:vn,contents:i}));this.recordUsage("classify",r,vn);let o=(r.text??"").trim();return o.toLowerCase()==="none"||o===""?null:o.startsWith("NEW:")?o:n.find(l=>o.toLowerCase().includes(l.toLowerCase()))||null}async summarizeContent(e,t){let i=(t==="youtube"?YU:XU).replace("{content}",e),r=await this.callWithRetry(async()=>await this.ai.models.generateContent({model:vn,contents:i}));this.recordUsage(t,r,vn);let o=r.text??"";return this.parseSummaryResponse(o)}async summarizePDF(e,t=!1){let i=(t?e3:ZU).replace("{content}",e),r=await this.callWithRetry(async()=>await this.ai.models.generateContent({model:vn,contents:i}));this.recordUsage("ocr",r,vn);let o=r.text??"";return this.parseSummaryResponse(o)}async analyzeYouTube(e){let t=`\uC774 YouTube \uC601\uC0C1\uC744 \uBD84\uC11D\uD574\uC8FC\uC138\uC694.

## \uADDC\uCE59
- \uC601\uC0C1\uC758 \uD575\uC2EC \uC8FC\uC81C\uB97C \uD30C\uC545\uD574\uB77C
- \uC8FC\uC694 \uB0B4\uC6A9\uC744 3-5\uBB38\uC7A5\uC73C\uB85C \uC694\uC57D\uD574\uB77C
- \uD575\uC2EC \uD3EC\uC778\uD2B8\uB97C 3-7\uAC1C\uC758 bullet point\uB85C \uC815\uB9AC\uD574\uB77C
- \uC804\uBB38 \uC6A9\uC5B4\uB098 \uC911\uC694\uD55C \uAC1C\uB150\uC740 \uADF8\uB300\uB85C \uC720\uC9C0\uD574\uB77C
- \uD654\uBA74\uC5D0 \uBCF4\uC774\uB294 \uD14D\uC2A4\uD2B8, \uC2AC\uB77C\uC774\uB4DC, \uCF54\uB4DC \uB4F1\uB3C4 \uCC38\uACE0\uD574\uB77C

## \uCD9C\uB825 \uD615\uC2DD (JSON\uC73C\uB85C \uC751\uB2F5)
{
  "title": "\uC601\uC0C1 \uB0B4\uC6A9\uC744 \uB300\uD45C\uD558\uB294 \uC81C\uBAA9",
  "summary": "3-5\uBB38\uC7A5 \uC694\uC57D",
  "keyPoints": ["\uD575\uC2EC \uD3EC\uC778\uD2B81", "\uD575\uC2EC \uD3EC\uC778\uD2B82", ...]
}`,n=await this.callWithRetry(async()=>await this.ai.models.generateContent({model:vn,contents:[{role:"user",parts:[{fileData:{mimeType:"video/mp4",fileUri:e}},{text:t}]}]}));this.recordUsage("youtube",n,vn);let i=n.text??"";return this.parseSummaryResponse(i)}async analyzeWebpage(e){let t=`\uB2E4\uC74C \uC6F9\uD398\uC774\uC9C0\uB97C \uBD84\uC11D\uD574\uC8FC\uC138\uC694: ${e}

## \uADDC\uCE59
- \uD398\uC774\uC9C0\uC758 \uD575\uC2EC \uB0B4\uC6A9\uC744 \uC815\uD655\uD788 \uD30C\uC545\uD574\uB77C
- \uACF5\uACE0/\uBAA8\uC9D1\uC774\uBA74: \uB300\uC0C1, \uC870\uAC74, \uAE30\uAC04, \uD61C\uD0DD\uC744 \uAD6C\uCCB4\uC801\uC73C\uB85C
- \uB274\uC2A4/\uAE30\uC0AC\uBA74: \uD575\uC2EC \uC0AC\uC2E4, \uBC30\uACBD, \uC758\uBBF8\uB97C
- \uC81C\uD488/\uC11C\uBE44\uC2A4\uBA74: \uC8FC\uC694 \uAE30\uB2A5, \uAC00\uACA9, \uD2B9\uC9D5\uC744
- \uC77C\uBC18 \uC815\uBCF4\uBA74: \uD575\uC2EC \uBA54\uC2DC\uC9C0\uC640 \uC911\uC694 \uC138\uBD80\uC0AC\uD56D\uC744
- \uC804\uBB38 \uC6A9\uC5B4, \uACE0\uC720\uBA85\uC0AC, \uC22B\uC790\uB294 \uADF8\uB300\uB85C \uC720\uC9C0\uD574\uB77C

## \uCD9C\uB825 \uD615\uC2DD (JSON\uC73C\uB85C \uC751\uB2F5)
{
  "title": "\uD398\uC774\uC9C0 \uB0B4\uC6A9\uC744 \uB300\uD45C\uD558\uB294 \uC81C\uBAA9",
  "summary": "3-5\uBB38\uC7A5 \uC694\uC57D (\uAD6C\uCCB4\uC801\uC778 \uC815\uBCF4 \uD3EC\uD568)",
  "keyPoints": ["\uD575\uC2EC \uD3EC\uC778\uD2B81", "\uD575\uC2EC \uD3EC\uC778\uD2B82", ...]
}`,n=await this.callWithRetry(async()=>await this.ai.models.generateContent({model:vn,contents:t,config:{tools:[{urlContext:{}}]}}));this.recordUsage("webpage",n,vn);let i=n.text??"";return this.parseSummaryResponse(i)}parseSummaryResponse(e){let t=e.match(/\{[\s\S]*\}/);if(!t)return{title:"Untitled",summary:e.trim(),keyPoints:[]};try{let n=JSON.parse(t[0]);return{title:n.title||"Untitled",summary:n.summary||"",keyPoints:Array.isArray(n.keyPoints)?n.keyPoints:[]}}catch{return console.error("\uC694\uC57D \uC751\uB2F5 \uD30C\uC2F1 \uC2E4\uD328:",e),{title:"Untitled",summary:e.trim(),keyPoints:[]}}}parseKeywordsResponse(e){let t=e.match(/\[[\s\S]*\]/);if(!t)return[];try{let n=JSON.parse(t[0]);return Array.isArray(n)?n.filter(i=>typeof i=="string"):[]}catch{return console.error("\uD0A4\uC6CC\uB4DC \uC751\uB2F5 \uD30C\uC2F1 \uC2E4\uD328:",e),[]}}parseRelatedNotesResponse(e){let t=e.match(/\[[\s\S]*\]/);if(!t)return[];try{let n=JSON.parse(t[0]);return Array.isArray(n)?n.filter(i=>typeof i=="object"&&typeof i.index=="number"&&typeof i.relevance=="number").filter(i=>i.relevance>=.5).sort((i,r)=>r.relevance-i.relevance).slice(0,5).map(i=>({index:i.index,relevance:i.relevance,reason:i.reason||"",type:i.type||""})):[]}catch{return console.error("\uAD00\uB828 \uB178\uD2B8 \uC751\uB2F5 \uD30C\uC2F1 \uC2E4\uD328:",e),[]}}async generateTopicStructure(e,t){let n=JU.replace("{topic}",e).replace("{notes}",t),i=await this.callWithRetry(async()=>await this.ai.models.generateContent({model:vn,contents:n}));this.recordUsage("zk",i,vn);let r=i.text??"";return this.parseTopicStructureResponse(r)}parseTopicStructureResponse(e){let t=e.match(/\{[\s\S]*\}/);if(!t)return{description:"",notes:[],relatedTopics:[]};try{let n=JSON.parse(t[0]);return{description:n.description||"",notes:Array.isArray(n.notes)?n.notes:[],relatedTopics:Array.isArray(n.relatedTopics)?n.relatedTopics:[]}}catch{return console.error("\uC8FC\uC81C \uAD6C\uC870 \uC751\uB2F5 \uD30C\uC2F1 \uC2E4\uD328:",e),{description:"",notes:[],relatedTopics:[]}}}async splitContent(e,t){let n=t.length>0?t.map((a,l)=>`${l+1}. ${a}`).join(`
`):"(\uAE30\uC874 \uD504\uB85C\uC81D\uD2B8 \uC5C6\uC74C)",i=QU.replace("{projects}",n).replace("{content}",e),r=await this.callWithRetry(async()=>await this.ai.models.generateContent({model:vn,contents:i}));this.recordUsage("split",r,vn);let o=r.text??"";return this.parseSplitResponse(o)}parseSplitResponse(e){let t=e.match(/\[[\s\S]*\]/);if(!t)return[];try{let n=JSON.parse(t[0]);return Array.isArray(n)?n.map(i=>({title:i.title||"Untitled",content:i.content||"",targetType:this.validateTargetType(i.targetType),project:i.projectName||void 0,isNewProject:i.isNewProject??!1,keywords:Array.isArray(i.keywords)?i.keywords:[],isAtomic:i.isAtomic??!1})):[]}catch{return console.error("\uC2A4\uB9C8\uD2B8 \uBD84\uB9AC \uC751\uB2F5 \uD30C\uC2F1 \uC2E4\uD328:",e),[]}}validateTargetType(e){return["project","library","archive"].includes(e)?e:"library"}async analyzeReview(e,t,n){let r={today:"\uC624\uB298",week:"\uC774\uBC88 \uC8FC",month:"\uC774\uBC88 \uB2EC",custom:"\uC0AC\uC6A9\uC790 \uC9C0\uC815 \uAE30\uAC04"}[e]||"\uAE30\uAC04",o=`${$s(t.start,"auto")} ~ ${$s(t.end,"auto")}`,a=n.map(u=>{let h=u.notes.map(p=>`  - ${p.title}${p.summary?`: ${p.summary}`:""}`).join(`
`);return`### ${u.projectName} (${u.noteCount}\uAC1C)
${h}`}).join(`

`),l=n3.replace("{period}",r).replace("{dateRange}",o).replace("{projectData}",a),c=await this.callWithRetry(async()=>await this.ai.models.generateContent({model:vn,contents:l}));this.recordUsage("review",c,vn);let d=c.text??"";return this.parseReviewAnalysisResponse(d)}parseReviewAnalysisResponse(e){let t=e.match(/\{[\s\S]*\}/);if(!t)return{summary:"\uBD84\uC11D \uACB0\uACFC\uB97C \uD30C\uC2F1\uD560 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4.",mainTopics:[],insights:[],nextActions:[]};try{let n=JSON.parse(t[0]);return{summary:n.summary||"",mainTopics:Array.isArray(n.mainTopics)?n.mainTopics:[],insights:Array.isArray(n.insights)?n.insights:[],nextActions:Array.isArray(n.nextActions)?n.nextActions:[],patterns:n.patterns||void 0}}catch{return console.error("\uD68C\uACE0 \uBD84\uC11D \uC751\uB2F5 \uD30C\uC2F1 \uC2E4\uD328:",e),{summary:"\uBD84\uC11D \uACB0\uACFC\uB97C \uD30C\uC2F1\uD560 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4.",mainTopics:[],insights:[],nextActions:[]}}}async analyzeMeeting(e,t,n){console.log("\uD68C\uC758 \uB179\uC74C \uC5C5\uB85C\uB4DC \uC911...",n);let i=await this.ai.files.upload({file:e,config:{mimeType:t}});console.log("\uC5C5\uB85C\uB4DC \uC644\uB8CC:",i.uri);let r=await this.callWithRetry(async()=>await this.ai.models.generateContent({model:vn,contents:[{role:"user",parts:[{fileData:{fileUri:i.uri,mimeType:i.mimeType}},{text:t3}]}]}));this.recordUsage("meeting",r,vn);let o=r.text??"";return this.parseMeetingResponse(o,n)}parseMeetingResponse(e,t){let n=e.match(/\{[\s\S]*\}/);if(!n)return{title:"\uD68C\uC758\uB85D",transcription:e.trim(),summary:"",actionItems:[],decisions:[],nextAgenda:[],sourceFile:t};try{let i=JSON.parse(n[0]);return{title:i.title||"\uD68C\uC758\uB85D",transcription:i.transcription||"",summary:i.summary||"",actionItems:Array.isArray(i.actionItems)?i.actionItems.map(r=>({task:r.task||"",assignee:r.assignee||null,deadline:r.deadline||null})):[],decisions:Array.isArray(i.decisions)?i.decisions:[],nextAgenda:Array.isArray(i.nextAgenda)?i.nextAgenda:[],sourceFile:t}}catch{return console.error("\uD68C\uC758\uB85D \uC751\uB2F5 \uD30C\uC2F1 \uC2E4\uD328:",e),{title:"\uD68C\uC758\uB85D",transcription:e.trim(),summary:"",actionItems:[],decisions:[],nextAgenda:[],sourceFile:t}}}async detectSchedules(e,t){let n=s3.replace("{content}",e).replace("{today}",t),i=await this.callWithRetry(async()=>await this.ai.models.generateContent({model:vn,contents:n}));this.recordUsage("schedule",i,vn);let r=i.text??"";return this.parseSchedulesResponse(r)}parseSchedulesResponse(e){let t=e.match(/\[[\s\S]*\]/);if(!t)return[];try{let n=JSON.parse(t[0]);return Array.isArray(n)?n.filter(i=>typeof i=="object"&&typeof i.title=="string"&&typeof i.date=="string"&&(i.type==="event"||i.type==="task")).map(i=>({title:i.title,date:i.date,time:i.time||null,type:i.type})):[]}catch{return console.error("\uC77C\uC815 \uAC10\uC9C0 \uC751\uB2F5 \uD30C\uC2F1 \uC2E4\uD328:",e),[]}}async generateContent(e){let t=await this.callWithRetry(async()=>await this.ai.models.generateContent({model:vn,contents:e}));this.recordUsage("chat",t,vn);let n=t.text??"";if(!n)throw new Error("\uC751\uB2F5 \uC0DD\uC131 \uC2E4\uD328");return n.trim()}async generateEmbedding(e,t="document"){if(!e||e.trim().length===0)return[];let n=e.length>8e3?e.substring(0,8e3):e,i=t==="query"?"RETRIEVAL_QUERY":"RETRIEVAL_DOCUMENT",r=await this.callWithRetry(async()=>await this.ai.models.embedContent({model:"gemini-embedding-001",contents:[{parts:[{text:n}]}],config:{taskType:i,outputDimensionality:768}}));if(this.usageTracker){let o=Math.ceil(n.length/4);this.usageTracker.recordUsage("embedding",o,0,"gemini-embedding-001")}return r.embeddings&&r.embeddings.length>0?r.embeddings[0].values||[]:[]}async batchGenerateEmbeddings(e,t){let n=[];for(let i=0;i<e.length;i++){t&&t(i+1,e.length);let r=await this.generateEmbedding(e[i]);n.push(r),i<e.length-1&&await this.delay(300)}return n}};var o0=require("obsidian");var Ete={};var hg={};hg.d=(s,e)=>{for(var t in e)hg.o(e,t)&&!hg.o(s,t)&&Object.defineProperty(s,t,{enumerable:!0,get:e[t]})};hg.o=(s,e)=>Object.prototype.hasOwnProperty.call(s,e);var jt=globalThis.pdfjsLib={};hg.d(jt,{AbortException:()=>ya,AnnotationEditorLayer:()=>mI,AnnotationEditorParamsType:()=>mn,AnnotationEditorType:()=>Qt,AnnotationEditorUIManager:()=>zu,AnnotationLayer:()=>jk,AnnotationMode:()=>Wl,ColorPicker:()=>cT,DOMSVGFactory:()=>Eg,DrawLayer:()=>yI,FeatureTest:()=>ui,GlobalWorkerOptions:()=>xo,ImageKind:()=>oM,InvalidPDFException:()=>gg,MissingPDFException:()=>Ou,OPS:()=>co,OutputScale:()=>vg,PDFDataRangeTransport:()=>QM,PDFDateString:()=>fg,PDFWorker:()=>op,PasswordResponses:()=>Ree,PermissionFlag:()=>Dee,PixelsPerInch:()=>Ac,RenderingCancelledException:()=>yg,TextLayer:()=>Mg,TouchManager:()=>zM,UnexpectedResponseException:()=>$f,Util:()=>At,VerbosityLevel:()=>XE,XfaLayer:()=>eT,build:()=>wte,createValidAbsoluteUrl:()=>Oee,fetchData:()=>e0,getDocument:()=>_te,getFilenameFromUrl:()=>Hee,getPdfFilenameFromUrl:()=>jee,getXfaPageViewport:()=>qee,isDataScheme:()=>t0,isPdfFile:()=>TI,noContextMenu:()=>So,normalizeUnicode:()=>Vee,setLayerDimensions:()=>$u,shadow:()=>an,stopEvent:()=>vr,version:()=>bte});var xi=typeof process=="object"&&process+""=="[object process]"&&!process.versions.nw&&!(process.versions.electron&&process.type&&process.type!=="browser"),y3=[1,0,0,1,0,0],oP=[.001,0,0,.001,0,0],Pee=1e7,rM=1.35,kee=.35,Cle=kee/rM,yr={ANY:1,DISPLAY:2,PRINT:4,SAVE:8,ANNOTATIONS_FORMS:16,ANNOTATIONS_STORAGE:32,ANNOTATIONS_DISABLE:64,IS_EDITING:128,OPLIST:256},Wl={DISABLE:0,ENABLE:1,ENABLE_FORMS:2,ENABLE_STORAGE:3},Iee="pdfjs_internal_editor_",Qt={DISABLE:-1,NONE:0,FREETEXT:3,HIGHLIGHT:9,STAMP:13,INK:15},mn={RESIZE:1,CREATE:2,FREETEXT_SIZE:11,FREETEXT_COLOR:12,FREETEXT_OPACITY:13,INK_COLOR:21,INK_THICKNESS:22,INK_OPACITY:23,HIGHLIGHT_COLOR:31,HIGHLIGHT_DEFAULT_COLOR:32,HIGHLIGHT_THICKNESS:33,HIGHLIGHT_FREE:34,HIGHLIGHT_SHOW_ALL:35,DRAW_STEP:41},Dee={PRINT:4,MODIFY_CONTENTS:8,COPY:16,MODIFY_ANNOTATIONS:32,FILL_INTERACTIVE_FORMS:256,COPY_FOR_ACCESSIBILITY:512,ASSEMBLE:1024,PRINT_HIGH_QUALITY:2048},_i={FILL:0,STROKE:1,FILL_STROKE:2,INVISIBLE:3,FILL_ADD_TO_PATH:4,STROKE_ADD_TO_PATH:5,FILL_STROKE_ADD_TO_PATH:6,ADD_TO_PATH:7,FILL_STROKE_MASK:3,ADD_TO_PATH_FLAG:4},oM={GRAYSCALE_1BPP:1,RGB_24BPP:2,RGBA_32BPP:3},Bs={TEXT:1,LINK:2,FREETEXT:3,LINE:4,SQUARE:5,CIRCLE:6,POLYGON:7,POLYLINE:8,HIGHLIGHT:9,UNDERLINE:10,SQUIGGLY:11,STRIKEOUT:12,STAMP:13,CARET:14,INK:15,POPUP:16,FILEATTACHMENT:17,SOUND:18,MOVIE:19,WIDGET:20,SCREEN:21,PRINTERMARK:22,TRAPNET:23,WATERMARK:24,THREED:25,REDACT:26};var qm={SOLID:1,DASHED:2,BEVELED:3,INSET:4,UNDERLINE:5};var XE={ERRORS:0,WARNINGS:1,INFOS:5},co={dependency:1,setLineWidth:2,setLineCap:3,setLineJoin:4,setMiterLimit:5,setDash:6,setRenderingIntent:7,setFlatness:8,setGState:9,save:10,restore:11,transform:12,moveTo:13,lineTo:14,curveTo:15,curveTo2:16,curveTo3:17,closePath:18,rectangle:19,stroke:20,closeStroke:21,fill:22,eoFill:23,fillStroke:24,eoFillStroke:25,closeFillStroke:26,closeEOFillStroke:27,endPath:28,clip:29,eoClip:30,beginText:31,endText:32,setCharSpacing:33,setWordSpacing:34,setHScale:35,setLeading:36,setFont:37,setTextRenderingMode:38,setTextRise:39,moveText:40,setLeadingMoveText:41,setTextMatrix:42,nextLine:43,showText:44,showSpacedText:45,nextLineShowText:46,nextLineSetSpacingShowText:47,setCharWidth:48,setCharWidthAndBounds:49,setStrokeColorSpace:50,setFillColorSpace:51,setStrokeColor:52,setStrokeColorN:53,setFillColor:54,setFillColorN:55,setStrokeGray:56,setFillGray:57,setStrokeRGBColor:58,setFillRGBColor:59,setStrokeCMYKColor:60,setFillCMYKColor:61,shadingFill:62,beginInlineImage:63,beginImageData:64,endInlineImage:65,paintXObject:66,markPoint:67,markPointProps:68,beginMarkedContent:69,beginMarkedContentProps:70,endMarkedContent:71,beginCompat:72,endCompat:73,paintFormXObjectBegin:74,paintFormXObjectEnd:75,beginGroup:76,endGroup:77,beginAnnotation:80,endAnnotation:81,paintImageMaskXObject:83,paintImageMaskXObjectGroup:84,paintImageXObject:85,paintInlineImageXObject:86,paintInlineImageXObjectGroup:87,paintImageXObjectRepeat:88,paintImageMaskXObjectRepeat:89,paintSolidColorImageMask:90,constructPath:91,setStrokeTransparent:92,setFillTransparent:93},Ree={NEED_PASSWORD:1,INCORRECT_PASSWORD:2},QE=XE.WARNINGS;function Fee(s){Number.isInteger(s)&&(QE=s)}function Lee(){return QE}function JE(s){QE>=XE.INFOS&&console.log(`Info: ${s}`)}function Jt(s){QE>=XE.WARNINGS&&console.log(`Warning: ${s}`)}function zn(s){throw new Error(s)}function Ds(s,e){s||zn(e)}function Nee(s){switch(s?.protocol){case"http:":case"https:":case"ftp:":case"mailto:":case"tel:":return!0;default:return!1}}function Oee(s,e=null,t=null){if(!s)return null;try{if(t&&typeof s=="string"&&(t.addDefaultProtocol&&s.startsWith("www.")&&s.match(/\./g)?.length>=2&&(s=`http://${s}`),t.tryConvertEncoding))try{s=Uee(s)}catch{}let n=e?new URL(s,e):new URL(s);if(Nee(n))return n}catch{}return null}function an(s,e,t,n=!1){return Object.defineProperty(s,e,{value:t,enumerable:!n,configurable:!0,writable:!1}),t}var Pc=function(){function e(t,n){this.message=t,this.name=n}return e.prototype=new Error,e.constructor=e,e}(),NM=class extends Pc{constructor(e,t){super(e,"PasswordException"),this.code=t}},pg=class extends Pc{constructor(e,t){super(e,"UnknownErrorException"),this.details=t}},gg=class extends Pc{constructor(e){super(e,"InvalidPDFException")}},Ou=class extends Pc{constructor(e){super(e,"MissingPDFException")}},$f=class extends Pc{constructor(e,t){super(e,"UnexpectedResponseException"),this.status=t}},aP=class extends Pc{constructor(e){super(e,"FormatError")}},ya=class extends Pc{constructor(e){super(e,"AbortException")}};function v3(s){(typeof s!="object"||s?.length===void 0)&&zn("Invalid argument for bytesToString");let e=s.length,t=8192;if(e<t)return String.fromCharCode.apply(null,s);let n=[];for(let i=0;i<e;i+=t){let r=Math.min(i+t,e),o=s.subarray(i,r);n.push(String.fromCharCode.apply(null,o))}return n.join("")}function ZE(s){typeof s!="string"&&zn("Invalid argument for stringToBytes");let e=s.length,t=new Uint8Array(e);for(let n=0;n<e;++n)t[n]=s.charCodeAt(n)&255;return t}function $ee(s){return String.fromCharCode(s>>24&255,s>>16&255,s>>8&255,s&255)}function wI(s){let e=Object.create(null);for(let[t,n]of s)e[t]=n;return e}function Bee(){let s=new Uint8Array(4);return s[0]=1,new Uint32Array(s.buffer,0,1)[0]===1}function zee(){try{return new Function(""),!0}catch{return!1}}var ui=class{static get isLittleEndian(){return an(this,"isLittleEndian",Bee())}static get isEvalSupported(){return an(this,"isEvalSupported",zee())}static get isOffscreenCanvasSupported(){return an(this,"isOffscreenCanvasSupported",typeof OffscreenCanvas<"u")}static get isImageDecoderSupported(){return an(this,"isImageDecoderSupported",typeof ImageDecoder<"u")}static get platform(){return typeof navigator<"u"&&typeof navigator?.platform=="string"?an(this,"platform",{isMac:navigator.platform.includes("Mac"),isWindows:navigator.platform.includes("Win"),isFirefox:typeof navigator?.userAgent=="string"&&navigator.userAgent.includes("Firefox")}):an(this,"platform",{isMac:!1,isWindows:!1,isFirefox:!1})}static get isCSSRoundSupported(){return an(this,"isCSSRoundSupported",globalThis.CSS?.supports?.("width: round(1.5px, 1px)"))}},tP=Array.from(Array(256).keys(),s=>s.toString(16).padStart(2,"0")),ap,aM,Pg,lP,At=class{static makeHexColor(e,t,n){return`#${tP[e]}${tP[t]}${tP[n]}`}static scaleMinMax(e,t){let n;e[0]?(e[0]<0&&(n=t[0],t[0]=t[2],t[2]=n),t[0]*=e[0],t[2]*=e[0],e[3]<0&&(n=t[1],t[1]=t[3],t[3]=n),t[1]*=e[3],t[3]*=e[3]):(n=t[0],t[0]=t[1],t[1]=n,n=t[2],t[2]=t[3],t[3]=n,e[1]<0&&(n=t[1],t[1]=t[3],t[3]=n),t[1]*=e[1],t[3]*=e[1],e[2]<0&&(n=t[0],t[0]=t[2],t[2]=n),t[0]*=e[2],t[2]*=e[2]),t[0]+=e[4],t[1]+=e[5],t[2]+=e[4],t[3]+=e[5]}static transform(e,t){return[e[0]*t[0]+e[2]*t[1],e[1]*t[0]+e[3]*t[1],e[0]*t[2]+e[2]*t[3],e[1]*t[2]+e[3]*t[3],e[0]*t[4]+e[2]*t[5]+e[4],e[1]*t[4]+e[3]*t[5]+e[5]]}static applyTransform(e,t){let n=e[0]*t[0]+e[1]*t[2]+t[4],i=e[0]*t[1]+e[1]*t[3]+t[5];return[n,i]}static applyInverseTransform(e,t){let n=t[0]*t[3]-t[1]*t[2],i=(e[0]*t[3]-e[1]*t[2]+t[2]*t[5]-t[4]*t[3])/n,r=(-e[0]*t[1]+e[1]*t[0]+t[4]*t[1]-t[5]*t[0])/n;return[i,r]}static getAxialAlignedBoundingBox(e,t){let n=this.applyTransform(e,t),i=this.applyTransform(e.slice(2,4),t),r=this.applyTransform([e[0],e[3]],t),o=this.applyTransform([e[2],e[1]],t);return[Math.min(n[0],i[0],r[0],o[0]),Math.min(n[1],i[1],r[1],o[1]),Math.max(n[0],i[0],r[0],o[0]),Math.max(n[1],i[1],r[1],o[1])]}static inverseTransform(e){let t=e[0]*e[3]-e[1]*e[2];return[e[3]/t,-e[1]/t,-e[2]/t,e[0]/t,(e[2]*e[5]-e[4]*e[3])/t,(e[4]*e[1]-e[5]*e[0])/t]}static singularValueDecompose2dScale(e){let t=[e[0],e[2],e[1],e[3]],n=e[0]*t[0]+e[1]*t[2],i=e[0]*t[1]+e[1]*t[3],r=e[2]*t[0]+e[3]*t[2],o=e[2]*t[1]+e[3]*t[3],a=(n+o)/2,l=Math.sqrt((n+o)**2-4*(n*o-r*i))/2,c=a+l||1,d=a-l||1;return[Math.sqrt(c),Math.sqrt(d)]}static normalizeRect(e){let t=e.slice(0);return e[0]>e[2]&&(t[0]=e[2],t[2]=e[0]),e[1]>e[3]&&(t[1]=e[3],t[3]=e[1]),t}static intersect(e,t){let n=Math.max(Math.min(e[0],e[2]),Math.min(t[0],t[2])),i=Math.min(Math.max(e[0],e[2]),Math.max(t[0],t[2]));if(n>i)return null;let r=Math.max(Math.min(e[1],e[3]),Math.min(t[1],t[3])),o=Math.min(Math.max(e[1],e[3]),Math.max(t[1],t[3]));return r>o?null:[n,r,i,o]}static bezierBoundingBox(e,t,n,i,r,o,a,l,c){return c?(c[0]=Math.min(c[0],e,a),c[1]=Math.min(c[1],t,l),c[2]=Math.max(c[2],e,a),c[3]=Math.max(c[3],t,l)):c=[Math.min(e,a),Math.min(t,l),Math.max(e,a),Math.max(t,l)],K(this,Pg,lP).call(this,e,n,r,a,t,i,o,l,3*(-e+3*(n-r)+a),6*(e-2*n+r),3*(n-e),c),K(this,Pg,lP).call(this,e,n,r,a,t,i,o,l,3*(-t+3*(i-o)+l),6*(t-2*i+o),3*(i-t),c),c}};ap=new WeakSet,aM=function(e,t,n,i,r,o,a,l,c,d){if(c<=0||c>=1)return;let u=1-c,h=c*c,p=h*c,f=u*(u*(u*e+3*c*t)+3*h*n)+p*i,_=u*(u*(u*r+3*c*o)+3*h*a)+p*l;d[0]=Math.min(d[0],f),d[1]=Math.min(d[1],_),d[2]=Math.max(d[2],f),d[3]=Math.max(d[3],_)},Pg=new WeakSet,lP=function(e,t,n,i,r,o,a,l,c,d,u,h){if(Math.abs(c)<1e-12){Math.abs(d)>=1e-12&&K(this,ap,aM).call(this,e,t,n,i,r,o,a,l,-u/d,h);return}let p=d**2-4*u*c;if(p<0)return;let f=Math.sqrt(p),_=2*c;K(this,ap,aM).call(this,e,t,n,i,r,o,a,l,(-d+f)/_,h),K(this,ap,aM).call(this,e,t,n,i,r,o,a,l,(-d-f)/_,h)},L(At,ap),L(At,Pg);function Uee(s){return decodeURIComponent(escape(s))}var nP=null,i3=null;function Vee(s){return nP||(nP=/([\u00a0\u00b5\u037e\u0eb3\u2000-\u200a\u202f\u2126\ufb00-\ufb04\ufb06\ufb20-\ufb36\ufb38-\ufb3c\ufb3e\ufb40-\ufb41\ufb43-\ufb44\ufb46-\ufba1\ufba4-\ufba9\ufbae-\ufbb1\ufbd3-\ufbdc\ufbde-\ufbe7\ufbea-\ufbf8\ufbfc-\ufbfd\ufc00-\ufc5d\ufc64-\ufcf1\ufcf5-\ufd3d\ufd88\ufdf4\ufdfa-\ufdfb\ufe71\ufe77\ufe79\ufe7b\ufe7d]+)|(\ufb05+)/gu,i3=new Map([["\uFB05","\u017Ft"]])),s.replaceAll(nP,(e,t,n)=>t?t.normalize("NFKC"):i3.get(n))}function Gee(){if(typeof crypto.randomUUID=="function")return crypto.randomUUID();let s=new Uint8Array(32);return crypto.getRandomValues(s),v3(s)}var MI="pdfjs_internal_id_";function Wee(s){return Uint8Array.prototype.toBase64?s.toBase64():btoa(v3(s))}typeof Promise.try!="function"&&(Promise.try=function(s,...e){return new Promise(t=>{t(s(...e))})});var Va="http://www.w3.org/2000/svg",_d=class _d{};Z(_d,"CSS",96),Z(_d,"PDF",72),Z(_d,"PDF_TO_CSS_UNITS",_d.CSS/_d.PDF);var Ac=_d;async function e0(s,e="text"){if(Qm(s,document.baseURI)){let t=await fetch(s);if(!t.ok)throw new Error(t.statusText);switch(e){case"arraybuffer":return t.arrayBuffer();case"blob":return t.blob();case"json":return t.json()}return t.text()}return new Promise((t,n)=>{let i=new XMLHttpRequest;i.open("GET",s,!0),i.responseType=e,i.onreadystatechange=()=>{if(i.readyState===XMLHttpRequest.DONE){if(i.status===200||i.status===0){switch(e){case"arraybuffer":case"blob":case"json":t(i.response);return}t(i.responseText);return}n(new Error(i.statusText))}},i.send(null)})}var _g=class s{constructor({viewBox:e,userUnit:t,scale:n,rotation:i,offsetX:r=0,offsetY:o=0,dontFlip:a=!1}){this.viewBox=e,this.userUnit=t,this.scale=n,this.rotation=i,this.offsetX=r,this.offsetY=o,n*=t;let l=(e[2]+e[0])/2,c=(e[3]+e[1])/2,d,u,h,p;switch(i%=360,i<0&&(i+=360),i){case 180:d=-1,u=0,h=0,p=1;break;case 90:d=0,u=1,h=1,p=0;break;case 270:d=0,u=-1,h=-1,p=0;break;case 0:d=1,u=0,h=0,p=-1;break;default:throw new Error("PageViewport: Invalid rotation, must be a multiple of 90 degrees.")}a&&(h=-h,p=-p);let f,_,b,y;d===0?(f=Math.abs(c-e[1])*n+r,_=Math.abs(l-e[0])*n+o,b=(e[3]-e[1])*n,y=(e[2]-e[0])*n):(f=Math.abs(l-e[0])*n+r,_=Math.abs(c-e[1])*n+o,b=(e[2]-e[0])*n,y=(e[3]-e[1])*n),this.transform=[d*n,u*n,h*n,p*n,f-d*n*l-h*n*c,_-u*n*l-p*n*c],this.width=b,this.height=y}get rawDims(){let{userUnit:e,viewBox:t}=this,n=t.map(i=>i*e);return an(this,"rawDims",{pageWidth:n[2]-n[0],pageHeight:n[3]-n[1],pageX:n[0],pageY:n[1]})}clone({scale:e=this.scale,rotation:t=this.rotation,offsetX:n=this.offsetX,offsetY:i=this.offsetY,dontFlip:r=!1}={}){return new s({viewBox:this.viewBox.slice(),userUnit:this.userUnit,scale:e,rotation:t,offsetX:n,offsetY:i,dontFlip:r})}convertToViewportPoint(e,t){return At.applyTransform([e,t],this.transform)}convertToViewportRectangle(e){let t=At.applyTransform([e[0],e[1]],this.transform),n=At.applyTransform([e[2],e[3]],this.transform);return[t[0],t[1],n[0],n[1]]}convertToPdfPoint(e,t){return At.applyInverseTransform([e,t],this.transform)}},yg=class extends Pc{constructor(e,t=0){super(e,"RenderingCancelledException"),this.extraDelay=t}};function t0(s){let e=s.length,t=0;for(;t<e&&s[t].trim()==="";)t++;return s.substring(t,t+5).toLowerCase()==="data:"}function TI(s){return typeof s=="string"&&/\.pdf$/i.test(s)}function Hee(s){return[s]=s.split(/[#?]/,1),s.substring(s.lastIndexOf("/")+1)}function jee(s,e="document.pdf"){if(typeof s!="string")return e;if(t0(s))return Jt('getPdfFilenameFromUrl: ignore "data:"-URL for performance reasons.'),e;let t=/^(?:(?:[^:]+:)?\/\/[^/]+)?([^?#]*)(\?[^#]*)?(#.*)?$/,n=/[^/?#=]+\.pdf\b(?!.*\.pdf\b)/i,i=t.exec(s),r=n.exec(i[1])||n.exec(i[2])||n.exec(i[3]);if(r&&(r=r[0],r.includes("%")))try{r=n.exec(decodeURIComponent(r))[0]}catch{}return r||e}var OM=class{constructor(){Z(this,"started",Object.create(null));Z(this,"times",[])}time(e){e in this.started&&Jt(`Timer is already running for ${e}`),this.started[e]=Date.now()}timeEnd(e){e in this.started||Jt(`Timer has not been started for ${e}`),this.times.push({name:e,start:this.started[e],end:Date.now()}),delete this.started[e]}toString(){let e=[],t=0;for(let{name:n}of this.times)t=Math.max(n.length,t);for(let{name:n,start:i,end:r}of this.times)e.push(`${n.padEnd(t)} ${r-i}ms
`);return e.join("")}};function Qm(s,e){try{let{protocol:t}=e?new URL(s,e):new URL(s);return t==="http:"||t==="https:"}catch{return!1}}function So(s){s.preventDefault()}function vr(s){s.preventDefault(),s.stopPropagation()}var kg,fg=class{static toDateObject(e){if(!e||typeof e!="string")return null;m(this,kg)||N(this,kg,new RegExp("^D:(\\d{4})(\\d{2})?(\\d{2})?(\\d{2})?(\\d{2})?(\\d{2})?([Z|+|-])?(\\d{2})?'?(\\d{2})?'?"));let t=m(this,kg).exec(e);if(!t)return null;let n=parseInt(t[1],10),i=parseInt(t[2],10);i=i>=1&&i<=12?i-1:0;let r=parseInt(t[3],10);r=r>=1&&r<=31?r:1;let o=parseInt(t[4],10);o=o>=0&&o<=23?o:0;let a=parseInt(t[5],10);a=a>=0&&a<=59?a:0;let l=parseInt(t[6],10);l=l>=0&&l<=59?l:0;let c=t[7]||"Z",d=parseInt(t[8],10);d=d>=0&&d<=23?d:0;let u=parseInt(t[9],10)||0;return u=u>=0&&u<=59?u:0,c==="-"?(o+=d,a+=u):c==="+"&&(o-=d,a-=u),new Date(Date.UTC(n,i,r,o,a,l))}};kg=new WeakMap,L(fg,kg,void 0);function qee(s,{scale:e=1,rotation:t=0}){let{width:n,height:i}=s.attributes.style,r=[0,0,parseInt(n),parseInt(i)];return new _g({viewBox:r,userUnit:1,scale:e,rotation:t})}function EI(s){if(s.startsWith("#")){let e=parseInt(s.slice(1),16);return[(e&16711680)>>16,(e&65280)>>8,e&255]}return s.startsWith("rgb(")?s.slice(4,-1).split(",").map(e=>parseInt(e)):s.startsWith("rgba(")?s.slice(5,-1).split(",").map(e=>parseInt(e)).slice(0,3):(Jt(`Not a valid color format: "${s}"`),[0,0,0])}function Kee(s){let e=document.createElement("span");e.style.visibility="hidden",document.body.append(e);for(let t of s.keys()){e.style.color=t;let n=window.getComputedStyle(e).color;s.set(t,EI(n))}e.remove()}function Zn(s){let{a:e,b:t,c:n,d:i,e:r,f:o}=s.getTransform();return[e,t,n,i,r,o]}function Qo(s){let{a:e,b:t,c:n,d:i,e:r,f:o}=s.getTransform().invertSelf();return[e,t,n,i,r,o]}function $u(s,e,t=!1,n=!0){if(e instanceof _g){let{pageWidth:i,pageHeight:r}=e.rawDims,{style:o}=s,a=ui.isCSSRoundSupported,l=`var(--scale-factor) * ${i}px`,c=`var(--scale-factor) * ${r}px`,d=a?`round(down, ${l}, var(--scale-round-x, 1px))`:`calc(${l})`,u=a?`round(down, ${c}, var(--scale-round-y, 1px))`:`calc(${c})`;!t||e.rotation%180===0?(o.width=d,o.height=u):(o.width=u,o.height=d)}n&&s.setAttribute("data-main-rotation",e.rotation)}var vg=class{constructor(){let e=window.devicePixelRatio||1;this.sx=e,this.sy=e}get scaled(){return this.sx!==1||this.sy!==1}get symmetric(){return this.sx===this.sy}},Hl,bd,uo,wd,Ig,Dg,hT,b3,pT,w3,fT,M3,lp,lM,mT,T3,Rg,dP,Ha=class Ha{constructor(e){L(this,pT);L(this,fT);L(this,lp);L(this,mT);L(this,Rg);L(this,Hl,null);L(this,bd,null);L(this,uo,void 0);L(this,wd,null);L(this,Ig,null);N(this,uo,e),m(Ha,Dg)||N(Ha,Dg,Object.freeze({freetext:"pdfjs-editor-remove-freetext-button",highlight:"pdfjs-editor-remove-highlight-button",ink:"pdfjs-editor-remove-ink-button",stamp:"pdfjs-editor-remove-stamp-button"}))}render(){let e=N(this,Hl,document.createElement("div"));e.classList.add("editToolbar","hidden"),e.setAttribute("role","toolbar");let t=m(this,uo)._uiManager._signal;e.addEventListener("contextmenu",So,{signal:t}),e.addEventListener("pointerdown",K(Ha,hT,b3),{signal:t});let n=N(this,wd,document.createElement("div"));n.className="buttons",e.append(n);let i=m(this,uo).toolbarPosition;if(i){let{style:r}=e,o=m(this,uo)._uiManager.direction==="ltr"?1-i[0]:i[0];r.insetInlineEnd=`${100*o}%`,r.top=`calc(${100*i[1]}% + var(--editor-toolbar-vert-offset))`}return K(this,mT,T3).call(this),e}get div(){return m(this,Hl)}hide(){m(this,Hl).classList.add("hidden"),m(this,bd)?.hideDropdown()}show(){m(this,Hl).classList.remove("hidden"),m(this,Ig)?.shown()}async addAltText(e){let t=await e.render();K(this,lp,lM).call(this,t),m(this,wd).prepend(t,m(this,Rg,dP)),N(this,Ig,e)}addColorPicker(e){N(this,bd,e);let t=e.renderButton();K(this,lp,lM).call(this,t),m(this,wd).prepend(t,m(this,Rg,dP))}remove(){m(this,Hl).remove(),m(this,bd)?.destroy(),N(this,bd,null)}};Hl=new WeakMap,bd=new WeakMap,uo=new WeakMap,wd=new WeakMap,Ig=new WeakMap,Dg=new WeakMap,hT=new WeakSet,b3=function(e){e.stopPropagation()},pT=new WeakSet,w3=function(e){m(this,uo)._focusEventsAllowed=!1,vr(e)},fT=new WeakSet,M3=function(e){m(this,uo)._focusEventsAllowed=!0,vr(e)},lp=new WeakSet,lM=function(e){let t=m(this,uo)._uiManager._signal;e.addEventListener("focusin",K(this,pT,w3).bind(this),{capture:!0,signal:t}),e.addEventListener("focusout",K(this,fT,M3).bind(this),{capture:!0,signal:t}),e.addEventListener("contextmenu",So,{signal:t})},mT=new WeakSet,T3=function(){let{editorType:e,_uiManager:t}=m(this,uo),n=document.createElement("button");n.className="delete",n.tabIndex=0,n.setAttribute("data-l10n-id",m(Ha,Dg)[e]),K(this,lp,lM).call(this,n),n.addEventListener("click",i=>{t.delete()},{signal:t._signal}),m(this,wd).append(n)},Rg=new WeakSet,dP=function(){let e=document.createElement("div");return e.className="divider",e},L(Ha,hT),L(Ha,Dg,null);var cP=Ha,Fg,Md,Td,gT,E3,_T,x3,yT,S3,uP=class{constructor(e){L(this,gT);L(this,_T);L(this,yT);L(this,Fg,null);L(this,Md,null);L(this,Td,void 0);N(this,Td,e)}show(e,t,n){let[i,r]=K(this,_T,x3).call(this,t,n),{style:o}=m(this,Md)||N(this,Md,K(this,gT,E3).call(this));e.append(m(this,Md)),o.insetInlineEnd=`${100*i}%`,o.top=`calc(${100*r}% + var(--editor-toolbar-vert-offset))`}hide(){m(this,Md).remove()}};Fg=new WeakMap,Md=new WeakMap,Td=new WeakMap,gT=new WeakSet,E3=function(){let e=N(this,Md,document.createElement("div"));e.className="editToolbar",e.setAttribute("role","toolbar"),e.addEventListener("contextmenu",So,{signal:m(this,Td)._signal});let t=N(this,Fg,document.createElement("div"));return t.className="buttons",e.append(t),K(this,yT,S3).call(this),e},_T=new WeakSet,x3=function(e,t){let n=0,i=0;for(let r of e){let o=r.y+r.height;if(o<n)continue;let a=r.x+(t?r.width:0);if(o>n){i=a,n=o;continue}t?a>i&&(i=a):a<i&&(i=a)}return[t?1-i:i,n]},yT=new WeakSet,S3=function(){let e=document.createElement("button");e.className="highlightButton",e.tabIndex=0,e.setAttribute("data-l10n-id","pdfjs-highlight-floating-button1");let t=document.createElement("span");e.append(t),t.className="visuallyHidden",t.setAttribute("data-l10n-id","pdfjs-highlight-floating-button-label");let n=m(this,Td)._signal;e.addEventListener("contextmenu",So,{signal:n}),e.addEventListener("click",()=>{m(this,Td).highlightSelection("floating_button")},{signal:n}),m(this,Fg).append(e)};function $M(s,e,t){for(let n of t)e.addEventListener(n,s[n].bind(s))}var vT,hP=class{constructor(){L(this,vT,0)}get id(){return`${Iee}${Ii(this,vT)._++}`}};vT=new WeakMap;var cp,Lg,bi,dp,cM,xI=class xI{constructor(){L(this,dp);L(this,cp,Gee());L(this,Lg,0);L(this,bi,null)}static get _isSVGFittingCanvas(){let e='data:image/svg+xml;charset=UTF-8,<svg viewBox="0 0 1 1" width="1" height="1" xmlns="http://www.w3.org/2000/svg"><rect width="1" height="1" style="fill:red;"/></svg>',n=new OffscreenCanvas(1,3).getContext("2d",{willReadFrequently:!0}),i=new Image;i.src=e;let r=i.decode().then(()=>(n.drawImage(i,0,0,1,1,0,0,1,3),new Uint32Array(n.getImageData(0,0,1,1).data.buffer)[0]===0));return an(this,"_isSVGFittingCanvas",r)}async getFromFile(e){let{lastModified:t,name:n,size:i,type:r}=e;return K(this,dp,cM).call(this,`${t}_${n}_${i}_${r}`,e)}async getFromUrl(e){return K(this,dp,cM).call(this,e,e)}async getFromBlob(e,t){let n=await t;return K(this,dp,cM).call(this,e,n)}async getFromId(e){m(this,bi)||N(this,bi,new Map);let t=m(this,bi).get(e);if(!t)return null;if(t.bitmap)return t.refCounter+=1,t;if(t.file)return this.getFromFile(t.file);if(t.blobPromise){let{blobPromise:n}=t;return delete t.blobPromise,this.getFromBlob(t.id,n)}return this.getFromUrl(t.url)}getFromCanvas(e,t){m(this,bi)||N(this,bi,new Map);let n=m(this,bi).get(e);if(n?.bitmap)return n.refCounter+=1,n;let i=new OffscreenCanvas(t.width,t.height);return i.getContext("2d").drawImage(t,0,0),n={bitmap:i.transferToImageBitmap(),id:`image_${m(this,cp)}_${Ii(this,Lg)._++}`,refCounter:1,isSvg:!1},m(this,bi).set(e,n),m(this,bi).set(n.id,n),n}getSvgUrl(e){let t=m(this,bi).get(e);return t?.isSvg?t.svgUrl:null}deleteId(e){m(this,bi)||N(this,bi,new Map);let t=m(this,bi).get(e);if(!t||(t.refCounter-=1,t.refCounter!==0))return;let{bitmap:n}=t;if(!t.url&&!t.file){let i=new OffscreenCanvas(n.width,n.height);i.getContext("bitmaprenderer").transferFromImageBitmap(n),t.blobPromise=i.convertToBlob()}n.close?.(),t.bitmap=null}isValidId(e){return e.startsWith(`image_${m(this,cp)}_`)}};cp=new WeakMap,Lg=new WeakMap,bi=new WeakMap,dp=new WeakSet,cM=async function(e,t){m(this,bi)||N(this,bi,new Map);let n=m(this,bi).get(e);if(n===null)return null;if(n?.bitmap)return n.refCounter+=1,n;try{n||(n={bitmap:null,id:`image_${m(this,cp)}_${Ii(this,Lg)._++}`,refCounter:0,isSvg:!1});let i;if(typeof t=="string"?(n.url=t,i=await e0(t,"blob")):t instanceof File?i=n.file=t:t instanceof Blob&&(i=t),i.type==="image/svg+xml"){let r=xI._isSVGFittingCanvas,o=new FileReader,a=new Image,l=new Promise((c,d)=>{a.onload=()=>{n.bitmap=a,n.isSvg=!0,c()},o.onload=async()=>{let u=n.svgUrl=o.result;a.src=await r?`${u}#svgView(preserveAspectRatio(none))`:u},a.onerror=o.onerror=d});o.readAsDataURL(i),await l}else n.bitmap=await createImageBitmap(i);n.refCounter=1}catch(i){Jt(i),n=null}return m(this,bi).set(e,n),n&&m(this,bi).set(n.id,n),n};var pP=xI,Ms,jl,Ng,os,fP=class{constructor(e=128){L(this,Ms,[]);L(this,jl,!1);L(this,Ng,void 0);L(this,os,-1);N(this,Ng,e)}add({cmd:e,undo:t,post:n,mustExec:i,type:r=NaN,overwriteIfSameType:o=!1,keepUndo:a=!1}){if(i&&e(),m(this,jl))return;let l={cmd:e,undo:t,post:n,type:r};if(m(this,os)===-1){m(this,Ms).length>0&&(m(this,Ms).length=0),N(this,os,0),m(this,Ms).push(l);return}if(o&&m(this,Ms)[m(this,os)].type===r){a&&(l.undo=m(this,Ms)[m(this,os)].undo),m(this,Ms)[m(this,os)]=l;return}let c=m(this,os)+1;c===m(this,Ng)?m(this,Ms).splice(0,1):(N(this,os,c),c<m(this,Ms).length&&m(this,Ms).splice(c)),m(this,Ms).push(l)}undo(){if(m(this,os)===-1)return;N(this,jl,!0);let{undo:e,post:t}=m(this,Ms)[m(this,os)];e(),t?.(),N(this,jl,!1),N(this,os,m(this,os)-1)}redo(){if(m(this,os)<m(this,Ms).length-1){N(this,os,m(this,os)+1),N(this,jl,!0);let{cmd:e,post:t}=m(this,Ms)[m(this,os)];e(),t?.(),N(this,jl,!1)}}hasSomethingToUndo(){return m(this,os)!==-1}hasSomethingToRedo(){return m(this,os)<m(this,Ms).length-1}cleanType(e){if(m(this,os)!==-1){for(let t=m(this,os);t>=0;t--)if(m(this,Ms)[t].type!==e){m(this,Ms).splice(t+1,m(this,os)-t),N(this,os,t);return}m(this,Ms).length=0,N(this,os,-1)}}destroy(){N(this,Ms,null)}};Ms=new WeakMap,jl=new WeakMap,Ng=new WeakMap,os=new WeakMap;var bT,C3,Bu=class{constructor(e){L(this,bT);this.buffer=[],this.callbacks=new Map,this.allKeys=new Set;let{isMac:t}=ui.platform;for(let[n,i,r={}]of e)for(let o of n){let a=o.startsWith("mac+");t&&a?(this.callbacks.set(o.slice(4),{callback:i,options:r}),this.allKeys.add(o.split("+").at(-1))):!t&&!a&&(this.callbacks.set(o,{callback:i,options:r}),this.allKeys.add(o.split("+").at(-1)))}}exec(e,t){if(!this.allKeys.has(t.key))return;let n=this.callbacks.get(K(this,bT,C3).call(this,t));if(!n)return;let{callback:i,options:{bubbles:r=!1,args:o=[],checker:a=null}}=n;a&&!a(e,t)||(i.bind(e,...o,t)(),r||vr(t))}};bT=new WeakSet,C3=function(e){e.altKey&&this.buffer.push("alt"),e.ctrlKey&&this.buffer.push("ctrl"),e.metaKey&&this.buffer.push("meta"),e.shiftKey&&this.buffer.push("shift"),this.buffer.push(e.key);let t=this.buffer.join("+");return this.buffer.length=0,t};var wT=class wT{get _colors(){let e=new Map([["CanvasText",null],["Canvas",null]]);return Kee(e),an(this,"_colors",e)}convert(e){let t=EI(e);if(!window.matchMedia("(forced-colors: active)").matches)return t;for(let[n,i]of this._colors)if(i.every((r,o)=>r===t[o]))return wT._colorsMapping.get(n);return t}getHexCode(e){let t=this._colors.get(e);return t?At.makeHexColor(...t):e}};Z(wT,"_colorsMapping",new Map([["CanvasText",[0,0,0]],["Canvas",[255,255,255]]]));var mP=wT,up,or,zs,ri,hp,qa,pp,Lr,ql,Ed,fp,xd,ea,ho,Sd,Og,$g,mp,Bg,ta,Kl,gp,Yl,na,MT,Xl,zg,Ql,Cd,Ug,Vg,Ys,Dn,Ka,Ad,Gg,Wg,Jl,sa,Ya,Hg,Nr,_p,dM,jg,gP,TT,A3,ET,P3,yp,uM,xT,k3,ST,I3,CT,D3,qg,_P,AT,R3,Kg,yP,Yg,vP,PT,F3,oi,Ri,po,Ga,kT,L3,IT,N3,Xg,bP,DT,O3,Pd,Jm,Qg,wP,sp=class sp{constructor(e,t,n,i,r,o,a,l,c,d,u,h,p){L(this,_p);L(this,jg);L(this,TT);L(this,ET);L(this,yp);L(this,xT);L(this,ST);L(this,CT);L(this,qg);L(this,AT);L(this,Kg);L(this,Yg);L(this,PT);L(this,oi);L(this,po);L(this,kT);L(this,IT);L(this,Xg);L(this,DT);L(this,Pd);L(this,Qg);L(this,up,new AbortController);L(this,or,null);L(this,zs,new Map);L(this,ri,new Map);L(this,hp,null);L(this,qa,null);L(this,pp,null);L(this,Lr,new fP);L(this,ql,null);L(this,Ed,null);L(this,fp,0);L(this,xd,new Set);L(this,ea,null);L(this,ho,null);L(this,Sd,new Set);Z(this,"_editorUndoBar",null);L(this,Og,!1);L(this,$g,!1);L(this,mp,!1);L(this,Bg,null);L(this,ta,null);L(this,Kl,null);L(this,gp,null);L(this,Yl,!1);L(this,na,null);L(this,MT,new hP);L(this,Xl,!1);L(this,zg,!1);L(this,Ql,null);L(this,Cd,null);L(this,Ug,null);L(this,Vg,null);L(this,Ys,Qt.NONE);L(this,Dn,new Set);L(this,Ka,null);L(this,Ad,null);L(this,Gg,null);L(this,Wg,{isEditing:!1,isEmpty:!0,hasSomethingToUndo:!1,hasSomethingToRedo:!1,hasSelectedEditor:!1,hasSelectedText:!1});L(this,Jl,[0,0]);L(this,sa,null);L(this,Ya,null);L(this,Hg,null);L(this,Nr,null);let f=this._signal=m(this,up).signal;N(this,Ya,e),N(this,Hg,t),N(this,hp,n),this._eventBus=i,i._on("editingaction",this.onEditingAction.bind(this),{signal:f}),i._on("pagechanging",this.onPageChanging.bind(this),{signal:f}),i._on("scalechanging",this.onScaleChanging.bind(this),{signal:f}),i._on("rotationchanging",this.onRotationChanging.bind(this),{signal:f}),i._on("setpreference",this.onSetPreference.bind(this),{signal:f}),i._on("switchannotationeditorparams",_=>this.updateParams(_.type,_.value),{signal:f}),K(this,xT,k3).call(this),K(this,PT,F3).call(this),K(this,qg,_P).call(this),N(this,qa,r.annotationStorage),N(this,Bg,r.filterFactory),N(this,Ad,o),N(this,gp,a||null),N(this,Og,l),N(this,$g,c),N(this,mp,d),N(this,Vg,u||null),this.viewParameters={realScale:Ac.PDF_TO_CSS_UNITS,rotation:0},this.isShiftKeyDown=!1,this._editorUndoBar=h||null,this._supportsPinchToZoom=p!==!1}static get _keyboardManager(){let e=sp.prototype,t=o=>m(o,Ya).contains(document.activeElement)&&document.activeElement.tagName!=="BUTTON"&&o.hasSomethingToControl(),n=(o,{target:a})=>{if(a instanceof HTMLInputElement){let{type:l}=a;return l!=="text"&&l!=="number"}return!0},i=this.TRANSLATE_SMALL,r=this.TRANSLATE_BIG;return an(this,"_keyboardManager",new Bu([[["ctrl+a","mac+meta+a"],e.selectAll,{checker:n}],[["ctrl+z","mac+meta+z"],e.undo,{checker:n}],[["ctrl+y","ctrl+shift+z","mac+meta+shift+z","ctrl+shift+Z","mac+meta+shift+Z"],e.redo,{checker:n}],[["Backspace","alt+Backspace","ctrl+Backspace","shift+Backspace","mac+Backspace","mac+alt+Backspace","mac+ctrl+Backspace","Delete","ctrl+Delete","shift+Delete","mac+Delete"],e.delete,{checker:n}],[["Enter","mac+Enter"],e.addNewEditorFromKeyboard,{checker:(o,{target:a})=>!(a instanceof HTMLButtonElement)&&m(o,Ya).contains(a)&&!o.isEnterHandled}],[[" ","mac+ "],e.addNewEditorFromKeyboard,{checker:(o,{target:a})=>!(a instanceof HTMLButtonElement)&&m(o,Ya).contains(document.activeElement)}],[["Escape","mac+Escape"],e.unselectAll],[["ArrowLeft","mac+ArrowLeft"],e.translateSelectedEditors,{args:[-i,0],checker:t}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],e.translateSelectedEditors,{args:[-r,0],checker:t}],[["ArrowRight","mac+ArrowRight"],e.translateSelectedEditors,{args:[i,0],checker:t}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],e.translateSelectedEditors,{args:[r,0],checker:t}],[["ArrowUp","mac+ArrowUp"],e.translateSelectedEditors,{args:[0,-i],checker:t}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],e.translateSelectedEditors,{args:[0,-r],checker:t}],[["ArrowDown","mac+ArrowDown"],e.translateSelectedEditors,{args:[0,i],checker:t}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],e.translateSelectedEditors,{args:[0,r],checker:t}]]))}destroy(){m(this,Nr)?.resolve(),N(this,Nr,null),m(this,up)?.abort(),N(this,up,null),this._signal=null;for(let e of m(this,ri).values())e.destroy();m(this,ri).clear(),m(this,zs).clear(),m(this,Sd).clear(),N(this,or,null),m(this,Dn).clear(),m(this,Lr).destroy(),m(this,hp)?.destroy(),m(this,na)?.hide(),N(this,na,null),m(this,ta)&&(clearTimeout(m(this,ta)),N(this,ta,null)),m(this,sa)&&(clearTimeout(m(this,sa)),N(this,sa,null)),this._editorUndoBar?.destroy()}combinedSignal(e){return AbortSignal.any([this._signal,e.signal])}get mlManager(){return m(this,Vg)}get useNewAltTextFlow(){return m(this,$g)}get useNewAltTextWhenAddingImage(){return m(this,mp)}get hcmFilter(){return an(this,"hcmFilter",m(this,Ad)?m(this,Bg).addHCMFilter(m(this,Ad).foreground,m(this,Ad).background):"none")}get direction(){return an(this,"direction",getComputedStyle(m(this,Ya)).direction)}get highlightColors(){return an(this,"highlightColors",m(this,gp)?new Map(m(this,gp).split(",").map(e=>e.split("=").map(t=>t.trim()))):null)}get highlightColorNames(){return an(this,"highlightColorNames",this.highlightColors?new Map(Array.from(this.highlightColors,e=>e.reverse())):null)}setCurrentDrawingSession(e){e?(this.unselectAll(),this.disableUserSelect(!0)):this.disableUserSelect(!1),N(this,Ed,e)}setMainHighlightColorPicker(e){N(this,Ug,e)}editAltText(e,t=!1){m(this,hp)?.editAltText(this,e,t)}switchToMode(e,t){this._eventBus.on("annotationeditormodechanged",t,{once:!0,signal:this._signal}),this._eventBus.dispatch("showannotationeditorui",{source:this,mode:e})}setPreference(e,t){this._eventBus.dispatch("setpreference",{source:this,name:e,value:t})}onSetPreference({name:e,value:t}){switch(e){case"enableNewAltTextWhenAddingImage":N(this,mp,t);break}}onPageChanging({pageNumber:e}){N(this,fp,e-1)}focusMainContainer(){m(this,Ya).focus()}findParent(e,t){for(let n of m(this,ri).values()){let{x:i,y:r,width:o,height:a}=n.div.getBoundingClientRect();if(e>=i&&e<=i+o&&t>=r&&t<=r+a)return n}return null}disableUserSelect(e=!1){m(this,Hg).classList.toggle("noUserSelect",e)}addShouldRescale(e){m(this,Sd).add(e)}removeShouldRescale(e){m(this,Sd).delete(e)}onScaleChanging({scale:e}){this.commitOrRemove(),this.viewParameters.realScale=e*Ac.PDF_TO_CSS_UNITS;for(let t of m(this,Sd))t.onScaleChanging();m(this,Ed)?.onScaleChanging()}onRotationChanging({pagesRotation:e}){this.commitOrRemove(),this.viewParameters.rotation=e}highlightSelection(e=""){let t=document.getSelection();if(!t||t.isCollapsed)return;let{anchorNode:n,anchorOffset:i,focusNode:r,focusOffset:o}=t,a=t.toString(),c=K(this,_p,dM).call(this,t).closest(".textLayer"),d=this.getSelectionBoxes(c);if(!d)return;t.empty();let u=K(this,jg,gP).call(this,c),h=m(this,Ys)===Qt.NONE,p=()=>{u?.createAndAddNewEditor({x:0,y:0},!1,{methodOfCreation:e,boxes:d,anchorNode:n,anchorOffset:i,focusNode:r,focusOffset:o,text:a}),h&&this.showAllEditors("highlight",!0,!0)};if(h){this.switchToMode(Qt.HIGHLIGHT,p);return}p()}addToAnnotationStorage(e){!e.isEmpty()&&m(this,qa)&&!m(this,qa).has(e.id)&&m(this,qa).setValue(e.id,e)}blur(){if(this.isShiftKeyDown=!1,m(this,Yl)&&(N(this,Yl,!1),K(this,yp,uM).call(this,"main_toolbar")),!this.hasSelection)return;let{activeElement:e}=document;for(let t of m(this,Dn))if(t.div.contains(e)){N(this,Cd,[t,e]),t._focusEventsAllowed=!1;break}}focus(){if(!m(this,Cd))return;let[e,t]=m(this,Cd);N(this,Cd,null),t.addEventListener("focusin",()=>{e._focusEventsAllowed=!0},{once:!0,signal:this._signal}),t.focus()}addEditListeners(){K(this,qg,_P).call(this),K(this,Kg,yP).call(this)}removeEditListeners(){K(this,AT,R3).call(this),K(this,Yg,vP).call(this)}dragOver(e){for(let{type:t}of e.dataTransfer.items)for(let n of m(this,ho))if(n.isHandlingMimeForPasting(t)){e.dataTransfer.dropEffect="copy",e.preventDefault();return}}drop(e){for(let t of e.dataTransfer.items)for(let n of m(this,ho))if(n.isHandlingMimeForPasting(t.type)){n.paste(t,this.currentLayer),e.preventDefault();return}}copy(e){if(e.preventDefault(),m(this,or)?.commitOrRemove(),!this.hasSelection)return;let t=[];for(let n of m(this,Dn)){let i=n.serialize(!0);i&&t.push(i)}t.length!==0&&e.clipboardData.setData("application/pdfjs",JSON.stringify(t))}cut(e){this.copy(e),this.delete()}async paste(e){e.preventDefault();let{clipboardData:t}=e;for(let r of t.items)for(let o of m(this,ho))if(o.isHandlingMimeForPasting(r.type)){o.paste(r,this.currentLayer);return}let n=t.getData("application/pdfjs");if(!n)return;try{n=JSON.parse(n)}catch(r){Jt(`paste: "${r.message}".`);return}if(!Array.isArray(n))return;this.unselectAll();let i=this.currentLayer;try{let r=[];for(let l of n){let c=await i.deserialize(l);if(!c)return;r.push(c)}let o=()=>{for(let l of r)K(this,Xg,bP).call(this,l);K(this,Qg,wP).call(this,r)},a=()=>{for(let l of r)l.remove()};this.addCommands({cmd:o,undo:a,mustExec:!0})}catch(r){Jt(`paste: "${r.message}".`)}}keydown(e){!this.isShiftKeyDown&&e.key==="Shift"&&(this.isShiftKeyDown=!0),m(this,Ys)!==Qt.NONE&&!this.isEditorHandlingKeyboard&&sp._keyboardManager.exec(this,e)}keyup(e){this.isShiftKeyDown&&e.key==="Shift"&&(this.isShiftKeyDown=!1,m(this,Yl)&&(N(this,Yl,!1),K(this,yp,uM).call(this,"main_toolbar")))}onEditingAction({name:e}){switch(e){case"undo":case"redo":case"delete":case"selectAll":this[e]();break;case"highlightSelection":this.highlightSelection("context_menu");break}}setEditingState(e){e?(K(this,ST,I3).call(this),K(this,Kg,yP).call(this),K(this,oi,Ri).call(this,{isEditing:m(this,Ys)!==Qt.NONE,isEmpty:K(this,Pd,Jm).call(this),hasSomethingToUndo:m(this,Lr).hasSomethingToUndo(),hasSomethingToRedo:m(this,Lr).hasSomethingToRedo(),hasSelectedEditor:!1})):(K(this,CT,D3).call(this),K(this,Yg,vP).call(this),K(this,oi,Ri).call(this,{isEditing:!1}),this.disableUserSelect(!1))}registerEditorTypes(e){if(!m(this,ho)){N(this,ho,e);for(let t of m(this,ho))K(this,po,Ga).call(this,t.defaultPropertiesToUpdate)}}getId(){return m(this,MT).id}get currentLayer(){return m(this,ri).get(m(this,fp))}getLayer(e){return m(this,ri).get(e)}get currentPageIndex(){return m(this,fp)}addLayer(e){m(this,ri).set(e.pageIndex,e),m(this,Xl)?e.enable():e.disable()}removeLayer(e){m(this,ri).delete(e.pageIndex)}async updateMode(e,t=null,n=!1){if(m(this,Ys)!==e&&!(m(this,Nr)&&(await m(this,Nr).promise,!m(this,Nr)))){if(N(this,Nr,Promise.withResolvers()),N(this,Ys,e),e===Qt.NONE){this.setEditingState(!1),K(this,IT,N3).call(this),this._editorUndoBar?.hide(),m(this,Nr).resolve();return}this.setEditingState(!0),await K(this,kT,L3).call(this),this.unselectAll();for(let i of m(this,ri).values())i.updateMode(e);if(!t){n&&this.addNewEditorFromKeyboard(),m(this,Nr).resolve();return}for(let i of m(this,zs).values())i.annotationElementId===t?(this.setSelected(i),i.enterInEditMode()):i.unselect();m(this,Nr).resolve()}}addNewEditorFromKeyboard(){this.currentLayer.canCreateNewEmptyEditor()&&this.currentLayer.addNewEditor()}updateToolbar(e){e!==m(this,Ys)&&this._eventBus.dispatch("switchannotationeditormode",{source:this,mode:e})}updateParams(e,t){if(m(this,ho)){switch(e){case mn.CREATE:this.currentLayer.addNewEditor();return;case mn.HIGHLIGHT_DEFAULT_COLOR:m(this,Ug)?.updateColor(t);break;case mn.HIGHLIGHT_SHOW_ALL:this._eventBus.dispatch("reporttelemetry",{source:this,details:{type:"editing",data:{type:"highlight",action:"toggle_visibility"}}}),(m(this,Gg)||N(this,Gg,new Map)).set(e,t),this.showAllEditors("highlight",t);break}for(let n of m(this,Dn))n.updateParams(e,t);for(let n of m(this,ho))n.updateDefaultParams(e,t)}}showAllEditors(e,t,n=!1){for(let r of m(this,zs).values())r.editorType===e&&r.show(t);(m(this,Gg)?.get(mn.HIGHLIGHT_SHOW_ALL)??!0)!==t&&K(this,po,Ga).call(this,[[mn.HIGHLIGHT_SHOW_ALL,t]])}enableWaiting(e=!1){if(m(this,zg)!==e){N(this,zg,e);for(let t of m(this,ri).values())e?t.disableClick():t.enableClick(),t.div.classList.toggle("waiting",e)}}getEditors(e){let t=[];for(let n of m(this,zs).values())n.pageIndex===e&&t.push(n);return t}getEditor(e){return m(this,zs).get(e)}addEditor(e){m(this,zs).set(e.id,e)}removeEditor(e){e.div.contains(document.activeElement)&&(m(this,ta)&&clearTimeout(m(this,ta)),N(this,ta,setTimeout(()=>{this.focusMainContainer(),N(this,ta,null)},0))),m(this,zs).delete(e.id),this.unselect(e),(!e.annotationElementId||!m(this,xd).has(e.annotationElementId))&&m(this,qa)?.remove(e.id)}addDeletedAnnotationElement(e){m(this,xd).add(e.annotationElementId),this.addChangedExistingAnnotation(e),e.deleted=!0}isDeletedAnnotationElement(e){return m(this,xd).has(e)}removeDeletedAnnotationElement(e){m(this,xd).delete(e.annotationElementId),this.removeChangedExistingAnnotation(e),e.deleted=!1}setActiveEditor(e){m(this,or)!==e&&(N(this,or,e),e&&K(this,po,Ga).call(this,e.propertiesToUpdate))}updateUI(e){m(this,DT,O3)===e&&K(this,po,Ga).call(this,e.propertiesToUpdate)}updateUIForDefaultProperties(e){K(this,po,Ga).call(this,e.defaultPropertiesToUpdate)}toggleSelected(e){if(m(this,Dn).has(e)){m(this,Dn).delete(e),e.unselect(),K(this,oi,Ri).call(this,{hasSelectedEditor:this.hasSelection});return}m(this,Dn).add(e),e.select(),K(this,po,Ga).call(this,e.propertiesToUpdate),K(this,oi,Ri).call(this,{hasSelectedEditor:!0})}setSelected(e){m(this,Ed)?.commitOrRemove();for(let t of m(this,Dn))t!==e&&t.unselect();m(this,Dn).clear(),m(this,Dn).add(e),e.select(),K(this,po,Ga).call(this,e.propertiesToUpdate),K(this,oi,Ri).call(this,{hasSelectedEditor:!0})}isSelected(e){return m(this,Dn).has(e)}get firstSelectedEditor(){return m(this,Dn).values().next().value}unselect(e){e.unselect(),m(this,Dn).delete(e),K(this,oi,Ri).call(this,{hasSelectedEditor:this.hasSelection})}get hasSelection(){return m(this,Dn).size!==0}get isEnterHandled(){return m(this,Dn).size===1&&this.firstSelectedEditor.isEnterHandled}undo(){m(this,Lr).undo(),K(this,oi,Ri).call(this,{hasSomethingToUndo:m(this,Lr).hasSomethingToUndo(),hasSomethingToRedo:!0,isEmpty:K(this,Pd,Jm).call(this)}),this._editorUndoBar?.hide()}redo(){m(this,Lr).redo(),K(this,oi,Ri).call(this,{hasSomethingToUndo:!0,hasSomethingToRedo:m(this,Lr).hasSomethingToRedo(),isEmpty:K(this,Pd,Jm).call(this)})}addCommands(e){m(this,Lr).add(e),K(this,oi,Ri).call(this,{hasSomethingToUndo:!0,hasSomethingToRedo:!1,isEmpty:K(this,Pd,Jm).call(this)})}cleanUndoStack(e){m(this,Lr).cleanType(e)}delete(){this.commitOrRemove();let e=this.currentLayer?.endDrawingSession(!0);if(!this.hasSelection&&!e)return;let t=e?[e]:[...m(this,Dn)],n=()=>{this._editorUndoBar?.show(i,t.length===1?t[0].editorType:t.length);for(let r of t)r.remove()},i=()=>{for(let r of t)K(this,Xg,bP).call(this,r)};this.addCommands({cmd:n,undo:i,mustExec:!0})}commitOrRemove(){m(this,or)?.commitOrRemove()}hasSomethingToControl(){return m(this,or)||this.hasSelection}selectAll(){for(let e of m(this,Dn))e.commit();K(this,Qg,wP).call(this,m(this,zs).values())}unselectAll(){if(!(m(this,or)&&(m(this,or).commitOrRemove(),m(this,Ys)!==Qt.NONE))&&!m(this,Ed)?.commitOrRemove()&&this.hasSelection){for(let e of m(this,Dn))e.unselect();m(this,Dn).clear(),K(this,oi,Ri).call(this,{hasSelectedEditor:!1})}}translateSelectedEditors(e,t,n=!1){if(n||this.commitOrRemove(),!this.hasSelection)return;m(this,Jl)[0]+=e,m(this,Jl)[1]+=t;let[i,r]=m(this,Jl),o=[...m(this,Dn)],a=1e3;m(this,sa)&&clearTimeout(m(this,sa)),N(this,sa,setTimeout(()=>{N(this,sa,null),m(this,Jl)[0]=m(this,Jl)[1]=0,this.addCommands({cmd:()=>{for(let l of o)m(this,zs).has(l.id)&&l.translateInPage(i,r)},undo:()=>{for(let l of o)m(this,zs).has(l.id)&&l.translateInPage(-i,-r)},mustExec:!1})},a));for(let l of o)l.translateInPage(e,t)}setUpDragSession(){if(this.hasSelection){this.disableUserSelect(!0),N(this,ea,new Map);for(let e of m(this,Dn))m(this,ea).set(e,{savedX:e.x,savedY:e.y,savedPageIndex:e.pageIndex,newX:0,newY:0,newPageIndex:-1})}}endDragSession(){if(!m(this,ea))return!1;this.disableUserSelect(!1);let e=m(this,ea);N(this,ea,null);let t=!1;for(let[{x:i,y:r,pageIndex:o},a]of e)a.newX=i,a.newY=r,a.newPageIndex=o,t||(t=i!==a.savedX||r!==a.savedY||o!==a.savedPageIndex);if(!t)return!1;let n=(i,r,o,a)=>{if(m(this,zs).has(i.id)){let l=m(this,ri).get(a);l?i._setParentAndPosition(l,r,o):(i.pageIndex=a,i.x=r,i.y=o)}};return this.addCommands({cmd:()=>{for(let[i,{newX:r,newY:o,newPageIndex:a}]of e)n(i,r,o,a)},undo:()=>{for(let[i,{savedX:r,savedY:o,savedPageIndex:a}]of e)n(i,r,o,a)},mustExec:!0}),!0}dragSelectedEditors(e,t){if(m(this,ea))for(let n of m(this,ea).keys())n.drag(e,t)}rebuild(e){if(e.parent===null){let t=this.getLayer(e.pageIndex);t?(t.changeParent(e),t.addOrRebuild(e)):(this.addEditor(e),this.addToAnnotationStorage(e),e.rebuild())}else e.parent.addOrRebuild(e)}get isEditorHandlingKeyboard(){return this.getActive()?.shouldGetKeyboardEvents()||m(this,Dn).size===1&&this.firstSelectedEditor.shouldGetKeyboardEvents()}isActive(e){return m(this,or)===e}getActive(){return m(this,or)}getMode(){return m(this,Ys)}get imageManager(){return an(this,"imageManager",new pP)}getSelectionBoxes(e){if(!e)return null;let t=document.getSelection();for(let c=0,d=t.rangeCount;c<d;c++)if(!e.contains(t.getRangeAt(c).commonAncestorContainer))return null;let{x:n,y:i,width:r,height:o}=e.getBoundingClientRect(),a;switch(e.getAttribute("data-main-rotation")){case"90":a=(c,d,u,h)=>({x:(d-i)/o,y:1-(c+u-n)/r,width:h/o,height:u/r});break;case"180":a=(c,d,u,h)=>({x:1-(c+u-n)/r,y:1-(d+h-i)/o,width:u/r,height:h/o});break;case"270":a=(c,d,u,h)=>({x:1-(d+h-i)/o,y:(c-n)/r,width:h/o,height:u/r});break;default:a=(c,d,u,h)=>({x:(c-n)/r,y:(d-i)/o,width:u/r,height:h/o});break}let l=[];for(let c=0,d=t.rangeCount;c<d;c++){let u=t.getRangeAt(c);if(!u.collapsed)for(let{x:h,y:p,width:f,height:_}of u.getClientRects())f===0||_===0||l.push(a(h,p,f,_))}return l.length===0?null:l}addChangedExistingAnnotation({annotationElementId:e,id:t}){(m(this,pp)||N(this,pp,new Map)).set(e,t)}removeChangedExistingAnnotation({annotationElementId:e}){m(this,pp)?.delete(e)}renderAnnotationElement(e){let t=m(this,pp)?.get(e.data.id);if(!t)return;let n=m(this,qa).getRawValue(t);n&&(m(this,Ys)===Qt.NONE&&!n.hasBeenModified||n.renderAnnotationElement(e))}};up=new WeakMap,or=new WeakMap,zs=new WeakMap,ri=new WeakMap,hp=new WeakMap,qa=new WeakMap,pp=new WeakMap,Lr=new WeakMap,ql=new WeakMap,Ed=new WeakMap,fp=new WeakMap,xd=new WeakMap,ea=new WeakMap,ho=new WeakMap,Sd=new WeakMap,Og=new WeakMap,$g=new WeakMap,mp=new WeakMap,Bg=new WeakMap,ta=new WeakMap,Kl=new WeakMap,gp=new WeakMap,Yl=new WeakMap,na=new WeakMap,MT=new WeakMap,Xl=new WeakMap,zg=new WeakMap,Ql=new WeakMap,Cd=new WeakMap,Ug=new WeakMap,Vg=new WeakMap,Ys=new WeakMap,Dn=new WeakMap,Ka=new WeakMap,Ad=new WeakMap,Gg=new WeakMap,Wg=new WeakMap,Jl=new WeakMap,sa=new WeakMap,Ya=new WeakMap,Hg=new WeakMap,Nr=new WeakMap,_p=new WeakSet,dM=function({anchorNode:e}){return e.nodeType===Node.TEXT_NODE?e.parentElement:e},jg=new WeakSet,gP=function(e){let{currentLayer:t}=this;if(t.hasTextLayer(e))return t;for(let n of m(this,ri).values())if(n.hasTextLayer(e))return n;return null},TT=new WeakSet,A3=function(){let e=document.getSelection();if(!e||e.isCollapsed)return;let n=K(this,_p,dM).call(this,e).closest(".textLayer"),i=this.getSelectionBoxes(n);i&&(m(this,na)||N(this,na,new uP(this)),m(this,na).show(n,i,this.direction==="ltr"))},ET=new WeakSet,P3=function(){let e=document.getSelection();if(!e||e.isCollapsed){m(this,Ka)&&(m(this,na)?.hide(),N(this,Ka,null),K(this,oi,Ri).call(this,{hasSelectedText:!1}));return}let{anchorNode:t}=e;if(t===m(this,Ka))return;let i=K(this,_p,dM).call(this,e).closest(".textLayer");if(!i){m(this,Ka)&&(m(this,na)?.hide(),N(this,Ka,null),K(this,oi,Ri).call(this,{hasSelectedText:!1}));return}if(m(this,na)?.hide(),N(this,Ka,t),K(this,oi,Ri).call(this,{hasSelectedText:!0}),!(m(this,Ys)!==Qt.HIGHLIGHT&&m(this,Ys)!==Qt.NONE)&&(m(this,Ys)===Qt.HIGHLIGHT&&this.showAllEditors("highlight",!0,!0),N(this,Yl,this.isShiftKeyDown),!this.isShiftKeyDown)){let r=m(this,Ys)===Qt.HIGHLIGHT?K(this,jg,gP).call(this,i):null;r?.toggleDrawing();let o=new AbortController,a=this.combinedSignal(o),l=c=>{c.type==="pointerup"&&c.button!==0||(o.abort(),r?.toggleDrawing(!0),c.type==="pointerup"&&K(this,yp,uM).call(this,"main_toolbar"))};window.addEventListener("pointerup",l,{signal:a}),window.addEventListener("blur",l,{signal:a})}},yp=new WeakSet,uM=function(e=""){m(this,Ys)===Qt.HIGHLIGHT?this.highlightSelection(e):m(this,Og)&&K(this,TT,A3).call(this)},xT=new WeakSet,k3=function(){document.addEventListener("selectionchange",K(this,ET,P3).bind(this),{signal:this._signal})},ST=new WeakSet,I3=function(){if(m(this,Kl))return;N(this,Kl,new AbortController);let e=this.combinedSignal(m(this,Kl));window.addEventListener("focus",this.focus.bind(this),{signal:e}),window.addEventListener("blur",this.blur.bind(this),{signal:e})},CT=new WeakSet,D3=function(){m(this,Kl)?.abort(),N(this,Kl,null)},qg=new WeakSet,_P=function(){if(m(this,Ql))return;N(this,Ql,new AbortController);let e=this.combinedSignal(m(this,Ql));window.addEventListener("keydown",this.keydown.bind(this),{signal:e}),window.addEventListener("keyup",this.keyup.bind(this),{signal:e})},AT=new WeakSet,R3=function(){m(this,Ql)?.abort(),N(this,Ql,null)},Kg=new WeakSet,yP=function(){if(m(this,ql))return;N(this,ql,new AbortController);let e=this.combinedSignal(m(this,ql));document.addEventListener("copy",this.copy.bind(this),{signal:e}),document.addEventListener("cut",this.cut.bind(this),{signal:e}),document.addEventListener("paste",this.paste.bind(this),{signal:e})},Yg=new WeakSet,vP=function(){m(this,ql)?.abort(),N(this,ql,null)},PT=new WeakSet,F3=function(){let e=this._signal;document.addEventListener("dragover",this.dragOver.bind(this),{signal:e}),document.addEventListener("drop",this.drop.bind(this),{signal:e})},oi=new WeakSet,Ri=function(e){Object.entries(e).some(([n,i])=>m(this,Wg)[n]!==i)&&(this._eventBus.dispatch("annotationeditorstateschanged",{source:this,details:Object.assign(m(this,Wg),e)}),m(this,Ys)===Qt.HIGHLIGHT&&e.hasSelectedEditor===!1&&K(this,po,Ga).call(this,[[mn.HIGHLIGHT_FREE,!0]]))},po=new WeakSet,Ga=function(e){this._eventBus.dispatch("annotationeditorparamschanged",{source:this,details:e})},kT=new WeakSet,L3=async function(){if(!m(this,Xl)){N(this,Xl,!0);let e=[];for(let t of m(this,ri).values())e.push(t.enable());await Promise.all(e);for(let t of m(this,zs).values())t.enable()}},IT=new WeakSet,N3=function(){if(this.unselectAll(),m(this,Xl)){N(this,Xl,!1);for(let e of m(this,ri).values())e.disable();for(let e of m(this,zs).values())e.disable()}},Xg=new WeakSet,bP=function(e){let t=m(this,ri).get(e.pageIndex);t?t.addOrRebuild(e):(this.addEditor(e),this.addToAnnotationStorage(e))},DT=new WeakSet,O3=function(){let e=null;for(e of m(this,Dn));return e},Pd=new WeakSet,Jm=function(){if(m(this,zs).size===0)return!0;if(m(this,zs).size===1)for(let e of m(this,zs).values())return e.isEmpty();return!1},Qg=new WeakSet,wP=function(e){for(let t of m(this,Dn))t.unselect();m(this,Dn).clear();for(let t of e)t.isEmpty()||(m(this,Dn).add(t),t.select());K(this,oi,Ri).call(this,{hasSelectedEditor:this.hasSelection})},Z(sp,"TRANSLATE_SMALL",1),Z(sp,"TRANSLATE_BIG",10);var zu=sp,Xs,ia,fo,vp,ra,ar,bp,oa,Ki,Xa,kd,aa,Zl,Id,Zm,wp,hM,Fi=class Fi{constructor(e){L(this,Id);L(this,wp);L(this,Xs,null);L(this,ia,!1);L(this,fo,null);L(this,vp,null);L(this,ra,null);L(this,ar,null);L(this,bp,!1);L(this,oa,null);L(this,Ki,null);L(this,Xa,null);L(this,kd,null);L(this,aa,!1);N(this,Ki,e),N(this,aa,e._uiManager.useNewAltTextFlow),m(Fi,Zl)||N(Fi,Zl,Object.freeze({added:"pdfjs-editor-new-alt-text-added-button","added-label":"pdfjs-editor-new-alt-text-added-button-label",missing:"pdfjs-editor-new-alt-text-missing-button","missing-label":"pdfjs-editor-new-alt-text-missing-button-label",review:"pdfjs-editor-new-alt-text-to-review-button","review-label":"pdfjs-editor-new-alt-text-to-review-button-label"}))}static initialize(e){Fi._l10n??(Fi._l10n=e)}async render(){let e=N(this,fo,document.createElement("button"));e.className="altText",e.tabIndex="0";let t=N(this,vp,document.createElement("span"));e.append(t),m(this,aa)?(e.classList.add("new"),e.setAttribute("data-l10n-id",m(Fi,Zl).missing),t.setAttribute("data-l10n-id",m(Fi,Zl)["missing-label"])):(e.setAttribute("data-l10n-id","pdfjs-editor-alt-text-button"),t.setAttribute("data-l10n-id","pdfjs-editor-alt-text-button-label"));let n=m(this,Ki)._uiManager._signal;e.addEventListener("contextmenu",So,{signal:n}),e.addEventListener("pointerdown",r=>r.stopPropagation(),{signal:n});let i=r=>{r.preventDefault(),m(this,Ki)._uiManager.editAltText(m(this,Ki)),m(this,aa)&&m(this,Ki)._reportTelemetry({action:"pdfjs.image.alt_text.image_status_label_clicked",data:{label:m(this,Id,Zm)}})};return e.addEventListener("click",i,{capture:!0,signal:n}),e.addEventListener("keydown",r=>{r.target===e&&r.key==="Enter"&&(N(this,bp,!0),i(r))},{signal:n}),await K(this,wp,hM).call(this),e}finish(){m(this,fo)&&(m(this,fo).focus({focusVisible:m(this,bp)}),N(this,bp,!1))}isEmpty(){return m(this,aa)?m(this,Xs)===null:!m(this,Xs)&&!m(this,ia)}hasData(){return m(this,aa)?m(this,Xs)!==null||!!m(this,Xa):this.isEmpty()}get guessedText(){return m(this,Xa)}async setGuessedText(e){m(this,Xs)===null&&(N(this,Xa,e),N(this,kd,await Fi._l10n.get("pdfjs-editor-new-alt-text-generated-alt-text-with-disclaimer",{generatedAltText:e})),K(this,wp,hM).call(this))}toggleAltTextBadge(e=!1){if(!m(this,aa)||m(this,Xs)){m(this,oa)?.remove(),N(this,oa,null);return}if(!m(this,oa)){let t=N(this,oa,document.createElement("div"));t.className="noAltTextBadge",m(this,Ki).div.append(t)}m(this,oa).classList.toggle("hidden",!e)}serialize(e){let t=m(this,Xs);return!e&&m(this,Xa)===t&&(t=m(this,kd)),{altText:t,decorative:m(this,ia),guessedText:m(this,Xa),textWithDisclaimer:m(this,kd)}}get data(){return{altText:m(this,Xs),decorative:m(this,ia)}}set data({altText:e,decorative:t,guessedText:n,textWithDisclaimer:i,cancel:r=!1}){n&&(N(this,Xa,n),N(this,kd,i)),!(m(this,Xs)===e&&m(this,ia)===t)&&(r||(N(this,Xs,e),N(this,ia,t)),K(this,wp,hM).call(this))}toggle(e=!1){m(this,fo)&&(!e&&m(this,ar)&&(clearTimeout(m(this,ar)),N(this,ar,null)),m(this,fo).disabled=!e)}shown(){m(this,Ki)._reportTelemetry({action:"pdfjs.image.alt_text.image_status_label_displayed",data:{label:m(this,Id,Zm)}})}destroy(){m(this,fo)?.remove(),N(this,fo,null),N(this,vp,null),N(this,ra,null),m(this,oa)?.remove(),N(this,oa,null)}};Xs=new WeakMap,ia=new WeakMap,fo=new WeakMap,vp=new WeakMap,ra=new WeakMap,ar=new WeakMap,bp=new WeakMap,oa=new WeakMap,Ki=new WeakMap,Xa=new WeakMap,kd=new WeakMap,aa=new WeakMap,Zl=new WeakMap,Id=new WeakSet,Zm=function(){return m(this,Xs)&&"added"||m(this,Xs)===null&&this.guessedText&&"review"||"missing"},wp=new WeakSet,hM=async function(){let e=m(this,fo);if(!e)return;if(m(this,aa)){if(e.classList.toggle("done",!!m(this,Xs)),e.setAttribute("data-l10n-id",m(Fi,Zl)[m(this,Id,Zm)]),m(this,vp)?.setAttribute("data-l10n-id",m(Fi,Zl)[`${m(this,Id,Zm)}-label`]),!m(this,Xs)){m(this,ra)?.remove();return}}else{if(!m(this,Xs)&&!m(this,ia)){e.classList.remove("done"),m(this,ra)?.remove();return}e.classList.add("done"),e.setAttribute("data-l10n-id","pdfjs-editor-alt-text-edit-button")}let t=m(this,ra);if(!t){N(this,ra,t=document.createElement("span")),t.className="tooltip",t.setAttribute("role","tooltip"),t.id=`alt-text-tooltip-${m(this,Ki).id}`;let i=100,r=m(this,Ki)._uiManager._signal;r.addEventListener("abort",()=>{clearTimeout(m(this,ar)),N(this,ar,null)},{once:!0}),e.addEventListener("mouseenter",()=>{N(this,ar,setTimeout(()=>{N(this,ar,null),m(this,ra).classList.add("show"),m(this,Ki)._reportTelemetry({action:"alt_text_tooltip"})},i))},{signal:r}),e.addEventListener("mouseleave",()=>{m(this,ar)&&(clearTimeout(m(this,ar)),N(this,ar,null)),m(this,ra)?.classList.remove("show")},{signal:r})}m(this,ia)?t.setAttribute("data-l10n-id","pdfjs-editor-alt-text-decorative-tooltip"):(t.removeAttribute("data-l10n-id"),t.textContent=m(this,Xs)),t.parentNode||e.append(t),m(this,Ki).getImageForAltText()?.setAttribute("aria-describedby",t.id)},L(Fi,Zl,null),Z(Fi,"_l10n",null);var BM=Fi,Jg,Dd,Zg,e_,t_,n_,s_,Mp,Qa,Rd,ec,RT,$3,FT,B3,i_,MP,SI=class SI{constructor({container:e,isPinchingDisabled:t=null,isPinchingStopped:n=null,onPinchStart:i=null,onPinching:r=null,onPinchEnd:o=null,signal:a}){L(this,RT);L(this,FT);L(this,i_);L(this,Jg,void 0);L(this,Dd,!1);L(this,Zg,null);L(this,e_,void 0);L(this,t_,void 0);L(this,n_,void 0);L(this,s_,void 0);L(this,Mp,void 0);L(this,Qa,null);L(this,Rd,void 0);L(this,ec,null);N(this,Jg,e),N(this,Zg,n),N(this,e_,t),N(this,t_,i),N(this,n_,r),N(this,s_,o),N(this,Rd,new AbortController),N(this,Mp,AbortSignal.any([a,m(this,Rd).signal])),e.addEventListener("touchstart",K(this,RT,$3).bind(this),{passive:!1,signal:m(this,Mp)})}get MIN_TOUCH_DISTANCE_TO_PINCH(){return an(this,"MIN_TOUCH_DISTANCE_TO_PINCH",35/(window.devicePixelRatio||1))}destroy(){m(this,Rd)?.abort(),N(this,Rd,null)}};Jg=new WeakMap,Dd=new WeakMap,Zg=new WeakMap,e_=new WeakMap,t_=new WeakMap,n_=new WeakMap,s_=new WeakMap,Mp=new WeakMap,Qa=new WeakMap,Rd=new WeakMap,ec=new WeakMap,RT=new WeakSet,$3=function(e){var i,r,o;if((i=m(this,e_))!=null&&i.call(this)||e.touches.length<2)return;if(!m(this,ec)){N(this,ec,new AbortController);let a=AbortSignal.any([m(this,Mp),m(this,ec).signal]),l=m(this,Jg),c={signal:a,passive:!1};l.addEventListener("touchmove",K(this,FT,B3).bind(this),c),l.addEventListener("touchend",K(this,i_,MP).bind(this),c),l.addEventListener("touchcancel",K(this,i_,MP).bind(this),c),(r=m(this,t_))==null||r.call(this)}if(vr(e),e.touches.length!==2||(o=m(this,Zg))!=null&&o.call(this)){N(this,Qa,null);return}let[t,n]=e.touches;t.identifier>n.identifier&&([t,n]=[n,t]),N(this,Qa,{touch0X:t.screenX,touch0Y:t.screenY,touch1X:n.screenX,touch1Y:n.screenY})},FT=new WeakSet,B3=function(e){var M;if(!m(this,Qa)||e.touches.length!==2)return;let[t,n]=e.touches;t.identifier>n.identifier&&([t,n]=[n,t]);let{screenX:i,screenY:r}=t,{screenX:o,screenY:a}=n,l=m(this,Qa),{touch0X:c,touch0Y:d,touch1X:u,touch1Y:h}=l,p=u-c,f=h-d,_=o-i,b=a-r,y=Math.hypot(_,b)||1,w=Math.hypot(p,f)||1;if(!m(this,Dd)&&Math.abs(w-y)<=SI.MIN_TOUCH_DISTANCE_TO_PINCH)return;if(l.touch0X=i,l.touch0Y=r,l.touch1X=o,l.touch1Y=a,e.preventDefault(),!m(this,Dd)){N(this,Dd,!0);return}let C=[(i+o)/2,(r+a)/2];(M=m(this,n_))==null||M.call(this,C,w,y)},i_=new WeakSet,MP=function(e){var t;m(this,ec).abort(),N(this,ec,null),(t=m(this,s_))==null||t.call(this),m(this,Qa)&&(e.preventDefault(),N(this,Qa,null),N(this,Dd,!1))};var zM=SI,Fd,mo,Kn,Tp,tc,r_,Ld,ai,Nd,Ja,nc,o_,Od,lr,a_,$d,Za,la,Ep,xp,Or,Bd,l_,LT,c_,TP,d_,EP,Sp,pM,NT,z3,OT,U3,u_,xP,Cp,fM,h_,SP,$T,V3,BT,G3,zT,W3,p_,CP,UT,H3,f_,AP,VT,j3,GT,q3,WT,K3,m_,PP,zd,eg,tn=class tn{constructor(e){L(this,c_);L(this,Sp);L(this,NT);L(this,OT);L(this,u_);L(this,Cp);L(this,h_);L(this,$T);L(this,BT);L(this,zT);L(this,p_);L(this,UT);L(this,f_);L(this,VT);L(this,GT);L(this,WT);L(this,m_);L(this,zd);L(this,Fd,null);L(this,mo,null);L(this,Kn,null);L(this,Tp,!1);L(this,tc,null);L(this,r_,"");L(this,Ld,!1);L(this,ai,null);L(this,Nd,null);L(this,Ja,null);L(this,nc,null);L(this,o_,"");L(this,Od,!1);L(this,lr,null);L(this,a_,!1);L(this,$d,!1);L(this,Za,!1);L(this,la,null);L(this,Ep,0);L(this,xp,0);L(this,Or,null);L(this,Bd,null);Z(this,"_editToolbar",null);Z(this,"_initialOptions",Object.create(null));Z(this,"_initialData",null);Z(this,"_isVisible",!0);Z(this,"_uiManager",null);Z(this,"_focusEventsAllowed",!0);L(this,l_,!1);L(this,LT,tn._zIndex++);this.parent=e.parent,this.id=e.id,this.width=this.height=null,this.pageIndex=e.parent.pageIndex,this.name=e.name,this.div=null,this._uiManager=e.uiManager,this.annotationElementId=null,this._willKeepAspectRatio=!1,this._initialOptions.isCentered=e.isCentered,this._structTreeParentId=null;let{rotation:t,rawDims:{pageWidth:n,pageHeight:i,pageX:r,pageY:o}}=this.parent.viewport;this.rotation=t,this.pageRotation=(360+t-this._uiManager.viewParameters.rotation)%360,this.pageDimensions=[n,i],this.pageTranslation=[r,o];let[a,l]=this.parentDimensions;this.x=e.x/a,this.y=e.y/l,this.isAttachedToDOM=!1,this.deleted=!1}static get _resizerKeyboardManager(){let e=tn.prototype._resizeWithKeyboard,t=zu.TRANSLATE_SMALL,n=zu.TRANSLATE_BIG;return an(this,"_resizerKeyboardManager",new Bu([[["ArrowLeft","mac+ArrowLeft"],e,{args:[-t,0]}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],e,{args:[-n,0]}],[["ArrowRight","mac+ArrowRight"],e,{args:[t,0]}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],e,{args:[n,0]}],[["ArrowUp","mac+ArrowUp"],e,{args:[0,-t]}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],e,{args:[0,-n]}],[["ArrowDown","mac+ArrowDown"],e,{args:[0,t]}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],e,{args:[0,n]}],[["Escape","mac+Escape"],tn.prototype._stopResizingWithKeyboard]]))}get editorType(){return Object.getPrototypeOf(this).constructor._type}static get isDrawer(){return!1}static get _defaultLineColor(){return an(this,"_defaultLineColor",this._colorManager.getHexCode("CanvasText"))}static deleteAnnotationElement(e){let t=new kP({id:e.parent.getNextId(),parent:e.parent,uiManager:e._uiManager});t.annotationElementId=e.annotationElementId,t.deleted=!0,t._uiManager.addToAnnotationStorage(t)}static initialize(e,t){if(tn._l10n??(tn._l10n=e),tn._l10nResizer||(tn._l10nResizer=Object.freeze({topLeft:"pdfjs-editor-resizer-top-left",topMiddle:"pdfjs-editor-resizer-top-middle",topRight:"pdfjs-editor-resizer-top-right",middleRight:"pdfjs-editor-resizer-middle-right",bottomRight:"pdfjs-editor-resizer-bottom-right",bottomMiddle:"pdfjs-editor-resizer-bottom-middle",bottomLeft:"pdfjs-editor-resizer-bottom-left",middleLeft:"pdfjs-editor-resizer-middle-left"})),tn._borderLineWidth!==-1)return;let n=getComputedStyle(document.documentElement);tn._borderLineWidth=parseFloat(n.getPropertyValue("--outline-width"))||0}static updateDefaultParams(e,t){}static get defaultPropertiesToUpdate(){return[]}static isHandlingMimeForPasting(e){return!1}static paste(e,t){zn("Not implemented")}get propertiesToUpdate(){return[]}get _isDraggable(){return m(this,l_)}set _isDraggable(e){N(this,l_,e),this.div?.classList.toggle("draggable",e)}get isEnterHandled(){return!0}center(){let[e,t]=this.pageDimensions;switch(this.parentRotation){case 90:this.x-=this.height*t/(e*2),this.y+=this.width*e/(t*2);break;case 180:this.x+=this.width/2,this.y+=this.height/2;break;case 270:this.x+=this.height*t/(e*2),this.y-=this.width*e/(t*2);break;default:this.x-=this.width/2,this.y-=this.height/2;break}this.fixAndSetPosition()}addCommands(e){this._uiManager.addCommands(e)}get currentLayer(){return this._uiManager.currentLayer}setInBackground(){this.div.style.zIndex=0}setInForeground(){this.div.style.zIndex=m(this,LT)}setParent(e){e!==null?(this.pageIndex=e.pageIndex,this.pageDimensions=e.pageDimensions):K(this,zd,eg).call(this),this.parent=e}focusin(e){this._focusEventsAllowed&&(m(this,Od)?N(this,Od,!1):this.parent.setSelected(this))}focusout(e){!this._focusEventsAllowed||!this.isAttachedToDOM||e.relatedTarget?.closest(`#${this.id}`)||(e.preventDefault(),this.parent?.isMultipleSelection||this.commitOrRemove())}commitOrRemove(){this.isEmpty()?this.remove():this.commit()}commit(){this.addToAnnotationStorage()}addToAnnotationStorage(){this._uiManager.addToAnnotationStorage(this)}setAt(e,t,n,i){let[r,o]=this.parentDimensions;[n,i]=this.screenToPageTranslation(n,i),this.x=(e+n)/r,this.y=(t+i)/o,this.fixAndSetPosition()}translate(e,t){K(this,c_,TP).call(this,this.parentDimensions,e,t)}translateInPage(e,t){m(this,lr)||N(this,lr,[this.x,this.y,this.width,this.height]),K(this,c_,TP).call(this,this.pageDimensions,e,t),this.div.scrollIntoView({block:"nearest"})}drag(e,t){m(this,lr)||N(this,lr,[this.x,this.y,this.width,this.height]);let{div:n,parentDimensions:[i,r]}=this;if(this.x+=e/i,this.y+=t/r,this.parent&&(this.x<0||this.x>1||this.y<0||this.y>1)){let{x:u,y:h}=this.div.getBoundingClientRect();this.parent.findNewParent(this,u,h)&&(this.x-=Math.floor(this.x),this.y-=Math.floor(this.y))}let{x:o,y:a}=this,[l,c]=this.getBaseTranslation();o+=l,a+=c;let{style:d}=n;d.left=`${(100*o).toFixed(2)}%`,d.top=`${(100*a).toFixed(2)}%`,this._onTranslating(o,a),n.scrollIntoView({block:"nearest"})}_onTranslating(e,t){}_onTranslated(e,t){}get _hasBeenMoved(){return!!m(this,lr)&&(m(this,lr)[0]!==this.x||m(this,lr)[1]!==this.y)}get _hasBeenResized(){return!!m(this,lr)&&(m(this,lr)[2]!==this.width||m(this,lr)[3]!==this.height)}getBaseTranslation(){let[e,t]=this.parentDimensions,{_borderLineWidth:n}=tn,i=n/e,r=n/t;switch(this.rotation){case 90:return[-i,r];case 180:return[i,r];case 270:return[i,-r];default:return[-i,-r]}}get _mustFixPosition(){return!0}fixAndSetPosition(e=this.rotation){let{div:{style:t},pageDimensions:[n,i]}=this,{x:r,y:o,width:a,height:l}=this;if(a*=n,l*=i,r*=n,o*=i,this._mustFixPosition)switch(e){case 0:r=Math.max(0,Math.min(n-a,r)),o=Math.max(0,Math.min(i-l,o));break;case 90:r=Math.max(0,Math.min(n-l,r)),o=Math.min(i,Math.max(a,o));break;case 180:r=Math.min(n,Math.max(a,r)),o=Math.min(i,Math.max(l,o));break;case 270:r=Math.min(n,Math.max(l,r)),o=Math.max(0,Math.min(i-a,o));break}this.x=r/=n,this.y=o/=i;let[c,d]=this.getBaseTranslation();r+=c,o+=d,t.left=`${(100*r).toFixed(2)}%`,t.top=`${(100*o).toFixed(2)}%`,this.moveInDOM()}screenToPageTranslation(e,t){var n;return K(n=tn,d_,EP).call(n,e,t,this.parentRotation)}pageTranslationToScreen(e,t){var n;return K(n=tn,d_,EP).call(n,e,t,360-this.parentRotation)}get parentScale(){return this._uiManager.viewParameters.realScale}get parentRotation(){return(this._uiManager.viewParameters.rotation+this.pageRotation)%360}get parentDimensions(){let{parentScale:e,pageDimensions:[t,n]}=this;return[t*e,n*e]}setDims(e,t){let[n,i]=this.parentDimensions,{style:r}=this.div;r.width=`${(100*e/n).toFixed(2)}%`,m(this,Ld)||(r.height=`${(100*t/i).toFixed(2)}%`)}fixDims(){let{style:e}=this.div,{height:t,width:n}=e,i=n.endsWith("%"),r=!m(this,Ld)&&t.endsWith("%");if(i&&r)return;let[o,a]=this.parentDimensions;i||(e.width=`${(100*parseFloat(n)/o).toFixed(2)}%`),!m(this,Ld)&&!r&&(e.height=`${(100*parseFloat(t)/a).toFixed(2)}%`)}getInitialTranslation(){return[0,0]}_onResized(){}static _round(e){return Math.round(e*1e4)/1e4}_onResizing(){}altTextFinish(){m(this,Kn)?.finish()}async addEditToolbar(){return this._editToolbar||m(this,$d)?this._editToolbar:(this._editToolbar=new cP(this),this.div.append(this._editToolbar.render()),m(this,Kn)&&await this._editToolbar.addAltText(m(this,Kn)),this._editToolbar)}removeEditToolbar(){this._editToolbar&&(this._editToolbar.remove(),this._editToolbar=null,m(this,Kn)?.destroy())}addContainer(e){let t=this._editToolbar?.div;t?t.before(e):this.div.append(e)}getClientDimensions(){return this.div.getBoundingClientRect()}async addAltTextButton(){m(this,Kn)||(BM.initialize(tn._l10n),N(this,Kn,new BM(this)),m(this,Fd)&&(m(this,Kn).data=m(this,Fd),N(this,Fd,null)),await this.addEditToolbar())}get altTextData(){return m(this,Kn)?.data}set altTextData(e){m(this,Kn)&&(m(this,Kn).data=e)}get guessedAltText(){return m(this,Kn)?.guessedText}async setGuessedAltText(e){await m(this,Kn)?.setGuessedText(e)}serializeAltText(e){return m(this,Kn)?.serialize(e)}hasAltText(){return!!m(this,Kn)&&!m(this,Kn).isEmpty()}hasAltTextData(){return m(this,Kn)?.hasData()??!1}render(){this.div=document.createElement("div"),this.div.setAttribute("data-editor-rotation",(360-this.rotation)%360),this.div.className=this.name,this.div.setAttribute("id",this.id),this.div.tabIndex=m(this,Tp)?-1:0,this._isVisible||this.div.classList.add("hidden"),this.setInForeground(),K(this,f_,AP).call(this);let[e,t]=this.parentDimensions;this.parentRotation%180!==0&&(this.div.style.maxWidth=`${(100*t/e).toFixed(2)}%`,this.div.style.maxHeight=`${(100*e/t).toFixed(2)}%`);let[n,i]=this.getInitialTranslation();return this.translate(n,i),$M(this,this.div,["pointerdown"]),this.isResizable&&this._uiManager._supportsPinchToZoom&&(m(this,Bd)||N(this,Bd,new zM({container:this.div,isPinchingDisabled:()=>!this.isSelected,onPinchStart:K(this,$T,V3).bind(this),onPinching:K(this,BT,G3).bind(this),onPinchEnd:K(this,zT,W3).bind(this),signal:this._uiManager._signal}))),this._uiManager._editorUndoBar?.hide(),this.div}pointerdown(e){let{isMac:t}=ui.platform;if(e.button!==0||e.ctrlKey&&t){e.preventDefault();return}if(N(this,Od,!0),this._isDraggable){K(this,UT,H3).call(this,e);return}K(this,p_,CP).call(this,e)}get isSelected(){return this._uiManager.isSelected(this)}_onStartDragging(){}_onStopDragging(){}moveInDOM(){m(this,la)&&clearTimeout(m(this,la)),N(this,la,setTimeout(()=>{N(this,la,null),this.parent?.moveEditorInDOM(this)},0))}_setParentAndPosition(e,t,n){e.changeParent(this),this.x=t,this.y=n,this.fixAndSetPosition(),this._onTranslated()}getRect(e,t,n=this.rotation){let i=this.parentScale,[r,o]=this.pageDimensions,[a,l]=this.pageTranslation,c=e/i,d=t/i,u=this.x*r,h=this.y*o,p=this.width*r,f=this.height*o;switch(n){case 0:return[u+c+a,o-h-d-f+l,u+c+p+a,o-h-d+l];case 90:return[u+d+a,o-h+c+l,u+d+f+a,o-h+c+p+l];case 180:return[u-c-p+a,o-h+d+l,u-c+a,o-h+d+f+l];case 270:return[u-d-f+a,o-h-c-p+l,u-d+a,o-h-c+l];default:throw new Error("Invalid rotation")}}getRectInCurrentCoords(e,t){let[n,i,r,o]=e,a=r-n,l=o-i;switch(this.rotation){case 0:return[n,t-o,a,l];case 90:return[n,t-i,l,a];case 180:return[r,t-i,a,l];case 270:return[r,t-o,l,a];default:throw new Error("Invalid rotation")}}onceAdded(e){}isEmpty(){return!1}enableEditMode(){N(this,$d,!0)}disableEditMode(){N(this,$d,!1)}isInEditMode(){return m(this,$d)}shouldGetKeyboardEvents(){return m(this,Za)}needsToBeRebuilt(){return this.div&&!this.isAttachedToDOM}get isOnScreen(){let{top:e,left:t,bottom:n,right:i}=this.getClientDimensions(),{innerHeight:r,innerWidth:o}=window;return t<o&&i>0&&e<r&&n>0}rebuild(){K(this,f_,AP).call(this)}rotate(e){}resize(){}serializeDeleted(){return{id:this.annotationElementId,deleted:!0,pageIndex:this.pageIndex,popupRef:this._initialData?.popupRef||""}}serialize(e=!1,t=null){zn("An editor must be serializable")}static async deserialize(e,t,n){let i=new this.prototype.constructor({parent:t,id:t.getNextId(),uiManager:n});i.rotation=e.rotation,N(i,Fd,e.accessibilityData);let[r,o]=i.pageDimensions,[a,l,c,d]=i.getRectInCurrentCoords(e.rect,o);return i.x=a/r,i.y=l/o,i.width=c/r,i.height=d/o,i}get hasBeenModified(){return!!this.annotationElementId&&(this.deleted||this.serialize()!==null)}remove(){if(m(this,nc)?.abort(),N(this,nc,null),this.isEmpty()||this.commit(),this.parent?this.parent.remove(this):this._uiManager.removeEditor(this),m(this,la)&&(clearTimeout(m(this,la)),N(this,la,null)),K(this,zd,eg).call(this),this.removeEditToolbar(),m(this,Or)){for(let e of m(this,Or).values())clearTimeout(e);N(this,Or,null)}this.parent=null,m(this,Bd)?.destroy(),N(this,Bd,null)}get isResizable(){return!1}makeResizable(){this.isResizable&&(K(this,NT,z3).call(this),m(this,ai).classList.remove("hidden"),$M(this,this.div,["keydown"]))}get toolbarPosition(){return null}keydown(e){if(!this.isResizable||e.target!==this.div||e.key!=="Enter")return;this._uiManager.setSelected(this),N(this,Ja,{savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height});let t=m(this,ai).children;if(!m(this,mo)){N(this,mo,Array.from(t));let o=K(this,VT,j3).bind(this),a=K(this,GT,q3).bind(this),l=this._uiManager._signal;for(let c of m(this,mo)){let d=c.getAttribute("data-resizer-name");c.setAttribute("role","spinbutton"),c.addEventListener("keydown",o,{signal:l}),c.addEventListener("blur",a,{signal:l}),c.addEventListener("focus",K(this,WT,K3).bind(this,d),{signal:l}),c.setAttribute("data-l10n-id",tn._l10nResizer[d])}}let n=m(this,mo)[0],i=0;for(let o of t){if(o===n)break;i++}let r=(360-this.rotation+this.parentRotation)%360/90*(m(this,mo).length/4);if(r!==i){if(r<i)for(let a=0;a<i-r;a++)m(this,ai).append(m(this,ai).firstChild);else if(r>i)for(let a=0;a<r-i;a++)m(this,ai).firstChild.before(m(this,ai).lastChild);let o=0;for(let a of t){let c=m(this,mo)[o++].getAttribute("data-resizer-name");a.setAttribute("data-l10n-id",tn._l10nResizer[c])}}K(this,m_,PP).call(this,0),N(this,Za,!0),m(this,ai).firstChild.focus({focusVisible:!0}),e.preventDefault(),e.stopImmediatePropagation()}_resizeWithKeyboard(e,t){m(this,Za)&&K(this,h_,SP).call(this,m(this,o_),{deltaX:e,deltaY:t,fromKeyboard:!0})}_stopResizingWithKeyboard(){K(this,zd,eg).call(this),this.div.focus()}select(){if(this.makeResizable(),this.div?.classList.add("selectedEditor"),!this._editToolbar){this.addEditToolbar().then(()=>{this.div?.classList.contains("selectedEditor")&&this._editToolbar?.show()});return}this._editToolbar?.show(),m(this,Kn)?.toggleAltTextBadge(!1)}unselect(){m(this,ai)?.classList.add("hidden"),this.div?.classList.remove("selectedEditor"),this.div?.contains(document.activeElement)&&this._uiManager.currentLayer.div.focus({preventScroll:!0}),this._editToolbar?.hide(),m(this,Kn)?.toggleAltTextBadge(!0)}updateParams(e,t){}disableEditing(){}enableEditing(){}enterInEditMode(){}getImageForAltText(){return null}get contentDiv(){return this.div}get isEditing(){return m(this,a_)}set isEditing(e){N(this,a_,e),this.parent&&(e?(this.parent.setSelected(this),this.parent.setActiveEditor(this)):this.parent.setActiveEditor(null))}setAspectRatio(e,t){N(this,Ld,!0);let n=e/t,{style:i}=this.div;i.aspectRatio=n,i.height="auto"}static get MIN_SIZE(){return 16}static canCreateNewEmptyEditor(){return!0}get telemetryInitialData(){return{action:"added"}}get telemetryFinalData(){return null}_reportTelemetry(e,t=!1){if(t){m(this,Or)||N(this,Or,new Map);let{action:n}=e,i=m(this,Or).get(n);i&&clearTimeout(i),i=setTimeout(()=>{this._reportTelemetry(e),m(this,Or).delete(n),m(this,Or).size===0&&N(this,Or,null)},tn._telemetryTimeout),m(this,Or).set(n,i);return}e.type||(e.type=this.editorType),this._uiManager._eventBus.dispatch("reporttelemetry",{source:this,details:{type:"editing",data:e}})}show(e=this._isVisible){this.div.classList.toggle("hidden",!e),this._isVisible=e}enable(){this.div&&(this.div.tabIndex=0),N(this,Tp,!1)}disable(){this.div&&(this.div.tabIndex=-1),N(this,Tp,!0)}renderAnnotationElement(e){let t=e.container.querySelector(".annotationContent");if(!t)t=document.createElement("div"),t.classList.add("annotationContent",this.editorType),e.container.prepend(t);else if(t.nodeName==="CANVAS"){let n=t;t=document.createElement("div"),t.classList.add("annotationContent",this.editorType),n.before(t)}return t}resetAnnotationElement(e){let{firstChild:t}=e.container;t?.nodeName==="DIV"&&t.classList.contains("annotationContent")&&t.remove()}};Fd=new WeakMap,mo=new WeakMap,Kn=new WeakMap,Tp=new WeakMap,tc=new WeakMap,r_=new WeakMap,Ld=new WeakMap,ai=new WeakMap,Nd=new WeakMap,Ja=new WeakMap,nc=new WeakMap,o_=new WeakMap,Od=new WeakMap,lr=new WeakMap,a_=new WeakMap,$d=new WeakMap,Za=new WeakMap,la=new WeakMap,Ep=new WeakMap,xp=new WeakMap,Or=new WeakMap,Bd=new WeakMap,l_=new WeakMap,LT=new WeakMap,c_=new WeakSet,TP=function([e,t],n,i){[n,i]=this.screenToPageTranslation(n,i),this.x+=n/e,this.y+=i/t,this._onTranslating(this.x,this.y),this.fixAndSetPosition()},d_=new WeakSet,EP=function(e,t,n){switch(n){case 90:return[t,-e];case 180:return[-e,-t];case 270:return[-t,e];default:return[e,t]}},Sp=new WeakSet,pM=function(e){switch(e){case 90:{let[t,n]=this.pageDimensions;return[0,-t/n,n/t,0]}case 180:return[-1,0,0,-1];case 270:{let[t,n]=this.pageDimensions;return[0,t/n,-n/t,0]}default:return[1,0,0,1]}},NT=new WeakSet,z3=function(){if(m(this,ai))return;N(this,ai,document.createElement("div")),m(this,ai).classList.add("resizers");let e=this._willKeepAspectRatio?["topLeft","topRight","bottomRight","bottomLeft"]:["topLeft","topMiddle","topRight","middleRight","bottomRight","bottomMiddle","bottomLeft","middleLeft"],t=this._uiManager._signal;for(let n of e){let i=document.createElement("div");m(this,ai).append(i),i.classList.add("resizer",n),i.setAttribute("data-resizer-name",n),i.addEventListener("pointerdown",K(this,OT,U3).bind(this,n),{signal:t}),i.addEventListener("contextmenu",So,{signal:t}),i.tabIndex=-1}this.div.prepend(m(this,ai))},OT=new WeakSet,U3=function(e,t){t.preventDefault();let{isMac:n}=ui.platform;if(t.button!==0||t.ctrlKey&&n)return;m(this,Kn)?.toggle(!1);let i=this._isDraggable;this._isDraggable=!1,N(this,Nd,[t.screenX,t.screenY]);let r=new AbortController,o=this._uiManager.combinedSignal(r);this.parent.togglePointerEvents(!1),window.addEventListener("pointermove",K(this,h_,SP).bind(this,e),{passive:!0,capture:!0,signal:o}),window.addEventListener("touchmove",vr,{passive:!1,signal:o}),window.addEventListener("contextmenu",So,{signal:o}),N(this,Ja,{savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height});let a=this.parent.div.style.cursor,l=this.div.style.cursor;this.div.style.cursor=this.parent.div.style.cursor=window.getComputedStyle(t.target).cursor;let c=()=>{r.abort(),this.parent.togglePointerEvents(!0),m(this,Kn)?.toggle(!0),this._isDraggable=i,this.parent.div.style.cursor=a,this.div.style.cursor=l,K(this,Cp,fM).call(this)};window.addEventListener("pointerup",c,{signal:o}),window.addEventListener("blur",c,{signal:o})},u_=new WeakSet,xP=function(e,t,n,i){this.width=n,this.height=i,this.x=e,this.y=t;let[r,o]=this.parentDimensions;this.setDims(r*n,o*i),this.fixAndSetPosition(),this._onResized()},Cp=new WeakSet,fM=function(){if(!m(this,Ja))return;let{savedX:e,savedY:t,savedWidth:n,savedHeight:i}=m(this,Ja);N(this,Ja,null);let r=this.x,o=this.y,a=this.width,l=this.height;r===e&&o===t&&a===n&&l===i||this.addCommands({cmd:K(this,u_,xP).bind(this,r,o,a,l),undo:K(this,u_,xP).bind(this,e,t,n,i),mustExec:!0})},h_=new WeakSet,SP=function(e,t){let[n,i]=this.parentDimensions,r=this.x,o=this.y,a=this.width,l=this.height,c=tn.MIN_SIZE/n,d=tn.MIN_SIZE/i,u=K(this,Sp,pM).call(this,this.rotation),h=(Y,se)=>[u[0]*Y+u[2]*se,u[1]*Y+u[3]*se],p=K(this,Sp,pM).call(this,360-this.rotation),f=(Y,se)=>[p[0]*Y+p[2]*se,p[1]*Y+p[3]*se],_,b,y=!1,w=!1;switch(e){case"topLeft":y=!0,_=(Y,se)=>[0,0],b=(Y,se)=>[Y,se];break;case"topMiddle":_=(Y,se)=>[Y/2,0],b=(Y,se)=>[Y/2,se];break;case"topRight":y=!0,_=(Y,se)=>[Y,0],b=(Y,se)=>[0,se];break;case"middleRight":w=!0,_=(Y,se)=>[Y,se/2],b=(Y,se)=>[0,se/2];break;case"bottomRight":y=!0,_=(Y,se)=>[Y,se],b=(Y,se)=>[0,0];break;case"bottomMiddle":_=(Y,se)=>[Y/2,se],b=(Y,se)=>[Y/2,0];break;case"bottomLeft":y=!0,_=(Y,se)=>[0,se],b=(Y,se)=>[Y,0];break;case"middleLeft":w=!0,_=(Y,se)=>[0,se/2],b=(Y,se)=>[Y,se/2];break}let C=_(a,l),M=b(a,l),S=h(...M),k=tn._round(r+S[0]),T=tn._round(o+S[1]),P=1,R=1,O,H;if(t.fromKeyboard)({deltaX:O,deltaY:H}=t);else{let{screenX:Y,screenY:se}=t,[ue,fe]=m(this,Nd);[O,H]=this.screenToPageTranslation(Y-ue,se-fe),m(this,Nd)[0]=Y,m(this,Nd)[1]=se}if([O,H]=f(O/n,H/i),y){let Y=Math.hypot(a,l);P=R=Math.max(Math.min(Math.hypot(M[0]-C[0]-O,M[1]-C[1]-H)/Y,1/a,1/l),c/a,d/l)}else w?P=Math.max(c,Math.min(1,Math.abs(M[0]-C[0]-O)))/a:R=Math.max(d,Math.min(1,Math.abs(M[1]-C[1]-H)))/l;let X=tn._round(a*P),z=tn._round(l*R);S=h(...b(X,z));let ne=k-S[0],re=T-S[1];m(this,lr)||N(this,lr,[this.x,this.y,this.width,this.height]),this.width=X,this.height=z,this.x=ne,this.y=re,this.setDims(n*X,i*z),this.fixAndSetPosition(),this._onResizing()},$T=new WeakSet,V3=function(){N(this,Ja,{savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height}),m(this,Kn)?.toggle(!1),this.parent.togglePointerEvents(!1)},BT=new WeakSet,G3=function(e,t,n){let r=.7*(n/t)+1-.7;if(r===1)return;let o=K(this,Sp,pM).call(this,this.rotation),a=(k,T)=>[o[0]*k+o[2]*T,o[1]*k+o[3]*T],[l,c]=this.parentDimensions,d=this.x,u=this.y,h=this.width,p=this.height,f=tn.MIN_SIZE/l,_=tn.MIN_SIZE/c;r=Math.max(Math.min(r,1/h,1/p),f/h,_/p);let b=tn._round(h*r),y=tn._round(p*r);if(b===h&&y===p)return;m(this,lr)||N(this,lr,[d,u,h,p]);let w=a(h/2,p/2),C=tn._round(d+w[0]),M=tn._round(u+w[1]),S=a(b/2,y/2);this.x=C-S[0],this.y=M-S[1],this.width=b,this.height=y,this.setDims(l*b,c*y),this.fixAndSetPosition(),this._onResizing()},zT=new WeakSet,W3=function(){m(this,Kn)?.toggle(!0),this.parent.togglePointerEvents(!0),K(this,Cp,fM).call(this)},p_=new WeakSet,CP=function(e){let{isMac:t}=ui.platform;e.ctrlKey&&!t||e.shiftKey||e.metaKey&&t?this.parent.toggleSelected(this):this.parent.setSelected(this)},UT=new WeakSet,H3=function(e){let{isSelected:t}=this;this._uiManager.setUpDragSession();let n=!1,i=new AbortController,r=this._uiManager.combinedSignal(i),o={capture:!0,passive:!1,signal:r},a=c=>{i.abort(),N(this,tc,null),N(this,Od,!1),this._uiManager.endDragSession()||K(this,p_,CP).call(this,c),n&&this._onStopDragging()};t&&(N(this,Ep,e.clientX),N(this,xp,e.clientY),N(this,tc,e.pointerId),N(this,r_,e.pointerType),window.addEventListener("pointermove",c=>{n||(n=!0,this._onStartDragging());let{clientX:d,clientY:u,pointerId:h}=c;if(h!==m(this,tc)){vr(c);return}let[p,f]=this.screenToPageTranslation(d-m(this,Ep),u-m(this,xp));N(this,Ep,d),N(this,xp,u),this._uiManager.dragSelectedEditors(p,f)},o),window.addEventListener("touchmove",vr,o),window.addEventListener("pointerdown",c=>{c.pointerType===m(this,r_)&&(m(this,Bd)||c.isPrimary)&&a(c),vr(c)},o));let l=c=>{if(!m(this,tc)||m(this,tc)===c.pointerId){a(c);return}vr(c)};window.addEventListener("pointerup",l,{signal:r}),window.addEventListener("blur",l,{signal:r})},f_=new WeakSet,AP=function(){if(m(this,nc)||!this.div)return;N(this,nc,new AbortController);let e=this._uiManager.combinedSignal(m(this,nc));this.div.addEventListener("focusin",this.focusin.bind(this),{signal:e}),this.div.addEventListener("focusout",this.focusout.bind(this),{signal:e})},VT=new WeakSet,j3=function(e){tn._resizerKeyboardManager.exec(this,e)},GT=new WeakSet,q3=function(e){m(this,Za)&&e.relatedTarget?.parentNode!==m(this,ai)&&K(this,zd,eg).call(this)},WT=new WeakSet,K3=function(e){N(this,o_,m(this,Za)?e:"")},m_=new WeakSet,PP=function(e){if(m(this,mo))for(let t of m(this,mo))t.tabIndex=e},zd=new WeakSet,eg=function(){N(this,Za,!1),K(this,m_,PP).call(this,-1),K(this,Cp,fM).call(this)},L(tn,d_),Z(tn,"_l10n",null),Z(tn,"_l10nResizer",null),Z(tn,"_borderLineWidth",-1),Z(tn,"_colorManager",new mP),Z(tn,"_zIndex",1),Z(tn,"_telemetryTimeout",1e3);var ls=tn,kP=class extends ls{constructor(e){super(e),this.annotationElementId=e.annotationElementId,this.deleted=!0}serialize(){return this.serializeDeleted()}},r3=3285377520,Fr=4294901760,Jo=65535,UM=class{constructor(e){this.h1=e?e&4294967295:r3,this.h2=e?e&4294967295:r3}update(e){let t,n;if(typeof e=="string"){t=new Uint8Array(e.length*2),n=0;for(let _=0,b=e.length;_<b;_++){let y=e.charCodeAt(_);y<=255?t[n++]=y:(t[n++]=y>>>8,t[n++]=y&255)}}else if(ArrayBuffer.isView(e))t=e.slice(),n=t.byteLength;else throw new Error("Invalid data format, must be a string or TypedArray.");let i=n>>2,r=n-i*4,o=new Uint32Array(t.buffer,0,i),a=0,l=0,c=this.h1,d=this.h2,u=3432918353,h=461845907,p=u&Jo,f=h&Jo;for(let _=0;_<i;_++)_&1?(a=o[_],a=a*u&Fr|a*p&Jo,a=a<<15|a>>>17,a=a*h&Fr|a*f&Jo,c^=a,c=c<<13|c>>>19,c=c*5+3864292196):(l=o[_],l=l*u&Fr|l*p&Jo,l=l<<15|l>>>17,l=l*h&Fr|l*f&Jo,d^=l,d=d<<13|d>>>19,d=d*5+3864292196);switch(a=0,r){case 3:a^=t[i*4+2]<<16;case 2:a^=t[i*4+1]<<8;case 1:a^=t[i*4],a=a*u&Fr|a*p&Jo,a=a<<15|a>>>17,a=a*h&Fr|a*f&Jo,i&1?c^=a:d^=a}this.h1=c,this.h2=d}hexdigest(){let e=this.h1,t=this.h2;return e^=t>>>1,e=e*3981806797&Fr|e*36045&Jo,t=t*4283543511&Fr|((t<<16|e>>>16)*2950163797&Fr)>>>16,e^=t>>>1,e=e*444984403&Fr|e*60499&Jo,t=t*3301882366&Fr|((t<<16|e>>>16)*3120437893&Fr)>>>16,e^=t>>>1,(e>>>0).toString(16).padStart(8,"0")+(t>>>0).toString(16).padStart(8,"0")}},IP=Object.freeze({map:null,hash:"",transfer:void 0}),Ud,Vd,Qs,HT,Y3,bg=class{constructor(){L(this,HT);L(this,Ud,!1);L(this,Vd,null);L(this,Qs,new Map);this.onSetModified=null,this.onResetModified=null,this.onAnnotationEditor=null}getValue(e,t){let n=m(this,Qs).get(e);return n===void 0?t:Object.assign(t,n)}getRawValue(e){return m(this,Qs).get(e)}remove(e){if(m(this,Qs).delete(e),m(this,Qs).size===0&&this.resetModified(),typeof this.onAnnotationEditor=="function"){for(let t of m(this,Qs).values())if(t instanceof ls)return;this.onAnnotationEditor(null)}}setValue(e,t){let n=m(this,Qs).get(e),i=!1;if(n!==void 0)for(let[r,o]of Object.entries(t))n[r]!==o&&(i=!0,n[r]=o);else i=!0,m(this,Qs).set(e,t);i&&K(this,HT,Y3).call(this),t instanceof ls&&typeof this.onAnnotationEditor=="function"&&this.onAnnotationEditor(t.constructor._type)}has(e){return m(this,Qs).has(e)}getAll(){return m(this,Qs).size>0?wI(m(this,Qs)):null}setAll(e){for(let[t,n]of Object.entries(e))this.setValue(t,n)}get size(){return m(this,Qs).size}resetModified(){m(this,Ud)&&(N(this,Ud,!1),typeof this.onResetModified=="function"&&this.onResetModified())}get print(){return new VM(this)}get serializable(){if(m(this,Qs).size===0)return IP;let e=new Map,t=new UM,n=[],i=Object.create(null),r=!1;for(let[o,a]of m(this,Qs)){let l=a instanceof ls?a.serialize(!1,i):a;l&&(e.set(o,l),t.update(`${o}:${JSON.stringify(l)}`),r||(r=!!l.bitmap))}if(r)for(let o of e.values())o.bitmap&&n.push(o.bitmap);return e.size>0?{map:e,hash:t.hexdigest(),transfer:n}:IP}get editorStats(){let e=null,t=new Map;for(let n of m(this,Qs).values()){if(!(n instanceof ls))continue;let i=n.telemetryFinalData;if(!i)continue;let{type:r}=i;t.has(r)||t.set(r,Object.getPrototypeOf(n).constructor),e||(e=Object.create(null));let o=e[r]||(e[r]=new Map);for(let[a,l]of Object.entries(i)){if(a==="type")continue;let c=o.get(a);c||(c=new Map,o.set(a,c));let d=c.get(l)??0;c.set(l,d+1)}}for(let[n,i]of t)e[n]=i.computeTelemetryFinalData(e[n]);return e}resetModifiedIds(){N(this,Vd,null)}get modifiedIds(){if(m(this,Vd))return m(this,Vd);let e=[];for(let t of m(this,Qs).values())!(t instanceof ls)||!t.annotationElementId||!t.serialize()||e.push(t.annotationElementId);return N(this,Vd,{ids:new Set(e),hash:e.join(",")})}};Ud=new WeakMap,Vd=new WeakMap,Qs=new WeakMap,HT=new WeakSet,Y3=function(){m(this,Ud)||(N(this,Ud,!0),typeof this.onSetModified=="function"&&this.onSetModified())};var g_,VM=class extends bg{constructor(t){super();L(this,g_,void 0);let{map:n,hash:i,transfer:r}=t.serializable,o=structuredClone(n,r?{transfer:r}:null);N(this,g_,{map:o,hash:i,transfer:r})}get print(){zn("Should not call PrintAnnotationStorage.print")}get serializable(){return m(this,g_)}get modifiedIds(){return an(this,"modifiedIds",{ids:new Set,hash:""})}};g_=new WeakMap;var Ap,DP=class{constructor({ownerDocument:e=globalThis.document,styleElement:t=null}){L(this,Ap,new Set);this._document=e,this.nativeFontFaces=new Set,this.styleElement=null,this.loadingRequests=[],this.loadTestFontId=0}addNativeFontFace(e){this.nativeFontFaces.add(e),this._document.fonts.add(e)}removeNativeFontFace(e){this.nativeFontFaces.delete(e),this._document.fonts.delete(e)}insertRule(e){this.styleElement||(this.styleElement=this._document.createElement("style"),this._document.documentElement.getElementsByTagName("head")[0].append(this.styleElement));let t=this.styleElement.sheet;t.insertRule(e,t.cssRules.length)}clear(){for(let e of this.nativeFontFaces)this._document.fonts.delete(e);this.nativeFontFaces.clear(),m(this,Ap).clear(),this.styleElement&&(this.styleElement.remove(),this.styleElement=null)}async loadSystemFont({systemFontInfo:e,_inspectFont:t}){if(!(!e||m(this,Ap).has(e.loadedName))){if(Ds(!this.disableFontFace,"loadSystemFont shouldn't be called when `disableFontFace` is set."),this.isFontLoadingAPISupported){let{loadedName:n,src:i,style:r}=e,o=new FontFace(n,i,r);this.addNativeFontFace(o);try{await o.load(),m(this,Ap).add(n),t?.(e)}catch{Jt(`Cannot load system font: ${e.baseFontName}, installing it could help to improve PDF rendering.`),this.removeNativeFontFace(o)}return}zn("Not implemented: loadSystemFont without the Font Loading API.")}}async bind(e){if(e.attached||e.missingFile&&!e.systemFontInfo)return;if(e.attached=!0,e.systemFontInfo){await this.loadSystemFont(e);return}if(this.isFontLoadingAPISupported){let n=e.createNativeFontFace();if(n){this.addNativeFontFace(n);try{await n.loaded}catch(i){throw Jt(`Failed to load font '${n.family}': '${i}'.`),e.disableFontFace=!0,i}}return}let t=e.createFontFaceRule();if(t){if(this.insertRule(t),this.isSyncFontLoadingSupported)return;await new Promise(n=>{let i=this._queueLoadingCallback(n);this._prepareFontLoadEvent(e,i)})}}get isFontLoadingAPISupported(){let e=!!this._document?.fonts;return an(this,"isFontLoadingAPISupported",e)}get isSyncFontLoadingSupported(){let e=!1;return(xi||typeof navigator<"u"&&typeof navigator?.userAgent=="string"&&/Mozilla\/5.0.*?rv:\d+.*? Gecko/.test(navigator.userAgent))&&(e=!0),an(this,"isSyncFontLoadingSupported",e)}_queueLoadingCallback(e){function t(){for(Ds(!i.done,"completeRequest() cannot be called twice."),i.done=!0;n.length>0&&n[0].done;){let r=n.shift();setTimeout(r.callback,0)}}let{loadingRequests:n}=this,i={done:!1,complete:t,callback:e};return n.push(i),i}get _loadTestFont(){let e=atob("T1RUTwALAIAAAwAwQ0ZGIDHtZg4AAAOYAAAAgUZGVE1lkzZwAAAEHAAAABxHREVGABQAFQAABDgAAAAeT1MvMlYNYwkAAAEgAAAAYGNtYXABDQLUAAACNAAAAUJoZWFk/xVFDQAAALwAAAA2aGhlYQdkA+oAAAD0AAAAJGhtdHgD6AAAAAAEWAAAAAZtYXhwAAJQAAAAARgAAAAGbmFtZVjmdH4AAAGAAAAAsXBvc3T/hgAzAAADeAAAACAAAQAAAAEAALZRFsRfDzz1AAsD6AAAAADOBOTLAAAAAM4KHDwAAAAAA+gDIQAAAAgAAgAAAAAAAAABAAADIQAAAFoD6AAAAAAD6AABAAAAAAAAAAAAAAAAAAAAAQAAUAAAAgAAAAQD6AH0AAUAAAKKArwAAACMAooCvAAAAeAAMQECAAACAAYJAAAAAAAAAAAAAQAAAAAAAAAAAAAAAFBmRWQAwAAuAC4DIP84AFoDIQAAAAAAAQAAAAAAAAAAACAAIAABAAAADgCuAAEAAAAAAAAAAQAAAAEAAAAAAAEAAQAAAAEAAAAAAAIAAQAAAAEAAAAAAAMAAQAAAAEAAAAAAAQAAQAAAAEAAAAAAAUAAQAAAAEAAAAAAAYAAQAAAAMAAQQJAAAAAgABAAMAAQQJAAEAAgABAAMAAQQJAAIAAgABAAMAAQQJAAMAAgABAAMAAQQJAAQAAgABAAMAAQQJAAUAAgABAAMAAQQJAAYAAgABWABYAAAAAAAAAwAAAAMAAAAcAAEAAAAAADwAAwABAAAAHAAEACAAAAAEAAQAAQAAAC7//wAAAC7////TAAEAAAAAAAABBgAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAAAAAAD/gwAyAAAAAQAAAAAAAAAAAAAAAAAAAAABAAQEAAEBAQJYAAEBASH4DwD4GwHEAvgcA/gXBIwMAYuL+nz5tQXkD5j3CBLnEQACAQEBIVhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYAAABAQAADwACAQEEE/t3Dov6fAH6fAT+fPp8+nwHDosMCvm1Cvm1DAz6fBQAAAAAAAABAAAAAMmJbzEAAAAAzgTjFQAAAADOBOQpAAEAAAAAAAAADAAUAAQAAAABAAAAAgABAAAAAAAAAAAD6AAAAAAAAA==");return an(this,"_loadTestFont",e)}_prepareFontLoadEvent(e,t){function n(M,S){return M.charCodeAt(S)<<24|M.charCodeAt(S+1)<<16|M.charCodeAt(S+2)<<8|M.charCodeAt(S+3)&255}function i(M,S,k,T){let P=M.substring(0,S),R=M.substring(S+k);return P+T+R}let r,o,a=this._document.createElement("canvas");a.width=1,a.height=1;let l=a.getContext("2d"),c=0;function d(M,S){if(++c>30){Jt("Load test font never loaded."),S();return}if(l.font="30px "+M,l.fillText(".",0,20),l.getImageData(0,0,1,1).data[3]>0){S();return}setTimeout(d.bind(null,M,S))}let u=`lt${Date.now()}${this.loadTestFontId++}`,h=this._loadTestFont;h=i(h,976,u.length,u);let f=16,_=1482184792,b=n(h,f);for(r=0,o=u.length-3;r<o;r+=4)b=b-_+n(u,r)|0;r<u.length&&(b=b-_+n(u+"XXX",r)|0),h=i(h,f,4,$ee(b));let y=`url(data:font/opentype;base64,${btoa(h)});`,w=`@font-face {font-family:"${u}";src:${y}}`;this.insertRule(w);let C=this._document.createElement("div");C.style.visibility="hidden",C.style.width=C.style.height="10px",C.style.position="absolute",C.style.top=C.style.left="0px";for(let M of[e.loadedName,u]){let S=this._document.createElement("span");S.textContent="Hi",S.style.fontFamily=M,C.append(S)}this._document.body.append(C),d(u,()=>{C.remove(),t.complete()})}};Ap=new WeakMap;var RP=class{constructor(e,{disableFontFace:t=!1,fontExtraProperties:n=!1,inspectFont:i=null}){this.compiledGlyphs=Object.create(null);for(let r in e)this[r]=e[r];this.disableFontFace=t===!0,this.fontExtraProperties=n===!0,this._inspectFont=i}createNativeFontFace(){if(!this.data||this.disableFontFace)return null;let e;if(!this.cssFontInfo)e=new FontFace(this.loadedName,this.data,{});else{let t={weight:this.cssFontInfo.fontWeight};this.cssFontInfo.italicAngle&&(t.style=`oblique ${this.cssFontInfo.italicAngle}deg`),e=new FontFace(this.cssFontInfo.fontFamily,this.data,t)}return this._inspectFont?.(this),e}createFontFaceRule(){if(!this.data||this.disableFontFace)return null;let e=`url(data:${this.mimetype};base64,${Wee(this.data)});`,t;if(!this.cssFontInfo)t=`@font-face {font-family:"${this.loadedName}";src:${e}}`;else{let n=`font-weight: ${this.cssFontInfo.fontWeight};`;this.cssFontInfo.italicAngle&&(n+=`font-style: oblique ${this.cssFontInfo.italicAngle}deg;`),t=`@font-face {font-family:"${this.cssFontInfo.fontFamily}";${n}src:${e}}`}return this._inspectFont?.(this,e),t}getPathGenerator(e,t){if(this.compiledGlyphs[t]!==void 0)return this.compiledGlyphs[t];let n=this.loadedName+"_path_"+t,i;try{i=e.get(n)}catch(o){Jt(`getPathGenerator - ignoring character: "${o}".`)}let r=new Path2D(i||"");return this.fontExtraProperties||e.delete(n),this.compiledGlyphs[t]=r}},tM={DATA:1,ERROR:2},Is={CANCEL:1,CANCEL_COMPLETE:2,CLOSE:3,ENQUEUE:4,ERROR:5,PULL:6,PULL_COMPLETE:7,START_COMPLETE:8};function o3(){}function ji(s){if(s instanceof ya||s instanceof gg||s instanceof Ou||s instanceof NM||s instanceof $f||s instanceof pg)return s;switch(s instanceof Error||typeof s=="object"&&s!==null||zn('wrapReason: Expected "reason" to be a (possibly cloned) Error.'),s.name){case"AbortException":return new ya(s.message);case"InvalidPDFException":return new gg(s.message);case"MissingPDFException":return new Ou(s.message);case"PasswordException":return new NM(s.message,s.code);case"UnexpectedResponseException":return new $f(s.message,s.status);case"UnknownErrorException":return new pg(s.message,s.details)}return new pg(s.message,s.toString())}var Pp,jT,X3,qT,Q3,KT,J3,kp,mM,vd=class{constructor(e,t,n){L(this,jT);L(this,qT);L(this,KT);L(this,kp);L(this,Pp,new AbortController);this.sourceName=e,this.targetName=t,this.comObj=n,this.callbackId=1,this.streamId=1,this.streamSinks=Object.create(null),this.streamControllers=Object.create(null),this.callbackCapabilities=Object.create(null),this.actionHandler=Object.create(null),n.addEventListener("message",K(this,jT,X3).bind(this),{signal:m(this,Pp).signal})}on(e,t){let n=this.actionHandler;if(n[e])throw new Error(`There is already an actionName called "${e}"`);n[e]=t}send(e,t,n){this.comObj.postMessage({sourceName:this.sourceName,targetName:this.targetName,action:e,data:t},n)}sendWithPromise(e,t,n){let i=this.callbackId++,r=Promise.withResolvers();this.callbackCapabilities[i]=r;try{this.comObj.postMessage({sourceName:this.sourceName,targetName:this.targetName,action:e,callbackId:i,data:t},n)}catch(o){r.reject(o)}return r.promise}sendWithStream(e,t,n,i){let r=this.streamId++,o=this.sourceName,a=this.targetName,l=this.comObj;return new ReadableStream({start:c=>{let d=Promise.withResolvers();return this.streamControllers[r]={controller:c,startCall:d,pullCall:null,cancelCall:null,isClosed:!1},l.postMessage({sourceName:o,targetName:a,action:e,streamId:r,data:t,desiredSize:c.desiredSize},i),d.promise},pull:c=>{let d=Promise.withResolvers();return this.streamControllers[r].pullCall=d,l.postMessage({sourceName:o,targetName:a,stream:Is.PULL,streamId:r,desiredSize:c.desiredSize}),d.promise},cancel:c=>{Ds(c instanceof Error,"cancel must have a valid reason");let d=Promise.withResolvers();return this.streamControllers[r].cancelCall=d,this.streamControllers[r].isClosed=!0,l.postMessage({sourceName:o,targetName:a,stream:Is.CANCEL,streamId:r,reason:ji(c)}),d.promise}},n)}destroy(){m(this,Pp)?.abort(),N(this,Pp,null)}};Pp=new WeakMap,jT=new WeakSet,X3=function({data:e}){if(e.targetName!==this.sourceName)return;if(e.stream){K(this,KT,J3).call(this,e);return}if(e.callback){let n=e.callbackId,i=this.callbackCapabilities[n];if(!i)throw new Error(`Cannot resolve callback ${n}`);if(delete this.callbackCapabilities[n],e.callback===tM.DATA)i.resolve(e.data);else if(e.callback===tM.ERROR)i.reject(ji(e.reason));else throw new Error("Unexpected callback case");return}let t=this.actionHandler[e.action];if(!t)throw new Error(`Unknown action from worker: ${e.action}`);if(e.callbackId){let n=this.sourceName,i=e.sourceName,r=this.comObj;Promise.try(t,e.data).then(function(o){r.postMessage({sourceName:n,targetName:i,callback:tM.DATA,callbackId:e.callbackId,data:o})},function(o){r.postMessage({sourceName:n,targetName:i,callback:tM.ERROR,callbackId:e.callbackId,reason:ji(o)})});return}if(e.streamId){K(this,qT,Q3).call(this,e);return}t(e.data)},qT=new WeakSet,Q3=function(e){let t=e.streamId,n=this.sourceName,i=e.sourceName,r=this.comObj,o=this,a=this.actionHandler[e.action],l={enqueue(c,d=1,u){if(this.isCancelled)return;let h=this.desiredSize;this.desiredSize-=d,h>0&&this.desiredSize<=0&&(this.sinkCapability=Promise.withResolvers(),this.ready=this.sinkCapability.promise),r.postMessage({sourceName:n,targetName:i,stream:Is.ENQUEUE,streamId:t,chunk:c},u)},close(){this.isCancelled||(this.isCancelled=!0,r.postMessage({sourceName:n,targetName:i,stream:Is.CLOSE,streamId:t}),delete o.streamSinks[t])},error(c){Ds(c instanceof Error,"error must have a valid reason"),!this.isCancelled&&(this.isCancelled=!0,r.postMessage({sourceName:n,targetName:i,stream:Is.ERROR,streamId:t,reason:ji(c)}))},sinkCapability:Promise.withResolvers(),onPull:null,onCancel:null,isCancelled:!1,desiredSize:e.desiredSize,ready:null};l.sinkCapability.resolve(),l.ready=l.sinkCapability.promise,this.streamSinks[t]=l,Promise.try(a,e.data,l).then(function(){r.postMessage({sourceName:n,targetName:i,stream:Is.START_COMPLETE,streamId:t,success:!0})},function(c){r.postMessage({sourceName:n,targetName:i,stream:Is.START_COMPLETE,streamId:t,reason:ji(c)})})},KT=new WeakSet,J3=function(e){let t=e.streamId,n=this.sourceName,i=e.sourceName,r=this.comObj,o=this.streamControllers[t],a=this.streamSinks[t];switch(e.stream){case Is.START_COMPLETE:e.success?o.startCall.resolve():o.startCall.reject(ji(e.reason));break;case Is.PULL_COMPLETE:e.success?o.pullCall.resolve():o.pullCall.reject(ji(e.reason));break;case Is.PULL:if(!a){r.postMessage({sourceName:n,targetName:i,stream:Is.PULL_COMPLETE,streamId:t,success:!0});break}a.desiredSize<=0&&e.desiredSize>0&&a.sinkCapability.resolve(),a.desiredSize=e.desiredSize,Promise.try(a.onPull||o3).then(function(){r.postMessage({sourceName:n,targetName:i,stream:Is.PULL_COMPLETE,streamId:t,success:!0})},function(c){r.postMessage({sourceName:n,targetName:i,stream:Is.PULL_COMPLETE,streamId:t,reason:ji(c)})});break;case Is.ENQUEUE:if(Ds(o,"enqueue should have stream controller"),o.isClosed)break;o.controller.enqueue(e.chunk);break;case Is.CLOSE:if(Ds(o,"close should have stream controller"),o.isClosed)break;o.isClosed=!0,o.controller.close(),K(this,kp,mM).call(this,o,t);break;case Is.ERROR:Ds(o,"error should have stream controller"),o.controller.error(ji(e.reason)),K(this,kp,mM).call(this,o,t);break;case Is.CANCEL_COMPLETE:e.success?o.cancelCall.resolve():o.cancelCall.reject(ji(e.reason)),K(this,kp,mM).call(this,o,t);break;case Is.CANCEL:if(!a)break;let l=ji(e.reason);Promise.try(a.onCancel||o3,l).then(function(){r.postMessage({sourceName:n,targetName:i,stream:Is.CANCEL_COMPLETE,streamId:t,success:!0})},function(c){r.postMessage({sourceName:n,targetName:i,stream:Is.CANCEL_COMPLETE,streamId:t,reason:ji(c)})}),a.sinkCapability.reject(l),a.isCancelled=!0,delete this.streamSinks[t];break;default:throw new Error("Unexpected stream case")}},kp=new WeakSet,mM=async function(e,t){await Promise.allSettled([e.startCall?.promise,e.pullCall?.promise,e.cancelCall?.promise]),delete this.streamControllers[t]};var __,GM=class{constructor({enableHWA:e=!1}){L(this,__,!1);N(this,__,e)}create(e,t){if(e<=0||t<=0)throw new Error("Invalid canvas size");let n=this._createCanvas(e,t);return{canvas:n,context:n.getContext("2d",{willReadFrequently:!m(this,__)})}}reset(e,t,n){if(!e.canvas)throw new Error("Canvas is not specified");if(t<=0||n<=0)throw new Error("Invalid canvas size");e.canvas.width=t,e.canvas.height=n}destroy(e){if(!e.canvas)throw new Error("Canvas is not specified");e.canvas.width=0,e.canvas.height=0,e.canvas=null,e.context=null}_createCanvas(e,t){zn("Abstract method `_createCanvas` called.")}};__=new WeakMap;var FP=class extends GM{constructor({ownerDocument:e=globalThis.document,enableHWA:t=!1}){super({enableHWA:t}),this._document=e}_createCanvas(e,t){let n=this._document.createElement("canvas");return n.width=e,n.height=t,n}},WM=class{constructor({baseUrl:e=null,isCompressed:t=!0}){this.baseUrl=e,this.isCompressed=t}async fetch({name:e}){if(!this.baseUrl)throw new Error("Ensure that the `cMapUrl` and `cMapPacked` API parameters are provided.");if(!e)throw new Error("CMap name must be specified.");let t=this.baseUrl+e+(this.isCompressed?".bcmap":"");return this._fetch(t).then(n=>({cMapData:n,isCompressed:this.isCompressed})).catch(n=>{throw new Error(`Unable to load ${this.isCompressed?"binary ":""}CMap at: ${t}`)})}async _fetch(e){zn("Abstract method `_fetch` called.")}},HM=class extends WM{async _fetch(e){let t=await e0(e,this.isCompressed?"arraybuffer":"text");return t instanceof ArrayBuffer?new Uint8Array(t):ZE(t)}},jM=class{addFilter(e){return"none"}addHCMFilter(e,t){return"none"}addAlphaFilter(e){return"none"}addLuminosityFilter(e){return"none"}addHighlightHCMFilter(e,t,n,i,r){return"none"}destroy(e=!1){}},Gd,Ip,el,tl,wi,Wd,Hd,Js,yi,jd,tg,sc,Xh,Dp,gM,ic,Qh,YT,Z3,y_,NP,rc,Jh,qd,ng,Kd,sg,v_,OP,Yd,ig,LP=class extends jM{constructor({docId:t,ownerDocument:n=globalThis.document}){super();L(this,Js);L(this,jd);L(this,sc);L(this,Dp);L(this,ic);L(this,YT);L(this,y_);L(this,rc);L(this,qd);L(this,Kd);L(this,v_);L(this,Yd);L(this,Gd,void 0);L(this,Ip,void 0);L(this,el,void 0);L(this,tl,void 0);L(this,wi,void 0);L(this,Wd,void 0);L(this,Hd,0);N(this,tl,t),N(this,wi,n)}addFilter(t){if(!t)return"none";let n=m(this,Js,yi).get(t);if(n)return n;let[i,r,o]=K(this,Dp,gM).call(this,t),a=t.length===1?i:`${i}${r}${o}`;if(n=m(this,Js,yi).get(a),n)return m(this,Js,yi).set(t,n),n;let l=`g_${m(this,tl)}_transfer_map_${Ii(this,Hd)._++}`,c=K(this,ic,Qh).call(this,l);m(this,Js,yi).set(t,c),m(this,Js,yi).set(a,c);let d=K(this,rc,Jh).call(this,l);return K(this,Kd,sg).call(this,i,r,o,d),c}addHCMFilter(t,n){let i=`${t}-${n}`,r="base",o=m(this,jd,tg).get(r);if(o?.key===i||(o?(o.filter?.remove(),o.key=i,o.url="none",o.filter=null):(o={key:i,url:"none",filter:null},m(this,jd,tg).set(r,o)),!t||!n))return o.url;let a=K(this,Yd,ig).call(this,t);t=At.makeHexColor(...a);let l=K(this,Yd,ig).call(this,n);if(n=At.makeHexColor(...l),m(this,sc,Xh).style.color="",t==="#000000"&&n==="#ffffff"||t===n)return o.url;let c=new Array(256);for(let f=0;f<=255;f++){let _=f/255;c[f]=_<=.03928?_/12.92:((_+.055)/1.055)**2.4}let d=c.join(","),u=`g_${m(this,tl)}_hcm_filter`,h=o.filter=K(this,rc,Jh).call(this,u);K(this,Kd,sg).call(this,d,d,d,h),K(this,y_,NP).call(this,h);let p=(f,_)=>{let b=a[f]/255,y=l[f]/255,w=new Array(_+1);for(let C=0;C<=_;C++)w[C]=b+C/_*(y-b);return w.join(",")};return K(this,Kd,sg).call(this,p(0,5),p(1,5),p(2,5),h),o.url=K(this,ic,Qh).call(this,u),o.url}addAlphaFilter(t){let n=m(this,Js,yi).get(t);if(n)return n;let[i]=K(this,Dp,gM).call(this,[t]),r=`alpha_${i}`;if(n=m(this,Js,yi).get(r),n)return m(this,Js,yi).set(t,n),n;let o=`g_${m(this,tl)}_alpha_map_${Ii(this,Hd)._++}`,a=K(this,ic,Qh).call(this,o);m(this,Js,yi).set(t,a),m(this,Js,yi).set(r,a);let l=K(this,rc,Jh).call(this,o);return K(this,v_,OP).call(this,i,l),a}addLuminosityFilter(t){let n=m(this,Js,yi).get(t||"luminosity");if(n)return n;let i,r;if(t?([i]=K(this,Dp,gM).call(this,[t]),r=`luminosity_${i}`):r="luminosity",n=m(this,Js,yi).get(r),n)return m(this,Js,yi).set(t,n),n;let o=`g_${m(this,tl)}_luminosity_map_${Ii(this,Hd)._++}`,a=K(this,ic,Qh).call(this,o);m(this,Js,yi).set(t,a),m(this,Js,yi).set(r,a);let l=K(this,rc,Jh).call(this,o);return K(this,YT,Z3).call(this,l),t&&K(this,v_,OP).call(this,i,l),a}addHighlightHCMFilter(t,n,i,r,o){let a=`${n}-${i}-${r}-${o}`,l=m(this,jd,tg).get(t);if(l?.key===a||(l?(l.filter?.remove(),l.key=a,l.url="none",l.filter=null):(l={key:a,url:"none",filter:null},m(this,jd,tg).set(t,l)),!n||!i))return l.url;let[c,d]=[n,i].map(K(this,Yd,ig).bind(this)),u=Math.round(.2126*c[0]+.7152*c[1]+.0722*c[2]),h=Math.round(.2126*d[0]+.7152*d[1]+.0722*d[2]),[p,f]=[r,o].map(K(this,Yd,ig).bind(this));h<u&&([u,h,p,f]=[h,u,f,p]),m(this,sc,Xh).style.color="";let _=(w,C,M)=>{let S=new Array(256),k=(h-u)/M,T=w/255,P=(C-w)/(255*M),R=0;for(let O=0;O<=M;O++){let H=Math.round(u+O*k),X=T+O*P;for(let z=R;z<=H;z++)S[z]=X;R=H+1}for(let O=R;O<256;O++)S[O]=S[R-1];return S.join(",")},b=`g_${m(this,tl)}_hcm_${t}_filter`,y=l.filter=K(this,rc,Jh).call(this,b);return K(this,y_,NP).call(this,y),K(this,Kd,sg).call(this,_(p[0],f[0],5),_(p[1],f[1],5),_(p[2],f[2],5),y),l.url=K(this,ic,Qh).call(this,b),l.url}destroy(t=!1){t&&m(this,Wd)?.size||(m(this,el)?.parentNode.parentNode.remove(),N(this,el,null),m(this,Ip)?.clear(),N(this,Ip,null),m(this,Wd)?.clear(),N(this,Wd,null),N(this,Hd,0))}};Gd=new WeakMap,Ip=new WeakMap,el=new WeakMap,tl=new WeakMap,wi=new WeakMap,Wd=new WeakMap,Hd=new WeakMap,Js=new WeakSet,yi=function(){return m(this,Ip)||N(this,Ip,new Map)},jd=new WeakSet,tg=function(){return m(this,Wd)||N(this,Wd,new Map)},sc=new WeakSet,Xh=function(){if(!m(this,el)){let t=m(this,wi).createElement("div"),{style:n}=t;n.visibility="hidden",n.contain="strict",n.width=n.height=0,n.position="absolute",n.top=n.left=0,n.zIndex=-1;let i=m(this,wi).createElementNS(Va,"svg");i.setAttribute("width",0),i.setAttribute("height",0),N(this,el,m(this,wi).createElementNS(Va,"defs")),t.append(i),i.append(m(this,el)),m(this,wi).body.append(t)}return m(this,el)},Dp=new WeakSet,gM=function(t){if(t.length===1){let c=t[0],d=new Array(256);for(let h=0;h<256;h++)d[h]=c[h]/255;let u=d.join(",");return[u,u,u]}let[n,i,r]=t,o=new Array(256),a=new Array(256),l=new Array(256);for(let c=0;c<256;c++)o[c]=n[c]/255,a[c]=i[c]/255,l[c]=r[c]/255;return[o.join(","),a.join(","),l.join(",")]},ic=new WeakSet,Qh=function(t){if(m(this,Gd)===void 0){N(this,Gd,"");let n=m(this,wi).URL;n!==m(this,wi).baseURI&&(t0(n)?Jt('#createUrl: ignore "data:"-URL for performance reasons.'):N(this,Gd,n.split("#",1)[0]))}return`url(${m(this,Gd)}#${t})`},YT=new WeakSet,Z3=function(t){let n=m(this,wi).createElementNS(Va,"feColorMatrix");n.setAttribute("type","matrix"),n.setAttribute("values","0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.3 0.59 0.11 0 0"),t.append(n)},y_=new WeakSet,NP=function(t){let n=m(this,wi).createElementNS(Va,"feColorMatrix");n.setAttribute("type","matrix"),n.setAttribute("values","0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0 0 0 1 0"),t.append(n)},rc=new WeakSet,Jh=function(t){let n=m(this,wi).createElementNS(Va,"filter");return n.setAttribute("color-interpolation-filters","sRGB"),n.setAttribute("id",t),m(this,sc,Xh).append(n),n},qd=new WeakSet,ng=function(t,n,i){let r=m(this,wi).createElementNS(Va,n);r.setAttribute("type","discrete"),r.setAttribute("tableValues",i),t.append(r)},Kd=new WeakSet,sg=function(t,n,i,r){let o=m(this,wi).createElementNS(Va,"feComponentTransfer");r.append(o),K(this,qd,ng).call(this,o,"feFuncR",t),K(this,qd,ng).call(this,o,"feFuncG",n),K(this,qd,ng).call(this,o,"feFuncB",i)},v_=new WeakSet,OP=function(t,n){let i=m(this,wi).createElementNS(Va,"feComponentTransfer");n.append(i),K(this,qd,ng).call(this,i,"feFuncA",t)},Yd=new WeakSet,ig=function(t){return m(this,sc,Xh).style.color=t,EI(getComputedStyle(m(this,sc,Xh)).getPropertyValue("color"))};var qM=class{constructor({baseUrl:e=null}){this.baseUrl=e}async fetch({filename:e}){if(!this.baseUrl)throw new Error("Ensure that the `standardFontDataUrl` API parameter is provided.");if(!e)throw new Error("Font filename must be specified.");let t=`${this.baseUrl}${e}`;return this._fetch(t).catch(n=>{throw new Error(`Unable to load font data at: ${t}`)})}async _fetch(e){zn("Abstract method `_fetch` called.")}},KM=class extends qM{async _fetch(e){let t=await e0(e,"arraybuffer");return new Uint8Array(t)}};xi&&Jt("Please use the `legacy` build in Node.js environments.");async function eV(s){let t=await process.getBuiltinModule("fs").promises.readFile(s);return new Uint8Array(t)}var $P=class extends jM{},BP=class extends GM{_createCanvas(e,t){return process.getBuiltinModule("module").createRequire(Ete.url)("@napi-rs/canvas").createCanvas(e,t)}},zP=class extends WM{async _fetch(e){return eV(e)}},UP=class extends qM{async _fetch(e){return eV(e)}},Ei={FILL:"Fill",STROKE:"Stroke",SHADING:"Shading"};function VP(s,e){if(!e)return;let t=e[2]-e[0],n=e[3]-e[1],i=new Path2D;i.rect(e[0],e[1],t,n),s.clip(i)}var wg=class{getPattern(){zn("Abstract method `getPattern` called.")}},GP=class extends wg{constructor(e){super(),this._type=e[1],this._bbox=e[2],this._colorStops=e[3],this._p0=e[4],this._p1=e[5],this._r0=e[6],this._r1=e[7],this.matrix=null}_createGradient(e){let t;this._type==="axial"?t=e.createLinearGradient(this._p0[0],this._p0[1],this._p1[0],this._p1[1]):this._type==="radial"&&(t=e.createRadialGradient(this._p0[0],this._p0[1],this._r0,this._p1[0],this._p1[1],this._r1));for(let n of this._colorStops)t.addColorStop(n[0],n[1]);return t}getPattern(e,t,n,i){let r;if(i===Ei.STROKE||i===Ei.FILL){let o=t.current.getClippedPathBoundingBox(i,Zn(e))||[0,0,0,0],a=Math.ceil(o[2]-o[0])||1,l=Math.ceil(o[3]-o[1])||1,c=t.cachedCanvases.getCanvas("pattern",a,l),d=c.context;d.clearRect(0,0,d.canvas.width,d.canvas.height),d.beginPath(),d.rect(0,0,d.canvas.width,d.canvas.height),d.translate(-o[0],-o[1]),n=At.transform(n,[1,0,0,1,o[0],o[1]]),d.transform(...t.baseTransform),this.matrix&&d.transform(...this.matrix),VP(d,this._bbox),d.fillStyle=this._createGradient(d),d.fill(),r=e.createPattern(c.canvas,"no-repeat");let u=new DOMMatrix(n);r.setTransform(u)}else VP(e,this._bbox),r=this._createGradient(e);return r}};function sP(s,e,t,n,i,r,o,a){let l=e.coords,c=e.colors,d=s.data,u=s.width*4,h;l[t+1]>l[n+1]&&(h=t,t=n,n=h,h=r,r=o,o=h),l[n+1]>l[i+1]&&(h=n,n=i,i=h,h=o,o=a,a=h),l[t+1]>l[n+1]&&(h=t,t=n,n=h,h=r,r=o,o=h);let p=(l[t]+e.offsetX)*e.scaleX,f=(l[t+1]+e.offsetY)*e.scaleY,_=(l[n]+e.offsetX)*e.scaleX,b=(l[n+1]+e.offsetY)*e.scaleY,y=(l[i]+e.offsetX)*e.scaleX,w=(l[i+1]+e.offsetY)*e.scaleY;if(f>=w)return;let C=c[r],M=c[r+1],S=c[r+2],k=c[o],T=c[o+1],P=c[o+2],R=c[a],O=c[a+1],H=c[a+2],X=Math.round(f),z=Math.round(w),ne,re,Y,se,ue,fe,Pe,oe;for(let te=X;te<=z;te++){if(te<b){let xe=te<f?0:(f-te)/(f-b);ne=p-(p-_)*xe,re=C-(C-k)*xe,Y=M-(M-T)*xe,se=S-(S-P)*xe}else{let xe;te>w?xe=1:b===w?xe=0:xe=(b-te)/(b-w),ne=_-(_-y)*xe,re=k-(k-R)*xe,Y=T-(T-O)*xe,se=P-(P-H)*xe}let j;te<f?j=0:te>w?j=1:j=(f-te)/(f-w),ue=p-(p-y)*j,fe=C-(C-R)*j,Pe=M-(M-O)*j,oe=S-(S-H)*j;let G=Math.round(Math.min(ne,ue)),de=Math.round(Math.max(ne,ue)),be=u*te+G*4;for(let xe=G;xe<=de;xe++)j=(ne-xe)/(ne-ue),j<0?j=0:j>1&&(j=1),d[be++]=re-(re-fe)*j|0,d[be++]=Y-(Y-Pe)*j|0,d[be++]=se-(se-oe)*j|0,d[be++]=255}}function Yee(s,e,t){let n=e.coords,i=e.colors,r,o;switch(e.type){case"lattice":let a=e.verticesPerRow,l=Math.floor(n.length/a)-1,c=a-1;for(r=0;r<l;r++){let d=r*a;for(let u=0;u<c;u++,d++)sP(s,t,n[d],n[d+1],n[d+a],i[d],i[d+1],i[d+a]),sP(s,t,n[d+a+1],n[d+1],n[d+a],i[d+a+1],i[d+1],i[d+a])}break;case"triangles":for(r=0,o=n.length;r<o;r+=3)sP(s,t,n[r],n[r+1],n[r+2],i[r],i[r+1],i[r+2]);break;default:throw new Error("illegal figure")}}var WP=class extends wg{constructor(e){super(),this._coords=e[2],this._colors=e[3],this._figures=e[4],this._bounds=e[5],this._bbox=e[7],this._background=e[8],this.matrix=null}_createMeshCanvas(e,t,n){let a=Math.floor(this._bounds[0]),l=Math.floor(this._bounds[1]),c=Math.ceil(this._bounds[2])-a,d=Math.ceil(this._bounds[3])-l,u=Math.min(Math.ceil(Math.abs(c*e[0]*1.1)),3e3),h=Math.min(Math.ceil(Math.abs(d*e[1]*1.1)),3e3),p=c/u,f=d/h,_={coords:this._coords,colors:this._colors,offsetX:-a,offsetY:-l,scaleX:1/p,scaleY:1/f},b=u+2*2,y=h+2*2,w=n.getCanvas("mesh",b,y),C=w.context,M=C.createImageData(u,h);if(t){let k=M.data;for(let T=0,P=k.length;T<P;T+=4)k[T]=t[0],k[T+1]=t[1],k[T+2]=t[2],k[T+3]=255}for(let k of this._figures)Yee(M,k,_);return C.putImageData(M,2,2),{canvas:w.canvas,offsetX:a-2*p,offsetY:l-2*f,scaleX:p,scaleY:f}}getPattern(e,t,n,i){VP(e,this._bbox);let r;if(i===Ei.SHADING)r=At.singularValueDecompose2dScale(Zn(e));else if(r=At.singularValueDecompose2dScale(t.baseTransform),this.matrix){let a=At.singularValueDecompose2dScale(this.matrix);r=[r[0]*a[0],r[1]*a[1]]}let o=this._createMeshCanvas(r,i===Ei.SHADING?null:this._background,t.cachedCanvases);return i!==Ei.SHADING&&(e.setTransform(...t.baseTransform),this.matrix&&e.transform(...this.matrix)),e.translate(o.offsetX,o.offsetY),e.scale(o.scaleX,o.scaleY),e.createPattern(o.canvas,"no-repeat")}},HP=class extends wg{getPattern(){return"hotpink"}};function Xee(s){switch(s[0]){case"RadialAxial":return new GP(s);case"Mesh":return new WP(s);case"Dummy":return new HP}throw new Error(`Unknown IR type: ${s[0]}`)}var a3={COLORED:1,UNCOLORED:2},XT=class XT{constructor(e,t,n,i,r){this.operatorList=e[2],this.matrix=e[3],this.bbox=e[4],this.xstep=e[5],this.ystep=e[6],this.paintType=e[7],this.tilingType=e[8],this.color=t,this.ctx=n,this.canvasGraphicsFactory=i,this.baseTransform=r}createPatternCanvas(e){let{bbox:t,operatorList:n,paintType:i,tilingType:r,color:o,canvasGraphicsFactory:a}=this,{xstep:l,ystep:c}=this;l=Math.abs(l),c=Math.abs(c),JE("TilingType: "+r);let d=t[0],u=t[1],h=t[2],p=t[3],f=h-d,_=p-u,b=At.singularValueDecompose2dScale(this.matrix),y=At.singularValueDecompose2dScale(this.baseTransform),w=b[0]*y[0],C=b[1]*y[1],M=f,S=_,k=!1,T=!1,P=Math.ceil(l*w),R=Math.ceil(c*C),O=Math.ceil(f*w),H=Math.ceil(_*C);P>=O?M=l:k=!0,R>=H?S=c:T=!0;let X=this.getSizeAndScale(M,this.ctx.canvas.width,w),z=this.getSizeAndScale(S,this.ctx.canvas.height,C),ne=e.cachedCanvases.getCanvas("pattern",X.size,z.size),re=ne.context,Y=a.createCanvasGraphics(re);if(Y.groupLevel=e.groupLevel,this.setFillAndStrokeStyleToContext(Y,i,o),re.translate(-X.scale*d,-z.scale*u),Y.transform(X.scale,0,0,z.scale,0,0),re.save(),this.clipBbox(Y,d,u,h,p),Y.baseTransform=Zn(Y.ctx),Y.executeOperatorList(n),Y.endDrawing(),re.restore(),k||T){let se=ne.canvas;k&&(M=l),T&&(S=c);let ue=this.getSizeAndScale(M,this.ctx.canvas.width,w),fe=this.getSizeAndScale(S,this.ctx.canvas.height,C),Pe=ue.size,oe=fe.size,te=e.cachedCanvases.getCanvas("pattern-workaround",Pe,oe),j=te.context,G=k?Math.floor(f/l):0,de=T?Math.floor(_/c):0;for(let be=0;be<=G;be++)for(let xe=0;xe<=de;xe++)j.drawImage(se,Pe*be,oe*xe,Pe,oe,0,0,Pe,oe);return{canvas:te.canvas,scaleX:ue.scale,scaleY:fe.scale,offsetX:d,offsetY:u}}return{canvas:ne.canvas,scaleX:X.scale,scaleY:z.scale,offsetX:d,offsetY:u}}getSizeAndScale(e,t,n){let i=Math.max(XT.MAX_PATTERN_SIZE,t),r=Math.ceil(e*n);return r>=i?r=i:n=r/e,{scale:n,size:r}}clipBbox(e,t,n,i,r){let o=i-t,a=r-n;e.ctx.rect(t,n,o,a),e.current.updateRectMinMax(Zn(e.ctx),[t,n,i,r]),e.clip(),e.endPath()}setFillAndStrokeStyleToContext(e,t,n){let i=e.ctx,r=e.current;switch(t){case a3.COLORED:let o=this.ctx;i.fillStyle=o.fillStyle,i.strokeStyle=o.strokeStyle,r.fillColor=o.fillStyle,r.strokeColor=o.strokeStyle;break;case a3.UNCOLORED:let a=At.makeHexColor(n[0],n[1],n[2]);i.fillStyle=a,i.strokeStyle=a,r.fillColor=a,r.strokeColor=a;break;default:throw new aP(`Unsupported paint type: ${t}`)}}getPattern(e,t,n,i){let r=n;i!==Ei.SHADING&&(r=At.transform(r,t.baseTransform),this.matrix&&(r=At.transform(r,this.matrix)));let o=this.createPatternCanvas(t),a=new DOMMatrix(r);a=a.translate(o.offsetX,o.offsetY),a=a.scale(1/o.scaleX,1/o.scaleY);let l=e.createPattern(o.canvas,"repeat");return l.setTransform(a),l}};Z(XT,"MAX_PATTERN_SIZE",3e3);var jP=XT;function Qee({src:s,srcPos:e=0,dest:t,width:n,height:i,nonBlackColor:r=4294967295,inverseDecode:o=!1}){let a=ui.isLittleEndian?4278190080:255,[l,c]=o?[r,a]:[a,r],d=n>>3,u=n&7,h=s.length;t=new Uint32Array(t.buffer);let p=0;for(let f=0;f<i;f++){for(let b=e+d;e<b;e++){let y=e<h?s[e]:255;t[p++]=y&128?c:l,t[p++]=y&64?c:l,t[p++]=y&32?c:l,t[p++]=y&16?c:l,t[p++]=y&8?c:l,t[p++]=y&4?c:l,t[p++]=y&2?c:l,t[p++]=y&1?c:l}if(u===0)continue;let _=e<h?s[e++]:255;for(let b=0;b<u;b++)t[p++]=_&1<<7-b?c:l}return{srcPos:e,destPos:p}}var l3=16,c3=100,Jee=15,d3=10,u3=1e3,Qi=16;function Zee(s,e){if(s._removeMirroring)throw new Error("Context is already forwarding operations.");s.__originalSave=s.save,s.__originalRestore=s.restore,s.__originalRotate=s.rotate,s.__originalScale=s.scale,s.__originalTranslate=s.translate,s.__originalTransform=s.transform,s.__originalSetTransform=s.setTransform,s.__originalResetTransform=s.resetTransform,s.__originalClip=s.clip,s.__originalMoveTo=s.moveTo,s.__originalLineTo=s.lineTo,s.__originalBezierCurveTo=s.bezierCurveTo,s.__originalRect=s.rect,s.__originalClosePath=s.closePath,s.__originalBeginPath=s.beginPath,s._removeMirroring=()=>{s.save=s.__originalSave,s.restore=s.__originalRestore,s.rotate=s.__originalRotate,s.scale=s.__originalScale,s.translate=s.__originalTranslate,s.transform=s.__originalTransform,s.setTransform=s.__originalSetTransform,s.resetTransform=s.__originalResetTransform,s.clip=s.__originalClip,s.moveTo=s.__originalMoveTo,s.lineTo=s.__originalLineTo,s.bezierCurveTo=s.__originalBezierCurveTo,s.rect=s.__originalRect,s.closePath=s.__originalClosePath,s.beginPath=s.__originalBeginPath,delete s._removeMirroring},s.save=function(){e.save(),this.__originalSave()},s.restore=function(){e.restore(),this.__originalRestore()},s.translate=function(n,i){e.translate(n,i),this.__originalTranslate(n,i)},s.scale=function(n,i){e.scale(n,i),this.__originalScale(n,i)},s.transform=function(n,i,r,o,a,l){e.transform(n,i,r,o,a,l),this.__originalTransform(n,i,r,o,a,l)},s.setTransform=function(n,i,r,o,a,l){e.setTransform(n,i,r,o,a,l),this.__originalSetTransform(n,i,r,o,a,l)},s.resetTransform=function(){e.resetTransform(),this.__originalResetTransform()},s.rotate=function(n){e.rotate(n),this.__originalRotate(n)},s.clip=function(n){e.clip(n),this.__originalClip(n)},s.moveTo=function(t,n){e.moveTo(t,n),this.__originalMoveTo(t,n)},s.lineTo=function(t,n){e.lineTo(t,n),this.__originalLineTo(t,n)},s.bezierCurveTo=function(t,n,i,r,o,a){e.bezierCurveTo(t,n,i,r,o,a),this.__originalBezierCurveTo(t,n,i,r,o,a)},s.rect=function(t,n,i,r){e.rect(t,n,i,r),this.__originalRect(t,n,i,r)},s.closePath=function(){e.closePath(),this.__originalClosePath()},s.beginPath=function(){e.beginPath(),this.__originalBeginPath()}}var qP=class{constructor(e){this.canvasFactory=e,this.cache=Object.create(null)}getCanvas(e,t,n){let i;return this.cache[e]!==void 0?(i=this.cache[e],this.canvasFactory.reset(i,t,n)):(i=this.canvasFactory.create(t,n),this.cache[e]=i),i}delete(e){delete this.cache[e]}clear(){for(let e in this.cache){let t=this.cache[e];this.canvasFactory.destroy(t),delete this.cache[e]}}};function nM(s,e,t,n,i,r,o,a,l,c){let[d,u,h,p,f,_]=Zn(s);if(u===0&&h===0){let w=o*d+f,C=Math.round(w),M=a*p+_,S=Math.round(M),k=(o+l)*d+f,T=Math.abs(Math.round(k)-C)||1,P=(a+c)*p+_,R=Math.abs(Math.round(P)-S)||1;return s.setTransform(Math.sign(d),0,0,Math.sign(p),C,S),s.drawImage(e,t,n,i,r,0,0,T,R),s.setTransform(d,u,h,p,f,_),[T,R]}if(d===0&&p===0){let w=a*h+f,C=Math.round(w),M=o*u+_,S=Math.round(M),k=(a+c)*h+f,T=Math.abs(Math.round(k)-C)||1,P=(o+l)*u+_,R=Math.abs(Math.round(P)-S)||1;return s.setTransform(0,Math.sign(u),Math.sign(h),0,C,S),s.drawImage(e,t,n,i,r,0,0,R,T),s.setTransform(d,u,h,p,f,_),[R,T]}s.drawImage(e,t,n,i,r,o,a,l,c);let b=Math.hypot(d,u),y=Math.hypot(h,p);return[b*l,y*c]}function ete(s){let{width:e,height:t}=s;if(e>u3||t>u3)return null;let n=1e3,i=new Uint8Array([0,2,4,0,1,0,5,4,8,10,0,8,0,2,1,0]),r=e+1,o=new Uint8Array(r*(t+1)),a,l,c,d=e+7&-8,u=new Uint8Array(d*t),h=0;for(let y of s.data){let w=128;for(;w>0;)u[h++]=y&w?0:255,w>>=1}let p=0;for(h=0,u[h]!==0&&(o[0]=1,++p),l=1;l<e;l++)u[h]!==u[h+1]&&(o[l]=u[h]?2:1,++p),h++;for(u[h]!==0&&(o[l]=2,++p),a=1;a<t;a++){h=a*d,c=a*r,u[h-d]!==u[h]&&(o[c]=u[h]?1:8,++p);let y=(u[h]?4:0)+(u[h-d]?8:0);for(l=1;l<e;l++)y=(y>>2)+(u[h+1]?4:0)+(u[h-d+1]?8:0),i[y]&&(o[c+l]=i[y],++p),h++;if(u[h-d]!==u[h]&&(o[c+l]=u[h]?2:4,++p),p>n)return null}for(h=d*(t-1),c=a*r,u[h]!==0&&(o[c]=8,++p),l=1;l<e;l++)u[h]!==u[h+1]&&(o[c+l]=u[h]?4:8,++p),h++;if(u[h]!==0&&(o[c+l]=4,++p),p>n)return null;let f=new Int32Array([0,r,-1,0,-r,0,0,0,1]),_=new Path2D;for(a=0;p&&a<=t;a++){let y=a*r,w=y+e;for(;y<w&&!o[y];)y++;if(y===w)continue;_.moveTo(y%r,a);let C=y,M=o[y];do{let S=f[M];do y+=S;while(!o[y]);let k=o[y];k!==5&&k!==10?(M=k,o[y]=0):(M=k&51*M>>4,o[y]&=M>>2|M<<2),_.lineTo(y%r,y/r|0),o[y]||--p}while(C!==y);--a}return u=null,o=null,function(y){y.save(),y.scale(1/e,-1/t),y.translate(0,-t),y.fill(_),y.beginPath(),y.restore()}}var YM=class{constructor(e,t){this.alphaIsShape=!1,this.fontSize=0,this.fontSizeScale=1,this.textMatrix=y3,this.textMatrixScale=1,this.fontMatrix=oP,this.leading=0,this.x=0,this.y=0,this.lineX=0,this.lineY=0,this.charSpacing=0,this.wordSpacing=0,this.textHScale=1,this.textRenderingMode=_i.FILL,this.textRise=0,this.fillColor="#000000",this.strokeColor="#000000",this.patternFill=!1,this.patternStroke=!1,this.fillAlpha=1,this.strokeAlpha=1,this.lineWidth=1,this.activeSMask=null,this.transferMaps="none",this.startNewPathAndClipBox([0,0,e,t])}clone(){let e=Object.create(this);return e.clipBox=this.clipBox.slice(),e}setCurrentPoint(e,t){this.x=e,this.y=t}updatePathMinMax(e,t,n){[t,n]=At.applyTransform([t,n],e),this.minX=Math.min(this.minX,t),this.minY=Math.min(this.minY,n),this.maxX=Math.max(this.maxX,t),this.maxY=Math.max(this.maxY,n)}updateRectMinMax(e,t){let n=At.applyTransform(t,e),i=At.applyTransform(t.slice(2),e),r=At.applyTransform([t[0],t[3]],e),o=At.applyTransform([t[2],t[1]],e);this.minX=Math.min(this.minX,n[0],i[0],r[0],o[0]),this.minY=Math.min(this.minY,n[1],i[1],r[1],o[1]),this.maxX=Math.max(this.maxX,n[0],i[0],r[0],o[0]),this.maxY=Math.max(this.maxY,n[1],i[1],r[1],o[1])}updateScalingPathMinMax(e,t){At.scaleMinMax(e,t),this.minX=Math.min(this.minX,t[0]),this.minY=Math.min(this.minY,t[1]),this.maxX=Math.max(this.maxX,t[2]),this.maxY=Math.max(this.maxY,t[3])}updateCurvePathMinMax(e,t,n,i,r,o,a,l,c,d){let u=At.bezierBoundingBox(t,n,i,r,o,a,l,c,d);d||this.updateRectMinMax(e,u)}getPathBoundingBox(e=Ei.FILL,t=null){let n=[this.minX,this.minY,this.maxX,this.maxY];if(e===Ei.STROKE){t||zn("Stroke bounding box must include transform.");let i=At.singularValueDecompose2dScale(t),r=i[0]*this.lineWidth/2,o=i[1]*this.lineWidth/2;n[0]-=r,n[1]-=o,n[2]+=r,n[3]+=o}return n}updateClipFromPath(){let e=At.intersect(this.clipBox,this.getPathBoundingBox());this.startNewPathAndClipBox(e||[0,0,0,0])}isEmptyClip(){return this.minX===1/0}startNewPathAndClipBox(e){this.clipBox=e,this.minX=1/0,this.minY=1/0,this.maxX=0,this.maxY=0}getClippedPathBoundingBox(e=Ei.FILL,t=null){return At.intersect(this.clipBox,this.getPathBoundingBox(e,t))}};function h3(s,e){if(e instanceof ImageData){s.putImageData(e,0,0);return}let t=e.height,n=e.width,i=t%Qi,r=(t-i)/Qi,o=i===0?r:r+1,a=s.createImageData(n,Qi),l=0,c,d=e.data,u=a.data,h,p,f,_;if(e.kind===oM.GRAYSCALE_1BPP){let b=d.byteLength,y=new Uint32Array(u.buffer,0,u.byteLength>>2),w=y.length,C=n+7>>3,M=4294967295,S=ui.isLittleEndian?4278190080:255;for(h=0;h<o;h++){for(f=h<r?Qi:i,c=0,p=0;p<f;p++){let k=b-l,T=0,P=k>C?n:k*8-7,R=P&-8,O=0,H=0;for(;T<R;T+=8)H=d[l++],y[c++]=H&128?M:S,y[c++]=H&64?M:S,y[c++]=H&32?M:S,y[c++]=H&16?M:S,y[c++]=H&8?M:S,y[c++]=H&4?M:S,y[c++]=H&2?M:S,y[c++]=H&1?M:S;for(;T<P;T++)O===0&&(H=d[l++],O=128),y[c++]=H&O?M:S,O>>=1}for(;c<w;)y[c++]=0;s.putImageData(a,0,h*Qi)}}else if(e.kind===oM.RGBA_32BPP){for(p=0,_=n*Qi*4,h=0;h<r;h++)u.set(d.subarray(l,l+_)),l+=_,s.putImageData(a,0,p),p+=Qi;h<o&&(_=n*i*4,u.set(d.subarray(l,l+_)),s.putImageData(a,0,p))}else if(e.kind===oM.RGB_24BPP)for(f=Qi,_=n*f,h=0;h<o;h++){for(h>=r&&(f=i,_=n*f),c=0,p=_;p--;)u[c++]=d[l++],u[c++]=d[l++],u[c++]=d[l++],u[c++]=255;s.putImageData(a,0,h*Qi)}else throw new Error(`bad image kind: ${e.kind}`)}function p3(s,e){if(e.bitmap){s.drawImage(e.bitmap,0,0);return}let t=e.height,n=e.width,i=t%Qi,r=(t-i)/Qi,o=i===0?r:r+1,a=s.createImageData(n,Qi),l=0,c=e.data,d=a.data;for(let u=0;u<o;u++){let h=u<r?Qi:i;({srcPos:l}=Qee({src:c,srcPos:l,dest:d,width:n,height:h,nonBlackColor:0})),s.putImageData(a,0,u*Qi)}}function Km(s,e){let t=["strokeStyle","fillStyle","fillRule","globalAlpha","lineWidth","lineCap","lineJoin","miterLimit","globalCompositeOperation","font","filter"];for(let n of t)s[n]!==void 0&&(e[n]=s[n]);s.setLineDash!==void 0&&(e.setLineDash(s.getLineDash()),e.lineDashOffset=s.lineDashOffset)}function sM(s){if(s.strokeStyle=s.fillStyle="#000000",s.fillRule="nonzero",s.globalAlpha=1,s.lineWidth=1,s.lineCap="butt",s.lineJoin="miter",s.miterLimit=10,s.globalCompositeOperation="source-over",s.font="10px sans-serif",s.setLineDash!==void 0&&(s.setLineDash([]),s.lineDashOffset=0),!xi){let{filter:e}=s;e!=="none"&&e!==""&&(s.filter="none")}}function f3(s,e){if(e)return!0;let t=At.singularValueDecompose2dScale(s);t[0]=Math.fround(t[0]),t[1]=Math.fround(t[1]);let n=Math.fround((globalThis.devicePixelRatio||1)*Ac.PDF_TO_CSS_UNITS);return t[0]<=n&&t[1]<=n}var tte=["butt","round","square"],nte=["miter","round","bevel"],ste={},m3={},b_,KP,w_,YP,M_,XP,CI=class CI{constructor(e,t,n,i,r,{optionalContentConfig:o,markedContentStack:a=null},l,c){L(this,b_);L(this,w_);L(this,M_);this.ctx=e,this.current=new YM(this.ctx.canvas.width,this.ctx.canvas.height),this.stateStack=[],this.pendingClip=null,this.pendingEOFill=!1,this.res=null,this.xobjs=null,this.commonObjs=t,this.objs=n,this.canvasFactory=i,this.filterFactory=r,this.groupStack=[],this.processingType3=null,this.baseTransform=null,this.baseTransformStack=[],this.groupLevel=0,this.smaskStack=[],this.smaskCounter=0,this.tempSMask=null,this.suspendedCtx=null,this.contentVisible=!0,this.markedContentStack=a||[],this.optionalContentConfig=o,this.cachedCanvases=new qP(this.canvasFactory),this.cachedPatterns=new Map,this.annotationCanvasMap=l,this.viewportScale=1,this.outputScaleX=1,this.outputScaleY=1,this.pageColors=c,this._cachedScaleForStroking=[-1,0],this._cachedGetSinglePixelWidth=null,this._cachedBitmapsMap=new Map}getObject(e,t=null){return typeof e=="string"?e.startsWith("g_")?this.commonObjs.get(e):this.objs.get(e):t}beginDrawing({transform:e,viewport:t,transparency:n=!1,background:i=null}){let r=this.ctx.canvas.width,o=this.ctx.canvas.height,a=this.ctx.fillStyle;if(this.ctx.fillStyle=i||"#ffffff",this.ctx.fillRect(0,0,r,o),this.ctx.fillStyle=a,n){let l=this.cachedCanvases.getCanvas("transparent",r,o);this.compositeCtx=this.ctx,this.transparentCanvas=l.canvas,this.ctx=l.context,this.ctx.save(),this.ctx.transform(...Zn(this.compositeCtx))}this.ctx.save(),sM(this.ctx),e&&(this.ctx.transform(...e),this.outputScaleX=e[0],this.outputScaleY=e[0]),this.ctx.transform(...t.transform),this.viewportScale=t.scale,this.baseTransform=Zn(this.ctx)}executeOperatorList(e,t,n,i){let r=e.argsArray,o=e.fnArray,a=t||0,l=r.length;if(l===a)return a;let c=l-a>d3&&typeof n=="function",d=c?Date.now()+Jee:0,u=0,h=this.commonObjs,p=this.objs,f;for(;;){if(i!==void 0&&a===i.nextBreakPoint)return i.breakIt(a,n),a;if(f=o[a],f!==co.dependency)this[f].apply(this,r[a]);else for(let _ of r[a]){let b=_.startsWith("g_")?h:p;if(!b.has(_))return b.get(_,n),a}if(a++,a===l)return a;if(c&&++u>d3){if(Date.now()>d)return n(),a;u=0}}}endDrawing(){K(this,b_,KP).call(this),this.cachedCanvases.clear(),this.cachedPatterns.clear();for(let e of this._cachedBitmapsMap.values()){for(let t of e.values())typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement&&(t.width=t.height=0);e.clear()}this._cachedBitmapsMap.clear(),K(this,w_,YP).call(this)}_scaleImage(e,t){let n=e.width??e.displayWidth,i=e.height??e.displayHeight,r=Math.max(Math.hypot(t[0],t[1]),1),o=Math.max(Math.hypot(t[2],t[3]),1),a=n,l=i,c="prescale1",d,u;for(;r>2&&a>1||o>2&&l>1;){let h=a,p=l;r>2&&a>1&&(h=a>=16384?Math.floor(a/2)-1||1:Math.ceil(a/2),r/=a/h),o>2&&l>1&&(p=l>=16384?Math.floor(l/2)-1||1:Math.ceil(l)/2,o/=l/p),d=this.cachedCanvases.getCanvas(c,h,p),u=d.context,u.clearRect(0,0,h,p),u.drawImage(e,0,0,a,l,0,0,h,p),e=d.canvas,a=h,l=p,c=c==="prescale1"?"prescale2":"prescale1"}return{img:e,paintWidth:a,paintHeight:l}}_createMaskCanvas(e){let t=this.ctx,{width:n,height:i}=e,r=this.current.fillColor,o=this.current.patternFill,a=Zn(t),l,c,d,u;if((e.bitmap||e.data)&&e.count>1){let P=e.bitmap||e.data.buffer;c=JSON.stringify(o?a:[a.slice(0,4),r]),l=this._cachedBitmapsMap.get(P),l||(l=new Map,this._cachedBitmapsMap.set(P,l));let R=l.get(c);if(R&&!o){let O=Math.round(Math.min(a[0],a[2])+a[4]),H=Math.round(Math.min(a[1],a[3])+a[5]);return{canvas:R,offsetX:O,offsetY:H}}d=R}d||(u=this.cachedCanvases.getCanvas("maskCanvas",n,i),p3(u.context,e));let h=At.transform(a,[1/n,0,0,-1/i,0,0]);h=At.transform(h,[1,0,0,1,0,-i]);let[p,f,_,b]=At.getAxialAlignedBoundingBox([0,0,n,i],h),y=Math.round(_-p)||1,w=Math.round(b-f)||1,C=this.cachedCanvases.getCanvas("fillCanvas",y,w),M=C.context,S=p,k=f;M.translate(-S,-k),M.transform(...h),d||(d=this._scaleImage(u.canvas,Qo(M)),d=d.img,l&&o&&l.set(c,d)),M.imageSmoothingEnabled=f3(Zn(M),e.interpolate),nM(M,d,0,0,d.width,d.height,0,0,n,i),M.globalCompositeOperation="source-in";let T=At.transform(Qo(M),[1,0,0,1,-S,-k]);return M.fillStyle=o?r.getPattern(t,this,T,Ei.FILL):r,M.fillRect(0,0,n,i),l&&!o&&(this.cachedCanvases.delete("fillCanvas"),l.set(c,C.canvas)),{canvas:C.canvas,offsetX:Math.round(S),offsetY:Math.round(k)}}setLineWidth(e){e!==this.current.lineWidth&&(this._cachedScaleForStroking[0]=-1),this.current.lineWidth=e,this.ctx.lineWidth=e}setLineCap(e){this.ctx.lineCap=tte[e]}setLineJoin(e){this.ctx.lineJoin=nte[e]}setMiterLimit(e){this.ctx.miterLimit=e}setDash(e,t){let n=this.ctx;n.setLineDash!==void 0&&(n.setLineDash(e),n.lineDashOffset=t)}setRenderingIntent(e){}setFlatness(e){}setGState(e){for(let[t,n]of e)switch(t){case"LW":this.setLineWidth(n);break;case"LC":this.setLineCap(n);break;case"LJ":this.setLineJoin(n);break;case"ML":this.setMiterLimit(n);break;case"D":this.setDash(n[0],n[1]);break;case"RI":this.setRenderingIntent(n);break;case"FL":this.setFlatness(n);break;case"Font":this.setFont(n[0],n[1]);break;case"CA":this.current.strokeAlpha=n;break;case"ca":this.current.fillAlpha=n,this.ctx.globalAlpha=n;break;case"BM":this.ctx.globalCompositeOperation=n;break;case"SMask":this.current.activeSMask=n?this.tempSMask:null,this.tempSMask=null,this.checkSMaskState();break;case"TR":this.ctx.filter=this.current.transferMaps=this.filterFactory.addFilter(n);break}}get inSMaskMode(){return!!this.suspendedCtx}checkSMaskState(){let e=this.inSMaskMode;this.current.activeSMask&&!e?this.beginSMaskMode():!this.current.activeSMask&&e&&this.endSMaskMode()}beginSMaskMode(){if(this.inSMaskMode)throw new Error("beginSMaskMode called while already in smask mode");let e=this.ctx.canvas.width,t=this.ctx.canvas.height,n="smaskGroupAt"+this.groupLevel,i=this.cachedCanvases.getCanvas(n,e,t);this.suspendedCtx=this.ctx,this.ctx=i.context;let r=this.ctx;r.setTransform(...Zn(this.suspendedCtx)),Km(this.suspendedCtx,r),Zee(r,this.suspendedCtx),this.setGState([["BM","source-over"],["ca",1],["CA",1]])}endSMaskMode(){if(!this.inSMaskMode)throw new Error("endSMaskMode called while not in smask mode");this.ctx._removeMirroring(),Km(this.ctx,this.suspendedCtx),this.ctx=this.suspendedCtx,this.suspendedCtx=null}compose(e){if(!this.current.activeSMask)return;e?(e[0]=Math.floor(e[0]),e[1]=Math.floor(e[1]),e[2]=Math.ceil(e[2]),e[3]=Math.ceil(e[3])):e=[0,0,this.ctx.canvas.width,this.ctx.canvas.height];let t=this.current.activeSMask,n=this.suspendedCtx;this.composeSMask(n,t,this.ctx,e),this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.restore()}composeSMask(e,t,n,i){let r=i[0],o=i[1],a=i[2]-r,l=i[3]-o;a===0||l===0||(this.genericComposeSMask(t.context,n,a,l,t.subtype,t.backdrop,t.transferMap,r,o,t.offsetX,t.offsetY),e.save(),e.globalAlpha=1,e.globalCompositeOperation="source-over",e.setTransform(1,0,0,1,0,0),e.drawImage(n.canvas,0,0),e.restore())}genericComposeSMask(e,t,n,i,r,o,a,l,c,d,u){let h=e.canvas,p=l-d,f=c-u;if(o){let b=At.makeHexColor(...o);if(p<0||f<0||p+n>h.width||f+i>h.height){let y=this.cachedCanvases.getCanvas("maskExtension",n,i),w=y.context;w.drawImage(h,-p,-f),w.globalCompositeOperation="destination-atop",w.fillStyle=b,w.fillRect(0,0,n,i),w.globalCompositeOperation="source-over",h=y.canvas,p=f=0}else{e.save(),e.globalAlpha=1,e.setTransform(1,0,0,1,0,0);let y=new Path2D;y.rect(p,f,n,i),e.clip(y),e.globalCompositeOperation="destination-atop",e.fillStyle=b,e.fillRect(p,f,n,i),e.restore()}}t.save(),t.globalAlpha=1,t.setTransform(1,0,0,1,0,0),r==="Alpha"&&a?t.filter=this.filterFactory.addAlphaFilter(a):r==="Luminosity"&&(t.filter=this.filterFactory.addLuminosityFilter(a));let _=new Path2D;_.rect(l,c,n,i),t.clip(_),t.globalCompositeOperation="destination-in",t.drawImage(h,p,f,n,i,l,c,n,i),t.restore()}save(){this.inSMaskMode?(Km(this.ctx,this.suspendedCtx),this.suspendedCtx.save()):this.ctx.save();let e=this.current;this.stateStack.push(e),this.current=e.clone()}restore(){this.stateStack.length===0&&this.inSMaskMode&&this.endSMaskMode(),this.stateStack.length!==0&&(this.current=this.stateStack.pop(),this.inSMaskMode?(this.suspendedCtx.restore(),Km(this.suspendedCtx,this.ctx)):this.ctx.restore(),this.checkSMaskState(),this.pendingClip=null,this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null)}transform(e,t,n,i,r,o){this.ctx.transform(e,t,n,i,r,o),this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null}constructPath(e,t,n){let i=this.ctx,r=this.current,o=r.x,a=r.y,l,c,d=Zn(i),u=d[0]===0&&d[3]===0||d[1]===0&&d[2]===0,h=u?n.slice(0):null;for(let p=0,f=0,_=e.length;p<_;p++)switch(e[p]|0){case co.rectangle:o=t[f++],a=t[f++];let b=t[f++],y=t[f++],w=o+b,C=a+y;i.moveTo(o,a),b===0||y===0?i.lineTo(w,C):(i.lineTo(w,a),i.lineTo(w,C),i.lineTo(o,C)),u||r.updateRectMinMax(d,[o,a,w,C]),i.closePath();break;case co.moveTo:o=t[f++],a=t[f++],i.moveTo(o,a),u||r.updatePathMinMax(d,o,a);break;case co.lineTo:o=t[f++],a=t[f++],i.lineTo(o,a),u||r.updatePathMinMax(d,o,a);break;case co.curveTo:l=o,c=a,o=t[f+4],a=t[f+5],i.bezierCurveTo(t[f],t[f+1],t[f+2],t[f+3],o,a),r.updateCurvePathMinMax(d,l,c,t[f],t[f+1],t[f+2],t[f+3],o,a,h),f+=6;break;case co.curveTo2:l=o,c=a,i.bezierCurveTo(o,a,t[f],t[f+1],t[f+2],t[f+3]),r.updateCurvePathMinMax(d,l,c,o,a,t[f],t[f+1],t[f+2],t[f+3],h),o=t[f+2],a=t[f+3],f+=4;break;case co.curveTo3:l=o,c=a,o=t[f+2],a=t[f+3],i.bezierCurveTo(t[f],t[f+1],o,a,o,a),r.updateCurvePathMinMax(d,l,c,t[f],t[f+1],o,a,o,a,h),f+=4;break;case co.closePath:i.closePath();break}u&&r.updateScalingPathMinMax(d,h),r.setCurrentPoint(o,a)}closePath(){this.ctx.closePath()}stroke(e=!0){let t=this.ctx,n=this.current.strokeColor;t.globalAlpha=this.current.strokeAlpha,this.contentVisible&&(typeof n=="object"&&n?.getPattern?(t.save(),t.strokeStyle=n.getPattern(t,this,Qo(t),Ei.STROKE),this.rescaleAndStroke(!1),t.restore()):this.rescaleAndStroke(!0)),e&&this.consumePath(this.current.getClippedPathBoundingBox()),t.globalAlpha=this.current.fillAlpha}closeStroke(){this.closePath(),this.stroke()}fill(e=!0){let t=this.ctx,n=this.current.fillColor,i=this.current.patternFill,r=!1;i&&(t.save(),t.fillStyle=n.getPattern(t,this,Qo(t),Ei.FILL),r=!0);let o=this.current.getClippedPathBoundingBox();this.contentVisible&&o!==null&&(this.pendingEOFill?(t.fill("evenodd"),this.pendingEOFill=!1):t.fill()),r&&t.restore(),e&&this.consumePath(o)}eoFill(){this.pendingEOFill=!0,this.fill()}fillStroke(){this.fill(!1),this.stroke(!1),this.consumePath()}eoFillStroke(){this.pendingEOFill=!0,this.fillStroke()}closeFillStroke(){this.closePath(),this.fillStroke()}closeEOFillStroke(){this.pendingEOFill=!0,this.closePath(),this.fillStroke()}endPath(){this.consumePath()}clip(){this.pendingClip=ste}eoClip(){this.pendingClip=m3}beginText(){this.current.textMatrix=y3,this.current.textMatrixScale=1,this.current.x=this.current.lineX=0,this.current.y=this.current.lineY=0}endText(){let e=this.pendingTextPaths,t=this.ctx;if(e===void 0){t.beginPath();return}let n=new Path2D,i=t.getTransform().invertSelf();for(let{transform:r,x:o,y:a,fontSize:l,path:c}of e)n.addPath(c,new DOMMatrix(r).preMultiplySelf(i).translate(o,a).scale(l,-l));t.clip(n),t.beginPath(),delete this.pendingTextPaths}setCharSpacing(e){this.current.charSpacing=e}setWordSpacing(e){this.current.wordSpacing=e}setHScale(e){this.current.textHScale=e/100}setLeading(e){this.current.leading=-e}setFont(e,t){let n=this.commonObjs.get(e),i=this.current;if(!n)throw new Error(`Can't find font for ${e}`);if(i.fontMatrix=n.fontMatrix||oP,(i.fontMatrix[0]===0||i.fontMatrix[3]===0)&&Jt("Invalid font matrix for font "+e),t<0?(t=-t,i.fontDirection=-1):i.fontDirection=1,this.current.font=n,this.current.fontSize=t,n.isType3Font)return;let r=n.loadedName||"sans-serif",o=n.systemFontInfo?.css||`"${r}", ${n.fallbackName}`,a="normal";n.black?a="900":n.bold&&(a="bold");let l=n.italic?"italic":"normal",c=t;t<l3?c=l3:t>c3&&(c=c3),this.current.fontSizeScale=t/c,this.ctx.font=`${l} ${a} ${c}px ${o}`}setTextRenderingMode(e){this.current.textRenderingMode=e}setTextRise(e){this.current.textRise=e}moveText(e,t){this.current.x=this.current.lineX+=e,this.current.y=this.current.lineY+=t}setLeadingMoveText(e,t){this.setLeading(-t),this.moveText(e,t)}setTextMatrix(e,t,n,i,r,o){this.current.textMatrix=[e,t,n,i,r,o],this.current.textMatrixScale=Math.hypot(e,t),this.current.x=this.current.lineX=0,this.current.y=this.current.lineY=0}nextLine(){this.moveText(0,this.current.leading)}paintChar(e,t,n,i,r){let o=this.ctx,a=this.current,l=a.font,c=a.textRenderingMode,d=a.fontSize/a.fontSizeScale,u=c&_i.FILL_STROKE_MASK,h=!!(c&_i.ADD_TO_PATH_FLAG),p=a.patternFill&&!l.missingFile,f=a.patternStroke&&!l.missingFile,_;if((l.disableFontFace||h||p||f)&&(_=l.getPathGenerator(this.commonObjs,e)),l.disableFontFace||p||f){if(o.save(),o.translate(t,n),o.scale(d,-d),u===_i.FILL||u===_i.FILL_STROKE)if(i){let b=o.getTransform();o.setTransform(...i),o.fill(K(this,M_,XP).call(this,_,b,i))}else o.fill(_);if(u===_i.STROKE||u===_i.FILL_STROKE)if(r){let b=o.getTransform();o.setTransform(...r),o.stroke(K(this,M_,XP).call(this,_,b,r))}else o.lineWidth/=d,o.stroke(_);o.restore()}else(u===_i.FILL||u===_i.FILL_STROKE)&&o.fillText(e,t,n),(u===_i.STROKE||u===_i.FILL_STROKE)&&o.strokeText(e,t,n);h&&(this.pendingTextPaths||(this.pendingTextPaths=[])).push({transform:Zn(o),x:t,y:n,fontSize:d,path:_})}get isFontSubpixelAAEnabled(){let{context:e}=this.cachedCanvases.getCanvas("isFontSubpixelAAEnabled",10,10);e.scale(1.5,1),e.fillText("I",0,10);let t=e.getImageData(0,0,10,10).data,n=!1;for(let i=3;i<t.length;i+=4)if(t[i]>0&&t[i]<255){n=!0;break}return an(this,"isFontSubpixelAAEnabled",n)}showText(e){let t=this.current,n=t.font;if(n.isType3Font)return this.showType3Text(e);let i=t.fontSize;if(i===0)return;let r=this.ctx,o=t.fontSizeScale,a=t.charSpacing,l=t.wordSpacing,c=t.fontDirection,d=t.textHScale*c,u=e.length,h=n.vertical,p=h?1:-1,f=n.defaultVMetrics,_=i*t.fontMatrix[0],b=t.textRenderingMode===_i.FILL&&!n.disableFontFace&&!t.patternFill;r.save(),r.transform(...t.textMatrix),r.translate(t.x,t.y+t.textRise),c>0?r.scale(d,-1):r.scale(d,1);let y,w;if(t.patternFill){r.save();let T=t.fillColor.getPattern(r,this,Qo(r),Ei.FILL);y=Zn(r),r.restore(),r.fillStyle=T}if(t.patternStroke){r.save();let T=t.strokeColor.getPattern(r,this,Qo(r),Ei.STROKE);w=Zn(r),r.restore(),r.strokeStyle=T}let C=t.lineWidth,M=t.textMatrixScale;if(M===0||C===0){let T=t.textRenderingMode&_i.FILL_STROKE_MASK;(T===_i.STROKE||T===_i.FILL_STROKE)&&(C=this.getSinglePixelWidth())}else C/=M;if(o!==1&&(r.scale(o,o),C/=o),r.lineWidth=C,n.isInvalidPDFjsFont){let T=[],P=0;for(let R of e)T.push(R.unicode),P+=R.width;r.fillText(T.join(""),0,0),t.x+=P*_*d,r.restore(),this.compose();return}let S=0,k;for(k=0;k<u;++k){let T=e[k];if(typeof T=="number"){S+=p*T*i/1e3;continue}let P=!1,R=(T.isSpace?l:0)+a,O=T.fontChar,H=T.accent,X,z,ne=T.width;if(h){let Y=T.vmetric||f,se=-(T.vmetric?Y[1]:ne*.5)*_,ue=Y[2]*_;ne=Y?-Y[0]:ne,X=se/o,z=(S+ue)/o}else X=S/o,z=0;if(n.remeasure&&ne>0){let Y=r.measureText(O).width*1e3/i*o;if(ne<Y&&this.isFontSubpixelAAEnabled){let se=ne/Y;P=!0,r.save(),r.scale(se,1),X/=se}else ne!==Y&&(X+=(ne-Y)/2e3*i/o)}if(this.contentVisible&&(T.isInFont||n.missingFile)){if(b&&!H)r.fillText(O,X,z);else if(this.paintChar(O,X,z,y,w),H){let Y=X+i*H.offset.x/o,se=z-i*H.offset.y/o;this.paintChar(H.fontChar,Y,se,y,w)}}let re=h?ne*_-R*c:ne*_+R*c;S+=re,P&&r.restore()}h?t.y-=S:t.x+=S*d,r.restore(),this.compose()}showType3Text(e){let t=this.ctx,n=this.current,i=n.font,r=n.fontSize,o=n.fontDirection,a=i.vertical?1:-1,l=n.charSpacing,c=n.wordSpacing,d=n.textHScale*o,u=n.fontMatrix||oP,h=e.length,p=n.textRenderingMode===_i.INVISIBLE,f,_,b,y;if(!(p||r===0)){for(this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null,t.save(),t.transform(...n.textMatrix),t.translate(n.x,n.y),t.scale(d,o),f=0;f<h;++f){if(_=e[f],typeof _=="number"){y=a*_*r/1e3,this.ctx.translate(y,0),n.x+=y*d;continue}let w=(_.isSpace?c:0)+l,C=i.charProcOperatorList[_.operatorListId];if(!C){Jt(`Type3 character "${_.operatorListId}" is not available.`);continue}this.contentVisible&&(this.processingType3=_,this.save(),t.scale(r,r),t.transform(...u),this.executeOperatorList(C),this.restore()),b=At.applyTransform([_.width,0],u)[0]*r+w,t.translate(b,0),n.x+=b*d}t.restore(),this.processingType3=null}}setCharWidth(e,t){}setCharWidthAndBounds(e,t,n,i,r,o){this.ctx.rect(n,i,r-n,o-i),this.ctx.clip(),this.endPath()}getColorN_Pattern(e){let t;if(e[0]==="TilingPattern"){let n=e[1],i=this.baseTransform||Zn(this.ctx),r={createCanvasGraphics:o=>new CI(o,this.commonObjs,this.objs,this.canvasFactory,this.filterFactory,{optionalContentConfig:this.optionalContentConfig,markedContentStack:this.markedContentStack})};t=new jP(e,n,this.ctx,r,i)}else t=this._getPattern(e[1],e[2]);return t}setStrokeColorN(){this.current.strokeColor=this.getColorN_Pattern(arguments),this.current.patternStroke=!0}setFillColorN(){this.current.fillColor=this.getColorN_Pattern(arguments),this.current.patternFill=!0}setStrokeRGBColor(e,t,n){this.ctx.strokeStyle=this.current.strokeColor=At.makeHexColor(e,t,n),this.current.patternStroke=!1}setStrokeTransparent(){this.ctx.strokeStyle=this.current.strokeColor="transparent",this.current.patternStroke=!1}setFillRGBColor(e,t,n){this.ctx.fillStyle=this.current.fillColor=At.makeHexColor(e,t,n),this.current.patternFill=!1}setFillTransparent(){this.ctx.fillStyle=this.current.fillColor="transparent",this.current.patternFill=!1}_getPattern(e,t=null){let n;return this.cachedPatterns.has(e)?n=this.cachedPatterns.get(e):(n=Xee(this.getObject(e)),this.cachedPatterns.set(e,n)),t&&(n.matrix=t),n}shadingFill(e){if(!this.contentVisible)return;let t=this.ctx;this.save();let n=this._getPattern(e);t.fillStyle=n.getPattern(t,this,Qo(t),Ei.SHADING);let i=Qo(t);if(i){let{width:r,height:o}=t.canvas,[a,l,c,d]=At.getAxialAlignedBoundingBox([0,0,r,o],i);this.ctx.fillRect(a,l,c-a,d-l)}else this.ctx.fillRect(-1e10,-1e10,2e10,2e10);this.compose(this.current.getClippedPathBoundingBox()),this.restore()}beginInlineImage(){zn("Should not call beginInlineImage")}beginImageData(){zn("Should not call beginImageData")}paintFormXObjectBegin(e,t){if(this.contentVisible&&(this.save(),this.baseTransformStack.push(this.baseTransform),e&&this.transform(...e),this.baseTransform=Zn(this.ctx),t)){let n=t[2]-t[0],i=t[3]-t[1];this.ctx.rect(t[0],t[1],n,i),this.current.updateRectMinMax(Zn(this.ctx),t),this.clip(),this.endPath()}}paintFormXObjectEnd(){this.contentVisible&&(this.restore(),this.baseTransform=this.baseTransformStack.pop())}beginGroup(e){if(!this.contentVisible)return;this.save(),this.inSMaskMode&&(this.endSMaskMode(),this.current.activeSMask=null);let t=this.ctx;e.isolated||JE("TODO: Support non-isolated groups."),e.knockout&&Jt("Knockout groups not supported.");let n=Zn(t);if(e.matrix&&t.transform(...e.matrix),!e.bbox)throw new Error("Bounding box is required.");let i=At.getAxialAlignedBoundingBox(e.bbox,Zn(t)),r=[0,0,t.canvas.width,t.canvas.height];i=At.intersect(i,r)||[0,0,0,0];let o=Math.floor(i[0]),a=Math.floor(i[1]),l=Math.max(Math.ceil(i[2])-o,1),c=Math.max(Math.ceil(i[3])-a,1);this.current.startNewPathAndClipBox([0,0,l,c]);let d="groupAt"+this.groupLevel;e.smask&&(d+="_smask_"+this.smaskCounter++%2);let u=this.cachedCanvases.getCanvas(d,l,c),h=u.context;h.translate(-o,-a),h.transform(...n),e.smask?this.smaskStack.push({canvas:u.canvas,context:h,offsetX:o,offsetY:a,subtype:e.smask.subtype,backdrop:e.smask.backdrop,transferMap:e.smask.transferMap||null,startTransformInverse:null}):(t.setTransform(1,0,0,1,0,0),t.translate(o,a),t.save()),Km(t,h),this.ctx=h,this.setGState([["BM","source-over"],["ca",1],["CA",1]]),this.groupStack.push(t),this.groupLevel++}endGroup(e){if(!this.contentVisible)return;this.groupLevel--;let t=this.ctx,n=this.groupStack.pop();if(this.ctx=n,this.ctx.imageSmoothingEnabled=!1,e.smask)this.tempSMask=this.smaskStack.pop(),this.restore();else{this.ctx.restore();let i=Zn(this.ctx);this.restore(),this.ctx.save(),this.ctx.setTransform(...i);let r=At.getAxialAlignedBoundingBox([0,0,t.canvas.width,t.canvas.height],i);this.ctx.drawImage(t.canvas,0,0),this.ctx.restore(),this.compose(r)}}beginAnnotation(e,t,n,i,r){if(K(this,b_,KP).call(this),sM(this.ctx),this.ctx.save(),this.save(),this.baseTransform&&this.ctx.setTransform(...this.baseTransform),t){let o=t[2]-t[0],a=t[3]-t[1];if(r&&this.annotationCanvasMap){n=n.slice(),n[4]-=t[0],n[5]-=t[1],t=t.slice(),t[0]=t[1]=0,t[2]=o,t[3]=a;let[l,c]=At.singularValueDecompose2dScale(Zn(this.ctx)),{viewportScale:d}=this,u=Math.ceil(o*this.outputScaleX*d),h=Math.ceil(a*this.outputScaleY*d);this.annotationCanvas=this.canvasFactory.create(u,h);let{canvas:p,context:f}=this.annotationCanvas;this.annotationCanvasMap.set(e,p),this.annotationCanvas.savedCtx=this.ctx,this.ctx=f,this.ctx.save(),this.ctx.setTransform(l,0,0,-c,0,a*c),sM(this.ctx)}else sM(this.ctx),this.endPath(),this.ctx.rect(t[0],t[1],o,a),this.ctx.clip(),this.ctx.beginPath()}this.current=new YM(this.ctx.canvas.width,this.ctx.canvas.height),this.transform(...n),this.transform(...i)}endAnnotation(){this.annotationCanvas&&(this.ctx.restore(),K(this,w_,YP).call(this),this.ctx=this.annotationCanvas.savedCtx,delete this.annotationCanvas.savedCtx,delete this.annotationCanvas)}paintImageMaskXObject(e){if(!this.contentVisible)return;let t=e.count;e=this.getObject(e.data,e),e.count=t;let n=this.ctx,i=this.processingType3;if(i&&(i.compiled===void 0&&(i.compiled=ete(e)),i.compiled)){i.compiled(n);return}let r=this._createMaskCanvas(e),o=r.canvas;n.save(),n.setTransform(1,0,0,1,0,0),n.drawImage(o,r.offsetX,r.offsetY),n.restore(),this.compose()}paintImageMaskXObjectRepeat(e,t,n=0,i=0,r,o){if(!this.contentVisible)return;e=this.getObject(e.data,e);let a=this.ctx;a.save();let l=Zn(a);a.transform(t,n,i,r,0,0);let c=this._createMaskCanvas(e);a.setTransform(1,0,0,1,c.offsetX-l[4],c.offsetY-l[5]);for(let d=0,u=o.length;d<u;d+=2){let h=At.transform(l,[t,n,i,r,o[d],o[d+1]]),[p,f]=At.applyTransform([0,0],h);a.drawImage(c.canvas,p,f)}a.restore(),this.compose()}paintImageMaskXObjectGroup(e){if(!this.contentVisible)return;let t=this.ctx,n=this.current.fillColor,i=this.current.patternFill;for(let r of e){let{data:o,width:a,height:l,transform:c}=r,d=this.cachedCanvases.getCanvas("maskCanvas",a,l),u=d.context;u.save();let h=this.getObject(o,r);p3(u,h),u.globalCompositeOperation="source-in",u.fillStyle=i?n.getPattern(u,this,Qo(t),Ei.FILL):n,u.fillRect(0,0,a,l),u.restore(),t.save(),t.transform(...c),t.scale(1,-1),nM(t,d.canvas,0,0,a,l,0,-1,1,1),t.restore()}this.compose()}paintImageXObject(e){if(!this.contentVisible)return;let t=this.getObject(e);if(!t){Jt("Dependent image isn't ready yet");return}this.paintInlineImageXObject(t)}paintImageXObjectRepeat(e,t,n,i){if(!this.contentVisible)return;let r=this.getObject(e);if(!r){Jt("Dependent image isn't ready yet");return}let o=r.width,a=r.height,l=[];for(let c=0,d=i.length;c<d;c+=2)l.push({transform:[t,0,0,n,i[c],i[c+1]],x:0,y:0,w:o,h:a});this.paintInlineImageXObjectGroup(r,l)}applyTransferMapsToCanvas(e){return this.current.transferMaps!=="none"&&(e.filter=this.current.transferMaps,e.drawImage(e.canvas,0,0),e.filter="none"),e.canvas}applyTransferMapsToBitmap(e){if(this.current.transferMaps==="none")return e.bitmap;let{bitmap:t,width:n,height:i}=e,r=this.cachedCanvases.getCanvas("inlineImage",n,i),o=r.context;return o.filter=this.current.transferMaps,o.drawImage(t,0,0),o.filter="none",r.canvas}paintInlineImageXObject(e){if(!this.contentVisible)return;let t=e.width,n=e.height,i=this.ctx;if(this.save(),!xi){let{filter:a}=i;a!=="none"&&a!==""&&(i.filter="none")}i.scale(1/t,-1/n);let r;if(e.bitmap)r=this.applyTransferMapsToBitmap(e);else if(typeof HTMLElement=="function"&&e instanceof HTMLElement||!e.data)r=e;else{let l=this.cachedCanvases.getCanvas("inlineImage",t,n).context;h3(l,e),r=this.applyTransferMapsToCanvas(l)}let o=this._scaleImage(r,Qo(i));i.imageSmoothingEnabled=f3(Zn(i),e.interpolate),nM(i,o.img,0,0,o.paintWidth,o.paintHeight,0,-n,t,n),this.compose(),this.restore()}paintInlineImageXObjectGroup(e,t){if(!this.contentVisible)return;let n=this.ctx,i;if(e.bitmap)i=e.bitmap;else{let r=e.width,o=e.height,l=this.cachedCanvases.getCanvas("inlineImage",r,o).context;h3(l,e),i=this.applyTransferMapsToCanvas(l)}for(let r of t)n.save(),n.transform(...r.transform),n.scale(1,-1),nM(n,i,r.x,r.y,r.w,r.h,0,-1,1,1),n.restore();this.compose()}paintSolidColorImageMask(){this.contentVisible&&(this.ctx.fillRect(0,0,1,1),this.compose())}markPoint(e){}markPointProps(e,t){}beginMarkedContent(e){this.markedContentStack.push({visible:!0})}beginMarkedContentProps(e,t){e==="OC"?this.markedContentStack.push({visible:this.optionalContentConfig.isVisible(t)}):this.markedContentStack.push({visible:!0}),this.contentVisible=this.isContentVisible()}endMarkedContent(){this.markedContentStack.pop(),this.contentVisible=this.isContentVisible()}beginCompat(){}endCompat(){}consumePath(e){let t=this.current.isEmptyClip();this.pendingClip&&this.current.updateClipFromPath(),this.pendingClip||this.compose(e);let n=this.ctx;this.pendingClip&&(t||(this.pendingClip===m3?n.clip("evenodd"):n.clip()),this.pendingClip=null),this.current.startNewPathAndClipBox(this.current.clipBox),n.beginPath()}getSinglePixelWidth(){if(!this._cachedGetSinglePixelWidth){let e=Zn(this.ctx);if(e[1]===0&&e[2]===0)this._cachedGetSinglePixelWidth=1/Math.min(Math.abs(e[0]),Math.abs(e[3]));else{let t=Math.abs(e[0]*e[3]-e[2]*e[1]),n=Math.hypot(e[0],e[2]),i=Math.hypot(e[1],e[3]);this._cachedGetSinglePixelWidth=Math.max(n,i)/t}}return this._cachedGetSinglePixelWidth}getScaleForStroking(){if(this._cachedScaleForStroking[0]===-1){let{lineWidth:e}=this.current,{a:t,b:n,c:i,d:r}=this.ctx.getTransform(),o,a;if(n===0&&i===0){let l=Math.abs(t),c=Math.abs(r);if(l===c)if(e===0)o=a=1/l;else{let d=l*e;o=a=d<1?1/d:1}else if(e===0)o=1/l,a=1/c;else{let d=l*e,u=c*e;o=d<1?1/d:1,a=u<1?1/u:1}}else{let l=Math.abs(t*r-n*i),c=Math.hypot(t,n),d=Math.hypot(i,r);if(e===0)o=d/l,a=c/l;else{let u=e*l;o=d>u?d/u:1,a=c>u?c/u:1}}this._cachedScaleForStroking[0]=o,this._cachedScaleForStroking[1]=a}return this._cachedScaleForStroking}rescaleAndStroke(e){let{ctx:t}=this,{lineWidth:n}=this.current,[i,r]=this.getScaleForStroking();if(t.lineWidth=n||1,i===1&&r===1){t.stroke();return}let o=t.getLineDash();if(e&&t.save(),t.scale(i,r),o.length>0){let a=Math.max(i,r);t.setLineDash(o.map(l=>l/a)),t.lineDashOffset/=a}t.stroke(),e&&t.restore()}isContentVisible(){for(let e=this.markedContentStack.length-1;e>=0;e--)if(!this.markedContentStack[e].visible)return!1;return!0}};b_=new WeakSet,KP=function(){for(;this.stateStack.length||this.inSMaskMode;)this.restore();this.current.activeSMask=null,this.ctx.restore(),this.transparentCanvas&&(this.ctx=this.compositeCtx,this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.drawImage(this.transparentCanvas,0,0),this.ctx.restore(),this.transparentCanvas=null)},w_=new WeakSet,YP=function(){if(this.pageColors){let e=this.filterFactory.addHCMFilter(this.pageColors.foreground,this.pageColors.background);if(e!=="none"){let t=this.ctx.filter;this.ctx.filter=e,this.ctx.drawImage(this.ctx.canvas,0,0),this.ctx.filter=t}}},M_=new WeakSet,XP=function(e,t,n){let i=new Path2D;return i.addPath(e,new DOMMatrix(n).invertSelf().multiplySelf(t)),i};var rp=CI;for(let s in co)rp.prototype[s]!==void 0&&(rp.prototype[co[s]]=rp.prototype[s]);var T_,E_,xo=class{static get workerPort(){return m(this,T_)}static set workerPort(e){if(!(typeof Worker<"u"&&e instanceof Worker)&&e!==null)throw new Error("Invalid `workerPort` type.");N(this,T_,e)}static get workerSrc(){return m(this,E_)}static set workerSrc(e){if(typeof e!="string")throw new Error("Invalid `workerSrc` type.");N(this,E_,e)}};T_=new WeakMap,E_=new WeakMap,L(xo,T_,null),L(xo,E_,"");var Xd,x_,QP=class{constructor({parsedData:e,rawData:t}){L(this,Xd,void 0);L(this,x_,void 0);N(this,Xd,e),N(this,x_,t)}getRaw(){return m(this,x_)}get(e){return m(this,Xd).get(e)??null}getAll(){return wI(m(this,Xd))}has(e){return m(this,Xd).has(e)}};Xd=new WeakMap,x_=new WeakMap;var Zh=Symbol("INTERNAL"),S_,C_,A_,Rp,JP=class{constructor(e,{name:t,intent:n,usage:i,rbGroups:r}){L(this,S_,!1);L(this,C_,!1);L(this,A_,!1);L(this,Rp,!0);N(this,S_,!!(e&yr.DISPLAY)),N(this,C_,!!(e&yr.PRINT)),this.name=t,this.intent=n,this.usage=i,this.rbGroups=r}get visible(){if(m(this,A_))return m(this,Rp);if(!m(this,Rp))return!1;let{print:e,view:t}=this.usage;return m(this,S_)?t?.viewState!=="OFF":m(this,C_)?e?.printState!=="OFF":!0}_setVisible(e,t,n=!1){e!==Zh&&zn("Internal method `_setVisible` called."),N(this,A_,n),N(this,Rp,t)}};S_=new WeakMap,C_=new WeakMap,A_=new WeakMap,Rp=new WeakMap;var oc,Rn,Fp,Lp,P_,ek,ZP=class{constructor(e,t=yr.DISPLAY){L(this,P_);L(this,oc,null);L(this,Rn,new Map);L(this,Fp,null);L(this,Lp,null);if(this.renderingIntent=t,this.name=null,this.creator=null,e!==null){this.name=e.name,this.creator=e.creator,N(this,Lp,e.order);for(let n of e.groups)m(this,Rn).set(n.id,new JP(t,n));if(e.baseState==="OFF")for(let n of m(this,Rn).values())n._setVisible(Zh,!1);for(let n of e.on)m(this,Rn).get(n)._setVisible(Zh,!0);for(let n of e.off)m(this,Rn).get(n)._setVisible(Zh,!1);N(this,Fp,this.getHash())}}isVisible(e){if(m(this,Rn).size===0)return!0;if(!e)return JE("Optional content group not defined."),!0;if(e.type==="OCG")return m(this,Rn).has(e.id)?m(this,Rn).get(e.id).visible:(Jt(`Optional content group not found: ${e.id}`),!0);if(e.type==="OCMD"){if(e.expression)return K(this,P_,ek).call(this,e.expression);if(!e.policy||e.policy==="AnyOn"){for(let t of e.ids){if(!m(this,Rn).has(t))return Jt(`Optional content group not found: ${t}`),!0;if(m(this,Rn).get(t).visible)return!0}return!1}else if(e.policy==="AllOn"){for(let t of e.ids){if(!m(this,Rn).has(t))return Jt(`Optional content group not found: ${t}`),!0;if(!m(this,Rn).get(t).visible)return!1}return!0}else if(e.policy==="AnyOff"){for(let t of e.ids){if(!m(this,Rn).has(t))return Jt(`Optional content group not found: ${t}`),!0;if(!m(this,Rn).get(t).visible)return!0}return!1}else if(e.policy==="AllOff"){for(let t of e.ids){if(!m(this,Rn).has(t))return Jt(`Optional content group not found: ${t}`),!0;if(m(this,Rn).get(t).visible)return!1}return!0}return Jt(`Unknown optional content policy ${e.policy}.`),!0}return Jt(`Unknown group type ${e.type}.`),!0}setVisibility(e,t=!0,n=!0){let i=m(this,Rn).get(e);if(!i){Jt(`Optional content group not found: ${e}`);return}if(n&&t&&i.rbGroups.length)for(let r of i.rbGroups)for(let o of r)o!==e&&m(this,Rn).get(o)?._setVisible(Zh,!1,!0);i._setVisible(Zh,!!t,!0),N(this,oc,null)}setOCGState({state:e,preserveRB:t}){let n;for(let i of e){switch(i){case"ON":case"OFF":case"Toggle":n=i;continue}let r=m(this,Rn).get(i);if(r)switch(n){case"ON":this.setVisibility(i,!0,t);break;case"OFF":this.setVisibility(i,!1,t);break;case"Toggle":this.setVisibility(i,!r.visible,t);break}}N(this,oc,null)}get hasInitialVisibility(){return m(this,Fp)===null||this.getHash()===m(this,Fp)}getOrder(){return m(this,Rn).size?m(this,Lp)?m(this,Lp).slice():[...m(this,Rn).keys()]:null}getGroups(){return m(this,Rn).size>0?wI(m(this,Rn)):null}getGroup(e){return m(this,Rn).get(e)||null}getHash(){if(m(this,oc)!==null)return m(this,oc);let e=new UM;for(let[t,n]of m(this,Rn))e.update(`${t}:${n.visible}`);return N(this,oc,e.hexdigest())}};oc=new WeakMap,Rn=new WeakMap,Fp=new WeakMap,Lp=new WeakMap,P_=new WeakSet,ek=function(e){let t=e.length;if(t<2)return!0;let n=e[0];for(let i=1;i<t;i++){let r=e[i],o;if(Array.isArray(r))o=K(this,P_,ek).call(this,r);else if(m(this,Rn).has(r))o=m(this,Rn).get(r).visible;else return Jt(`Optional content group not found: ${r}`),!0;switch(n){case"And":if(!o)return!1;break;case"Or":if(o)return!0;break;case"Not":return!o;default:return!0}}return n==="And"};var tk=class{constructor(e,{disableRange:t=!1,disableStream:n=!1}){Ds(e,'PDFDataTransportStream - missing required "pdfDataRangeTransport" argument.');let{length:i,initialData:r,progressiveDone:o,contentDispositionFilename:a}=e;if(this._queuedChunks=[],this._progressiveDone=o,this._contentDispositionFilename=a,r?.length>0){let l=r instanceof Uint8Array&&r.byteLength===r.buffer.byteLength?r.buffer:new Uint8Array(r).buffer;this._queuedChunks.push(l)}this._pdfDataRangeTransport=e,this._isStreamingSupported=!n,this._isRangeSupported=!t,this._contentLength=i,this._fullRequestReader=null,this._rangeReaders=[],e.addRangeListener((l,c)=>{this._onReceiveData({begin:l,chunk:c})}),e.addProgressListener((l,c)=>{this._onProgress({loaded:l,total:c})}),e.addProgressiveReadListener(l=>{this._onReceiveData({chunk:l})}),e.addProgressiveDoneListener(()=>{this._onProgressiveDone()}),e.transportReady()}_onReceiveData({begin:e,chunk:t}){let n=t instanceof Uint8Array&&t.byteLength===t.buffer.byteLength?t.buffer:new Uint8Array(t).buffer;if(e===void 0)this._fullRequestReader?this._fullRequestReader._enqueue(n):this._queuedChunks.push(n);else{let i=this._rangeReaders.some(function(r){return r._begin!==e?!1:(r._enqueue(n),!0)});Ds(i,"_onReceiveData - no `PDFDataTransportStreamRangeReader` instance found.")}}get _progressiveDataLength(){return this._fullRequestReader?._loaded??0}_onProgress(e){e.total===void 0?this._rangeReaders[0]?.onProgress?.({loaded:e.loaded}):this._fullRequestReader?.onProgress?.({loaded:e.loaded,total:e.total})}_onProgressiveDone(){this._fullRequestReader?.progressiveDone(),this._progressiveDone=!0}_removeRangeReader(e){let t=this._rangeReaders.indexOf(e);t>=0&&this._rangeReaders.splice(t,1)}getFullReader(){Ds(!this._fullRequestReader,"PDFDataTransportStream.getFullReader can only be called once.");let e=this._queuedChunks;return this._queuedChunks=null,new nk(this,e,this._progressiveDone,this._contentDispositionFilename)}getRangeReader(e,t){if(t<=this._progressiveDataLength)return null;let n=new sk(this,e,t);return this._pdfDataRangeTransport.requestDataRange(e,t),this._rangeReaders.push(n),n}cancelAllRequests(e){this._fullRequestReader?.cancel(e);for(let t of this._rangeReaders.slice(0))t.cancel(e);this._pdfDataRangeTransport.abort()}},nk=class{constructor(e,t,n=!1,i=null){this._stream=e,this._done=n||!1,this._filename=TI(i)?i:null,this._queuedChunks=t||[],this._loaded=0;for(let r of this._queuedChunks)this._loaded+=r.byteLength;this._requests=[],this._headersReady=Promise.resolve(),e._fullRequestReader=this,this.onProgress=null}_enqueue(e){this._done||(this._requests.length>0?this._requests.shift().resolve({value:e,done:!1}):this._queuedChunks.push(e),this._loaded+=e.byteLength)}get headersReady(){return this._headersReady}get filename(){return this._filename}get isRangeSupported(){return this._stream._isRangeSupported}get isStreamingSupported(){return this._stream._isStreamingSupported}get contentLength(){return this._stream._contentLength}async read(){if(this._queuedChunks.length>0)return{value:this._queuedChunks.shift(),done:!1};if(this._done)return{value:void 0,done:!0};let e=Promise.withResolvers();return this._requests.push(e),e.promise}cancel(e){this._done=!0;for(let t of this._requests)t.resolve({value:void 0,done:!0});this._requests.length=0}progressiveDone(){this._done||(this._done=!0)}},sk=class{constructor(e,t,n){this._stream=e,this._begin=t,this._end=n,this._queuedChunk=null,this._requests=[],this._done=!1,this.onProgress=null}_enqueue(e){if(!this._done){if(this._requests.length===0)this._queuedChunk=e;else{this._requests.shift().resolve({value:e,done:!1});for(let n of this._requests)n.resolve({value:void 0,done:!0});this._requests.length=0}this._done=!0,this._stream._removeRangeReader(this)}}get isStreamingSupported(){return!1}async read(){if(this._queuedChunk){let t=this._queuedChunk;return this._queuedChunk=null,{value:t,done:!1}}if(this._done)return{value:void 0,done:!0};let e=Promise.withResolvers();return this._requests.push(e),e.promise}cancel(e){this._done=!0;for(let t of this._requests)t.resolve({value:void 0,done:!0});this._requests.length=0,this._stream._removeRangeReader(this)}};function ite(s){let e=!0,t=n("filename\\*","i").exec(s);if(t){t=t[1];let d=a(t);return d=unescape(d),d=l(d),d=c(d),r(d)}if(t=o(s),t){let d=c(t);return r(d)}if(t=n("filename","i").exec(s),t){t=t[1];let d=a(t);return d=c(d),r(d)}function n(d,u){return new RegExp("(?:^|;)\\s*"+d+'\\s*=\\s*([^";\\s][^;\\s]*|"(?:[^"\\\\]|\\\\"?)+"?)',u)}function i(d,u){if(d){if(!/^[\x00-\xFF]+$/.test(u))return u;try{let h=new TextDecoder(d,{fatal:!0}),p=ZE(u);u=h.decode(p),e=!1}catch{}}return u}function r(d){return e&&/[\x80-\xff]/.test(d)&&(d=i("utf-8",d),e&&(d=i("iso-8859-1",d))),d}function o(d){let u=[],h,p=n("filename\\*((?!0\\d)\\d+)(\\*?)","ig");for(;(h=p.exec(d))!==null;){let[,_,b,y]=h;if(_=parseInt(_,10),_ in u){if(_===0)break;continue}u[_]=[b,y]}let f=[];for(let _=0;_<u.length&&_ in u;++_){let[b,y]=u[_];y=a(y),b&&(y=unescape(y),_===0&&(y=l(y))),f.push(y)}return f.join("")}function a(d){if(d.startsWith('"')){let u=d.slice(1).split('\\"');for(let h=0;h<u.length;++h){let p=u[h].indexOf('"');p!==-1&&(u[h]=u[h].slice(0,p),u.length=h+1),u[h]=u[h].replaceAll(/\\(.)/g,"$1")}d=u.join('"')}return d}function l(d){let u=d.indexOf("'");if(u===-1)return d;let h=d.slice(0,u),f=d.slice(u+1).replace(/^[^']*'/,"");return i(h,f)}function c(d){return!d.startsWith("=?")||/[\x00-\x19\x80-\xff]/.test(d)?d:d.replaceAll(/=\?([\w-]*)\?([QqBb])\?((?:[^?]|\?(?!=))*)\?=/g,function(u,h,p,f){if(p==="q"||p==="Q")return f=f.replaceAll("_"," "),f=f.replaceAll(/=([0-9a-fA-F]{2})/g,function(_,b){return String.fromCharCode(parseInt(b,16))}),i(h,f);try{f=atob(f)}catch{}return i(h,f)})}return""}function tV(s,e){let t=new Headers;if(!s||!e||typeof e!="object")return t;for(let n in e){let i=e[n];i!==void 0&&t.append(n,i)}return t}function n0(s){try{return new URL(s).origin}catch{}return null}function nV({responseHeaders:s,isHttp:e,rangeChunkSize:t,disableRange:n}){let i={allowRangeRequests:!1,suggestedLength:void 0},r=parseInt(s.get("Content-Length"),10);return!Number.isInteger(r)||(i.suggestedLength=r,r<=2*t)||n||!e||s.get("Accept-Ranges")!=="bytes"||(s.get("Content-Encoding")||"identity")!=="identity"||(i.allowRangeRequests=!0),i}function sV(s){let e=s.get("Content-Disposition");if(e){let t=ite(e);if(t.includes("%"))try{t=decodeURIComponent(t)}catch{}if(TI(t))return t}return null}function s0(s,e){return s===404||s===0&&e.startsWith("file:")?new Ou('Missing PDF "'+e+'".'):new $f(`Unexpected server response (${s}) while retrieving PDF "${e}".`,s)}function iV(s){return s===200||s===206}function rV(s,e,t){return{method:"GET",headers:s,signal:t.signal,mode:"cors",credentials:e?"include":"same-origin",redirect:"follow"}}function oV(s){return s instanceof Uint8Array?s.buffer:s instanceof ArrayBuffer?s:(Jt(`getArrayBuffer - unexpected data format: ${s}`),new Uint8Array(s).buffer)}var XM=class{constructor(e){Z(this,"_responseOrigin",null);this.source=e,this.isHttp=/^https?:/i.test(e.url),this.headers=tV(this.isHttp,e.httpHeaders),this._fullRequestReader=null,this._rangeRequestReaders=[]}get _progressiveDataLength(){return this._fullRequestReader?._loaded??0}getFullReader(){return Ds(!this._fullRequestReader,"PDFFetchStream.getFullReader can only be called once."),this._fullRequestReader=new ik(this),this._fullRequestReader}getRangeReader(e,t){if(t<=this._progressiveDataLength)return null;let n=new rk(this,e,t);return this._rangeRequestReaders.push(n),n}cancelAllRequests(e){this._fullRequestReader?.cancel(e);for(let t of this._rangeRequestReaders.slice(0))t.cancel(e)}},ik=class{constructor(e){this._stream=e,this._reader=null,this._loaded=0,this._filename=null;let t=e.source;this._withCredentials=t.withCredentials||!1,this._contentLength=t.length,this._headersCapability=Promise.withResolvers(),this._disableRange=t.disableRange||!1,this._rangeChunkSize=t.rangeChunkSize,!this._rangeChunkSize&&!this._disableRange&&(this._disableRange=!0),this._abortController=new AbortController,this._isStreamingSupported=!t.disableStream,this._isRangeSupported=!t.disableRange;let n=new Headers(e.headers),i=t.url;fetch(i,rV(n,this._withCredentials,this._abortController)).then(r=>{if(e._responseOrigin=n0(r.url),!iV(r.status))throw s0(r.status,i);this._reader=r.body.getReader(),this._headersCapability.resolve();let o=r.headers,{allowRangeRequests:a,suggestedLength:l}=nV({responseHeaders:o,isHttp:e.isHttp,rangeChunkSize:this._rangeChunkSize,disableRange:this._disableRange});this._isRangeSupported=a,this._contentLength=l||this._contentLength,this._filename=sV(o),!this._isStreamingSupported&&this._isRangeSupported&&this.cancel(new ya("Streaming is disabled."))}).catch(this._headersCapability.reject),this.onProgress=null}get headersReady(){return this._headersCapability.promise}get filename(){return this._filename}get contentLength(){return this._contentLength}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}async read(){await this._headersCapability.promise;let{value:e,done:t}=await this._reader.read();return t?{value:e,done:t}:(this._loaded+=e.byteLength,this.onProgress?.({loaded:this._loaded,total:this._contentLength}),{value:oV(e),done:!1})}cancel(e){this._reader?.cancel(e),this._abortController.abort()}},rk=class{constructor(e,t,n){this._stream=e,this._reader=null,this._loaded=0;let i=e.source;this._withCredentials=i.withCredentials||!1,this._readCapability=Promise.withResolvers(),this._isStreamingSupported=!i.disableStream,this._abortController=new AbortController;let r=new Headers(e.headers);r.append("Range",`bytes=${t}-${n-1}`);let o=i.url;fetch(o,rV(r,this._withCredentials,this._abortController)).then(a=>{let l=n0(a.url);if(l!==e._responseOrigin)throw new Error(`Expected range response-origin "${l}" to match "${e._responseOrigin}".`);if(!iV(a.status))throw s0(a.status,o);this._readCapability.resolve(),this._reader=a.body.getReader()}).catch(this._readCapability.reject),this.onProgress=null}get isStreamingSupported(){return this._isStreamingSupported}async read(){await this._readCapability.promise;let{value:e,done:t}=await this._reader.read();return t?{value:e,done:t}:(this._loaded+=e.byteLength,this.onProgress?.({loaded:this._loaded}),{value:oV(e),done:!1})}cancel(e){this._reader?.cancel(e),this._abortController.abort()}},iP=200,rP=206;function rte(s){let e=s.response;return typeof e!="string"?e:ZE(e).buffer}var ok=class{constructor({url:e,httpHeaders:t,withCredentials:n}){Z(this,"_responseOrigin",null);this.url=e,this.isHttp=/^https?:/i.test(e),this.headers=tV(this.isHttp,t),this.withCredentials=n||!1,this.currXhrId=0,this.pendingRequests=Object.create(null)}request(e){let t=new XMLHttpRequest,n=this.currXhrId++,i=this.pendingRequests[n]={xhr:t};t.open("GET",this.url),t.withCredentials=this.withCredentials;for(let[r,o]of this.headers)t.setRequestHeader(r,o);return this.isHttp&&"begin"in e&&"end"in e?(t.setRequestHeader("Range",`bytes=${e.begin}-${e.end-1}`),i.expectedStatus=rP):i.expectedStatus=iP,t.responseType="arraybuffer",Ds(e.onError,"Expected `onError` callback to be provided."),t.onerror=()=>{e.onError(t.status)},t.onreadystatechange=this.onStateChange.bind(this,n),t.onprogress=this.onProgress.bind(this,n),i.onHeadersReceived=e.onHeadersReceived,i.onDone=e.onDone,i.onError=e.onError,i.onProgress=e.onProgress,t.send(null),n}onProgress(e,t){let n=this.pendingRequests[e];n&&n.onProgress?.(t)}onStateChange(e,t){let n=this.pendingRequests[e];if(!n)return;let i=n.xhr;if(i.readyState>=2&&n.onHeadersReceived&&(n.onHeadersReceived(),delete n.onHeadersReceived),i.readyState!==4||!(e in this.pendingRequests))return;if(delete this.pendingRequests[e],i.status===0&&this.isHttp){n.onError(i.status);return}let r=i.status||iP;if(!(r===iP&&n.expectedStatus===rP)&&r!==n.expectedStatus){n.onError(i.status);return}let a=rte(i);if(r===rP){let l=i.getResponseHeader("Content-Range"),c=/bytes (\d+)-(\d+)\/(\d+)/.exec(l);c?n.onDone({begin:parseInt(c[1],10),chunk:a}):(Jt('Missing or invalid "Content-Range" header.'),n.onError(0))}else a?n.onDone({begin:0,chunk:a}):n.onError(i.status)}getRequestXhr(e){return this.pendingRequests[e].xhr}isPendingRequest(e){return e in this.pendingRequests}abortRequest(e){let t=this.pendingRequests[e].xhr;delete this.pendingRequests[e],t.abort()}},ak=class{constructor(e){this._source=e,this._manager=new ok(e),this._rangeChunkSize=e.rangeChunkSize,this._fullRequestReader=null,this._rangeRequestReaders=[]}_onRangeRequestReaderClosed(e){let t=this._rangeRequestReaders.indexOf(e);t>=0&&this._rangeRequestReaders.splice(t,1)}getFullReader(){return Ds(!this._fullRequestReader,"PDFNetworkStream.getFullReader can only be called once."),this._fullRequestReader=new lk(this._manager,this._source),this._fullRequestReader}getRangeReader(e,t){let n=new ck(this._manager,e,t);return n.onClosed=this._onRangeRequestReaderClosed.bind(this),this._rangeRequestReaders.push(n),n}cancelAllRequests(e){this._fullRequestReader?.cancel(e);for(let t of this._rangeRequestReaders.slice(0))t.cancel(e)}},lk=class{constructor(e,t){this._manager=e,this._url=t.url,this._fullRequestId=e.request({onHeadersReceived:this._onHeadersReceived.bind(this),onDone:this._onDone.bind(this),onError:this._onError.bind(this),onProgress:this._onProgress.bind(this)}),this._headersCapability=Promise.withResolvers(),this._disableRange=t.disableRange||!1,this._contentLength=t.length,this._rangeChunkSize=t.rangeChunkSize,!this._rangeChunkSize&&!this._disableRange&&(this._disableRange=!0),this._isStreamingSupported=!1,this._isRangeSupported=!1,this._cachedChunks=[],this._requests=[],this._done=!1,this._storedError=void 0,this._filename=null,this.onProgress=null}_onHeadersReceived(){let e=this._fullRequestId,t=this._manager.getRequestXhr(e);this._manager._responseOrigin=n0(t.responseURL);let n=t.getAllResponseHeaders(),i=new Headers(n?n.trimStart().replace(/[^\S ]+$/,"").split(/[\r\n]+/).map(a=>{let[l,...c]=a.split(": ");return[l,c.join(": ")]}):[]),{allowRangeRequests:r,suggestedLength:o}=nV({responseHeaders:i,isHttp:this._manager.isHttp,rangeChunkSize:this._rangeChunkSize,disableRange:this._disableRange});r&&(this._isRangeSupported=!0),this._contentLength=o||this._contentLength,this._filename=sV(i),this._isRangeSupported&&this._manager.abortRequest(e),this._headersCapability.resolve()}_onDone(e){if(e&&(this._requests.length>0?this._requests.shift().resolve({value:e.chunk,done:!1}):this._cachedChunks.push(e.chunk)),this._done=!0,!(this._cachedChunks.length>0)){for(let t of this._requests)t.resolve({value:void 0,done:!0});this._requests.length=0}}_onError(e){this._storedError=s0(e,this._url),this._headersCapability.reject(this._storedError);for(let t of this._requests)t.reject(this._storedError);this._requests.length=0,this._cachedChunks.length=0}_onProgress(e){this.onProgress?.({loaded:e.loaded,total:e.lengthComputable?e.total:this._contentLength})}get filename(){return this._filename}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}get contentLength(){return this._contentLength}get headersReady(){return this._headersCapability.promise}async read(){if(await this._headersCapability.promise,this._storedError)throw this._storedError;if(this._cachedChunks.length>0)return{value:this._cachedChunks.shift(),done:!1};if(this._done)return{value:void 0,done:!0};let e=Promise.withResolvers();return this._requests.push(e),e.promise}cancel(e){this._done=!0,this._headersCapability.reject(e);for(let t of this._requests)t.resolve({value:void 0,done:!0});this._requests.length=0,this._manager.isPendingRequest(this._fullRequestId)&&this._manager.abortRequest(this._fullRequestId),this._fullRequestReader=null}},ck=class{constructor(e,t,n){this._manager=e,this._url=e.url,this._requestId=e.request({begin:t,end:n,onHeadersReceived:this._onHeadersReceived.bind(this),onDone:this._onDone.bind(this),onError:this._onError.bind(this),onProgress:this._onProgress.bind(this)}),this._requests=[],this._queuedChunk=null,this._done=!1,this._storedError=void 0,this.onProgress=null,this.onClosed=null}_onHeadersReceived(){let e=n0(this._manager.getRequestXhr(this._requestId)?.responseURL);e!==this._manager._responseOrigin&&(this._storedError=new Error(`Expected range response-origin "${e}" to match "${this._manager._responseOrigin}".`),this._onError(0))}_close(){this.onClosed?.(this)}_onDone(e){let t=e.chunk;this._requests.length>0?this._requests.shift().resolve({value:t,done:!1}):this._queuedChunk=t,this._done=!0;for(let n of this._requests)n.resolve({value:void 0,done:!0});this._requests.length=0,this._close()}_onError(e){this._storedError??(this._storedError=s0(e,this._url));for(let t of this._requests)t.reject(this._storedError);this._requests.length=0,this._queuedChunk=null}_onProgress(e){this.isStreamingSupported||this.onProgress?.({loaded:e.loaded})}get isStreamingSupported(){return!1}async read(){if(this._storedError)throw this._storedError;if(this._queuedChunk!==null){let t=this._queuedChunk;return this._queuedChunk=null,{value:t,done:!1}}if(this._done)return{value:void 0,done:!0};let e=Promise.withResolvers();return this._requests.push(e),e.promise}cancel(e){this._done=!0;for(let t of this._requests)t.resolve({value:void 0,done:!0});this._requests.length=0,this._manager.isPendingRequest(this._requestId)&&this._manager.abortRequest(this._requestId),this._close()}},ote=/^[a-z][a-z0-9\-+.]+:/i;function ate(s){if(ote.test(s))return new URL(s);let e=process.getBuiltinModule("url");return new URL(e.pathToFileURL(s))}var dk=class{constructor(e){this.source=e,this.url=ate(e.url),Ds(this.url.protocol==="file:","PDFNodeStream only supports file:// URLs."),this._fullRequestReader=null,this._rangeRequestReaders=[]}get _progressiveDataLength(){return this._fullRequestReader?._loaded??0}getFullReader(){return Ds(!this._fullRequestReader,"PDFNodeStream.getFullReader can only be called once."),this._fullRequestReader=new uk(this),this._fullRequestReader}getRangeReader(e,t){if(t<=this._progressiveDataLength)return null;let n=new hk(this,e,t);return this._rangeRequestReaders.push(n),n}cancelAllRequests(e){this._fullRequestReader?.cancel(e);for(let t of this._rangeRequestReaders.slice(0))t.cancel(e)}},uk=class{constructor(e){this._url=e.url,this._done=!1,this._storedError=null,this.onProgress=null;let t=e.source;this._contentLength=t.length,this._loaded=0,this._filename=null,this._disableRange=t.disableRange||!1,this._rangeChunkSize=t.rangeChunkSize,!this._rangeChunkSize&&!this._disableRange&&(this._disableRange=!0),this._isStreamingSupported=!t.disableStream,this._isRangeSupported=!t.disableRange,this._readableStream=null,this._readCapability=Promise.withResolvers(),this._headersCapability=Promise.withResolvers();let n=process.getBuiltinModule("fs");n.promises.lstat(this._url).then(i=>{this._contentLength=i.size,this._setReadableStream(n.createReadStream(this._url)),this._headersCapability.resolve()},i=>{i.code==="ENOENT"&&(i=new Ou(`Missing PDF "${this._url}".`)),this._storedError=i,this._headersCapability.reject(i)})}get headersReady(){return this._headersCapability.promise}get filename(){return this._filename}get contentLength(){return this._contentLength}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}async read(){if(await this._readCapability.promise,this._done)return{value:void 0,done:!0};if(this._storedError)throw this._storedError;let e=this._readableStream.read();return e===null?(this._readCapability=Promise.withResolvers(),this.read()):(this._loaded+=e.length,this.onProgress?.({loaded:this._loaded,total:this._contentLength}),{value:new Uint8Array(e).buffer,done:!1})}cancel(e){if(!this._readableStream){this._error(e);return}this._readableStream.destroy(e)}_error(e){this._storedError=e,this._readCapability.resolve()}_setReadableStream(e){this._readableStream=e,e.on("readable",()=>{this._readCapability.resolve()}),e.on("end",()=>{e.destroy(),this._done=!0,this._readCapability.resolve()}),e.on("error",t=>{this._error(t)}),!this._isStreamingSupported&&this._isRangeSupported&&this._error(new ya("streaming is disabled")),this._storedError&&this._readableStream.destroy(this._storedError)}},hk=class{constructor(e,t,n){this._url=e.url,this._done=!1,this._storedError=null,this.onProgress=null,this._loaded=0,this._readableStream=null,this._readCapability=Promise.withResolvers();let i=e.source;this._isStreamingSupported=!i.disableStream;let r=process.getBuiltinModule("fs");this._setReadableStream(r.createReadStream(this._url,{start:t,end:n-1}))}get isStreamingSupported(){return this._isStreamingSupported}async read(){if(await this._readCapability.promise,this._done)return{value:void 0,done:!0};if(this._storedError)throw this._storedError;let e=this._readableStream.read();return e===null?(this._readCapability=Promise.withResolvers(),this.read()):(this._loaded+=e.length,this.onProgress?.({loaded:this._loaded}),{value:new Uint8Array(e).buffer,done:!1})}cancel(e){if(!this._readableStream){this._error(e);return}this._readableStream.destroy(e)}_error(e){this._storedError=e,this._readCapability.resolve()}_setReadableStream(e){this._readableStream=e,e.on("readable",()=>{this._readCapability.resolve()}),e.on("end",()=>{e.destroy(),this._done=!0,this._readCapability.resolve()}),e.on("error",t=>{this._error(t)}),this._storedError&&this._readableStream.destroy(this._storedError)}},lte=1e5,Hi=30,cte=.8,ac,Yi,k_,I_,Qd,nl,D_,R_,Jd,Np,Op,lc,$p,F_,Bp,Zd,L_,N_,eu,tu,O_,cc,zp,QT,aV,JT,lV,$_,pk,Up,_M,B_,fk,ZT,cV,eE,dV,ps=class ps{constructor({textContentSource:e,container:t,viewport:n}){L(this,QT);L(this,JT);L(this,$_);L(this,ac,Promise.withResolvers());L(this,Yi,null);L(this,k_,!1);L(this,I_,!!globalThis.FontInspector?.enabled);L(this,Qd,null);L(this,nl,null);L(this,D_,0);L(this,R_,0);L(this,Jd,null);L(this,Np,null);L(this,Op,0);L(this,lc,0);L(this,$p,Object.create(null));L(this,F_,[]);L(this,Bp,null);L(this,Zd,[]);L(this,L_,new WeakMap);L(this,N_,null);var l;if(e instanceof ReadableStream)N(this,Bp,e);else if(typeof e=="object")N(this,Bp,new ReadableStream({start(c){c.enqueue(e),c.close()}}));else throw new Error('No "textContentSource" parameter specified.');N(this,Yi,N(this,Np,t)),N(this,lc,n.scale*(globalThis.devicePixelRatio||1)),N(this,Op,n.rotation),N(this,nl,{div:null,properties:null,ctx:null});let{pageWidth:i,pageHeight:r,pageX:o,pageY:a}=n.rawDims;N(this,N_,[1,0,0,-1,-o,a+r]),N(this,R_,i),N(this,D_,r),K(l=ps,ZT,cV).call(l),$u(t,n),m(this,ac).promise.finally(()=>{m(ps,zp).delete(this),N(this,nl,null),N(this,$p,null)}).catch(()=>{})}static get fontFamilyMap(){let{isWindows:e,isFirefox:t}=ui.platform;return an(this,"fontFamilyMap",new Map([["sans-serif",`${e&&t?"Calibri, ":""}sans-serif`],["monospace",`${e&&t?"Lucida Console, ":""}monospace`]]))}render(){let e=()=>{m(this,Jd).read().then(({value:t,done:n})=>{if(n){m(this,ac).resolve();return}m(this,Qd)??N(this,Qd,t.lang),Object.assign(m(this,$p),t.styles),K(this,QT,aV).call(this,t.items),e()},m(this,ac).reject)};return N(this,Jd,m(this,Bp).getReader()),m(ps,zp).add(this),e(),m(this,ac).promise}update({viewport:e,onBefore:t=null}){var r;let n=e.scale*(globalThis.devicePixelRatio||1),i=e.rotation;if(i!==m(this,Op)&&(t?.(),N(this,Op,i),$u(m(this,Np),{rotation:i})),n!==m(this,lc)){t?.(),N(this,lc,n);let o={div:null,properties:null,ctx:K(r=ps,Up,_M).call(r,m(this,Qd))};for(let a of m(this,Zd))o.properties=m(this,L_).get(a),o.div=a,K(this,$_,pk).call(this,o)}}cancel(){let e=new ya("TextLayer task cancelled.");m(this,Jd)?.cancel(e).catch(()=>{}),N(this,Jd,null),m(this,ac).reject(e)}get textDivs(){return m(this,Zd)}get textContentItemsStr(){return m(this,F_)}static cleanup(){if(!(m(this,zp).size>0)){m(this,eu).clear();for(let{canvas:e}of m(this,tu).values())e.remove();m(this,tu).clear()}}};ac=new WeakMap,Yi=new WeakMap,k_=new WeakMap,I_=new WeakMap,Qd=new WeakMap,nl=new WeakMap,D_=new WeakMap,R_=new WeakMap,Jd=new WeakMap,Np=new WeakMap,Op=new WeakMap,lc=new WeakMap,$p=new WeakMap,F_=new WeakMap,Bp=new WeakMap,Zd=new WeakMap,L_=new WeakMap,N_=new WeakMap,eu=new WeakMap,tu=new WeakMap,O_=new WeakMap,cc=new WeakMap,zp=new WeakMap,QT=new WeakSet,aV=function(e){var i,r;if(m(this,k_))return;(r=m(this,nl)).ctx??(r.ctx=K(i=ps,Up,_M).call(i,m(this,Qd)));let t=m(this,Zd),n=m(this,F_);for(let o of e){if(t.length>lte){Jt("Ignoring additional textDivs for performance reasons."),N(this,k_,!0);return}if(o.str===void 0){if(o.type==="beginMarkedContentProps"||o.type==="beginMarkedContent"){let a=m(this,Yi);N(this,Yi,document.createElement("span")),m(this,Yi).classList.add("markedContent"),o.id!==null&&m(this,Yi).setAttribute("id",`${o.id}`),a.append(m(this,Yi))}else o.type==="endMarkedContent"&&N(this,Yi,m(this,Yi).parentNode);continue}n.push(o.str),K(this,JT,lV).call(this,o)}},JT=new WeakSet,lV=function(e){var _;let t=document.createElement("span"),n={angle:0,canvasWidth:0,hasText:e.str!=="",hasEOL:e.hasEOL,fontSize:0};m(this,Zd).push(t);let i=At.transform(m(this,N_),e.transform),r=Math.atan2(i[1],i[0]),o=m(this,$p)[e.fontName];o.vertical&&(r+=Math.PI/2);let a=m(this,I_)&&o.fontSubstitution||o.fontFamily;a=ps.fontFamilyMap.get(a)||a;let l=Math.hypot(i[2],i[3]),c=l*K(_=ps,eE,dV).call(_,a,m(this,Qd)),d,u;r===0?(d=i[4],u=i[5]-c):(d=i[4]+c*Math.sin(r),u=i[5]-c*Math.cos(r));let h="calc(var(--scale-factor)*",p=t.style;m(this,Yi)===m(this,Np)?(p.left=`${(100*d/m(this,R_)).toFixed(2)}%`,p.top=`${(100*u/m(this,D_)).toFixed(2)}%`):(p.left=`${h}${d.toFixed(2)}px)`,p.top=`${h}${u.toFixed(2)}px)`),p.fontSize=`${h}${(m(ps,cc)*l).toFixed(2)}px)`,p.fontFamily=a,n.fontSize=l,t.setAttribute("role","presentation"),t.textContent=e.str,t.dir=e.dir,m(this,I_)&&(t.dataset.fontName=o.fontSubstitutionLoadedName||e.fontName),r!==0&&(n.angle=r*(180/Math.PI));let f=!1;if(e.str.length>1)f=!0;else if(e.str!==" "&&e.transform[0]!==e.transform[3]){let b=Math.abs(e.transform[0]),y=Math.abs(e.transform[3]);b!==y&&Math.max(b,y)/Math.min(b,y)>1.5&&(f=!0)}if(f&&(n.canvasWidth=o.vertical?e.height:e.width),m(this,L_).set(t,n),m(this,nl).div=t,m(this,nl).properties=n,K(this,$_,pk).call(this,m(this,nl)),n.hasText&&m(this,Yi).append(t),n.hasEOL){let b=document.createElement("br");b.setAttribute("role","presentation"),m(this,Yi).append(b)}},$_=new WeakSet,pk=function(e){var a;let{div:t,properties:n,ctx:i}=e,{style:r}=t,o="";if(m(ps,cc)>1&&(o=`scale(${1/m(ps,cc)})`),n.canvasWidth!==0&&n.hasText){let{fontFamily:l}=r,{canvasWidth:c,fontSize:d}=n;K(a=ps,B_,fk).call(a,i,d*m(this,lc),l);let{width:u}=i.measureText(t.textContent);u>0&&(o=`scaleX(${c*m(this,lc)/u}) ${o}`)}n.angle!==0&&(o=`rotate(${n.angle}deg) ${o}`),o.length>0&&(r.transform=o)},Up=new WeakSet,_M=function(e=null){let t=m(this,tu).get(e||(e=""));if(!t){let n=document.createElement("canvas");n.className="hiddenCanvasElement",n.lang=e,document.body.append(n),t=n.getContext("2d",{alpha:!1,willReadFrequently:!0}),m(this,tu).set(e,t),m(this,O_).set(t,{size:0,family:""})}return t},B_=new WeakSet,fk=function(e,t,n){let i=m(this,O_).get(e);t===i.size&&n===i.family||(e.font=`${t}px ${n}`,i.size=t,i.family=n)},ZT=new WeakSet,cV=function(){if(m(this,cc)!==null)return;let e=document.createElement("div");e.style.opacity=0,e.style.lineHeight=1,e.style.fontSize="1px",e.style.position="absolute",e.textContent="X",document.body.append(e),N(this,cc,e.getBoundingClientRect().height),e.remove()},eE=new WeakSet,dV=function(e,t){let n=m(this,eu).get(e);if(n)return n;let i=K(this,Up,_M).call(this,t);i.canvas.width=i.canvas.height=Hi,K(this,B_,fk).call(this,i,Hi,e);let r=i.measureText(""),o=r.fontBoundingBoxAscent,a=Math.abs(r.fontBoundingBoxDescent);if(o){let d=o/(o+a);return m(this,eu).set(e,d),i.canvas.width=i.canvas.height=0,d}i.strokeStyle="red",i.clearRect(0,0,Hi,Hi),i.strokeText("g",0,0);let l=i.getImageData(0,0,Hi,Hi).data;a=0;for(let d=l.length-1-3;d>=0;d-=4)if(l[d]>0){a=Math.ceil(d/4/Hi);break}i.clearRect(0,0,Hi,Hi),i.strokeText("A",0,Hi),l=i.getImageData(0,0,Hi,Hi).data,o=0;for(let d=0,u=l.length;d<u;d+=4)if(l[d]>0){o=Hi-Math.floor(d/4/Hi);break}i.canvas.width=i.canvas.height=0;let c=o?o/(o+a):cte;return m(this,eu).set(e,c),c},L(ps,Up),L(ps,B_),L(ps,ZT),L(ps,eE),L(ps,eu,new Map),L(ps,tu,new Map),L(ps,O_,new WeakMap),L(ps,cc,null),L(ps,zp,new Set);var Mg=ps,Tg=class s{static textContent(e){let t=[],n={items:t,styles:Object.create(null)};function i(r){if(!r)return;let o=null,a=r.name;if(a==="#text")o=r.value;else if(s.shouldBuildText(a))r?.attributes?.textContent?o=r.attributes.textContent:r.value&&(o=r.value);else return;if(o!==null&&t.push({str:o}),!!r.children)for(let l of r.children)i(l)}return i(e),n}static shouldBuildText(e){return!(e==="textarea"||e==="input"||e==="option"||e==="select")}},dte=65536,ute=100,hte=5e3,pte=xi?BP:FP,fte=xi?zP:HM,mte=xi?$P:LP,gte=xi?UP:KM;function _te(s={}){typeof s=="string"||s instanceof URL?s={url:s}:(s instanceof ArrayBuffer||ArrayBuffer.isView(s))&&(s={data:s});let e=new mk,{docId:t}=e,n=s.url?yte(s.url):null,i=s.data?vte(s.data):null,r=s.httpHeaders||null,o=s.withCredentials===!0,a=s.password??null,l=s.range instanceof QM?s.range:null,c=Number.isInteger(s.rangeChunkSize)&&s.rangeChunkSize>0?s.rangeChunkSize:dte,d=s.worker instanceof op?s.worker:null,u=s.verbosity,h=typeof s.docBaseUrl=="string"&&!t0(s.docBaseUrl)?s.docBaseUrl:null,p=typeof s.cMapUrl=="string"?s.cMapUrl:null,f=s.cMapPacked!==!1,_=s.CMapReaderFactory||fte,b=typeof s.standardFontDataUrl=="string"?s.standardFontDataUrl:null,y=s.StandardFontDataFactory||gte,w=s.stopAtErrors!==!0,C=Number.isInteger(s.maxImageSize)&&s.maxImageSize>-1?s.maxImageSize:-1,M=s.isEvalSupported!==!1,S=typeof s.isOffscreenCanvasSupported=="boolean"?s.isOffscreenCanvasSupported:!xi,k=typeof s.isImageDecoderSupported=="boolean"?s.isImageDecoderSupported:!xi&&(ui.platform.isFirefox||!globalThis.chrome),T=Number.isInteger(s.canvasMaxAreaInBytes)?s.canvasMaxAreaInBytes:-1,P=typeof s.disableFontFace=="boolean"?s.disableFontFace:xi,R=s.fontExtraProperties===!0,O=s.enableXfa===!0,H=s.ownerDocument||globalThis.document,X=s.disableRange===!0,z=s.disableStream===!0,ne=s.disableAutoFetch===!0,re=s.pdfBug===!0,Y=s.CanvasFactory||pte,se=s.FilterFactory||mte,ue=s.enableHWA===!0,fe=l?l.length:s.length??NaN,Pe=typeof s.useSystemFonts=="boolean"?s.useSystemFonts:!xi&&!P,oe=typeof s.useWorkerFetch=="boolean"?s.useWorkerFetch:_===HM&&y===KM&&p&&b&&Qm(p,document.baseURI)&&Qm(b,document.baseURI),te=null;Fee(u);let j={canvasFactory:new Y({ownerDocument:H,enableHWA:ue}),filterFactory:new se({docId:t,ownerDocument:H}),cMapReaderFactory:oe?null:new _({baseUrl:p,isCompressed:f}),standardFontDataFactory:oe?null:new y({baseUrl:b})};if(!d){let be={verbosity:u,port:xo.workerPort};d=be.port?op.fromPort(be):new op(be),e._worker=d}let G={docId:t,apiVersion:"4.10.38",data:i,password:a,disableAutoFetch:ne,rangeChunkSize:c,length:fe,docBaseUrl:h,enableXfa:O,evaluatorOptions:{maxImageSize:C,disableFontFace:P,ignoreErrors:w,isEvalSupported:M,isOffscreenCanvasSupported:S,isImageDecoderSupported:k,canvasMaxAreaInBytes:T,fontExtraProperties:R,useSystemFonts:Pe,cMapUrl:oe?p:null,standardFontDataUrl:oe?b:null}},de={disableFontFace:P,fontExtraProperties:R,ownerDocument:H,pdfBug:re,styleElement:te,loadingParams:{disableAutoFetch:ne,enableXfa:O}};return d.promise.then(function(){if(e.destroyed)throw new Error("Loading aborted");if(d.destroyed)throw new Error("Worker was destroyed");let be=d.messageHandler.sendWithPromise("GetDocRequest",G,i?[i.buffer]:null),xe;if(l)xe=new tk(l,{disableRange:X,disableStream:z});else if(!i){if(!n)throw new Error("getDocument - no `url` parameter provided.");let Oe;if(xi)if(Qm(n)){if(typeof fetch>"u"||typeof Response>"u"||!("body"in Response.prototype))throw new Error("getDocument - the Fetch API was disabled in Node.js, see `--no-experimental-fetch`.");Oe=XM}else Oe=dk;else Oe=Qm(n)?XM:ak;xe=new Oe({url:n,length:fe,httpHeaders:r,withCredentials:o,rangeChunkSize:c,disableRange:X,disableStream:z})}return be.then(Oe=>{if(e.destroyed)throw new Error("Loading aborted");if(d.destroyed)throw new Error("Worker was destroyed");let je=new vd(t,Oe,d.port),dt=new vk(je,e,xe,de,j);e._transport=dt,je.send("Ready",null)})}).catch(e._capability.reject),e}function yte(s){if(s instanceof URL)return s.href;try{return new URL(s,window.location).href}catch{if(xi&&typeof s=="string")return s}throw new Error("Invalid PDF url data: either string or URL-object is expected in the url property.")}function vte(s){if(xi&&typeof Buffer<"u"&&s instanceof Buffer)throw new Error("Please provide binary data as `Uint8Array`, rather than `Buffer`.");if(s instanceof Uint8Array&&s.byteLength===s.buffer.byteLength)return s;if(typeof s=="string")return ZE(s);if(s instanceof ArrayBuffer||ArrayBuffer.isView(s)||typeof s=="object"&&!isNaN(s?.length))return new Uint8Array(s);throw new Error("Invalid PDF binary data: either TypedArray, string, or array-like object is expected in the data property.")}function g3(s){return typeof s=="object"&&Number.isInteger(s?.num)&&s.num>=0&&Number.isInteger(s?.gen)&&s.gen>=0}var tE,nE=class nE{constructor(){this._capability=Promise.withResolvers(),this._transport=null,this._worker=null,this.docId=`d${Ii(nE,tE)._++}`,this.destroyed=!1,this.onPassword=null,this.onProgress=null}get promise(){return this._capability.promise}async destroy(){this.destroyed=!0;try{this._worker?.port&&(this._worker._pendingDestroy=!0),await this._transport?.destroy()}catch(e){throw this._worker?.port&&delete this._worker._pendingDestroy,e}this._transport=null,this._worker?.destroy(),this._worker=null}};tE=new WeakMap,L(nE,tE,0);var mk=nE,QM=class{constructor(e,t,n=!1,i=null){this.length=e,this.initialData=t,this.progressiveDone=n,this.contentDispositionFilename=i,this._rangeListeners=[],this._progressListeners=[],this._progressiveReadListeners=[],this._progressiveDoneListeners=[],this._readyCapability=Promise.withResolvers()}addRangeListener(e){this._rangeListeners.push(e)}addProgressListener(e){this._progressListeners.push(e)}addProgressiveReadListener(e){this._progressiveReadListeners.push(e)}addProgressiveDoneListener(e){this._progressiveDoneListeners.push(e)}onDataRange(e,t){for(let n of this._rangeListeners)n(e,t)}onDataProgress(e,t){this._readyCapability.promise.then(()=>{for(let n of this._progressListeners)n(e,t)})}onDataProgressiveRead(e){this._readyCapability.promise.then(()=>{for(let t of this._progressiveReadListeners)t(e)})}onDataProgressiveDone(){this._readyCapability.promise.then(()=>{for(let e of this._progressiveDoneListeners)e()})}transportReady(){this._readyCapability.resolve()}requestDataRange(e,t){zn("Abstract method PDFDataRangeTransport.requestDataRange")}abort(){}},gk=class{constructor(e,t){this._pdfInfo=e,this._transport=t}get annotationStorage(){return this._transport.annotationStorage}get canvasFactory(){return this._transport.canvasFactory}get filterFactory(){return this._transport.filterFactory}get numPages(){return this._pdfInfo.numPages}get fingerprints(){return this._pdfInfo.fingerprints}get isPureXfa(){return an(this,"isPureXfa",!!this._transport._htmlForXfa)}get allXfaHtml(){return this._transport._htmlForXfa}getPage(e){return this._transport.getPage(e)}getPageIndex(e){return this._transport.getPageIndex(e)}getDestinations(){return this._transport.getDestinations()}getDestination(e){return this._transport.getDestination(e)}getPageLabels(){return this._transport.getPageLabels()}getPageLayout(){return this._transport.getPageLayout()}getPageMode(){return this._transport.getPageMode()}getViewerPreferences(){return this._transport.getViewerPreferences()}getOpenAction(){return this._transport.getOpenAction()}getAttachments(){return this._transport.getAttachments()}getJSActions(){return this._transport.getDocJSActions()}getOutline(){return this._transport.getOutline()}getOptionalContentConfig({intent:e="display"}={}){let{renderingIntent:t}=this._transport.getRenderingIntent(e);return this._transport.getOptionalContentConfig(t)}getPermissions(){return this._transport.getPermissions()}getMetadata(){return this._transport.getMetadata()}getMarkInfo(){return this._transport.getMarkInfo()}getData(){return this._transport.getData()}saveDocument(){return this._transport.saveDocument()}getDownloadInfo(){return this._transport.downloadInfoCapability.promise}cleanup(e=!1){return this._transport.startCleanup(e||this.isPureXfa)}destroy(){return this.loadingTask.destroy()}cachedPageNumber(e){return this._transport.cachedPageNumber(e)}get loadingParams(){return this._transport.loadingParams}get loadingTask(){return this._transport.loadingTask}getFieldObjects(){return this._transport.getFieldObjects()}hasJSActions(){return this._transport.hasJSActions()}getCalculationOrderIds(){return this._transport.getCalculationOrderIds()}},dc,sl,uc,ep,Vp,yM,_k=class{constructor(e,t,n,i=!1){L(this,uc);L(this,Vp);L(this,dc,null);L(this,sl,!1);this._pageIndex=e,this._pageInfo=t,this._transport=n,this._stats=i?new OM:null,this._pdfBug=i,this.commonObjs=n.commonObjs,this.objs=new JM,this._maybeCleanupAfterRender=!1,this._intentStates=new Map,this.destroyed=!1}get pageNumber(){return this._pageIndex+1}get rotate(){return this._pageInfo.rotate}get ref(){return this._pageInfo.ref}get userUnit(){return this._pageInfo.userUnit}get view(){return this._pageInfo.view}getViewport({scale:e,rotation:t=this.rotate,offsetX:n=0,offsetY:i=0,dontFlip:r=!1}={}){return new _g({viewBox:this.view,userUnit:this.userUnit,scale:e,rotation:t,offsetX:n,offsetY:i,dontFlip:r})}getAnnotations({intent:e="display"}={}){let{renderingIntent:t}=this._transport.getRenderingIntent(e);return this._transport.getAnnotations(this._pageIndex,t)}getJSActions(){return this._transport.getPageJSActions(this._pageIndex)}get filterFactory(){return this._transport.filterFactory}get isPureXfa(){return an(this,"isPureXfa",!!this._transport._htmlForXfa)}async getXfa(){return this._transport._htmlForXfa?.children[this._pageIndex]||null}render({canvasContext:e,viewport:t,intent:n="display",annotationMode:i=Wl.ENABLE,transform:r=null,background:o=null,optionalContentConfigPromise:a=null,annotationCanvasMap:l=null,pageColors:c=null,printAnnotationStorage:d=null,isEditing:u=!1}){this._stats?.time("Overall");let h=this._transport.getRenderingIntent(n,i,d,u),{renderingIntent:p,cacheKey:f}=h;N(this,sl,!1),K(this,Vp,yM).call(this),a||(a=this._transport.getOptionalContentConfig(p));let _=this._intentStates.get(f);_||(_=Object.create(null),this._intentStates.set(f,_)),_.streamReaderCancelTimeout&&(clearTimeout(_.streamReaderCancelTimeout),_.streamReaderCancelTimeout=null);let b=!!(p&yr.PRINT);_.displayReadyCapability||(_.displayReadyCapability=Promise.withResolvers(),_.operatorList={fnArray:[],argsArray:[],lastChunk:!1,separateAnnots:null},this._stats?.time("Page Request"),this._pumpOperatorList(h));let y=M=>{_.renderTasks.delete(w),(this._maybeCleanupAfterRender||b)&&N(this,sl,!0),K(this,uc,ep).call(this,!b),M?(w.capability.reject(M),this._abortOperatorList({intentState:_,reason:M instanceof Error?M:new Error(M)})):w.capability.resolve(),this._stats&&(this._stats.timeEnd("Rendering"),this._stats.timeEnd("Overall"),globalThis.Stats?.enabled&&globalThis.Stats.add(this.pageNumber,this._stats))},w=new Mk({callback:y,params:{canvasContext:e,viewport:t,transform:r,background:o},objs:this.objs,commonObjs:this.commonObjs,annotationCanvasMap:l,operatorList:_.operatorList,pageIndex:this._pageIndex,canvasFactory:this._transport.canvasFactory,filterFactory:this._transport.filterFactory,useRequestAnimationFrame:!b,pdfBug:this._pdfBug,pageColors:c});(_.renderTasks||(_.renderTasks=new Set)).add(w);let C=w.task;return Promise.all([_.displayReadyCapability.promise,a]).then(([M,S])=>{if(this.destroyed){y();return}if(this._stats?.time("Rendering"),!(S.renderingIntent&p))throw new Error("Must use the same `intent`-argument when calling the `PDFPageProxy.render` and `PDFDocumentProxy.getOptionalContentConfig` methods.");w.initializeGraphics({transparency:M,optionalContentConfig:S}),w.operatorListChanged()}).catch(y),C}getOperatorList({intent:e="display",annotationMode:t=Wl.ENABLE,printAnnotationStorage:n=null,isEditing:i=!1}={}){function r(){a.operatorList.lastChunk&&(a.opListReadCapability.resolve(a.operatorList),a.renderTasks.delete(l))}let o=this._transport.getRenderingIntent(e,t,n,i,!0),a=this._intentStates.get(o.cacheKey);a||(a=Object.create(null),this._intentStates.set(o.cacheKey,a));let l;return a.opListReadCapability||(l=Object.create(null),l.operatorListChanged=r,a.opListReadCapability=Promise.withResolvers(),(a.renderTasks||(a.renderTasks=new Set)).add(l),a.operatorList={fnArray:[],argsArray:[],lastChunk:!1,separateAnnots:null},this._stats?.time("Page Request"),this._pumpOperatorList(o)),a.opListReadCapability.promise}streamTextContent({includeMarkedContent:e=!1,disableNormalization:t=!1}={}){return this._transport.messageHandler.sendWithStream("GetTextContent",{pageIndex:this._pageIndex,includeMarkedContent:e===!0,disableNormalization:t===!0},{highWaterMark:100,size(i){return i.items.length}})}getTextContent(e={}){if(this._transport._htmlForXfa)return this.getXfa().then(n=>Tg.textContent(n));let t=this.streamTextContent(e);return new Promise(function(n,i){function r(){o.read().then(function({value:l,done:c}){if(c){n(a);return}a.lang??(a.lang=l.lang),Object.assign(a.styles,l.styles),a.items.push(...l.items),r()},i)}let o=t.getReader(),a={items:[],styles:Object.create(null),lang:null};r()})}getStructTree(){return this._transport.getStructTree(this._pageIndex)}_destroy(){this.destroyed=!0;let e=[];for(let t of this._intentStates.values())if(this._abortOperatorList({intentState:t,reason:new Error("Page was destroyed."),force:!0}),!t.opListReadCapability)for(let n of t.renderTasks)e.push(n.completed),n.cancel();return this.objs.clear(),N(this,sl,!1),K(this,Vp,yM).call(this),Promise.all(e)}cleanup(e=!1){N(this,sl,!0);let t=K(this,uc,ep).call(this,!1);return e&&t&&this._stats&&(this._stats=new OM),t}_startRenderPage(e,t){let n=this._intentStates.get(t);n&&(this._stats?.timeEnd("Page Request"),n.displayReadyCapability?.resolve(e))}_renderPageChunk(e,t){for(let n=0,i=e.length;n<i;n++)t.operatorList.fnArray.push(e.fnArray[n]),t.operatorList.argsArray.push(e.argsArray[n]);t.operatorList.lastChunk=e.lastChunk,t.operatorList.separateAnnots=e.separateAnnots;for(let n of t.renderTasks)n.operatorListChanged();e.lastChunk&&K(this,uc,ep).call(this,!0)}_pumpOperatorList({renderingIntent:e,cacheKey:t,annotationStorageSerializable:n,modifiedIds:i}){let{map:r,transfer:o}=n,l=this._transport.messageHandler.sendWithStream("GetOperatorList",{pageIndex:this._pageIndex,intent:e,cacheKey:t,annotationStorage:r,modifiedIds:i},o).getReader(),c=this._intentStates.get(t);c.streamReader=l;let d=()=>{l.read().then(({value:u,done:h})=>{if(h){c.streamReader=null;return}this._transport.destroyed||(this._renderPageChunk(u,c),d())},u=>{if(c.streamReader=null,!this._transport.destroyed){if(c.operatorList){c.operatorList.lastChunk=!0;for(let h of c.renderTasks)h.operatorListChanged();K(this,uc,ep).call(this,!0)}if(c.displayReadyCapability)c.displayReadyCapability.reject(u);else if(c.opListReadCapability)c.opListReadCapability.reject(u);else throw u}})};d()}_abortOperatorList({intentState:e,reason:t,force:n=!1}){if(e.streamReader){if(e.streamReaderCancelTimeout&&(clearTimeout(e.streamReaderCancelTimeout),e.streamReaderCancelTimeout=null),!n){if(e.renderTasks.size>0)return;if(t instanceof yg){let i=ute;t.extraDelay>0&&t.extraDelay<1e3&&(i+=t.extraDelay),e.streamReaderCancelTimeout=setTimeout(()=>{e.streamReaderCancelTimeout=null,this._abortOperatorList({intentState:e,reason:t,force:!0})},i);return}}if(e.streamReader.cancel(new ya(t.message)).catch(()=>{}),e.streamReader=null,!this._transport.destroyed){for(let[i,r]of this._intentStates)if(r===e){this._intentStates.delete(i);break}this.cleanup()}}}get stats(){return this._stats}};dc=new WeakMap,sl=new WeakMap,uc=new WeakSet,ep=function(e=!1){if(K(this,Vp,yM).call(this),!m(this,sl)||this.destroyed)return!1;if(e)return N(this,dc,setTimeout(()=>{N(this,dc,null),K(this,uc,ep).call(this,!1)},hte)),!1;for(let{renderTasks:t,operatorList:n}of this._intentStates.values())if(t.size>0||!n.lastChunk)return!1;return this._intentStates.clear(),this.objs.clear(),N(this,sl,!1),!0},Vp=new WeakSet,yM=function(){m(this,dc)&&(clearTimeout(m(this,dc)),N(this,dc,null))};var il,sE,yk=class{constructor(){L(this,il,new Map);L(this,sE,Promise.resolve())}postMessage(e,t){let n={data:structuredClone(e,t?{transfer:t}:null)};m(this,sE).then(()=>{for(let[i]of m(this,il))i.call(this,n)})}addEventListener(e,t,n=null){let i=null;if(n?.signal instanceof AbortSignal){let{signal:r}=n;if(r.aborted){Jt("LoopbackPort - cannot use an `aborted` signal.");return}let o=()=>this.removeEventListener(e,t);i=()=>r.removeEventListener("abort",o),r.addEventListener("abort",o)}m(this,il).set(t,i)}removeEventListener(e,t){m(this,il).get(t)?.(),m(this,il).delete(t)}terminate(){for(let[,e]of m(this,il))e?.();m(this,il).clear()}};il=new WeakMap,sE=new WeakMap;var iE,nu,su,Gp,vM,Wp,bM,Jn=class Jn{constructor({name:e=null,port:t=null,verbosity:n=Lee()}={}){L(this,Gp);if(this.name=e,this.destroyed=!1,this.verbosity=n,this._readyCapability=Promise.withResolvers(),this._port=null,this._webWorker=null,this._messageHandler=null,t){if(m(Jn,su)?.has(t))throw new Error("Cannot use more than one PDFWorker per port.");(m(Jn,su)||N(Jn,su,new WeakMap)).set(t,this),this._initializeFromPort(t);return}this._initialize()}get promise(){return this._readyCapability.promise}get port(){return this._port}get messageHandler(){return this._messageHandler}_initializeFromPort(e){this._port=e,this._messageHandler=new vd("main","worker",e),this._messageHandler.on("ready",function(){}),K(this,Gp,vM).call(this)}_initialize(){if(m(Jn,nu)||m(Jn,Wp,bM)){this._setupFakeWorker();return}let{workerSrc:e}=Jn;try{Jn._isSameOrigin(window.location.href,e)||(e=Jn._createCDNWrapper(new URL(e,window.location).href));let t=new Worker(e,{type:"module"}),n=new vd("main","worker",t),i=()=>{r.abort(),n.destroy(),t.terminate(),this.destroyed?this._readyCapability.reject(new Error("Worker was destroyed")):this._setupFakeWorker()},r=new AbortController;t.addEventListener("error",()=>{this._webWorker||i()},{signal:r.signal}),n.on("test",a=>{if(r.abort(),this.destroyed||!a){i();return}this._messageHandler=n,this._port=t,this._webWorker=t,K(this,Gp,vM).call(this)}),n.on("ready",a=>{if(r.abort(),this.destroyed){i();return}try{o()}catch{this._setupFakeWorker()}});let o=()=>{let a=new Uint8Array;n.send("test",a,[a.buffer])};o();return}catch{JE("The worker has been disabled.")}this._setupFakeWorker()}_setupFakeWorker(){m(Jn,nu)||(Jt("Setting up fake worker."),N(Jn,nu,!0)),Jn._setupFakeWorkerGlobal.then(e=>{if(this.destroyed){this._readyCapability.reject(new Error("Worker was destroyed"));return}let t=new yk;this._port=t;let n=`fake${Ii(Jn,iE)._++}`,i=new vd(n+"_worker",n,t);e.setup(i,t),this._messageHandler=new vd(n,n+"_worker",t),K(this,Gp,vM).call(this)}).catch(e=>{this._readyCapability.reject(new Error(`Setting up fake worker failed: "${e.message}".`))})}destroy(){this.destroyed=!0,this._webWorker?.terminate(),this._webWorker=null,m(Jn,su)?.delete(this._port),this._port=null,this._messageHandler?.destroy(),this._messageHandler=null}static fromPort(e){if(!e?.port)throw new Error("PDFWorker.fromPort - invalid method signature.");let t=m(this,su)?.get(e.port);if(t){if(t._pendingDestroy)throw new Error("PDFWorker.fromPort - the worker is being destroyed.\nPlease remember to await `PDFDocumentLoadingTask.destroy()`-calls.");return t}return new Jn(e)}static get workerSrc(){if(xo.workerSrc)return xo.workerSrc;throw new Error('No "GlobalWorkerOptions.workerSrc" specified.')}static get _setupFakeWorkerGlobal(){return an(this,"_setupFakeWorkerGlobal",(async()=>m(this,Wp,bM)?m(this,Wp,bM):(await import(this.workerSrc)).WorkerMessageHandler)())}};iE=new WeakMap,nu=new WeakMap,su=new WeakMap,Gp=new WeakSet,vM=function(){this._readyCapability.resolve(),this._messageHandler.send("configure",{verbosity:this.verbosity})},Wp=new WeakSet,bM=function(){try{return globalThis.pdfjsWorker?.WorkerMessageHandler||null}catch{return null}},L(Jn,Wp),L(Jn,iE,0),L(Jn,nu,!1),L(Jn,su,void 0),xi&&(N(Jn,nu,!0),xo.workerSrc||(xo.workerSrc="./pdf.worker.mjs")),Jn._isSameOrigin=(e,t)=>{let n;try{if(n=new URL(e),!n.origin||n.origin==="null")return!1}catch{return!1}let i=new URL(t,n);return n.origin===i.origin},Jn._createCDNWrapper=e=>{let t=`await import("${e}");`;return URL.createObjectURL(new Blob([t],{type:"text/javascript"}))};var op=Jn,rl,ca,Hp,jp,ol,iu,rg,vk=class{constructor(e,t,n,i,r){L(this,iu);L(this,rl,new Map);L(this,ca,new Map);L(this,Hp,new Map);L(this,jp,new Map);L(this,ol,null);this.messageHandler=e,this.loadingTask=t,this.commonObjs=new JM,this.fontLoader=new DP({ownerDocument:i.ownerDocument,styleElement:i.styleElement}),this.loadingParams=i.loadingParams,this._params=i,this.canvasFactory=r.canvasFactory,this.filterFactory=r.filterFactory,this.cMapReaderFactory=r.cMapReaderFactory,this.standardFontDataFactory=r.standardFontDataFactory,this.destroyed=!1,this.destroyCapability=null,this._networkStream=n,this._fullReader=null,this._lastProgress=null,this.downloadInfoCapability=Promise.withResolvers(),this.setupMessageHandler()}get annotationStorage(){return an(this,"annotationStorage",new bg)}getRenderingIntent(e,t=Wl.ENABLE,n=null,i=!1,r=!1){let o=yr.DISPLAY,a=IP;switch(e){case"any":o=yr.ANY;break;case"display":break;case"print":o=yr.PRINT;break;default:Jt(`getRenderingIntent - invalid intent: ${e}`)}let l=o&yr.PRINT&&n instanceof VM?n:this.annotationStorage;switch(t){case Wl.DISABLE:o+=yr.ANNOTATIONS_DISABLE;break;case Wl.ENABLE:break;case Wl.ENABLE_FORMS:o+=yr.ANNOTATIONS_FORMS;break;case Wl.ENABLE_STORAGE:o+=yr.ANNOTATIONS_STORAGE,a=l.serializable;break;default:Jt(`getRenderingIntent - invalid annotationMode: ${t}`)}i&&(o+=yr.IS_EDITING),r&&(o+=yr.OPLIST);let{ids:c,hash:d}=l.modifiedIds,u=[o,a.hash,d];return{renderingIntent:o,cacheKey:u.join("_"),annotationStorageSerializable:a,modifiedIds:c}}destroy(){if(this.destroyCapability)return this.destroyCapability.promise;this.destroyed=!0,this.destroyCapability=Promise.withResolvers(),m(this,ol)?.reject(new Error("Worker was destroyed during onPassword callback"));let e=[];for(let n of m(this,ca).values())e.push(n._destroy());m(this,ca).clear(),m(this,Hp).clear(),m(this,jp).clear(),this.hasOwnProperty("annotationStorage")&&this.annotationStorage.resetModified();let t=this.messageHandler.sendWithPromise("Terminate",null);return e.push(t),Promise.all(e).then(()=>{this.commonObjs.clear(),this.fontLoader.clear(),m(this,rl).clear(),this.filterFactory.destroy(),Mg.cleanup(),this._networkStream?.cancelAllRequests(new ya("Worker was terminated.")),this.messageHandler?.destroy(),this.messageHandler=null,this.destroyCapability.resolve()},this.destroyCapability.reject),this.destroyCapability.promise}setupMessageHandler(){let{messageHandler:e,loadingTask:t}=this;e.on("GetReader",(n,i)=>{Ds(this._networkStream,"GetReader - no `IPDFStream` instance available."),this._fullReader=this._networkStream.getFullReader(),this._fullReader.onProgress=r=>{this._lastProgress={loaded:r.loaded,total:r.total}},i.onPull=()=>{this._fullReader.read().then(function({value:r,done:o}){if(o){i.close();return}Ds(r instanceof ArrayBuffer,"GetReader - expected an ArrayBuffer."),i.enqueue(new Uint8Array(r),1,[r])}).catch(r=>{i.error(r)})},i.onCancel=r=>{this._fullReader.cancel(r),i.ready.catch(o=>{if(!this.destroyed)throw o})}}),e.on("ReaderHeadersReady",async n=>{await this._fullReader.headersReady;let{isStreamingSupported:i,isRangeSupported:r,contentLength:o}=this._fullReader;return(!i||!r)&&(this._lastProgress&&t.onProgress?.(this._lastProgress),this._fullReader.onProgress=a=>{t.onProgress?.({loaded:a.loaded,total:a.total})}),{isStreamingSupported:i,isRangeSupported:r,contentLength:o}}),e.on("GetRangeReader",(n,i)=>{Ds(this._networkStream,"GetRangeReader - no `IPDFStream` instance available.");let r=this._networkStream.getRangeReader(n.begin,n.end);if(!r){i.close();return}i.onPull=()=>{r.read().then(function({value:o,done:a}){if(a){i.close();return}Ds(o instanceof ArrayBuffer,"GetRangeReader - expected an ArrayBuffer."),i.enqueue(new Uint8Array(o),1,[o])}).catch(o=>{i.error(o)})},i.onCancel=o=>{r.cancel(o),i.ready.catch(a=>{if(!this.destroyed)throw a})}}),e.on("GetDoc",({pdfInfo:n})=>{this._numPages=n.numPages,this._htmlForXfa=n.htmlForXfa,delete n.htmlForXfa,t._capability.resolve(new gk(n,this))}),e.on("DocException",n=>{t._capability.reject(ji(n))}),e.on("PasswordRequest",n=>{N(this,ol,Promise.withResolvers());try{if(!t.onPassword)throw ji(n);let i=r=>{r instanceof Error?m(this,ol).reject(r):m(this,ol).resolve({password:r})};t.onPassword(i,n.code)}catch(i){m(this,ol).reject(i)}return m(this,ol).promise}),e.on("DataLoaded",n=>{t.onProgress?.({loaded:n.length,total:n.length}),this.downloadInfoCapability.resolve(n)}),e.on("StartRenderPage",n=>{if(this.destroyed)return;m(this,ca).get(n.pageIndex)._startRenderPage(n.transparency,n.cacheKey)}),e.on("commonobj",([n,i,r])=>{if(this.destroyed||this.commonObjs.has(n))return null;switch(i){case"Font":let{disableFontFace:o,fontExtraProperties:a,pdfBug:l}=this._params;if("error"in r){let h=r.error;Jt(`Error during font loading: ${h}`),this.commonObjs.resolve(n,h);break}let c=l&&globalThis.FontInspector?.enabled?(h,p)=>globalThis.FontInspector.fontAdded(h,p):null,d=new RP(r,{disableFontFace:o,fontExtraProperties:a,inspectFont:c});this.fontLoader.bind(d).catch(()=>e.sendWithPromise("FontFallback",{id:n})).finally(()=>{!a&&d.data&&(d.data=null),this.commonObjs.resolve(n,d)});break;case"CopyLocalImage":let{imageRef:u}=r;Ds(u,"The imageRef must be defined.");for(let h of m(this,ca).values())for(let[,p]of h.objs)if(p?.ref===u)return p.dataLen?(this.commonObjs.resolve(n,structuredClone(p)),p.dataLen):null;break;case"FontPath":case"Image":case"Pattern":this.commonObjs.resolve(n,r);break;default:throw new Error(`Got unknown common object type ${i}`)}return null}),e.on("obj",([n,i,r,o])=>{if(this.destroyed)return;let a=m(this,ca).get(i);if(!a.objs.has(n)){if(a._intentStates.size===0){o?.bitmap?.close();return}switch(r){case"Image":a.objs.resolve(n,o),o?.dataLen>Pee&&(a._maybeCleanupAfterRender=!0);break;case"Pattern":a.objs.resolve(n,o);break;default:throw new Error(`Got unknown object type ${r}`)}}}),e.on("DocProgress",n=>{this.destroyed||t.onProgress?.({loaded:n.loaded,total:n.total})}),e.on("FetchBuiltInCMap",async n=>{if(this.destroyed)throw new Error("Worker was destroyed.");if(!this.cMapReaderFactory)throw new Error("CMapReaderFactory not initialized, see the `useWorkerFetch` parameter.");return this.cMapReaderFactory.fetch(n)}),e.on("FetchStandardFontData",async n=>{if(this.destroyed)throw new Error("Worker was destroyed.");if(!this.standardFontDataFactory)throw new Error("StandardFontDataFactory not initialized, see the `useWorkerFetch` parameter.");return this.standardFontDataFactory.fetch(n)})}getData(){return this.messageHandler.sendWithPromise("GetData",null)}saveDocument(){this.annotationStorage.size<=0&&Jt("saveDocument called while `annotationStorage` is empty, please use the getData-method instead.");let{map:e,transfer:t}=this.annotationStorage.serializable;return this.messageHandler.sendWithPromise("SaveDocument",{isPureXfa:!!this._htmlForXfa,numPages:this._numPages,annotationStorage:e,filename:this._fullReader?.filename??null},t).finally(()=>{this.annotationStorage.resetModified()})}getPage(e){if(!Number.isInteger(e)||e<=0||e>this._numPages)return Promise.reject(new Error("Invalid page request."));let t=e-1,n=m(this,Hp).get(t);if(n)return n;let i=this.messageHandler.sendWithPromise("GetPage",{pageIndex:t}).then(r=>{if(this.destroyed)throw new Error("Transport destroyed");r.refStr&&m(this,jp).set(r.refStr,e);let o=new _k(t,r,this,this._params.pdfBug);return m(this,ca).set(t,o),o});return m(this,Hp).set(t,i),i}getPageIndex(e){return g3(e)?this.messageHandler.sendWithPromise("GetPageIndex",{num:e.num,gen:e.gen}):Promise.reject(new Error("Invalid pageIndex request."))}getAnnotations(e,t){return this.messageHandler.sendWithPromise("GetAnnotations",{pageIndex:e,intent:t})}getFieldObjects(){return K(this,iu,rg).call(this,"GetFieldObjects")}hasJSActions(){return K(this,iu,rg).call(this,"HasJSActions")}getCalculationOrderIds(){return this.messageHandler.sendWithPromise("GetCalculationOrderIds",null)}getDestinations(){return this.messageHandler.sendWithPromise("GetDestinations",null)}getDestination(e){return typeof e!="string"?Promise.reject(new Error("Invalid destination request.")):this.messageHandler.sendWithPromise("GetDestination",{id:e})}getPageLabels(){return this.messageHandler.sendWithPromise("GetPageLabels",null)}getPageLayout(){return this.messageHandler.sendWithPromise("GetPageLayout",null)}getPageMode(){return this.messageHandler.sendWithPromise("GetPageMode",null)}getViewerPreferences(){return this.messageHandler.sendWithPromise("GetViewerPreferences",null)}getOpenAction(){return this.messageHandler.sendWithPromise("GetOpenAction",null)}getAttachments(){return this.messageHandler.sendWithPromise("GetAttachments",null)}getDocJSActions(){return K(this,iu,rg).call(this,"GetDocJSActions")}getPageJSActions(e){return this.messageHandler.sendWithPromise("GetPageJSActions",{pageIndex:e})}getStructTree(e){return this.messageHandler.sendWithPromise("GetStructTree",{pageIndex:e})}getOutline(){return this.messageHandler.sendWithPromise("GetOutline",null)}getOptionalContentConfig(e){return K(this,iu,rg).call(this,"GetOptionalContentConfig").then(t=>new ZP(t,e))}getPermissions(){return this.messageHandler.sendWithPromise("GetPermissions",null)}getMetadata(){let e="GetMetadata",t=m(this,rl).get(e);if(t)return t;let n=this.messageHandler.sendWithPromise(e,null).then(i=>({info:i[0],metadata:i[1]?new QP(i[1]):null,contentDispositionFilename:this._fullReader?.filename??null,contentLength:this._fullReader?.contentLength??null}));return m(this,rl).set(e,n),n}getMarkInfo(){return this.messageHandler.sendWithPromise("GetMarkInfo",null)}async startCleanup(e=!1){if(!this.destroyed){await this.messageHandler.sendWithPromise("Cleanup",null);for(let t of m(this,ca).values())if(!t.cleanup())throw new Error(`startCleanup: Page ${t.pageNumber} is currently rendering.`);this.commonObjs.clear(),e||this.fontLoader.clear(),m(this,rl).clear(),this.filterFactory.destroy(!0),Mg.cleanup()}}cachedPageNumber(e){if(!g3(e))return null;let t=e.gen===0?`${e.num}R`:`${e.num}R${e.gen}`;return m(this,jp).get(t)??null}};rl=new WeakMap,ca=new WeakMap,Hp=new WeakMap,jp=new WeakMap,ol=new WeakMap,iu=new WeakSet,rg=function(e,t=null){let n=m(this,rl).get(e);if(n)return n;let i=this.messageHandler.sendWithPromise(e,t);return m(this,rl).set(e,i),i};var Ym=Symbol("INITIAL_DATA"),cr,z_,bk,JM=class{constructor(){L(this,z_);L(this,cr,Object.create(null))}get(e,t=null){if(t){let i=K(this,z_,bk).call(this,e);return i.promise.then(()=>t(i.data)),null}let n=m(this,cr)[e];if(!n||n.data===Ym)throw new Error(`Requesting object that isn't resolved yet ${e}.`);return n.data}has(e){let t=m(this,cr)[e];return!!t&&t.data!==Ym}delete(e){let t=m(this,cr)[e];return!t||t.data===Ym?!1:(delete m(this,cr)[e],!0)}resolve(e,t=null){let n=K(this,z_,bk).call(this,e);n.data=t,n.resolve()}clear(){for(let e in m(this,cr)){let{data:t}=m(this,cr)[e];t?.bitmap?.close()}N(this,cr,Object.create(null))}*[Symbol.iterator](){for(let e in m(this,cr)){let{data:t}=m(this,cr)[e];t!==Ym&&(yield[e,t])}}};cr=new WeakMap,z_=new WeakSet,bk=function(e){var t;return(t=m(this,cr))[e]||(t[e]={...Promise.withResolvers(),data:Ym})};var hc,wk=class{constructor(e){L(this,hc,null);N(this,hc,e),this.onContinue=null}get promise(){return m(this,hc).capability.promise}cancel(e=0){m(this,hc).cancel(null,e)}get separateAnnots(){let{separateAnnots:e}=m(this,hc).operatorList;if(!e)return!1;let{annotationCanvasMap:t}=m(this,hc);return e.form||e.canvas&&t?.size>0}};hc=new WeakMap;var pc,ru,yd=class yd{constructor({callback:e,params:t,objs:n,commonObjs:i,annotationCanvasMap:r,operatorList:o,pageIndex:a,canvasFactory:l,filterFactory:c,useRequestAnimationFrame:d=!1,pdfBug:u=!1,pageColors:h=null}){L(this,pc,null);this.callback=e,this.params=t,this.objs=n,this.commonObjs=i,this.annotationCanvasMap=r,this.operatorListIdx=null,this.operatorList=o,this._pageIndex=a,this.canvasFactory=l,this.filterFactory=c,this._pdfBug=u,this.pageColors=h,this.running=!1,this.graphicsReadyCallback=null,this.graphicsReady=!1,this._useRequestAnimationFrame=d===!0&&typeof window<"u",this.cancelled=!1,this.capability=Promise.withResolvers(),this.task=new wk(this),this._cancelBound=this.cancel.bind(this),this._continueBound=this._continue.bind(this),this._scheduleNextBound=this._scheduleNext.bind(this),this._nextBound=this._next.bind(this),this._canvas=t.canvasContext.canvas}get completed(){return this.capability.promise.catch(function(){})}initializeGraphics({transparency:e=!1,optionalContentConfig:t}){if(this.cancelled)return;if(this._canvas){if(m(yd,ru).has(this._canvas))throw new Error("Cannot use the same canvas during multiple render() operations. Use different canvas or ensure previous operations were cancelled or completed.");m(yd,ru).add(this._canvas)}this._pdfBug&&globalThis.StepperManager?.enabled&&(this.stepper=globalThis.StepperManager.create(this._pageIndex),this.stepper.init(this.operatorList),this.stepper.nextBreakPoint=this.stepper.getNextBreakPoint());let{canvasContext:n,viewport:i,transform:r,background:o}=this.params;this.gfx=new rp(n,this.commonObjs,this.objs,this.canvasFactory,this.filterFactory,{optionalContentConfig:t},this.annotationCanvasMap,this.pageColors),this.gfx.beginDrawing({transform:r,viewport:i,transparency:e,background:o}),this.operatorListIdx=0,this.graphicsReady=!0,this.graphicsReadyCallback?.()}cancel(e=null,t=0){this.running=!1,this.cancelled=!0,this.gfx?.endDrawing(),m(this,pc)&&(window.cancelAnimationFrame(m(this,pc)),N(this,pc,null)),m(yd,ru).delete(this._canvas),this.callback(e||new yg(`Rendering cancelled, page ${this._pageIndex+1}`,t))}operatorListChanged(){if(!this.graphicsReady){this.graphicsReadyCallback||(this.graphicsReadyCallback=this._continueBound);return}this.stepper?.updateOperatorList(this.operatorList),!this.running&&this._continue()}_continue(){this.running=!0,!this.cancelled&&(this.task.onContinue?this.task.onContinue(this._scheduleNextBound):this._scheduleNext())}_scheduleNext(){this._useRequestAnimationFrame?N(this,pc,window.requestAnimationFrame(()=>{N(this,pc,null),this._nextBound().catch(this._cancelBound)})):Promise.resolve().then(this._nextBound).catch(this._cancelBound)}async _next(){this.cancelled||(this.operatorListIdx=this.gfx.executeOperatorList(this.operatorList,this.operatorListIdx,this._continueBound,this.stepper),this.operatorListIdx===this.operatorList.argsArray.length&&(this.running=!1,this.operatorList.lastChunk&&(this.gfx.endDrawing(),m(yd,ru).delete(this._canvas),this.callback())))}};pc=new WeakMap,ru=new WeakMap,L(yd,ru,new WeakSet);var Mk=yd,bte="4.10.38",wte="f9bea397f";function _3(s){return Math.floor(Math.max(0,Math.min(1,s))*255).toString(16).padStart(2,"0")}function Xm(s){return Math.max(0,Math.min(255,255*s))}var ZM=class{static CMYK_G([e,t,n,i]){return["G",1-Math.min(1,.3*e+.59*n+.11*t+i)]}static G_CMYK([e]){return["CMYK",0,0,0,1-e]}static G_RGB([e]){return["RGB",e,e,e]}static G_rgb([e]){return e=Xm(e),[e,e,e]}static G_HTML([e]){let t=_3(e);return`#${t}${t}${t}`}static RGB_G([e,t,n]){return["G",.3*e+.59*t+.11*n]}static RGB_rgb(e){return e.map(Xm)}static RGB_HTML(e){return`#${e.map(_3).join("")}`}static T_HTML(){return"#00000000"}static T_rgb(){return[null]}static CMYK_RGB([e,t,n,i]){return["RGB",1-Math.min(1,e+i),1-Math.min(1,n+i),1-Math.min(1,t+i)]}static CMYK_rgb([e,t,n,i]){return[Xm(1-Math.min(1,e+i)),Xm(1-Math.min(1,n+i)),Xm(1-Math.min(1,t+i))]}static CMYK_HTML(e){let t=this.CMYK_RGB(e).slice(1);return this.RGB_HTML(t)}static RGB_CMYK([e,t,n]){let i=1-e,r=1-t,o=1-n,a=Math.min(i,r,o);return["CMYK",i,r,o,a]}},Tk=class{create(e,t,n=!1){if(e<=0||t<=0)throw new Error("Invalid SVG dimensions");let i=this._createSVG("svg:svg");return i.setAttribute("version","1.1"),n||(i.setAttribute("width",`${e}px`),i.setAttribute("height",`${t}px`)),i.setAttribute("preserveAspectRatio","none"),i.setAttribute("viewBox",`0 0 ${e} ${t}`),i}createElement(e){if(typeof e!="string")throw new Error("Invalid SVG element type");return this._createSVG(e)}_createSVG(e){zn("Abstract method `_createSVG` called.")}},Eg=class extends Tk{_createSVG(e){return document.createElementNS(Va,e)}},eT=class{static setupStorage(e,t,n,i,r){let o=i.getValue(t,{value:null});switch(n.name){case"textarea":if(o.value!==null&&(e.textContent=o.value),r==="print")break;e.addEventListener("input",a=>{i.setValue(t,{value:a.target.value})});break;case"input":if(n.attributes.type==="radio"||n.attributes.type==="checkbox"){if(o.value===n.attributes.xfaOn?e.setAttribute("checked",!0):o.value===n.attributes.xfaOff&&e.removeAttribute("checked"),r==="print")break;e.addEventListener("change",a=>{i.setValue(t,{value:a.target.checked?a.target.getAttribute("xfaOn"):a.target.getAttribute("xfaOff")})})}else{if(o.value!==null&&e.setAttribute("value",o.value),r==="print")break;e.addEventListener("input",a=>{i.setValue(t,{value:a.target.value})})}break;case"select":if(o.value!==null){e.setAttribute("value",o.value);for(let a of n.children)a.attributes.value===o.value?a.attributes.selected=!0:a.attributes.hasOwnProperty("selected")&&delete a.attributes.selected}e.addEventListener("input",a=>{let l=a.target.options,c=l.selectedIndex===-1?"":l[l.selectedIndex].value;i.setValue(t,{value:c})});break}}static setAttributes({html:e,element:t,storage:n=null,intent:i,linkService:r}){let{attributes:o}=t,a=e instanceof HTMLAnchorElement;o.type==="radio"&&(o.name=`${o.name}-${i}`);for(let[l,c]of Object.entries(o))if(c!=null)switch(l){case"class":c.length&&e.setAttribute(l,c.join(" "));break;case"dataId":break;case"id":e.setAttribute("data-element-id",c);break;case"style":Object.assign(e.style,c);break;case"textContent":e.textContent=c;break;default:(!a||l!=="href"&&l!=="newWindow")&&e.setAttribute(l,c)}a&&r.addLinkAttributes(e,o.href,o.newWindow),n&&o.dataId&&this.setupStorage(e,o.dataId,t,n)}static render(e){let t=e.annotationStorage,n=e.linkService,i=e.xfaHtml,r=e.intent||"display",o=document.createElement(i.name);i.attributes&&this.setAttributes({html:o,element:i,intent:r,linkService:n});let a=r!=="richText",l=e.div;if(l.append(o),e.viewport){let u=`matrix(${e.viewport.transform.join(",")})`;l.style.transform=u}a&&l.setAttribute("class","xfaLayer xfaFont");let c=[];if(i.children.length===0){if(i.value){let u=document.createTextNode(i.value);o.append(u),a&&Tg.shouldBuildText(i.name)&&c.push(u)}return{textDivs:c}}let d=[[i,-1,o]];for(;d.length>0;){let[u,h,p]=d.at(-1);if(h+1===u.children.length){d.pop();continue}let f=u.children[++d.at(-1)[1]];if(f===null)continue;let{name:_}=f;if(_==="#text"){let y=document.createTextNode(f.value);c.push(y),p.append(y);continue}let b=f?.attributes?.xmlns?document.createElementNS(f.attributes.xmlns,_):document.createElement(_);if(p.append(b),f.attributes&&this.setAttributes({html:b,element:f,storage:t,intent:r,linkService:n}),f.children?.length>0)d.push([f,-1,b]);else if(f.value){let y=document.createTextNode(f.value);a&&Tg.shouldBuildText(_)&&c.push(y),b.append(y)}}for(let u of l.querySelectorAll(".xfaNonInteractive input, .xfaNonInteractive textarea"))u.setAttribute("readOnly",!0);return{textDivs:c}}static update(e){let t=`matrix(${e.viewport.transform.join(",")})`;e.div.style.transform=t,e.div.hidden=!1}},Uy=1e3,Mte=9,Uu=new WeakSet;function Cc(s){return{width:s[2]-s[0],height:s[3]-s[1]}}var Ek=class{static create(e){switch(e.data.annotationType){case Bs.LINK:return new tT(e);case Bs.TEXT:return new Sk(e);case Bs.WIDGET:switch(e.data.fieldType){case"Tx":return new Ck(e);case"Btn":return e.data.radioButton?new nT(e):e.data.checkBox?new Pk(e):new kk(e);case"Ch":return new Ik(e);case"Sig":return new Ak(e)}return new wl(e);case Bs.POPUP:return new xg(e);case Bs.FREETEXT:return new sT(e);case Bs.LINE:return new Lk(e);case Bs.SQUARE:return new Nk(e);case Bs.CIRCLE:return new Ok(e);case Bs.POLYLINE:return new iT(e);case Bs.CARET:return new Bk(e);case Bs.INK:return new Sg(e);case Bs.POLYGON:return new $k(e);case Bs.HIGHLIGHT:return new rT(e);case Bs.UNDERLINE:return new Uk(e);case Bs.SQUIGGLY:return new Vk(e);case Bs.STRIKEOUT:return new Gk(e);case Bs.STAMP:return new oT(e);case Bs.FILEATTACHMENT:return new Wk(e);default:return new Es(e)}}},ou,qp,Kp,U_,xk,AI=class AI{constructor(e,{isRenderable:t=!1,ignoreBorder:n=!1,createQuadrilaterals:i=!1}={}){L(this,U_);L(this,ou,null);L(this,qp,!1);L(this,Kp,null);this.isRenderable=t,this.data=e.data,this.layer=e.layer,this.linkService=e.linkService,this.downloadManager=e.downloadManager,this.imageResourcesPath=e.imageResourcesPath,this.renderForms=e.renderForms,this.svgFactory=e.svgFactory,this.annotationStorage=e.annotationStorage,this.enableScripting=e.enableScripting,this.hasJSActions=e.hasJSActions,this._fieldObjects=e.fieldObjects,this.parent=e.parent,t&&(this.container=this._createContainer(n)),i&&this._createQuadrilaterals()}static _hasPopupData({titleObj:e,contentsObj:t,richText:n}){return!!(e?.str||t?.str||n?.str)}get _isEditable(){return this.data.isEditable}get hasPopupData(){return AI._hasPopupData(this.data)}updateEdited(e){if(!this.container)return;m(this,ou)||N(this,ou,{rect:this.data.rect.slice(0)});let{rect:t}=e;t&&K(this,U_,xk).call(this,t),m(this,Kp)?.popup.updateEdited(e)}resetEdited(){m(this,ou)&&(K(this,U_,xk).call(this,m(this,ou).rect),m(this,Kp)?.popup.resetEdited(),N(this,ou,null))}_createContainer(e){let{data:t,parent:{page:n,viewport:i}}=this,r=document.createElement("section");r.setAttribute("data-annotation-id",t.id),this instanceof wl||(r.tabIndex=Uy);let{style:o}=r;if(o.zIndex=this.parent.zIndex++,t.alternativeText&&(r.title=t.alternativeText),t.noRotate&&r.classList.add("norotate"),!t.rect||this instanceof xg){let{rotation:_}=t;return!t.hasOwnCanvas&&_!==0&&this.setRotation(_,r),r}let{width:a,height:l}=Cc(t.rect);if(!e&&t.borderStyle.width>0){o.borderWidth=`${t.borderStyle.width}px`;let _=t.borderStyle.horizontalCornerRadius,b=t.borderStyle.verticalCornerRadius;if(_>0||b>0){let w=`calc(${_}px * var(--scale-factor)) / calc(${b}px * var(--scale-factor))`;o.borderRadius=w}else if(this instanceof nT){let w=`calc(${a}px * var(--scale-factor)) / calc(${l}px * var(--scale-factor))`;o.borderRadius=w}switch(t.borderStyle.style){case qm.SOLID:o.borderStyle="solid";break;case qm.DASHED:o.borderStyle="dashed";break;case qm.BEVELED:Jt("Unimplemented border style: beveled");break;case qm.INSET:Jt("Unimplemented border style: inset");break;case qm.UNDERLINE:o.borderBottomStyle="solid";break;default:break}let y=t.borderColor||null;y?(N(this,qp,!0),o.borderColor=At.makeHexColor(y[0]|0,y[1]|0,y[2]|0)):o.borderWidth=0}let c=At.normalizeRect([t.rect[0],n.view[3]-t.rect[1]+n.view[1],t.rect[2],n.view[3]-t.rect[3]+n.view[1]]),{pageWidth:d,pageHeight:u,pageX:h,pageY:p}=i.rawDims;o.left=`${100*(c[0]-h)/d}%`,o.top=`${100*(c[1]-p)/u}%`;let{rotation:f}=t;return t.hasOwnCanvas||f===0?(o.width=`${100*a/d}%`,o.height=`${100*l/u}%`):this.setRotation(f,r),r}setRotation(e,t=this.container){if(!this.data.rect)return;let{pageWidth:n,pageHeight:i}=this.parent.viewport.rawDims,{width:r,height:o}=Cc(this.data.rect),a,l;e%180===0?(a=100*r/n,l=100*o/i):(a=100*o/n,l=100*r/i),t.style.width=`${a}%`,t.style.height=`${l}%`,t.setAttribute("data-main-rotation",(360-e)%360)}get _commonActions(){let e=(t,n,i)=>{let r=i.detail[t],o=r[0],a=r.slice(1);i.target.style[n]=ZM[`${o}_HTML`](a),this.annotationStorage.setValue(this.data.id,{[n]:ZM[`${o}_rgb`](a)})};return an(this,"_commonActions",{display:t=>{let{display:n}=t.detail,i=n%2===1;this.container.style.visibility=i?"hidden":"visible",this.annotationStorage.setValue(this.data.id,{noView:i,noPrint:n===1||n===2})},print:t=>{this.annotationStorage.setValue(this.data.id,{noPrint:!t.detail.print})},hidden:t=>{let{hidden:n}=t.detail;this.container.style.visibility=n?"hidden":"visible",this.annotationStorage.setValue(this.data.id,{noPrint:n,noView:n})},focus:t=>{setTimeout(()=>t.target.focus({preventScroll:!1}),0)},userName:t=>{t.target.title=t.detail.userName},readonly:t=>{t.target.disabled=t.detail.readonly},required:t=>{this._setRequired(t.target,t.detail.required)},bgColor:t=>{e("bgColor","backgroundColor",t)},fillColor:t=>{e("fillColor","backgroundColor",t)},fgColor:t=>{e("fgColor","color",t)},textColor:t=>{e("textColor","color",t)},borderColor:t=>{e("borderColor","borderColor",t)},strokeColor:t=>{e("strokeColor","borderColor",t)},rotation:t=>{let n=t.detail.rotation;this.setRotation(n),this.annotationStorage.setValue(this.data.id,{rotation:n})}})}_dispatchEventFromSandbox(e,t){let n=this._commonActions;for(let i of Object.keys(t.detail))(e[i]||n[i])?.(t)}_setDefaultPropertiesFromJS(e){if(!this.enableScripting)return;let t=this.annotationStorage.getRawValue(this.data.id);if(!t)return;let n=this._commonActions;for(let[i,r]of Object.entries(t)){let o=n[i];if(o){let a={detail:{[i]:r},target:e};o(a),delete t[i]}}}_createQuadrilaterals(){if(!this.container)return;let{quadPoints:e}=this.data;if(!e)return;let[t,n,i,r]=this.data.rect.map(_=>Math.fround(_));if(e.length===8){let[_,b,y,w]=e.subarray(2,6);if(i===_&&r===b&&t===y&&n===w)return}let{style:o}=this.container,a;if(m(this,qp)){let{borderColor:_,borderWidth:b}=o;o.borderWidth=0,a=["url('data:image/svg+xml;utf8,",'<svg xmlns="http://www.w3.org/2000/svg"',' preserveAspectRatio="none" viewBox="0 0 1 1">',`<g fill="transparent" stroke="${_}" stroke-width="${b}">`],this.container.classList.add("hasBorder")}let l=i-t,c=r-n,{svgFactory:d}=this,u=d.createElement("svg");u.classList.add("quadrilateralsContainer"),u.setAttribute("width",0),u.setAttribute("height",0);let h=d.createElement("defs");u.append(h);let p=d.createElement("clipPath"),f=`clippath_${this.data.id}`;p.setAttribute("id",f),p.setAttribute("clipPathUnits","objectBoundingBox"),h.append(p);for(let _=2,b=e.length;_<b;_+=8){let y=e[_],w=e[_+1],C=e[_+2],M=e[_+3],S=d.createElement("rect"),k=(C-t)/l,T=(r-w)/c,P=(y-C)/l,R=(w-M)/c;S.setAttribute("x",k),S.setAttribute("y",T),S.setAttribute("width",P),S.setAttribute("height",R),p.append(S),a?.push(`<rect vector-effect="non-scaling-stroke" x="${k}" y="${T}" width="${P}" height="${R}"/>`)}m(this,qp)&&(a.push("</g></svg>')"),o.backgroundImage=a.join("")),this.container.append(u),this.container.style.clipPath=`url(#${f})`}_createPopup(){let{data:e}=this,t=N(this,Kp,new xg({data:{color:e.color,titleObj:e.titleObj,modificationDate:e.modificationDate,contentsObj:e.contentsObj,richText:e.richText,parentRect:e.rect,borderStyle:0,id:`popup_${e.id}`,rotation:e.rotation},parent:this.parent,elements:[this]}));this.parent.div.append(t.render())}render(){zn("Abstract method `AnnotationElement.render` called")}_getElementsByName(e,t=null){let n=[];if(this._fieldObjects){let i=this._fieldObjects[e];if(i)for(let{page:r,id:o,exportValues:a}of i){if(r===-1||o===t)continue;let l=typeof a=="string"?a:null,c=document.querySelector(`[data-element-id="${o}"]`);if(c&&!Uu.has(c)){Jt(`_getElementsByName - element not allowed: ${o}`);continue}n.push({id:o,exportValue:l,domElement:c})}return n}for(let i of document.getElementsByName(e)){let{exportValue:r}=i,o=i.getAttribute("data-element-id");o!==t&&Uu.has(i)&&n.push({id:o,exportValue:r,domElement:i})}return n}show(){this.container&&(this.container.hidden=!1),this.popup?.maybeShow()}hide(){this.container&&(this.container.hidden=!0),this.popup?.forceHide()}getElementsToTriggerPopup(){return this.container}addHighlightArea(){let e=this.getElementsToTriggerPopup();if(Array.isArray(e))for(let t of e)t.classList.add("highlightArea");else e.classList.add("highlightArea")}_editOnDoubleClick(){if(!this._isEditable)return;let{annotationEditorType:e,data:{id:t}}=this;this.container.addEventListener("dblclick",()=>{this.linkService.eventBus?.dispatch("switchannotationeditormode",{source:this,mode:e,editId:t})})}};ou=new WeakMap,qp=new WeakMap,Kp=new WeakMap,U_=new WeakSet,xk=function(e){let{container:{style:t},data:{rect:n,rotation:i},parent:{viewport:{rawDims:{pageWidth:r,pageHeight:o,pageX:a,pageY:l}}}}=this;n?.splice(0,4,...e);let{width:c,height:d}=Cc(e);t.left=`${100*(e[0]-a)/r}%`,t.top=`${100*(o-e[3]+l)/o}%`,i===0?(t.width=`${100*c/r}%`,t.height=`${100*d/o}%`):this.setRotation(i)};var Es=AI,al,fd,rE,uV,oE,hV,tT=class extends Es{constructor(t,n=null){super(t,{isRenderable:!0,ignoreBorder:!!n?.ignoreBorder,createQuadrilaterals:!0});L(this,al);L(this,rE);L(this,oE);this.isTooltipOnly=t.data.isTooltipOnly}render(){let{data:t,linkService:n}=this,i=document.createElement("a");i.setAttribute("data-element-id",t.id);let r=!1;return t.url?(n.addLinkAttributes(i,t.url,t.newWindow),r=!0):t.action?(this._bindNamedAction(i,t.action),r=!0):t.attachment?(K(this,rE,uV).call(this,i,t.attachment,t.attachmentDest),r=!0):t.setOCGState?(K(this,oE,hV).call(this,i,t.setOCGState),r=!0):t.dest?(this._bindLink(i,t.dest),r=!0):(t.actions&&(t.actions.Action||t.actions["Mouse Up"]||t.actions["Mouse Down"])&&this.enableScripting&&this.hasJSActions&&(this._bindJSAction(i,t),r=!0),t.resetForm?(this._bindResetFormAction(i,t.resetForm),r=!0):this.isTooltipOnly&&!r&&(this._bindLink(i,""),r=!0)),this.container.classList.add("linkAnnotation"),r&&this.container.append(i),this.container}_bindLink(t,n){t.href=this.linkService.getDestinationHash(n),t.onclick=()=>(n&&this.linkService.goToDestination(n),!1),(n||n==="")&&K(this,al,fd).call(this)}_bindNamedAction(t,n){t.href=this.linkService.getAnchorUrl(""),t.onclick=()=>(this.linkService.executeNamedAction(n),!1),K(this,al,fd).call(this)}_bindJSAction(t,n){t.href=this.linkService.getAnchorUrl("");let i=new Map([["Action","onclick"],["Mouse Up","onmouseup"],["Mouse Down","onmousedown"]]);for(let r of Object.keys(n.actions)){let o=i.get(r);o&&(t[o]=()=>(this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:n.id,name:r}}),!1))}t.onclick||(t.onclick=()=>!1),K(this,al,fd).call(this)}_bindResetFormAction(t,n){let i=t.onclick;if(i||(t.href=this.linkService.getAnchorUrl("")),K(this,al,fd).call(this),!this._fieldObjects){Jt('_bindResetFormAction - "resetForm" action not supported, ensure that the `fieldObjects` parameter is provided.'),i||(t.onclick=()=>!1);return}t.onclick=()=>{i?.();let{fields:r,refs:o,include:a}=n,l=[];if(r.length!==0||o.length!==0){let u=new Set(o);for(let h of r){let p=this._fieldObjects[h]||[];for(let{id:f}of p)u.add(f)}for(let h of Object.values(this._fieldObjects))for(let p of h)u.has(p.id)===a&&l.push(p)}else for(let u of Object.values(this._fieldObjects))l.push(...u);let c=this.annotationStorage,d=[];for(let u of l){let{id:h}=u;switch(d.push(h),u.type){case"text":{let f=u.defaultValue||"";c.setValue(h,{value:f});break}case"checkbox":case"radiobutton":{let f=u.defaultValue===u.exportValues;c.setValue(h,{value:f});break}case"combobox":case"listbox":{let f=u.defaultValue||"";c.setValue(h,{value:f});break}default:continue}let p=document.querySelector(`[data-element-id="${h}"]`);if(p){if(!Uu.has(p)){Jt(`_bindResetFormAction - element not allowed: ${h}`);continue}}else continue;p.dispatchEvent(new Event("resetform"))}return this.enableScripting&&this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:"app",ids:d,name:"ResetForm"}}),!1}}};al=new WeakSet,fd=function(){this.container.setAttribute("data-internal-link","")},rE=new WeakSet,uV=function(t,n,i=null){t.href=this.linkService.getAnchorUrl(""),n.description&&(t.title=n.description),t.onclick=()=>(this.downloadManager?.openOrDownloadData(n.content,n.filename,i),!1),K(this,al,fd).call(this)},oE=new WeakSet,hV=function(t,n){t.href=this.linkService.getAnchorUrl(""),t.onclick=()=>(this.linkService.executeSetOCGState(n),!1),K(this,al,fd).call(this)};var Sk=class extends Es{constructor(e){super(e,{isRenderable:!0})}render(){this.container.classList.add("textAnnotation");let e=document.createElement("img");return e.src=this.imageResourcesPath+"annotation-"+this.data.name.toLowerCase()+".svg",e.setAttribute("data-l10n-id","pdfjs-text-annotation-type"),e.setAttribute("data-l10n-args",JSON.stringify({type:this.data.name})),!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container.append(e),this.container}},wl=class extends Es{render(){return this.container}showElementAndHideCanvas(e){this.data.hasOwnCanvas&&(e.previousSibling?.nodeName==="CANVAS"&&(e.previousSibling.hidden=!0),e.hidden=!1)}_getKeyModifier(e){return ui.platform.isMac?e.metaKey:e.ctrlKey}_setEventListener(e,t,n,i,r){n.includes("mouse")?e.addEventListener(n,o=>{this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:this.data.id,name:i,value:r(o),shift:o.shiftKey,modifier:this._getKeyModifier(o)}})}):e.addEventListener(n,o=>{if(n==="blur"){if(!t.focused||!o.relatedTarget)return;t.focused=!1}else if(n==="focus"){if(t.focused)return;t.focused=!0}r&&this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:this.data.id,name:i,value:r(o)}})})}_setEventListeners(e,t,n,i){for(let[r,o]of n)(o==="Action"||this.data.actions?.[o])&&((o==="Focus"||o==="Blur")&&(t||(t={focused:!1})),this._setEventListener(e,t,r,o,i),o==="Focus"&&!this.data.actions?.Blur?this._setEventListener(e,t,"blur","Blur",null):o==="Blur"&&!this.data.actions?.Focus&&this._setEventListener(e,t,"focus","Focus",null))}_setBackgroundColor(e){let t=this.data.backgroundColor||null;e.style.backgroundColor=t===null?"transparent":At.makeHexColor(t[0],t[1],t[2])}_setTextStyle(e){let t=["left","center","right"],{fontColor:n}=this.data.defaultAppearanceData,i=this.data.defaultAppearanceData.fontSize||Mte,r=e.style,o,a=2,l=c=>Math.round(10*c)/10;if(this.data.multiLine){let c=Math.abs(this.data.rect[3]-this.data.rect[1]-a),d=Math.round(c/(rM*i))||1,u=c/d;o=Math.min(i,l(u/rM))}else{let c=Math.abs(this.data.rect[3]-this.data.rect[1]-a);o=Math.min(i,l(c/rM))}r.fontSize=`calc(${o}px * var(--scale-factor))`,r.color=At.makeHexColor(n[0],n[1],n[2]),this.data.textAlignment!==null&&(r.textAlign=t[this.data.textAlignment])}_setRequired(e,t){t?e.setAttribute("required",!0):e.removeAttribute("required"),e.setAttribute("aria-required",t)}},Ck=class extends wl{constructor(e){let t=e.renderForms||e.data.hasOwnCanvas||!e.data.hasAppearance&&!!e.data.fieldValue;super(e,{isRenderable:t})}setPropertyOnSiblings(e,t,n,i){let r=this.annotationStorage;for(let o of this._getElementsByName(e.name,e.id))o.domElement&&(o.domElement[t]=n),r.setValue(o.id,{[i]:n})}render(){let e=this.annotationStorage,t=this.data.id;this.container.classList.add("textWidgetAnnotation");let n=null;if(this.renderForms){let i=e.getValue(t,{value:this.data.fieldValue}),r=i.value||"",o=e.getValue(t,{charLimit:this.data.maxLen}).charLimit;o&&r.length>o&&(r=r.slice(0,o));let a=i.formattedValue||this.data.textContent?.join(`
`)||null;a&&this.data.comb&&(a=a.replaceAll(/\s+/g,""));let l={userValue:r,formattedValue:a,lastCommittedValue:null,commitKey:1,focused:!1};this.data.multiLine?(n=document.createElement("textarea"),n.textContent=a??r,this.data.doNotScroll&&(n.style.overflowY="hidden")):(n=document.createElement("input"),n.type="text",n.setAttribute("value",a??r),this.data.doNotScroll&&(n.style.overflowX="hidden")),this.data.hasOwnCanvas&&(n.hidden=!0),Uu.add(n),n.setAttribute("data-element-id",t),n.disabled=this.data.readOnly,n.name=this.data.fieldName,n.tabIndex=Uy,this._setRequired(n,this.data.required),o&&(n.maxLength=o),n.addEventListener("input",d=>{e.setValue(t,{value:d.target.value}),this.setPropertyOnSiblings(n,"value",d.target.value,"value"),l.formattedValue=null}),n.addEventListener("resetform",d=>{let u=this.data.defaultFieldValue??"";n.value=l.userValue=u,l.formattedValue=null});let c=d=>{let{formattedValue:u}=l;u!=null&&(d.target.value=u),d.target.scrollLeft=0};if(this.enableScripting&&this.hasJSActions){n.addEventListener("focus",u=>{if(l.focused)return;let{target:h}=u;l.userValue&&(h.value=l.userValue),l.lastCommittedValue=h.value,l.commitKey=1,this.data.actions?.Focus||(l.focused=!0)}),n.addEventListener("updatefromsandbox",u=>{this.showElementAndHideCanvas(u.target);let h={value(p){l.userValue=p.detail.value??"",e.setValue(t,{value:l.userValue.toString()}),p.target.value=l.userValue},formattedValue(p){let{formattedValue:f}=p.detail;l.formattedValue=f,f!=null&&p.target!==document.activeElement&&(p.target.value=f),e.setValue(t,{formattedValue:f})},selRange(p){p.target.setSelectionRange(...p.detail.selRange)},charLimit:p=>{let{charLimit:f}=p.detail,{target:_}=p;if(f===0){_.removeAttribute("maxLength");return}_.setAttribute("maxLength",f);let b=l.userValue;!b||b.length<=f||(b=b.slice(0,f),_.value=l.userValue=b,e.setValue(t,{value:b}),this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:t,name:"Keystroke",value:b,willCommit:!0,commitKey:1,selStart:_.selectionStart,selEnd:_.selectionEnd}}))}};this._dispatchEventFromSandbox(h,u)}),n.addEventListener("keydown",u=>{l.commitKey=1;let h=-1;if(u.key==="Escape"?h=0:u.key==="Enter"&&!this.data.multiLine?h=2:u.key==="Tab"&&(l.commitKey=3),h===-1)return;let{value:p}=u.target;l.lastCommittedValue!==p&&(l.lastCommittedValue=p,l.userValue=p,this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:t,name:"Keystroke",value:p,willCommit:!0,commitKey:h,selStart:u.target.selectionStart,selEnd:u.target.selectionEnd}}))});let d=c;c=null,n.addEventListener("blur",u=>{if(!l.focused||!u.relatedTarget)return;this.data.actions?.Blur||(l.focused=!1);let{value:h}=u.target;l.userValue=h,l.lastCommittedValue!==h&&this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:t,name:"Keystroke",value:h,willCommit:!0,commitKey:l.commitKey,selStart:u.target.selectionStart,selEnd:u.target.selectionEnd}}),d(u)}),this.data.actions?.Keystroke&&n.addEventListener("beforeinput",u=>{l.lastCommittedValue=null;let{data:h,target:p}=u,{value:f,selectionStart:_,selectionEnd:b}=p,y=_,w=b;switch(u.inputType){case"deleteWordBackward":{let C=f.substring(0,_).match(/\w*[^\w]*$/);C&&(y-=C[0].length);break}case"deleteWordForward":{let C=f.substring(_).match(/^[^\w]*\w*/);C&&(w+=C[0].length);break}case"deleteContentBackward":_===b&&(y-=1);break;case"deleteContentForward":_===b&&(w+=1);break}u.preventDefault(),this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:t,name:"Keystroke",value:f,change:h||"",willCommit:!1,selStart:y,selEnd:w}})}),this._setEventListeners(n,l,[["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],u=>u.target.value)}if(c&&n.addEventListener("blur",c),this.data.comb){let u=(this.data.rect[2]-this.data.rect[0])/o;n.classList.add("comb"),n.style.letterSpacing=`calc(${u}px * var(--scale-factor) - 1ch)`}}else n=document.createElement("div"),n.textContent=this.data.fieldValue,n.style.verticalAlign="middle",n.style.display="table-cell",this.data.hasOwnCanvas&&(n.hidden=!0);return this._setTextStyle(n),this._setBackgroundColor(n),this._setDefaultPropertiesFromJS(n),this.container.append(n),this.container}},Ak=class extends wl{constructor(e){super(e,{isRenderable:!!e.data.hasOwnCanvas})}},Pk=class extends wl{constructor(e){super(e,{isRenderable:e.renderForms})}render(){let e=this.annotationStorage,t=this.data,n=t.id,i=e.getValue(n,{value:t.exportValue===t.fieldValue}).value;typeof i=="string"&&(i=i!=="Off",e.setValue(n,{value:i})),this.container.classList.add("buttonWidgetAnnotation","checkBox");let r=document.createElement("input");return Uu.add(r),r.setAttribute("data-element-id",n),r.disabled=t.readOnly,this._setRequired(r,this.data.required),r.type="checkbox",r.name=t.fieldName,i&&r.setAttribute("checked",!0),r.setAttribute("exportValue",t.exportValue),r.tabIndex=Uy,r.addEventListener("change",o=>{let{name:a,checked:l}=o.target;for(let c of this._getElementsByName(a,n)){let d=l&&c.exportValue===t.exportValue;c.domElement&&(c.domElement.checked=d),e.setValue(c.id,{value:d})}e.setValue(n,{value:l})}),r.addEventListener("resetform",o=>{let a=t.defaultFieldValue||"Off";o.target.checked=a===t.exportValue}),this.enableScripting&&this.hasJSActions&&(r.addEventListener("updatefromsandbox",o=>{let a={value(l){l.target.checked=l.detail.value!=="Off",e.setValue(n,{value:l.target.checked})}};this._dispatchEventFromSandbox(a,o)}),this._setEventListeners(r,null,[["change","Validate"],["change","Action"],["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],o=>o.target.checked)),this._setBackgroundColor(r),this._setDefaultPropertiesFromJS(r),this.container.append(r),this.container}},nT=class extends wl{constructor(e){super(e,{isRenderable:e.renderForms})}render(){this.container.classList.add("buttonWidgetAnnotation","radioButton");let e=this.annotationStorage,t=this.data,n=t.id,i=e.getValue(n,{value:t.fieldValue===t.buttonValue}).value;if(typeof i=="string"&&(i=i!==t.buttonValue,e.setValue(n,{value:i})),i)for(let o of this._getElementsByName(t.fieldName,n))e.setValue(o.id,{value:!1});let r=document.createElement("input");if(Uu.add(r),r.setAttribute("data-element-id",n),r.disabled=t.readOnly,this._setRequired(r,this.data.required),r.type="radio",r.name=t.fieldName,i&&r.setAttribute("checked",!0),r.tabIndex=Uy,r.addEventListener("change",o=>{let{name:a,checked:l}=o.target;for(let c of this._getElementsByName(a,n))e.setValue(c.id,{value:!1});e.setValue(n,{value:l})}),r.addEventListener("resetform",o=>{let a=t.defaultFieldValue;o.target.checked=a!=null&&a===t.buttonValue}),this.enableScripting&&this.hasJSActions){let o=t.buttonValue;r.addEventListener("updatefromsandbox",a=>{let l={value:c=>{let d=o===c.detail.value;for(let u of this._getElementsByName(c.target.name)){let h=d&&u.id===n;u.domElement&&(u.domElement.checked=h),e.setValue(u.id,{value:h})}}};this._dispatchEventFromSandbox(l,a)}),this._setEventListeners(r,null,[["change","Validate"],["change","Action"],["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],a=>a.target.checked)}return this._setBackgroundColor(r),this._setDefaultPropertiesFromJS(r),this.container.append(r),this.container}},kk=class extends tT{constructor(e){super(e,{ignoreBorder:e.data.hasAppearance})}render(){let e=super.render();e.classList.add("buttonWidgetAnnotation","pushButton");let t=e.lastChild;return this.enableScripting&&this.hasJSActions&&t&&(this._setDefaultPropertiesFromJS(t),t.addEventListener("updatefromsandbox",n=>{this._dispatchEventFromSandbox({},n)})),e}},Ik=class extends wl{constructor(e){super(e,{isRenderable:e.renderForms})}render(){this.container.classList.add("choiceWidgetAnnotation");let e=this.annotationStorage,t=this.data.id,n=e.getValue(t,{value:this.data.fieldValue}),i=document.createElement("select");Uu.add(i),i.setAttribute("data-element-id",t),i.disabled=this.data.readOnly,this._setRequired(i,this.data.required),i.name=this.data.fieldName,i.tabIndex=Uy;let r=this.data.combo&&this.data.options.length>0;this.data.combo||(i.size=this.data.options.length,this.data.multiSelect&&(i.multiple=!0)),i.addEventListener("resetform",d=>{let u=this.data.defaultFieldValue;for(let h of i.options)h.selected=h.value===u});for(let d of this.data.options){let u=document.createElement("option");u.textContent=d.displayValue,u.value=d.exportValue,n.value.includes(d.exportValue)&&(u.setAttribute("selected",!0),r=!1),i.append(u)}let o=null;if(r){let d=document.createElement("option");d.value=" ",d.setAttribute("hidden",!0),d.setAttribute("selected",!0),i.prepend(d),o=()=>{d.remove(),i.removeEventListener("input",o),o=null},i.addEventListener("input",o)}let a=d=>{let u=d?"value":"textContent",{options:h,multiple:p}=i;return p?Array.prototype.filter.call(h,f=>f.selected).map(f=>f[u]):h.selectedIndex===-1?null:h[h.selectedIndex][u]},l=a(!1),c=d=>{let u=d.target.options;return Array.prototype.map.call(u,h=>({displayValue:h.textContent,exportValue:h.value}))};return this.enableScripting&&this.hasJSActions?(i.addEventListener("updatefromsandbox",d=>{let u={value(h){o?.();let p=h.detail.value,f=new Set(Array.isArray(p)?p:[p]);for(let _ of i.options)_.selected=f.has(_.value);e.setValue(t,{value:a(!0)}),l=a(!1)},multipleSelection(h){i.multiple=!0},remove(h){let p=i.options,f=h.detail.remove;p[f].selected=!1,i.remove(f),p.length>0&&Array.prototype.findIndex.call(p,b=>b.selected)===-1&&(p[0].selected=!0),e.setValue(t,{value:a(!0),items:c(h)}),l=a(!1)},clear(h){for(;i.length!==0;)i.remove(0);e.setValue(t,{value:null,items:[]}),l=a(!1)},insert(h){let{index:p,displayValue:f,exportValue:_}=h.detail.insert,b=i.children[p],y=document.createElement("option");y.textContent=f,y.value=_,b?b.before(y):i.append(y),e.setValue(t,{value:a(!0),items:c(h)}),l=a(!1)},items(h){let{items:p}=h.detail;for(;i.length!==0;)i.remove(0);for(let f of p){let{displayValue:_,exportValue:b}=f,y=document.createElement("option");y.textContent=_,y.value=b,i.append(y)}i.options.length>0&&(i.options[0].selected=!0),e.setValue(t,{value:a(!0),items:c(h)}),l=a(!1)},indices(h){let p=new Set(h.detail.indices);for(let f of h.target.options)f.selected=p.has(f.index);e.setValue(t,{value:a(!0)}),l=a(!1)},editable(h){h.target.disabled=!h.detail.editable}};this._dispatchEventFromSandbox(u,d)}),i.addEventListener("input",d=>{let u=a(!0),h=a(!1);e.setValue(t,{value:u}),d.preventDefault(),this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:t,name:"Keystroke",value:l,change:h,changeEx:u,willCommit:!1,commitKey:1,keyDown:!1}})}),this._setEventListeners(i,null,[["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"],["input","Action"],["input","Validate"]],d=>d.target.value)):i.addEventListener("input",function(d){e.setValue(t,{value:a(!0)})}),this.data.combo&&this._setTextStyle(i),this._setBackgroundColor(i),this._setDefaultPropertiesFromJS(i),this.container.append(i),this.container}},xg=class extends Es{constructor(e){let{data:t,elements:n}=e;super(e,{isRenderable:Es._hasPopupData(t)}),this.elements=n,this.popup=null}render(){this.container.classList.add("popupAnnotation");let e=this.popup=new Dk({container:this.container,color:this.data.color,titleObj:this.data.titleObj,modificationDate:this.data.modificationDate,contentsObj:this.data.contentsObj,richText:this.data.richText,rect:this.data.rect,parentRect:this.data.parentRect||null,parent:this.parent,elements:this.elements,open:this.data.open}),t=[];for(let n of this.elements)n.popup=e,n.container.ariaHasPopup="dialog",t.push(n.data.id),n.addHighlightArea();return this.container.setAttribute("aria-controls",t.map(n=>`${MI}${n}`).join(",")),this.container}},Yp,aE,lE,Xp,au,fs,ll,Qp,V_,G_,Jp,cl,go,dl,W_,ul,H_,lu,cu,Zp,wM,j_,Rk,cE,pV,dE,fV,uE,mV,hE,gV,ef,MM,tf,TM,q_,Fk,Dk=class{constructor({container:e,color:t,elements:n,titleObj:i,modificationDate:r,contentsObj:o,richText:a,parent:l,rect:c,parentRect:d,open:u}){L(this,Zp);L(this,j_);L(this,cE);L(this,dE);L(this,uE);L(this,hE);L(this,ef);L(this,tf);L(this,q_);L(this,Yp,K(this,uE,mV).bind(this));L(this,aE,K(this,q_,Fk).bind(this));L(this,lE,K(this,tf,TM).bind(this));L(this,Xp,K(this,ef,MM).bind(this));L(this,au,null);L(this,fs,null);L(this,ll,null);L(this,Qp,null);L(this,V_,null);L(this,G_,null);L(this,Jp,null);L(this,cl,!1);L(this,go,null);L(this,dl,null);L(this,W_,null);L(this,ul,null);L(this,H_,null);L(this,lu,null);L(this,cu,!1);N(this,fs,e),N(this,H_,i),N(this,ll,o),N(this,ul,a),N(this,G_,l),N(this,au,t),N(this,W_,c),N(this,Jp,d),N(this,V_,n),N(this,Qp,fg.toDateObject(r)),this.trigger=n.flatMap(h=>h.getElementsToTriggerPopup());for(let h of this.trigger)h.addEventListener("click",m(this,Xp)),h.addEventListener("mouseenter",m(this,lE)),h.addEventListener("mouseleave",m(this,aE)),h.classList.add("popupTriggerArea");for(let h of n)h.container?.addEventListener("keydown",m(this,Yp));m(this,fs).hidden=!0,u&&K(this,ef,MM).call(this)}render(){if(m(this,go))return;let e=N(this,go,document.createElement("div"));if(e.className="popup",m(this,au)){let r=e.style.outlineColor=At.makeHexColor(...m(this,au));CSS.supports("background-color","color-mix(in srgb, red 30%, white)")?e.style.backgroundColor=`color-mix(in srgb, ${r} 30%, white)`:e.style.backgroundColor=At.makeHexColor(...m(this,au).map(a=>Math.floor(.7*(255-a)+a)))}let t=document.createElement("span");t.className="header";let n=document.createElement("h1");if(t.append(n),{dir:n.dir,str:n.textContent}=m(this,H_),e.append(t),m(this,Qp)){let r=document.createElement("span");r.classList.add("popupDate"),r.setAttribute("data-l10n-id","pdfjs-annotation-date-time-string"),r.setAttribute("data-l10n-args",JSON.stringify({dateObj:m(this,Qp).valueOf()})),t.append(r)}let i=m(this,Zp,wM);if(i)eT.render({xfaHtml:i,intent:"richText",div:e}),e.lastChild.classList.add("richText","popupContent");else{let r=this._formatContents(m(this,ll));e.append(r)}m(this,fs).append(e)}_formatContents({str:e,dir:t}){let n=document.createElement("p");n.classList.add("popupContent"),n.dir=t;let i=e.split(/(?:\r\n?|\n)/);for(let r=0,o=i.length;r<o;++r){let a=i[r];n.append(document.createTextNode(a)),r<o-1&&n.append(document.createElement("br"))}return n}updateEdited({rect:e,popupContent:t}){m(this,lu)||N(this,lu,{contentsObj:m(this,ll),richText:m(this,ul)}),e&&N(this,dl,null),t&&(N(this,ul,K(this,dE,fV).call(this,t)),N(this,ll,null)),m(this,go)?.remove(),N(this,go,null)}resetEdited(){m(this,lu)&&({contentsObj:Ii(this,ll)._,richText:Ii(this,ul)._}=m(this,lu),N(this,lu,null),m(this,go)?.remove(),N(this,go,null),N(this,dl,null))}forceHide(){N(this,cu,this.isVisible),m(this,cu)&&(m(this,fs).hidden=!0)}maybeShow(){m(this,cu)&&(m(this,go)||K(this,tf,TM).call(this),N(this,cu,!1),m(this,fs).hidden=!1)}get isVisible(){return m(this,fs).hidden===!1}};Yp=new WeakMap,aE=new WeakMap,lE=new WeakMap,Xp=new WeakMap,au=new WeakMap,fs=new WeakMap,ll=new WeakMap,Qp=new WeakMap,V_=new WeakMap,G_=new WeakMap,Jp=new WeakMap,cl=new WeakMap,go=new WeakMap,dl=new WeakMap,W_=new WeakMap,ul=new WeakMap,H_=new WeakMap,lu=new WeakMap,cu=new WeakMap,Zp=new WeakSet,wM=function(){let e=m(this,ul),t=m(this,ll);return e?.str&&(!t?.str||t.str===e.str)&&m(this,ul).html||null},j_=new WeakSet,Rk=function(){return m(this,Zp,wM)?.attributes?.style?.fontSize||0},cE=new WeakSet,pV=function(){return m(this,Zp,wM)?.attributes?.style?.color||null},dE=new WeakSet,fV=function(e){let t=[],n={str:e,html:{name:"div",attributes:{dir:"auto"},children:[{name:"p",children:t}]}},i={style:{color:m(this,cE,pV),fontSize:m(this,j_,Rk)?`calc(${m(this,j_,Rk)}px * var(--scale-factor))`:""}};for(let r of e.split(`
`))t.push({name:"span",value:r,attributes:i});return n},uE=new WeakSet,mV=function(e){e.altKey||e.shiftKey||e.ctrlKey||e.metaKey||(e.key==="Enter"||e.key==="Escape"&&m(this,cl))&&K(this,ef,MM).call(this)},hE=new WeakSet,gV=function(){if(m(this,dl)!==null)return;let{page:{view:e},viewport:{rawDims:{pageWidth:t,pageHeight:n,pageX:i,pageY:r}}}=m(this,G_),o=!!m(this,Jp),a=o?m(this,Jp):m(this,W_);for(let f of m(this,V_))if(!a||At.intersect(f.data.rect,a)!==null){a=f.data.rect,o=!0;break}let l=At.normalizeRect([a[0],e[3]-a[1]+e[1],a[2],e[3]-a[3]+e[1]]),d=o?a[2]-a[0]+5:0,u=l[0]+d,h=l[1];N(this,dl,[100*(u-i)/t,100*(h-r)/n]);let{style:p}=m(this,fs);p.left=`${m(this,dl)[0]}%`,p.top=`${m(this,dl)[1]}%`},ef=new WeakSet,MM=function(){N(this,cl,!m(this,cl)),m(this,cl)?(K(this,tf,TM).call(this),m(this,fs).addEventListener("click",m(this,Xp)),m(this,fs).addEventListener("keydown",m(this,Yp))):(K(this,q_,Fk).call(this),m(this,fs).removeEventListener("click",m(this,Xp)),m(this,fs).removeEventListener("keydown",m(this,Yp)))},tf=new WeakSet,TM=function(){m(this,go)||this.render(),this.isVisible?m(this,cl)&&m(this,fs).classList.add("focused"):(K(this,hE,gV).call(this),m(this,fs).hidden=!1,m(this,fs).style.zIndex=parseInt(m(this,fs).style.zIndex)+1e3)},q_=new WeakSet,Fk=function(){m(this,fs).classList.remove("focused"),!(m(this,cl)||!this.isVisible)&&(m(this,fs).hidden=!0,m(this,fs).style.zIndex=parseInt(m(this,fs).style.zIndex)-1e3)};var sT=class extends Es{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0}),this.textContent=e.data.textContent,this.textPosition=e.data.textPosition,this.annotationEditorType=Qt.FREETEXT}render(){if(this.container.classList.add("freeTextAnnotation"),this.textContent){let e=document.createElement("div");e.classList.add("annotationTextContent"),e.setAttribute("role","comment");for(let t of this.textContent){let n=document.createElement("span");n.textContent=t,e.append(n)}this.container.append(e)}return!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this._editOnDoubleClick(),this.container}},K_,Lk=class extends Es{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0});L(this,K_,null)}render(){this.container.classList.add("lineAnnotation");let t=this.data,{width:n,height:i}=Cc(t.rect),r=this.svgFactory.create(n,i,!0),o=N(this,K_,this.svgFactory.createElement("svg:line"));return o.setAttribute("x1",t.rect[2]-t.lineCoordinates[0]),o.setAttribute("y1",t.rect[3]-t.lineCoordinates[1]),o.setAttribute("x2",t.rect[2]-t.lineCoordinates[2]),o.setAttribute("y2",t.rect[3]-t.lineCoordinates[3]),o.setAttribute("stroke-width",t.borderStyle.width||1),o.setAttribute("stroke","transparent"),o.setAttribute("fill","transparent"),r.append(o),this.container.append(r),!t.popupRef&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return m(this,K_)}addHighlightArea(){this.container.classList.add("highlightArea")}};K_=new WeakMap;var Y_,Nk=class extends Es{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0});L(this,Y_,null)}render(){this.container.classList.add("squareAnnotation");let t=this.data,{width:n,height:i}=Cc(t.rect),r=this.svgFactory.create(n,i,!0),o=t.borderStyle.width,a=N(this,Y_,this.svgFactory.createElement("svg:rect"));return a.setAttribute("x",o/2),a.setAttribute("y",o/2),a.setAttribute("width",n-o),a.setAttribute("height",i-o),a.setAttribute("stroke-width",o||1),a.setAttribute("stroke","transparent"),a.setAttribute("fill","transparent"),r.append(a),this.container.append(r),!t.popupRef&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return m(this,Y_)}addHighlightArea(){this.container.classList.add("highlightArea")}};Y_=new WeakMap;var X_,Ok=class extends Es{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0});L(this,X_,null)}render(){this.container.classList.add("circleAnnotation");let t=this.data,{width:n,height:i}=Cc(t.rect),r=this.svgFactory.create(n,i,!0),o=t.borderStyle.width,a=N(this,X_,this.svgFactory.createElement("svg:ellipse"));return a.setAttribute("cx",n/2),a.setAttribute("cy",i/2),a.setAttribute("rx",n/2-o/2),a.setAttribute("ry",i/2-o/2),a.setAttribute("stroke-width",o||1),a.setAttribute("stroke","transparent"),a.setAttribute("fill","transparent"),r.append(a),this.container.append(r),!t.popupRef&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return m(this,X_)}addHighlightArea(){this.container.classList.add("highlightArea")}};X_=new WeakMap;var Q_,iT=class extends Es{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0});L(this,Q_,null);this.containerClassName="polylineAnnotation",this.svgElementName="svg:polyline"}render(){this.container.classList.add(this.containerClassName);let{data:{rect:t,vertices:n,borderStyle:i,popupRef:r}}=this;if(!n)return this.container;let{width:o,height:a}=Cc(t),l=this.svgFactory.create(o,a,!0),c=[];for(let u=0,h=n.length;u<h;u+=2){let p=n[u]-t[0],f=t[3]-n[u+1];c.push(`${p},${f}`)}c=c.join(" ");let d=N(this,Q_,this.svgFactory.createElement(this.svgElementName));return d.setAttribute("points",c),d.setAttribute("stroke-width",i.width||1),d.setAttribute("stroke","transparent"),d.setAttribute("fill","transparent"),l.append(d),this.container.append(l),!r&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return m(this,Q_)}addHighlightArea(){this.container.classList.add("highlightArea")}};Q_=new WeakMap;var $k=class extends iT{constructor(e){super(e),this.containerClassName="polygonAnnotation",this.svgElementName="svg:polygon"}},Bk=class extends Es{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0})}render(){return this.container.classList.add("caretAnnotation"),!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container}},J_,du,Z_,zk,Sg=class extends Es{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0});L(this,Z_);L(this,J_,null);L(this,du,[]);this.containerClassName="inkAnnotation",this.svgElementName="svg:polyline",this.annotationEditorType=this.data.it==="InkHighlight"?Qt.HIGHLIGHT:Qt.INK}render(){this.container.classList.add(this.containerClassName);let{data:{rect:t,rotation:n,inkLists:i,borderStyle:r,popupRef:o}}=this,{transform:a,width:l,height:c}=K(this,Z_,zk).call(this,n,t),d=this.svgFactory.create(l,c,!0),u=N(this,J_,this.svgFactory.createElement("svg:g"));d.append(u),u.setAttribute("stroke-width",r.width||1),u.setAttribute("stroke-linecap","round"),u.setAttribute("stroke-linejoin","round"),u.setAttribute("stroke-miterlimit",10),u.setAttribute("stroke","transparent"),u.setAttribute("fill","transparent"),u.setAttribute("transform",a);for(let h=0,p=i.length;h<p;h++){let f=this.svgFactory.createElement(this.svgElementName);m(this,du).push(f),f.setAttribute("points",i[h].join(",")),u.append(f)}return!o&&this.hasPopupData&&this._createPopup(),this.container.append(d),this._editOnDoubleClick(),this.container}updateEdited(t){super.updateEdited(t);let{thickness:n,points:i,rect:r}=t,o=m(this,J_);if(n>=0&&o.setAttribute("stroke-width",n||1),i)for(let a=0,l=m(this,du).length;a<l;a++)m(this,du)[a].setAttribute("points",i[a].join(","));if(r){let{transform:a,width:l,height:c}=K(this,Z_,zk).call(this,this.data.rotation,r);o.parentElement.setAttribute("viewBox",`0 0 ${l} ${c}`),o.setAttribute("transform",a)}}getElementsToTriggerPopup(){return m(this,du)}addHighlightArea(){this.container.classList.add("highlightArea")}};J_=new WeakMap,du=new WeakMap,Z_=new WeakSet,zk=function(t,n){switch(t){case 90:return{transform:`rotate(90) translate(${-n[0]},${n[1]}) scale(1,-1)`,width:n[3]-n[1],height:n[2]-n[0]};case 180:return{transform:`rotate(180) translate(${-n[2]},${n[1]}) scale(1,-1)`,width:n[2]-n[0],height:n[3]-n[1]};case 270:return{transform:`rotate(270) translate(${-n[2]},${n[3]}) scale(1,-1)`,width:n[3]-n[1],height:n[2]-n[0]};default:return{transform:`translate(${-n[0]},${n[3]}) scale(1,-1)`,width:n[2]-n[0],height:n[3]-n[1]}}};var rT=class extends Es{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0}),this.annotationEditorType=Qt.HIGHLIGHT}render(){return!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container.classList.add("highlightAnnotation"),this._editOnDoubleClick(),this.container}},Uk=class extends Es{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){return!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container.classList.add("underlineAnnotation"),this.container}},Vk=class extends Es{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){return!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container.classList.add("squigglyAnnotation"),this.container}},Gk=class extends Es{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){return!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container.classList.add("strikeoutAnnotation"),this.container}},oT=class extends Es{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0}),this.annotationEditorType=Qt.STAMP}render(){return this.container.classList.add("stampAnnotation"),this.container.setAttribute("role","img"),!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this._editOnDoubleClick(),this.container}},ey,ty,Hk,Wk=class extends Es{constructor(t){super(t,{isRenderable:!0});L(this,ty);L(this,ey,null);let{file:n}=this.data;this.filename=n.filename,this.content=n.content,this.linkService.eventBus?.dispatch("fileattachmentannotation",{source:this,...n})}render(){this.container.classList.add("fileAttachmentAnnotation");let{container:t,data:n}=this,i;n.hasAppearance||n.fillAlpha===0?i=document.createElement("div"):(i=document.createElement("img"),i.src=`${this.imageResourcesPath}annotation-${/paperclip/i.test(n.name)?"paperclip":"pushpin"}.svg`,n.fillAlpha&&n.fillAlpha<1&&(i.style=`filter: opacity(${Math.round(n.fillAlpha*100)}%);`)),i.addEventListener("dblclick",K(this,ty,Hk).bind(this)),N(this,ey,i);let{isMac:r}=ui.platform;return t.addEventListener("keydown",o=>{o.key==="Enter"&&(r?o.metaKey:o.ctrlKey)&&K(this,ty,Hk).call(this)}),!n.popupRef&&this.hasPopupData?this._createPopup():i.classList.add("popupTriggerArea"),t.append(i),t}getElementsToTriggerPopup(){return m(this,ey)}addHighlightArea(){this.container.classList.add("highlightArea")}};ey=new WeakMap,ty=new WeakSet,Hk=function(){this.downloadManager?.openOrDownloadData(this.content,this.filename)};var ny,uu,hu,sy,pE,_V,iy,qk,jk=class{constructor({div:e,accessibilityManager:t,annotationCanvasMap:n,annotationEditorUIManager:i,page:r,viewport:o,structTreeLayer:a}){L(this,pE);L(this,iy);L(this,ny,null);L(this,uu,null);L(this,hu,new Map);L(this,sy,null);this.div=e,N(this,ny,t),N(this,uu,n),N(this,sy,a||null),this.page=r,this.viewport=o,this.zIndex=0,this._annotationEditorUIManager=i}hasEditableAnnotations(){return m(this,hu).size>0}async render(e){let{annotations:t}=e,n=this.div;$u(n,this.viewport);let i=new Map,r={data:null,layer:n,linkService:e.linkService,downloadManager:e.downloadManager,imageResourcesPath:e.imageResourcesPath||"",renderForms:e.renderForms!==!1,svgFactory:new Eg,annotationStorage:e.annotationStorage||new bg,enableScripting:e.enableScripting===!0,hasJSActions:e.hasJSActions,fieldObjects:e.fieldObjects,parent:this,elements:null};for(let o of t){if(o.noHTML)continue;let a=o.annotationType===Bs.POPUP;if(a){let d=i.get(o.id);if(!d)continue;r.elements=d}else{let{width:d,height:u}=Cc(o.rect);if(d<=0||u<=0)continue}r.data=o;let l=Ek.create(r);if(!l.isRenderable)continue;if(!a&&o.popupRef){let d=i.get(o.popupRef);d?d.push(l):i.set(o.popupRef,[l])}let c=l.render();o.hidden&&(c.style.visibility="hidden"),await K(this,pE,_V).call(this,c,o.id),l._isEditable&&(m(this,hu).set(l.data.id,l),this._annotationEditorUIManager?.renderAnnotationElement(l))}K(this,iy,qk).call(this)}update({viewport:e}){let t=this.div;this.viewport=e,$u(t,{rotation:e.rotation}),K(this,iy,qk).call(this),t.hidden=!1}getEditableAnnotations(){return Array.from(m(this,hu).values())}getEditableAnnotation(e){return m(this,hu).get(e)}};ny=new WeakMap,uu=new WeakMap,hu=new WeakMap,sy=new WeakMap,pE=new WeakSet,_V=async function(e,t){let n=e.firstChild||e,i=n.id=`${MI}${t}`,r=await m(this,sy)?.getAriaAttributes(i);if(r)for(let[o,a]of r)n.setAttribute(o,a);this.div.append(e),m(this,ny)?.moveElementInDOM(this.div,e,n,!1)},iy=new WeakSet,qk=function(){if(!m(this,uu))return;let e=this.div;for(let[t,n]of m(this,uu)){let i=e.querySelector(`[data-annotation-id="${t}"]`);if(!i)continue;n.className="annotationContent";let{firstChild:r}=i;r?r.nodeName==="CANVAS"?r.replaceWith(n):r.classList.contains("annotationContent")?r.after(n):r.before(n):i.append(n)}m(this,uu).clear()};var iM=/\r\n?|\n/g,_o,dr,ry,pu,ur,fE,yV,mE,vV,gE,bV,nf,EM,sf,xM,rf,SM,_E,wV,oy,Yk,yE,MV,Bn=class Bn extends ls{constructor(t){super({...t,name:"freeTextEditor"});L(this,fE);L(this,mE);L(this,gE);L(this,nf);L(this,rf);L(this,_E);L(this,yE);L(this,_o,void 0);L(this,dr,"");L(this,ry,`${this.id}-editor`);L(this,pu,null);L(this,ur,void 0);N(this,_o,t.color||Bn._defaultColor||ls._defaultLineColor),N(this,ur,t.fontSize||Bn._defaultFontSize)}static get _keyboardManager(){let t=Bn.prototype,n=o=>o.isEmpty(),i=zu.TRANSLATE_SMALL,r=zu.TRANSLATE_BIG;return an(this,"_keyboardManager",new Bu([[["ctrl+s","mac+meta+s","ctrl+p","mac+meta+p"],t.commitOrRemove,{bubbles:!0}],[["ctrl+Enter","mac+meta+Enter","Escape","mac+Escape"],t.commitOrRemove],[["ArrowLeft","mac+ArrowLeft"],t._translateEmpty,{args:[-i,0],checker:n}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],t._translateEmpty,{args:[-r,0],checker:n}],[["ArrowRight","mac+ArrowRight"],t._translateEmpty,{args:[i,0],checker:n}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],t._translateEmpty,{args:[r,0],checker:n}],[["ArrowUp","mac+ArrowUp"],t._translateEmpty,{args:[0,-i],checker:n}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],t._translateEmpty,{args:[0,-r],checker:n}],[["ArrowDown","mac+ArrowDown"],t._translateEmpty,{args:[0,i],checker:n}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],t._translateEmpty,{args:[0,r],checker:n}]]))}static initialize(t,n){ls.initialize(t,n);let i=getComputedStyle(document.documentElement);this._internalPadding=parseFloat(i.getPropertyValue("--freetext-padding"))}static updateDefaultParams(t,n){switch(t){case mn.FREETEXT_SIZE:Bn._defaultFontSize=n;break;case mn.FREETEXT_COLOR:Bn._defaultColor=n;break}}updateParams(t,n){switch(t){case mn.FREETEXT_SIZE:K(this,fE,yV).call(this,n);break;case mn.FREETEXT_COLOR:K(this,mE,vV).call(this,n);break}}static get defaultPropertiesToUpdate(){return[[mn.FREETEXT_SIZE,Bn._defaultFontSize],[mn.FREETEXT_COLOR,Bn._defaultColor||ls._defaultLineColor]]}get propertiesToUpdate(){return[[mn.FREETEXT_SIZE,m(this,ur)],[mn.FREETEXT_COLOR,m(this,_o)]]}_translateEmpty(t,n){this._uiManager.translateSelectedEditors(t,n,!0)}getInitialTranslation(){let t=this.parentScale;return[-Bn._internalPadding*t,-(Bn._internalPadding+m(this,ur))*t]}rebuild(){this.parent&&(super.rebuild(),this.div!==null&&(this.isAttachedToDOM||this.parent.add(this)))}enableEditMode(){if(this.isInEditMode())return;this.parent.setEditingState(!1),this.parent.updateToolbar(Qt.FREETEXT),super.enableEditMode(),this.overlayDiv.classList.remove("enabled"),this.editorDiv.contentEditable=!0,this._isDraggable=!1,this.div.removeAttribute("aria-activedescendant"),N(this,pu,new AbortController);let t=this._uiManager.combinedSignal(m(this,pu));this.editorDiv.addEventListener("keydown",this.editorDivKeydown.bind(this),{signal:t}),this.editorDiv.addEventListener("focus",this.editorDivFocus.bind(this),{signal:t}),this.editorDiv.addEventListener("blur",this.editorDivBlur.bind(this),{signal:t}),this.editorDiv.addEventListener("input",this.editorDivInput.bind(this),{signal:t}),this.editorDiv.addEventListener("paste",this.editorDivPaste.bind(this),{signal:t})}disableEditMode(){this.isInEditMode()&&(this.parent.setEditingState(!0),super.disableEditMode(),this.overlayDiv.classList.add("enabled"),this.editorDiv.contentEditable=!1,this.div.setAttribute("aria-activedescendant",m(this,ry)),this._isDraggable=!0,m(this,pu)?.abort(),N(this,pu,null),this.div.focus({preventScroll:!0}),this.isEditing=!1,this.parent.div.classList.add("freetextEditing"))}focusin(t){this._focusEventsAllowed&&(super.focusin(t),t.target!==this.editorDiv&&this.editorDiv.focus())}onceAdded(t){this.width||(this.enableEditMode(),t&&this.editorDiv.focus(),this._initialOptions?.isCentered&&this.center(),this._initialOptions=null)}isEmpty(){return!this.editorDiv||this.editorDiv.innerText.trim()===""}remove(){this.isEditing=!1,this.parent&&(this.parent.setEditingState(!0),this.parent.div.classList.add("freetextEditing")),super.remove()}commit(){if(!this.isInEditMode())return;super.commit(),this.disableEditMode();let t=m(this,dr),n=N(this,dr,K(this,gE,bV).call(this).trimEnd());if(t===n)return;let i=r=>{if(N(this,dr,r),!r){this.remove();return}K(this,rf,SM).call(this),this._uiManager.rebuild(this),K(this,nf,EM).call(this)};this.addCommands({cmd:()=>{i(n)},undo:()=>{i(t)},mustExec:!1}),K(this,nf,EM).call(this)}shouldGetKeyboardEvents(){return this.isInEditMode()}enterInEditMode(){this.enableEditMode(),this.editorDiv.focus()}dblclick(t){this.enterInEditMode()}keydown(t){t.target===this.div&&t.key==="Enter"&&(this.enterInEditMode(),t.preventDefault())}editorDivKeydown(t){Bn._keyboardManager.exec(this,t)}editorDivFocus(t){this.isEditing=!0}editorDivBlur(t){this.isEditing=!1}editorDivInput(t){this.parent.div.classList.toggle("freetextEditing",this.isEmpty())}disableEditing(){this.editorDiv.setAttribute("role","comment"),this.editorDiv.removeAttribute("aria-multiline")}enableEditing(){this.editorDiv.setAttribute("role","textbox"),this.editorDiv.setAttribute("aria-multiline",!0)}render(){if(this.div)return this.div;let t,n;this.width&&(t=this.x,n=this.y),super.render(),this.editorDiv=document.createElement("div"),this.editorDiv.className="internal",this.editorDiv.setAttribute("id",m(this,ry)),this.editorDiv.setAttribute("data-l10n-id","pdfjs-free-text2"),this.editorDiv.setAttribute("data-l10n-attrs","default-content"),this.enableEditing(),this.editorDiv.contentEditable=!0;let{style:i}=this.editorDiv;if(i.fontSize=`calc(${m(this,ur)}px * var(--scale-factor))`,i.color=m(this,_o),this.div.append(this.editorDiv),this.overlayDiv=document.createElement("div"),this.overlayDiv.classList.add("overlay","enabled"),this.div.append(this.overlayDiv),$M(this,this.div,["dblclick","keydown"]),this.width){let[r,o]=this.parentDimensions;if(this.annotationElementId){let{position:a}=this._initialData,[l,c]=this.getInitialTranslation();[l,c]=this.pageTranslationToScreen(l,c);let[d,u]=this.pageDimensions,[h,p]=this.pageTranslation,f,_;switch(this.rotation){case 0:f=t+(a[0]-h)/d,_=n+this.height-(a[1]-p)/u;break;case 90:f=t+(a[0]-h)/d,_=n-(a[1]-p)/u,[l,c]=[c,-l];break;case 180:f=t-this.width+(a[0]-h)/d,_=n-(a[1]-p)/u,[l,c]=[-l,-c];break;case 270:f=t+(a[0]-h-this.height*u)/d,_=n+(a[1]-p-this.width*d)/u,[l,c]=[-c,l];break}this.setAt(f*r,_*o,l,c)}else this.setAt(t*r,n*o,this.width*r,this.height*o);K(this,rf,SM).call(this),this._isDraggable=!0,this.editorDiv.contentEditable=!1}else this._isDraggable=!1,this.editorDiv.contentEditable=!0;return this.div}editorDivPaste(t){var f,_,b;let n=t.clipboardData||window.clipboardData,{types:i}=n;if(i.length===1&&i[0]==="text/plain")return;t.preventDefault();let r=K(f=Bn,oy,Yk).call(f,n.getData("text")||"").replaceAll(iM,`
`);if(!r)return;let o=window.getSelection();if(!o.rangeCount)return;this.editorDiv.normalize(),o.deleteFromDocument();let a=o.getRangeAt(0);if(!r.includes(`
`)){a.insertNode(document.createTextNode(r)),this.editorDiv.normalize(),o.collapseToStart();return}let{startContainer:l,startOffset:c}=a,d=[],u=[];if(l.nodeType===Node.TEXT_NODE){let y=l.parentElement;if(u.push(l.nodeValue.slice(c).replaceAll(iM,"")),y!==this.editorDiv){let w=d;for(let C of this.editorDiv.childNodes){if(C===y){w=u;continue}w.push(K(_=Bn,sf,xM).call(_,C))}}d.push(l.nodeValue.slice(0,c).replaceAll(iM,""))}else if(l===this.editorDiv){let y=d,w=0;for(let C of this.editorDiv.childNodes)w++===c&&(y=u),y.push(K(b=Bn,sf,xM).call(b,C))}N(this,dr,`${d.join(`
`)}${r}${u.join(`
`)}`),K(this,rf,SM).call(this);let h=new Range,p=d.reduce((y,w)=>y+w.length,0);for(let{firstChild:y}of this.editorDiv.childNodes)if(y.nodeType===Node.TEXT_NODE){let w=y.nodeValue.length;if(p<=w){h.setStart(y,p),h.setEnd(y,p);break}p-=w}o.removeAllRanges(),o.addRange(h)}get contentDiv(){return this.editorDiv}static async deserialize(t,n,i){var a;let r=null;if(t instanceof sT){let{data:{defaultAppearanceData:{fontSize:l,fontColor:c},rect:d,rotation:u,id:h,popupRef:p},textContent:f,textPosition:_,parent:{page:{pageNumber:b}}}=t;if(!f||f.length===0)return null;r=t={annotationType:Qt.FREETEXT,color:Array.from(c),fontSize:l,value:f.join(`
`),position:_,pageIndex:b-1,rect:d.slice(0),rotation:u,id:h,deleted:!1,popupRef:p}}let o=await super.deserialize(t,n,i);return N(o,ur,t.fontSize),N(o,_o,At.makeHexColor(...t.color)),N(o,dr,K(a=Bn,oy,Yk).call(a,t.value)),o.annotationElementId=t.id||null,o._initialData=r,o}serialize(t=!1){if(this.isEmpty())return null;if(this.deleted)return this.serializeDeleted();let n=Bn._internalPadding*this.parentScale,i=this.getRect(n,n),r=ls._colorManager.convert(this.isAttachedToDOM?getComputedStyle(this.editorDiv).color:m(this,_o)),o={annotationType:Qt.FREETEXT,color:r,fontSize:m(this,ur),value:K(this,_E,wV).call(this),pageIndex:this.pageIndex,rect:i,rotation:this.rotation,structTreeParentId:this._structTreeParentId};return t?o:this.annotationElementId&&!K(this,yE,MV).call(this,o)?null:(o.id=this.annotationElementId,o)}renderAnnotationElement(t){let n=super.renderAnnotationElement(t);if(this.deleted)return n;let{style:i}=n;i.fontSize=`calc(${m(this,ur)}px * var(--scale-factor))`,i.color=m(this,_o),n.replaceChildren();for(let o of m(this,dr).split(`
`)){let a=document.createElement("div");a.append(o?document.createTextNode(o):document.createElement("br")),n.append(a)}let r=Bn._internalPadding*this.parentScale;return t.updateEdited({rect:this.getRect(r,r),popupContent:m(this,dr)}),n}resetAnnotationElement(t){super.resetAnnotationElement(t),t.resetEdited()}};_o=new WeakMap,dr=new WeakMap,ry=new WeakMap,pu=new WeakMap,ur=new WeakMap,fE=new WeakSet,yV=function(t){let n=r=>{this.editorDiv.style.fontSize=`calc(${r}px * var(--scale-factor))`,this.translate(0,-(r-m(this,ur))*this.parentScale),N(this,ur,r),K(this,nf,EM).call(this)},i=m(this,ur);this.addCommands({cmd:n.bind(this,t),undo:n.bind(this,i),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:mn.FREETEXT_SIZE,overwriteIfSameType:!0,keepUndo:!0})},mE=new WeakSet,vV=function(t){let n=r=>{N(this,_o,this.editorDiv.style.color=r)},i=m(this,_o);this.addCommands({cmd:n.bind(this,t),undo:n.bind(this,i),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:mn.FREETEXT_COLOR,overwriteIfSameType:!0,keepUndo:!0})},gE=new WeakSet,bV=function(){var i;let t=[];this.editorDiv.normalize();let n=null;for(let r of this.editorDiv.childNodes)n?.nodeType===Node.TEXT_NODE&&r.nodeName==="BR"||(t.push(K(i=Bn,sf,xM).call(i,r)),n=r);return t.join(`
`)},nf=new WeakSet,EM=function(){let[t,n]=this.parentDimensions,i;if(this.isAttachedToDOM)i=this.div.getBoundingClientRect();else{let{currentLayer:r,div:o}=this,a=o.style.display,l=o.classList.contains("hidden");o.classList.remove("hidden"),o.style.display="hidden",r.div.append(this.div),i=o.getBoundingClientRect(),o.remove(),o.style.display=a,o.classList.toggle("hidden",l)}this.rotation%180===this.parentRotation%180?(this.width=i.width/t,this.height=i.height/n):(this.width=i.height/t,this.height=i.width/n),this.fixAndSetPosition()},sf=new WeakSet,xM=function(t){return(t.nodeType===Node.TEXT_NODE?t.nodeValue:t.innerText).replaceAll(iM,"")},rf=new WeakSet,SM=function(){if(this.editorDiv.replaceChildren(),!!m(this,dr))for(let t of m(this,dr).split(`
`)){let n=document.createElement("div");n.append(t?document.createTextNode(t):document.createElement("br")),this.editorDiv.append(n)}},_E=new WeakSet,wV=function(){return m(this,dr).replaceAll("\xA0"," ")},oy=new WeakSet,Yk=function(t){return t.replaceAll(" ","\xA0")},yE=new WeakSet,MV=function(t){let{value:n,fontSize:i,color:r,pageIndex:o}=this._initialData;return this._hasBeenMoved||t.value!==n||t.fontSize!==i||t.color.some((a,l)=>a!==r[l])||t.pageIndex!==o},L(Bn,sf),L(Bn,oy),Z(Bn,"_freeTextDefaultContent",""),Z(Bn,"_internalPadding",0),Z(Bn,"_defaultColor",null),Z(Bn,"_defaultFontSize",10),Z(Bn,"_type","freetext"),Z(Bn,"_editorType",Qt.FREETEXT);var Kk=Bn,yt=class{toSVGPath(){zn("Abstract method `toSVGPath` must be implemented.")}get box(){zn("Abstract getter `box` must be implemented.")}serialize(e,t){zn("Abstract method `serialize` must be implemented.")}static _rescale(e,t,n,i,r,o){o||(o=new Float32Array(e.length));for(let a=0,l=e.length;a<l;a+=2)o[a]=t+e[a]*i,o[a+1]=n+e[a+1]*r;return o}static _rescaleAndSwap(e,t,n,i,r,o){o||(o=new Float32Array(e.length));for(let a=0,l=e.length;a<l;a+=2)o[a]=t+e[a+1]*i,o[a+1]=n+e[a]*r;return o}static _translate(e,t,n,i){i||(i=new Float32Array(e.length));for(let r=0,o=e.length;r<o;r+=2)i[r]=t+e[r],i[r+1]=n+e[r+1];return i}static svgRound(e){return Math.round(e*1e4)}static _normalizePoint(e,t,n,i,r){switch(r){case 90:return[1-t/n,e/i];case 180:return[1-e/n,1-t/i];case 270:return[t/n,1-e/i];default:return[e/n,t/i]}}static _normalizePagePoint(e,t,n){switch(n){case 90:return[1-t,e];case 180:return[1-e,1-t];case 270:return[t,1-e];default:return[e,t]}}static createBezierPoints(e,t,n,i,r,o){return[(e+5*n)/6,(t+5*i)/6,(5*n+r)/6,(5*i+o)/6,(n+r)/2,(i+o)/2]}};Z(yt,"PRECISION",1e-4);var hr,yo,of,af,da,on,fu,mu,ay,ly,lf,cf,fc,cy,vE,bE,gu,og,wE,TV,ME,EV,TE,xV,EE,SV,xE,CV,SE,AV,ja=class ja{constructor({x:e,y:t},n,i,r,o,a=0){L(this,gu);L(this,wE);L(this,ME);L(this,TE);L(this,EE);L(this,xE);L(this,SE);L(this,hr,void 0);L(this,yo,[]);L(this,of,void 0);L(this,af,void 0);L(this,da,[]);L(this,on,new Float32Array(18));L(this,fu,void 0);L(this,mu,void 0);L(this,ay,void 0);L(this,ly,void 0);L(this,lf,void 0);L(this,cf,void 0);L(this,fc,[]);N(this,hr,n),N(this,cf,r*i),N(this,af,o),m(this,on).set([NaN,NaN,NaN,NaN,e,t],6),N(this,of,a),N(this,ly,m(ja,cy)*i),N(this,ay,m(ja,bE)*i),N(this,lf,i),m(this,fc).push(e,t)}isEmpty(){return isNaN(m(this,on)[8])}add({x:e,y:t}){N(this,fu,e),N(this,mu,t);let[n,i,r,o]=m(this,hr),[a,l,c,d]=m(this,on).subarray(8,12),u=e-c,h=t-d,p=Math.hypot(u,h);if(p<m(this,ay))return!1;let f=p-m(this,ly),_=f/p,b=_*u,y=_*h,w=a,C=l;a=c,l=d,c+=b,d+=y,m(this,fc)?.push(e,t);let M=-y/f,S=b/f,k=M*m(this,cf),T=S*m(this,cf);return m(this,on).set(m(this,on).subarray(2,8),0),m(this,on).set([c+k,d+T],4),m(this,on).set(m(this,on).subarray(14,18),12),m(this,on).set([c-k,d-T],16),isNaN(m(this,on)[6])?(m(this,da).length===0&&(m(this,on).set([a+k,l+T],2),m(this,da).push(NaN,NaN,NaN,NaN,(a+k-n)/r,(l+T-i)/o),m(this,on).set([a-k,l-T],14),m(this,yo).push(NaN,NaN,NaN,NaN,(a-k-n)/r,(l-T-i)/o)),m(this,on).set([w,C,a,l,c,d],6),!this.isEmpty()):(m(this,on).set([w,C,a,l,c,d],6),Math.abs(Math.atan2(C-l,w-a)-Math.atan2(y,b))<Math.PI/2?([a,l,c,d]=m(this,on).subarray(2,6),m(this,da).push(NaN,NaN,NaN,NaN,((a+c)/2-n)/r,((l+d)/2-i)/o),[a,l,w,C]=m(this,on).subarray(14,18),m(this,yo).push(NaN,NaN,NaN,NaN,((w+a)/2-n)/r,((C+l)/2-i)/o),!0):([w,C,a,l,c,d]=m(this,on).subarray(0,6),m(this,da).push(((w+5*a)/6-n)/r,((C+5*l)/6-i)/o,((5*a+c)/6-n)/r,((5*l+d)/6-i)/o,((a+c)/2-n)/r,((l+d)/2-i)/o),[c,d,a,l,w,C]=m(this,on).subarray(12,18),m(this,yo).push(((w+5*a)/6-n)/r,((C+5*l)/6-i)/o,((5*a+c)/6-n)/r,((5*l+d)/6-i)/o,((a+c)/2-n)/r,((l+d)/2-i)/o),!0))}toSVGPath(){if(this.isEmpty())return"";let e=m(this,da),t=m(this,yo);if(isNaN(m(this,on)[6])&&!this.isEmpty())return K(this,wE,TV).call(this);let n=[];n.push(`M${e[4]} ${e[5]}`);for(let i=6;i<e.length;i+=6)isNaN(e[i])?n.push(`L${e[i+4]} ${e[i+5]}`):n.push(`C${e[i]} ${e[i+1]} ${e[i+2]} ${e[i+3]} ${e[i+4]} ${e[i+5]}`);K(this,TE,xV).call(this,n);for(let i=t.length-6;i>=6;i-=6)isNaN(t[i])?n.push(`L${t[i+4]} ${t[i+5]}`):n.push(`C${t[i]} ${t[i+1]} ${t[i+2]} ${t[i+3]} ${t[i+4]} ${t[i+5]}`);return K(this,ME,EV).call(this,n),n.join(" ")}newFreeDrawOutline(e,t,n,i,r,o){return new lT(e,t,n,i,r,o)}getOutlines(){let e=m(this,da),t=m(this,yo),n=m(this,on),[i,r,o,a]=m(this,hr),l=new Float32Array((m(this,fc)?.length??0)+2);for(let u=0,h=l.length-2;u<h;u+=2)l[u]=(m(this,fc)[u]-i)/o,l[u+1]=(m(this,fc)[u+1]-r)/a;if(l[l.length-2]=(m(this,fu)-i)/o,l[l.length-1]=(m(this,mu)-r)/a,isNaN(n[6])&&!this.isEmpty())return K(this,EE,SV).call(this,l);let c=new Float32Array(m(this,da).length+24+m(this,yo).length),d=e.length;for(let u=0;u<d;u+=2){if(isNaN(e[u])){c[u]=c[u+1]=NaN;continue}c[u]=e[u],c[u+1]=e[u+1]}d=K(this,SE,AV).call(this,c,d);for(let u=t.length-6;u>=6;u-=6)for(let h=0;h<6;h+=2){if(isNaN(t[u+h])){c[d]=c[d+1]=NaN,d+=2;continue}c[d]=t[u+h],c[d+1]=t[u+h+1],d+=2}return K(this,xE,CV).call(this,c,d),this.newFreeDrawOutline(c,l,m(this,hr),m(this,lf),m(this,of),m(this,af))}};hr=new WeakMap,yo=new WeakMap,of=new WeakMap,af=new WeakMap,da=new WeakMap,on=new WeakMap,fu=new WeakMap,mu=new WeakMap,ay=new WeakMap,ly=new WeakMap,lf=new WeakMap,cf=new WeakMap,fc=new WeakMap,cy=new WeakMap,vE=new WeakMap,bE=new WeakMap,gu=new WeakSet,og=function(){let e=m(this,on).subarray(4,6),t=m(this,on).subarray(16,18),[n,i,r,o]=m(this,hr);return[(m(this,fu)+(e[0]-t[0])/2-n)/r,(m(this,mu)+(e[1]-t[1])/2-i)/o,(m(this,fu)+(t[0]-e[0])/2-n)/r,(m(this,mu)+(t[1]-e[1])/2-i)/o]},wE=new WeakSet,TV=function(){let[e,t,n,i]=m(this,hr),[r,o,a,l]=K(this,gu,og).call(this);return`M${(m(this,on)[2]-e)/n} ${(m(this,on)[3]-t)/i} L${(m(this,on)[4]-e)/n} ${(m(this,on)[5]-t)/i} L${r} ${o} L${a} ${l} L${(m(this,on)[16]-e)/n} ${(m(this,on)[17]-t)/i} L${(m(this,on)[14]-e)/n} ${(m(this,on)[15]-t)/i} Z`},ME=new WeakSet,EV=function(e){let t=m(this,yo);e.push(`L${t[4]} ${t[5]} Z`)},TE=new WeakSet,xV=function(e){let[t,n,i,r]=m(this,hr),o=m(this,on).subarray(4,6),a=m(this,on).subarray(16,18),[l,c,d,u]=K(this,gu,og).call(this);e.push(`L${(o[0]-t)/i} ${(o[1]-n)/r} L${l} ${c} L${d} ${u} L${(a[0]-t)/i} ${(a[1]-n)/r}`)},EE=new WeakSet,SV=function(e){let t=m(this,on),[n,i,r,o]=m(this,hr),[a,l,c,d]=K(this,gu,og).call(this),u=new Float32Array(36);return u.set([NaN,NaN,NaN,NaN,(t[2]-n)/r,(t[3]-i)/o,NaN,NaN,NaN,NaN,(t[4]-n)/r,(t[5]-i)/o,NaN,NaN,NaN,NaN,a,l,NaN,NaN,NaN,NaN,c,d,NaN,NaN,NaN,NaN,(t[16]-n)/r,(t[17]-i)/o,NaN,NaN,NaN,NaN,(t[14]-n)/r,(t[15]-i)/o],0),this.newFreeDrawOutline(u,e,m(this,hr),m(this,lf),m(this,of),m(this,af))},xE=new WeakSet,CV=function(e,t){let n=m(this,yo);return e.set([NaN,NaN,NaN,NaN,n[4],n[5]],t),t+=6},SE=new WeakSet,AV=function(e,t){let n=m(this,on).subarray(4,6),i=m(this,on).subarray(16,18),[r,o,a,l]=m(this,hr),[c,d,u,h]=K(this,gu,og).call(this);return e.set([NaN,NaN,NaN,NaN,(n[0]-r)/a,(n[1]-o)/l,NaN,NaN,NaN,NaN,c,d,NaN,NaN,NaN,NaN,u,h,NaN,NaN,NaN,NaN,(i[0]-r)/a,(i[1]-o)/l],t),t+=24},L(ja,cy,8),L(ja,vE,2),L(ja,bE,m(ja,cy)+m(ja,vE));var aT=ja,df,_u,hl,dy,pr,uy,Ts,CE,PV,lT=class extends yt{constructor(t,n,i,r,o,a){super();L(this,CE);L(this,df,void 0);L(this,_u,new Float32Array(4));L(this,hl,void 0);L(this,dy,void 0);L(this,pr,void 0);L(this,uy,void 0);L(this,Ts,void 0);N(this,Ts,t),N(this,pr,n),N(this,df,i),N(this,uy,r),N(this,hl,o),N(this,dy,a),this.lastPoint=[NaN,NaN],K(this,CE,PV).call(this,a);let[l,c,d,u]=m(this,_u);for(let h=0,p=t.length;h<p;h+=2)t[h]=(t[h]-l)/d,t[h+1]=(t[h+1]-c)/u;for(let h=0,p=n.length;h<p;h+=2)n[h]=(n[h]-l)/d,n[h+1]=(n[h+1]-c)/u}toSVGPath(){let t=[`M${m(this,Ts)[4]} ${m(this,Ts)[5]}`];for(let n=6,i=m(this,Ts).length;n<i;n+=6){if(isNaN(m(this,Ts)[n])){t.push(`L${m(this,Ts)[n+4]} ${m(this,Ts)[n+5]}`);continue}t.push(`C${m(this,Ts)[n]} ${m(this,Ts)[n+1]} ${m(this,Ts)[n+2]} ${m(this,Ts)[n+3]} ${m(this,Ts)[n+4]} ${m(this,Ts)[n+5]}`)}return t.push("Z"),t.join(" ")}serialize([t,n,i,r],o){let a=i-t,l=r-n,c,d;switch(o){case 0:c=yt._rescale(m(this,Ts),t,r,a,-l),d=yt._rescale(m(this,pr),t,r,a,-l);break;case 90:c=yt._rescaleAndSwap(m(this,Ts),t,n,a,l),d=yt._rescaleAndSwap(m(this,pr),t,n,a,l);break;case 180:c=yt._rescale(m(this,Ts),i,n,-a,l),d=yt._rescale(m(this,pr),i,n,-a,l);break;case 270:c=yt._rescaleAndSwap(m(this,Ts),i,r,-a,-l),d=yt._rescaleAndSwap(m(this,pr),i,r,-a,-l);break}return{outline:Array.from(c),points:[Array.from(d)]}}get box(){return m(this,_u)}newOutliner(t,n,i,r,o,a=0){return new aT(t,n,i,r,o,a)}getNewOutline(t,n){let[i,r,o,a]=m(this,_u),[l,c,d,u]=m(this,df),h=o*d,p=a*u,f=i*d+l,_=r*u+c,b=this.newOutliner({x:m(this,pr)[0]*h+f,y:m(this,pr)[1]*p+_},m(this,df),m(this,uy),t,m(this,dy),n??m(this,hl));for(let y=2;y<m(this,pr).length;y+=2)b.add({x:m(this,pr)[y]*h+f,y:m(this,pr)[y+1]*p+_});return b.getOutlines()}};df=new WeakMap,_u=new WeakMap,hl=new WeakMap,dy=new WeakMap,pr=new WeakMap,uy=new WeakMap,Ts=new WeakMap,CE=new WeakSet,PV=function(t){let n=m(this,Ts),i=n[4],r=n[5],o=i,a=r,l=i,c=r,d=i,u=r,h=t?Math.max:Math.min;for(let f=6,_=n.length;f<_;f+=6){if(isNaN(n[f]))o=Math.min(o,n[f+4]),a=Math.min(a,n[f+5]),l=Math.max(l,n[f+4]),c=Math.max(c,n[f+5]),u<n[f+5]?(d=n[f+4],u=n[f+5]):u===n[f+5]&&(d=h(d,n[f+4]));else{let b=At.bezierBoundingBox(i,r,...n.slice(f,f+6));o=Math.min(o,b[0]),a=Math.min(a,b[1]),l=Math.max(l,b[2]),c=Math.max(c,b[3]),u<b[3]?(d=b[2],u=b[3]):u===b[3]&&(d=h(d,b[2]))}i=n[f+4],r=n[f+5]}let p=m(this,_u);p[0]=o-m(this,hl),p[1]=a-m(this,hl),p[2]=l-o+2*m(this,hl),p[3]=c-a+2*m(this,hl),this.lastPoint=[d,u]};var hy,py,mc,vo,AE,kV,uf,CM,PE,IV,kE,DV,fy,Xk,Cg=class{constructor(e,t=0,n=0,i=!0){L(this,AE);L(this,uf);L(this,PE);L(this,kE);L(this,fy);L(this,hy,void 0);L(this,py,void 0);L(this,mc,[]);L(this,vo,[]);let r=1/0,o=-1/0,a=1/0,l=-1/0,d=10**-4;for(let{x:y,y:w,width:C,height:M}of e){let S=Math.floor((y-t)/d)*d,k=Math.ceil((y+C+t)/d)*d,T=Math.floor((w-t)/d)*d,P=Math.ceil((w+M+t)/d)*d,R=[S,T,P,!0],O=[k,T,P,!1];m(this,mc).push(R,O),r=Math.min(r,S),o=Math.max(o,k),a=Math.min(a,T),l=Math.max(l,P)}let u=o-r+2*n,h=l-a+2*n,p=r-n,f=a-n,_=m(this,mc).at(i?-1:-2),b=[_[0],_[2]];for(let y of m(this,mc)){let[w,C,M]=y;y[0]=(w-p)/u,y[1]=(C-f)/h,y[2]=(M-f)/h}N(this,hy,new Float32Array([p,f,u,h])),N(this,py,b)}getOutlines(){m(this,mc).sort((t,n)=>t[0]-n[0]||t[1]-n[1]||t[2]-n[2]);let e=[];for(let t of m(this,mc))t[3]?(e.push(...K(this,fy,Xk).call(this,t)),K(this,PE,IV).call(this,t)):(K(this,kE,DV).call(this,t),e.push(...K(this,fy,Xk).call(this,t)));return K(this,AE,kV).call(this,e)}};hy=new WeakMap,py=new WeakMap,mc=new WeakMap,vo=new WeakMap,AE=new WeakSet,kV=function(e){let t=[],n=new Set;for(let o of e){let[a,l,c]=o;t.push([a,l,o],[a,c,o])}t.sort((o,a)=>o[1]-a[1]||o[0]-a[0]);for(let o=0,a=t.length;o<a;o+=2){let l=t[o][2],c=t[o+1][2];l.push(c),c.push(l),n.add(l),n.add(c)}let i=[],r;for(;n.size>0;){let o=n.values().next().value,[a,l,c,d,u]=o;n.delete(o);let h=a,p=l;for(r=[a,c],i.push(r);;){let f;if(n.has(d))f=d;else if(n.has(u))f=u;else break;n.delete(f),[a,l,c,d,u]=f,h!==a&&(r.push(h,p,a,p===l?l:c),h=a),p=p===l?c:l}r.push(h,p)}return new Qk(i,m(this,hy),m(this,py))},uf=new WeakSet,CM=function(e){let t=m(this,vo),n=0,i=t.length-1;for(;n<=i;){let r=n+i>>1,o=t[r][0];if(o===e)return r;o<e?n=r+1:i=r-1}return i+1},PE=new WeakSet,IV=function([,e,t]){let n=K(this,uf,CM).call(this,e);m(this,vo).splice(n,0,[e,t])},kE=new WeakSet,DV=function([,e,t]){let n=K(this,uf,CM).call(this,e);for(let i=n;i<m(this,vo).length;i++){let[r,o]=m(this,vo)[i];if(r!==e)break;if(r===e&&o===t){m(this,vo).splice(i,1);return}}for(let i=n-1;i>=0;i--){let[r,o]=m(this,vo)[i];if(r!==e)break;if(r===e&&o===t){m(this,vo).splice(i,1);return}}},fy=new WeakSet,Xk=function(e){let[t,n,i]=e,r=[[t,n,i]],o=K(this,uf,CM).call(this,i);for(let a=0;a<o;a++){let[l,c]=m(this,vo)[a];for(let d=0,u=r.length;d<u;d++){let[,h,p]=r[d];if(!(c<=h||p<=l)){if(h>=l){if(p>c)r[d][1]=c;else{if(u===1)return[];r.splice(d,1),d--,u--}continue}r[d][2]=l,p>c&&r.push([t,c,p])}}}return r};var my,hf,Qk=class extends yt{constructor(t,n,i){super();L(this,my,void 0);L(this,hf,void 0);N(this,hf,t),N(this,my,n),this.lastPoint=i}toSVGPath(){let t=[];for(let n of m(this,hf)){let[i,r]=n;t.push(`M${i} ${r}`);for(let o=2;o<n.length;o+=2){let a=n[o],l=n[o+1];a===i?(t.push(`V${l}`),r=l):l===r&&(t.push(`H${a}`),i=a)}t.push("Z")}return t.join(" ")}serialize([t,n,i,r],o){let a=[],l=i-t,c=r-n;for(let d of m(this,hf)){let u=new Array(d.length);for(let h=0;h<d.length;h+=2)u[h]=t+d[h]*l,u[h+1]=r-d[h+1]*c;a.push(u)}return a}get box(){return m(this,my)}get classNamesForOutlining(){return["highlightOutline"]}};my=new WeakMap,hf=new WeakMap;var Ag=class extends aT{newFreeDrawOutline(e,t,n,i,r,o){return new Jk(e,t,n,i,r,o)}},Jk=class extends lT{newOutliner(e,t,n,i,r,o=0){return new Ag(e,t,n,i,r,o)}},bo,yu,pf,Us,gy,ff,_y,yy,gc,wo,mf,vy,by,Zk,wy,eI,My,tI,pl,md,IE,RV,ua,Gl,qi=class qi{constructor({editor:e=null,uiManager:t=null}){L(this,by);L(this,wy);L(this,My);L(this,pl);L(this,IE);L(this,ua);L(this,bo,null);L(this,yu,null);L(this,pf,void 0);L(this,Us,null);L(this,gy,!1);L(this,ff,!1);L(this,_y,null);L(this,yy,void 0);L(this,gc,null);L(this,wo,null);L(this,mf,void 0);e?(N(this,ff,!1),N(this,mf,mn.HIGHLIGHT_COLOR),N(this,_y,e)):(N(this,ff,!0),N(this,mf,mn.HIGHLIGHT_DEFAULT_COLOR)),N(this,wo,e?._uiManager||t),N(this,yy,m(this,wo)._eventBus),N(this,pf,e?.color||m(this,wo)?.highlightColors.values().next().value||"#FFFF98"),m(qi,vy)||N(qi,vy,Object.freeze({blue:"pdfjs-editor-colorpicker-blue",green:"pdfjs-editor-colorpicker-green",pink:"pdfjs-editor-colorpicker-pink",red:"pdfjs-editor-colorpicker-red",yellow:"pdfjs-editor-colorpicker-yellow"}))}static get _keyboardManager(){return an(this,"_keyboardManager",new Bu([[["Escape","mac+Escape"],qi.prototype._hideDropdownFromKeyboard],[[" ","mac+ "],qi.prototype._colorSelectFromKeyboard],[["ArrowDown","ArrowRight","mac+ArrowDown","mac+ArrowRight"],qi.prototype._moveToNext],[["ArrowUp","ArrowLeft","mac+ArrowUp","mac+ArrowLeft"],qi.prototype._moveToPrevious],[["Home","mac+Home"],qi.prototype._moveToBeginning],[["End","mac+End"],qi.prototype._moveToEnd]]))}renderButton(){let e=N(this,bo,document.createElement("button"));e.className="colorPicker",e.tabIndex="0",e.setAttribute("data-l10n-id","pdfjs-editor-colorpicker-button"),e.setAttribute("aria-haspopup",!0);let t=m(this,wo)._signal;e.addEventListener("click",K(this,pl,md).bind(this),{signal:t}),e.addEventListener("keydown",K(this,My,tI).bind(this),{signal:t});let n=N(this,yu,document.createElement("span"));return n.className="swatch",n.setAttribute("aria-hidden",!0),n.style.backgroundColor=m(this,pf),e.append(n),e}renderMainDropdown(){let e=N(this,Us,K(this,by,Zk).call(this));return e.setAttribute("aria-orientation","horizontal"),e.setAttribute("aria-labelledby","highlightColorPickerLabel"),e}_colorSelectFromKeyboard(e){if(e.target===m(this,bo)){K(this,pl,md).call(this,e);return}let t=e.target.getAttribute("data-color");t&&K(this,wy,eI).call(this,t,e)}_moveToNext(e){if(!m(this,ua,Gl)){K(this,pl,md).call(this,e);return}if(e.target===m(this,bo)){m(this,Us).firstChild?.focus();return}e.target.nextSibling?.focus()}_moveToPrevious(e){if(e.target===m(this,Us)?.firstChild||e.target===m(this,bo)){m(this,ua,Gl)&&this._hideDropdownFromKeyboard();return}m(this,ua,Gl)||K(this,pl,md).call(this,e),e.target.previousSibling?.focus()}_moveToBeginning(e){if(!m(this,ua,Gl)){K(this,pl,md).call(this,e);return}m(this,Us).firstChild?.focus()}_moveToEnd(e){if(!m(this,ua,Gl)){K(this,pl,md).call(this,e);return}m(this,Us).lastChild?.focus()}hideDropdown(){m(this,Us)?.classList.add("hidden"),m(this,gc)?.abort(),N(this,gc,null)}_hideDropdownFromKeyboard(){if(!m(this,ff)){if(!m(this,ua,Gl)){m(this,_y)?.unselect();return}this.hideDropdown(),m(this,bo).focus({preventScroll:!0,focusVisible:m(this,gy)})}}updateColor(e){if(m(this,yu)&&(m(this,yu).style.backgroundColor=e),!m(this,Us))return;let t=m(this,wo).highlightColors.values();for(let n of m(this,Us).children)n.setAttribute("aria-selected",t.next().value===e)}destroy(){m(this,bo)?.remove(),N(this,bo,null),N(this,yu,null),m(this,Us)?.remove(),N(this,Us,null)}};bo=new WeakMap,yu=new WeakMap,pf=new WeakMap,Us=new WeakMap,gy=new WeakMap,ff=new WeakMap,_y=new WeakMap,yy=new WeakMap,gc=new WeakMap,wo=new WeakMap,mf=new WeakMap,vy=new WeakMap,by=new WeakSet,Zk=function(){let e=document.createElement("div"),t=m(this,wo)._signal;e.addEventListener("contextmenu",So,{signal:t}),e.className="dropdown",e.role="listbox",e.setAttribute("aria-multiselectable",!1),e.setAttribute("aria-orientation","vertical"),e.setAttribute("data-l10n-id","pdfjs-editor-colorpicker-dropdown");for(let[n,i]of m(this,wo).highlightColors){let r=document.createElement("button");r.tabIndex="0",r.role="option",r.setAttribute("data-color",i),r.title=n,r.setAttribute("data-l10n-id",m(qi,vy)[n]);let o=document.createElement("span");r.append(o),o.className="swatch",o.style.backgroundColor=i,r.setAttribute("aria-selected",i===m(this,pf)),r.addEventListener("click",K(this,wy,eI).bind(this,i),{signal:t}),e.append(r)}return e.addEventListener("keydown",K(this,My,tI).bind(this),{signal:t}),e},wy=new WeakSet,eI=function(e,t){t.stopPropagation(),m(this,yy).dispatch("switchannotationeditorparams",{source:this,type:m(this,mf),value:e})},My=new WeakSet,tI=function(e){qi._keyboardManager.exec(this,e)},pl=new WeakSet,md=function(e){if(m(this,ua,Gl)){this.hideDropdown();return}if(N(this,gy,e.detail===0),m(this,gc)||(N(this,gc,new AbortController),window.addEventListener("pointerdown",K(this,IE,RV).bind(this),{signal:m(this,wo).combinedSignal(m(this,gc))})),m(this,Us)){m(this,Us).classList.remove("hidden");return}let t=N(this,Us,K(this,by,Zk).call(this));m(this,bo).append(t)},IE=new WeakSet,RV=function(e){m(this,Us)?.contains(e.target)||this.hideDropdown()},ua=new WeakSet,Gl=function(){return m(this,Us)&&!m(this,Us).classList.contains("hidden")},L(qi,vy,null);var cT=qi,gf,Ty,fl,vu,_f,Xi,Ey,xy,bu,$r,fr,li,yf,ml,Mi,vf,Br,Sy,Cy,nI,bf,AM,DE,FV,RE,LV,FE,NV,Ay,sI,gl,gd,_c,tp,LE,OV,wf,PM,wu,ag,NE,$V,OE,BV,$E,zV,BE,UV,zE,VV,wn=class wn extends ls{constructor(t){super({...t,name:"highlightEditor"});L(this,Cy);L(this,bf);L(this,DE);L(this,RE);L(this,FE);L(this,Ay);L(this,gl);L(this,LE);L(this,wf);L(this,wu);L(this,NE);L(this,OE);L(this,zE);L(this,gf,null);L(this,Ty,0);L(this,fl,void 0);L(this,vu,null);L(this,_f,null);L(this,Xi,null);L(this,Ey,null);L(this,xy,0);L(this,bu,null);L(this,$r,null);L(this,fr,null);L(this,li,!1);L(this,yf,null);L(this,ml,void 0);L(this,Mi,null);L(this,vf,"");L(this,Br,void 0);L(this,Sy,"");this.color=t.color||wn._defaultColor,N(this,Br,t.thickness||wn._defaultThickness),N(this,ml,t.opacity||wn._defaultOpacity),N(this,fl,t.boxes||null),N(this,Sy,t.methodOfCreation||""),N(this,vf,t.text||""),this._isDraggable=!1,t.highlightId>-1?(N(this,li,!0),K(this,bf,AM).call(this,t),K(this,gl,gd).call(this)):m(this,fl)&&(N(this,gf,t.anchorNode),N(this,Ty,t.anchorOffset),N(this,Ey,t.focusNode),N(this,xy,t.focusOffset),K(this,Cy,nI).call(this),K(this,gl,gd).call(this),this.rotate(this.rotation))}static get _keyboardManager(){let t=wn.prototype;return an(this,"_keyboardManager",new Bu([[["ArrowLeft","mac+ArrowLeft"],t._moveCaret,{args:[0]}],[["ArrowRight","mac+ArrowRight"],t._moveCaret,{args:[1]}],[["ArrowUp","mac+ArrowUp"],t._moveCaret,{args:[2]}],[["ArrowDown","mac+ArrowDown"],t._moveCaret,{args:[3]}]]))}get telemetryInitialData(){return{action:"added",type:m(this,li)?"free_highlight":"highlight",color:this._uiManager.highlightColorNames.get(this.color),thickness:m(this,Br),methodOfCreation:m(this,Sy)}}get telemetryFinalData(){return{type:"highlight",color:this._uiManager.highlightColorNames.get(this.color)}}static computeTelemetryFinalData(t){return{numberOfColors:t.get("color").size}}static initialize(t,n){ls.initialize(t,n),wn._defaultColor||(wn._defaultColor=n.highlightColors?.values().next().value||"#fff066")}static updateDefaultParams(t,n){switch(t){case mn.HIGHLIGHT_DEFAULT_COLOR:wn._defaultColor=n;break;case mn.HIGHLIGHT_THICKNESS:wn._defaultThickness=n;break}}translateInPage(t,n){}get toolbarPosition(){return m(this,yf)}updateParams(t,n){switch(t){case mn.HIGHLIGHT_COLOR:K(this,DE,FV).call(this,n);break;case mn.HIGHLIGHT_THICKNESS:K(this,RE,LV).call(this,n);break}}static get defaultPropertiesToUpdate(){return[[mn.HIGHLIGHT_DEFAULT_COLOR,wn._defaultColor],[mn.HIGHLIGHT_THICKNESS,wn._defaultThickness]]}get propertiesToUpdate(){return[[mn.HIGHLIGHT_COLOR,this.color||wn._defaultColor],[mn.HIGHLIGHT_THICKNESS,m(this,Br)||wn._defaultThickness],[mn.HIGHLIGHT_FREE,m(this,li)]]}async addEditToolbar(){let t=await super.addEditToolbar();return t?(this._uiManager.highlightColors&&(N(this,_f,new cT({editor:this})),t.addColorPicker(m(this,_f))),t):null}disableEditing(){super.disableEditing(),this.div.classList.toggle("disabled",!0)}enableEditing(){super.enableEditing(),this.div.classList.toggle("disabled",!1)}fixAndSetPosition(){return super.fixAndSetPosition(K(this,wu,ag).call(this))}getBaseTranslation(){return[0,0]}getRect(t,n){return super.getRect(t,n,K(this,wu,ag).call(this))}onceAdded(t){this.annotationElementId||this.parent.addUndoableEditor(this),t&&this.div.focus()}remove(){K(this,Ay,sI).call(this),this._reportTelemetry({action:"deleted"}),super.remove()}rebuild(){this.parent&&(super.rebuild(),this.div!==null&&(K(this,gl,gd).call(this),this.isAttachedToDOM||this.parent.add(this)))}setParent(t){let n=!1;this.parent&&!t?K(this,Ay,sI).call(this):t&&(K(this,gl,gd).call(this,t),n=!this.parent&&this.div?.classList.contains("selectedEditor")),super.setParent(t),this.show(this._isVisible),n&&this.select()}rotate(t){var r,o,a;let{drawLayer:n}=this.parent,i;m(this,li)?(t=(t-this.rotation+360)%360,i=K(r=wn,_c,tp).call(r,m(this,$r).box,t)):i=K(o=wn,_c,tp).call(o,[this.x,this.y,this.width,this.height],t),n.updateProperties(m(this,fr),{bbox:i,root:{"data-main-rotation":t}}),n.updateProperties(m(this,Mi),{bbox:K(a=wn,_c,tp).call(a,m(this,Xi).box,t),root:{"data-main-rotation":t}})}render(){if(this.div)return this.div;let t=super.render();m(this,vf)&&(t.setAttribute("aria-label",m(this,vf)),t.setAttribute("role","mark")),m(this,li)?t.classList.add("free"):this.div.addEventListener("keydown",K(this,LE,OV).bind(this),{signal:this._uiManager._signal});let n=N(this,bu,document.createElement("div"));t.append(n),n.setAttribute("aria-hidden","true"),n.className="internal",n.style.clipPath=m(this,vu);let[i,r]=this.parentDimensions;return this.setDims(this.width*i,this.height*r),$M(this,m(this,bu),["pointerover","pointerleave"]),this.enableEditing(),t}pointerover(){this.isSelected||this.parent?.drawLayer.updateProperties(m(this,Mi),{rootClass:{hovered:!0}})}pointerleave(){this.isSelected||this.parent?.drawLayer.updateProperties(m(this,Mi),{rootClass:{hovered:!1}})}_moveCaret(t){switch(this.parent.unselect(this),t){case 0:case 2:K(this,wf,PM).call(this,!0);break;case 1:case 3:K(this,wf,PM).call(this,!1);break}}select(){super.select(),m(this,Mi)&&this.parent?.drawLayer.updateProperties(m(this,Mi),{rootClass:{hovered:!1,selected:!0}})}unselect(){super.unselect(),m(this,Mi)&&(this.parent?.drawLayer.updateProperties(m(this,Mi),{rootClass:{selected:!1}}),m(this,li)||K(this,wf,PM).call(this,!1))}get _mustFixPosition(){return!m(this,li)}show(t=this._isVisible){super.show(t),this.parent&&(this.parent.drawLayer.updateProperties(m(this,fr),{rootClass:{hidden:!t}}),this.parent.drawLayer.updateProperties(m(this,Mi),{rootClass:{hidden:!t}}))}static startHighlighting(t,n,{target:i,x:r,y:o}){let{x:a,y:l,width:c,height:d}=i.getBoundingClientRect(),u=new AbortController,h=t.combinedSignal(u),p=f=>{u.abort(),K(this,BE,UV).call(this,t,f)};window.addEventListener("blur",p,{signal:h}),window.addEventListener("pointerup",p,{signal:h}),window.addEventListener("pointerdown",vr,{capture:!0,passive:!1,signal:h}),window.addEventListener("contextmenu",So,{signal:h}),i.addEventListener("pointermove",K(this,$E,zV).bind(this,t),{signal:h}),this._freeHighlight=new Ag({x:r,y:o},[a,l,c,d],t.scale,this._defaultThickness/2,n,.001),{id:this._freeHighlightId,clipPathId:this._freeHighlightClipId}=t.drawLayer.draw({bbox:[0,0,1,1],root:{viewBox:"0 0 1 1",fill:this._defaultColor,"fill-opacity":this._defaultOpacity},rootClass:{highlight:!0,free:!0},path:{d:this._freeHighlight.toSVGPath()}},!0,!0)}static async deserialize(t,n,i){var _,b,y,w;let r=null;if(t instanceof rT){let{data:{quadPoints:C,rect:M,rotation:S,id:k,color:T,opacity:P,popupRef:R},parent:{page:{pageNumber:O}}}=t;r=t={annotationType:Qt.HIGHLIGHT,color:Array.from(T),opacity:P,quadPoints:C,boxes:null,pageIndex:O-1,rect:M.slice(0),rotation:S,id:k,deleted:!1,popupRef:R}}else if(t instanceof Sg){let{data:{inkLists:C,rect:M,rotation:S,id:k,color:T,borderStyle:{rawWidth:P},popupRef:R},parent:{page:{pageNumber:O}}}=t;r=t={annotationType:Qt.HIGHLIGHT,color:Array.from(T),thickness:P,inkLists:C,boxes:null,pageIndex:O-1,rect:M.slice(0),rotation:S,id:k,deleted:!1,popupRef:R}}let{color:o,quadPoints:a,inkLists:l,opacity:c}=t,d=await super.deserialize(t,n,i);d.color=At.makeHexColor(...o),N(d,ml,c||1),l&&N(d,Br,t.thickness),d.annotationElementId=t.id||null,d._initialData=r;let[u,h]=d.pageDimensions,[p,f]=d.pageTranslation;if(a){let C=N(d,fl,[]);for(let M=0;M<a.length;M+=8)C.push({x:(a[M]-p)/u,y:1-(a[M+1]-f)/h,width:(a[M+2]-a[M])/u,height:(a[M+1]-a[M+5])/h});K(_=d,Cy,nI).call(_),K(b=d,gl,gd).call(b),d.rotate(d.rotation)}else if(l){N(d,li,!0);let C=l[0],M={x:C[0]-p,y:h-(C[1]-f)},S=new Ag(M,[0,0,u,h],1,m(d,Br)/2,!0,.001);for(let P=0,R=C.length;P<R;P+=2)M.x=C[P]-p,M.y=h-(C[P+1]-f),S.add(M);let{id:k,clipPathId:T}=n.drawLayer.draw({bbox:[0,0,1,1],root:{viewBox:"0 0 1 1",fill:d.color,"fill-opacity":d._defaultOpacity},rootClass:{highlight:!0,free:!0},path:{d:S.toSVGPath()}},!0,!0);K(y=d,bf,AM).call(y,{highlightOutlines:S.getOutlines(),highlightId:k,clipPathId:T}),K(w=d,gl,gd).call(w)}return d}serialize(t=!1){if(this.isEmpty()||t)return null;if(this.deleted)return this.serializeDeleted();let n=this.getRect(0,0),i=ls._colorManager.convert(this.color),r={annotationType:Qt.HIGHLIGHT,color:i,opacity:m(this,ml),thickness:m(this,Br),quadPoints:K(this,NE,$V).call(this),outlines:K(this,OE,BV).call(this,n),pageIndex:this.pageIndex,rect:n,rotation:K(this,wu,ag).call(this),structTreeParentId:this._structTreeParentId};return this.annotationElementId&&!K(this,zE,VV).call(this,r)?null:(r.id=this.annotationElementId,r)}renderAnnotationElement(t){return t.updateEdited({rect:this.getRect(0,0)}),null}static canCreateNewEmptyEditor(){return!1}};gf=new WeakMap,Ty=new WeakMap,fl=new WeakMap,vu=new WeakMap,_f=new WeakMap,Xi=new WeakMap,Ey=new WeakMap,xy=new WeakMap,bu=new WeakMap,$r=new WeakMap,fr=new WeakMap,li=new WeakMap,yf=new WeakMap,ml=new WeakMap,Mi=new WeakMap,vf=new WeakMap,Br=new WeakMap,Sy=new WeakMap,Cy=new WeakSet,nI=function(){let t=new Cg(m(this,fl),.001);N(this,$r,t.getOutlines()),[this.x,this.y,this.width,this.height]=m(this,$r).box;let n=new Cg(m(this,fl),.0025,.001,this._uiManager.direction==="ltr");N(this,Xi,n.getOutlines());let{lastPoint:i}=m(this,Xi);N(this,yf,[(i[0]-this.x)/this.width,(i[1]-this.y)/this.height])},bf=new WeakSet,AM=function({highlightOutlines:t,highlightId:n,clipPathId:i}){var u,h;if(N(this,$r,t),N(this,Xi,t.getNewOutline(m(this,Br)/2+1.5,.0025)),n>=0)N(this,fr,n),N(this,vu,i),this.parent.drawLayer.finalizeDraw(n,{bbox:t.box,path:{d:t.toSVGPath()}}),N(this,Mi,this.parent.drawLayer.drawOutline({rootClass:{highlightOutline:!0,free:!0},bbox:m(this,Xi).box,path:{d:m(this,Xi).toSVGPath()}},!0));else if(this.parent){let p=this.parent.viewport.rotation;this.parent.drawLayer.updateProperties(m(this,fr),{bbox:K(u=wn,_c,tp).call(u,m(this,$r).box,(p-this.rotation+360)%360),path:{d:t.toSVGPath()}}),this.parent.drawLayer.updateProperties(m(this,Mi),{bbox:K(h=wn,_c,tp).call(h,m(this,Xi).box,p),path:{d:m(this,Xi).toSVGPath()}})}let[o,a,l,c]=t.box;switch(this.rotation){case 0:this.x=o,this.y=a,this.width=l,this.height=c;break;case 90:{let[p,f]=this.parentDimensions;this.x=a,this.y=1-o,this.width=l*f/p,this.height=c*p/f;break}case 180:this.x=1-o,this.y=1-a,this.width=l,this.height=c;break;case 270:{let[p,f]=this.parentDimensions;this.x=1-a,this.y=o,this.width=l*f/p,this.height=c*p/f;break}}let{lastPoint:d}=m(this,Xi);N(this,yf,[(d[0]-o)/l,(d[1]-a)/c])},DE=new WeakSet,FV=function(t){let n=(o,a)=>{this.color=o,N(this,ml,a),this.parent?.drawLayer.updateProperties(m(this,fr),{root:{fill:o,"fill-opacity":a}}),m(this,_f)?.updateColor(o)},i=this.color,r=m(this,ml);this.addCommands({cmd:n.bind(this,t,wn._defaultOpacity),undo:n.bind(this,i,r),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:mn.HIGHLIGHT_COLOR,overwriteIfSameType:!0,keepUndo:!0}),this._reportTelemetry({action:"color_changed",color:this._uiManager.highlightColorNames.get(t)},!0)},RE=new WeakSet,LV=function(t){let n=m(this,Br),i=r=>{N(this,Br,r),K(this,FE,NV).call(this,r)};this.addCommands({cmd:i.bind(this,t),undo:i.bind(this,n),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:mn.INK_THICKNESS,overwriteIfSameType:!0,keepUndo:!0}),this._reportTelemetry({action:"thickness_changed",thickness:t},!0)},FE=new WeakSet,NV=function(t){if(!m(this,li))return;K(this,bf,AM).call(this,{highlightOutlines:m(this,$r).getNewOutline(t/2)}),this.fixAndSetPosition();let[n,i]=this.parentDimensions;this.setDims(this.width*n,this.height*i)},Ay=new WeakSet,sI=function(){m(this,fr)===null||!this.parent||(this.parent.drawLayer.remove(m(this,fr)),N(this,fr,null),this.parent.drawLayer.remove(m(this,Mi)),N(this,Mi,null))},gl=new WeakSet,gd=function(t=this.parent){m(this,fr)===null&&({id:Ii(this,fr)._,clipPathId:Ii(this,vu)._}=t.drawLayer.draw({bbox:m(this,$r).box,root:{viewBox:"0 0 1 1",fill:this.color,"fill-opacity":m(this,ml)},rootClass:{highlight:!0,free:m(this,li)},path:{d:m(this,$r).toSVGPath()}},!1,!0),N(this,Mi,t.drawLayer.drawOutline({rootClass:{highlightOutline:!0,free:m(this,li)},bbox:m(this,Xi).box,path:{d:m(this,Xi).toSVGPath()}},m(this,li))),m(this,bu)&&(m(this,bu).style.clipPath=m(this,vu)))},_c=new WeakSet,tp=function([t,n,i,r],o){switch(o){case 90:return[1-n-r,t,r,i];case 180:return[1-t-i,1-n-r,i,r];case 270:return[n,1-t-i,r,i]}return[t,n,i,r]},LE=new WeakSet,OV=function(t){wn._keyboardManager.exec(this,t)},wf=new WeakSet,PM=function(t){if(!m(this,gf))return;let n=window.getSelection();t?n.setPosition(m(this,gf),m(this,Ty)):n.setPosition(m(this,Ey),m(this,xy))},wu=new WeakSet,ag=function(){return m(this,li)?this.rotation:0},NE=new WeakSet,$V=function(){if(m(this,li))return null;let[t,n]=this.pageDimensions,[i,r]=this.pageTranslation,o=m(this,fl),a=new Float32Array(o.length*8),l=0;for(let{x:c,y:d,width:u,height:h}of o){let p=c*t+i,f=(1-d)*n+r;a[l]=a[l+4]=p,a[l+1]=a[l+3]=f,a[l+2]=a[l+6]=p+u*t,a[l+5]=a[l+7]=f-h*n,l+=8}return a},OE=new WeakSet,BV=function(t){return m(this,$r).serialize(t,K(this,wu,ag).call(this))},$E=new WeakSet,zV=function(t,n){this._freeHighlight.add(n)&&t.drawLayer.updateProperties(this._freeHighlightId,{path:{d:this._freeHighlight.toSVGPath()}})},BE=new WeakSet,UV=function(t,n){this._freeHighlight.isEmpty()?t.drawLayer.remove(this._freeHighlightId):t.createAndAddNewEditor(n,!1,{highlightId:this._freeHighlightId,highlightOutlines:this._freeHighlight.getOutlines(),clipPathId:this._freeHighlightClipId,methodOfCreation:"main_toolbar"}),this._freeHighlightId=-1,this._freeHighlight=null,this._freeHighlightClipId=""},zE=new WeakSet,VV=function(t){let{color:n}=this._initialData;return t.color.some((i,r)=>i!==n[r])},L(wn,_c),L(wn,$E),L(wn,BE),Z(wn,"_defaultColor",null),Z(wn,"_defaultOpacity",1),Z(wn,"_defaultThickness",12),Z(wn,"_type","highlight"),Z(wn,"_editorType",Qt.HIGHLIGHT),Z(wn,"_freeHighlightId",-1),Z(wn,"_freeHighlight",null),Z(wn,"_freeHighlightClipId","");var dT=wn,Mu,iI=class{constructor(){L(this,Mu,Object.create(null))}updateProperty(e,t){this[e]=t,this.updateSVGProperty(e,t)}updateProperties(e){if(e)for(let[t,n]of Object.entries(e))this.updateProperty(t,n)}updateSVGProperty(e,t){m(this,Mu)[e]=t}toSVGProperties(){let e=m(this,Mu);return N(this,Mu,Object.create(null)),{root:e}}reset(){N(this,Mu,Object.create(null))}updateAll(e=this){this.updateProperties(e)}clone(){zn("Not implemented")}};Mu=new WeakMap;var mr,Mf,Zs,Tu,Eu,yc,vc,bc,xu,Py,oI,ky,aI,Iy,lI,Su,lg,UE,GV,Tf,kM,Cu,cg,wc,np,Tt=class Tt extends ls{constructor(t){super(t);L(this,Py);L(this,ky);L(this,Iy);L(this,Su);L(this,UE);L(this,Tf);L(this,Cu);L(this,wc);L(this,mr,null);L(this,Mf,void 0);Z(this,"_drawId",null);N(this,Mf,t.mustBeCommitted||!1),t.drawOutlines&&(K(this,Py,oI).call(this,t),K(this,Su,lg).call(this))}static _mergeSVGProperties(t,n){let i=new Set(Object.keys(t));for(let[r,o]of Object.entries(n))i.has(r)?Object.assign(t[r],o):t[r]=o;return t}static getDefaultDrawingOptions(t){zn("Not implemented")}static get typesMap(){zn("Not implemented")}static get isDrawer(){return!0}static get supportMultipleDrawings(){return!1}static updateDefaultParams(t,n){let i=this.typesMap.get(t);i&&this._defaultDrawingOptions.updateProperty(i,n),this._currentParent&&(m(Tt,Zs).updateProperty(i,n),this._currentParent.drawLayer.updateProperties(this._currentDrawId,this._defaultDrawingOptions.toSVGProperties()))}updateParams(t,n){let i=this.constructor.typesMap.get(t);i&&this._updateProperty(t,i,n)}static get defaultPropertiesToUpdate(){let t=[],n=this._defaultDrawingOptions;for(let[i,r]of this.typesMap)t.push([i,n[r]]);return t}get propertiesToUpdate(){let t=[],{_drawingOptions:n}=this;for(let[i,r]of this.constructor.typesMap)t.push([i,n[r]]);return t}_updateProperty(t,n,i){let r=this._drawingOptions,o=r[n],a=l=>{r.updateProperty(n,l);let c=m(this,mr).updateProperty(n,l);c&&K(this,Cu,cg).call(this,c),this.parent?.drawLayer.updateProperties(this._drawId,r.toSVGProperties())};this.addCommands({cmd:a.bind(this,i),undo:a.bind(this,o),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:t,overwriteIfSameType:!0,keepUndo:!0})}_onResizing(){this.parent?.drawLayer.updateProperties(this._drawId,Tt._mergeSVGProperties(m(this,mr).getPathResizingSVGProperties(K(this,Tf,kM).call(this)),{bbox:K(this,wc,np).call(this)}))}_onResized(){this.parent?.drawLayer.updateProperties(this._drawId,Tt._mergeSVGProperties(m(this,mr).getPathResizedSVGProperties(K(this,Tf,kM).call(this)),{bbox:K(this,wc,np).call(this)}))}_onTranslating(t,n){this.parent?.drawLayer.updateProperties(this._drawId,{bbox:K(this,wc,np).call(this,t,n)})}_onTranslated(){this.parent?.drawLayer.updateProperties(this._drawId,Tt._mergeSVGProperties(m(this,mr).getPathTranslatedSVGProperties(K(this,Tf,kM).call(this),this.parentDimensions),{bbox:K(this,wc,np).call(this)}))}_onStartDragging(){this.parent?.drawLayer.updateProperties(this._drawId,{rootClass:{moving:!0}})}_onStopDragging(){this.parent?.drawLayer.updateProperties(this._drawId,{rootClass:{moving:!1}})}commit(){super.commit(),this.disableEditMode(),this.disableEditing()}disableEditing(){super.disableEditing(),this.div.classList.toggle("disabled",!0)}enableEditing(){super.enableEditing(),this.div.classList.toggle("disabled",!1)}getBaseTranslation(){return[0,0]}get isResizable(){return!0}onceAdded(t){this.annotationElementId||this.parent.addUndoableEditor(this),this._isDraggable=!0,m(this,Mf)&&(N(this,Mf,!1),this.commit(),this.parent.setSelected(this),t&&this.isOnScreen&&this.div.focus())}remove(){K(this,Iy,lI).call(this),super.remove()}rebuild(){this.parent&&(super.rebuild(),this.div!==null&&(K(this,Su,lg).call(this),K(this,Cu,cg).call(this,m(this,mr).box),this.isAttachedToDOM||this.parent.add(this)))}setParent(t){let n=!1;this.parent&&!t?(this._uiManager.removeShouldRescale(this),K(this,Iy,lI).call(this)):t&&(this._uiManager.addShouldRescale(this),K(this,Su,lg).call(this,t),n=!this.parent&&this.div?.classList.contains("selectedEditor")),super.setParent(t),n&&this.select()}rotate(){this.parent&&this.parent.drawLayer.updateProperties(this._drawId,Tt._mergeSVGProperties({bbox:K(this,wc,np).call(this)},m(this,mr).updateRotation((this.parentRotation-this.rotation+360)%360)))}onScaleChanging(){this.parent&&K(this,Cu,cg).call(this,m(this,mr).updateParentDimensions(this.parentDimensions,this.parent.scale))}static onScaleChangingWhenDrawing(){}render(){if(this.div)return this.div;let t=super.render();t.classList.add("draw");let n=document.createElement("div");t.append(n),n.setAttribute("aria-hidden","true"),n.className="internal";let[i,r]=this.parentDimensions;return this.setDims(this.width*i,this.height*r),this._uiManager.addShouldRescale(this),this.disableEditing(),t}static createDrawerInstance(t,n,i,r,o){zn("Not implemented")}static startDrawing(t,n,i,r){let{target:o,offsetX:a,offsetY:l,pointerId:c,pointerType:d}=r;if(m(Tt,vc)&&m(Tt,vc)!==d)return;let{viewport:{rotation:u}}=t,{width:h,height:p}=o.getBoundingClientRect(),f=N(Tt,Tu,new AbortController),_=t.combinedSignal(f);if(m(Tt,yc)||N(Tt,yc,c),m(Tt,vc)??N(Tt,vc,d),window.addEventListener("pointerup",b=>{m(Tt,yc)===b.pointerId?this._endDraw(b):m(Tt,bc)?.delete(b.pointerId)},{signal:_}),window.addEventListener("pointercancel",b=>{m(Tt,yc)===b.pointerId?this._currentParent.endDrawingSession():m(Tt,bc)?.delete(b.pointerId)},{signal:_}),window.addEventListener("pointerdown",b=>{m(Tt,vc)===b.pointerType&&((m(Tt,bc)||N(Tt,bc,new Set)).add(b.pointerId),m(Tt,Zs).isCancellable()&&(m(Tt,Zs).removeLastElement(),m(Tt,Zs).isEmpty()?this._currentParent.endDrawingSession(!0):this._endDraw(null)))},{capture:!0,passive:!1,signal:_}),window.addEventListener("contextmenu",So,{signal:_}),o.addEventListener("pointermove",this._drawMove.bind(this),{signal:_}),o.addEventListener("touchmove",b=>{b.timeStamp===m(Tt,xu)&&vr(b)},{signal:_}),t.toggleDrawing(),n._editorUndoBar?.hide(),m(Tt,Zs)){t.drawLayer.updateProperties(this._currentDrawId,m(Tt,Zs).startNew(a,l,h,p,u));return}n.updateUIForDefaultProperties(this),N(Tt,Zs,this.createDrawerInstance(a,l,h,p,u)),N(Tt,Eu,this.getDefaultDrawingOptions()),this._currentParent=t,{id:this._currentDrawId}=t.drawLayer.draw(this._mergeSVGProperties(m(Tt,Eu).toSVGProperties(),m(Tt,Zs).defaultSVGProperties),!0,!1)}static _drawMove(t){if(N(Tt,xu,-1),!m(Tt,Zs))return;let{offsetX:n,offsetY:i,pointerId:r}=t;if(m(Tt,yc)===r){if(m(Tt,bc)?.size>=1){this._endDraw(t);return}this._currentParent.drawLayer.updateProperties(this._currentDrawId,m(Tt,Zs).add(n,i)),N(Tt,xu,t.timeStamp),vr(t)}}static _cleanup(t){t&&(this._currentDrawId=-1,this._currentParent=null,N(Tt,Zs,null),N(Tt,Eu,null),N(Tt,vc,null),N(Tt,xu,NaN)),m(Tt,Tu)&&(m(Tt,Tu).abort(),N(Tt,Tu,null),N(Tt,yc,NaN),N(Tt,bc,null))}static _endDraw(t){let n=this._currentParent;if(n){if(n.toggleDrawing(!0),this._cleanup(!1),t&&n.drawLayer.updateProperties(this._currentDrawId,m(Tt,Zs).end(t.offsetX,t.offsetY)),this.supportMultipleDrawings){let i=m(Tt,Zs),r=this._currentDrawId,o=i.getLastElement();n.addCommands({cmd:()=>{n.drawLayer.updateProperties(r,i.setLastElement(o))},undo:()=>{n.drawLayer.updateProperties(r,i.removeLastElement())},mustExec:!1,type:mn.DRAW_STEP});return}this.endDrawing(!1)}}static endDrawing(t){let n=this._currentParent;if(!n)return null;if(n.toggleDrawing(!0),n.cleanUndoStack(mn.DRAW_STEP),!m(Tt,Zs).isEmpty()){let{pageDimensions:[i,r],scale:o}=n,a=n.createAndAddNewEditor({offsetX:0,offsetY:0},!1,{drawId:this._currentDrawId,drawOutlines:m(Tt,Zs).getOutlines(i*o,r*o,o,this._INNER_MARGIN),drawingOptions:m(Tt,Eu),mustBeCommitted:!t});return this._cleanup(!0),a}return n.drawLayer.remove(this._currentDrawId),this._cleanup(!0),null}createDrawingOptions(t){}static deserializeDraw(t,n,i,r,o,a){zn("Not implemented")}static async deserialize(t,n,i){var u,h;let{rawDims:{pageWidth:r,pageHeight:o,pageX:a,pageY:l}}=n.viewport,c=this.deserializeDraw(a,l,r,o,this._INNER_MARGIN,t),d=await super.deserialize(t,n,i);return d.createDrawingOptions(t),K(u=d,Py,oI).call(u,{drawOutlines:c}),K(h=d,Su,lg).call(h),d.onScaleChanging(),d.rotate(),d}serializeDraw(t){let[n,i]=this.pageTranslation,[r,o]=this.pageDimensions;return m(this,mr).serialize([n,i,r,o],t)}renderAnnotationElement(t){return t.updateEdited({rect:this.getRect(0,0)}),null}static canCreateNewEmptyEditor(){return!1}};mr=new WeakMap,Mf=new WeakMap,Zs=new WeakMap,Tu=new WeakMap,Eu=new WeakMap,yc=new WeakMap,vc=new WeakMap,bc=new WeakMap,xu=new WeakMap,Py=new WeakSet,oI=function({drawOutlines:t,drawId:n,drawingOptions:i}){N(this,mr,t),this._drawingOptions||(this._drawingOptions=i),n>=0?(this._drawId=n,this.parent.drawLayer.finalizeDraw(n,t.defaultProperties)):this._drawId=K(this,ky,aI).call(this,t,this.parent),K(this,Cu,cg).call(this,t.box)},ky=new WeakSet,aI=function(t,n){let{id:i}=n.drawLayer.draw(Tt._mergeSVGProperties(this._drawingOptions.toSVGProperties(),t.defaultSVGProperties),!1,!1);return i},Iy=new WeakSet,lI=function(){this._drawId===null||!this.parent||(this.parent.drawLayer.remove(this._drawId),this._drawId=null,this._drawingOptions.reset())},Su=new WeakSet,lg=function(t=this.parent){if(!(this._drawId!==null&&this.parent===t)){if(this._drawId!==null){this.parent.drawLayer.updateParent(this._drawId,t.drawLayer);return}this._drawingOptions.updateAll(),this._drawId=K(this,ky,aI).call(this,m(this,mr),t)}},UE=new WeakSet,GV=function([t,n,i,r]){let{parentDimensions:[o,a],rotation:l}=this;switch(l){case 90:return[n,1-t,i*(a/o),r*(o/a)];case 180:return[1-t,1-n,i,r];case 270:return[1-n,t,i*(a/o),r*(o/a)];default:return[t,n,i,r]}},Tf=new WeakSet,kM=function(){let{x:t,y:n,width:i,height:r,parentDimensions:[o,a],rotation:l}=this;switch(l){case 90:return[1-n,t,i*(o/a),r*(a/o)];case 180:return[1-t,1-n,i,r];case 270:return[n,1-t,i*(o/a),r*(a/o)];default:return[t,n,i,r]}},Cu=new WeakSet,cg=function(t){if([this.x,this.y,this.width,this.height]=K(this,UE,GV).call(this,t),this.div){this.fixAndSetPosition();let[n,i]=this.parentDimensions;this.setDims(this.width*n,this.height*i)}this._onResized()},wc=new WeakSet,np=function(){let{x:t,y:n,width:i,height:r,rotation:o,parentRotation:a,parentDimensions:[l,c]}=this;switch((o*4+a)/90){case 1:return[1-n-r,t,r,i];case 2:return[1-t-i,1-n-r,i,r];case 3:return[n,1-t-i,r,i];case 4:return[t,n-i*(l/c),r*(c/l),i*(l/c)];case 5:return[1-n,t,i*(l/c),r*(c/l)];case 6:return[1-t-r*(c/l),1-n,r*(c/l),i*(l/c)];case 7:return[n-i*(l/c),1-t-r*(c/l),i*(l/c),r*(c/l)];case 8:return[t-i,n-r,i,r];case 9:return[1-n,t-i,r,i];case 10:return[1-t,1-n,i,r];case 11:return[n-r,1-t,r,i];case 12:return[t-r*(c/l),n,r*(c/l),i*(l/c)];case 13:return[1-n-i*(l/c),t-r*(c/l),i*(l/c),r*(c/l)];case 14:return[1-t,1-n-i*(l/c),r*(c/l),i*(l/c)];case 15:return[n,1-t,i*(l/c),r*(c/l)];default:return[t,n,i,r]}},Z(Tt,"_currentDrawId",-1),Z(Tt,"_currentParent",null),L(Tt,Zs,null),L(Tt,Tu,null),L(Tt,Eu,null),L(Tt,yc,NaN),L(Tt,vc,null),L(Tt,bc,null),L(Tt,xu,NaN),Z(Tt,"_INNER_MARGIN",3);var rI=Tt,ha,ei,ti,Au,Ef,Li,ci,zr,Pu,ku,Iu,xf,IM,cI=class{constructor(e,t,n,i,r,o){L(this,xf);L(this,ha,new Float64Array(6));L(this,ei,void 0);L(this,ti,void 0);L(this,Au,void 0);L(this,Ef,void 0);L(this,Li,void 0);L(this,ci,"");L(this,zr,0);L(this,Pu,new uT);L(this,ku,void 0);L(this,Iu,void 0);N(this,ku,n),N(this,Iu,i),N(this,Au,r),N(this,Ef,o),[e,t]=K(this,xf,IM).call(this,e,t);let a=N(this,ei,[NaN,NaN,NaN,NaN,e,t]);N(this,Li,[e,t]),N(this,ti,[{line:a,points:m(this,Li)}]),m(this,ha).set(a,0)}updateProperty(e,t){e==="stroke-width"&&N(this,Ef,t)}isEmpty(){return!m(this,ti)||m(this,ti).length===0}isCancellable(){return m(this,Li).length<=10}add(e,t){[e,t]=K(this,xf,IM).call(this,e,t);let[n,i,r,o]=m(this,ha).subarray(2,6),a=e-r,l=t-o;return Math.hypot(m(this,ku)*a,m(this,Iu)*l)<=2?null:(m(this,Li).push(e,t),isNaN(n)?(m(this,ha).set([r,o,e,t],2),m(this,ei).push(NaN,NaN,NaN,NaN,e,t),{path:{d:this.toSVGPath()}}):(isNaN(m(this,ha)[0])&&m(this,ei).splice(6,6),m(this,ha).set([n,i,r,o,e,t],0),m(this,ei).push(...yt.createBezierPoints(n,i,r,o,e,t)),{path:{d:this.toSVGPath()}}))}end(e,t){let n=this.add(e,t);return n||(m(this,Li).length===2?{path:{d:this.toSVGPath()}}:null)}startNew(e,t,n,i,r){N(this,ku,n),N(this,Iu,i),N(this,Au,r),[e,t]=K(this,xf,IM).call(this,e,t);let o=N(this,ei,[NaN,NaN,NaN,NaN,e,t]);N(this,Li,[e,t]);let a=m(this,ti).at(-1);return a&&(a.line=new Float32Array(a.line),a.points=new Float32Array(a.points)),m(this,ti).push({line:o,points:m(this,Li)}),m(this,ha).set(o,0),N(this,zr,0),this.toSVGPath(),null}getLastElement(){return m(this,ti).at(-1)}setLastElement(e){return m(this,ti)?(m(this,ti).push(e),N(this,ei,e.line),N(this,Li,e.points),N(this,zr,0),{path:{d:this.toSVGPath()}}):m(this,Pu).setLastElement(e)}removeLastElement(){if(!m(this,ti))return m(this,Pu).removeLastElement();m(this,ti).pop(),N(this,ci,"");for(let e=0,t=m(this,ti).length;e<t;e++){let{line:n,points:i}=m(this,ti)[e];N(this,ei,n),N(this,Li,i),N(this,zr,0),this.toSVGPath()}return{path:{d:m(this,ci)}}}toSVGPath(){let e=yt.svgRound(m(this,ei)[4]),t=yt.svgRound(m(this,ei)[5]);if(m(this,Li).length===2)return N(this,ci,`${m(this,ci)} M ${e} ${t} Z`),m(this,ci);if(m(this,Li).length<=6){let i=m(this,ci).lastIndexOf("M");N(this,ci,`${m(this,ci).slice(0,i)} M ${e} ${t}`),N(this,zr,6)}if(m(this,Li).length===4){let i=yt.svgRound(m(this,ei)[10]),r=yt.svgRound(m(this,ei)[11]);return N(this,ci,`${m(this,ci)} L ${i} ${r}`),N(this,zr,12),m(this,ci)}let n=[];m(this,zr)===0&&(n.push(`M ${e} ${t}`),N(this,zr,6));for(let i=m(this,zr),r=m(this,ei).length;i<r;i+=6){let[o,a,l,c,d,u]=m(this,ei).slice(i,i+6).map(yt.svgRound);n.push(`C${o} ${a} ${l} ${c} ${d} ${u}`)}return N(this,ci,m(this,ci)+n.join(" ")),N(this,zr,m(this,ei).length),m(this,ci)}getOutlines(e,t,n,i){let r=m(this,ti).at(-1);return r.line=new Float32Array(r.line),r.points=new Float32Array(r.points),m(this,Pu).build(m(this,ti),e,t,n,m(this,Au),m(this,Ef),i),N(this,ha,null),N(this,ei,null),N(this,ti,null),N(this,ci,null),m(this,Pu)}get defaultSVGProperties(){return{root:{viewBox:"0 0 10000 10000"},rootClass:{draw:!0},bbox:[0,0,1,1]}}};ha=new WeakMap,ei=new WeakMap,ti=new WeakMap,Au=new WeakMap,Ef=new WeakMap,Li=new WeakMap,ci=new WeakMap,zr=new WeakMap,Pu=new WeakMap,ku=new WeakMap,Iu=new WeakMap,xf=new WeakSet,IM=function(e,t){return yt._normalizePoint(e,t,m(this,ku),m(this,Iu),m(this,Au))};var Ni,Dy,Ry,gr,pa,fa,Sf,Cf,Af,Mo,Wa,VE,WV,GE,HV,WE,jV,PI=class PI extends yt{constructor(){super(...arguments);L(this,Mo);L(this,VE);L(this,GE);L(this,WE);L(this,Ni,void 0);L(this,Dy,0);L(this,Ry,void 0);L(this,gr,void 0);L(this,pa,void 0);L(this,fa,void 0);L(this,Sf,void 0);L(this,Cf,void 0);L(this,Af,void 0)}build(t,n,i,r,o,a,l){N(this,pa,n),N(this,fa,i),N(this,Sf,r),N(this,Cf,o),N(this,Af,a),N(this,Ry,l??0),N(this,gr,t),K(this,GE,HV).call(this)}setLastElement(t){return m(this,gr).push(t),{path:{d:this.toSVGPath()}}}removeLastElement(){return m(this,gr).pop(),{path:{d:this.toSVGPath()}}}toSVGPath(){let t=[];for(let{line:n}of m(this,gr)){if(t.push(`M${yt.svgRound(n[4])} ${yt.svgRound(n[5])}`),n.length===6){t.push("Z");continue}if(n.length===12){t.push(`L${yt.svgRound(n[10])} ${yt.svgRound(n[11])}`);continue}for(let i=6,r=n.length;i<r;i+=6){let[o,a,l,c,d,u]=n.subarray(i,i+6).map(yt.svgRound);t.push(`C${o} ${a} ${l} ${c} ${d} ${u}`)}}return t.join("")}serialize([t,n,i,r],o){let a=[],l=[],[c,d,u,h]=K(this,VE,WV).call(this),p,f,_,b,y,w,C,M,S;switch(m(this,Cf)){case 0:S=yt._rescale,p=t,f=n+r,_=i,b=-r,y=t+c*i,w=n+(1-d-h)*r,C=t+(c+u)*i,M=n+(1-d)*r;break;case 90:S=yt._rescaleAndSwap,p=t,f=n,_=i,b=r,y=t+d*i,w=n+c*r,C=t+(d+h)*i,M=n+(c+u)*r;break;case 180:S=yt._rescale,p=t+i,f=n,_=-i,b=r,y=t+(1-c-u)*i,w=n+d*r,C=t+(1-c)*i,M=n+(d+h)*r;break;case 270:S=yt._rescaleAndSwap,p=t+i,f=n+r,_=-i,b=-r,y=t+(1-d-h)*i,w=n+(1-c-u)*r,C=t+(1-d)*i,M=n+(1-c)*r;break}for(let{line:k,points:T}of m(this,gr))a.push(S(k,p,f,_,b,o?new Array(k.length):null)),l.push(S(T,p,f,_,b,o?new Array(T.length):null));return{lines:a,points:l,rect:[y,w,C,M]}}static deserialize(t,n,i,r,o,{paths:{lines:a,points:l},rotation:c,thickness:d}){let u=[],h,p,f,_,b;switch(c){case 0:b=yt._rescale,h=-t/i,p=n/r+1,f=1/i,_=-1/r;break;case 90:b=yt._rescaleAndSwap,h=-n/r,p=-t/i,f=1/r,_=1/i;break;case 180:b=yt._rescale,h=t/i+1,p=-n/r,f=-1/i,_=1/r;break;case 270:b=yt._rescaleAndSwap,h=n/r+1,p=t/i+1,f=-1/r,_=-1/i;break}if(!a){a=[];for(let w of l){let C=w.length;if(C===2){a.push(new Float32Array([NaN,NaN,NaN,NaN,w[0],w[1]]));continue}if(C===4){a.push(new Float32Array([NaN,NaN,NaN,NaN,w[0],w[1],NaN,NaN,NaN,NaN,w[2],w[3]]));continue}let M=new Float32Array(3*(C-2));a.push(M);let[S,k,T,P]=w.subarray(0,4);M.set([NaN,NaN,NaN,NaN,S,k],0);for(let R=4;R<C;R+=2){let O=w[R],H=w[R+1];M.set(yt.createBezierPoints(S,k,T,P,O,H),(R-2)*3),[S,k,T,P]=[T,P,O,H]}}}for(let w=0,C=a.length;w<C;w++)u.push({line:b(a[w].map(M=>M??NaN),h,p,f,_),points:b(l[w].map(M=>M??NaN),h,p,f,_)});let y=new PI;return y.build(u,i,r,1,c,d,o),y}get box(){return m(this,Ni)}updateProperty(t,n){return t==="stroke-width"?K(this,WE,jV).call(this,n):null}updateParentDimensions([t,n],i){let[r,o]=K(this,Mo,Wa).call(this);N(this,pa,t),N(this,fa,n),N(this,Sf,i);let[a,l]=K(this,Mo,Wa).call(this),c=a-r,d=l-o,u=m(this,Ni);return u[0]-=c,u[1]-=d,u[2]+=2*c,u[3]+=2*d,u}updateRotation(t){return N(this,Dy,t),{path:{transform:this.rotationTransform}}}get viewBox(){return m(this,Ni).map(yt.svgRound).join(" ")}get defaultProperties(){let[t,n]=m(this,Ni);return{root:{viewBox:this.viewBox},path:{"transform-origin":`${yt.svgRound(t)} ${yt.svgRound(n)}`}}}get rotationTransform(){let[,,t,n]=m(this,Ni),i=0,r=0,o=0,a=0,l=0,c=0;switch(m(this,Dy)){case 90:r=n/t,o=-t/n,l=t;break;case 180:i=-1,a=-1,l=t,c=n;break;case 270:r=-n/t,o=t/n,c=n;break;default:return""}return`matrix(${i} ${r} ${o} ${a} ${yt.svgRound(l)} ${yt.svgRound(c)})`}getPathResizingSVGProperties([t,n,i,r]){let[o,a]=K(this,Mo,Wa).call(this),[l,c,d,u]=m(this,Ni);if(Math.abs(d-o)<=yt.PRECISION||Math.abs(u-a)<=yt.PRECISION){let b=t+i/2-(l+d/2),y=n+r/2-(c+u/2);return{path:{"transform-origin":`${yt.svgRound(t)} ${yt.svgRound(n)}`,transform:`${this.rotationTransform} translate(${b} ${y})`}}}let h=(i-2*o)/(d-2*o),p=(r-2*a)/(u-2*a),f=d/i,_=u/r;return{path:{"transform-origin":`${yt.svgRound(l)} ${yt.svgRound(c)}`,transform:`${this.rotationTransform} scale(${f} ${_}) translate(${yt.svgRound(o)} ${yt.svgRound(a)}) scale(${h} ${p}) translate(${yt.svgRound(-o)} ${yt.svgRound(-a)})`}}}getPathResizedSVGProperties([t,n,i,r]){let[o,a]=K(this,Mo,Wa).call(this),l=m(this,Ni),[c,d,u,h]=l;if(l[0]=t,l[1]=n,l[2]=i,l[3]=r,Math.abs(u-o)<=yt.PRECISION||Math.abs(h-a)<=yt.PRECISION){let y=t+i/2-(c+u/2),w=n+r/2-(d+h/2);for(let{line:C,points:M}of m(this,gr))yt._translate(C,y,w,C),yt._translate(M,y,w,M);return{root:{viewBox:this.viewBox},path:{"transform-origin":`${yt.svgRound(t)} ${yt.svgRound(n)}`,transform:this.rotationTransform||null,d:this.toSVGPath()}}}let p=(i-2*o)/(u-2*o),f=(r-2*a)/(h-2*a),_=-p*(c+o)+t+o,b=-f*(d+a)+n+a;if(p!==1||f!==1||_!==0||b!==0)for(let{line:y,points:w}of m(this,gr))yt._rescale(y,_,b,p,f,y),yt._rescale(w,_,b,p,f,w);return{root:{viewBox:this.viewBox},path:{"transform-origin":`${yt.svgRound(t)} ${yt.svgRound(n)}`,transform:this.rotationTransform||null,d:this.toSVGPath()}}}getPathTranslatedSVGProperties([t,n],i){let[r,o]=i,a=m(this,Ni),l=t-a[0],c=n-a[1];if(m(this,pa)===r&&m(this,fa)===o)for(let{line:d,points:u}of m(this,gr))yt._translate(d,l,c,d),yt._translate(u,l,c,u);else{let d=m(this,pa)/r,u=m(this,fa)/o;N(this,pa,r),N(this,fa,o);for(let{line:h,points:p}of m(this,gr))yt._rescale(h,l,c,d,u,h),yt._rescale(p,l,c,d,u,p);a[2]*=d,a[3]*=u}return a[0]=t,a[1]=n,{root:{viewBox:this.viewBox},path:{d:this.toSVGPath(),"transform-origin":`${yt.svgRound(t)} ${yt.svgRound(n)}`}}}get defaultSVGProperties(){let t=m(this,Ni);return{root:{viewBox:this.viewBox},rootClass:{draw:!0},path:{d:this.toSVGPath(),"transform-origin":`${yt.svgRound(t[0])} ${yt.svgRound(t[1])}`,transform:this.rotationTransform||null},bbox:t}}};Ni=new WeakMap,Dy=new WeakMap,Ry=new WeakMap,gr=new WeakMap,pa=new WeakMap,fa=new WeakMap,Sf=new WeakMap,Cf=new WeakMap,Af=new WeakMap,Mo=new WeakSet,Wa=function(t=m(this,Af)){let n=m(this,Ry)+t/2*m(this,Sf);return m(this,Cf)%180===0?[n/m(this,pa),n/m(this,fa)]:[n/m(this,fa),n/m(this,pa)]},VE=new WeakSet,WV=function(){let[t,n,i,r]=m(this,Ni),[o,a]=K(this,Mo,Wa).call(this,0);return[t+o,n+a,i-2*o,r-2*a]},GE=new WeakSet,HV=function(){let t=N(this,Ni,new Float32Array([1/0,1/0,-1/0,-1/0]));for(let{line:r}of m(this,gr)){if(r.length<=12){for(let l=4,c=r.length;l<c;l+=6){let[d,u]=r.subarray(l,l+2);t[0]=Math.min(t[0],d),t[1]=Math.min(t[1],u),t[2]=Math.max(t[2],d),t[3]=Math.max(t[3],u)}continue}let o=r[4],a=r[5];for(let l=6,c=r.length;l<c;l+=6){let[d,u,h,p,f,_]=r.subarray(l,l+6);At.bezierBoundingBox(o,a,d,u,h,p,f,_,t),o=f,a=_}}let[n,i]=K(this,Mo,Wa).call(this);t[0]=Math.min(1,Math.max(0,t[0]-n)),t[1]=Math.min(1,Math.max(0,t[1]-i)),t[2]=Math.min(1,Math.max(0,t[2]+n)),t[3]=Math.min(1,Math.max(0,t[3]+i)),t[2]-=t[0],t[3]-=t[1]},WE=new WeakSet,jV=function(t){let[n,i]=K(this,Mo,Wa).call(this);N(this,Af,t);let[r,o]=K(this,Mo,Wa).call(this),[a,l]=[r-n,o-i],c=m(this,Ni);return c[0]-=a,c[1]-=l,c[2]+=2*a,c[3]+=2*l,c};var uT=PI,Pf,kI=class kI extends iI{constructor(t){super();L(this,Pf,void 0);N(this,Pf,t),super.updateProperties({fill:"none",stroke:ls._defaultLineColor,"stroke-opacity":1,"stroke-width":1,"stroke-linecap":"round","stroke-linejoin":"round","stroke-miterlimit":10})}updateSVGProperty(t,n){t==="stroke-width"&&(n??(n=this["stroke-width"]),n*=m(this,Pf).realScale),super.updateSVGProperty(t,n)}clone(){let t=new kI(m(this,Pf));return t.updateAll(this),t}};Pf=new WeakMap;var dI=kI,HE,qV,ip=class ip extends rI{constructor(t){super({...t,name:"inkEditor"});L(this,HE);this._willKeepAspectRatio=!0}static initialize(t,n){ls.initialize(t,n),this._defaultDrawingOptions=new dI(n.viewParameters)}static getDefaultDrawingOptions(t){let n=this._defaultDrawingOptions.clone();return n.updateProperties(t),n}static get supportMultipleDrawings(){return!0}static get typesMap(){return an(this,"typesMap",new Map([[mn.INK_THICKNESS,"stroke-width"],[mn.INK_COLOR,"stroke"],[mn.INK_OPACITY,"stroke-opacity"]]))}static createDrawerInstance(t,n,i,r,o){return new cI(t,n,i,r,o,this._defaultDrawingOptions["stroke-width"])}static deserializeDraw(t,n,i,r,o,a){return uT.deserialize(t,n,i,r,o,a)}static async deserialize(t,n,i){let r=null;if(t instanceof Sg){let{data:{inkLists:a,rect:l,rotation:c,id:d,color:u,opacity:h,borderStyle:{rawWidth:p},popupRef:f},parent:{page:{pageNumber:_}}}=t;r=t={annotationType:Qt.INK,color:Array.from(u),thickness:p,opacity:h,paths:{points:a},boxes:null,pageIndex:_-1,rect:l.slice(0),rotation:c,id:d,deleted:!1,popupRef:f}}let o=await super.deserialize(t,n,i);return o.annotationElementId=t.id||null,o._initialData=r,o}onScaleChanging(){if(!this.parent)return;super.onScaleChanging();let{_drawId:t,_drawingOptions:n,parent:i}=this;n.updateSVGProperty("stroke-width"),i.drawLayer.updateProperties(t,n.toSVGProperties())}static onScaleChangingWhenDrawing(){let t=this._currentParent;t&&(super.onScaleChangingWhenDrawing(),this._defaultDrawingOptions.updateSVGProperty("stroke-width"),t.drawLayer.updateProperties(this._currentDrawId,this._defaultDrawingOptions.toSVGProperties()))}createDrawingOptions({color:t,thickness:n,opacity:i}){this._drawingOptions=ip.getDefaultDrawingOptions({stroke:At.makeHexColor(...t),"stroke-width":n,"stroke-opacity":i})}serialize(t=!1){if(this.isEmpty())return null;if(this.deleted)return this.serializeDeleted();let{lines:n,points:i,rect:r}=this.serializeDraw(t),{_drawingOptions:{stroke:o,"stroke-opacity":a,"stroke-width":l}}=this,c={annotationType:Qt.INK,color:ls._colorManager.convert(o),opacity:a,thickness:l,paths:{lines:n,points:i},pageIndex:this.pageIndex,rect:r,rotation:this.rotation,structTreeParentId:this._structTreeParentId};return t?c:this.annotationElementId&&!K(this,HE,qV).call(this,c)?null:(c.id=this.annotationElementId,c)}renderAnnotationElement(t){let{points:n,rect:i}=this.serializeDraw(!1);return t.updateEdited({rect:i,thickness:this._drawingOptions["stroke-width"],points:n}),null}};HE=new WeakSet,qV=function(t){let{color:n,thickness:i,opacity:r,pageIndex:o}=this._initialData;return this._hasBeenMoved||this._hasBeenResized||t.color.some((a,l)=>a!==n[l])||t.thickness!==i||t.opacity!==r||t.pageIndex!==o},Z(ip,"_type","ink"),Z(ip,"_editorType",Qt.INK),Z(ip,"_defaultDrawingOptions",null);var uI=ip,as,di,Mc,_l,Tc,kf,ma,ga,_r,If,Du,dg,Ru,ug,Df,DM,Fy,pI,Rf,RM,Ly,fI,Ff,FM,jE,KV,mg=class mg extends ls{constructor(t){super({...t,name:"stampEditor"});L(this,Du);L(this,Ru);L(this,Df);L(this,Fy);L(this,Rf);L(this,Ly);L(this,Ff);L(this,jE);L(this,as,null);L(this,di,null);L(this,Mc,null);L(this,_l,null);L(this,Tc,null);L(this,kf,"");L(this,ma,null);L(this,ga,null);L(this,_r,!1);L(this,If,!1);N(this,_l,t.bitmapUrl),N(this,Tc,t.bitmapFile)}static initialize(t,n){ls.initialize(t,n)}static get supportedTypes(){return an(this,"supportedTypes",["apng","avif","bmp","gif","jpeg","png","svg+xml","webp","x-icon"].map(n=>`image/${n}`))}static get supportedTypesStr(){return an(this,"supportedTypesStr",this.supportedTypes.join(","))}static isHandlingMimeForPasting(t){return this.supportedTypes.includes(t)}static paste(t,n){n.pasteEditor(Qt.STAMP,{bitmapFile:t.getAsFile()})}altTextFinish(){this._uiManager.useNewAltTextFlow&&(this.div.hidden=!1),super.altTextFinish()}get telemetryFinalData(){return{type:"stamp",hasAltText:!!this.altTextData?.altText}}static computeTelemetryFinalData(t){let n=t.get("hasAltText");return{hasAltText:n.get(!0)??0,hasNoAltText:n.get(!1)??0}}async mlGuessAltText(t=null,n=!0){if(this.hasAltTextData())return null;let{mlManager:i}=this._uiManager;if(!i)throw new Error("No ML.");if(!await i.isEnabledFor("altText"))throw new Error("ML isn't enabled for alt text.");let{data:r,width:o,height:a}=t||this.copyCanvas(null,null,!0).imageData,l=await i.guess({name:"altText",request:{data:r,width:o,height:a,channels:r.length/(o*a)}});if(!l)throw new Error("No response from the AI service.");if(l.error)throw new Error("Error from the AI service.");if(l.cancel)return null;if(!l.output)throw new Error("No valid response from the AI service.");let c=l.output;return await this.setGuessedAltText(c),n&&!this.hasAltTextData()&&(this.altTextData={alt:c,decorative:!1}),c}remove(){m(this,di)&&(N(this,as,null),this._uiManager.imageManager.deleteId(m(this,di)),m(this,ma)?.remove(),N(this,ma,null),m(this,ga)&&(clearTimeout(m(this,ga)),N(this,ga,null))),super.remove()}rebuild(){if(!this.parent){m(this,di)&&K(this,Df,DM).call(this);return}super.rebuild(),this.div!==null&&(m(this,di)&&m(this,ma)===null&&K(this,Df,DM).call(this),this.isAttachedToDOM||this.parent.add(this))}onceAdded(t){this._isDraggable=!0,t&&this.div.focus()}isEmpty(){return!(m(this,Mc)||m(this,as)||m(this,_l)||m(this,Tc)||m(this,di))}get isResizable(){return!0}render(){if(this.div)return this.div;let t,n;if(this.width&&(t=this.x,n=this.y),super.render(),this.div.hidden=!0,this.div.setAttribute("role","figure"),this.addAltTextButton(),m(this,as)?K(this,Fy,pI).call(this):K(this,Df,DM).call(this),this.width&&!this.annotationElementId){let[i,r]=this.parentDimensions;this.setAt(t*i,n*r,this.width*i,this.height*r)}return this._uiManager.addShouldRescale(this),this.div}_onResized(){this.onScaleChanging()}onScaleChanging(){if(!this.parent)return;m(this,ga)!==null&&clearTimeout(m(this,ga)),N(this,ga,setTimeout(()=>{N(this,ga,null),K(this,Ly,fI).call(this)},200))}copyCanvas(t,n,i=!1){t||(t=224);let{width:r,height:o}=m(this,as),a=new vg,l=m(this,as),c=r,d=o,u=null;if(n){if(r>n||o>n){let T=Math.min(n/r,n/o);c=Math.floor(r*T),d=Math.floor(o*T)}u=document.createElement("canvas");let p=u.width=Math.ceil(c*a.sx),f=u.height=Math.ceil(d*a.sy);m(this,_r)||(l=K(this,Rf,RM).call(this,p,f));let _=u.getContext("2d");_.filter=this._uiManager.hcmFilter;let b="white",y="#cfcfd8";this._uiManager.hcmFilter!=="none"?y="black":window.matchMedia?.("(prefers-color-scheme: dark)").matches&&(b="#8f8f9d",y="#42414d");let w=15,C=w*a.sx,M=w*a.sy,S=new OffscreenCanvas(C*2,M*2),k=S.getContext("2d");k.fillStyle=b,k.fillRect(0,0,C*2,M*2),k.fillStyle=y,k.fillRect(0,0,C,M),k.fillRect(C,M,C,M),_.fillStyle=_.createPattern(S,"repeat"),_.fillRect(0,0,p,f),_.drawImage(l,0,0,l.width,l.height,0,0,p,f)}let h=null;if(i){let p,f;if(a.symmetric&&l.width<t&&l.height<t)p=l.width,f=l.height;else if(l=m(this,as),r>t||o>t){let y=Math.min(t/r,t/o);p=Math.floor(r*y),f=Math.floor(o*y),m(this,_r)||(l=K(this,Rf,RM).call(this,p,f))}let b=new OffscreenCanvas(p,f).getContext("2d",{willReadFrequently:!0});b.drawImage(l,0,0,l.width,l.height,0,0,p,f),h={width:p,height:f,data:b.getImageData(0,0,p,f).data}}return{canvas:u,width:c,height:d,imageData:h}}getImageForAltText(){return m(this,ma)}static async deserialize(t,n,i){let r=null;if(t instanceof oT){let{data:{rect:_,rotation:b,id:y,structParent:w,popupRef:C},container:M,parent:{page:{pageNumber:S}}}=t,k=M.querySelector("canvas"),T=i.imageManager.getFromCanvas(M.id,k);k.remove();let P=(await n._structTree.getAriaAttributes(`${MI}${y}`))?.get("aria-label")||"";r=t={annotationType:Qt.STAMP,bitmapId:T.id,bitmap:T.bitmap,pageIndex:S-1,rect:_.slice(0),rotation:b,id:y,deleted:!1,accessibilityData:{decorative:!1,altText:P},isSvg:!1,structParent:w,popupRef:C}}let o=await super.deserialize(t,n,i),{rect:a,bitmap:l,bitmapUrl:c,bitmapId:d,isSvg:u,accessibilityData:h}=t;d&&i.imageManager.isValidId(d)?(N(o,di,d),l&&N(o,as,l)):N(o,_l,c),N(o,_r,u);let[p,f]=o.pageDimensions;return o.width=(a[2]-a[0])/p,o.height=(a[3]-a[1])/f,o.annotationElementId=t.id||null,h&&(o.altTextData=h),o._initialData=r,N(o,If,!!r),o}serialize(t=!1,n=null){if(this.isEmpty())return null;if(this.deleted)return this.serializeDeleted();let i={annotationType:Qt.STAMP,bitmapId:m(this,di),pageIndex:this.pageIndex,rect:this.getRect(0,0),rotation:this.rotation,isSvg:m(this,_r),structTreeParentId:this._structTreeParentId};if(t)return i.bitmapUrl=K(this,Ff,FM).call(this,!0),i.accessibilityData=this.serializeAltText(!0),i;let{decorative:r,altText:o}=this.serializeAltText(!1);if(!r&&o&&(i.accessibilityData={type:"Figure",alt:o}),this.annotationElementId){let l=K(this,jE,KV).call(this,i);if(l.isSame)return null;l.isSameAltText?delete i.accessibilityData:i.accessibilityData.structParent=this._initialData.structParent??-1}if(i.id=this.annotationElementId,n===null)return i;n.stamps||(n.stamps=new Map);let a=m(this,_r)?(i.rect[2]-i.rect[0])*(i.rect[3]-i.rect[1]):null;if(!n.stamps.has(m(this,di)))n.stamps.set(m(this,di),{area:a,serialized:i}),i.bitmap=K(this,Ff,FM).call(this,!1);else if(m(this,_r)){let l=n.stamps.get(m(this,di));a>l.area&&(l.area=a,l.serialized.bitmap.close(),l.serialized.bitmap=K(this,Ff,FM).call(this,!1))}return i}renderAnnotationElement(t){return t.updateEdited({rect:this.getRect(0,0)}),null}};as=new WeakMap,di=new WeakMap,Mc=new WeakMap,_l=new WeakMap,Tc=new WeakMap,kf=new WeakMap,ma=new WeakMap,ga=new WeakMap,_r=new WeakMap,If=new WeakMap,Du=new WeakSet,dg=function(t,n=!1){if(!t){this.remove();return}N(this,as,t.bitmap),n||(N(this,di,t.id),N(this,_r,t.isSvg)),t.file&&N(this,kf,t.file.name),K(this,Fy,pI).call(this)},Ru=new WeakSet,ug=function(){if(N(this,Mc,null),this._uiManager.enableWaiting(!1),!!m(this,ma)){if(this._uiManager.useNewAltTextWhenAddingImage&&this._uiManager.useNewAltTextFlow&&m(this,as)){this._editToolbar.hide(),this._uiManager.editAltText(this,!0);return}if(!this._uiManager.useNewAltTextWhenAddingImage&&this._uiManager.useNewAltTextFlow&&m(this,as)){this._reportTelemetry({action:"pdfjs.image.image_added",data:{alt_text_modal:!1,alt_text_type:"empty"}});try{this.mlGuessAltText()}catch{}}this.div.focus()}},Df=new WeakSet,DM=function(){if(m(this,di)){this._uiManager.enableWaiting(!0),this._uiManager.imageManager.getFromId(m(this,di)).then(i=>K(this,Du,dg).call(this,i,!0)).finally(()=>K(this,Ru,ug).call(this));return}if(m(this,_l)){let i=m(this,_l);N(this,_l,null),this._uiManager.enableWaiting(!0),N(this,Mc,this._uiManager.imageManager.getFromUrl(i).then(r=>K(this,Du,dg).call(this,r)).finally(()=>K(this,Ru,ug).call(this)));return}if(m(this,Tc)){let i=m(this,Tc);N(this,Tc,null),this._uiManager.enableWaiting(!0),N(this,Mc,this._uiManager.imageManager.getFromFile(i).then(r=>K(this,Du,dg).call(this,r)).finally(()=>K(this,Ru,ug).call(this)));return}let t=document.createElement("input");t.type="file",t.accept=mg.supportedTypesStr;let n=this._uiManager._signal;N(this,Mc,new Promise(i=>{t.addEventListener("change",async()=>{if(!t.files||t.files.length===0)this.remove();else{this._uiManager.enableWaiting(!0);let r=await this._uiManager.imageManager.getFromFile(t.files[0]);this._reportTelemetry({action:"pdfjs.image.image_selected",data:{alt_text_modal:this._uiManager.useNewAltTextFlow}}),K(this,Du,dg).call(this,r)}i()},{signal:n}),t.addEventListener("cancel",()=>{this.remove(),i()},{signal:n})}).finally(()=>K(this,Ru,ug).call(this))),t.click()},Fy=new WeakSet,pI=function(){let{div:t}=this,{width:n,height:i}=m(this,as),[r,o]=this.pageDimensions,a=.75;if(this.width)n=this.width*r,i=this.height*o;else if(n>a*r||i>a*o){let u=Math.min(a*r/n,a*o/i);n*=u,i*=u}let[l,c]=this.parentDimensions;this.setDims(n*l/r,i*c/o),this._uiManager.enableWaiting(!1);let d=N(this,ma,document.createElement("canvas"));d.setAttribute("role","img"),this.addContainer(d),this.width=n/r,this.height=i/o,this._initialOptions?.isCentered?this.center():this.fixAndSetPosition(),this._initialOptions=null,(!this._uiManager.useNewAltTextWhenAddingImage||!this._uiManager.useNewAltTextFlow||this.annotationElementId)&&(t.hidden=!1),K(this,Ly,fI).call(this),m(this,If)||(this.parent.addUndoableEditor(this),N(this,If,!0)),this._reportTelemetry({action:"inserted_image"}),m(this,kf)&&d.setAttribute("aria-label",m(this,kf))},Rf=new WeakSet,RM=function(t,n){let{width:i,height:r}=m(this,as),o=i,a=r,l=m(this,as);for(;o>2*t||a>2*n;){let c=o,d=a;o>2*t&&(o=o>=16384?Math.floor(o/2)-1:Math.ceil(o/2)),a>2*n&&(a=a>=16384?Math.floor(a/2)-1:Math.ceil(a/2));let u=new OffscreenCanvas(o,a);u.getContext("2d").drawImage(l,0,0,c,d,0,0,o,a),l=u.transferToImageBitmap()}return l},Ly=new WeakSet,fI=function(){let[t,n]=this.parentDimensions,{width:i,height:r}=this,o=new vg,a=Math.ceil(i*t*o.sx),l=Math.ceil(r*n*o.sy),c=m(this,ma);if(!c||c.width===a&&c.height===l)return;c.width=a,c.height=l;let d=m(this,_r)?m(this,as):K(this,Rf,RM).call(this,a,l),u=c.getContext("2d");u.filter=this._uiManager.hcmFilter,u.drawImage(d,0,0,d.width,d.height,0,0,a,l)},Ff=new WeakSet,FM=function(t){if(t){if(m(this,_r)){let r=this._uiManager.imageManager.getSvgUrl(m(this,di));if(r)return r}let n=document.createElement("canvas");return{width:n.width,height:n.height}=m(this,as),n.getContext("2d").drawImage(m(this,as),0,0),n.toDataURL()}if(m(this,_r)){let[n,i]=this.pageDimensions,r=Math.round(this.width*n*Ac.PDF_TO_CSS_UNITS),o=Math.round(this.height*i*Ac.PDF_TO_CSS_UNITS),a=new OffscreenCanvas(r,o);return a.getContext("2d").drawImage(m(this,as),0,0,m(this,as).width,m(this,as).height,0,0,r,o),a.transferToImageBitmap()}return structuredClone(m(this,as))},jE=new WeakSet,KV=function(t){let{pageIndex:n,accessibilityData:{altText:i}}=this._initialData,r=t.pageIndex===n,o=(t.accessibilityData?.alt||"")===i;return{isSame:!this._hasBeenMoved&&!this._hasBeenResized&&r&&o,isSameAltText:o}},Z(mg,"_type","stamp"),Z(mg,"_editorType",Qt.STAMP);var hI=mg,Fu,Lf,_a,Ec,yl,Ur,xc,Nf,Lu,To,vl,Ti,bl,kt,Sc,qE,YV,Vr,Zo,Ny,gI,Oy,_I,Of,LM,lo=class lo{constructor({uiManager:e,pageIndex:t,div:n,structTreeLayer:i,accessibilityManager:r,annotationLayer:o,drawLayer:a,textLayer:l,viewport:c,l10n:d}){L(this,qE);L(this,Vr);L(this,Ny);L(this,Oy);L(this,Of);L(this,Fu,void 0);L(this,Lf,!1);L(this,_a,null);L(this,Ec,null);L(this,yl,null);L(this,Ur,new Map);L(this,xc,!1);L(this,Nf,!1);L(this,Lu,!1);L(this,To,null);L(this,vl,null);L(this,Ti,null);L(this,bl,null);L(this,kt,void 0);let u=[...m(lo,Sc).values()];if(!lo._initialized){lo._initialized=!0;for(let h of u)h.initialize(d,e)}e.registerEditorTypes(u),N(this,kt,e),this.pageIndex=t,this.div=n,N(this,Fu,r),N(this,_a,o),this.viewport=c,N(this,Ti,l),this.drawLayer=a,this._structTree=i,m(this,kt).addLayer(this)}get isEmpty(){return m(this,Ur).size===0}get isInvisible(){return this.isEmpty&&m(this,kt).getMode()===Qt.NONE}updateToolbar(e){m(this,kt).updateToolbar(e)}updateMode(e=m(this,kt).getMode()){switch(K(this,Of,LM).call(this),e){case Qt.NONE:this.disableTextSelection(),this.togglePointerEvents(!1),this.toggleAnnotationLayerPointerEvents(!0),this.disableClick();return;case Qt.INK:this.disableTextSelection(),this.togglePointerEvents(!0),this.enableClick();break;case Qt.HIGHLIGHT:this.enableTextSelection(),this.togglePointerEvents(!1),this.disableClick();break;default:this.disableTextSelection(),this.togglePointerEvents(!0),this.enableClick()}this.toggleAnnotationLayerPointerEvents(!1);let{classList:t}=this.div;for(let n of m(lo,Sc).values())t.toggle(`${n._type}Editing`,e===n._editorType);this.div.hidden=!1}hasTextLayer(e){return e===m(this,Ti)?.div}setEditingState(e){m(this,kt).setEditingState(e)}addCommands(e){m(this,kt).addCommands(e)}cleanUndoStack(e){m(this,kt).cleanUndoStack(e)}toggleDrawing(e=!1){this.div.classList.toggle("drawing",!e)}togglePointerEvents(e=!1){this.div.classList.toggle("disabled",!e)}toggleAnnotationLayerPointerEvents(e=!1){m(this,_a)?.div.classList.toggle("disabled",!e)}async enable(){N(this,Lu,!0),this.div.tabIndex=0,this.togglePointerEvents(!0);let e=new Set;for(let n of m(this,Ur).values())n.enableEditing(),n.show(!0),n.annotationElementId&&(m(this,kt).removeChangedExistingAnnotation(n),e.add(n.annotationElementId));if(!m(this,_a)){N(this,Lu,!1);return}let t=m(this,_a).getEditableAnnotations();for(let n of t){if(n.hide(),m(this,kt).isDeletedAnnotationElement(n.data.id)||e.has(n.data.id))continue;let i=await this.deserialize(n);i&&(this.addOrRebuild(i),i.enableEditing())}N(this,Lu,!1)}disable(){N(this,Nf,!0),this.div.tabIndex=-1,this.togglePointerEvents(!1);let e=new Map,t=new Map;for(let i of m(this,Ur).values())if(i.disableEditing(),!!i.annotationElementId){if(i.serialize()!==null){e.set(i.annotationElementId,i);continue}else t.set(i.annotationElementId,i);this.getEditableAnnotation(i.annotationElementId)?.show(),i.remove()}if(m(this,_a)){let i=m(this,_a).getEditableAnnotations();for(let r of i){let{id:o}=r.data;if(m(this,kt).isDeletedAnnotationElement(o))continue;let a=t.get(o);if(a){a.resetAnnotationElement(r),a.show(!1),r.show();continue}a=e.get(o),a&&(m(this,kt).addChangedExistingAnnotation(a),a.renderAnnotationElement(r)&&a.show(!1)),r.show()}}K(this,Of,LM).call(this),this.isEmpty&&(this.div.hidden=!0);let{classList:n}=this.div;for(let i of m(lo,Sc).values())n.remove(`${i._type}Editing`);this.disableTextSelection(),this.toggleAnnotationLayerPointerEvents(!0),N(this,Nf,!1)}getEditableAnnotation(e){return m(this,_a)?.getEditableAnnotation(e)||null}setActiveEditor(e){m(this,kt).getActive()!==e&&m(this,kt).setActiveEditor(e)}enableTextSelection(){if(this.div.tabIndex=-1,m(this,Ti)?.div&&!m(this,bl)){N(this,bl,new AbortController);let e=m(this,kt).combinedSignal(m(this,bl));m(this,Ti).div.addEventListener("pointerdown",K(this,qE,YV).bind(this),{signal:e}),m(this,Ti).div.classList.add("highlighting")}}disableTextSelection(){this.div.tabIndex=0,m(this,Ti)?.div&&m(this,bl)&&(m(this,bl).abort(),N(this,bl,null),m(this,Ti).div.classList.remove("highlighting"))}enableClick(){if(m(this,Ec))return;N(this,Ec,new AbortController);let e=m(this,kt).combinedSignal(m(this,Ec));this.div.addEventListener("pointerdown",this.pointerdown.bind(this),{signal:e});let t=this.pointerup.bind(this);this.div.addEventListener("pointerup",t,{signal:e}),this.div.addEventListener("pointercancel",t,{signal:e})}disableClick(){m(this,Ec)?.abort(),N(this,Ec,null)}attach(e){m(this,Ur).set(e.id,e);let{annotationElementId:t}=e;t&&m(this,kt).isDeletedAnnotationElement(t)&&m(this,kt).removeDeletedAnnotationElement(e)}detach(e){m(this,Ur).delete(e.id),m(this,Fu)?.removePointerInTextLayer(e.contentDiv),!m(this,Nf)&&e.annotationElementId&&m(this,kt).addDeletedAnnotationElement(e)}remove(e){this.detach(e),m(this,kt).removeEditor(e),e.div.remove(),e.isAttachedToDOM=!1}changeParent(e){e.parent!==this&&(e.parent&&e.annotationElementId&&(m(this,kt).addDeletedAnnotationElement(e.annotationElementId),ls.deleteAnnotationElement(e),e.annotationElementId=null),this.attach(e),e.parent?.detach(e),e.setParent(this),e.div&&e.isAttachedToDOM&&(e.div.remove(),this.div.append(e.div)))}add(e){if(!(e.parent===this&&e.isAttachedToDOM)){if(this.changeParent(e),m(this,kt).addEditor(e),this.attach(e),!e.isAttachedToDOM){let t=e.render();this.div.append(t),e.isAttachedToDOM=!0}e.fixAndSetPosition(),e.onceAdded(!m(this,Lu)),m(this,kt).addToAnnotationStorage(e),e._reportTelemetry(e.telemetryInitialData)}}moveEditorInDOM(e){if(!e.isAttachedToDOM)return;let{activeElement:t}=document;e.div.contains(t)&&!m(this,yl)&&(e._focusEventsAllowed=!1,N(this,yl,setTimeout(()=>{N(this,yl,null),e.div.contains(document.activeElement)?e._focusEventsAllowed=!0:(e.div.addEventListener("focusin",()=>{e._focusEventsAllowed=!0},{once:!0,signal:m(this,kt)._signal}),t.focus())},0))),e._structTreeParentId=m(this,Fu)?.moveElementInDOM(this.div,e.div,e.contentDiv,!0)}addOrRebuild(e){e.needsToBeRebuilt()?(e.parent||(e.parent=this),e.rebuild(),e.show()):this.add(e)}addUndoableEditor(e){let t=()=>e._uiManager.rebuild(e),n=()=>{e.remove()};this.addCommands({cmd:t,undo:n,mustExec:!1})}getNextId(){return m(this,kt).getId()}combinedSignal(e){return m(this,kt).combinedSignal(e)}canCreateNewEmptyEditor(){return m(this,Vr,Zo)?.canCreateNewEmptyEditor()}pasteEditor(e,t){m(this,kt).updateToolbar(e),m(this,kt).updateMode(e);let{offsetX:n,offsetY:i}=K(this,Oy,_I).call(this),r=this.getNextId(),o=K(this,Ny,gI).call(this,{parent:this,id:r,x:n,y:i,uiManager:m(this,kt),isCentered:!0,...t});o&&this.add(o)}async deserialize(e){return await m(lo,Sc).get(e.annotationType??e.annotationEditorType)?.deserialize(e,this,m(this,kt))||null}createAndAddNewEditor(e,t,n={}){let i=this.getNextId(),r=K(this,Ny,gI).call(this,{parent:this,id:i,x:e.offsetX,y:e.offsetY,uiManager:m(this,kt),isCentered:t,...n});return r&&this.add(r),r}addNewEditor(){this.createAndAddNewEditor(K(this,Oy,_I).call(this),!0)}setSelected(e){m(this,kt).setSelected(e)}toggleSelected(e){m(this,kt).toggleSelected(e)}unselect(e){m(this,kt).unselect(e)}pointerup(e){let{isMac:t}=ui.platform;if(!(e.button!==0||e.ctrlKey&&t)&&e.target===this.div&&m(this,xc)&&(N(this,xc,!1),!(m(this,Vr,Zo)?.isDrawer&&m(this,Vr,Zo).supportMultipleDrawings))){if(!m(this,Lf)){N(this,Lf,!0);return}if(m(this,kt).getMode()===Qt.STAMP){m(this,kt).unselectAll();return}this.createAndAddNewEditor(e,!1)}}pointerdown(e){if(m(this,kt).getMode()===Qt.HIGHLIGHT&&this.enableTextSelection(),m(this,xc)){N(this,xc,!1);return}let{isMac:t}=ui.platform;if(e.button!==0||e.ctrlKey&&t||e.target!==this.div)return;if(N(this,xc,!0),m(this,Vr,Zo)?.isDrawer){this.startDrawingSession(e);return}let n=m(this,kt).getActive();N(this,Lf,!n||n.isEmpty())}startDrawingSession(e){if(this.div.focus(),m(this,To)){m(this,Vr,Zo).startDrawing(this,m(this,kt),!1,e);return}m(this,kt).setCurrentDrawingSession(this),N(this,To,new AbortController);let t=m(this,kt).combinedSignal(m(this,To));this.div.addEventListener("blur",({relatedTarget:n})=>{n&&!this.div.contains(n)&&(N(this,vl,null),this.commitOrRemove())},{signal:t}),m(this,Vr,Zo).startDrawing(this,m(this,kt),!1,e)}pause(e){if(e){let{activeElement:t}=document;this.div.contains(t)&&N(this,vl,t);return}m(this,vl)&&setTimeout(()=>{m(this,vl)?.focus(),N(this,vl,null)},0)}endDrawingSession(e=!1){return m(this,To)?(m(this,kt).setCurrentDrawingSession(null),m(this,To).abort(),N(this,To,null),N(this,vl,null),m(this,Vr,Zo).endDrawing(e)):null}findNewParent(e,t,n){let i=m(this,kt).findParent(t,n);return i===null||i===this?!1:(i.changeParent(e),!0)}commitOrRemove(){return m(this,To)?(this.endDrawingSession(),!0):!1}onScaleChanging(){m(this,To)&&m(this,Vr,Zo).onScaleChangingWhenDrawing(this)}destroy(){this.commitOrRemove(),m(this,kt).getActive()?.parent===this&&(m(this,kt).commitOrRemove(),m(this,kt).setActiveEditor(null)),m(this,yl)&&(clearTimeout(m(this,yl)),N(this,yl,null));for(let e of m(this,Ur).values())m(this,Fu)?.removePointerInTextLayer(e.contentDiv),e.setParent(null),e.isAttachedToDOM=!1,e.div.remove();this.div=null,m(this,Ur).clear(),m(this,kt).removeLayer(this)}render({viewport:e}){this.viewport=e,$u(this.div,e);for(let t of m(this,kt).getEditors(this.pageIndex))this.add(t),t.rebuild();this.updateMode()}update({viewport:e}){m(this,kt).commitOrRemove(),K(this,Of,LM).call(this);let t=this.viewport.rotation,n=e.rotation;if(this.viewport=e,$u(this.div,{rotation:n}),t!==n)for(let i of m(this,Ur).values())i.rotate(n)}get pageDimensions(){let{pageWidth:e,pageHeight:t}=this.viewport.rawDims;return[e,t]}get scale(){return m(this,kt).viewParameters.realScale}};Fu=new WeakMap,Lf=new WeakMap,_a=new WeakMap,Ec=new WeakMap,yl=new WeakMap,Ur=new WeakMap,xc=new WeakMap,Nf=new WeakMap,Lu=new WeakMap,To=new WeakMap,vl=new WeakMap,Ti=new WeakMap,bl=new WeakMap,kt=new WeakMap,Sc=new WeakMap,qE=new WeakSet,YV=function(e){m(this,kt).unselectAll();let{target:t}=e;if(t===m(this,Ti).div||(t.getAttribute("role")==="img"||t.classList.contains("endOfContent"))&&m(this,Ti).div.contains(t)){let{isMac:n}=ui.platform;if(e.button!==0||e.ctrlKey&&n)return;m(this,kt).showAllEditors("highlight",!0,!0),m(this,Ti).div.classList.add("free"),this.toggleDrawing(),dT.startHighlighting(this,m(this,kt).direction==="ltr",{target:m(this,Ti).div,x:e.x,y:e.y}),m(this,Ti).div.addEventListener("pointerup",()=>{m(this,Ti).div.classList.remove("free"),this.toggleDrawing(!0)},{once:!0,signal:m(this,kt)._signal}),e.preventDefault()}},Vr=new WeakSet,Zo=function(){return m(lo,Sc).get(m(this,kt).getMode())},Ny=new WeakSet,gI=function(e){let t=m(this,Vr,Zo);return t?new t.prototype.constructor(e):null},Oy=new WeakSet,_I=function(){let{x:e,y:t,width:n,height:i}=this.div.getBoundingClientRect(),r=Math.max(0,e),o=Math.max(0,t),a=Math.min(window.innerWidth,e+n),l=Math.min(window.innerHeight,t+i),c=(r+a)/2-e,d=(o+l)/2-t,[u,h]=this.viewport.rotation%180===0?[c,d]:[d,c];return{offsetX:u,offsetY:h}},Of=new WeakSet,LM=function(){for(let e of m(this,Ur).values())e.isEmpty()&&e.remove()},Z(lo,"_initialized",!1),L(lo,Sc,new Map([Kk,uI,hI,dT].map(e=>[e._editorType,e])));var mI=lo,Eo,$y,Oi,Nu,KE,XV,By,vI,YE,QV,zy,bI,vi=class vi{constructor({pageIndex:e}){L(this,By);L(this,YE);L(this,zy);L(this,Eo,null);L(this,$y,0);L(this,Oi,new Map);L(this,Nu,new Map);this.pageIndex=e}setParent(e){if(!m(this,Eo)){N(this,Eo,e);return}if(m(this,Eo)!==e){if(m(this,Oi).size>0)for(let t of m(this,Oi).values())t.remove(),e.append(t);N(this,Eo,e)}}static get _svgFactory(){return an(this,"_svgFactory",new Eg)}draw(e,t=!1,n=!1){let i=Ii(this,$y)._++,r=K(this,By,vI).call(this),o=vi._svgFactory.createElement("defs");r.append(o);let a=vi._svgFactory.createElement("path");o.append(a);let l=`path_p${this.pageIndex}_${i}`;a.setAttribute("id",l),a.setAttribute("vector-effect","non-scaling-stroke"),t&&m(this,Nu).set(i,a);let c=n?K(this,YE,QV).call(this,o,l):null,d=vi._svgFactory.createElement("use");return r.append(d),d.setAttribute("href",`#${l}`),this.updateProperties(r,e),m(this,Oi).set(i,r),{id:i,clipPathId:`url(#${c})`}}drawOutline(e,t){let n=Ii(this,$y)._++,i=K(this,By,vI).call(this),r=vi._svgFactory.createElement("defs");i.append(r);let o=vi._svgFactory.createElement("path");r.append(o);let a=`path_p${this.pageIndex}_${n}`;o.setAttribute("id",a),o.setAttribute("vector-effect","non-scaling-stroke");let l;if(t){let u=vi._svgFactory.createElement("mask");r.append(u),l=`mask_p${this.pageIndex}_${n}`,u.setAttribute("id",l),u.setAttribute("maskUnits","objectBoundingBox");let h=vi._svgFactory.createElement("rect");u.append(h),h.setAttribute("width","1"),h.setAttribute("height","1"),h.setAttribute("fill","white");let p=vi._svgFactory.createElement("use");u.append(p),p.setAttribute("href",`#${a}`),p.setAttribute("stroke","none"),p.setAttribute("fill","black"),p.setAttribute("fill-rule","nonzero"),p.classList.add("mask")}let c=vi._svgFactory.createElement("use");i.append(c),c.setAttribute("href",`#${a}`),l&&c.setAttribute("mask",`url(#${l})`);let d=c.cloneNode();return i.append(d),c.classList.add("mainOutline"),d.classList.add("secondaryOutline"),this.updateProperties(i,e),m(this,Oi).set(n,i),n}finalizeDraw(e,t){m(this,Nu).delete(e),this.updateProperties(e,t)}updateProperties(e,t){var l;if(!t)return;let{root:n,bbox:i,rootClass:r,path:o}=t,a=typeof e=="number"?m(this,Oi).get(e):e;if(a){if(n&&K(this,zy,bI).call(this,a,n),i&&K(l=vi,KE,XV).call(l,a,i),r){let{classList:c}=a;for(let[d,u]of Object.entries(r))c.toggle(d,u)}if(o){let d=a.firstChild.firstChild;K(this,zy,bI).call(this,d,o)}}}updateParent(e,t){if(t===this)return;let n=m(this,Oi).get(e);n&&(m(t,Eo).append(n),m(this,Oi).delete(e),m(t,Oi).set(e,n))}remove(e){m(this,Nu).delete(e),m(this,Eo)!==null&&(m(this,Oi).get(e).remove(),m(this,Oi).delete(e))}destroy(){N(this,Eo,null);for(let e of m(this,Oi).values())e.remove();m(this,Oi).clear(),m(this,Nu).clear()}};Eo=new WeakMap,$y=new WeakMap,Oi=new WeakMap,Nu=new WeakMap,KE=new WeakSet,XV=function(e,[t,n,i,r]){let{style:o}=e;o.top=`${100*n}%`,o.left=`${100*t}%`,o.width=`${100*i}%`,o.height=`${100*r}%`},By=new WeakSet,vI=function(){let e=vi._svgFactory.create(1,1,!0);return m(this,Eo).append(e),e.setAttribute("aria-hidden",!0),e},YE=new WeakSet,QV=function(e,t){let n=vi._svgFactory.createElement("clipPath");e.append(n);let i=`clip_${t}`;n.setAttribute("id",i),n.setAttribute("clipPathUnits","objectBoundingBox");let r=vi._svgFactory.createElement("use");return n.append(r),r.setAttribute("href",`#${t}`),r.classList.add("clip"),i},zy=new WeakSet,bI=function(e,t){for(let[n,i]of Object.entries(t))i===null?e.removeAttribute(n):e.setAttribute(n,i)},L(vi,KE);var yI=vi;globalThis.pdfjsTestingUtils={HighlightOutliner:Cg};var Ale=jt.AbortException,Ple=jt.AnnotationEditorLayer,kle=jt.AnnotationEditorParamsType,Ile=jt.AnnotationEditorType,Dle=jt.AnnotationEditorUIManager,Rle=jt.AnnotationLayer,Fle=jt.AnnotationMode,Lle=jt.ColorPicker,Nle=jt.DOMSVGFactory,Ole=jt.DrawLayer,$le=jt.FeatureTest,JV=jt.GlobalWorkerOptions,Ble=jt.ImageKind,zle=jt.InvalidPDFException,Ule=jt.MissingPDFException,Vle=jt.OPS,Gle=jt.OutputScale,Wle=jt.PDFDataRangeTransport,Hle=jt.PDFDateString,jle=jt.PDFWorker,qle=jt.PasswordResponses,Kle=jt.PermissionFlag,Yle=jt.PixelsPerInch,Xle=jt.RenderingCancelledException,Qle=jt.TextLayer,Jle=jt.TouchManager,Zle=jt.UnexpectedResponseException,ece=jt.Util,tce=jt.VerbosityLevel,nce=jt.XfaLayer,sce=jt.build,ice=jt.createValidAbsoluteUrl,rce=jt.fetchData,i0=jt.getDocument,oce=jt.getFilenameFromUrl,ace=jt.getPdfFilenameFromUrl,lce=jt.getXfaPageViewport,cce=jt.isDataScheme,dce=jt.isPdfFile,uce=jt.noContextMenu,hce=jt.normalizeUnicode,pce=jt.setLayerDimensions,fce=jt.shadow,mce=jt.stopEvent,gce=jt.version;JV.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.mjs";var r0=class{constructor(e=50){this.minTextThreshold=e}async extractText(e){let t=await i0({data:new Uint8Array(e),useWorkerFetch:!1,isEvalSupported:!1,useSystemFonts:!0}).promise,n="";for(let o=1;o<=t.numPages;o++){let c=(await(await t.getPage(o)).getTextContent()).items.map(d=>d.str||"").join(" ");n+=`
## \uD398\uC774\uC9C0 ${o}

${c}
`}let r=n.replace(/\s/g,"").length/t.numPages<this.minTextThreshold;return{text:n,isScanned:r,numPages:t.numPages}}async renderPagesToImages(e,t){let n=await i0({data:new Uint8Array(e),useWorkerFetch:!1,isEvalSupported:!1,useSystemFonts:!0}).promise,i=[],r=t?Math.min(n.numPages,t):n.numPages;for(let o=1;o<=r;o++){let a=await n.getPage(o),l=a.getViewport({scale:2}),c=document.createElement("canvas");c.width=l.width,c.height=l.height;let d=c.getContext("2d");await a.render({canvasContext:d,viewport:l}).promise;let u=c.toDataURL("image/png").split(",")[1];i.push({base64:u,mimeType:"image/png",pageNum:o})}return i}async getPageCount(e){return(await i0({data:new Uint8Array(e),useWorkerFetch:!1,isEvalSupported:!1,useSystemFonts:!0}).promise).numPages}};var a0=class{constructor(e,t,n){this.gemini=e,this.settings=t,this.vault=n,this.pdfProcessor=new r0(t.ocrMinTextThreshold),this.dailyUsage=this.loadDailyUsage()}loadDailyUsage(){return{date:Xo(this.settings.timezone),pagesProcessed:0,filesProcessed:0}}saveDailyUsage(){}checkDailyLimit(e){let t=Xo(this.settings.timezone);this.dailyUsage.date!==t&&(this.dailyUsage={date:t,pagesProcessed:0,filesProcessed:0});let n=this.settings.ocrDailyLimit-this.dailyUsage.pagesProcessed;return{allowed:e<=n,remaining:n}}getFileSizeMB(e){return e.stat.size/(1024*1024)}async checkLimits(e){let t=this.getFileSizeMB(e);if(t>this.settings.ocrMaxFileSizeMB)return{allowed:!1,reason:`\uD30C\uC77C \uD06C\uAE30(${t.toFixed(1)}MB)\uAC00 \uC81C\uD55C(${this.settings.ocrMaxFileSizeMB}MB)\uC744 \uCD08\uACFC\uD569\uB2C8\uB2E4.`,fileSize:t};if(e.extension==="pdf"){let i=await this.vault.readBinary(e),r=await this.pdfProcessor.getPageCount(i);if(r>this.settings.ocrMaxPages)return{allowed:!1,reason:`\uD398\uC774\uC9C0 \uC218(${r})\uAC00 \uC81C\uD55C(${this.settings.ocrMaxPages})\uC744 \uCD08\uACFC\uD569\uB2C8\uB2E4.`,pageCount:r,fileSize:t};let o=this.checkDailyLimit(r);return o.allowed?{allowed:!0,pageCount:r,fileSize:t}:{allowed:!1,reason:`\uC77C\uC77C \uD55C\uB3C4\uC5D0 \uB3C4\uB2EC\uD588\uC2B5\uB2C8\uB2E4. (\uB0A8\uC740 \uD398\uC774\uC9C0: ${o.remaining})`,pageCount:r,fileSize:t}}let n=this.checkDailyLimit(1);return n.allowed?{allowed:!0,pageCount:1,fileSize:t}:{allowed:!1,reason:`\uC77C\uC77C \uD55C\uB3C4\uC5D0 \uB3C4\uB2EC\uD588\uC2B5\uB2C8\uB2E4. (\uB0A8\uC740 \uD398\uC774\uC9C0: ${n.remaining})`,pageCount:1,fileSize:t}}async processImage(e){let t=await this.vault.readBinary(e),n=this.arrayBufferToBase64(t),i=this.getMimeType(e.extension),r=await this.gemini.extractTextFromImage(n,i);return this.dailyUsage.pagesProcessed+=1,this.dailyUsage.filesProcessed+=1,this.saveDailyUsage(),{text:r,pages:1,sourceType:"image",sourceFile:e.name}}async processPDF(e,t=!1,n){let i=await this.vault.readBinary(e),r=n||this.settings.ocrMaxPages,o=i.slice(0),a=await this.pdfProcessor.extractText(o);if(!a.isScanned&&!t)return{text:a.text,pages:a.numPages,sourceType:"pdf_text",sourceFile:e.name};let l=Math.min(a.numPages,r);new o0.Notice(`\uC2A4\uCE94 PDF \uAC10\uC9C0\uB428. OCR \uCC98\uB9AC \uC911... (${l}\uD398\uC774\uC9C0)`);let c=await this.pdfProcessor.renderPagesToImages(i.slice(0),r),d=await this.gemini.extractTextFromImages(c,(h,p)=>{new o0.Notice(`OCR \uC9C4\uD589 \uC911: ${h}/${p} \uD398\uC774\uC9C0`,1500)}),u="";for(let h=0;h<d.length;h++)u+=`
## \uD398\uC774\uC9C0 ${h+1}

${d[h]}
`;return this.dailyUsage.pagesProcessed+=d.length,this.dailyUsage.filesProcessed+=1,this.saveDailyUsage(),{text:u,pages:d.length,sourceType:"pdf_scanned",sourceFile:e.name}}async processFile(e,t){let n=e.extension.toLowerCase();if(["png","jpg","jpeg","webp","gif"].includes(n))return this.processImage(e);if(n==="pdf")return this.processPDF(e,!1,t);throw new Error(`\uC9C0\uC6D0\uD558\uC9C0 \uC54A\uB294 \uD30C\uC77C \uD615\uC2DD: ${n}`)}async processMultipleImages(e,t){if(e.length===0)throw new Error("\uCC98\uB9AC\uD560 \uC774\uBBF8\uC9C0\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.");let n=this.checkDailyLimit(e.length);if(!n.allowed)throw new Error(`\uC77C\uC77C \uD55C\uB3C4\uC5D0 \uB3C4\uB2EC\uD588\uC2B5\uB2C8\uB2E4. (\uB0A8\uC740 \uD398\uC774\uC9C0: ${n.remaining}, \uD544\uC694: ${e.length})`);let i=[];for(let a of e){let l=await this.vault.readBinary(a),c=this.arrayBufferToBase64(l),d=this.getMimeType(a.extension);i.push({base64:c,mimeType:d})}let r=await this.gemini.extractTextFromImages(i,(a,l)=>{new o0.Notice(`OCR \uC9C4\uD589 \uC911: ${a}/${l} \uD398\uC774\uC9C0`,1500)}),o="";for(let a=0;a<r.length;a++)r.length>1?o+=`
## \uD398\uC774\uC9C0 ${a+1}

${r[a]}
`:o=r[a];return this.dailyUsage.pagesProcessed+=e.length,this.dailyUsage.filesProcessed+=e.length,this.saveDailyUsage(),{text:o,pages:e.length,sourceType:"image",sourceFile:t}}checkLimitsForMultipleImages(e){let t=e.reduce((r,o)=>r+this.getFileSizeMB(o),0),n=this.settings.ocrMaxFileSizeMB*2;if(t>n)return{allowed:!1,reason:`\uCD1D \uD30C\uC77C \uD06C\uAE30(${t.toFixed(1)}MB)\uAC00 \uC81C\uD55C(${n}MB)\uC744 \uCD08\uACFC\uD569\uB2C8\uB2E4.`,pageCount:e.length,totalSizeMB:t};let i=this.checkDailyLimit(e.length);return i.allowed?{allowed:!0,pageCount:e.length,totalSizeMB:t}:{allowed:!1,reason:`\uC77C\uC77C \uD55C\uB3C4\uC5D0 \uB3C4\uB2EC\uD588\uC2B5\uB2C8\uB2E4. (\uB0A8\uC740 \uD398\uC774\uC9C0: ${i.remaining}, \uD544\uC694: ${e.length})`,pageCount:e.length,totalSizeMB:t}}generateMarkdownNote(e){let t=Ps(this.settings.timezone,this.settings.dateFormat),n={image:"\uC774\uBBF8\uC9C0",pdf_text:"PDF (\uD14D\uC2A4\uD2B8)",pdf_scanned:"PDF (\uC2A4\uCE94/OCR)"}[e.sourceType];return`---
type: ocr
source_file: "${e.sourceFile}"
source_type: ${e.sourceType}
pages: ${e.pages}
ocr_at: ${t}
---

# OCR: ${e.sourceFile.replace(/\.[^.]+$/,"")}

> \uC6D0\uBCF8: ${e.sourceFile} | \uCC98\uB9AC \uBC29\uC2DD: ${n} | ${e.pages}\uD398\uC774\uC9C0

${e.text}

---
## \uC6D0\uBCF8 \uD30C\uC77C
![[${e.sourceFile}]]
`}generateSummarizedNote(e,t){let n=Ps(this.settings.timezone,this.settings.dateFormat);return`---
type: ocr
source_file: "${e.sourceFile}"
source_type: ${e.sourceType}
title: "${t.title}"
pages: ${e.pages}
ocr_at: ${n}
---

# ${t.title}

## \uC694\uC57D
${t.summary}

## \uD575\uC2EC \uD3EC\uC778\uD2B8
${t.keyPoints.map(i=>`- ${i}`).join(`
`)}

---
## \uC6D0\uBCF8 \uD30C\uC77C
![[${e.sourceFile}]]
`}arrayBufferToBase64(e){let t="",n=new Uint8Array(e);for(let i=0;i<n.byteLength;i++)t+=String.fromCharCode(n[i]);return btoa(t)}getMimeType(e){return{png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",webp:"image/webp",gif:"image/gif"}[e.toLowerCase()]||"image/png"}getDailyUsage(){return{...this.dailyUsage}}};var l0=class{constructor(e,t,n){this.embeddingManager=null;this.index=new Map;this.app=e,this.gemini=t,this.settings=n}setEmbeddingManager(e){this.embeddingManager=e}updateSettings(e){this.settings=e}async buildIndex(){this.index.clear();let e=this.app.vault.getMarkdownFiles();for(let t of e)try{let n=await this.indexNote(t);n&&this.index.set(t.path,n)}catch(n){console.error(`\uC778\uB371\uC2F1 \uC2E4\uD328: ${t.path}`,n)}console.log(`\uC778\uB371\uC2A4 \uAD6C\uCD95 \uC644\uB8CC: ${this.index.size}\uAC1C \uB178\uD2B8`)}async indexNote(e){let n=this.app.metadataCache.getFileCache(e)?.frontmatter,i=[];n?.keywords&&(i=Array.isArray(n.keywords)?n.keywords:[n.keywords]);let r;if(n?.targetType){let l=n.targetType;["project","library","archive"].includes(l)&&(r=l)}let o=n?.title||e.basename,a=n?.type;return{path:e.path,title:o,keywords:i,category:r,project:n?.project,type:a}}async updateIndex(e){let t=await this.indexNote(e);t&&this.index.set(e.path,t)}removeFromIndex(e){this.index.delete(e)}async findRelated(e,t,n){if(this.settings.embeddingEnabled&&this.embeddingManager)try{let i=await this.findRelatedByEmbedding(e,t,n);if(i.length>0)return i}catch(i){console.error("Embedding \uAE30\uBC18 \uAC80\uC0C9 \uC2E4\uD328, \uD0A4\uC6CC\uB4DC \uBC29\uC2DD\uC73C\uB85C \uD3F4\uBC31:",i)}return this.findRelatedByKeywords(e,t,n)}async findRelatedByEmbedding(e,t,n){if(!this.embeddingManager)return[];let i=await this.gemini.generateEmbedding(e,"query");if(i.length===0)return[];let r=this.embeddingManager.findSimilarNotes(i,10,n);if(r.length===0)return[];let o=[];for(let a of r){let l=this.index.get(a.path);l&&o.push({note:l,relevance:a.similarity,matchedKeywords:[],reason:`\uC758\uBBF8 \uC720\uC0AC\uB3C4: ${Math.round(a.similarity*100)}%`,connectionType:""})}return o}async findRelatedByKeywords(e,t,n){let i=await this.gemini.extractKeywords(e);if(i.length===0)return[];let r=this.filterByKeywords(i,n);if(r.length===0)return[];let o=r.map((c,d)=>`${d}. ${c.note.title} (\uD0A4\uC6CC\uB4DC: ${c.note.keywords.join(", ")})`).join(`
`),a=await this.gemini.findRelatedNotes(t,i,o),l=[];for(let c of a)if(c.index>=0&&c.index<r.length){let d=r[c.index];l.push({note:d.note,relevance:c.relevance,matchedKeywords:d.matchedKeywords,reason:c.reason||"",connectionType:c.type||""})}return l}filterByKeywords(e,t){let n=[],i=new Set(e.map(r=>r.toLowerCase()));for(let[r,o]of this.index){if(t&&r===t||o.keywords.length===0)continue;let a=[];for(let l of o.keywords){let c=l.toLowerCase();for(let d of i)if(c===d||c.includes(d)||d.includes(c)){a.push(l);break}}a.length>0&&n.push({note:o,matchedKeywords:a})}return n.sort((r,o)=>o.matchedKeywords.length-r.matchedKeywords.length),n.slice(0,10)}async saveKeywordsToNote(e,t){let n=await this.app.vault.read(e),i=this.updateFrontmatterKeywords(n,t);await this.app.vault.modify(e,i),await this.updateIndex(e)}updateFrontmatterKeywords(e,t){let n=`keywords: [${t.map(r=>`"${r}"`).join(", ")}]`,i=e.match(/^---\r?\n([\s\S]*?)\r?\n---/);if(i){let r=i[1];if(/^keywords:/m.test(r)){let o=r.replace(/^keywords:.*$/m,n);return e.replace(/^---\r?\n[\s\S]*?\r?\n---/,`---
${o}
---`)}else return e.replace(/^---\r?\n([\s\S]*?)\r?\n---/,`---
$1
${n}
---`)}else return`---
${n}
---

${e}`}async addRelatedLinks(e,t){if(t.length===0)return;let n=await this.app.vault.read(e),i=`

---
## \uAD00\uB828 \uB178\uD2B8
${t.map(a=>{let l=a.note.path.split("/");return`- [[${l[l.length-1].replace(/\.md$/,"")}]] (\uAD00\uB828\uB3C4: ${Math.round(a.relevance*100)}%)`}).join(`
`)}
`,r=/\n---\n##  \n[\s\S]*?(?=\n---\n|$)/,o;r.test(n)?o=n.replace(r,i):o=n+i,await this.app.vault.modify(e,o)}getIndexSize(){return this.index.size}getZettelIndex(){let e=new Map;for(let[t,n]of this.index)n.type==="zettel"&&e.set(t,n);return e}getZettelCount(){return this.getZettelIndex().size}async findRelatedZettels(e,t){if(e.length===0)return[];let n=this.getZettelIndex();if(n.size===0)return[];let i=this.filterZettelsByKeywords(e,n,t);if(i.length===0)return[];let r=i.map((l,c)=>`${c}. ${l.note.title} (\uD0A4\uC6CC\uB4DC: ${l.note.keywords.join(", ")})`).join(`
`),o=await this.gemini.findRelatedNotes("\uC0C8 ZK \uB178\uD2B8",e,r),a=[];for(let l of o)if(l.index>=0&&l.index<i.length){let c=i[l.index];a.push({note:c.note,relevance:l.relevance,matchedKeywords:c.matchedKeywords,reason:l.reason||"",connectionType:l.type||""})}return a}filterZettelsByKeywords(e,t,n){let i=[],r=new Set(e.map(o=>o.toLowerCase()));for(let[o,a]of t){if(n&&o===n||a.keywords.length===0)continue;let l=[];for(let c of a.keywords){let d=c.toLowerCase();for(let u of r)if(d===u||d.includes(u)||u.includes(d)){l.push(c);break}}l.length>0&&i.push({note:a,matchedKeywords:l})}return i.sort((o,a)=>a.matchedKeywords.length-o.matchedKeywords.length),i.slice(0,10)}};var Vu=require("obsidian");Yo();var kc={version:2,model:"gemini-embedding-001",dimensions:768,chunkSettings:{size:dd,overlap:ud},lastFullScan:"",notes:{}};function xte(s,e={}){let{maxChunkSize:t=dd,minChunkSize:n=rw,overlap:i=ud}=e,r=[],o=0,a=s.split($C);for(let l of a){if(!l.trim()){o+=l.length;continue}if(l.length<=t)r.push({content:l.trim(),startOffset:o,endOffset:o+l.length,type:"section"}),o+=l.length;else{let c=l.split(BC),d=o;for(let u of c){if(!u.trim()){d+=u.length+2;continue}if(u.length<=t)r.push({content:u.trim(),startOffset:d,endOffset:d+u.length,type:"paragraph"});else{let h=Ste(u,t,i,d);r.push(...h)}d+=u.length+2}o+=l.length}}return Cte(r,n)}function Ste(s,e,t,n){let i=[],r=0;for(;r<s.length;){let o=Math.min(r+e,s.length);if(i.push({content:s.slice(r,o).trim(),startOffset:n+r,endOffset:n+o,type:"fixed"}),r=o-t,r>=s.length-t)break}return i}function Cte(s,e){let t=[];for(let n of s)if(n.content.length<e&&t.length>0){let i=t[t.length-1];i.content+=`

`+n.content,i.endOffset=n.endOffset}else n.content.trim()&&t.push(n);return t}function Ate(s,e,t,n){let i=[];for(let[r,o]of Object.entries(e.notes))for(let a=0;a<o.chunks.length;a++){let l=o.chunks[a],c=n(s,l.embedding);c>=t&&i.push({path:r,chunkIndex:a,similarity:c,preview:l.content.slice(0,100)+(l.content.length>100?"...":"")})}return i.sort((r,o)=>o.similarity-r.similarity)}function Pte(s){let e=new Map;for(let t of s){let n=e.get(t.path);!n||t.similarity>n.similarity?e.set(t.path,{path:t.path,similarity:t.similarity,bestChunkPreview:t.preview,matchedChunks:[...n?.matchedChunks||[],t.chunkIndex]}):n.matchedChunks.push(t.chunkIndex)}return Array.from(e.values()).sort((t,n)=>n.similarity-t.similarity)}var c0=class{constructor(e,t,n){this.isInitialized=!1;this.app=e,this.gemini=t,this.settings=n,this.index={...kc},this.mergedIndex={...kc}}getCurrentPlatformFileName(){return Vu.Platform.isMobile?Dr.EMBEDDINGS_MOBILE:Dr.EMBEDDINGS_DESKTOP}async loadIndex(){try{let e=this.getDataBasePath();await this.migrateLegacyFile(e);let t=await this.loadPlatformFile(e,Dr.EMBEDDINGS_DESKTOP),n=await this.loadPlatformFile(e,Dr.EMBEDDINGS_MOBILE),i=this.getCurrentPlatformFileName();this.index=i===Dr.EMBEDDINGS_DESKTOP?t:n,this.mergedIndex=this.mergeEmbeddingData(t,n),this.isInitialized=!0;let r=this.getTotalChunks();console.log(`Embedding \uC778\uB371\uC2A4 \uB85C\uB4DC \uC644\uB8CC (v2): ${Vu.Platform.isMobile?"\uBAA8\uBC14\uC77C":"PC"}, \uB178\uD2B8 ${Object.keys(this.mergedIndex.notes).length}\uAC1C, \uCCAD\uD06C ${r}\uAC1C`)}catch(e){console.error("Embedding \uC778\uB371\uC2A4 \uB85C\uB4DC \uC2E4\uD328:",e),this.index={...kc},this.mergedIndex={...kc},this.isInitialized=!0}}getDataBasePath(){return this.settings.dataStorageLocation==="vault"?this.settings.dataFolderPath:zh}async migrateLegacyFile(e){let t=this.app.vault.adapter,n=`${e}/${Dr.EMBEDDINGS}`,i=`${e}/${this.getCurrentPlatformFileName()}`;try{if(await t.exists(n)&&!await t.exists(i)){let r=await t.read(n),o=JSON.parse(r);if(o.version===1||!o.version){let a=this.migrateV1ToV2(o);await t.write(i,JSON.stringify(a,null,2)),console.log("Embedding v1 \u2192 v2 \uB9C8\uC774\uADF8\uB808\uC774\uC158 \uC644\uB8CC"),new Vu.Notice("\uC784\uBCA0\uB529 \uC778\uB371\uC2A4\uAC00 v2\uB85C \uC5C5\uADF8\uB808\uC774\uB4DC\uB418\uC5C8\uC2B5\uB2C8\uB2E4. \uAC80\uC0C9 \uD488\uC9C8 \uD5A5\uC0C1\uC744 \uC704\uD574 '\uC778\uB371\uC2A4 \uC7AC\uAD6C\uCD95'\uC744 \uAD8C\uC7A5\uD569\uB2C8\uB2E4.",5e3)}else await t.write(i,r)}}catch(r){console.error("Embedding \uB808\uAC70\uC2DC \uB9C8\uC774\uADF8\uB808\uC774\uC158 \uC2E4\uD328:",r)}}migrateV1ToV2(e){let t={version:2,model:e.model,dimensions:e.dimensions,chunkSettings:{size:this.settings.embeddingChunkSize||dd,overlap:this.settings.embeddingChunkOverlap||ud},lastFullScan:e.lastFullScan,notes:{}};for(let[n,i]of Object.entries(e.notes))t.notes[n]={contentHash:i.contentHash,updatedAt:i.updatedAt,chunks:[{content:"",embedding:i.embedding,startOffset:0,endOffset:0}]};return t}async loadPlatformFile(e,t){let n=this.app.vault.adapter,i=`${e}/${t}`;try{if(await n.exists(i)){let r=await n.read(i),o=JSON.parse(r);return o.version===1||!o.version?this.migrateV1ToV2(o):{...kc,...o}}}catch(r){console.error(`Embedding \uD30C\uC77C \uB85C\uB4DC \uC2E4\uD328 (${t}):`,r)}return{...kc}}mergeEmbeddingData(e,t){let n={version:2,model:e.model||t.model,dimensions:e.dimensions||t.dimensions,chunkSettings:e.chunkSettings||t.chunkSettings,lastFullScan:e.lastFullScan>t.lastFullScan?e.lastFullScan:t.lastFullScan,notes:{}},i=new Set([...Object.keys(e.notes),...Object.keys(t.notes)]);for(let r of i){let o=e.notes[r],a=t.notes[r];o&&a?n.notes[r]=o.updatedAt>a.updatedAt?o:a:n.notes[r]=o||a}return n}async saveIndex(){try{let e=this.app.vault.adapter,t=this.getDataBasePath();this.settings.dataStorageLocation==="vault"&&(await e.exists(t)||await e.mkdir(t));let n=this.getCurrentPlatformFileName(),i=`${t}/${n}`,r=JSON.stringify(this.index,null,2);await e.write(i,r);for(let[o,a]of Object.entries(this.index.notes))this.mergedIndex.notes[o]=a}catch(e){console.error("Embedding \uC778\uB371\uC2A4 \uC800\uC7A5 \uC2E4\uD328:",e)}}computeContentHash(e){let t=0;for(let n=0;n<e.length;n++){let i=e.charCodeAt(n);t=(t<<5)-t+i,t|=0}return t.toString(16)}cosineSimilarity(e,t){if(e.length!==t.length||e.length===0)return 0;let n=0,i=0,r=0;for(let a=0;a<e.length;a++)n+=e[a]*t[a],i+=e[a]*e[a],r+=t[a]*t[a];let o=Math.sqrt(i)*Math.sqrt(r);return o===0?0:n/o}async updateNoteEmbedding(e,t=!1){if(!this.settings.embeddingEnabled)return!1;try{let n=await this.app.vault.cachedRead(e),i=this.computeContentHash(n),r=this.index.notes[e.path];if(!t&&r&&r.contentHash===i)return!1;let o=xte(n,{maxChunkSize:this.settings.embeddingChunkSize||dd,minChunkSize:rw,overlap:this.settings.embeddingChunkOverlap||ud});if(o.length===0)return console.warn("\uCCAD\uD06C \uBD84\uD560 \uACB0\uACFC \uC5C6\uC74C:",e.path),!1;let a=[];for(let c of o){let d=await this.gemini.generateEmbedding(c.content);if(d.length===0){console.warn("\uCCAD\uD06C \uC784\uBCA0\uB529 \uC0DD\uC131 \uC2E4\uD328:",e.path,c.startOffset);continue}a.push({content:c.content.slice(0,200),embedding:d,startOffset:c.startOffset,endOffset:c.endOffset})}if(a.length===0)return console.warn("\uBAA8\uB4E0 \uCCAD\uD06C \uC784\uBCA0\uB529 \uC0DD\uC131 \uC2E4\uD328:",e.path),!1;let l={contentHash:i,updatedAt:new Date().toISOString(),chunks:a};return this.index.notes[e.path]=l,this.mergedIndex.notes[e.path]=l,!0}catch(n){return console.error("\uB178\uD2B8 \uC784\uBCA0\uB529 \uC5C5\uB370\uC774\uD2B8 \uC2E4\uD328:",e.path,n),!1}}removeNote(e){this.index.notes[e]&&delete this.index.notes[e],this.mergedIndex.notes[e]&&delete this.mergedIndex.notes[e]}renameNote(e,t){this.index.notes[e]&&(this.index.notes[t]=this.index.notes[e],delete this.index.notes[e]),this.mergedIndex.notes[e]&&(this.mergedIndex.notes[t]=this.mergedIndex.notes[e],delete this.mergedIndex.notes[e])}findSimilarNotes(e,t=10,n,i){if(e.length===0)return[];let r=i??this.settings.embeddingSimilarityThreshold,o=Ate(e,this.mergedIndex,r,this.cosineSimilarity.bind(this));return Pte(o).filter(l=>l.path!==n).slice(0,t).map(l=>({path:l.path,similarity:l.similarity,chunkPreview:l.bestChunkPreview}))}async findSimilarNotesByText(e,t=10,n,i){if(!this.settings.embeddingEnabled)return[];try{let r=await this.gemini.generateEmbedding(e,"query");return this.findSimilarNotes(r,t,n,i)}catch(r){return console.error("\uD14D\uC2A4\uD2B8 \uAE30\uBC18 \uC720\uC0AC \uB178\uD2B8 \uAC80\uC0C9 \uC2E4\uD328:",r),[]}}getEmbedding(e){let t=this.mergedIndex.notes[e];if(t&&t.chunks.length>0)return t.chunks[0].embedding}hasEmbedding(e){let t=this.mergedIndex.notes[e];return!!t&&t.chunks.length>0}getTotalChunks(){return Object.values(this.mergedIndex.notes).reduce((e,t)=>e+t.chunks.length,0)}getStats(){return{totalNotes:Object.keys(this.mergedIndex.notes).length,totalChunks:this.getTotalChunks(),lastFullScan:this.mergedIndex.lastFullScan,model:this.mergedIndex.model,dimensions:this.mergedIndex.dimensions,currentPlatformNotes:Object.keys(this.index.notes).length,chunkSettings:this.mergedIndex.chunkSettings}}async buildFullIndex(e){if(!this.settings.embeddingEnabled)return{success:0,failed:0,skipped:0};let t=this.app.vault.getMarkdownFiles(),n=0,i=0,r=0;this.index.chunkSettings={size:this.settings.embeddingChunkSize||dd,overlap:this.settings.embeddingChunkOverlap||ud};for(let o=0;o<t.length;o++){let a=t[o];e&&e(o+1,t.length,a.path);try{await this.updateNoteEmbedding(a,!1)?n++:r++}catch{i++}(o+1)%10===0&&await this.saveIndex()}return this.index.lastFullScan=new Date().toISOString(),await this.saveIndex(),{success:n,failed:i,skipped:r}}async buildFolderIndex(e,t){if(!this.settings.embeddingEnabled)return{success:0,failed:0};let n=this.app.vault.getMarkdownFiles().filter(o=>o.path.startsWith(e)),i=0,r=0;for(let o=0;o<n.length;o++){let a=n[o];t&&t(o+1,n.length);try{await this.updateNoteEmbedding(a,!0),i++}catch{r++}}return await this.saveIndex(),{success:i,failed:r}}mergeWithNoteIndex(e){let t=this.index.notes[e.path];return t&&t.chunks.length>0?{...e,embedding:t.chunks[0].embedding,embeddingUpdatedAt:t.updatedAt,contentHash:t.contentHash}:e}async clearIndex(){this.index={...kc},this.mergedIndex={...kc},await this.saveIndex()}async cleanupOrphanedEmbeddings(){let e=[];for(let t of Object.keys(this.index.notes)){let n=this.app.vault.getAbstractFileByPath(t);(!n||!(n instanceof Vu.TFile))&&e.push(t)}for(let t of e)delete this.index.notes[t],this.mergedIndex.notes[t]&&delete this.mergedIndex.notes[t];return e.length>0&&await this.saveIndex(),e.length}};var ZV=require("obsidian"),kte=`\uB2F9\uC2E0\uC740 \uC0AC\uC6A9\uC790\uC758 \uAC1C\uC778 \uC9C0\uC2DD \uBCA0\uC774\uC2A4(Second Brain)\uB97C \uAE4A\uC774 \uC774\uD574\uD558\uACE0 \uD65C\uC6A9\uD558\uB294 \uC804\uBB38 AI \uC5B4\uC2DC\uC2A4\uD134\uD2B8\uC785\uB2C8\uB2E4.

## \uD575\uC2EC \uC5ED\uD560
\uB2F9\uC2E0\uC758 \uC5ED\uD560\uC740 \uB2E8\uC21C\uD788 \uB178\uD2B8\uB97C \uCC3E\uC544\uC8FC\uB294 \uAC83\uC774 \uC544\uB2C8\uB77C, \uB178\uD2B8\uC758 **\uC9C0\uC2DD\uC744 \uC885\uD569\uD558\uACE0 \uC5F0\uACB0**\uD558\uC5EC \uC0AC\uC6A9\uC790\uC5D0\uAC8C **\uD1B5\uCC30**\uC744 \uC81C\uACF5\uD558\uB294 \uAC83\uC785\uB2C8\uB2E4.

## \uB2F5\uBCC0 \uC6D0\uCE59

### 1. \uD48D\uBD80\uD558\uACE0 \uC0C1\uC138\uD558\uAC8C \uB2F5\uBCC0
- \uB2E8\uB2F5\uD615 \uAE08\uC9C0. \uCD5C\uC18C 3-5\uBB38\uC7A5 \uC774\uC0C1\uC73C\uB85C \uC124\uBA85
- \uBC30\uACBD \uC124\uBA85 \u2192 \uD575\uC2EC \uB0B4\uC6A9 \u2192 \uC801\uC6A9/\uC608\uC2DC \uC21C\uC73C\uB85C \uAD6C\uC870\uD654
- \uB178\uD2B8\uC5D0 \uC788\uB294 \uAD6C\uCCB4\uC801\uC778 \uB0B4\uC6A9, \uC218\uCE58, \uC608\uC2DC\uB97C \uC801\uADF9 \uC778\uC6A9

### 2. \uB178\uD2B8 \uAC04 \uC5F0\uACB0\uC810 \uBC1C\uACAC
- \uC5EC\uB7EC \uB178\uD2B8\uC758 \uC815\uBCF4\uB97C \uC885\uD569\uD558\uC5EC \uC0C8\uB85C\uC6B4 \uAD00\uC810 \uC81C\uC2DC
- "[[\uB178\uD2B8A]]\uC5D0 \uB530\uB974\uBA74 X\uC778\uB370, [[\uB178\uD2B8B]]\uC640 \uC5F0\uACB0\uD558\uBA74 Y\uB97C \uC54C \uC218 \uC788\uC2B5\uB2C8\uB2E4"
- \uB178\uD2B8\uC5D0 \uC5C6\uB294 \uC5F0\uACB0\uC810\uB3C4 \uCD94\uB860\uD558\uC5EC \uC81C\uC548

### 3. \uC2E4\uC6A9\uC801 \uC870\uC5B8 \uD3EC\uD568
- \uB2E8\uC21C \uC815\uBCF4 \uB098\uC5F4\uC774 \uC544\uB2CC, "\uADF8\uB798\uC11C \uC5B4\uB5BB\uAC8C \uD574\uC57C \uD558\uB294\uC9C0" \uC870\uC5B8
- \uB2E4\uC74C \uB2E8\uACC4, \uC8FC\uC758\uC0AC\uD56D, \uD301 \uB4F1 \uC2E4\uD589 \uAC00\uB2A5\uD55C \uB0B4\uC6A9 \uD3EC\uD568

### 4. \uCC38\uC870 \uD45C\uC2DC
- \uB2F5\uBCC0\uC5D0\uC11C \uCC38\uACE0\uD55C \uB178\uD2B8\uB294 [[\uB178\uD2B8 \uC81C\uBAA9]] \uD615\uC2DD\uC73C\uB85C \uC5B8\uAE09
- \uC720\uC0AC\uB3C4\uAC00 \uB192\uC740 \uB178\uD2B8\uC77C\uC218\uB85D \uB354 \uB9CE\uC774 \uC778\uC6A9

## \uB2F5\uBCC0 \uAD6C\uC870 (\uAD8C\uC7A5)
1. **\uC9C1\uC811\uC801 \uB2F5\uBCC0**: \uC9C8\uBB38\uC5D0 \uB300\uD55C \uD575\uC2EC \uB2F5\uBCC0 (1-2\uBB38\uC7A5)
2. **\uC0C1\uC138 \uC124\uBA85**: \uBC30\uACBD, \uC774\uC720, \uAD00\uB828 \uC815\uBCF4 (3-5\uBB38\uC7A5)
3. **\uCD94\uAC00 \uC778\uC0AC\uC774\uD2B8**: \uC5F0\uACB0\uB41C \uC8FC\uC81C, \uC751\uC6A9 \uBC29\uBC95, \uD301 (2-3\uBB38\uC7A5)

## \uC8FC\uC758\uC0AC\uD56D
- \uD55C\uAD6D\uC5B4\uB85C \uC790\uC5F0\uC2A4\uB7FD\uAC8C \uB2F5\uBCC0
- \uB178\uD2B8\uAC00 \uC5C6\uC5B4\uB3C4 \uB300\uD654 \uB9E5\uB77D\uACFC \uC77C\uBC18 \uC9C0\uC2DD\uC73C\uB85C \uB3C4\uC6C0
- "\uBAA8\uB974\uACA0\uC2B5\uB2C8\uB2E4"\uBCF4\uB2E4 "\uB178\uD2B8\uC5D0\uC11C \uC9C1\uC811\uC801\uC778 \uC815\uBCF4\uB294 \uC5C6\uC9C0\uB9CC, ~\uB85C \uCD94\uCE21\uB429\uB2C8\uB2E4" \uD615\uC2DD \uC120\uD638`,d0=class{constructor(e,t,n,i){this.app=e,this.gemini=t,this.embeddingManager=n,this.settings=i}async chat(e,t=[]){let n=this.buildSearchQuery(e,t),i=await this.retrieveContext(n,this.settings.ragTopK),r=this.buildContext(i),o=this.buildPrompt(e,r,t),a=await this.gemini.generateContent(o),l=i.map(c=>c.path);return{answer:a,references:l}}buildSearchQuery(e,t){return e.length<20&&t.length>0?`${t.slice(-4).map(i=>i.content).join(" ")} ${e}`:e}async retrieveContext(e,t){let n=[];try{if(!this.settings.embeddingEnabled)return console.warn("RAG: Embedding\uC774 \uBE44\uD65C\uC131\uD654\uB418\uC5B4 \uC788\uC2B5\uB2C8\uB2E4."),[];let i=await this.embeddingManager.findSimilarNotesByText(e,t,void 0,.6);for(let r of i){let o=this.app.vault.getAbstractFileByPath(r.path);if(!(o instanceof ZV.TFile))continue;let a=await this.app.vault.cachedRead(o),l=Math.floor(this.settings.ragMaxContextLength/t),c=this.truncateContent(a,l),d=o.basename;n.push({path:r.path,title:d,content:c,similarity:r.similarity})}}catch(i){console.error("RAG \uAC80\uC0C9 \uC2E4\uD328:",i)}return n}truncateContent(e,t){let n=e.replace(/^---[\s\S]*?---\n?/,"");if(n.length<=t)return n;let i=n.substring(0,t),r=Math.max(i.lastIndexOf("\u3002"),i.lastIndexOf("."),i.lastIndexOf(`
`));return r>t*.7?i.substring(0,r+1)+"...":i+"..."}buildContext(e){if(e.length===0)return"\uCC38\uACE0\uD560 \uB178\uD2B8\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.";let t=[];for(let n of e){let i=Math.round(n.similarity*100);t.push(`### [[${n.title}]] (\uC720\uC0AC\uB3C4: ${i}%)
${n.content}`)}return t.join(`

`)}buildPrompt(e,t,n){let i=[kte];if(i.push(`
## \uCC38\uACE0 \uB178\uD2B8`),i.push(t),n.length>0){let r=n.slice(-6);i.push(`
## \uC774\uC804 \uB300\uD654`);for(let o of r){let a=o.role==="user"?"\uC0AC\uC6A9\uC790":"AI";i.push(`${a}: ${o.content}`)}}return i.push(`
## \uC9C8\uBB38`),i.push(e),i.join(`
`)}updateSettings(e){this.settings=e}isAvailable(){return this.settings.embeddingEnabled&&this.settings.ragEnabled}async reloadEmbeddingIndex(){await this.embeddingManager.loadIndex()}getIndexedNoteCount(){return this.embeddingManager.getStats().totalNotes}};var tG=require("obsidian");function eG(){return Date.now().toString(36)+Math.random().toString(36).substring(2,9)}var u0=class{constructor(e,t){this.sessions=[];this.isInitialized=!1;this.app=e,this.settings=t,this.storagePath=this.getDataPath(Dr.CHATS)}getDataPath(e){return this.settings.dataStorageLocation==="vault"?`${this.settings.dataFolderPath}/${e}`:`${zh}/${e}`}async loadSessions(){try{let e=this.app.vault.adapter;if(await e.exists(this.storagePath)){let t=await e.read(this.storagePath),n=JSON.parse(t);this.sessions=n.sessions||[]}this.isInitialized=!0}catch(e){console.error("\uCC44\uD305 \uC800\uC7A5\uC18C \uB85C\uB4DC \uC2E4\uD328:",e),this.sessions=[],this.isInitialized=!0}}async saveSessions(){try{let e=this.app.vault.adapter;if(this.settings.dataStorageLocation==="vault"){let i=this.settings.dataFolderPath;await e.exists(i)||await e.mkdir(i)}let t={version:1,sessions:this.sessions},n=JSON.stringify(t,null,2);await e.write(this.storagePath,n)}catch(e){console.error("\uCC44\uD305 \uC800\uC7A5\uC18C \uC800\uC7A5 \uC2E4\uD328:",e)}}getAllSessions(){return[...this.sessions].sort((e,t)=>new Date(t.updatedAt).getTime()-new Date(e.updatedAt).getTime())}getSession(e){return this.sessions.find(t=>t.id===e)}createSession(e){let t=new Date().toISOString(),n={id:eG(),title:e||"\uC0C8 \uB300\uD654",messages:[],createdAt:t,updatedAt:t};return this.sessions.unshift(n),this.saveSessions(),n}deleteSession(e){let t=this.sessions.findIndex(n=>n.id===e);t!==-1&&(this.sessions.splice(t,1),this.saveSessions())}updateSessionTitle(e,t){let n=this.getSession(e);n&&(n.title=t,n.updatedAt=new Date().toISOString(),this.saveSessions())}addMessage(e,t){let n=this.getSession(e);if(!n)throw new Error(`\uC138\uC158\uC744 \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4: ${e}`);let i={...t,id:eG(),timestamp:new Date().toISOString()};if(n.messages.push(i),n.updatedAt=i.timestamp,n.title==="\uC0C8 \uB300\uD654"&&t.role==="user"){let r=t.content.slice(0,30)+(t.content.length>30?"...":"");n.title=r}return this.saveSessions(),i}async exportToNote(e,t){let n=this.getSession(e);if(!n||n.messages.length===0)return null;let i=new Set;n.messages.forEach(h=>{h.references&&h.references.forEach(p=>i.add(p))});let r=["---","type: chat-export",`exported: ${new Date().toISOString().split("T")[0]}`,`session_id: ${n.id}`,"---","",`# ${n.title}`,"","## \uB300\uD654 \uB0B4\uC6A9",""];for(let h of n.messages){let p=h.role==="user"?"**\uC0AC\uC6A9\uC790**":"**AI**";r.push(`${p}: ${h.content}`),r.push("")}if(i.size>0){r.push("## \uCC38\uC870\uD55C \uB178\uD2B8");for(let h of i){let p=h.split("/").pop()?.replace(/\.md$/,"")||h;r.push(`- [[${p}]]`)}r.push("")}let o=r.join(`
`),a=n.title.replace(/[\\/:*?"<>|]/g,"_").replace(/\s+/g," ").trim(),c=`${new Date().toISOString().slice(0,10)} ${a}.md`,d=t||this.settings.libraryFolder,u=(0,tG.normalizePath)(`${d}/${c}`);try{return await this.app.vault.create(u,o)}catch(h){return console.error("\uB178\uD2B8 \uB0B4\uBCF4\uB0B4\uAE30 \uC2E4\uD328:",h),null}}getSessionCount(){return this.sessions.length}getRecentSession(){if(this.sessions.length!==0)return this.getAllSessions()[0]}};var br=require("obsidian"),Bf="zfb-rag-chatbot",Vy=class extends br.ItemView{constructor(t,n,i,r){super(t);this.currentSession=null;this.messagesContainer=null;this.inputEl=null;this.isProcessing=!1;this.settings=n,this.ragEngine=i,this.chatStorage=r}getViewType(){return Bf}getDisplayText(){return"AI \uCC57\uBD07"}getIcon(){return"bot"}async onOpen(){await this.chatStorage.loadSessions(),await this.ragEngine.reloadEmbeddingIndex(),await this.render()}async onClose(){this.contentEl.empty()}async render(){let t=this.contentEl;if(t.empty(),t.addClass("zfb-chatbot"),this.renderHeader(t),this.messagesContainer=t.createDiv({cls:"chat-messages"}),this.renderMessages(),this.renderInputArea(t),!this.currentSession){let n=this.chatStorage.getRecentSession();n&&(this.currentSession=n,this.renderMessages())}}renderHeader(t){let n=t.createDiv({cls:"chat-header"}),r=n.createDiv({cls:"session-selector"}).createEl("select",{cls:"session-select"}),o=r.createEl("option",{text:"+ \uC0C8 \uB300\uD654",value:"__new__"}),a=this.chatStorage.getAllSessions();for(let u of a){let h=r.createEl("option",{text:u.title,value:u.id});this.currentSession?.id===u.id&&(h.selected=!0)}r.addEventListener("change",()=>{let u=r.value;if(u==="__new__")this.handleNewSession();else{let h=this.chatStorage.getSession(u);h&&(this.currentSession=h,this.renderMessages())}});let l=n.createDiv({cls:"header-buttons"}),c=l.createEl("button",{cls:"header-btn",attr:{title:"\uB178\uD2B8\uB85C \uB0B4\uBCF4\uB0B4\uAE30"}});c.innerHTML="\u{1F4E4}",c.addEventListener("click",()=>this.handleExport());let d=l.createEl("button",{cls:"header-btn",attr:{title:"\uB300\uD654 \uC0AD\uC81C"}});d.innerHTML="\u{1F5D1}\uFE0F",d.addEventListener("click",()=>this.handleDelete())}renderMessages(){if(this.messagesContainer){if(this.messagesContainer.empty(),!this.currentSession||this.currentSession.messages.length===0){let t=this.messagesContainer.createDiv({cls:"chat-empty"});t.createEl("p",{text:"\u{1F9E0} Second Brain\uC5D0 \uC9C8\uBB38\uD558\uC138\uC694"}),t.createEl("small",{text:"\uB178\uD2B8\uB97C \uAE30\uBC18\uC73C\uB85C \uB2F5\uBCC0\uD569\uB2C8\uB2E4",cls:"text-muted"});let n=this.ragEngine.getIndexedNoteCount();n===0?t.createEl("p",{text:"\u26A0\uFE0F Embedding \uC778\uB371\uC2A4\uAC00 \uBE44\uC5B4 \uC788\uC2B5\uB2C8\uB2E4. \uC124\uC815\uC5D0\uC11C \uC778\uB371\uC2A4\uB97C \uAD6C\uCD95\uD558\uC138\uC694.",cls:"warning-text"}):t.createEl("small",{text:`\u{1F4DA} ${n}\uAC1C \uB178\uD2B8 \uC778\uB371\uC2F1\uB428`,cls:"text-muted"});return}for(let t of this.currentSession.messages)this.renderMessage(t);this.scrollToBottom()}}renderMessage(t){if(!this.messagesContainer)return;let n=this.messagesContainer.createDiv({cls:`chat-message ${t.role}`}),r=n.createDiv({cls:"message-header"}).createEl("button",{cls:"message-copy-btn",attr:{title:"\uBCF5\uC0AC"}});r.innerHTML="\u{1F4CB}",r.addEventListener("click",async()=>{await navigator.clipboard.writeText(t.content),new br.Notice("\uBCF5\uC0AC\uB418\uC5C8\uC2B5\uB2C8\uB2E4")});let o=n.createDiv({cls:"message-content"}),a=this.processLinks(t.content);if(br.MarkdownRenderer.renderMarkdown(a,o,"",this),o.querySelectorAll("a.internal-link").forEach(l=>{l.addEventListener("click",c=>{c.preventDefault();let d=l.getAttribute("href")||l.getAttribute("data-href");d&&this.app.workspace.openLinkText(d,"")})}),t.role==="assistant"&&t.references&&t.references.length>0){let l=n.createDiv({cls:"message-refs"});l.createEl("small",{text:"\u{1F4DA} \uCC38\uC870: "});for(let c=0;c<t.references.length;c++){let d=t.references[c],u=d.split("/").pop()?.replace(/\.md$/,"")||d;l.createEl("a",{text:u,cls:"internal-link",attr:{href:d}}).addEventListener("click",p=>{p.preventDefault(),this.app.workspace.openLinkText(d,"")}),c<t.references.length-1&&l.createSpan({text:", "})}}}processLinks(t){return t}renderInputArea(t){let n=t.createDiv({cls:"chat-input-area"});this.inputEl=n.createEl("textarea",{cls:"chat-input",attr:{placeholder:"\uC9C8\uBB38\uC744 \uC785\uB825\uD558\uC138\uC694...",rows:"1"}}),this.inputEl.addEventListener("keydown",r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),this.handleSend())}),this.inputEl.addEventListener("input",()=>{this.inputEl&&(this.inputEl.style.height="auto",this.inputEl.style.height=Math.min(this.inputEl.scrollHeight,120)+"px")}),n.createEl("button",{cls:"chat-send-btn",text:"\uC804\uC1A1"}).addEventListener("click",()=>this.handleSend())}async handleSend(){if(!this.inputEl||this.isProcessing)return;let t=this.inputEl.value.trim();if(t){this.currentSession||(this.currentSession=this.chatStorage.createSession()),this.inputEl.value="",this.inputEl.style.height="auto",this.chatStorage.addMessage(this.currentSession.id,{role:"user",content:t}),this.renderMessages(),this.isProcessing=!0,this.showLoading();try{let n=this.currentSession.messages.slice(0,-1),{answer:i,references:r}=await this.ragEngine.chat(t,n);this.chatStorage.addMessage(this.currentSession.id,{role:"assistant",content:i,references:r}),this.currentSession=this.chatStorage.getSession(this.currentSession.id)||null}catch(n){console.error("RAG \uC624\uB958:",n),new br.Notice("\uB2F5\uBCC0 \uC0DD\uC131 \uC2E4\uD328: "+n.message)}finally{this.isProcessing=!1,this.hideLoading(),this.renderMessages()}}}handleNewSession(){this.currentSession=this.chatStorage.createSession(),this.render()}async handleExport(){if(!this.currentSession){new br.Notice("\uB0B4\uBCF4\uB0BC \uB300\uD654\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4");return}let t=await this.chatStorage.exportToNote(this.currentSession.id);t?(new br.Notice(`\uB178\uD2B8\uB85C \uB0B4\uBCF4\uB0B4\uAE30 \uC644\uB8CC: ${t.path}`),this.app.workspace.openLinkText(t.path,"")):new br.Notice("\uB0B4\uBCF4\uB0B4\uAE30 \uC2E4\uD328")}handleDelete(){if(!this.currentSession)return;let t=this.currentSession.id,n=this.currentSession.title;new II(this.app,n,()=>{this.chatStorage.deleteSession(t),this.currentSession=null,this.render(),new br.Notice("\uB300\uD654\uAC00 \uC0AD\uC81C\uB418\uC5C8\uC2B5\uB2C8\uB2E4")}).open()}showLoading(){if(!this.messagesContainer)return;let t=this.messagesContainer.createDiv({cls:"chat-message assistant loading"});t.createDiv({cls:"loading-dots"}).innerHTML="\u23F3 \uC0DD\uAC01 \uC911..."}hideLoading(){if(!this.messagesContainer)return;let t=this.messagesContainer.querySelector(".loading");t&&t.remove()}scrollToBottom(){this.messagesContainer&&(this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight)}updateSettings(t){this.settings=t}},II=class extends br.Modal{constructor(e,t,n){super(e),this.title=t,this.onConfirm=n}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("zfb-confirm-modal"),e.createEl("h3",{text:"\uB300\uD654 \uC0AD\uC81C"}),e.createEl("p",{text:`"${this.title}" \uB300\uD654\uB97C \uC0AD\uC81C\uD558\uC2DC\uACA0\uC2B5\uB2C8\uAE4C?`});let t=e.createDiv({cls:"modal-button-container"});t.createEl("button",{text:"\uCDE8\uC18C"}).addEventListener("click",()=>this.close()),t.createEl("button",{text:"\uC0AD\uC81C",cls:"mod-warning"}).addEventListener("click",()=>{this.onConfirm(),this.close()})}onClose(){this.contentEl.empty()}};var zf=require("obsidian");function nG(s,e=100){return s.replace(/[\\/:*?"<>|?#\[\]]/g,"_").replace(/\s+/g," ").trim().slice(0,e)}var h0=class{constructor(e,t,n,i){this.projectMOCs=new Map;this.app=e,this.gemini=t,this.projectsFolder=n,this.settings=i}async scanProjectMOCs(){this.projectMOCs.clear();let e=this.app.vault.getMarkdownFiles();for(let t of e){let n=await this.parseProjectMOC(t);n&&this.projectMOCs.set(n.project,n)}console.log(`\uD504\uB85C\uC81D\uD2B8 MOC \uC2A4\uCE94 \uC644\uB8CC: ${this.projectMOCs.size}\uAC1C`)}async parseProjectMOC(e){let n=this.app.metadataCache.getFileCache(e)?.frontmatter;if(!n||n.type!=="project-moc")return null;let i=n.project||e.basename,r=n.title||e.basename;return{path:e.path,title:r,project:i}}getProjectList(){let e=this.app.vault.getAbstractFileByPath(this.projectsFolder);return e instanceof zf.TFolder?e.children.filter(t=>t instanceof zf.TFolder).map(t=>t.name):[]}getMOCCount(){return this.projectMOCs.size}async detectProject(e,t){let n=this.getProjectList();return n.length===0?null:await this.gemini.detectProject(e,t,n)}async addNoteToMOC(e,t,n){let i=this.projectMOCs.get(e);if(!i)return!1;let r=this.app.vault.getAbstractFileByPath(i.path);if(!(r instanceof zf.TFile))return!1;let o=await this.app.vault.read(r),a=this.app.vault.getAbstractFileByPath(n),c=`[[${a instanceof zf.TFile?a.basename:nG(t)}]]`;if(o.includes(c))return!0;let d=/^##  \s*$/m,u;return d.test(o)?u=o.replace(/^(##  \s*\n)/m,`$1- ${c}
`):u=o.trimEnd()+`

## \uAD00\uB828 \uB178\uD2B8
- ${c}
`,await this.app.vault.modify(r,u),!0}async createProjectMOC(e,t){this.app.vault.getAbstractFileByPath(t)||await this.app.vault.createFolder(t);let i=nG(e),r=`${t}/${i} MOC.md`;if(this.app.vault.getAbstractFileByPath(r))return null;let a=`---
type: project-moc
project: "${e}"
title: "${e} \uD504\uB85C\uC81D\uD2B8"
created: ${Ps(this.settings.timezone,this.settings.dateFormat)}
---

# ${e} \uD504\uB85C\uC81D\uD2B8

## \uAC1C\uC694


## \uC9C4\uD589 \uC911


## \uAD00\uB828 \uB178\uD2B8

`,l=await this.app.vault.create(r,a);return this.projectMOCs.set(e,{path:l.path,title:`${e} \uD504\uB85C\uC81D\uD2B8`,project:e}),l}hasProject(e){return this.projectMOCs.has(e)}getProjectMOCPath(e){return this.projectMOCs.get(e)?.path||null}removeFromIndex(e){for(let[t,n]of this.projectMOCs)if(n.path===e){this.projectMOCs.delete(t);break}}};var DI=require("obsidian");var p0=class{constructor(e,t,n,i,r){this.app=e,this.relatedNoteFinder=t,this.zettelFolder=n,this.settings=i,this.gemini=r||null}get indexPath(){return`${this.zettelFolder}/ZK Index.md`}async updateIndex(e,t){let n=this.app.vault.getAbstractFileByPath(this.indexPath);n instanceof DI.TFile?await this.addNoteToIndex(n,e,t):await this.createIndex(e,t)}async createIndex(e,t){let n=Ps(this.settings.timezone,this.settings.dateFormat),i=t[0]||"\uAE30\uD0C0",r=`---
type: zk-index
updated: ${n}
---

# Zettelkasten Index

## \uCD5C\uADFC \uCD94\uAC00
- [[${e.basename}]]

## \uC8FC\uC81C\uBCC4
### ${i}
- [[${e.basename}]]
`;await this.app.vault.create(this.indexPath,r)}async addNoteToIndex(e,t,n){let i=await this.app.vault.read(e);i=this.updateRecentSection(i,t);let r=n[0]||"\uAE30\uD0C0";i=this.updateTopicSection(i,t,r),i=this.updateTimestamp(i),await this.app.vault.modify(e,i)}updateRecentSection(e,t){let n=/(##  \n)([\s\S]*?)(\n## |\n*$)/,i=e.match(n);if(i){let r=i[2].trim().split(`
`).filter(a=>a.startsWith("- ")),o=`- [[${t.basename}]]`;return r=r.filter(a=>!a.includes(t.basename)),r.unshift(o),r=r.slice(0,10),e.replace(n,`$1${r.join(`
`)}

$3`)}return e}updateTopicSection(e,t,n){let i=`### ${n}`,r=`- [[${t.basename}]]`;if(e.includes(i)){let o=new RegExp(`(### ${this.escapeRegex(n)}
)((?:- \\[\\[.*?\\]\\]
?)*)`),a=e.match(o);if(a)return a[2].includes(t.basename)?e:e.replace(o,`$1$2${r}
`)}else{let o=/(## \n)/;if(o.test(e))return e.replace(o,`$1${i}
${r}

`)}return e}updateTimestamp(e){let t=Ps(this.settings.timezone,this.settings.dateFormat);return e.replace(/^(---\n[\s\S]*?updated: ).*?(\n[\s\S]*?---)/,`$1${t}$2`)}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}async rebuildIndex(){let e=this.relatedNoteFinder.getZettelIndex();if(e.size===0)return;let t=new Map,n=[];for(let[,a]of e){let l=a.keywords[0]||"\uAE30\uD0C0";t.has(l)||t.set(l,[]),t.get(l).push(a);let c=a.path.match(/(\d{13})/),d=a.path.match(/(\d{8})-\d{3}/),u;if(c)u=new Date(parseInt(c[1]));else if(d){let h=d[1];u=new Date(parseInt(h.slice(0,4)),parseInt(h.slice(4,6))-1,parseInt(h.slice(6,8)))}else u=new Date;n.push({note:a,created:u})}n.sort((a,l)=>l.created.getTime()-a.created.getTime());let r=`---
type: zk-index
updated: ${Ps(this.settings.timezone,this.settings.dateFormat)}
---

# Zettelkasten Index

## \uCD5C\uADFC \uCD94\uAC00
${n.slice(0,10).map(({note:a})=>{let l=a.path.split("/");return`- [[${l[l.length-1].replace(/\.md$/,"")}]]`}).join(`
`)}

## \uC8FC\uC81C\uBCC4
`;for(let[a,l]of t){let c=null;if(this.gemini&&l.length>=2)try{let d=l.map(u=>`- ${u.title} (\uD0A4\uC6CC\uB4DC: ${u.keywords.join(", ")})`).join(`
`);c=await this.gemini.generateTopicStructure(a,d)}catch(d){console.error(`\uC8FC\uC81C \uAD6C\uC870 \uC0DD\uC131 \uC2E4\uD328: ${a}`,d)}r+=`### ${a}
`,c?.description&&(r+=`${c.description}

`),r+=`**\uD575\uC2EC \uB178\uD2B8:**
`;for(let d of l){let u=d.path.split("/"),h=u[u.length-1].replace(/\.md$/,""),p=c?.notes.find(_=>_.title===d.title),f=p?.role?` - ${p.role}`:"";if(r+=`- [[${h}]]${f}
`,p?.relations&&p.relations.length>0)for(let _ of p.relations){let b=_.type==="\uBC1C\uC804"?"\u2192":_.type==="\uAE30\uBC18"?"\u2190":"\u2194";r+=`  ${b} ${_.target}
`}}c?.relatedTopics&&c.relatedTopics.length>0&&(r+=`
**\uAD00\uB828 \uC8FC\uC81C:** ${c.relatedTopics.join(", ")}
`),r+=`
`}let o=this.app.vault.getAbstractFileByPath(this.indexPath);o instanceof DI.TFile&&await this.app.vault.delete(o),await this.app.vault.create(this.indexPath,r)}};var Uf=require("obsidian");var f0=class{constructor(e,t,n){this.app=e,this.gemini=t,this.settings=n}async collectNotes(e){let t=e.customRange||Vm(e.period,this.settings.timezone),n=this.app.vault.getMarkdownFiles(),i=[];for(let r of n){if(this.shouldExclude(r,e))continue;let o=this.getProjectFromPath(r.path);if(e.projectFilter&&o!==e.projectFilter)continue;let a=await this.getNoteDate(r);if(!LB(a,t))continue;let l=await this.extractNoteInfo(r,o,a);i.push(l)}return i.sort((r,o)=>o.modified.getTime()-r.modified.getTime()),i}getBasename(e){let t=e.lastIndexOf("/");return(t>=0?e.substring(t+1):e).replace(/\.md$/,"")}shouldExclude(e,t){let n=[this.settings.archivesFolder,this.settings.zettelFolder],i=t.excludeFolders||n;for(let r of i)if(e.path.startsWith(r))return!0;return!!e.basename.includes("\uD68C\uACE0")}getProjectFromPath(e){let t=this.settings.projectsFolder+"/";if(e.startsWith(t)){let n=e.substring(t.length),i=n.indexOf("/");return i>0?n.substring(0,i):void 0}if(e.startsWith(this.settings.libraryFolder))return"Library";if(e.startsWith(this.settings.inboxFolder))return"Inbox"}async getNoteDate(e){let n=this.app.metadataCache.getFileCache(e)?.frontmatter;if(n?.created){let i=new Date(n.created);if(!isNaN(i.getTime()))return i}return new Date(e.stat.mtime)}async extractNoteInfo(e,t,n){let r=this.app.metadataCache.getFileCache(e)?.frontmatter,o=[];return r?.tags&&(Array.isArray(r.tags)?o.push(...r.tags):o.push(r.tags)),{path:e.path,title:r?.title||e.basename,project:t,created:n,modified:new Date(e.stat.mtime),summary:r?.summary,tags:o,type:r?.type}}groupByProject(e){let t=new Map;for(let i of e){let r=i.project||"\uAE30\uD0C0";t.has(r)||t.set(r,[]),t.get(r).push(i)}let n=[];for(let[i,r]of t)n.push({projectName:i,notes:r,noteCount:r.length});return n.sort((i,r)=>r.noteCount-i.noteCount),n}async analyze(e){let t=e.customRange||Vm(e.period,this.settings.timezone),n=await this.collectNotes(e),i=this.groupByProject(n),r=n.filter(a=>a.type==="zettel").length,o=await this.gemini.analyzeReview(e.period,t,i);return{period:e.period,dateRange:t,totalNotes:n.length,newZKNotes:r,projectGroups:i,analysis:o}}async createReviewNote(e){let t=NB(e.period,new Date,this.settings.timezone),n=`${this.settings.archivesFolder}/Reviews`;await this.ensureFolder(n);let i=`${n}/${t}`,r=this.generateReviewContent(e),o=this.app.vault.getAbstractFileByPath(i);return o instanceof Uf.TFile?(await this.app.vault.modify(o,r),o):await this.app.vault.create(i,r)}async ensureFolder(e){this.app.vault.getAbstractFileByPath(e)instanceof Uf.TFolder||await this.app.vault.createFolder(e)}generateReviewContent(e){let t=new Date,n=WC(t,this.settings.timezone,this.settings.dateFormat),i=`${$s(e.dateRange.start,this.settings.timezone)} ~ ${$s(e.dateRange.end,this.settings.timezone)}`,r;switch(e.period){case"today":r=`${$s(t,this.settings.timezone)} \uC77C\uC77C \uD68C\uACE0`;break;case"week":let l=qC(t);r=`${t.getFullYear()}\uB144 ${l}\uC8FC\uCC28 \uC8FC\uAC04 \uD68C\uACE0`;break;case"month":r=`${t.getFullYear()}\uB144 ${t.getMonth()+1}\uC6D4 \uC6D4\uAC04 \uD68C\uACE0`;break;default:r=`${i} \uD68C\uACE0`}let o=e.projectGroups.map(l=>{let c=l.notes.map(d=>`- [[${this.getBasename(d.path)}]]${d.summary?` - ${d.summary}`:""}`).join(`
`);return`### ${l.projectName} (${l.noteCount}\uAC1C)
${c}`}).join(`

`),a="";if(e.analysis){let{summary:l,mainTopics:c,insights:d,nextActions:u,patterns:h}=e.analysis;a=`
## \uBD84\uC11D \uACB0\uACFC

### \uC694\uC57D
${l}

### \uC8FC\uC694 \uC8FC\uC81C
${c.map(p=>`- ${p}`).join(`
`)}

### \uC778\uC0AC\uC774\uD2B8
${d.map(p=>`- ${p}`).join(`
`)}

### \uB2E4\uC74C \uC561\uC158
${u.map(p=>`- [ ] ${p}`).join(`
`)}
${h?`
### \uC791\uC5C5 \uD328\uD134
${h}`:""}`}return`---
type: review
period: ${e.period}
date_range: ${i}
created: ${n}
tags: [review, ${e.period==="today"?"daily":e.period==="week"?"weekly":"monthly"}]
---

# ${r}

## \uD1B5\uACC4
- \uC791\uC5C5\uD55C \uB178\uD2B8: ${e.totalNotes}\uAC1C
- \uC0C8 ZK \uB178\uD2B8: ${e.newZKNotes}\uAC1C
- \uD65C\uC131 \uD504\uB85C\uC81D\uD2B8: ${e.projectGroups.filter(l=>l.projectName!=="\uAE30\uD0C0"&&l.projectName!=="Library"&&l.projectName!=="Inbox").length}\uAC1C

## \uD504\uB85C\uC81D\uD2B8\uBCC4 \uC791\uC5C5

${o}
${a}
`}getProjectList(){let e=new Set,t=this.app.vault.getAbstractFileByPath(this.settings.projectsFolder);if(t instanceof Uf.TFolder)for(let n of t.children)n instanceof Uf.TFolder&&e.add(n.name);return Array.from(e).sort()}};var RI=["mp3","wav","m4a","aac","ogg","flac","webm"],Ite=2*1024*1024*1024,m0=class{constructor(e,t,n){this.app=e,this.gemini=t,this.settings=n}isAudioFile(e){return RI.includes(e.extension.toLowerCase())}getMimeType(e){return{mp3:"audio/mp3",wav:"audio/wav",m4a:"audio/m4a",aac:"audio/aac",ogg:"audio/ogg",flac:"audio/flac",webm:"audio/webm"}[e.toLowerCase()]||"audio/mp3"}async fileToBlob(e,t){let n=await this.app.vault.readBinary(e);return new Blob([n],{type:t})}async processAudio(e){if(e.stat.size>Ite)throw new Error("\uD30C\uC77C \uD06C\uAE30\uAC00 2GB\uB97C \uCD08\uACFC\uD569\uB2C8\uB2E4");let t=e.extension.toLowerCase(),n=this.getMimeType(t),i=await this.fileToBlob(e,n);return await this.gemini.analyzeMeeting(i,n,e.name)}generateMarkdownNote(e){let t=Ps(this.settings.timezone,this.settings.dateFormat),n=e.actionItems.length>0?e.actionItems.map(o=>{let a=`- [ ] ${o.task}`;return o.assignee&&(a+=` - @${o.assignee}`),o.deadline&&(a+=` (\uAE30\uD55C: ${o.deadline})`),a}).join(`
`):"- (\uC5C6\uC74C)",i=e.decisions.length>0?e.decisions.map(o=>`- ${o}`).join(`
`):"- (\uC5C6\uC74C)",r=e.nextAgenda.length>0?e.nextAgenda.map(o=>`- ${o}`).join(`
`):"- (\uC5C6\uC74C)";return`---
type: meeting
source_file: "${e.sourceFile}"
title: "${e.title.replace(/"/g,'\\"')}"
created: ${t}
---

# ${e.title}

## \uC694\uC57D
${e.summary}

## \uC561\uC158 \uC544\uC774\uD15C
${n}

## \uACB0\uC815\uC0AC\uD56D
${i}

## \uB2E4\uC74C \uD68C\uC758 \uC548\uAC74
${r}

---

<details>
<summary>\uC804\uCCB4 \uB179\uCDE8\uB85D</summary>

${e.transcription}

</details>

---
## \uC6D0\uBCF8 \uD30C\uC77C
![[${e.sourceFile}]]
`}};var _0=require("obsidian");var g0=class{constructor(e,t){this.app=e,this.settings=t}async saveToDaily(e){let t=new Map;for(let i of e)t.has(i.date)||t.set(i.date,[]),t.get(i.date).push(i);let n=0;for(let[i,r]of t)await this.appendToDaily(i,r),n+=r.length;return n}async appendToDaily(e,t){let n=this.settings.dailyNotesFolder,i=`${n}/${e}.md`;await this.ensureFolder(n);let r=t.map(a=>this.formatTask(a)).join(`
`),o=this.app.vault.getAbstractFileByPath(i);if(o instanceof _0.TFile){let a=await this.app.vault.read(o),l=this.appendSchedulesToContent(a,r);await this.app.vault.modify(o,l)}else{let a=this.createDailyNoteContent(e,r);await this.app.vault.create(i,a)}}formatTask(e){let t=e.time?`${e.time} `:"",n=e.type==="event"?"\u{1F4C5}":"\u{1F4CB}",i=e.sourceNote?` (from [[${e.sourceNote}]])`:"";return`- [ ] ${t}${e.title} ${n} ${e.date}${i}`}appendSchedulesToContent(e,t){let n="## \uC77C\uC815";if(e.includes(n)){let r=e.indexOf(n),o=e.indexOf(`
## `,r+1);return o>0?e.substring(0,o)+t+`

`+e.substring(o):e+`
`+t}let i=e.indexOf("---",3);if(i>0){let r=e.indexOf(`
`,i)+1;return e.substring(0,r)+`
## \uC77C\uC815
`+t+`
`+e.substring(r)}return`## \uC77C\uC815
`+t+`

`+e}createDailyNoteContent(e,t){return`---
type: daily
date: ${e}
created: ${Xo(this.settings.timezone)}
---

# ${e}

## \uC77C\uC815
${t}

## \uBA54\uBAA8

`}async ensureFolder(e){if(!(this.app.vault.getAbstractFileByPath(e)instanceof _0.TFolder))try{await this.app.vault.createFolder(e)}catch{}}getToday(){return Xo(this.settings.timezone)}};Yo();function Ic(s){return s.replace(/\$/g,"$$$$")}function y0(s,e,t){let n=s?.trim()?s:t;if(!n)return console.warn("\uD15C\uD50C\uB9BF\uC774 \uBE44\uC5B4\uC788\uC2B5\uB2C8\uB2E4. \uAE30\uBCF8 \uD615\uC2DD\uC73C\uB85C \uC0DD\uC131\uD569\uB2C8\uB2E4."),`# ${e.title}

${e.summary}

${e.keyPoints.map(a=>`- ${a}`).join(`
`)}`;let i=e.keyPoints.map(a=>`- ${a}`).join(`
`),r=e.title.replace(/"/g,'\\"'),o=n;return o=o.replace(/\{\{title\}\}/g,Ic(e.title)),o=o.replace(/\{\{escapedTitle\}\}/g,Ic(r)),o=o.replace(/\{\{url\}\}/g,Ic(e.url)),o=o.replace(/\{\{summary\}\}/g,Ic(e.summary)),o=o.replace(/\{\{keyPoints\}\}/g,Ic(i)),o=o.replace(/\{\{date\}\}/g,Ic(e.date)),o=o.replace(/\{\{iframe\}\}/g,Ic(e.iframe||"")),o=o.replace(/\{\{bookmark\}\}/g,Ic(e.bookmark||"")),o}function sG(s){return`<div style="resize: both; overflow: hidden; width: 100%; height: 400px; border: 1px solid var(--background-modifier-border); border-radius: 4px;">
<iframe src="${`https://www.youtube.com/embed/${s}`}" style="width: 133%; height: 133%; transform: scale(0.75); transform-origin: 0 0; border: none;" allowfullscreen></iframe>
</div>`}function iG(s){let e=s;return s.includes("blog.naver.com")&&!s.includes("m.blog.naver.com")&&(e=s.replace("blog.naver.com","m.blog.naver.com")),`<div style="resize: both; overflow: hidden; width: 100%; height: 600px; border: 1px solid var(--background-modifier-border); border-radius: 4px;">
<iframe src="${e}" style="width: 133%; height: 133%; transform: scale(0.75); transform-origin: 0 0; border: none; color-scheme: light;"></iframe>
</div>`}function rG(s,e,t){if(t){let n=t.image?`
> ![](${t.image})
>`:"",i=t.description?`
> ${t.description}
>`:"";return`> [!bookmark] ${t.siteName||new URL(e).hostname}
> **${s}**
>${i}${n}
> \u{1F517} ${e}`}return`> [!bookmark] \uC6F9\uD398\uC774\uC9C0
> **${s}**
>
> \u{1F517} ${e}`}var v0=class{constructor(e,t){this.gemini=e,this.settings=t}extractVideoId(e){let t=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/|youtube\.com\/shorts\/)([a-zA-Z0-9_-]{11})/,/^([a-zA-Z0-9_-]{11})$/];for(let n of t){let i=e.match(n);if(i)return i[1]}return null}isValidYouTubeUrl(e){return this.extractVideoId(e)!==null}async processVideo(e){let t=this.extractVideoId(e);if(!t)throw new Error("\uC720\uD6A8\uD55C YouTube URL\uC774 \uC544\uB2D9\uB2C8\uB2E4");let n=`https://www.youtube.com/watch?v=${t}`;console.log("Gemini \uB124\uC774\uD2F0\uBE0C YouTube \uBD84\uC11D \uC2DC\uC791:",n);let i=await this.gemini.analyzeYouTube(n);return{videoId:t,url:n,title:i.title,summary:i.summary,keyPoints:i.keyPoints}}generateMarkdownNote(e){let t=Ps(this.settings.timezone,this.settings.dateFormat),n={title:e.title,url:e.url,summary:e.summary,keyPoints:e.keyPoints,date:t,iframe:sG(e.videoId)};return y0(this.settings.youtubeTemplate,n,cd.youtubeTemplate)}};var Gy=require("obsidian");Yo();var b0=class{constructor(e,t){this.gemini=e,this.settings=t}isValidUrl(e){try{let t=new URL(e);return t.protocol==="http:"||t.protocol==="https:"}catch{return!1}}extractMetadata(e,t){let n=l=>{let c=[new RegExp(`<meta[^>]*property=["']${l}["'][^>]*content=["']([^"']+)["']`,"i"),new RegExp(`<meta[^>]*content=["']([^"']+)["'][^>]*property=["']${l}["']`,"i"),new RegExp(`<meta[^>]*name=["']${l}["'][^>]*content=["']([^"']+)["']`,"i"),new RegExp(`<meta[^>]*content=["']([^"']+)["'][^>]*name=["']${l}["']`,"i")];for(let d of c){let u=e.match(d);if(u)return u[1]}return""},i=e.match(/<title[^>]*>([^<]+)<\/title>/i),r=e.match(/<link[^>]*rel=["'](?:shortcut )?icon["'][^>]*href=["']([^"']+)["']/i),o=new URL(t),a=l=>l?l.startsWith("http")?l:l.startsWith("//")?o.protocol+l:l.startsWith("/")?o.origin+l:o.origin+"/"+l:"";return{title:n("og:title")||n("twitter:title")||i?.[1]||"",description:n("og:description")||n("twitter:description")||n("description")||"",image:a(n("og:image")||n("twitter:image")||""),siteName:n("og:site_name")||o.hostname,favicon:a(r?.[1]||"/favicon.ico")}}extractContent(e){let t=e.match(/<title[^>]*>([^<]+)<\/title>/i),i=e.match(/<meta[^>]*property=["']og:title["'][^>]*content=["']([^"']+)["']/i)?.[1]||t?.[1]||"Untitled",r=e.replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"").replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"").replace(/<!--[\s\S]*?-->/g,"").replace(/<nav[^>]*>[\s\S]*?<\/nav>/gi,"").replace(/<header[^>]*>[\s\S]*?<\/header>/gi,"").replace(/<footer[^>]*>[\s\S]*?<\/footer>/gi,"").replace(/<aside[^>]*>[\s\S]*?<\/aside>/gi,""),o="",a=r.match(/<article[^>]*>([\s\S]*?)<\/article>/i),l=r.match(/<main[^>]*>([\s\S]*?)<\/main>/i),c=r.match(/<div[^>]*(?:class|id)=["'][^"']*content[^"']*["'][^>]*>([\s\S]*?)<\/div>/i);return a?o=a[1]:l?o=l[1]:c?o=c[1]:o=r.match(/<body[^>]*>([\s\S]*?)<\/body>/i)?.[1]||r,o=o.replace(/<\/?(p|div|br|h[1-6]|li|tr)[^>]*>/gi,`
`).replace(/<[^>]+>/g,"").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&[a-z]+;/gi," ").replace(/\n{3,}/g,`

`).replace(/[ \t]+/g," ").trim(),{title:i.replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").trim(),content:o}}async fetchWithJinaReader(e){let t=`https://r.jina.ai/${e}`,i=(await(0,Gy.requestUrl)({url:t,method:"GET",headers:{Accept:"text/plain","X-Timeout":"30","X-Wait-For-Selector":"article, .post-content, .se-main-container, #postViewArea"}})).text;i.includes("Warning: This page maybe not yet fully loaded")&&console.log("Jina Reader: \uD398\uC774\uC9C0 \uB85C\uB529 \uACBD\uACE0 \uAC10\uC9C0");let r=i.split(`
`),o="Untitled",a=0;for(r[0]?.startsWith("# ")?(o=r[0].substring(2).trim(),a=1):r[0]?.startsWith("Title: ")&&(o=r[0].substring(7).trim(),a=1);a<r.length;){let c=r[a];if(c?.startsWith("URL Source:")||c?.startsWith("http")||c?.startsWith("Warning:")||c?.startsWith("Markdown Content:")||c?.trim()==="")a++;else break}let l=r.slice(a).join(`
`).trim();if(l.length<100&&!l.includes(`
`))throw new Error("\uD398\uC774\uC9C0 \uCF58\uD150\uCE20\uB97C \uAC00\uC838\uC62C \uC218 \uC5C6\uC2B5\uB2C8\uB2E4 (JavaScript \uB85C\uB529 \uB300\uAE30 \uC2E4\uD328)");return{title:o,content:l}}async fetchNaverBlog(e){let t=e;if(e.includes("blog.naver.com")){let u=e.match(/blog\.naver\.com\/([^\/]+)\/(\d+)/);u&&(t=`https://m.blog.naver.com/${u[1]}/${u[2]}`)}let i=(await(0,Gy.requestUrl)({url:t,method:"GET",headers:{"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X) AppleWebKit/605.1.15",Accept:"text/html,application/xhtml+xml","Accept-Language":"ko-KR,ko;q=0.9"}})).text,o=i.match(/<title[^>]*>([^<]+)<\/title>/i)?.[1]?.replace(/ :  $/,"").trim()||"Untitled",a="",l=i.match(/<div[^>]*class="[^"]*se-main-container[^"]*"[^>]*>([\s\S]*?)<\/div>\s*<\/div>\s*<\/div>/i),c=i.match(/<div[^>]*id="postViewArea"[^>]*>([\s\S]*?)<\/div>/i),d=l?.[1]||c?.[1]||"";return d&&(a=d.replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"").replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"").replace(/<\/?(p|div|br|h[1-6]|li|tr)[^>]*>/gi,`
`).replace(/<[^>]+>/g,"").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/\n{3,}/g,`

`).replace(/[ \t]+/g," ").trim()),{title:o,content:a}}async processUrl(e){if(!this.isValidUrl(e))throw new Error("\uC720\uD6A8\uD55C URL\uC774 \uC544\uB2D9\uB2C8\uB2E4");let t;try{let r=(await(0,Gy.requestUrl)({url:e,method:"GET",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Language":"ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7"}})).text;t=this.extractMetadata(r,e)}catch(i){console.log("\uBA54\uD0C0\uB370\uC774\uD130 \uCD94\uCD9C \uC2E4\uD328:",i)}if(e.includes("blog.naver.com"))return console.log("\uB124\uC774\uBC84 \uBE14\uB85C\uADF8 \uAC10\uC9C0, Jina Reader \uC0AC\uC6A9"),await this.processUrlFallback(e,t);try{console.log("URL Context Tool\uB85C \uC6F9\uD398\uC774\uC9C0 \uBD84\uC11D \uC2DC\uB3C4");let i=await this.gemini.analyzeWebpage(e),r=["unable to access","cannot access","could not access","\uC811\uADFC\uD560 \uC218 \uC5C6","\uAC00\uC838\uC62C \uC218 \uC5C6"],o=i.summary.toLowerCase();return r.some(l=>o.includes(l.toLowerCase()))?(console.log("URL Context Tool \uC811\uADFC \uC2E4\uD328 \uAC10\uC9C0, \uD3F4\uBC31 \uC2DC\uB3C4"),await this.processUrlFallback(e,t)):(t&&(t.title=t.title||i.title),{url:e,title:i.title,content:"",summary:i.summary,keyPoints:i.keyPoints,metadata:t})}catch(i){console.log("URL Context Tool \uC2E4\uD328, \uD3F4\uBC31 \uC2DC\uB3C4:",i)}return await this.processUrlFallback(e,t)}async processUrlFallback(e,t){let n,i,r=null;if(!t)try{r=(await(0,Gy.requestUrl)({url:e,method:"GET",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Language":"ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7"}})).text,t=this.extractMetadata(r,e)}catch(d){console.log("HTML \uAC00\uC838\uC624\uAE30 \uC2E4\uD328:",d)}if(e.includes("blog.naver.com")){console.log("\uB124\uC774\uBC84 \uBE14\uB85C\uADF8 \uAC10\uC9C0, \uC804\uC6A9 \uCD94\uCD9C \uC2DC\uB3C4");try{let d=await this.fetchNaverBlog(e);if(n=d.title,i=d.content,i.length<100)throw new Error("\uB124\uC774\uBC84 \uBE14\uB85C\uADF8 \uCD94\uCD9C \uC2E4\uD328")}catch(d){console.log("\uB124\uC774\uBC84 \uBE14\uB85C\uADF8 \uC804\uC6A9 \uCD94\uCD9C \uC2E4\uD328, Jina Reader \uC2DC\uB3C4:",d);let u=await this.fetchWithJinaReader(e);n=u.title,i=u.content}}else try{console.log("Jina Reader\uB85C \uCF58\uD150\uCE20 \uCD94\uCD9C \uC2DC\uB3C4");let d=await this.fetchWithJinaReader(e);n=d.title,i=d.content}catch(d){if(console.log("Jina Reader \uC2E4\uD328, \uC9C1\uC811 \uCD94\uCD9C\uB85C \uD3F4\uBC31:",d),r){let u=this.extractContent(r);n=u.title,i=u.content}else throw new Error("\uC6F9\uD398\uC774\uC9C0\uB97C \uAC00\uC838\uC62C \uC218 \uC5C6\uC2B5\uB2C8\uB2E4")}if(i.length<50)throw new Error("\uBCF8\uBB38\uC744 \uCD94\uCD9C\uD560 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4. \uC811\uADFC\uC774 \uC81C\uD55C\uB41C \uD398\uC774\uC9C0\uC77C \uC218 \uC788\uC2B5\uB2C8\uB2E4.");let a=5e4,l=i.length>a?i.slice(0,a)+"...":i,c=await this.gemini.summarizeContent(l,"webpage");return t&&(t.title=t.title||n),{url:e,title:c.title||n,content:l,summary:c.summary,keyPoints:c.keyPoints,metadata:t}}generateMarkdownNote(e){let t=Ps(this.settings.timezone,this.settings.dateFormat),n=e.metadata,i=rG(e.title,e.url,{siteName:n?.siteName,description:n?.description,image:n?.image}),r={title:e.title,url:e.url,summary:e.summary,keyPoints:e.keyPoints,date:t,iframe:iG(e.url),bookmark:i};return y0(this.settings.webpageTemplate,r,cd.webpageTemplate)}};var Ml=require("obsidian"),Dte="YOUR_CLIENT_ID.apps.googleusercontent.com",Rte="YOUR_CLIENT_SECRET",oG="http://127.0.0.1:42813/callback",Fte="https://accounts.google.com/o/oauth2/v2/auth",aG="https://oauth2.googleapis.com/token",Lte="https://www.googleapis.com/calendar/v3",Nte="https://www.googleapis.com/auth/calendar.events",Wy=class{constructor(e,t,n){this.authServer=null;this.app=e,this.settings=t,this.saveSettings=n}isConnected(){return!!this.settings.googleRefreshToken}getClientId(){return this.settings.useOwnApiKey?this.settings.googleClientId:Dte}getClientSecret(){return this.settings.useOwnApiKey?this.settings.googleClientSecret:Rte}async startOAuth(){let e=this.getClientId();if(!e||e==="YOUR_CLIENT_ID.apps.googleusercontent.com"){new Ml.Notice(`Google Calendar Client ID\uAC00 \uC124\uC815\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4.
\uC124\uC815\uC5D0\uC11C Advanced \uBAA8\uB4DC\uB85C \uC9C1\uC811 Client ID\uB97C \uC785\uB825\uD558\uAC70\uB098,
\uD50C\uB7EC\uADF8\uC778 \uC5C5\uB370\uC774\uD2B8\uB97C \uAE30\uB2E4\uB824\uC8FC\uC138\uC694.`,1e4);return}let t=new URLSearchParams({client_id:e,redirect_uri:oG,response_type:"code",scope:Nte,access_type:"offline",prompt:"consent"}),n=`${Fte}?${t.toString()}`;try{let i=await this.startAuthServer();await this.exchangeCodeForTokens(i),new Ml.Notice("Google Calendar \uC5F0\uACB0 \uC644\uB8CC!")}catch(i){console.error("OAuth \uC5D0\uB7EC:",i),new Ml.Notice("Google Calendar \uC5F0\uACB0 \uC2E4\uD328: "+i.message)}window.open(n,"_blank")}startAuthServer(){return new Promise((e,t)=>{let n=require("http"),i=setTimeout(()=>{this.stopAuthServer(),t(new Error("\uC778\uC99D \uC2DC\uAC04 \uCD08\uACFC (5\uBD84)"))},5*60*1e3);this.authServer=n.createServer((r,o)=>{let a=new URL(r.url||"","http://127.0.0.1:42813");if(a.pathname==="/callback"){let l=a.searchParams.get("code"),c=a.searchParams.get("error");if(c){o.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),o.end(`
							<html><body style="font-family: sans-serif; text-align: center; padding-top: 50px;">
								<h1>\uC5F0\uACB0 \uC2E4\uD328</h1>
								<p>Google Calendar \uC5F0\uACB0\uC774 \uCDE8\uC18C\uB418\uC5C8\uC2B5\uB2C8\uB2E4.</p>
								<p>\uC774 \uCC3D\uC744 \uB2EB\uC544\uB3C4 \uB429\uB2C8\uB2E4.</p>
							</body></html>
						`),clearTimeout(i),this.stopAuthServer(),t(new Error(c));return}if(l){o.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),o.end(`
							<html><body style="font-family: sans-serif; text-align: center; padding-top: 50px;">
								<h1>\uC5F0\uACB0 \uC644\uB8CC!</h1>
								<p>Google Calendar\uAC00 \uC5F0\uACB0\uB418\uC5C8\uC2B5\uB2C8\uB2E4.</p>
								<p>\uC774 \uCC3D\uC744 \uB2EB\uACE0 Obsidian\uC73C\uB85C \uB3CC\uC544\uAC00\uC138\uC694.</p>
							</body></html>
						`),clearTimeout(i),this.stopAuthServer(),e(l);return}}o.writeHead(404),o.end("Not Found")}),this.authServer.listen(42813,"127.0.0.1",()=>{console.log("OAuth \uCF5C\uBC31 \uC11C\uBC84 \uC2DC\uC791: http://127.0.0.1:42813")}),this.authServer.on("error",r=>{clearTimeout(i),t(new Error(`\uC11C\uBC84 \uC2DC\uC791 \uC2E4\uD328: ${r.message}`))})})}stopAuthServer(){this.authServer&&(this.authServer.close(),this.authServer=null)}async exchangeCodeForTokens(e){let n=(await(0,Ml.requestUrl)({url:aG,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:this.getClientId(),client_secret:this.getClientSecret(),code:e,grant_type:"authorization_code",redirect_uri:oG}).toString()})).json;if(n.error)throw new Error(n.error_description||n.error);this.settings.googleAccessToken=n.access_token,n.refresh_token&&(this.settings.googleRefreshToken=n.refresh_token),this.settings.googleTokenExpiry=Date.now()+n.expires_in*1e3,await this.saveSettings()}async refreshAccessToken(){if(!this.settings.googleRefreshToken)throw new Error("Refresh token\uC774 \uC5C6\uC2B5\uB2C8\uB2E4. \uB2E4\uC2DC \uC5F0\uACB0\uD574\uC8FC\uC138\uC694.");let t=(await(0,Ml.requestUrl)({url:aG,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:this.getClientId(),client_secret:this.getClientSecret(),refresh_token:this.settings.googleRefreshToken,grant_type:"refresh_token"}).toString()})).json;if(t.error)throw t.error==="invalid_grant"?(this.settings.googleRefreshToken="",await this.saveSettings(),new Error("Google \uC5F0\uACB0\uC774 \uB9CC\uB8CC\uB418\uC5C8\uC2B5\uB2C8\uB2E4. \uB2E4\uC2DC \uC5F0\uACB0\uD574\uC8FC\uC138\uC694.")):new Error(t.error_description||t.error);this.settings.googleAccessToken=t.access_token,this.settings.googleTokenExpiry=Date.now()+t.expires_in*1e3,await this.saveSettings()}async ensureValidToken(){Date.now()>this.settings.googleTokenExpiry-5*60*1e3&&await this.refreshAccessToken()}async createEvent(e){if(!this.isConnected())throw new Error("Google Calendar\uAC00 \uC5F0\uACB0\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4.");await this.ensureValidToken();let t,n;if(e.time){let o=`${e.date}T${e.time}:00`,a=this.addHour(e.time),l=`${e.date}T${a}:00`;t={dateTime:o,timeZone:this.resolveTimezone()},n={dateTime:l,timeZone:this.resolveTimezone()}}else t={date:e.date},n={date:this.getNextDay(e.date)};let i={summary:e.title,start:t,end:n},r=await(0,Ml.requestUrl)({url:`${Lte}/calendars/primary/events`,method:"POST",headers:{Authorization:`Bearer ${this.settings.googleAccessToken}`,"Content-Type":"application/json"},body:JSON.stringify(i)});if(r.status>=400){let o=r.json;throw new Error(o.error?.message||"\uC774\uBCA4\uD2B8 \uC0DD\uC131 \uC2E4\uD328")}}async saveSchedules(e){let t=0;for(let n of e)try{await this.createEvent(n),t++}catch(i){console.error("\uC77C\uC815 \uC800\uC7A5 \uC2E4\uD328:",n.title,i)}return t}addHour(e){let[t,n]=e.split(":").map(Number),i=(t+1)%24;return`${String(i).padStart(2,"0")}:${String(n).padStart(2,"0")}`}getNextDay(e){let t=new Date(e);return t.setDate(t.getDate()+1),t.toISOString().split("T")[0]}resolveTimezone(){return this.settings.timezone==="auto"?Intl.DateTimeFormat().resolvedOptions().timeZone:this.settings.timezone}async disconnect(){this.settings.googleAccessToken="",this.settings.googleRefreshToken="",this.settings.googleTokenExpiry=0,await this.saveSettings(),new Ml.Notice("Google Calendar \uC5F0\uACB0\uC774 \uD574\uC81C\uB418\uC5C8\uC2B5\uB2C8\uB2E4.")}};var lG=require("obsidian"),w0=class extends lG.Modal{constructor(t,n,i,r){super(t);this.resolvePromise=null;this.choiceMade=!1;this.schedules=n,this.settings=i,this.selected=new Set(n.map((o,a)=>a)),this.saveToDaily=!0,this.saveToGoogle=i.googleCalendarEnabled&&!!i.googleRefreshToken,this.moveToArchives=!1,this.onFeedback=r}async openAndWait(){return new Promise(t=>{this.resolvePromise=t,this.open()})}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("zfb-schedule-modal"),t.createEl("h2",{text:"\uAC10\uC9C0\uB41C \uC77C\uC815"}),t.createEl("p",{text:`${this.schedules.length}\uAC1C\uC758 \uC77C\uC815\uC774 \uAC10\uC9C0\uB418\uC5C8\uC2B5\uB2C8\uB2E4. \uC800\uC7A5\uD560 \uC77C\uC815\uC744 \uC120\uD0DD\uD558\uC138\uC694.`,cls:"setting-item-description"});let n=t.createDiv({cls:"schedule-list"});n.style.maxHeight="300px",n.style.overflowY="auto",n.style.marginBottom="16px",this.schedules.forEach((y,w)=>{let C=n.createDiv({cls:"schedule-item"});C.style.display="flex",C.style.alignItems="center",C.style.padding="10px 12px",C.style.marginBottom="8px",C.style.border="1px solid var(--background-modifier-border)",C.style.borderRadius="8px",C.style.gap="12px";let M=C.createEl("input",{type:"checkbox",attr:{checked:!0}});M.style.flexShrink="0",M.addEventListener("change",()=>{M.checked?this.selected.add(w):this.selected.delete(w),this.updateSaveButton()});let S=C.createDiv({cls:"schedule-info"});S.style.flex="1",S.style.minWidth="0";let k=S.createEl("div",{text:y.title});k.style.fontWeight="500",k.style.overflow="hidden",k.style.textOverflow="ellipsis",k.style.whiteSpace="nowrap";let T=S.createEl("div");T.style.fontSize="12px",T.style.color="var(--text-muted)";let P=y.type==="event"?"\uC57D\uC18D":"\uD560\uC77C",R=y.type==="event"?"\u{1F4C5}":"\u{1F4CB}",O=y.time||"\uC885\uC77C";T.setText(`${R} ${P} | ${y.date} ${O}`)});let i=t.createDiv({cls:"schedule-destinations"});i.style.padding="12px",i.style.backgroundColor="var(--background-secondary)",i.style.borderRadius="8px",i.style.marginBottom="16px",i.createEl("div",{text:"\uC800\uC7A5 \uC704\uCE58"}).style.fontWeight="500";let r=i.createDiv({cls:"destination-option"});r.style.display="flex",r.style.alignItems="center",r.style.gap="8px",r.style.marginTop="8px";let o=r.createEl("input",{type:"checkbox",attr:{checked:!0}});o.id="save-to-daily",o.addEventListener("change",()=>{this.saveToDaily=o.checked});let a=r.createEl("label",{text:`Daily Notes (${this.settings.dailyNotesFolder}/)`,attr:{for:"save-to-daily"}});a.style.cursor="pointer";let l=i.createDiv({cls:"destination-option"});l.style.display="flex",l.style.alignItems="center",l.style.gap="8px",l.style.marginTop="8px";let c=l.createEl("input",{type:"checkbox",attr:{checked:this.saveToGoogle,disabled:!this.settings.googleCalendarEnabled||!this.settings.googleRefreshToken}});c.id="save-to-google",c.addEventListener("change",()=>{this.saveToGoogle=c.checked});let d=l.createEl("label",{attr:{for:"save-to-google"}});d.style.cursor="pointer",this.settings.googleCalendarEnabled&&this.settings.googleRefreshToken?d.setText("Google Calendar (\uC5F0\uACB0\uB428)"):this.settings.googleCalendarEnabled?(d.setText("Google Calendar (\uC5F0\uACB0 \uD544\uC694)"),d.style.color="var(--text-muted)"):(d.setText("Google Calendar (\uBE44\uD65C\uC131\uD654)"),d.style.color="var(--text-muted)");let u=i.createDiv({cls:"destination-option"});u.style.display="flex",u.style.alignItems="center",u.style.gap="8px",u.style.marginTop="8px";let h=u.createEl("input",{type:"checkbox",attr:{checked:!1}});h.id="move-to-archives",h.addEventListener("change",()=>{this.moveToArchives=h.checked});let p=u.createEl("label",{text:"\u{1F4E6} \uC800\uC7A5 \uD6C4 \uC6D0\uBCF8 \uB178\uD2B8 Archives\uB85C \uC774\uB3D9",attr:{for:"move-to-archives"}});p.style.cursor="pointer";let f=t.createDiv({cls:"modal-button-container"});f.style.display="flex",f.style.justifyContent="flex-end",f.style.gap="8px",f.createEl("button",{text:"\uCDE8\uC18C"}).addEventListener("click",()=>{this.choiceMade=!0,this.onFeedback&&this.onFeedback({type:"schedule_detection",accepted:!1,allSchedules:this.schedules,selectedSchedules:[],rejectedSchedules:this.schedules}),this.close(),this.resolvePromise&&this.resolvePromise(null)});let b=f.createEl("button",{text:`${this.selected.size}\uAC1C \uC800\uC7A5`,cls:"mod-cta"});b.id="save-schedule-btn",b.addEventListener("click",()=>{this.choiceMade=!0;let y=this.schedules.filter((C,M)=>this.selected.has(M)),w=this.schedules.filter((C,M)=>!this.selected.has(M));this.onFeedback&&this.onFeedback({type:"schedule_detection",accepted:y.length>0,allSchedules:this.schedules,selectedSchedules:y,rejectedSchedules:w}),this.close(),this.resolvePromise&&this.resolvePromise({selectedSchedules:y,saveToDaily:this.saveToDaily,saveToGoogle:this.saveToGoogle,moveToArchives:this.moveToArchives})})}updateSaveButton(){let t=this.contentEl.querySelector("#save-schedule-btn");t&&t.setText(`${this.selected.size}\uAC1C \uC800\uC7A5`)}onClose(){this.choiceMade||(this.onFeedback&&this.onFeedback({type:"schedule_detection",accepted:!1,allSchedules:this.schedules,selectedSchedules:[],dismissed:!0}),this.resolvePromise&&this.resolvePromise(null)),this.contentEl.empty()}};var Vf=require("obsidian"),M0=class extends Vf.Modal{constructor(t,n,i,r,o=null){super(t);this.choiceMade=!1;this.activeTab="restructured";this.result=n,this.originalContent=i,this.onChoice=r,this.feedbackManager=o,this.component=new Vf.Component}getRestructureTypeLabel(t){switch(t){case"meeting":return"\u{1F4CB} \uD68C\uC758/\uBBF8\uD305";case"idea":return"\u{1F4A1} \uC544\uC774\uB514\uC5B4";case"learning":return"\u{1F4DA} \uD559\uC2B5/\uC5F0\uAD6C";case"general":return"\u{1F4DD} \uC77C\uBC18";default:return"\u{1F4DD} \uC77C\uBC18"}}recordFeedback(t){this.feedbackManager&&this.feedbackManager.addFeedback({timestamp:new Date().toISOString(),type:"content_restructure",noteTitle:this.result.title,aiSuggestion:{restructuredContent:this.result.restructuredContent,restructureType:this.result.restructureType},userChoice:{accepted:t===!0,dismissed:t===null}})}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("zfb-restructure-modal"),t.createEl("h2",{text:"\u2728 \uCF58\uD150\uCE20 \uC7AC\uAD6C\uC131 \uC81C\uC548"});let n=t.createDiv({cls:"restructure-info"});n.style.marginBottom="16px",n.style.padding="12px",n.style.backgroundColor="var(--background-secondary)",n.style.borderRadius="8px",n.createEl("p",{text:"\uC774 \uB178\uD2B8\uAC00 \uC815\uB9AC\uB418\uC9C0 \uC54A\uC740 \uAC83 \uAC19\uC544 \uC7AC\uAD6C\uC131\uC744 \uC81C\uC548\uD569\uB2C8\uB2E4."});let i=this.getRestructureTypeLabel(this.result.restructureType);n.createEl("p",{text:`\uC720\uD615: ${i}`,cls:"restructure-type"}).style.fontWeight="bold";let r=t.createDiv({cls:"restructure-tabs"});r.style.display="flex",r.style.borderBottom="1px solid var(--background-modifier-border)",r.style.marginBottom="12px";let o=r.createEl("button",{text:"\u{1F4C4} \uC6D0\uBCF8"});o.style.flex="1",o.style.padding="8px 16px",o.style.border="none",o.style.cursor="pointer",o.style.backgroundColor="transparent";let a=r.createEl("button",{text:"\u2728 \uC7AC\uAD6C\uC131"});a.style.flex="1",a.style.padding="8px 16px",a.style.border="none",a.style.cursor="pointer",a.style.backgroundColor="transparent";let l=t.createDiv({cls:"restructure-content-area"});l.style.minHeight="200px",l.style.maxHeight="400px",l.style.overflow="auto",l.style.padding="12px",l.style.border="1px solid var(--background-modifier-border)",l.style.borderRadius="8px",l.style.backgroundColor="var(--background-primary)";let c=()=>{this.activeTab==="original"?(o.style.borderBottom="2px solid var(--interactive-accent)",o.style.color="var(--text-normal)",a.style.borderBottom="none",a.style.color="var(--text-muted)",l.empty(),l.createEl("pre",{text:this.originalContent,cls:"original-content"}).style.whiteSpace="pre-wrap"):(a.style.borderBottom="2px solid var(--interactive-accent)",a.style.color="var(--text-normal)",o.style.borderBottom="none",o.style.color="var(--text-muted)",l.empty(),this.result.restructuredContent&&Vf.MarkdownRenderer.render(this.app,this.result.restructuredContent,l,"",this.component))};o.addEventListener("click",()=>{this.activeTab="original",c()}),a.addEventListener("click",()=>{this.activeTab="restructured",c()}),c();let d=t.createDiv({cls:"modal-button-container"});d.style.marginTop="16px",d.style.display="flex",d.style.gap="8px",d.style.justifyContent="flex-end",d.createEl("button",{text:"\u{1F4C4} \uC6D0\uBCF8 \uC720\uC9C0"}).addEventListener("click",()=>{this.choiceMade=!0,this.recordFeedback(!1),this.close(),this.onChoice(!1)}),d.createEl("button",{text:"\u2728 \uC7AC\uAD6C\uC131 \uC801\uC6A9",cls:"mod-cta"}).addEventListener("click",()=>{this.choiceMade=!0,this.recordFeedback(!0),this.close(),this.onChoice(!0)})}onClose(){this.choiceMade||this.recordFeedback(null),this.component.unload(),this.contentEl.empty()}};var cG=require("obsidian"),T0=class extends cG.Modal{constructor(t,n,i){super(t);this.resolvePromise=null;this.processButton=null;this.settings=i,this.imageFiles=n,this.selected=new Set}async openAndWait(){return new Promise(t=>{this.resolvePromise=t,this.open()})}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("zfb-image-batch-modal"),t.createEl("h2",{text:"\uC774\uBBF8\uC9C0 \uD1B5\uD569 \uCC98\uB9AC"}),t.createEl("p",{text:`_Inbox\uC5D0\uC11C ${this.imageFiles.length}\uAC1C\uC758 \uC774\uBBF8\uC9C0\uB97C \uBC1C\uACAC\uD588\uC2B5\uB2C8\uB2E4. \uCC98\uB9AC\uD560 \uC774\uBBF8\uC9C0\uB97C \uC120\uD0DD\uD558\uC138\uC694.`,cls:"setting-item-description"});let n=t.createDiv({cls:"image-batch-controls"});n.style.marginBottom="12px",n.style.display="flex",n.style.gap="8px";let i=n.createEl("button",{text:"\uC804\uCCB4 \uC120\uD0DD"});i.style.fontSize="12px",i.addEventListener("click",()=>{this.imageFiles.forEach(d=>this.selected.add(d.path)),this.renderList(o),this.updateProcessButton()});let r=n.createEl("button",{text:"\uC804\uCCB4 \uD574\uC81C"});r.style.fontSize="12px",r.addEventListener("click",()=>{this.selected.clear(),this.renderList(o),this.updateProcessButton()});let o=t.createDiv({cls:"image-list"});o.style.maxHeight="400px",o.style.overflowY="auto",o.style.marginBottom="16px",o.style.border="1px solid var(--background-modifier-border)",o.style.borderRadius="8px",o.style.padding="8px",this.renderList(o);let a=t.createEl("p",{cls:"setting-item-description"});a.style.fontSize="12px",a.style.marginBottom="16px",a.innerHTML=`
			<strong>\uB3D9\uC791:</strong> \uC120\uD0DD\uD55C \uC774\uBBF8\uC9C0\uB4E4\uC744 \uD558\uB098\uC758 \uBB38\uC11C\uB85C OCR \uCC98\uB9AC \uD6C4 AI \uC694\uC57D \uBC0F \uD504\uB85C\uC81D\uD2B8 \uBD84\uB958\uB97C \uC218\uD589\uD569\uB2C8\uB2E4.<br>
			<em>\uC5F0\uC18D\uB41C \uD544\uAE30 \uB178\uD2B8\uB098 \uAD00\uB828 \uC774\uBBF8\uC9C0\uB4E4\uC744 \uD558\uB098\uC758 \uBB38\uC11C\uB85C \uD1B5\uD569\uD560 \uB54C \uC720\uC6A9\uD569\uB2C8\uB2E4.</em>
		`;let l=t.createDiv({cls:"modal-button-container"});l.style.display="flex",l.style.justifyContent="flex-end",l.style.gap="8px",l.createEl("button",{text:"\uCDE8\uC18C"}).addEventListener("click",()=>{this.resolvePromise?.(null),this.close()}),this.processButton=l.createEl("button",{text:"OCR + \uBD84\uB958 (0\uAC1C \uC120\uD0DD)",cls:"mod-cta"}),this.processButton.disabled=!0,this.processButton.addEventListener("click",()=>{let d=this.imageFiles.filter(u=>this.selected.has(u.path));this.resolvePromise?.({selectedFiles:d}),this.close()})}renderList(t){if(t.empty(),this.imageFiles.length===0){t.createEl("p",{text:"_Inbox\uC5D0 \uC774\uBBF8\uC9C0 \uD30C\uC77C\uC774 \uC5C6\uC2B5\uB2C8\uB2E4.",cls:"setting-item-description"});return}this.imageFiles.forEach(n=>{let i=t.createDiv({cls:"image-item"});i.style.display="flex",i.style.alignItems="center",i.style.padding="8px",i.style.marginBottom="4px",i.style.borderRadius="4px",i.style.gap="10px",i.style.cursor="pointer",this.selected.has(n.path)&&(i.style.backgroundColor="var(--background-modifier-success)");let r=i.createEl("input",{type:"checkbox"});r.checked=this.selected.has(n.path),r.style.flexShrink="0",r.addEventListener("change",d=>{d.stopPropagation(),r.checked?this.selected.add(n.path):this.selected.delete(n.path),this.renderList(t),this.updateProcessButton()});let o=i.createSpan({cls:"image-icon"});o.style.fontSize="16px",o.textContent=this.getFileIcon(n.extension);let a=i.createDiv({cls:"image-info"});a.style.flex="1",a.style.minWidth="0";let l=a.createDiv({cls:"image-name"});l.textContent=n.name,l.style.fontWeight="500",l.style.overflow="hidden",l.style.textOverflow="ellipsis",l.style.whiteSpace="nowrap";let c=a.createDiv({cls:"image-meta"});c.style.fontSize="11px",c.style.color="var(--text-muted)",c.textContent=this.formatFileSize(n.stat.size),i.addEventListener("click",d=>{d.target!==r&&(r.checked=!r.checked,r.checked?this.selected.add(n.path):this.selected.delete(n.path),this.renderList(t),this.updateProcessButton())})})}updateProcessButton(){if(this.processButton){let t=this.selected.size;this.processButton.textContent=`OCR + \uBD84\uB958 (${t}\uAC1C \uC120\uD0DD)`,this.processButton.disabled=t===0}}getFileIcon(t){return{png:"\u{1F5BC}\uFE0F",jpg:"\u{1F5BC}\uFE0F",jpeg:"\u{1F5BC}\uFE0F",webp:"\u{1F5BC}\uFE0F",gif:"\u{1F5BC}\uFE0F",pdf:"\u{1F4C4}"}[t.toLowerCase()]||"\u{1F4C4}"}formatFileSize(t){return t<1024?`${t} B`:t<1024*1024?`${(t/1024).toFixed(1)} KB`:`${(t/(1024*1024)).toFixed(1)} MB`}onClose(){let{contentEl:t}=this;t.empty(),this.resolvePromise&&(this.resolvePromise(null),this.resolvePromise=null)}};var x0=require("obsidian"),E0=class extends x0.Modal{constructor(t,n){super(t);this.inputEl=null;this.resultsEl=null;this.results=[];this.selectedIndex=0;this.searchTimeout=null;this.isSearching=!1;this.embeddingManager=n}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("zfb-smart-search-modal"),t.createEl("div",{text:"\uBB34\uC5C7\uC744 \uCC3E\uACE0 \uC788\uB098\uC694?",cls:"smart-search-header"});let n=t.createDiv({cls:"smart-search-input-container"});this.inputEl=n.createEl("input",{type:"text",placeholder:"\uD30C\uC77C\uBA85 \uB610\uB294 \uB0B4\uC6A9\uC73C\uB85C \uAC80\uC0C9...",cls:"smart-search-input"}),this.inputEl.addEventListener("input",()=>this.onInputChange()),this.inputEl.addEventListener("keydown",i=>this.onKeyDown(i)),this.resultsEl=t.createDiv({cls:"smart-search-results"}),this.showEmptyState(),this.inputEl.focus()}onClose(){this.searchTimeout&&clearTimeout(this.searchTimeout),this.contentEl.empty()}onInputChange(){this.searchTimeout&&clearTimeout(this.searchTimeout);let t=this.inputEl?.value.trim()||"";if(t.length<2){this.showEmptyState();return}this.showSearching(),this.searchTimeout=setTimeout(()=>{this.performSearch(t)},300)}onKeyDown(t){switch(t.key){case"ArrowDown":t.preventDefault(),this.selectNext();break;case"ArrowUp":t.preventDefault(),this.selectPrevious();break;case"Enter":t.preventDefault(),this.openSelected();break;case"Escape":t.preventDefault(),this.close();break}}async performSearch(t){if(!this.isSearching){this.isSearching=!0;try{let n=t.toLowerCase(),i=new Set;this.results=[];let r=this.app.vault.getMarkdownFiles(),o=[];for(let l of r){let c=l.basename.toLowerCase();if(c.includes(n)){let d=l.parent?.path||"/",u=.9;c===n?u=1:c.startsWith(n)&&(u=.95),o.push({path:l.path,similarity:u,file:l,folder:d==="/"?"\uB8E8\uD2B8":d,matchType:"filename"}),i.add(l.path)}}o.sort((l,c)=>c.similarity-l.similarity),this.results.push(...o.slice(0,5));let a=await this.embeddingManager.findSimilarNotesByText(t,15,void 0,.2);for(let l of a){if(i.has(l.path))continue;let c=this.app.vault.getAbstractFileByPath(l.path);if(c instanceof x0.TFile){let d=c.parent?.path||"/";if(this.results.push({...l,file:c,folder:d==="/"?"\uB8E8\uD2B8":d,matchType:"content"}),i.add(l.path),this.results.length>=10)break}}this.selectedIndex=0,this.renderResults()}catch(n){console.error("\uC2A4\uB9C8\uD2B8 \uAC80\uC0C9 \uC624\uB958:",n),this.showError()}finally{this.isSearching=!1}}}renderResults(){if(this.resultsEl){if(this.resultsEl.empty(),this.results.length===0){this.showNoResults();return}for(let t=0;t<this.results.length;t++){let n=this.results[t],i=this.resultsEl.createDiv({cls:`smart-search-item ${t===this.selectedIndex?"is-selected":""}`}),r=i.createDiv({cls:"search-item-title-row"}),o=n.matchType==="filename"?"\u{1F4DD}":"\u{1F50D}";if(r.createSpan({text:`${o} `,cls:"search-item-icon"}),r.createSpan({text:n.file.basename,cls:"search-item-title"}),n.matchType==="filename")r.createSpan({text:"\uC774\uB984",cls:"search-item-match-type"});else{let a=Math.round(n.similarity*100);r.createSpan({text:`${a}%`,cls:"search-item-similarity"})}n.chunkPreview&&n.matchType==="content"&&i.createDiv({text:n.chunkPreview,cls:"search-item-chunk-preview"}),i.createDiv({text:`\u2192 ${n.folder}`,cls:"search-item-folder"}),i.addEventListener("click",()=>{this.selectedIndex=t,this.openSelected()}),i.addEventListener("mouseenter",()=>{this.selectedIndex=t,this.updateSelection()})}}}updateSelection(){if(!this.resultsEl)return;this.resultsEl.querySelectorAll(".smart-search-item").forEach((n,i)=>{i===this.selectedIndex?n.addClass("is-selected"):n.removeClass("is-selected")})}selectNext(){this.results.length!==0&&(this.selectedIndex=(this.selectedIndex+1)%this.results.length,this.updateSelection(),this.scrollToSelected())}selectPrevious(){this.results.length!==0&&(this.selectedIndex=(this.selectedIndex-1+this.results.length)%this.results.length,this.updateSelection(),this.scrollToSelected())}scrollToSelected(){if(!this.resultsEl)return;let t=this.resultsEl.querySelector(".is-selected");t&&t.scrollIntoView({block:"nearest"})}openSelected(){if(this.results.length===0||this.selectedIndex>=this.results.length)return;let t=this.results[this.selectedIndex];this.app.workspace.openLinkText(t.file.path,""),this.close()}showEmptyState(){if(!this.resultsEl)return;this.resultsEl.empty(),this.results=[];let t=this.resultsEl.createDiv({cls:"smart-search-empty"});t.createEl("p",{text:"\uAC80\uC0C9\uC5B4\uB97C 2\uAE00\uC790 \uC774\uC0C1 \uC785\uB825\uD558\uC138\uC694"}),t.createEl("small",{text:"\uB0B4\uC6A9 \uAE30\uBC18\uC73C\uB85C \uAD00\uB828 \uBB38\uC11C\uB97C \uCC3E\uC544\uB4DC\uB9BD\uB2C8\uB2E4"})}showSearching(){if(!this.resultsEl)return;this.resultsEl.empty(),this.resultsEl.createDiv({cls:"smart-search-searching"}).createEl("p",{text:"\u{1F50D} \uAC80\uC0C9 \uC911..."})}showNoResults(){if(!this.resultsEl)return;this.resultsEl.empty();let t=this.resultsEl.createDiv({cls:"smart-search-no-results"});t.createEl("p",{text:"\uAD00\uB828 \uBB38\uC11C\uB97C \uCC3E\uC9C0 \uBABB\uD588\uC2B5\uB2C8\uB2E4"}),t.createEl("small",{text:"\uB2E4\uB978 \uAC80\uC0C9\uC5B4\uB97C \uC2DC\uB3C4\uD574\uBCF4\uC138\uC694"})}showError(){if(!this.resultsEl)return;this.resultsEl.empty();let t=this.resultsEl.createDiv({cls:"smart-search-error"});t.createEl("p",{text:"\uAC80\uC0C9 \uC911 \uC624\uB958\uAC00 \uBC1C\uC0DD\uD588\uC2B5\uB2C8\uB2E4"}),t.createEl("small",{text:"\uC784\uBCA0\uB529 \uC778\uB371\uC2A4\uAC00 \uAD6C\uCD95\uB418\uC5B4 \uC788\uB294\uC9C0 \uD655\uC778\uD558\uC138\uC694"})}};var LI={};sw(LI,{InferenceSession:()=>Bte,TRACE:()=>xG,TRACE_FUNC_BEGIN:()=>C0,TRACE_FUNC_END:()=>A0,Tensor:()=>Hu,env:()=>$te,registerBackend:()=>dG});var S0=new Map,Gu=[],dG=(s,e,t)=>{if(e&&typeof e.init=="function"&&typeof e.createInferenceSessionHandler=="function"){let n=S0.get(s);if(n===void 0)S0.set(s,{backend:e,priority:t});else{if(n.priority>t)return;if(n.priority===t&&n.backend!==e)throw new Error(`cannot register backend "${s}" using priority ${t}`)}if(t>=0){let i=Gu.indexOf(s);i!==-1&&Gu.splice(i,1);for(let r=0;r<Gu.length;r++)if(S0.get(Gu[r]).priority<=t){Gu.splice(r,0,s);return}Gu.push(s)}return}throw new TypeError("not a valid backend")},Ote=async s=>{let e=S0.get(s);if(!e)return"backend not found.";if(e.initialized)return e.backend;if(e.aborted)return e.error;{let t=!!e.initPromise;try{return t||(e.initPromise=e.backend.init(s)),await e.initPromise,e.initialized=!0,e.backend}catch(n){return t||(e.error=`${n}`,e.aborted=!0),e.error}finally{delete e.initPromise}}},uG=async s=>{let e=s.executionProviders||[],t=e.map(l=>typeof l=="string"?l:l.name),n=t.length===0?Gu:t,i,r=[],o=new Set;for(let l of n){let c=await Ote(l);typeof c=="string"?r.push({name:l,err:c}):(i||(i=c),i===c&&o.add(l))}if(!i)throw new Error(`no available backend found. ERR: ${r.map(l=>`[${l.name}] ${l.err}`).join(", ")}`);for(let{name:l,err:c}of r)t.includes(l)&&console.warn(`removing requested execution provider "${l}" from session options because it is not available: ${c}`);let a=e.filter(l=>o.has(typeof l=="string"?l:l.name));return[i,new Proxy(s,{get:(l,c)=>c==="executionProviders"?a:Reflect.get(l,c)})]};var hG="1.21.0";var pG="warning",wr={wasm:{},webgl:{},webgpu:{},versions:{common:hG},set logLevel(s){if(s!==void 0){if(typeof s!="string"||["verbose","info","warning","error","fatal"].indexOf(s)===-1)throw new Error(`Unsupported logging level: ${s}`);pG=s}},get logLevel(){return pG}};Object.defineProperty(wr,"logLevel",{enumerable:!0});var $te=wr;var fG=(s,e)=>{let t=typeof document<"u"?document.createElement("canvas"):new OffscreenCanvas(1,1);t.width=s.dims[3],t.height=s.dims[2];let n=t.getContext("2d");if(n!=null){let i,r;e?.tensorLayout!==void 0&&e.tensorLayout==="NHWC"?(i=s.dims[2],r=s.dims[3]):(i=s.dims[3],r=s.dims[2]);let o=e?.format!==void 0?e.format:"RGB",a=e?.norm,l,c;a===void 0||a.mean===void 0?l=[255,255,255,255]:typeof a.mean=="number"?l=[a.mean,a.mean,a.mean,a.mean]:(l=[a.mean[0],a.mean[1],a.mean[2],0],a.mean[3]!==void 0&&(l[3]=a.mean[3])),a===void 0||a.bias===void 0?c=[0,0,0,0]:typeof a.bias=="number"?c=[a.bias,a.bias,a.bias,a.bias]:(c=[a.bias[0],a.bias[1],a.bias[2],0],a.bias[3]!==void 0&&(c[3]=a.bias[3]));let d=r*i,u=0,h=d,p=d*2,f=-1;o==="RGBA"?(u=0,h=d,p=d*2,f=d*3):o==="RGB"?(u=0,h=d,p=d*2):o==="RBG"&&(u=0,p=d,h=d*2);for(let _=0;_<r;_++)for(let b=0;b<i;b++){let y=(s.data[u++]-c[0])*l[0],w=(s.data[h++]-c[1])*l[1],C=(s.data[p++]-c[2])*l[2],M=f===-1?255:(s.data[f++]-c[3])*l[3];n.fillStyle="rgba("+y+","+w+","+C+","+M+")",n.fillRect(b,_,1,1)}if("toDataURL"in t)return t.toDataURL();throw new Error("toDataURL is not supported")}else throw new Error("Can not access image data")},mG=(s,e)=>{let t=typeof document<"u"?document.createElement("canvas").getContext("2d"):new OffscreenCanvas(1,1).getContext("2d"),n;if(t!=null){let i,r,o;e?.tensorLayout!==void 0&&e.tensorLayout==="NHWC"?(i=s.dims[2],r=s.dims[1],o=s.dims[3]):(i=s.dims[3],r=s.dims[2],o=s.dims[1]);let a=e!==void 0&&e.format!==void 0?e.format:"RGB",l=e?.norm,c,d;l===void 0||l.mean===void 0?c=[255,255,255,255]:typeof l.mean=="number"?c=[l.mean,l.mean,l.mean,l.mean]:(c=[l.mean[0],l.mean[1],l.mean[2],255],l.mean[3]!==void 0&&(c[3]=l.mean[3])),l===void 0||l.bias===void 0?d=[0,0,0,0]:typeof l.bias=="number"?d=[l.bias,l.bias,l.bias,l.bias]:(d=[l.bias[0],l.bias[1],l.bias[2],0],l.bias[3]!==void 0&&(d[3]=l.bias[3]));let u=r*i;if(e!==void 0&&(e.format!==void 0&&o===4&&e.format!=="RGBA"||o===3&&e.format!=="RGB"&&e.format!=="BGR"))throw new Error("Tensor format doesn't match input tensor dims");let h=4,p=0,f=1,_=2,b=3,y=0,w=u,C=u*2,M=-1;a==="RGBA"?(y=0,w=u,C=u*2,M=u*3):a==="RGB"?(y=0,w=u,C=u*2):a==="RBG"&&(y=0,C=u,w=u*2),n=t.createImageData(i,r);for(let S=0;S<r*i;p+=h,f+=h,_+=h,b+=h,S++)n.data[p]=(s.data[y++]-d[0])*c[0],n.data[f]=(s.data[w++]-d[1])*c[1],n.data[_]=(s.data[C++]-d[2])*c[2],n.data[b]=M===-1?255:(s.data[M++]-d[3])*c[3]}else throw new Error("Can not access image data");return n};var FI=(s,e)=>{if(s===void 0)throw new Error("Image buffer must be defined");if(e.height===void 0||e.width===void 0)throw new Error("Image height and width must be defined");if(e.tensorLayout==="NHWC")throw new Error("NHWC Tensor layout is not supported yet");let{height:t,width:n}=e,i=e.norm??{mean:255,bias:0},r,o;typeof i.mean=="number"?r=[i.mean,i.mean,i.mean,i.mean]:r=[i.mean[0],i.mean[1],i.mean[2],i.mean[3]??255],typeof i.bias=="number"?o=[i.bias,i.bias,i.bias,i.bias]:o=[i.bias[0],i.bias[1],i.bias[2],i.bias[3]??0];let a=e.format!==void 0?e.format:"RGBA",l=e.tensorFormat!==void 0&&e.tensorFormat!==void 0?e.tensorFormat:"RGB",c=t*n,d=l==="RGBA"?new Float32Array(c*4):new Float32Array(c*3),u=4,h=0,p=1,f=2,_=3,b=0,y=c,w=c*2,C=-1;a==="RGB"&&(u=3,h=0,p=1,f=2,_=-1),l==="RGBA"?C=c*3:l==="RBG"?(b=0,w=c,y=c*2):l==="BGR"&&(w=0,y=c,b=c*2);for(let S=0;S<c;S++,h+=u,f+=u,p+=u,_+=u)d[b++]=(s[h]+o[0])/r[0],d[y++]=(s[p]+o[1])/r[1],d[w++]=(s[f]+o[2])/r[2],C!==-1&&_!==-1&&(d[C++]=(s[_]+o[3])/r[3]);return l==="RGBA"?new hi("float32",d,[1,4,t,n]):new hi("float32",d,[1,3,t,n])},gG=async(s,e)=>{let t=typeof HTMLImageElement<"u"&&s instanceof HTMLImageElement,n=typeof ImageData<"u"&&s instanceof ImageData,i=typeof ImageBitmap<"u"&&s instanceof ImageBitmap,r=typeof s=="string",o,a=e??{},l=()=>{if(typeof document<"u")return document.createElement("canvas");if(typeof OffscreenCanvas<"u")return new OffscreenCanvas(1,1);throw new Error("Canvas is not supported")},c=d=>typeof HTMLCanvasElement<"u"&&d instanceof HTMLCanvasElement||d instanceof OffscreenCanvas?d.getContext("2d"):null;if(t){let d=l();d.width=s.width,d.height=s.height;let u=c(d);if(u!=null){let h=s.height,p=s.width;if(e!==void 0&&e.resizedHeight!==void 0&&e.resizedWidth!==void 0&&(h=e.resizedHeight,p=e.resizedWidth),e!==void 0){if(a=e,e.tensorFormat!==void 0)throw new Error("Image input config format must be RGBA for HTMLImageElement");a.tensorFormat="RGBA",a.height=h,a.width=p}else a.tensorFormat="RGBA",a.height=h,a.width=p;u.drawImage(s,0,0),o=u.getImageData(0,0,p,h).data}else throw new Error("Can not access image data")}else if(n){let d,u;if(e!==void 0&&e.resizedWidth!==void 0&&e.resizedHeight!==void 0?(d=e.resizedHeight,u=e.resizedWidth):(d=s.height,u=s.width),e!==void 0&&(a=e),a.format="RGBA",a.height=d,a.width=u,e!==void 0){let h=l();h.width=u,h.height=d;let p=c(h);if(p!=null)p.putImageData(s,0,0),o=p.getImageData(0,0,u,d).data;else throw new Error("Can not access image data")}else o=s.data}else if(i){if(e===void 0)throw new Error("Please provide image config with format for Imagebitmap");let d=l();d.width=s.width,d.height=s.height;let u=c(d);if(u!=null){let h=s.height,p=s.width;return u.drawImage(s,0,0,p,h),o=u.getImageData(0,0,p,h).data,a.height=h,a.width=p,FI(o,a)}else throw new Error("Can not access image data")}else{if(r)return new Promise((d,u)=>{let h=l(),p=c(h);if(!s||!p)return u();let f=new Image;f.crossOrigin="Anonymous",f.src=s,f.onload=()=>{h.width=f.width,h.height=f.height,p.drawImage(f,0,0,h.width,h.height);let _=p.getImageData(0,0,h.width,h.height);a.height=h.height,a.width=h.width,d(FI(_.data,a))}});throw new Error("Input data provided is not supported - aborted tensor creation")}if(o!==void 0)return FI(o,a);throw new Error("Input data provided is not supported - aborted tensor creation")},_G=(s,e)=>{let{width:t,height:n,download:i,dispose:r}=e,o=[1,n,t,4];return new hi({location:"texture",type:"float32",texture:s,dims:o,download:i,dispose:r})},yG=(s,e)=>{let{dataType:t,dims:n,download:i,dispose:r}=e;return new hi({location:"gpu-buffer",type:t??"float32",gpuBuffer:s,dims:n,download:i,dispose:r})},vG=(s,e)=>{let{dataType:t,dims:n,download:i,dispose:r}=e;return new hi({location:"ml-tensor",type:t??"float32",mlTensor:s,dims:n,download:i,dispose:r})},bG=(s,e,t)=>new hi({location:"cpu-pinned",type:s,data:e,dims:t??[e.length]});var Wu=new Map([["float32",Float32Array],["uint8",Uint8Array],["int8",Int8Array],["uint16",Uint16Array],["int16",Int16Array],["int32",Int32Array],["bool",Uint8Array],["float64",Float64Array],["uint32",Uint32Array],["int4",Uint8Array],["uint4",Uint8Array]]),Hy=new Map([[Float32Array,"float32"],[Uint8Array,"uint8"],[Int8Array,"int8"],[Uint16Array,"uint16"],[Int16Array,"int16"],[Int32Array,"int32"],[Float64Array,"float64"],[Uint32Array,"uint32"]]),wG=!1,MG=()=>{if(!wG){wG=!0;let s=typeof BigInt64Array<"u"&&BigInt64Array.from,e=typeof BigUint64Array<"u"&&BigUint64Array.from,t=globalThis.Float16Array,n=typeof t<"u"&&t.from;s&&(Wu.set("int64",BigInt64Array),Hy.set(BigInt64Array,"int64")),e&&(Wu.set("uint64",BigUint64Array),Hy.set(BigUint64Array,"uint64")),n?(Wu.set("float16",t),Hy.set(t,"float16")):Wu.set("float16",Uint16Array)}};var TG=s=>{let e=1;for(let t=0;t<s.length;t++){let n=s[t];if(typeof n!="number"||!Number.isSafeInteger(n))throw new TypeError(`dims[${t}] must be an integer, got: ${n}`);if(n<0)throw new RangeError(`dims[${t}] must be a non-negative integer, got: ${n}`);e*=n}return e},EG=(s,e)=>{switch(s.location){case"cpu":return new hi(s.type,s.data,e);case"cpu-pinned":return new hi({location:"cpu-pinned",data:s.data,type:s.type,dims:e});case"texture":return new hi({location:"texture",texture:s.texture,type:s.type,dims:e});case"gpu-buffer":return new hi({location:"gpu-buffer",gpuBuffer:s.gpuBuffer,type:s.type,dims:e});case"ml-tensor":return new hi({location:"ml-tensor",mlTensor:s.mlTensor,type:s.type,dims:e});default:throw new Error(`tensorReshape: tensor location ${s.location} is not supported`)}};var hi=class{constructor(e,t,n){MG();let i,r;if(typeof e=="object"&&"location"in e)switch(this.dataLocation=e.location,i=e.type,r=e.dims,e.location){case"cpu-pinned":{let a=Wu.get(i);if(!a)throw new TypeError(`unsupported type "${i}" to create tensor from pinned buffer`);if(!(e.data instanceof a))throw new TypeError(`buffer should be of type ${a.name}`);this.cpuData=e.data;break}case"texture":{if(i!=="float32")throw new TypeError(`unsupported type "${i}" to create tensor from texture`);this.gpuTextureData=e.texture,this.downloader=e.download,this.disposer=e.dispose;break}case"gpu-buffer":{if(i!=="float32"&&i!=="float16"&&i!=="int32"&&i!=="int64"&&i!=="uint32"&&i!=="uint8"&&i!=="bool"&&i!=="uint4"&&i!=="int4")throw new TypeError(`unsupported type "${i}" to create tensor from gpu buffer`);this.gpuBufferData=e.gpuBuffer,this.downloader=e.download,this.disposer=e.dispose;break}case"ml-tensor":{if(i!=="float32"&&i!=="float16"&&i!=="int32"&&i!=="int64"&&i!=="uint32"&&i!=="uint64"&&i!=="int8"&&i!=="uint8"&&i!=="bool"&&i!=="uint4"&&i!=="int4")throw new TypeError(`unsupported type "${i}" to create tensor from MLTensor`);this.mlTensorData=e.mlTensor,this.downloader=e.download,this.disposer=e.dispose;break}default:throw new Error(`Tensor constructor: unsupported location '${this.dataLocation}'`)}else{let a,l;if(typeof e=="string")if(i=e,l=n,e==="string"){if(!Array.isArray(t))throw new TypeError("A string tensor's data must be a string array.");a=t}else{let c=Wu.get(e);if(c===void 0)throw new TypeError(`Unsupported tensor type: ${e}.`);if(Array.isArray(t)){if(e==="float16"&&c===Uint16Array||e==="uint4"||e==="int4")throw new TypeError(`Creating a ${e} tensor from number array is not supported. Please use ${c.name} as data.`);e==="uint64"||e==="int64"?a=c.from(t,BigInt):a=c.from(t)}else if(t instanceof c)a=t;else if(t instanceof Uint8ClampedArray)if(e==="uint8")a=Uint8Array.from(t);else throw new TypeError("A Uint8ClampedArray tensor's data must be type of uint8");else if(e==="float16"&&t instanceof Uint16Array&&c!==Uint16Array)a=new globalThis.Float16Array(t.buffer,t.byteOffset,t.length);else throw new TypeError(`A ${i} tensor's data must be type of ${c}`)}else if(l=t,Array.isArray(e)){if(e.length===0)throw new TypeError("Tensor type cannot be inferred from an empty array.");let c=typeof e[0];if(c==="string")i="string",a=e;else if(c==="boolean")i="bool",a=Uint8Array.from(e);else throw new TypeError(`Invalid element type of data array: ${c}.`)}else if(e instanceof Uint8ClampedArray)i="uint8",a=Uint8Array.from(e);else{let c=Hy.get(e.constructor);if(c===void 0)throw new TypeError(`Unsupported type for tensor data: ${e.constructor}.`);i=c,a=e}if(l===void 0)l=[a.length];else if(!Array.isArray(l))throw new TypeError("A tensor's dims must be a number array");r=l,this.cpuData=a,this.dataLocation="cpu"}let o=TG(r);if(this.cpuData&&o!==this.cpuData.length&&!((i==="uint4"||i==="int4")&&Math.ceil(o/2)===this.cpuData.length))throw new Error(`Tensor's size(${o}) does not match data length(${this.cpuData.length}).`);this.type=i,this.dims=r,this.size=o}static async fromImage(e,t){return gG(e,t)}static fromTexture(e,t){return _G(e,t)}static fromGpuBuffer(e,t){return yG(e,t)}static fromMLTensor(e,t){return vG(e,t)}static fromPinnedBuffer(e,t,n){return bG(e,t,n)}toDataURL(e){return fG(this,e)}toImageData(e){return mG(this,e)}get data(){if(this.ensureValid(),!this.cpuData)throw new Error("The data is not on CPU. Use `getData()` to download GPU data to CPU, or use `texture` or `gpuBuffer` property to access the GPU data directly.");return this.cpuData}get location(){return this.dataLocation}get texture(){if(this.ensureValid(),!this.gpuTextureData)throw new Error("The data is not stored as a WebGL texture.");return this.gpuTextureData}get gpuBuffer(){if(this.ensureValid(),!this.gpuBufferData)throw new Error("The data is not stored as a WebGPU buffer.");return this.gpuBufferData}get mlTensor(){if(this.ensureValid(),!this.mlTensorData)throw new Error("The data is not stored as a WebNN MLTensor.");return this.mlTensorData}async getData(e){switch(this.ensureValid(),this.dataLocation){case"cpu":case"cpu-pinned":return this.data;case"texture":case"gpu-buffer":case"ml-tensor":{if(!this.downloader)throw new Error("The current tensor is not created with a specified data downloader.");if(this.isDownloading)throw new Error("The current tensor is being downloaded.");try{this.isDownloading=!0;let t=await this.downloader();return this.downloader=void 0,this.dataLocation="cpu",this.cpuData=t,e&&this.disposer&&(this.disposer(),this.disposer=void 0),t}finally{this.isDownloading=!1}}default:throw new Error(`cannot get data from location: ${this.dataLocation}`)}}dispose(){if(this.isDownloading)throw new Error("The current tensor is being downloaded.");this.disposer&&(this.disposer(),this.disposer=void 0),this.cpuData=void 0,this.gpuTextureData=void 0,this.gpuBufferData=void 0,this.mlTensorData=void 0,this.downloader=void 0,this.isDownloading=void 0,this.dataLocation="none"}ensureValid(){if(this.dataLocation==="none")throw new Error("The tensor is disposed.")}reshape(e){if(this.ensureValid(),this.downloader||this.disposer)throw new Error("Cannot reshape a tensor that owns GPU resource.");return EG(this,e)}};var Hu=hi;var xG=(s,e)=>{(typeof wr.trace>"u"?!wr.wasm.trace:!wr.trace)||console.timeStamp(`${s}::ORT::${e}`)},SG=(s,e)=>{let t=new Error().stack?.split(/\r\n|\r|\n/g)||[],n=!1;for(let i=0;i<t.length;i++){if(n&&!t[i].includes("TRACE_FUNC")){let r=`FUNC_${s}::${t[i].trim().split(" ")[1]}`;e&&(r+=`::${e}`),xG("CPU",r);return}t[i].includes("TRACE_FUNC")&&(n=!0)}},C0=s=>{(typeof wr.trace>"u"?!wr.wasm.trace:!wr.trace)||SG("BEGIN",s)},A0=s=>{(typeof wr.trace>"u"?!wr.wasm.trace:!wr.trace)||SG("END",s)};var P0=class s{constructor(e){this.handler=e}async run(e,t,n){C0();let i={},r={};if(typeof e!="object"||e===null||e instanceof Hu||Array.isArray(e))throw new TypeError("'feeds' must be an object that use input names as keys and OnnxValue as corresponding values.");let o=!0;if(typeof t=="object"){if(t===null)throw new TypeError("Unexpected argument[1]: cannot be null.");if(t instanceof Hu)throw new TypeError("'fetches' cannot be a Tensor");if(Array.isArray(t)){if(t.length===0)throw new TypeError("'fetches' cannot be an empty array.");o=!1;for(let c of t){if(typeof c!="string")throw new TypeError("'fetches' must be a string array or an object.");if(this.outputNames.indexOf(c)===-1)throw new RangeError(`'fetches' contains invalid output name: ${c}.`);i[c]=null}if(typeof n=="object"&&n!==null)r=n;else if(typeof n<"u")throw new TypeError("'options' must be an object.")}else{let c=!1,d=Object.getOwnPropertyNames(t);for(let u of this.outputNames)if(d.indexOf(u)!==-1){let h=t[u];(h===null||h instanceof Hu)&&(c=!0,o=!1,i[u]=h)}if(c){if(typeof n=="object"&&n!==null)r=n;else if(typeof n<"u")throw new TypeError("'options' must be an object.")}else r=t}}else if(typeof t<"u")throw new TypeError("Unexpected argument[1]: must be 'fetches' or 'options'.");for(let c of this.inputNames)if(typeof e[c]>"u")throw new Error(`input '${c}' is missing in 'feeds'.`);if(o)for(let c of this.outputNames)i[c]=null;let a=await this.handler.run(e,i,r),l={};for(let c in a)if(Object.hasOwnProperty.call(a,c)){let d=a[c];d instanceof Hu?l[c]=d:l[c]=new Hu(d.type,d.data,d.dims)}return A0(),l}async release(){return this.handler.dispose()}static async create(e,t,n,i){C0();let r,o={};if(typeof e=="string"){if(r=e,typeof t=="object"&&t!==null)o=t;else if(typeof t<"u")throw new TypeError("'options' must be an object.")}else if(e instanceof Uint8Array){if(r=e,typeof t=="object"&&t!==null)o=t;else if(typeof t<"u")throw new TypeError("'options' must be an object.")}else if(e instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&e instanceof SharedArrayBuffer){let d=e,u=0,h=e.byteLength;if(typeof t=="object"&&t!==null)o=t;else if(typeof t=="number"){if(u=t,!Number.isSafeInteger(u))throw new RangeError("'byteOffset' must be an integer.");if(u<0||u>=d.byteLength)throw new RangeError(`'byteOffset' is out of range [0, ${d.byteLength}).`);if(h=e.byteLength-u,typeof n=="number"){if(h=n,!Number.isSafeInteger(h))throw new RangeError("'byteLength' must be an integer.");if(h<=0||u+h>d.byteLength)throw new RangeError(`'byteLength' is out of range (0, ${d.byteLength-u}].`);if(typeof i=="object"&&i!==null)o=i;else if(typeof i<"u")throw new TypeError("'options' must be an object.")}else if(typeof n<"u")throw new TypeError("'byteLength' must be a number.")}else if(typeof t<"u")throw new TypeError("'options' must be an object.");r=new Uint8Array(d,u,h)}else throw new TypeError("Unexpected argument[0]: must be 'path' or 'buffer'.");let[a,l]=await uG(o),c=await a.createInferenceSessionHandler(r,l);return A0(),new s(c)}startProfiling(){this.handler.startProfiling()}endProfiling(){this.handler.endProfiling()}get inputNames(){return this.handler.inputNames}get outputNames(){return this.handler.outputNames}};var Bte=P0;var C1={};sw(C1,{InferenceSession:()=>ZD,TRACE:()=>lv,TRACE_FUNC_BEGIN:()=>Lo,TRACE_FUNC_END:()=>Hr,Tensor:()=>Fo,default:()=>rse,env:()=>Un,registerBackend:()=>Ju});var Ro={};var QD=Object.defineProperty,zte=Object.getOwnPropertyDescriptor,Ute=Object.getOwnPropertyNames,Vte=Object.prototype.hasOwnProperty,Gte=(s=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(s,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):s)(function(s){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+s+'" is not supported')}),Ze=(s,e)=>()=>(s&&(e=s(s=0)),e),Kf=(s,e)=>{for(var t in e)QD(s,t,{get:e[t],enumerable:!0})},Wte=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Ute(e))!Vte.call(s,i)&&i!==t&&QD(s,i,{get:()=>e[i],enumerable:!(n=zte(e,i))||n.enumerable});return s},av=s=>Wte(QD({},"__esModule",{value:!0}),s),jy,Dc,Ju,CG,r4,o4=Ze(()=>{"use strict";jy=new Map,Dc=[],Ju=(s,e,t)=>{if(e&&typeof e.init=="function"&&typeof e.createInferenceSessionHandler=="function"){let n=jy.get(s);if(n===void 0)jy.set(s,{backend:e,priority:t});else{if(n.priority>t)return;if(n.priority===t&&n.backend!==e)throw new Error(`cannot register backend "${s}" using priority ${t}`)}if(t>=0){let i=Dc.indexOf(s);i!==-1&&Dc.splice(i,1);for(let r=0;r<Dc.length;r++)if(jy.get(Dc[r]).priority<=t){Dc.splice(r,0,s);return}Dc.push(s)}return}throw new TypeError("not a valid backend")},CG=async s=>{let e=jy.get(s);if(!e)return"backend not found.";if(e.initialized)return e.backend;if(e.aborted)return e.error;{let t=!!e.initPromise;try{return t||(e.initPromise=e.backend.init(s)),await e.initPromise,e.initialized=!0,e.backend}catch(n){return t||(e.error=`${n}`,e.aborted=!0),e.error}finally{delete e.initPromise}}},r4=async s=>{let e=s.executionProviders||[],t=e.map(l=>typeof l=="string"?l:l.name),n=t.length===0?Dc:t,i,r=[],o=new Set;for(let l of n){let c=await CG(l);typeof c=="string"?r.push({name:l,err:c}):(i||(i=c),i===c&&o.add(l))}if(!i)throw new Error(`no available backend found. ERR: ${r.map(l=>`[${l.name}] ${l.err}`).join(", ")}`);for(let{name:l,err:c}of r)t.includes(l)&&console.warn(`removing requested execution provider "${l}" from session options because it is not available: ${c}`);let a=e.filter(l=>o.has(typeof l=="string"?l:l.name));return[i,new Proxy(s,{get:(l,c)=>c==="executionProviders"?a:Reflect.get(l,c)})]}}),Hte=Ze(()=>{"use strict";o4()}),a4,jte=Ze(()=>{"use strict";a4="1.22.0-dev.20250409-89f8206ba4"}),NI,Wr,l4=Ze(()=>{"use strict";jte(),NI="warning",Wr={wasm:{},webgl:{},webgpu:{},versions:{common:a4},set logLevel(s){if(s!==void 0){if(typeof s!="string"||["verbose","info","warning","error","fatal"].indexOf(s)===-1)throw new Error(`Unsupported logging level: ${s}`);NI=s}},get logLevel(){return NI}},Object.defineProperty(Wr,"logLevel",{enumerable:!0})}),Un,qte=Ze(()=>{"use strict";l4(),Un=Wr}),c4,d4,Kte=Ze(()=>{"use strict";c4=(s,e)=>{let t=typeof document<"u"?document.createElement("canvas"):new OffscreenCanvas(1,1);t.width=s.dims[3],t.height=s.dims[2];let n=t.getContext("2d");if(n!=null){let i,r;e?.tensorLayout!==void 0&&e.tensorLayout==="NHWC"?(i=s.dims[2],r=s.dims[3]):(i=s.dims[3],r=s.dims[2]);let o=e?.format!==void 0?e.format:"RGB",a=e?.norm,l,c;a===void 0||a.mean===void 0?l=[255,255,255,255]:typeof a.mean=="number"?l=[a.mean,a.mean,a.mean,a.mean]:(l=[a.mean[0],a.mean[1],a.mean[2],0],a.mean[3]!==void 0&&(l[3]=a.mean[3])),a===void 0||a.bias===void 0?c=[0,0,0,0]:typeof a.bias=="number"?c=[a.bias,a.bias,a.bias,a.bias]:(c=[a.bias[0],a.bias[1],a.bias[2],0],a.bias[3]!==void 0&&(c[3]=a.bias[3]));let d=r*i,u=0,h=d,p=d*2,f=-1;o==="RGBA"?(u=0,h=d,p=d*2,f=d*3):o==="RGB"?(u=0,h=d,p=d*2):o==="RBG"&&(u=0,p=d,h=d*2);for(let _=0;_<r;_++)for(let b=0;b<i;b++){let y=(s.data[u++]-c[0])*l[0],w=(s.data[h++]-c[1])*l[1],C=(s.data[p++]-c[2])*l[2],M=f===-1?255:(s.data[f++]-c[3])*l[3];n.fillStyle="rgba("+y+","+w+","+C+","+M+")",n.fillRect(b,_,1,1)}if("toDataURL"in t)return t.toDataURL();throw new Error("toDataURL is not supported")}else throw new Error("Can not access image data")},d4=(s,e)=>{let t=typeof document<"u"?document.createElement("canvas").getContext("2d"):new OffscreenCanvas(1,1).getContext("2d"),n;if(t!=null){let i,r,o;e?.tensorLayout!==void 0&&e.tensorLayout==="NHWC"?(i=s.dims[2],r=s.dims[1],o=s.dims[3]):(i=s.dims[3],r=s.dims[2],o=s.dims[1]);let a=e!==void 0&&e.format!==void 0?e.format:"RGB",l=e?.norm,c,d;l===void 0||l.mean===void 0?c=[255,255,255,255]:typeof l.mean=="number"?c=[l.mean,l.mean,l.mean,l.mean]:(c=[l.mean[0],l.mean[1],l.mean[2],255],l.mean[3]!==void 0&&(c[3]=l.mean[3])),l===void 0||l.bias===void 0?d=[0,0,0,0]:typeof l.bias=="number"?d=[l.bias,l.bias,l.bias,l.bias]:(d=[l.bias[0],l.bias[1],l.bias[2],0],l.bias[3]!==void 0&&(d[3]=l.bias[3]));let u=r*i;if(e!==void 0&&(e.format!==void 0&&o===4&&e.format!=="RGBA"||o===3&&e.format!=="RGB"&&e.format!=="BGR"))throw new Error("Tensor format doesn't match input tensor dims");let h=4,p=0,f=1,_=2,b=3,y=0,w=u,C=u*2,M=-1;a==="RGBA"?(y=0,w=u,C=u*2,M=u*3):a==="RGB"?(y=0,w=u,C=u*2):a==="RBG"&&(y=0,C=u,w=u*2),n=t.createImageData(i,r);for(let S=0;S<r*i;p+=h,f+=h,_+=h,b+=h,S++)n.data[p]=(s.data[y++]-d[0])*c[0],n.data[f]=(s.data[w++]-d[1])*c[1],n.data[_]=(s.data[C++]-d[2])*c[2],n.data[b]=M===-1?255:(s.data[M++]-d[3])*c[3]}else throw new Error("Can not access image data");return n}}),k0,u4,h4,p4,f4,m4,Yte=Ze(()=>{"use strict";JD(),k0=(s,e)=>{if(s===void 0)throw new Error("Image buffer must be defined");if(e.height===void 0||e.width===void 0)throw new Error("Image height and width must be defined");if(e.tensorLayout==="NHWC")throw new Error("NHWC Tensor layout is not supported yet");let{height:t,width:n}=e,i=e.norm??{mean:255,bias:0},r,o;typeof i.mean=="number"?r=[i.mean,i.mean,i.mean,i.mean]:r=[i.mean[0],i.mean[1],i.mean[2],i.mean[3]??255],typeof i.bias=="number"?o=[i.bias,i.bias,i.bias,i.bias]:o=[i.bias[0],i.bias[1],i.bias[2],i.bias[3]??0];let a=e.format!==void 0?e.format:"RGBA",l=e.tensorFormat!==void 0&&e.tensorFormat!==void 0?e.tensorFormat:"RGB",c=t*n,d=l==="RGBA"?new Float32Array(c*4):new Float32Array(c*3),u=4,h=0,p=1,f=2,_=3,b=0,y=c,w=c*2,C=-1;a==="RGB"&&(u=3,h=0,p=1,f=2,_=-1),l==="RGBA"?C=c*3:l==="RBG"?(b=0,w=c,y=c*2):l==="BGR"&&(w=0,y=c,b=c*2);for(let M=0;M<c;M++,h+=u,f+=u,p+=u,_+=u)d[b++]=(s[h]+o[0])/r[0],d[y++]=(s[p]+o[1])/r[1],d[w++]=(s[f]+o[2])/r[2],C!==-1&&_!==-1&&(d[C++]=(s[_]+o[3])/r[3]);return l==="RGBA"?new Tr("float32",d,[1,4,t,n]):new Tr("float32",d,[1,3,t,n])},u4=async(s,e)=>{let t=typeof HTMLImageElement<"u"&&s instanceof HTMLImageElement,n=typeof ImageData<"u"&&s instanceof ImageData,i=typeof ImageBitmap<"u"&&s instanceof ImageBitmap,r=typeof s=="string",o,a=e??{},l=()=>{if(typeof document<"u")return document.createElement("canvas");if(typeof OffscreenCanvas<"u")return new OffscreenCanvas(1,1);throw new Error("Canvas is not supported")},c=d=>typeof HTMLCanvasElement<"u"&&d instanceof HTMLCanvasElement||d instanceof OffscreenCanvas?d.getContext("2d"):null;if(t){let d=l();d.width=s.width,d.height=s.height;let u=c(d);if(u!=null){let h=s.height,p=s.width;if(e!==void 0&&e.resizedHeight!==void 0&&e.resizedWidth!==void 0&&(h=e.resizedHeight,p=e.resizedWidth),e!==void 0){if(a=e,e.tensorFormat!==void 0)throw new Error("Image input config format must be RGBA for HTMLImageElement");a.tensorFormat="RGBA",a.height=h,a.width=p}else a.tensorFormat="RGBA",a.height=h,a.width=p;u.drawImage(s,0,0),o=u.getImageData(0,0,p,h).data}else throw new Error("Can not access image data")}else if(n){let d,u;if(e!==void 0&&e.resizedWidth!==void 0&&e.resizedHeight!==void 0?(d=e.resizedHeight,u=e.resizedWidth):(d=s.height,u=s.width),e!==void 0&&(a=e),a.format="RGBA",a.height=d,a.width=u,e!==void 0){let h=l();h.width=u,h.height=d;let p=c(h);if(p!=null)p.putImageData(s,0,0),o=p.getImageData(0,0,u,d).data;else throw new Error("Can not access image data")}else o=s.data}else if(i){if(e===void 0)throw new Error("Please provide image config with format for Imagebitmap");let d=l();d.width=s.width,d.height=s.height;let u=c(d);if(u!=null){let h=s.height,p=s.width;return u.drawImage(s,0,0,p,h),o=u.getImageData(0,0,p,h).data,a.height=h,a.width=p,k0(o,a)}else throw new Error("Can not access image data")}else{if(r)return new Promise((d,u)=>{let h=l(),p=c(h);if(!s||!p)return u();let f=new Image;f.crossOrigin="Anonymous",f.src=s,f.onload=()=>{h.width=f.width,h.height=f.height,p.drawImage(f,0,0,h.width,h.height);let _=p.getImageData(0,0,h.width,h.height);a.height=h.height,a.width=h.width,d(k0(_.data,a))}});throw new Error("Input data provided is not supported - aborted tensor creation")}if(o!==void 0)return k0(o,a);throw new Error("Input data provided is not supported - aborted tensor creation")},h4=(s,e)=>{let{width:t,height:n,download:i,dispose:r}=e,o=[1,n,t,4];return new Tr({location:"texture",type:"float32",texture:s,dims:o,download:i,dispose:r})},p4=(s,e)=>{let{dataType:t,dims:n,download:i,dispose:r}=e;return new Tr({location:"gpu-buffer",type:t??"float32",gpuBuffer:s,dims:n,download:i,dispose:r})},f4=(s,e)=>{let{dataType:t,dims:n,download:i,dispose:r}=e;return new Tr({location:"ml-tensor",type:t??"float32",mlTensor:s,dims:n,download:i,dispose:r})},m4=(s,e,t)=>new Tr({location:"cpu-pinned",type:s,data:e,dims:t??[e.length]})}),Xu,nv,OI,g4,Xte=Ze(()=>{"use strict";Xu=new Map([["float32",Float32Array],["uint8",Uint8Array],["int8",Int8Array],["uint16",Uint16Array],["int16",Int16Array],["int32",Int32Array],["bool",Uint8Array],["float64",Float64Array],["uint32",Uint32Array],["int4",Uint8Array],["uint4",Uint8Array]]),nv=new Map([[Float32Array,"float32"],[Uint8Array,"uint8"],[Int8Array,"int8"],[Uint16Array,"uint16"],[Int16Array,"int16"],[Int32Array,"int32"],[Float64Array,"float64"],[Uint32Array,"uint32"]]),OI=!1,g4=()=>{if(!OI){OI=!0;let s=typeof BigInt64Array<"u"&&BigInt64Array.from,e=typeof BigUint64Array<"u"&&BigUint64Array.from,t=globalThis.Float16Array,n=typeof t<"u"&&t.from;s&&(Xu.set("int64",BigInt64Array),nv.set(BigInt64Array,"int64")),e&&(Xu.set("uint64",BigUint64Array),nv.set(BigUint64Array,"uint64")),n?(Xu.set("float16",t),nv.set(t,"float16")):Xu.set("float16",Uint16Array)}}}),_4,y4,Qte=Ze(()=>{"use strict";JD(),_4=s=>{let e=1;for(let t=0;t<s.length;t++){let n=s[t];if(typeof n!="number"||!Number.isSafeInteger(n))throw new TypeError(`dims[${t}] must be an integer, got: ${n}`);if(n<0)throw new RangeError(`dims[${t}] must be a non-negative integer, got: ${n}`);e*=n}return e},y4=(s,e)=>{switch(s.location){case"cpu":return new Tr(s.type,s.data,e);case"cpu-pinned":return new Tr({location:"cpu-pinned",data:s.data,type:s.type,dims:e});case"texture":return new Tr({location:"texture",texture:s.texture,type:s.type,dims:e});case"gpu-buffer":return new Tr({location:"gpu-buffer",gpuBuffer:s.gpuBuffer,type:s.type,dims:e});case"ml-tensor":return new Tr({location:"ml-tensor",mlTensor:s.mlTensor,type:s.type,dims:e});default:throw new Error(`tensorReshape: tensor location ${s.location} is not supported`)}}}),Tr,JD=Ze(()=>{"use strict";Kte(),Yte(),Xte(),Qte(),Tr=class{constructor(s,e,t){g4();let n,i;if(typeof s=="object"&&"location"in s)switch(this.dataLocation=s.location,n=s.type,i=s.dims,s.location){case"cpu-pinned":{let o=Xu.get(n);if(!o)throw new TypeError(`unsupported type "${n}" to create tensor from pinned buffer`);if(!(s.data instanceof o))throw new TypeError(`buffer should be of type ${o.name}`);this.cpuData=s.data;break}case"texture":{if(n!=="float32")throw new TypeError(`unsupported type "${n}" to create tensor from texture`);this.gpuTextureData=s.texture,this.downloader=s.download,this.disposer=s.dispose;break}case"gpu-buffer":{if(n!=="float32"&&n!=="float16"&&n!=="int32"&&n!=="int64"&&n!=="uint32"&&n!=="uint8"&&n!=="bool"&&n!=="uint4"&&n!=="int4")throw new TypeError(`unsupported type "${n}" to create tensor from gpu buffer`);this.gpuBufferData=s.gpuBuffer,this.downloader=s.download,this.disposer=s.dispose;break}case"ml-tensor":{if(n!=="float32"&&n!=="float16"&&n!=="int32"&&n!=="int64"&&n!=="uint32"&&n!=="uint64"&&n!=="int8"&&n!=="uint8"&&n!=="bool"&&n!=="uint4"&&n!=="int4")throw new TypeError(`unsupported type "${n}" to create tensor from MLTensor`);this.mlTensorData=s.mlTensor,this.downloader=s.download,this.disposer=s.dispose;break}default:throw new Error(`Tensor constructor: unsupported location '${this.dataLocation}'`)}else{let o,a;if(typeof s=="string")if(n=s,a=t,s==="string"){if(!Array.isArray(e))throw new TypeError("A string tensor's data must be a string array.");o=e}else{let l=Xu.get(s);if(l===void 0)throw new TypeError(`Unsupported tensor type: ${s}.`);if(Array.isArray(e)){if(s==="float16"&&l===Uint16Array||s==="uint4"||s==="int4")throw new TypeError(`Creating a ${s} tensor from number array is not supported. Please use ${l.name} as data.`);s==="uint64"||s==="int64"?o=l.from(e,BigInt):o=l.from(e)}else if(e instanceof l)o=e;else if(e instanceof Uint8ClampedArray)if(s==="uint8")o=Uint8Array.from(e);else throw new TypeError("A Uint8ClampedArray tensor's data must be type of uint8");else if(s==="float16"&&e instanceof Uint16Array&&l!==Uint16Array)o=new globalThis.Float16Array(e.buffer,e.byteOffset,e.length);else throw new TypeError(`A ${n} tensor's data must be type of ${l}`)}else if(a=e,Array.isArray(s)){if(s.length===0)throw new TypeError("Tensor type cannot be inferred from an empty array.");let l=typeof s[0];if(l==="string")n="string",o=s;else if(l==="boolean")n="bool",o=Uint8Array.from(s);else throw new TypeError(`Invalid element type of data array: ${l}.`)}else if(s instanceof Uint8ClampedArray)n="uint8",o=Uint8Array.from(s);else{let l=nv.get(s.constructor);if(l===void 0)throw new TypeError(`Unsupported type for tensor data: ${s.constructor}.`);n=l,o=s}if(a===void 0)a=[o.length];else if(!Array.isArray(a))throw new TypeError("A tensor's dims must be a number array");i=a,this.cpuData=o,this.dataLocation="cpu"}let r=_4(i);if(this.cpuData&&r!==this.cpuData.length&&!((n==="uint4"||n==="int4")&&Math.ceil(r/2)===this.cpuData.length))throw new Error(`Tensor's size(${r}) does not match data length(${this.cpuData.length}).`);this.type=n,this.dims=i,this.size=r}static async fromImage(s,e){return u4(s,e)}static fromTexture(s,e){return h4(s,e)}static fromGpuBuffer(s,e){return p4(s,e)}static fromMLTensor(s,e){return f4(s,e)}static fromPinnedBuffer(s,e,t){return m4(s,e,t)}toDataURL(s){return c4(this,s)}toImageData(s){return d4(this,s)}get data(){if(this.ensureValid(),!this.cpuData)throw new Error("The data is not on CPU. Use `getData()` to download GPU data to CPU, or use `texture` or `gpuBuffer` property to access the GPU data directly.");return this.cpuData}get location(){return this.dataLocation}get texture(){if(this.ensureValid(),!this.gpuTextureData)throw new Error("The data is not stored as a WebGL texture.");return this.gpuTextureData}get gpuBuffer(){if(this.ensureValid(),!this.gpuBufferData)throw new Error("The data is not stored as a WebGPU buffer.");return this.gpuBufferData}get mlTensor(){if(this.ensureValid(),!this.mlTensorData)throw new Error("The data is not stored as a WebNN MLTensor.");return this.mlTensorData}async getData(s){switch(this.ensureValid(),this.dataLocation){case"cpu":case"cpu-pinned":return this.data;case"texture":case"gpu-buffer":case"ml-tensor":{if(!this.downloader)throw new Error("The current tensor is not created with a specified data downloader.");if(this.isDownloading)throw new Error("The current tensor is being downloaded.");try{this.isDownloading=!0;let e=await this.downloader();return this.downloader=void 0,this.dataLocation="cpu",this.cpuData=e,s&&this.disposer&&(this.disposer(),this.disposer=void 0),e}finally{this.isDownloading=!1}}default:throw new Error(`cannot get data from location: ${this.dataLocation}`)}}dispose(){if(this.isDownloading)throw new Error("The current tensor is being downloaded.");this.disposer&&(this.disposer(),this.disposer=void 0),this.cpuData=void 0,this.gpuTextureData=void 0,this.gpuBufferData=void 0,this.mlTensorData=void 0,this.downloader=void 0,this.isDownloading=void 0,this.dataLocation="none"}ensureValid(){if(this.dataLocation==="none")throw new Error("The tensor is disposed.")}reshape(s){if(this.ensureValid(),this.downloader||this.disposer)throw new Error("Cannot reshape a tensor that owns GPU resource.");return y4(this,s)}}}),Fo,v4=Ze(()=>{"use strict";JD(),Fo=Tr}),lv,$I,Lo,Hr,b4=Ze(()=>{"use strict";l4(),lv=(s,e)=>{(typeof Wr.trace>"u"?!Wr.wasm.trace:!Wr.trace)||console.timeStamp(`${s}::ORT::${e}`)},$I=(s,e)=>{let t=new Error().stack?.split(/\r\n|\r|\n/g)||[],n=!1;for(let i=0;i<t.length;i++){if(n&&!t[i].includes("TRACE_FUNC")){let r=`FUNC_${s}::${t[i].trim().split(" ")[1]}`;e&&(r+=`::${e}`),lv("CPU",r);return}t[i].includes("TRACE_FUNC")&&(n=!0)}},Lo=s=>{(typeof Wr.trace>"u"?!Wr.wasm.trace:!Wr.trace)||$I("BEGIN",s)},Hr=s=>{(typeof Wr.trace>"u"?!Wr.wasm.trace:!Wr.trace)||$I("END",s)}}),w4,Jte=Ze(()=>{"use strict";o4(),v4(),b4(),w4=class M4{constructor(e){this.handler=e}async run(e,t,n){Lo();let i={},r={};if(typeof e!="object"||e===null||e instanceof Fo||Array.isArray(e))throw new TypeError("'feeds' must be an object that use input names as keys and OnnxValue as corresponding values.");let o=!0;if(typeof t=="object"){if(t===null)throw new TypeError("Unexpected argument[1]: cannot be null.");if(t instanceof Fo)throw new TypeError("'fetches' cannot be a Tensor");if(Array.isArray(t)){if(t.length===0)throw new TypeError("'fetches' cannot be an empty array.");o=!1;for(let c of t){if(typeof c!="string")throw new TypeError("'fetches' must be a string array or an object.");if(this.outputNames.indexOf(c)===-1)throw new RangeError(`'fetches' contains invalid output name: ${c}.`);i[c]=null}if(typeof n=="object"&&n!==null)r=n;else if(typeof n<"u")throw new TypeError("'options' must be an object.")}else{let c=!1,d=Object.getOwnPropertyNames(t);for(let u of this.outputNames)if(d.indexOf(u)!==-1){let h=t[u];(h===null||h instanceof Fo)&&(c=!0,o=!1,i[u]=h)}if(c){if(typeof n=="object"&&n!==null)r=n;else if(typeof n<"u")throw new TypeError("'options' must be an object.")}else r=t}}else if(typeof t<"u")throw new TypeError("Unexpected argument[1]: must be 'fetches' or 'options'.");for(let c of this.inputNames)if(typeof e[c]>"u")throw new Error(`input '${c}' is missing in 'feeds'.`);if(o)for(let c of this.outputNames)i[c]=null;let a=await this.handler.run(e,i,r),l={};for(let c in a)if(Object.hasOwnProperty.call(a,c)){let d=a[c];d instanceof Fo?l[c]=d:l[c]=new Fo(d.type,d.data,d.dims)}return Hr(),l}async release(){return this.handler.dispose()}static async create(e,t,n,i){Lo();let r,o={};if(typeof e=="string"){if(r=e,typeof t=="object"&&t!==null)o=t;else if(typeof t<"u")throw new TypeError("'options' must be an object.")}else if(e instanceof Uint8Array){if(r=e,typeof t=="object"&&t!==null)o=t;else if(typeof t<"u")throw new TypeError("'options' must be an object.")}else if(e instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&e instanceof SharedArrayBuffer){let d=e,u=0,h=e.byteLength;if(typeof t=="object"&&t!==null)o=t;else if(typeof t=="number"){if(u=t,!Number.isSafeInteger(u))throw new RangeError("'byteOffset' must be an integer.");if(u<0||u>=d.byteLength)throw new RangeError(`'byteOffset' is out of range [0, ${d.byteLength}).`);if(h=e.byteLength-u,typeof n=="number"){if(h=n,!Number.isSafeInteger(h))throw new RangeError("'byteLength' must be an integer.");if(h<=0||u+h>d.byteLength)throw new RangeError(`'byteLength' is out of range (0, ${d.byteLength-u}].`);if(typeof i=="object"&&i!==null)o=i;else if(typeof i<"u")throw new TypeError("'options' must be an object.")}else if(typeof n<"u")throw new TypeError("'byteLength' must be a number.")}else if(typeof t<"u")throw new TypeError("'options' must be an object.");r=new Uint8Array(d,u,h)}else throw new TypeError("Unexpected argument[0]: must be 'path' or 'buffer'.");let[a,l]=await r4(o),c=await a.createInferenceSessionHandler(r,l);return Hr(),new M4(c)}startProfiling(){this.handler.startProfiling()}endProfiling(){this.handler.endProfiling()}get inputNames(){return this.handler.inputNames}get outputNames(){return this.handler.outputNames}get inputMetadata(){return this.handler.inputMetadata}get outputMetadata(){return this.handler.outputMetadata}}}),ZD,Zte=Ze(()=>{"use strict";Jte(),ZD=w4}),ene=Ze(()=>{"use strict"}),tne=Ze(()=>{"use strict"}),nne=Ze(()=>{"use strict"}),sne=Ze(()=>{"use strict"}),T4={};Kf(T4,{InferenceSession:()=>ZD,TRACE:()=>lv,TRACE_FUNC_BEGIN:()=>Lo,TRACE_FUNC_END:()=>Hr,Tensor:()=>Fo,env:()=>Un,registerBackend:()=>Ju});var No=Ze(()=>{"use strict";Hte(),qte(),Zte(),v4(),ene(),tne(),b4(),nne(),sne()}),e1=Ze(()=>{"use strict"}),E4={};Kf(E4,{default:()=>x4});var BI,zI,x4,ine=Ze(()=>{"use strict";k5(),nh(),t1(),BI="ort-wasm-proxy-worker",zI=globalThis.self?.name===BI,zI&&(self.onmessage=s=>{let{type:e,in:t}=s.data;try{switch(e){case"init-wasm":n1(t.wasm).then(()=>{b1(t).then(()=>{postMessage({type:e})},n=>{postMessage({type:e,err:n})})},n=>{postMessage({type:e,err:n})});break;case"init-ep":{let{epName:n,env:i}=t;w1(i,n).then(()=>{postMessage({type:e})},r=>{postMessage({type:e,err:r})});break}case"copy-from":{let{buffer:n}=t,i=J0(n);postMessage({type:e,out:i});break}case"create":{let{model:n,options:i}=t;M1(n,i).then(r=>{postMessage({type:e,out:r})},r=>{postMessage({type:e,err:r})});break}case"release":T1(t),postMessage({type:e});break;case"run":{let{sessionId:n,inputIndices:i,inputs:r,outputIndices:o,options:a}=t;E1(n,i,r,o,new Array(o.length).fill(null),a).then(l=>{l.some(c=>c[3]!=="cpu")?postMessage({type:e,err:"Proxy does not support non-cpu tensor location."}):postMessage({type:e,out:l},S1([...r,...l]))},l=>{postMessage({type:e,err:l})});break}case"end-profiling":x1(t),postMessage({type:e});break;default:}}catch(n){postMessage({type:e,err:n})}}),x4=zI?null:s=>new Worker(s??Mr,{type:"module",name:BI})}),S4={};Kf(S4,{default:()=>C4});var UI,VI,C4,AG,rne=Ze(()=>{"use strict";VI=(UI=Ro.url,async function(s={}){var e,t,n=s,i=new Promise((x,I)=>{e=x,t=I}),r=typeof window=="object",o=typeof WorkerGlobalScope<"u",a=o&&self.name?.startsWith("em-pthread");n.mountExternalData=(x,I)=>{x.startsWith("./")&&(x=x.substring(2)),(n.Eb||(n.Eb=new Map)).set(x,I)},n.unmountExternalData=()=>{delete n.Eb};var l=globalThis.SharedArrayBuffer??new WebAssembly.Memory({initial:0,maximum:0,pc:!0}).buffer.constructor;let c=x=>async(...I)=>{try{if(n.Fb)throw Error("Session already started");let B=n.Fb={dc:I[0],errors:[]},W=await x(...I);if(n.Fb!==B)throw Error("Session mismatch");n.Jb?.flush();let Q=B.errors;if(0<Q.length){let ge=await Promise.all(Q);if(ge=ge.filter(Be=>Be),0<ge.length)throw Error(ge.join(`
`))}return W}finally{n.Fb=null}};n.jsepInit=(x,I)=>{if(x==="webgpu"){[n.Jb,n.Ub,n.Yb,n.Kb,n.Xb,n.jb,n.Zb,n.ac,n.Vb,n.Wb,n.$b]=I;let B=n.Jb;n.jsepRegisterBuffer=(W,Q,ge,Be)=>B.registerBuffer(W,Q,ge,Be),n.jsepGetBuffer=W=>B.getBuffer(W),n.jsepCreateDownloader=(W,Q,ge)=>B.createDownloader(W,Q,ge),n.jsepOnCreateSession=W=>{B.onCreateSession(W)},n.jsepOnReleaseSession=W=>{B.onReleaseSession(W)},n.jsepOnRunStart=W=>B.onRunStart(W),n.bc=(W,Q)=>{B.upload(W,Q)}}else if(x==="webnn"){let B=I[0];[n.nc,n.Nb,n.webnnEnsureTensor,n.Ob,n.webnnDownloadTensor]=I.slice(1),n.webnnReleaseTensorId=n.Nb,n.webnnUploadTensor=n.Ob,n.webnnOnRunStart=W=>B.onRunStart(W),n.webnnOnRunEnd=B.onRunEnd.bind(B),n.webnnRegisterMLContext=(W,Q)=>{B.registerMLContext(W,Q)},n.webnnOnReleaseSession=W=>{B.onReleaseSession(W)},n.webnnCreateMLTensorDownloader=(W,Q)=>B.createMLTensorDownloader(W,Q),n.webnnRegisterMLTensor=(W,Q,ge,Be)=>B.registerMLTensor(W,Q,ge,Be),n.webnnCreateMLContext=W=>B.createMLContext(W),n.webnnRegisterMLConstant=(W,Q,ge,Be,qe,lt)=>B.registerMLConstant(W,Q,ge,Be,qe,n.Eb,lt),n.webnnRegisterGraphInput=B.registerGraphInput.bind(B),n.webnnIsGraphInput=B.isGraphInput.bind(B),n.webnnCreateTemporaryTensor=B.createTemporaryTensor.bind(B),n.webnnIsInt64Supported=B.isInt64Supported.bind(B)}};let d=()=>{let x=(I,B,W)=>(...Q)=>{let ge=_s,Be=B?.();Q=I(...Q);let qe=B?.();return Be!==qe&&(I=qe,W(Be),B=W=null),_s!=ge?new Promise((lt,vt)=>{Ui={resolve:lt,reject:vt}}):Q};(()=>{for(let I of["_OrtAppendExecutionProvider","_OrtCreateSession","_OrtRun","_OrtRunWithBinding","_OrtBindInput"])n[I]=x(n[I],()=>n[I],B=>n[I]=B)})(),c!==void 0&&(n._OrtRun=c(n._OrtRun),n._OrtRunWithBinding=c(n._OrtRunWithBinding)),d=void 0};n.asyncInit=()=>{d?.()};var u,h,p=Object.assign({},n),f=(x,I)=>{throw I},_="";(r||o)&&(o?_=self.location.href:typeof document<"u"&&document.currentScript&&(_=document.currentScript.src),UI&&(_=UI),_=_.startsWith("blob:")?"":_.slice(0,_.replace(/[?#].*/,"").lastIndexOf("/")+1),o&&(h=x=>{var I=new XMLHttpRequest;return I.open("GET",x,!1),I.responseType="arraybuffer",I.send(null),new Uint8Array(I.response)}),u=async x=>{if(fe(x))return new Promise((B,W)=>{var Q=new XMLHttpRequest;Q.open("GET",x,!0),Q.responseType="arraybuffer",Q.onload=()=>{Q.status==200||Q.status==0&&Q.response?B(Q.response):W(Q.status)},Q.onerror=W,Q.send(null)});var I=await fetch(x,{credentials:"same-origin"});if(I.ok)return I.arrayBuffer();throw Error(I.status+" : "+I.url)});var b=console.log.bind(console),y=console.error.bind(console),w=b,C=y;Object.assign(n,p),p=null;var M,S,k,T,P,R,O,H,X,z,ne,re,Y,se=n.wasmBinary,ue=!1,fe=x=>x.startsWith("file://");function Pe(){return M.buffer!=T.buffer&&Re(),T}function oe(){return M.buffer!=T.buffer&&Re(),P}function te(){return M.buffer!=T.buffer&&Re(),R}function j(){return M.buffer!=T.buffer&&Re(),O}function G(){return M.buffer!=T.buffer&&Re(),H}function de(){return M.buffer!=T.buffer&&Re(),X}function be(){return M.buffer!=T.buffer&&Re(),z}function xe(){return M.buffer!=T.buffer&&Re(),Y}if(a){let x=function(I){try{var B=I.data,W=B.Bb;if(W==="load"){let Q=[];self.onmessage=ge=>Q.push(ge),self.startWorker=()=>{postMessage({Bb:"loaded"});for(let ge of Q)x(ge);self.onmessage=x};for(let ge of B.Rb)n[ge]&&!n[ge].proxy||(n[ge]=(...Be)=>{postMessage({Bb:"callHandler",Qb:ge,args:Be})},ge=="print"&&(w=n[ge]),ge=="printErr"&&(C=n[ge]));M=B.kc,Re(),je(B.lc)}else if(W==="run"){Dl(B.Ab),id(B.Ab,0,0,1,0,0),_n(),_e(B.Ab),dt||(Am(),dt=!0);try{Rl(B.fc,B.Hb)}catch(Q){if(Q!="unwind")throw Q}}else B.target!=="setimmediate"&&(W==="checkMailbox"?dt&&Ne():W&&(C(`worker: received unknown command ${W}`),C(B)))}catch(Q){throw Pm(),Q}};var Oe=x,je,dt=!1;C=function(...I){I=I.join(" "),console.error(I)},self.alert=function(...I){postMessage({Bb:"alert",text:I.join(" "),ic:Ol()})},self.onunhandledrejection=I=>{throw I.reason||I},self.onmessage=x}function Re(){var x=M.buffer;n.HEAP8=T=new Int8Array(x),n.HEAP16=R=new Int16Array(x),n.HEAPU8=P=new Uint8Array(x),n.HEAPU16=O=new Uint16Array(x),n.HEAP32=H=new Int32Array(x),n.HEAPU32=X=new Uint32Array(x),n.HEAPF32=z=new Float32Array(x),n.HEAPF64=Y=new Float64Array(x),n.HEAP64=ne=new BigInt64Array(x),n.HEAPU64=re=new BigUint64Array(x)}function U(){a?startWorker(n):xt.Ca()}a||(M=new WebAssembly.Memory({initial:256,maximum:65536,shared:!0}),Re());var pe,Ce=0,Fe=null;function Ve(){if(--Ce==0&&Fe){var x=Fe;Fe=null,x()}}function De(x){throw C(x="Aborted("+x+")"),ue=!0,x=new WebAssembly.RuntimeError(x+". Build with -sASSERTIONS for more info."),t(x),x}function Ee(){return{a:{L:$e,Aa:Se,b:Ws,$:Da,A:Uo,pa:Bi,X:F,Z:ie,qa:q,na:ee,ga:ae,ma:ye,J:Le,Y:ht,V:wt,oa:rt,W:Lt,va:hn,E:Vo,Q:Ra,O:Wo,D:kr,u:mi,r:Ke,P:tt,z:$,R:J,ja:le,T:nt,aa:it,M:pt,F:Bt,ia:_e,sa:pn,t:Cn,Ba:qs,w:Ir,o:rs,l:Pi,c:Ai,n:qo,j:ab,v:lb,p:Fl,f:cb,s:db,m:ub,e:hb,k:pb,i:Ll,g:fb,d:mb,da:gb,ea:_b,fa:yb,ba:Eh,ca:mm,N:xh,xa:cS,ua:_m,h:wb,C:Mb,G:Tb,ta:bb,x:Eb,ra:xb,U:vm,q:vb,y:Sb,K:Cb,S:bm,za:Ab,ya:wm,ka:Mm,la:kb,_:Pt,B:Tm,I:Ah,ha:Em,H:xm,a:M,wa:at}}}var ze={829644:(x,I,B,W,Q)=>{if(n===void 0||!n.Eb)return 1;if((x=In(Number(x>>>0))).startsWith("./")&&(x=x.substring(2)),!(x=n.Eb.get(x)))return 2;if(I=Number(I>>>0),B=Number(B>>>0),W=Number(W>>>0),I+B>x.byteLength)return 3;try{let ge=x.subarray(I,I+B);switch(Q){case 0:oe().set(ge,W>>>0);break;case 1:n.mc?n.mc(W,ge):n.bc(W,ge);break;default:return 4}return 0}catch{return 4}},830468:(x,I,B)=>{n.Ob(x,oe().subarray(I>>>0,I+B>>>0))},830532:()=>n.nc(),830574:x=>{n.Nb(x)},830611:()=>{n.Vb()},830642:()=>{n.Wb()},830671:()=>{n.$b()},830696:x=>n.Ub(x),830729:x=>n.Yb(x),830761:(x,I,B)=>{n.Kb(Number(x),Number(I),Number(B),!0)},830824:(x,I,B)=>{n.Kb(Number(x),Number(I),Number(B))},830881:()=>typeof wasmOffsetConverter<"u",830938:x=>{n.jb("Abs",x,void 0)},830989:x=>{n.jb("Neg",x,void 0)},831040:x=>{n.jb("Floor",x,void 0)},831093:x=>{n.jb("Ceil",x,void 0)},831145:x=>{n.jb("Reciprocal",x,void 0)},831203:x=>{n.jb("Sqrt",x,void 0)},831255:x=>{n.jb("Exp",x,void 0)},831306:x=>{n.jb("Erf",x,void 0)},831357:x=>{n.jb("Sigmoid",x,void 0)},831412:(x,I,B)=>{n.jb("HardSigmoid",x,{alpha:I,beta:B})},831491:x=>{n.jb("Log",x,void 0)},831542:x=>{n.jb("Sin",x,void 0)},831593:x=>{n.jb("Cos",x,void 0)},831644:x=>{n.jb("Tan",x,void 0)},831695:x=>{n.jb("Asin",x,void 0)},831747:x=>{n.jb("Acos",x,void 0)},831799:x=>{n.jb("Atan",x,void 0)},831851:x=>{n.jb("Sinh",x,void 0)},831903:x=>{n.jb("Cosh",x,void 0)},831955:x=>{n.jb("Asinh",x,void 0)},832008:x=>{n.jb("Acosh",x,void 0)},832061:x=>{n.jb("Atanh",x,void 0)},832114:x=>{n.jb("Tanh",x,void 0)},832166:x=>{n.jb("Not",x,void 0)},832217:(x,I,B)=>{n.jb("Clip",x,{min:I,max:B})},832286:x=>{n.jb("Clip",x,void 0)},832338:(x,I)=>{n.jb("Elu",x,{alpha:I})},832396:x=>{n.jb("Gelu",x,void 0)},832448:x=>{n.jb("Relu",x,void 0)},832500:(x,I)=>{n.jb("LeakyRelu",x,{alpha:I})},832564:(x,I)=>{n.jb("ThresholdedRelu",x,{alpha:I})},832634:(x,I)=>{n.jb("Cast",x,{to:I})},832692:x=>{n.jb("Add",x,void 0)},832743:x=>{n.jb("Sub",x,void 0)},832794:x=>{n.jb("Mul",x,void 0)},832845:x=>{n.jb("Div",x,void 0)},832896:x=>{n.jb("Pow",x,void 0)},832947:x=>{n.jb("Equal",x,void 0)},833e3:x=>{n.jb("Greater",x,void 0)},833055:x=>{n.jb("GreaterOrEqual",x,void 0)},833117:x=>{n.jb("Less",x,void 0)},833169:x=>{n.jb("LessOrEqual",x,void 0)},833228:(x,I,B,W,Q)=>{n.jb("ReduceMean",x,{keepDims:!!I,noopWithEmptyAxes:!!B,axes:W?Array.from(G().subarray(Number(W)>>>0,Number(Q)>>>0)):[]})},833403:(x,I,B,W,Q)=>{n.jb("ReduceMax",x,{keepDims:!!I,noopWithEmptyAxes:!!B,axes:W?Array.from(G().subarray(Number(W)>>>0,Number(Q)>>>0)):[]})},833577:(x,I,B,W,Q)=>{n.jb("ReduceMin",x,{keepDims:!!I,noopWithEmptyAxes:!!B,axes:W?Array.from(G().subarray(Number(W)>>>0,Number(Q)>>>0)):[]})},833751:(x,I,B,W,Q)=>{n.jb("ReduceProd",x,{keepDims:!!I,noopWithEmptyAxes:!!B,axes:W?Array.from(G().subarray(Number(W)>>>0,Number(Q)>>>0)):[]})},833926:(x,I,B,W,Q)=>{n.jb("ReduceSum",x,{keepDims:!!I,noopWithEmptyAxes:!!B,axes:W?Array.from(G().subarray(Number(W)>>>0,Number(Q)>>>0)):[]})},834100:(x,I,B,W,Q)=>{n.jb("ReduceL1",x,{keepDims:!!I,noopWithEmptyAxes:!!B,axes:W?Array.from(G().subarray(Number(W)>>>0,Number(Q)>>>0)):[]})},834273:(x,I,B,W,Q)=>{n.jb("ReduceL2",x,{keepDims:!!I,noopWithEmptyAxes:!!B,axes:W?Array.from(G().subarray(Number(W)>>>0,Number(Q)>>>0)):[]})},834446:(x,I,B,W,Q)=>{n.jb("ReduceLogSum",x,{keepDims:!!I,noopWithEmptyAxes:!!B,axes:W?Array.from(G().subarray(Number(W)>>>0,Number(Q)>>>0)):[]})},834623:(x,I,B,W,Q)=>{n.jb("ReduceSumSquare",x,{keepDims:!!I,noopWithEmptyAxes:!!B,axes:W?Array.from(G().subarray(Number(W)>>>0,Number(Q)>>>0)):[]})},834803:(x,I,B,W,Q)=>{n.jb("ReduceLogSumExp",x,{keepDims:!!I,noopWithEmptyAxes:!!B,axes:W?Array.from(G().subarray(Number(W)>>>0,Number(Q)>>>0)):[]})},834983:x=>{n.jb("Where",x,void 0)},835036:(x,I,B)=>{n.jb("Transpose",x,{perm:I?Array.from(G().subarray(Number(I)>>>0,Number(B)>>>0)):[]})},835160:(x,I,B,W)=>{n.jb("DepthToSpace",x,{blocksize:I,mode:In(B),format:W?"NHWC":"NCHW"})},835293:(x,I,B,W)=>{n.jb("DepthToSpace",x,{blocksize:I,mode:In(B),format:W?"NHWC":"NCHW"})},835426:(x,I,B,W,Q,ge,Be,qe,lt,vt,Vt,cn,En,vs,$a)=>{n.jb("ConvTranspose",x,{format:lt?"NHWC":"NCHW",autoPad:I,dilations:[B],group:W,kernelShape:[Q],pads:[ge,Be],strides:[qe],wIsConst:()=>!!Pe()[vt>>>0],outputPadding:Vt?Array.from(G().subarray(Number(Vt)>>>0,Number(cn)>>>0)):[],outputShape:En?Array.from(G().subarray(Number(En)>>>0,Number(vs)>>>0)):[],activation:In($a)})},835859:(x,I,B,W,Q,ge,Be,qe,lt,vt,Vt,cn,En,vs)=>{n.jb("ConvTranspose",x,{format:qe?"NHWC":"NCHW",autoPad:I,dilations:Array.from(G().subarray(Number(B)>>>0,2+(Number(B)>>>0)>>>0)),group:W,kernelShape:Array.from(G().subarray(Number(Q)>>>0,2+(Number(Q)>>>0)>>>0)),pads:Array.from(G().subarray(Number(ge)>>>0,4+(Number(ge)>>>0)>>>0)),strides:Array.from(G().subarray(Number(Be)>>>0,2+(Number(Be)>>>0)>>>0)),wIsConst:()=>!!Pe()[lt>>>0],outputPadding:vt?Array.from(G().subarray(Number(vt)>>>0,Number(Vt)>>>0)):[],outputShape:cn?Array.from(G().subarray(Number(cn)>>>0,Number(En)>>>0)):[],activation:In(vs)})},836520:(x,I,B,W,Q,ge,Be,qe,lt,vt,Vt,cn,En,vs,$a)=>{n.jb("ConvTranspose",x,{format:lt?"NHWC":"NCHW",autoPad:I,dilations:[B],group:W,kernelShape:[Q],pads:[ge,Be],strides:[qe],wIsConst:()=>!!Pe()[vt>>>0],outputPadding:Vt?Array.from(G().subarray(Number(Vt)>>>0,Number(cn)>>>0)):[],outputShape:En?Array.from(G().subarray(Number(En)>>>0,Number(vs)>>>0)):[],activation:In($a)})},836953:(x,I,B,W,Q,ge,Be,qe,lt,vt,Vt,cn,En,vs)=>{n.jb("ConvTranspose",x,{format:qe?"NHWC":"NCHW",autoPad:I,dilations:Array.from(G().subarray(Number(B)>>>0,2+(Number(B)>>>0)>>>0)),group:W,kernelShape:Array.from(G().subarray(Number(Q)>>>0,2+(Number(Q)>>>0)>>>0)),pads:Array.from(G().subarray(Number(ge)>>>0,4+(Number(ge)>>>0)>>>0)),strides:Array.from(G().subarray(Number(Be)>>>0,2+(Number(Be)>>>0)>>>0)),wIsConst:()=>!!Pe()[lt>>>0],outputPadding:vt?Array.from(G().subarray(Number(vt)>>>0,Number(Vt)>>>0)):[],outputShape:cn?Array.from(G().subarray(Number(cn)>>>0,Number(En)>>>0)):[],activation:In(vs)})},837614:(x,I)=>{n.jb("GlobalAveragePool",x,{format:I?"NHWC":"NCHW"})},837705:(x,I,B,W,Q,ge,Be,qe,lt,vt,Vt,cn,En,vs)=>{n.jb("AveragePool",x,{format:vs?"NHWC":"NCHW",auto_pad:I,ceil_mode:B,count_include_pad:W,storage_order:Q,dilations:ge?Array.from(G().subarray(Number(ge)>>>0,Number(Be)>>>0)):[],kernel_shape:qe?Array.from(G().subarray(Number(qe)>>>0,Number(lt)>>>0)):[],pads:vt?Array.from(G().subarray(Number(vt)>>>0,Number(Vt)>>>0)):[],strides:cn?Array.from(G().subarray(Number(cn)>>>0,Number(En)>>>0)):[]})},838184:(x,I)=>{n.jb("GlobalAveragePool",x,{format:I?"NHWC":"NCHW"})},838275:(x,I,B,W,Q,ge,Be,qe,lt,vt,Vt,cn,En,vs)=>{n.jb("AveragePool",x,{format:vs?"NHWC":"NCHW",auto_pad:I,ceil_mode:B,count_include_pad:W,storage_order:Q,dilations:ge?Array.from(G().subarray(Number(ge)>>>0,Number(Be)>>>0)):[],kernel_shape:qe?Array.from(G().subarray(Number(qe)>>>0,Number(lt)>>>0)):[],pads:vt?Array.from(G().subarray(Number(vt)>>>0,Number(Vt)>>>0)):[],strides:cn?Array.from(G().subarray(Number(cn)>>>0,Number(En)>>>0)):[]})},838754:(x,I)=>{n.jb("GlobalMaxPool",x,{format:I?"NHWC":"NCHW"})},838841:(x,I,B,W,Q,ge,Be,qe,lt,vt,Vt,cn,En,vs)=>{n.jb("MaxPool",x,{format:vs?"NHWC":"NCHW",auto_pad:I,ceil_mode:B,count_include_pad:W,storage_order:Q,dilations:ge?Array.from(G().subarray(Number(ge)>>>0,Number(Be)>>>0)):[],kernel_shape:qe?Array.from(G().subarray(Number(qe)>>>0,Number(lt)>>>0)):[],pads:vt?Array.from(G().subarray(Number(vt)>>>0,Number(Vt)>>>0)):[],strides:cn?Array.from(G().subarray(Number(cn)>>>0,Number(En)>>>0)):[]})},839316:(x,I)=>{n.jb("GlobalMaxPool",x,{format:I?"NHWC":"NCHW"})},839403:(x,I,B,W,Q,ge,Be,qe,lt,vt,Vt,cn,En,vs)=>{n.jb("MaxPool",x,{format:vs?"NHWC":"NCHW",auto_pad:I,ceil_mode:B,count_include_pad:W,storage_order:Q,dilations:ge?Array.from(G().subarray(Number(ge)>>>0,Number(Be)>>>0)):[],kernel_shape:qe?Array.from(G().subarray(Number(qe)>>>0,Number(lt)>>>0)):[],pads:vt?Array.from(G().subarray(Number(vt)>>>0,Number(Vt)>>>0)):[],strides:cn?Array.from(G().subarray(Number(cn)>>>0,Number(En)>>>0)):[]})},839878:(x,I,B,W,Q)=>{n.jb("Gemm",x,{alpha:I,beta:B,transA:W,transB:Q})},839982:x=>{n.jb("MatMul",x,void 0)},840036:(x,I,B,W)=>{n.jb("ArgMax",x,{keepDims:!!I,selectLastIndex:!!B,axis:W})},840144:(x,I,B,W)=>{n.jb("ArgMin",x,{keepDims:!!I,selectLastIndex:!!B,axis:W})},840252:(x,I)=>{n.jb("Softmax",x,{axis:I})},840315:(x,I)=>{n.jb("Concat",x,{axis:I})},840375:(x,I,B,W,Q)=>{n.jb("Split",x,{axis:I,numOutputs:B,splitSizes:W?Array.from(G().subarray(Number(W)>>>0,Number(Q)>>>0)):[]})},840531:x=>{n.jb("Expand",x,void 0)},840585:(x,I)=>{n.jb("Gather",x,{axis:Number(I)})},840656:(x,I)=>{n.jb("GatherElements",x,{axis:Number(I)})},840735:(x,I)=>{n.jb("GatherND",x,{batch_dims:Number(I)})},840814:(x,I,B,W,Q,ge,Be,qe,lt,vt,Vt)=>{n.jb("Resize",x,{antialias:I,axes:B?Array.from(G().subarray(Number(B)>>>0,Number(W)>>>0)):[],coordinateTransformMode:In(Q),cubicCoeffA:ge,excludeOutside:Be,extrapolationValue:qe,keepAspectRatioPolicy:In(lt),mode:In(vt),nearestMode:In(Vt)})},841176:(x,I,B,W,Q,ge,Be)=>{n.jb("Slice",x,{starts:I?Array.from(G().subarray(Number(I)>>>0,Number(B)>>>0)):[],ends:W?Array.from(G().subarray(Number(W)>>>0,Number(Q)>>>0)):[],axes:ge?Array.from(G().subarray(Number(ge)>>>0,Number(Be)>>>0)):[]})},841440:x=>{n.jb("Tile",x,void 0)},841492:(x,I,B)=>{n.jb("InstanceNormalization",x,{epsilon:I,format:B?"NHWC":"NCHW"})},841606:(x,I,B)=>{n.jb("InstanceNormalization",x,{epsilon:I,format:B?"NHWC":"NCHW"})},841720:x=>{n.jb("Range",x,void 0)},841773:(x,I)=>{n.jb("Einsum",x,{equation:In(I)})},841854:(x,I,B,W,Q)=>{n.jb("Pad",x,{mode:I,value:B,pads:W?Array.from(G().subarray(Number(W)>>>0,Number(Q)>>>0)):[]})},841997:(x,I,B,W,Q,ge)=>{n.jb("BatchNormalization",x,{epsilon:I,momentum:B,spatial:!!Q,trainingMode:!!W,format:ge?"NHWC":"NCHW"})},842166:(x,I,B,W,Q,ge)=>{n.jb("BatchNormalization",x,{epsilon:I,momentum:B,spatial:!!Q,trainingMode:!!W,format:ge?"NHWC":"NCHW"})},842335:(x,I,B)=>{n.jb("CumSum",x,{exclusive:Number(I),reverse:Number(B)})},842432:(x,I,B)=>{n.jb("DequantizeLinear",x,{axis:I,blockSize:B})},842522:(x,I,B,W,Q)=>{n.jb("GridSample",x,{align_corners:I,mode:In(B),padding_mode:In(W),format:Q?"NHWC":"NCHW"})},842692:(x,I,B,W,Q)=>{n.jb("GridSample",x,{align_corners:I,mode:In(B),padding_mode:In(W),format:Q?"NHWC":"NCHW"})},842862:(x,I)=>{n.jb("ScatterND",x,{reduction:In(I)})},842947:(x,I,B,W,Q,ge,Be,qe,lt)=>{n.jb("Attention",x,{numHeads:I,isUnidirectional:B,maskFilterValue:W,scale:Q,doRotary:ge,qkvHiddenSizes:Be?Array.from(G().subarray(Number(qe)>>>0,Number(qe)+Be>>>0)):[],pastPresentShareBuffer:!!lt})},843219:x=>{n.jb("BiasAdd",x,void 0)},843274:x=>{n.jb("BiasSplitGelu",x,void 0)},843335:x=>{n.jb("FastGelu",x,void 0)},843391:(x,I,B,W,Q,ge,Be,qe,lt,vt,Vt,cn,En,vs,$a,Rb)=>{n.jb("Conv",x,{format:cn?"NHWC":"NCHW",auto_pad:I,dilations:B?Array.from(G().subarray(Number(B)>>>0,Number(W)>>>0)):[],group:Q,kernel_shape:ge?Array.from(G().subarray(Number(ge)>>>0,Number(Be)>>>0)):[],pads:qe?Array.from(G().subarray(Number(qe)>>>0,Number(lt)>>>0)):[],strides:vt?Array.from(G().subarray(Number(vt)>>>0,Number(Vt)>>>0)):[],w_is_const:()=>!!Pe()[Number(En)>>>0],activation:In(vs),activation_params:$a?Array.from(be().subarray(Number($a)>>>0,Number(Rb)>>>0)):[]})},843975:x=>{n.jb("Gelu",x,void 0)},844027:(x,I,B,W,Q,ge,Be,qe,lt)=>{n.jb("GroupQueryAttention",x,{numHeads:I,kvNumHeads:B,scale:W,softcap:Q,doRotary:ge,rotaryInterleaved:Be,smoothSoftmax:qe,localWindowSize:lt})},844244:(x,I,B,W)=>{n.jb("LayerNormalization",x,{axis:I,epsilon:B,simplified:!!W})},844355:(x,I,B,W)=>{n.jb("LayerNormalization",x,{axis:I,epsilon:B,simplified:!!W})},844466:(x,I,B,W,Q,ge)=>{n.jb("MatMulNBits",x,{k:I,n:B,accuracyLevel:W,bits:Q,blockSize:ge})},844593:(x,I,B,W,Q,ge)=>{n.jb("MultiHeadAttention",x,{numHeads:I,isUnidirectional:B,maskFilterValue:W,scale:Q,doRotary:ge})},844752:(x,I)=>{n.jb("QuickGelu",x,{alpha:I})},844816:(x,I,B,W,Q)=>{n.jb("RotaryEmbedding",x,{interleaved:!!I,numHeads:B,rotaryEmbeddingDim:W,scale:Q})},844955:(x,I,B)=>{n.jb("SkipLayerNormalization",x,{epsilon:I,simplified:!!B})},845057:(x,I,B)=>{n.jb("SkipLayerNormalization",x,{epsilon:I,simplified:!!B})},845159:(x,I,B,W)=>{n.jb("GatherBlockQuantized",x,{gatherAxis:I,quantizeAxis:B,blockSize:W})},845280:x=>{n.Zb(x)},845314:(x,I)=>n.ac(Number(x),Number(I),n.Fb.dc,n.Fb.errors)};function Se(x,I,B){return Ns(async()=>{await n.Xb(Number(x),Number(I),Number(B))})}function $e(){return typeof wasmOffsetConverter<"u"}class et{constructor(I){Z(this,"name","ExitStatus");this.message=`Program terminated with exit(${I})`,this.status=I}}var Ge=x=>{x.terminate(),x.onmessage=()=>{}},Ye=[],Xe=x=>{st.length==0&&(Ia(),xs(st[0]));var I=st.pop();if(!I)return 6;zt.push(I),un[x.Ab]=I,I.Ab=x.Ab;var B={Bb:"run",fc:x.ec,Hb:x.Hb,Ab:x.Ab};return I.postMessage(B,x.Mb),0},gt=0,We=(x,I,...B)=>{for(var W=2*B.length,Q=Dh(),ge=od(8*W),Be=ge>>>3,qe=0;qe<B.length;qe++){var lt=B[qe];typeof lt=="bigint"?(ne[Be+2*qe]=1n,ne[Be+2*qe+1]=lt):(ne[Be+2*qe]=0n,xe()[Be+2*qe+1>>>0]=lt)}return x=km(x,0,W,ge,I),rd(Q),x};function at(x){if(a)return We(0,1,x);if(k=x,!(0<gt)){for(var I of zt)Ge(I);for(I of st)Ge(I);st=[],zt=[],un={},ue=!0}f(0,new et(x))}function Qe(x){if(a)return We(1,0,x);Pt(x)}var Pt=x=>{if(k=x,a)throw Qe(x),"unwind";at(x)},st=[],zt=[],rn=[],un={},ds=x=>{var I=x.Ab;delete un[I],st.push(x),zt.splice(zt.indexOf(x),1),x.Ab=0,Ph(I)};function _n(){rn.forEach(x=>x())}var xs=x=>new Promise(I=>{x.onmessage=Q=>{var ge=(Q=Q.data).Bb;if(Q.Gb&&Q.Gb!=Ol()){var Be=un[Q.Gb];Be?Be.postMessage(Q,Q.Mb):C(`Internal error! Worker sent a message "${ge}" to target pthread ${Q.Gb}, but that thread no longer exists!`)}else ge==="checkMailbox"?Ne():ge==="spawnThread"?Xe(Q):ge==="cleanupThread"?ds(un[Q.hc]):ge==="loaded"?(x.loaded=!0,I(x)):ge==="alert"?alert(`Thread ${Q.ic}: ${Q.text}`):Q.target==="setimmediate"?x.postMessage(Q):ge==="callHandler"?n[Q.Qb](...Q.args):ge&&C(`worker sent an unknown command ${ge}`)},x.onerror=Q=>{throw C(`worker sent an error! ${Q.filename}:${Q.lineno}: ${Q.message}`),Q};var B,W=[];for(B of[])n.propertyIsEnumerable(B)&&W.push(B);x.postMessage({Bb:"load",Rb:W,kc:M,lc:S})});function Ia(){var x=new Worker((()=>{let I=URL;return Ro.url>"file:"&&Ro.url<"file;"?new I("ort.bundle.min.mjs",Ro.url):new URL(Ro.url)})(),{type:"module",workerData:"em-pthread",name:"em-pthread"});st.push(x)}var Dl=x=>{Re();var I=de()[x+52>>>2>>>0];x=de()[x+56>>>2>>>0],Dm(I,I-x),rd(I)},Rl=(x,I)=>{gt=0,x=Rm(x,I),0<gt?k=x:kh(x)};class Yn{constructor(I){this.Ib=I-24}}function Ws(x,I,B){var W=new Yn(x>>>=0);throw I>>>=0,B>>>=0,de()[W.Ib+16>>>2>>>0]=0,de()[W.Ib+4>>>2>>>0]=I,de()[W.Ib+8>>>2>>>0]=B,x}function sr(x,I,B,W){return a?We(2,1,x,I,B,W):Da(x,I,B,W)}function Da(x,I,B,W){if(x>>>=0,B>>>=0,W>>>=0,l===void 0)return 6;var Q=[];return a&&Q.length===0?sr(x,I>>>=0,B,W):(x={ec:B,Ab:x,Hb:W,Mb:Q},a?(x.Bb="spawnThread",postMessage(x,Q),0):Xe(x))}var Rt=typeof TextDecoder<"u"?new TextDecoder:void 0,zo=(x,I=0,B=NaN)=>{var W=(I>>>=0)+B;for(B=I;x[B]&&!(B>=W);)++B;if(16<B-I&&x.buffer&&Rt)return Rt.decode(x.buffer instanceof ArrayBuffer?x.subarray(I,B):x.slice(I,B));for(W="";I<B;){var Q=x[I++];if(128&Q){var ge=63&x[I++];if((224&Q)==192)W+=String.fromCharCode((31&Q)<<6|ge);else{var Be=63&x[I++];65536>(Q=(240&Q)==224?(15&Q)<<12|ge<<6|Be:(7&Q)<<18|ge<<12|Be<<6|63&x[I++])?W+=String.fromCharCode(Q):(Q-=65536,W+=String.fromCharCode(55296|Q>>10,56320|1023&Q))}}else W+=String.fromCharCode(Q)}return W},In=(x,I)=>(x>>>=0)?zo(oe(),x,I):"";function Uo(x,I,B){return a?We(3,1,x,I,B):0}function Bi(x,I){if(a)return We(4,1,x,I)}var Kt=x=>{for(var I=0,B=0;B<x.length;++B){var W=x.charCodeAt(B);127>=W?I++:2047>=W?I+=2:55296<=W&&57343>=W?(I+=4,++B):I+=3}return I},zi=(x,I,B)=>{var W=oe();if(I>>>=0,0<B){var Q=I;B=I+B-1;for(var ge=0;ge<x.length;++ge){var Be=x.charCodeAt(ge);if(55296<=Be&&57343>=Be&&(Be=65536+((1023&Be)<<10)|1023&x.charCodeAt(++ge)),127>=Be){if(I>=B)break;W[I++>>>0]=Be}else{if(2047>=Be){if(I+1>=B)break;W[I++>>>0]=192|Be>>6}else{if(65535>=Be){if(I+2>=B)break;W[I++>>>0]=224|Be>>12}else{if(I+3>=B)break;W[I++>>>0]=240|Be>>18,W[I++>>>0]=128|Be>>12&63}W[I++>>>0]=128|Be>>6&63}W[I++>>>0]=128|63&Be}}W[I>>>0]=0,x=I-Q}else x=0;return x};function F(x,I){if(a)return We(5,1,x,I)}function ie(x,I,B){if(a)return We(6,1,x,I,B)}function q(x,I,B){return a?We(7,1,x,I,B):0}function ee(x,I){if(a)return We(8,1,x,I)}function ae(x,I,B){if(a)return We(9,1,x,I,B)}function ye(x,I,B,W){if(a)return We(10,1,x,I,B,W)}function Le(x,I,B,W){if(a)return We(11,1,x,I,B,W)}function ht(x,I,B,W){if(a)return We(12,1,x,I,B,W)}function wt(x){if(a)return We(13,1,x)}function rt(x,I){if(a)return We(14,1,x,I)}function Lt(x,I,B){if(a)return We(15,1,x,I,B)}var ut,Nt,hn=()=>De(""),Fn=x=>{for(var I="";oe()[x>>>0];)I+=ut[oe()[x++>>>0]];return I},ns={},Hs={},Fs={};function js(x,I,B={}){return function(W,Q,ge={}){var Be=Q.name;if(!W)throw new Nt(`type "${Be}" must have a positive integer typeid pointer`);if(Hs.hasOwnProperty(W)){if(ge.Sb)return;throw new Nt(`Cannot register type '${Be}' twice`)}Hs[W]=Q,delete Fs[W],ns.hasOwnProperty(W)&&(Q=ns[W],delete ns[W],Q.forEach(qe=>qe()))}(x,I,B)}var Qr=(x,I,B)=>{switch(I){case 1:return B?W=>Pe()[W>>>0]:W=>oe()[W>>>0];case 2:return B?W=>te()[W>>>1>>>0]:W=>j()[W>>>1>>>0];case 4:return B?W=>G()[W>>>2>>>0]:W=>de()[W>>>2>>>0];case 8:return B?W=>ne[W>>>3]:W=>re[W>>>3];default:throw new TypeError(`invalid integer width (${I}): ${x}`)}};function Vo(x,I,B){B>>>=0,js(x>>>=0,{name:I=Fn(I>>>0),fromWireType:W=>W,toWireType:function(W,Q){if(typeof Q!="bigint"&&typeof Q!="number")throw Q=Q===null?"null":(W=typeof Q)=="object"||W==="array"||W==="function"?Q.toString():""+Q,new TypeError(`Cannot convert "${Q}" to ${this.name}`);return typeof Q=="number"&&(Q=BigInt(Q)),Q},Cb:us,readValueFromPointer:Qr(I,B,I.indexOf("u")==-1),Db:null})}var us=8;function Ra(x,I,B,W){js(x>>>=0,{name:I=Fn(I>>>0),fromWireType:function(Q){return!!Q},toWireType:function(Q,ge){return ge?B:W},Cb:us,readValueFromPointer:function(Q){return this.fromWireType(oe()[Q>>>0])},Db:null})}var Pr=[],si=[];function Ai(x){9<(x>>>=0)&&--si[x+1]==0&&(si[x]=void 0,Pr.push(x))}var Xn=x=>{if(!x)throw new Nt("Cannot use deleted val. handle = "+x);return si[x]},ss=x=>{switch(x){case void 0:return 2;case null:return 4;case!0:return 6;case!1:return 8;default:let I=Pr.pop()||si.length;return si[I]=x,si[I+1]=1,I}};function Jr(x){return this.fromWireType(de()[x>>>2>>>0])}var Go={name:"emscripten::val",fromWireType:x=>{var I=Xn(x);return Ai(x),I},toWireType:(x,I)=>ss(I),Cb:us,readValueFromPointer:Jr,Db:null};function Wo(x){return js(x>>>0,Go)}var Ho=(x,I)=>{switch(I){case 4:return function(B){return this.fromWireType(be()[B>>>2>>>0])};case 8:return function(B){return this.fromWireType(xe()[B>>>3>>>0])};default:throw new TypeError(`invalid float width (${I}): ${x}`)}};function kr(x,I,B){B>>>=0,js(x>>>=0,{name:I=Fn(I>>>0),fromWireType:W=>W,toWireType:(W,Q)=>Q,Cb:us,readValueFromPointer:Ho(I,B),Db:null})}function mi(x,I,B,W,Q){if(x>>>=0,B>>>=0,I=Fn(I>>>0),Q===-1&&(Q=4294967295),Q=qe=>qe,W===0){var ge=32-8*B;Q=qe=>qe<<ge>>>ge}var Be=I.includes("unsigned")?function(qe,lt){return lt>>>0}:function(qe,lt){return lt};js(x,{name:I,fromWireType:Q,toWireType:Be,Cb:us,readValueFromPointer:Qr(I,B,W!==0),Db:null})}function Ke(x,I,B){function W(ge){var Be=de()[ge>>>2>>>0];return ge=de()[ge+4>>>2>>>0],new Q(Pe().buffer,ge,Be)}var Q=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array,BigInt64Array,BigUint64Array][I];js(x>>>=0,{name:B=Fn(B>>>0),fromWireType:W,Cb:us,readValueFromPointer:W},{Sb:!0})}function tt(x,I){js(x>>>=0,{name:I=Fn(I>>>0),fromWireType:function(B){for(var W,Q=de()[B>>>2>>>0],ge=B+4,Be=ge,qe=0;qe<=Q;++qe){var lt=ge+qe;qe!=Q&&oe()[lt>>>0]!=0||(Be=In(Be,lt-Be),W===void 0?W=Be:(W+="\0",W+=Be),Be=lt+1)}return rr(B),W},toWireType:function(B,W){W instanceof ArrayBuffer&&(W=new Uint8Array(W));var Q=typeof W=="string";if(!(Q||W instanceof Uint8Array||W instanceof Uint8ClampedArray||W instanceof Int8Array))throw new Nt("Cannot pass non-string to std::string");var ge=Q?Kt(W):W.length,Be=sd(4+ge+1),qe=Be+4;if(de()[Be>>>2>>>0]=ge,Q)zi(W,qe,ge+1);else if(Q)for(Q=0;Q<ge;++Q){var lt=W.charCodeAt(Q);if(255<lt)throw rr(Be),new Nt("String has UTF-16 code units that do not fit in 8 bits");oe()[qe+Q>>>0]=lt}else for(Q=0;Q<ge;++Q)oe()[qe+Q>>>0]=W[Q];return B!==null&&B.push(rr,Be),Be},Cb:us,readValueFromPointer:Jr,Db(B){rr(B)}})}var _t=typeof TextDecoder<"u"?new TextDecoder("utf-16le"):void 0,kn=(x,I)=>{for(var B=x>>1,W=B+I/2;!(B>=W)&&j()[B>>>0];)++B;if(32<(B<<=1)-x&&_t)return _t.decode(oe().slice(x,B));for(B="",W=0;!(W>=I/2);++W){var Q=te()[x+2*W>>>1>>>0];if(Q==0)break;B+=String.fromCharCode(Q)}return B},Fa=(x,I,B)=>{if(B??(B=2147483647),2>B)return 0;var W=I;B=(B-=2)<2*x.length?B/2:x.length;for(var Q=0;Q<B;++Q){var ge=x.charCodeAt(Q);te()[I>>>1>>>0]=ge,I+=2}return te()[I>>>1>>>0]=0,I-W},jo=x=>2*x.length,La=(x,I)=>{for(var B=0,W="";!(B>=I/4);){var Q=G()[x+4*B>>>2>>>0];if(Q==0)break;++B,65536<=Q?(Q-=65536,W+=String.fromCharCode(55296|Q>>10,56320|1023&Q)):W+=String.fromCharCode(Q)}return W},ed=(x,I,B)=>{if(I>>>=0,B??(B=2147483647),4>B)return 0;var W=I;B=W+B-4;for(var Q=0;Q<x.length;++Q){var ge=x.charCodeAt(Q);if(55296<=ge&&57343>=ge&&(ge=65536+((1023&ge)<<10)|1023&x.charCodeAt(++Q)),G()[I>>>2>>>0]=ge,(I+=4)+4>B)break}return G()[I>>>2>>>0]=0,I-W},ve=x=>{for(var I=0,B=0;B<x.length;++B){var W=x.charCodeAt(B);55296<=W&&57343>=W&&++B,I+=4}return I};function $(x,I,B){if(x>>>=0,I>>>=0,B=Fn(B>>>=0),I===2)var W=kn,Q=Fa,ge=jo,Be=qe=>j()[qe>>>1>>>0];else I===4&&(W=La,Q=ed,ge=ve,Be=qe=>de()[qe>>>2>>>0]);js(x,{name:B,fromWireType:qe=>{for(var lt,vt=de()[qe>>>2>>>0],Vt=qe+4,cn=0;cn<=vt;++cn){var En=qe+4+cn*I;cn!=vt&&Be(En)!=0||(Vt=W(Vt,En-Vt),lt===void 0?lt=Vt:(lt+="\0",lt+=Vt),Vt=En+I)}return rr(qe),lt},toWireType:(qe,lt)=>{if(typeof lt!="string")throw new Nt(`Cannot pass non-string to C++ string type ${B}`);var vt=ge(lt),Vt=sd(4+vt+I);return de()[Vt>>>2>>>0]=vt/I,Q(lt,Vt+4,vt+I),qe!==null&&qe.push(rr,Vt),Vt},Cb:us,readValueFromPointer:Jr,Db(qe){rr(qe)}})}function J(x,I){js(x>>>=0,{Tb:!0,name:I=Fn(I>>>0),Cb:0,fromWireType:()=>{},toWireType:()=>{}})}function le(x){id(x>>>0,!o,1,!r,131072,!1),_n()}var me=x=>{if(!ue)try{if(x(),!(0<gt))try{a?kh(k):Pt(k)}catch(I){I instanceof et||I=="unwind"||f(0,I)}}catch(I){I instanceof et||I=="unwind"||f(0,I)}};function _e(x){x>>>=0,typeof Atomics.jc=="function"&&(Atomics.jc(G(),x>>>2,x).value.then(Ne),x+=128,Atomics.store(G(),x>>>2,1))}var Ne=()=>{var x=Ol();x&&(_e(x),me(Ih))};function nt(x,I){(x>>>=0)==I>>>0?setTimeout(Ne):a?postMessage({Gb:x,Bb:"checkMailbox"}):(x=un[x])&&x.postMessage({Bb:"checkMailbox"})}var ct=[];function it(x,I,B,W,Q){for(I>>>=0,W/=2,ct.length=W,B=Q>>>0>>>3,Q=0;Q<W;Q++)ct[Q]=ne[B+2*Q]?ne[B+2*Q+1]:xe()[B+2*Q+1>>>0];return(I?ze[I]:Db[x])(...ct)}var pt=()=>{gt=0};function Bt(x){x>>>=0,a?postMessage({Bb:"cleanupThread",hc:x}):ds(un[x])}function pn(x){}var ln=(x,I)=>{var B=Hs[x];if(B===void 0)throw x=Cm(x),B=Fn(x),rr(x),new Nt(`${I} has unknown type ${B}`);return B},Gn=(x,I,B)=>{var W=[];return x=x.toWireType(W,B),W.length&&(de()[I>>>2>>>0]=ss(W)),x};function Cn(x,I,B){return I>>>=0,B>>>=0,x=Xn(x>>>0),I=ln(I,"emval::as"),Gn(I,B,x)}function qs(x,I){return I>>>=0,x=Xn(x>>>0),(I=ln(I,"emval::as")).toWireType(null,x)}var gs=x=>{try{x()}catch(I){De(I)}},is=0,_s=null,Ss=0,ir=[],On={},ys={},Ls=0,Ui=null,Zr=[];function Ns(x){return function(I){if(!ue){if(is===0){var B=!1,W=!1;I((Q=0)=>{if(!ue&&(Ss=Q,B=!0,W)){is=2,gs(()=>Lm(_s)),typeof MainLoop<"u"&&MainLoop.Pb&&MainLoop.resume(),Q=!1;try{var ge=function(){var lt=G()[_s+8>>>2>>>0];return lt=xt[ys[lt]],--gt,lt()}()}catch(lt){ge=lt,Q=!0}var Be=!1;if(!_s){var qe=Ui;qe&&(Ui=null,(Q?qe.reject:qe.resolve)(ge),Be=!0)}if(Q&&!Be)throw ge}}),W=!0,B||(is=1,_s=function(){var Q=sd(65548),ge=Q+12;de()[Q>>>2>>>0]=ge,de()[Q+4>>>2>>>0]=ge+65536,ge=ir[0];var Be=On[ge];return Be===void 0&&(Be=Ls++,On[ge]=Be,ys[Be]=ge),ge=Be,G()[Q+8>>>2>>>0]=ge,Q}(),typeof MainLoop<"u"&&MainLoop.Pb&&MainLoop.pause(),gs(()=>Rh(_s)))}else is===2?(is=0,gs(Fh),rr(_s),_s=null,Zr.forEach(me)):De(`invalid state: ${is}`);return Ss}}(I=>{x().then(I)})}function Ir(x){return x>>>=0,Ns(async()=>{var I=await Xn(x);return ss(I)})}var Qn=[];function rs(x,I,B,W){return B>>>=0,W>>>=0,(x=Qn[x>>>0])(null,I=Xn(I>>>0),B,W)}var hs={},Wn=x=>{var I=hs[x];return I===void 0?Fn(x):I};function Pi(x,I,B,W,Q){return B>>>=0,W>>>=0,Q>>>=0,(x=Qn[x>>>0])(I=Xn(I>>>0),I[B=Wn(B)],W,Q)}var Na=()=>typeof globalThis=="object"?globalThis:Function("return this")();function qo(x){return(x>>>=0)==0?ss(Na()):(x=Wn(x),ss(Na()[x]))}var rb=x=>{var I=Qn.length;return Qn.push(x),I},ob=(x,I)=>{for(var B=Array(x),W=0;W<x;++W)B[W]=ln(de()[I+4*W>>>2>>>0],"parameter "+W);return B},hm=(x,I)=>Object.defineProperty(I,"name",{value:x});function ab(x,I,B){var W=(I=ob(x,I>>>0)).shift();x--;var Q=`return function (obj, func, destructorsRef, args) {
`,ge=0,Be=[];B===0&&Be.push("obj");for(var qe=["retType"],lt=[W],vt=0;vt<x;++vt)Be.push("arg"+vt),qe.push("argType"+vt),lt.push(I[vt]),Q+=`  var arg${vt} = argType${vt}.readValueFromPointer(args${ge?"+"+ge:""});
`,ge+=I[vt].Cb;return Q+=`  var rv = ${B===1?"new func":"func.call"}(${Be.join(", ")});
`,W.Tb||(qe.push("emval_returnValue"),lt.push(Gn),Q+=`  return emval_returnValue(retType, destructorsRef, rv);
`),qe.push(Q+`};
`),x=function(Vt){var cn=Function;if(!(cn instanceof Function))throw new TypeError(`new_ called with constructor type ${typeof cn} which is not a function`);var En=hm(cn.name||"unknownFunctionName",function(){});return En.prototype=cn.prototype,En=new En,(Vt=cn.apply(En,Vt))instanceof Object?Vt:En}(qe)(...lt),B=`methodCaller<(${I.map(Vt=>Vt.name).join(", ")}) => ${W.name}>`,rb(hm(B,x))}function lb(x){return x=Wn(x>>>0),ss(n[x])}function Fl(x,I){return I>>>=0,x=Xn(x>>>0),I=Xn(I),ss(x[I])}function cb(x){9<(x>>>=0)&&(si[x+1]+=1)}function db(){return ss([])}function ub(x){x=Xn(x>>>0);for(var I=Array(x.length),B=0;B<x.length;B++)I[B]=x[B];return ss(I)}function hb(x){return ss(Wn(x>>>0))}function pb(){return ss({})}function Ll(x){for(var I=Xn(x>>>=0);I.length;){var B=I.pop();I.pop()(B)}Ai(x)}function fb(x,I,B){I>>>=0,B>>>=0,x=Xn(x>>>0),I=Xn(I),B=Xn(B),x[I]=B}function mb(x,I){return I>>>=0,x=(x=ln(x>>>0,"_emval_take_value")).readValueFromPointer(I),ss(x)}function gb(x,I){x=-9007199254740992>x||9007199254740992<x?NaN:Number(x),I>>>=0,x=new Date(1e3*x),G()[I>>>2>>>0]=x.getUTCSeconds(),G()[I+4>>>2>>>0]=x.getUTCMinutes(),G()[I+8>>>2>>>0]=x.getUTCHours(),G()[I+12>>>2>>>0]=x.getUTCDate(),G()[I+16>>>2>>>0]=x.getUTCMonth(),G()[I+20>>>2>>>0]=x.getUTCFullYear()-1900,G()[I+24>>>2>>>0]=x.getUTCDay(),x=(x.getTime()-Date.UTC(x.getUTCFullYear(),0,1,0,0,0,0))/864e5|0,G()[I+28>>>2>>>0]=x}var pm=x=>x%4==0&&(x%100!=0||x%400==0),fm=[0,31,60,91,121,152,182,213,244,274,305,335],Th=[0,31,59,90,120,151,181,212,243,273,304,334];function _b(x,I){x=-9007199254740992>x||9007199254740992<x?NaN:Number(x),I>>>=0,x=new Date(1e3*x),G()[I>>>2>>>0]=x.getSeconds(),G()[I+4>>>2>>>0]=x.getMinutes(),G()[I+8>>>2>>>0]=x.getHours(),G()[I+12>>>2>>>0]=x.getDate(),G()[I+16>>>2>>>0]=x.getMonth(),G()[I+20>>>2>>>0]=x.getFullYear()-1900,G()[I+24>>>2>>>0]=x.getDay();var B=(pm(x.getFullYear())?fm:Th)[x.getMonth()]+x.getDate()-1|0;G()[I+28>>>2>>>0]=B,G()[I+36>>>2>>>0]=-60*x.getTimezoneOffset(),B=new Date(x.getFullYear(),6,1).getTimezoneOffset();var W=new Date(x.getFullYear(),0,1).getTimezoneOffset();x=0|(B!=W&&x.getTimezoneOffset()==Math.min(W,B)),G()[I+32>>>2>>>0]=x}function yb(x){x>>>=0;var I=new Date(G()[x+20>>>2>>>0]+1900,G()[x+16>>>2>>>0],G()[x+12>>>2>>>0],G()[x+8>>>2>>>0],G()[x+4>>>2>>>0],G()[x>>>2>>>0],0),B=G()[x+32>>>2>>>0],W=I.getTimezoneOffset(),Q=new Date(I.getFullYear(),6,1).getTimezoneOffset(),ge=new Date(I.getFullYear(),0,1).getTimezoneOffset(),Be=Math.min(ge,Q);return 0>B?G()[x+32>>>2>>>0]=+(Q!=ge&&Be==W):0<B!=(Be==W)&&(Q=Math.max(ge,Q),I.setTime(I.getTime()+6e4*((0<B?Be:Q)-W))),G()[x+24>>>2>>>0]=I.getDay(),B=(pm(I.getFullYear())?fm:Th)[I.getMonth()]+I.getDate()-1|0,G()[x+28>>>2>>>0]=B,G()[x>>>2>>>0]=I.getSeconds(),G()[x+4>>>2>>>0]=I.getMinutes(),G()[x+8>>>2>>>0]=I.getHours(),G()[x+12>>>2>>>0]=I.getDate(),G()[x+16>>>2>>>0]=I.getMonth(),G()[x+20>>>2>>>0]=I.getYear(),x=I.getTime(),BigInt(isNaN(x)?-1:x/1e3)}function Eh(x,I,B,W,Q,ge,Be){return a?We(16,1,x,I,B,W,Q,ge,Be):-52}function mm(x,I,B,W,Q,ge){if(a)return We(17,1,x,I,B,W,Q,ge)}var Oa={},vb=()=>performance.timeOrigin+performance.now();function xh(x,I){if(a)return We(18,1,x,I);if(Oa[x]&&(clearTimeout(Oa[x].id),delete Oa[x]),!I)return 0;var B=setTimeout(()=>{delete Oa[x],me(()=>Im(x,performance.timeOrigin+performance.now()))},I);return Oa[x]={id:B,qc:I},0}function cS(x,I,B,W){x>>>=0,I>>>=0,B>>>=0,W>>>=0;var Q=new Date().getFullYear(),ge=new Date(Q,0,1).getTimezoneOffset();Q=new Date(Q,6,1).getTimezoneOffset();var Be=Math.max(ge,Q);de()[x>>>2>>>0]=60*Be,G()[I>>>2>>>0]=+(ge!=Q),x=(I=qe=>{var lt=Math.abs(qe);return`UTC${0<=qe?"-":"+"}${String(Math.floor(lt/60)).padStart(2,"0")}${String(lt%60).padStart(2,"0")}`})(ge),I=I(Q),Q<ge?(zi(x,B,17),zi(I,W,17)):(zi(x,W,17),zi(I,B,17))}var bb=()=>Date.now(),gm=1;function _m(x,I,B){if(!(0<=x&&3>=x))return 28;if(x===0)x=Date.now();else{if(!gm)return 52;x=performance.timeOrigin+performance.now()}return ne[B>>>0>>>3]=BigInt(Math.round(1e6*x)),0}var Nl=[],ym=(x,I)=>{Nl.length=0;for(var B;B=oe()[x++>>>0];){var W=B!=105;I+=(W&=B!=112)&&I%8?4:0,Nl.push(B==112?de()[I>>>2>>>0]:B==106?ne[I>>>3]:B==105?G()[I>>>2>>>0]:xe()[I>>>3>>>0]),I+=W?8:4}return Nl};function wb(x,I,B){return x>>>=0,I=ym(I>>>0,B>>>0),ze[x](...I)}function Mb(x,I,B){return x>>>=0,I=ym(I>>>0,B>>>0),ze[x](...I)}var Tb=()=>{};function Eb(x,I){return C(In(x>>>0,I>>>0))}var xb=()=>{throw gt+=1,"unwind"};function vm(){return 4294901760}var Sb=()=>navigator.hardwareConcurrency;function Cb(){return De("Cannot use emscripten_pc_get_function without -sUSE_OFFSET_CONVERTER"),0}function bm(x){x>>>=0;var I=oe().length;if(x<=I||4294901760<x)return!1;for(var B=1;4>=B;B*=2){var W=I*(1+.2/B);W=Math.min(W,x+100663296);e:{W=(Math.min(4294901760,65536*Math.ceil(Math.max(x,W)/65536))-M.buffer.byteLength+65535)/65536|0;try{M.grow(W),Re();var Q=1;break e}catch{}Q=void 0}if(Q)return!0}return!1}var td=()=>(De("Cannot use convertFrameToPC (needed by __builtin_return_address) without -sUSE_OFFSET_CONVERTER"),0),eo={},Sh=x=>{x.forEach(I=>{var B=td();B&&(eo[B]=I)})};function Ab(){var x=Error().stack.toString().split(`
`);return x[0]=="Error"&&x.shift(),Sh(x),eo.Lb=td(),eo.cc=x,eo.Lb}function wm(x,I,B){if(x>>>=0,I>>>=0,eo.Lb==x)var W=eo.cc;else(W=Error().stack.toString().split(`
`))[0]=="Error"&&W.shift(),Sh(W);for(var Q=3;W[Q]&&td()!=x;)++Q;for(x=0;x<B&&W[x+Q];++x)G()[I+4*x>>>2>>>0]=td();return x}var to,Ch={},Pb=()=>{if(!to){var x,I={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:(typeof navigator=="object"&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:"./this.program"};for(x in Ch)Ch[x]===void 0?delete I[x]:I[x]=Ch[x];var B=[];for(x in I)B.push(`${x}=${I[x]}`);to=B}return to};function Mm(x,I){if(a)return We(19,1,x,I);x>>>=0,I>>>=0;var B=0;return Pb().forEach((W,Q)=>{var ge=I+B;for(Q=de()[x+4*Q>>>2>>>0]=ge,ge=0;ge<W.length;++ge)Pe()[Q++>>>0]=W.charCodeAt(ge);Pe()[Q>>>0]=0,B+=W.length+1}),0}function kb(x,I){if(a)return We(20,1,x,I);x>>>=0,I>>>=0;var B=Pb();de()[x>>>2>>>0]=B.length;var W=0;return B.forEach(Q=>W+=Q.length+1),de()[I>>>2>>>0]=W,0}function Tm(x){return a?We(21,1,x):52}function Ah(x,I,B,W){return a?We(22,1,x,I,B,W):52}function Em(x,I,B,W){return a?We(23,1,x,I,B,W):70}var Ib=[null,[],[]];function xm(x,I,B,W){if(a)return We(24,1,x,I,B,W);I>>>=0,B>>>=0,W>>>=0;for(var Q=0,ge=0;ge<B;ge++){var Be=de()[I>>>2>>>0],qe=de()[I+4>>>2>>>0];I+=8;for(var lt=0;lt<qe;lt++){var vt=oe()[Be+lt>>>0],Vt=Ib[x];vt===0||vt===10?((x===1?w:C)(zo(Vt)),Vt.length=0):Vt.push(vt)}Q+=qe}return de()[W>>>2>>>0]=Q,0}a||function(){for(var x=n.numThreads-1;x--;)Ia();Ye.unshift(()=>{Ce++,function(I){a?I():Promise.all(st.map(xs)).then(I)}(()=>Ve())})}();for(var Sm=Array(256),nd=0;256>nd;++nd)Sm[nd]=String.fromCharCode(nd);ut=Sm,Nt=n.BindingError=class extends Error{constructor(x){super(x),this.name="BindingError"}},n.InternalError=class extends Error{constructor(x){super(x),this.name="InternalError"}},si.push(0,1,void 0,1,null,1,!0,1,!1,1),n.count_emval_handles=()=>si.length/2-5-Pr.length;var xt,Db=[at,Qe,sr,Uo,Bi,F,ie,q,ee,ae,ye,Le,ht,wt,rt,Lt,Eh,mm,xh,Mm,kb,Tm,Ah,Em,xm];(async function(){function x(W,Q){return xt=W.exports,xt=function(){var ge=xt,Be={};for(let[qe,lt]of Object.entries(ge))Be[qe]=typeof lt=="function"?(...vt)=>{ir.push(qe);try{return lt(...vt)}finally{ue||(ir.pop(),_s&&is===1&&ir.length===0&&(is=0,gt+=1,gs(Fm),typeof Fibers<"u"&&Fibers.rc()))}}:lt;return Be}(),xt=function(){var ge=xt,Be=lt=>vt=>lt(vt)>>>0,qe=lt=>()=>lt()>>>0;return(ge=Object.assign({},ge)).Da=Be(ge.Da),ge.fb=qe(ge.fb),ge.hb=Be(ge.hb),ge.tb=Be(ge.tb),ge.ub=qe(ge.ub),ge.__cxa_get_exception_ptr=Be(ge.__cxa_get_exception_ptr),ge}(),rn.push(xt.ib),S=Q,Ve(),xt}Ce++;var I=Ee();if(n.instantiateWasm)return new Promise(W=>{n.instantiateWasm(I,(Q,ge)=>{x(Q,ge),W(Q.exports)})});if(a)return new Promise(W=>{je=Q=>{var ge=new WebAssembly.Instance(Q,Ee());W(x(ge,Q))}});pe??(pe=n.locateFile?n.locateFile?n.locateFile("ort-wasm-simd-threaded.jsep.wasm",_):_+"ort-wasm-simd-threaded.jsep.wasm":new URL("ort-wasm-simd-threaded.jsep.wasm",Ro.url).href);try{var B=await async function(W){var Q=pe;if(!se&&typeof WebAssembly.instantiateStreaming=="function"&&!fe(Q))try{var ge=fetch(Q,{credentials:"same-origin"});return await WebAssembly.instantiateStreaming(ge,W)}catch(Be){C(`wasm streaming compile failed: ${Be}`),C("falling back to ArrayBuffer instantiation")}return async function(Be,qe){try{var lt=await async function(vt){if(!se)try{var Vt=await u(vt);return new Uint8Array(Vt)}catch{}if(vt==pe&&se)vt=new Uint8Array(se);else{if(!h)throw"both async and sync fetching of the wasm failed";vt=h(vt)}return vt}(Be);return await WebAssembly.instantiate(lt,qe)}catch(vt){C(`failed to asynchronously prepare wasm: ${vt}`),De(vt)}}(Q,W)}(I);return x(B.instance,B.module)}catch(W){return t(W),Promise.reject(W)}})();var Cm=x=>(Cm=xt.Da)(x),Am=()=>(Am=xt.Ea)();n._OrtInit=(x,I)=>(n._OrtInit=xt.Fa)(x,I),n._OrtGetLastError=(x,I)=>(n._OrtGetLastError=xt.Ga)(x,I),n._OrtCreateSessionOptions=(x,I,B,W,Q,ge,Be,qe,lt,vt)=>(n._OrtCreateSessionOptions=xt.Ha)(x,I,B,W,Q,ge,Be,qe,lt,vt),n._OrtAppendExecutionProvider=(x,I,B,W,Q)=>(n._OrtAppendExecutionProvider=xt.Ia)(x,I,B,W,Q),n._OrtAddFreeDimensionOverride=(x,I,B)=>(n._OrtAddFreeDimensionOverride=xt.Ja)(x,I,B),n._OrtAddSessionConfigEntry=(x,I,B)=>(n._OrtAddSessionConfigEntry=xt.Ka)(x,I,B),n._OrtReleaseSessionOptions=x=>(n._OrtReleaseSessionOptions=xt.La)(x),n._OrtCreateSession=(x,I,B)=>(n._OrtCreateSession=xt.Ma)(x,I,B),n._OrtReleaseSession=x=>(n._OrtReleaseSession=xt.Na)(x),n._OrtGetInputOutputCount=(x,I,B)=>(n._OrtGetInputOutputCount=xt.Oa)(x,I,B),n._OrtGetInputOutputMetadata=(x,I,B,W)=>(n._OrtGetInputOutputMetadata=xt.Pa)(x,I,B,W),n._OrtFree=x=>(n._OrtFree=xt.Qa)(x),n._OrtCreateTensor=(x,I,B,W,Q,ge)=>(n._OrtCreateTensor=xt.Ra)(x,I,B,W,Q,ge),n._OrtGetTensorData=(x,I,B,W,Q)=>(n._OrtGetTensorData=xt.Sa)(x,I,B,W,Q),n._OrtReleaseTensor=x=>(n._OrtReleaseTensor=xt.Ta)(x),n._OrtCreateRunOptions=(x,I,B,W)=>(n._OrtCreateRunOptions=xt.Ua)(x,I,B,W),n._OrtAddRunConfigEntry=(x,I,B)=>(n._OrtAddRunConfigEntry=xt.Va)(x,I,B),n._OrtReleaseRunOptions=x=>(n._OrtReleaseRunOptions=xt.Wa)(x),n._OrtCreateBinding=x=>(n._OrtCreateBinding=xt.Xa)(x),n._OrtBindInput=(x,I,B)=>(n._OrtBindInput=xt.Ya)(x,I,B),n._OrtBindOutput=(x,I,B,W)=>(n._OrtBindOutput=xt.Za)(x,I,B,W),n._OrtClearBoundOutputs=x=>(n._OrtClearBoundOutputs=xt._a)(x),n._OrtReleaseBinding=x=>(n._OrtReleaseBinding=xt.$a)(x),n._OrtRunWithBinding=(x,I,B,W,Q)=>(n._OrtRunWithBinding=xt.ab)(x,I,B,W,Q),n._OrtRun=(x,I,B,W,Q,ge,Be,qe)=>(n._OrtRun=xt.bb)(x,I,B,W,Q,ge,Be,qe),n._OrtEndProfiling=x=>(n._OrtEndProfiling=xt.cb)(x),n._JsepOutput=(x,I,B)=>(n._JsepOutput=xt.db)(x,I,B),n._JsepGetNodeName=x=>(n._JsepGetNodeName=xt.eb)(x);var Ol=()=>(Ol=xt.fb)(),rr=n._free=x=>(rr=n._free=xt.gb)(x),sd=n._malloc=x=>(sd=n._malloc=xt.hb)(x),id=(x,I,B,W,Q,ge)=>(id=xt.kb)(x,I,B,W,Q,ge),Pm=()=>(Pm=xt.lb)(),km=(x,I,B,W,Q)=>(km=xt.mb)(x,I,B,W,Q),Ph=x=>(Ph=xt.nb)(x),kh=x=>(kh=xt.ob)(x),Im=(x,I)=>(Im=xt.pb)(x,I),Ih=()=>(Ih=xt.qb)(),Dm=(x,I)=>(Dm=xt.rb)(x,I),rd=x=>(rd=xt.sb)(x),od=x=>(od=xt.tb)(x),Dh=()=>(Dh=xt.ub)(),Rm=n.dynCall_ii=(x,I)=>(Rm=n.dynCall_ii=xt.vb)(x,I),Rh=x=>(Rh=xt.wb)(x),Fm=()=>(Fm=xt.xb)(),Lm=x=>(Lm=xt.yb)(x),Fh=()=>(Fh=xt.zb)();return n.stackSave=()=>Dh(),n.stackRestore=x=>rd(x),n.stackAlloc=x=>od(x),n.setValue=function(x,I,B="i8"){switch(B.endsWith("*")&&(B="*"),B){case"i1":case"i8":Pe()[x>>>0]=I;break;case"i16":te()[x>>>1>>>0]=I;break;case"i32":G()[x>>>2>>>0]=I;break;case"i64":ne[x>>>3]=BigInt(I);break;case"float":be()[x>>>2>>>0]=I;break;case"double":xe()[x>>>3>>>0]=I;break;case"*":de()[x>>>2>>>0]=I;break;default:De(`invalid type for setValue: ${B}`)}},n.getValue=function(x,I="i8"){switch(I.endsWith("*")&&(I="*"),I){case"i1":case"i8":return Pe()[x>>>0];case"i16":return te()[x>>>1>>>0];case"i32":return G()[x>>>2>>>0];case"i64":return ne[x>>>3];case"float":return be()[x>>>2>>>0];case"double":return xe()[x>>>3>>>0];case"*":return de()[x>>>2>>>0];default:De(`invalid type for getValue: ${I}`)}},n.UTF8ToString=In,n.stringToUTF8=zi,n.lengthBytesUTF8=Kt,function x(){if(0<Ce)Fe=x;else if(a)e(n),U();else{for(;0<Ye.length;)Ye.shift()(n);0<Ce?Fe=x:(n.calledRun=!0,ue||(U(),e(n)))}}(),n.PTR_SIZE=4,i}),C4=VI,AG=globalThis.self?.name?.startsWith("em-pthread"),AG&&VI()}),GI,LD,PG,Mr,A4,I0,kG,IG,WI,DG,HI,P4,jI,k4,t1=Ze(()=>{"use strict";e1(),GI=typeof location>"u"?void 0:location.origin,LD=Ro.url>"file:"&&Ro.url<"file;",PG=()=>{if(LD){let s=URL;return new URL(new s("ort.bundle.min.mjs",Ro.url).href,GI).href}return Ro.url},Mr=PG(),A4=()=>{if(Mr&&!Mr.startsWith("blob:"))return Mr.substring(0,Mr.lastIndexOf("/")+1)},I0=(s,e)=>{try{let t=e??Mr;return(t?new URL(s,t):new URL(s)).origin===GI}catch{return!1}},kG=(s,e)=>{let t=e??Mr;try{return(t?new URL(s,t):new URL(s)).href}catch{return}},IG=(s,e)=>`${e??"./"}${s}`,WI=async s=>{let e=await(await fetch(s,{credentials:"same-origin"})).blob();return URL.createObjectURL(e)},DG=async s=>(await import(s)).default,HI=(ine(),av(E4)).default,P4=async()=>{if(!Mr)throw new Error("Failed to load proxy worker: cannot determine the script source URL.");if(I0(Mr))return[void 0,HI()];let s=await WI(Mr);return[s,HI(s)]},jI=(rne(),av(S4)).default,k4=async(s,e,t)=>{if(!s&&!e&&jI&&Mr&&I0(Mr))return[void 0,jI];{let n="ort-wasm-simd-threaded.jsep.mjs",i=s??kG(n,e),r=t&&i&&!I0(i,e),o=r?await WI(i):i??IG(n,e);return[r?o:void 0,await DG(o)]}}}),qI,D0,qy,KI,RG,FG,LG,n1,Nn,nh=Ze(()=>{"use strict";t1(),D0=!1,qy=!1,KI=!1,RG=()=>{if(typeof SharedArrayBuffer>"u")return!1;try{return typeof MessageChannel<"u"&&new MessageChannel().port1.postMessage(new SharedArrayBuffer(1)),WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,2,1,0,5,4,1,3,1,1,10,11,1,9,0,65,0,254,16,2,0,26,11]))}catch{return!1}},FG=()=>{try{return WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,2,1,0,10,30,1,28,0,65,0,253,15,253,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,253,186,1,26,11]))}catch{return!1}},LG=()=>{try{return WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,19,1,17,0,65,1,253,15,65,2,253,15,65,3,253,15,253,147,2,11]))}catch{return!1}},n1=async s=>{if(D0)return Promise.resolve();if(qy)throw new Error("multiple calls to 'initializeWebAssembly()' detected.");if(KI)throw new Error("previous call to 'initializeWebAssembly()' failed.");qy=!0;let e=s.initTimeout,t=s.numThreads;if(s.simd!==!1){if(s.simd==="relaxed"){if(!LG())throw new Error("Relaxed WebAssembly SIMD is not supported in the current environment.")}else if(!FG())throw new Error("WebAssembly SIMD is not supported in the current environment.")}let n=RG();t>1&&!n&&(typeof self<"u"&&!self.crossOriginIsolated&&console.warn("env.wasm.numThreads is set to "+t+", but this will not work unless you enable crossOriginIsolated mode. See https://web.dev/cross-origin-isolation-guide/ for more info."),console.warn("WebAssembly multi-threading is not supported in the current environment. Falling back to single-threading."),s.numThreads=t=1);let i=s.wasmPaths,r=typeof i=="string"?i:void 0,o=i?.mjs,a=o?.href??o,l=i?.wasm,c=l?.href??l,d=s.wasmBinary,[u,h]=await k4(a,r,t>1),p=!1,f=[];if(e>0&&f.push(new Promise(_=>{setTimeout(()=>{p=!0,_()},e)})),f.push(new Promise((_,b)=>{let y={numThreads:t};if(d)y.wasmBinary=d;else if(c||r)y.locateFile=w=>c??r+w;else if(a&&a.indexOf("blob:")!==0)y.locateFile=w=>new URL(w,a).href;else if(u){let w=A4();w&&(y.locateFile=C=>w+C)}h(y).then(w=>{qy=!1,D0=!0,qI=w,_(),u&&URL.revokeObjectURL(u)},w=>{qy=!1,KI=!0,b(w)})})),await Promise.race(f),p)throw new Error(`WebAssembly backend initializing failed due to timeout: ${e}ms`)},Nn=()=>{if(D0&&qI)return qI;throw new Error("WebAssembly is not initialized yet.")}}),Do,j0,An,s1=Ze(()=>{"use strict";nh(),Do=(s,e)=>{let t=Nn(),n=t.lengthBytesUTF8(s)+1,i=t._malloc(n);return t.stringToUTF8(s,i,n),e.push(i),i},j0=(s,e,t,n)=>{if(typeof s=="object"&&s!==null){if(t.has(s))throw new Error("Circular reference in options");t.add(s)}Object.entries(s).forEach(([i,r])=>{let o=e?e+i:i;if(typeof r=="object")j0(r,o+".",t,n);else if(typeof r=="string"||typeof r=="number")n(o,r.toString());else if(typeof r=="boolean")n(o,r?"1":"0");else throw new Error(`Can't handle extra config type: ${typeof r}`)})},An=s=>{let e=Nn(),t=e.stackSave();try{let n=e.PTR_SIZE,i=e.stackAlloc(2*n);e._OrtGetLastError(i,i+n);let r=Number(e.getValue(i,n===4?"i32":"i64")),o=e.getValue(i+n,"*"),a=o?e.UTF8ToString(o):"";throw new Error(`${s} ERROR_CODE: ${r}, ERROR_MESSAGE: ${a}`)}finally{e.stackRestore(t)}}}),I4,one=Ze(()=>{"use strict";nh(),s1(),I4=s=>{let e=Nn(),t=0,n=[],i=s||{};try{if(s?.logSeverityLevel===void 0)i.logSeverityLevel=2;else if(typeof s.logSeverityLevel!="number"||!Number.isInteger(s.logSeverityLevel)||s.logSeverityLevel<0||s.logSeverityLevel>4)throw new Error(`log serverity level is not valid: ${s.logSeverityLevel}`);if(s?.logVerbosityLevel===void 0)i.logVerbosityLevel=0;else if(typeof s.logVerbosityLevel!="number"||!Number.isInteger(s.logVerbosityLevel))throw new Error(`log verbosity level is not valid: ${s.logVerbosityLevel}`);s?.terminate===void 0&&(i.terminate=!1);let r=0;return s?.tag!==void 0&&(r=Do(s.tag,n)),t=e._OrtCreateRunOptions(i.logSeverityLevel,i.logVerbosityLevel,!!i.terminate,r),t===0&&An("Can't create run options."),s?.extra!==void 0&&j0(s.extra,"",new WeakSet,(o,a)=>{let l=Do(o,n),c=Do(a,n);e._OrtAddRunConfigEntry(t,l,c)!==0&&An(`Can't set a run config entry: ${o} - ${a}.`)}),[t,n]}catch(r){throw t!==0&&e._OrtReleaseRunOptions(t),n.forEach(o=>e._free(o)),r}}}),NG,OG,$G,Ky,BG,D4,ane=Ze(()=>{"use strict";nh(),s1(),NG=s=>{switch(s){case"disabled":return 0;case"basic":return 1;case"extended":return 2;case"all":return 99;default:throw new Error(`unsupported graph optimization level: ${s}`)}},OG=s=>{switch(s){case"sequential":return 0;case"parallel":return 1;default:throw new Error(`unsupported execution mode: ${s}`)}},$G=s=>{s.extra||(s.extra={}),s.extra.session||(s.extra.session={});let e=s.extra.session;e.use_ort_model_bytes_directly||(e.use_ort_model_bytes_directly="1"),s.executionProviders&&s.executionProviders.some(t=>(typeof t=="string"?t:t.name)==="webgpu")&&(s.enableMemPattern=!1)},Ky=(s,e,t,n)=>{let i=Do(e,n),r=Do(t,n);Nn()._OrtAddSessionConfigEntry(s,i,r)!==0&&An(`Can't set a session config entry: ${e} - ${t}.`)},BG=async(s,e,t)=>{for(let n of e){let i=typeof n=="string"?n:n.name,r=[];switch(i){case"webnn":if(i="WEBNN",typeof n!="string"){let d=n?.deviceType;d&&Ky(s,"deviceType",d,t)}break;case"webgpu":if(i="JS",typeof n!="string"){let d=n;if(d?.preferredLayout){if(d.preferredLayout!=="NCHW"&&d.preferredLayout!=="NHWC")throw new Error(`preferredLayout must be either 'NCHW' or 'NHWC': ${d.preferredLayout}`);Ky(s,"preferredLayout",d.preferredLayout,t)}}break;case"wasm":case"cpu":continue;default:throw new Error(`not supported execution provider: ${i}`)}let o=Do(i,t),a=r.length,l=0,c=0;if(a>0){l=Nn()._malloc(a*Nn().PTR_SIZE),t.push(l),c=Nn()._malloc(a*Nn().PTR_SIZE),t.push(c);for(let d=0;d<a;d++)Nn().setValue(l+d*Nn().PTR_SIZE,r[d][0],"*"),Nn().setValue(c+d*Nn().PTR_SIZE,r[d][1],"*")}await Nn()._OrtAppendExecutionProvider(s,o,l,c,a)!==0&&An(`Can't append execution provider: ${i}.`)}},D4=async s=>{let e=Nn(),t=0,n=[],i=s||{};$G(i);try{let r=NG(i.graphOptimizationLevel??"all"),o=OG(i.executionMode??"sequential"),a=typeof i.logId=="string"?Do(i.logId,n):0,l=i.logSeverityLevel??2;if(!Number.isInteger(l)||l<0||l>4)throw new Error(`log serverity level is not valid: ${l}`);let c=i.logVerbosityLevel??0;if(!Number.isInteger(c)||c<0||c>4)throw new Error(`log verbosity level is not valid: ${c}`);let d=typeof i.optimizedModelFilePath=="string"?Do(i.optimizedModelFilePath,n):0;if(t=e._OrtCreateSessionOptions(r,!!i.enableCpuMemArena,!!i.enableMemPattern,o,!!i.enableProfiling,0,a,l,c,d),t===0&&An("Can't create session options."),i.executionProviders&&await BG(t,i.executionProviders,n),i.enableGraphCapture!==void 0){if(typeof i.enableGraphCapture!="boolean")throw new Error(`enableGraphCapture must be a boolean value: ${i.enableGraphCapture}`);Ky(t,"enableGraphCapture",i.enableGraphCapture.toString(),n)}if(i.freeDimensionOverrides)for(let[u,h]of Object.entries(i.freeDimensionOverrides)){if(typeof u!="string")throw new Error(`free dimension override name must be a string: ${u}`);if(typeof h!="number"||!Number.isInteger(h)||h<0)throw new Error(`free dimension override value must be a non-negative integer: ${h}`);let p=Do(u,n);e._OrtAddFreeDimensionOverride(t,p,h)!==0&&An(`Can't set a free dimension override: ${u} - ${h}.`)}return i.extra!==void 0&&j0(i.extra,"",new WeakSet,(u,h)=>{Ky(t,u,h,n)}),[t,n]}catch(r){throw t!==0&&e._OrtReleaseSessionOptions(t)!==0&&An("Can't release session options."),n.forEach(o=>e._free(o)),r}}}),Wf,El,Qu,i1,q0,r1,o1,ND,$t=Ze(()=>{"use strict";Wf=s=>{switch(s){case"int8":return 3;case"uint8":return 2;case"bool":return 9;case"int16":return 5;case"uint16":return 4;case"int32":return 6;case"uint32":return 12;case"float16":return 10;case"float32":return 1;case"float64":return 11;case"string":return 8;case"int64":return 7;case"uint64":return 13;case"int4":return 22;case"uint4":return 21;default:throw new Error(`unsupported data type: ${s}`)}},El=s=>{switch(s){case 3:return"int8";case 2:return"uint8";case 9:return"bool";case 5:return"int16";case 4:return"uint16";case 6:return"int32";case 12:return"uint32";case 10:return"float16";case 1:return"float32";case 11:return"float64";case 8:return"string";case 7:return"int64";case 13:return"uint64";case 22:return"int4";case 21:return"uint4";default:throw new Error(`unsupported data type: ${s}`)}},Qu=(s,e)=>{let t=[-1,4,1,1,2,2,4,8,-1,1,2,8,4,8,-1,-1,-1,-1,-1,-1,-1,.5,.5][s],n=typeof e=="number"?e:e.reduce((i,r)=>i*r,1);return t>0?Math.ceil(n*t):void 0},i1=s=>{switch(s){case"float16":return typeof Float16Array<"u"&&Float16Array.from?Float16Array:Uint16Array;case"float32":return Float32Array;case"uint8":return Uint8Array;case"int8":return Int8Array;case"uint16":return Uint16Array;case"int16":return Int16Array;case"int32":return Int32Array;case"bool":return Uint8Array;case"float64":return Float64Array;case"uint32":return Uint32Array;case"int64":return BigInt64Array;case"uint64":return BigUint64Array;default:throw new Error(`unsupported type: ${s}`)}},q0=s=>{switch(s){case"verbose":return 0;case"info":return 1;case"warning":return 2;case"error":return 3;case"fatal":return 4;default:throw new Error(`unsupported logging level: ${s}`)}},r1=s=>s==="float32"||s==="float16"||s==="int32"||s==="int64"||s==="uint32"||s==="uint8"||s==="bool"||s==="uint4"||s==="int4",o1=s=>s==="float32"||s==="float16"||s==="int32"||s==="int64"||s==="uint32"||s==="uint64"||s==="int8"||s==="uint8"||s==="bool"||s==="uint4"||s==="int4",ND=s=>{switch(s){case"none":return 0;case"cpu":return 1;case"cpu-pinned":return 2;case"texture":return 3;case"gpu-buffer":return 4;case"ml-tensor":return 5;default:throw new Error(`unsupported data location: ${s}`)}}}),a1,R4=Ze(()=>{"use strict";e1(),a1=async s=>{if(typeof s=="string")if(0)try{}catch(e){}else{let e=await fetch(s);if(!e.ok)throw new Error(`failed to load external data file: ${s}`);let t=e.headers.get("Content-Length"),n=t?parseInt(t,10):0;if(n<1073741824)return new Uint8Array(await e.arrayBuffer());{if(!e.body)throw new Error(`failed to load external data file: ${s}, no response body.`);let i=e.body.getReader(),r;try{r=new ArrayBuffer(n)}catch(a){if(a instanceof RangeError){let l=Math.ceil(n/65536);r=new WebAssembly.Memory({initial:l,maximum:l}).buffer}else throw a}let o=0;for(;;){let{done:a,value:l}=await i.read();if(a)break;let c=l.byteLength;new Uint8Array(r,o,c).set(l),o+=c}return new Uint8Array(r,0,n)}}else return s instanceof Blob?new Uint8Array(await s.arrayBuffer()):s instanceof Uint8Array?s:new Uint8Array(s)}}),zG,UG,VG,GG,l1,WG,dn,xl=Ze(()=>{"use strict";$t(),zG=["V","I","W","E","F"],UG=(s,e)=>{console.log(`[${zG[s]},${new Date().toISOString()}]${e}`)},l1=(s,e)=>{VG=s,GG=e},WG=(s,e)=>{let t=q0(s),n=q0(VG);t>=n&&UG(t,typeof e=="function"?e():e)},dn=(...s)=>{GG&&WG(...s)}}),HG,jf,Ie,K0,F4,L4,N4,Ht=Ze(()=>{"use strict";HG=class{static calcMatMulShape(s,e){return s[1]!==e[0]?void 0:[s[0],e[1]]}},jf=class{static calcShape(s,e,t=!1){let n=s.length,i=e.length;if(n===0)return e;if(i===0)return s;let r=Math.max(s.length,e.length),o=new Array(r);if(t){if(n<2||i<2)return;let a=HG.calcMatMulShape([s[n-2],s[n-1]],[e[i-2],e[i-1]]);if(a===void 0)return;[o[r-2],o[r-1]]=a}for(let a=t?3:1;a<=r;a++){let l=n-a<0?1:s[n-a],c=i-a<0?1:e[i-a];if(l!==c&&l>1&&c>1)return;let d=Math.max(l,c);if(l&&c)o[r-a]=Math.max(l,c);else{if(d>1)return;o[r-a]=0}}return o}static isValidBroadcast(s,e){let t=s.length,n=e.length;if(t>n)return!1;for(let i=1;i<=t;i++)if(s[t-i]!==1&&s[t-i]!==e[n-i])return!1;return!0}},Ie=class W0{static size(e){return W0.getSizeFromDimensionRange(e,0,e.length)}static convertShape(e,t=4){let n=e.length;if(n===0)return[];let i=new Array(n),r=n-1;for(;r>=0;){if(e[r]%t===0){i[r]=e[r]/t;break}if(t%e[r]!==0)throw new Error("cannot convert shape");i[r]=1,t/=e[r],r--}for(r--;r>=0;r--)i[r]=e[r];return i}static sizeFromDimension(e,t){if(t<0||t>e.length)throw new Error(`invalid dimension of ${t} for sizeFromDimension as Tensor has ${e.length} dimensions.`);return W0.getSizeFromDimensionRange(e,t,e.length)}static sizeToDimension(e,t){if(t<0||t>e.length)throw new Error(`invalid dimension of ${t} for sizeToDimension as Tensor has ${e.length} dimensions.`);return W0.getSizeFromDimensionRange(e,0,t)}static getSizeFromDimensionRange(e,t,n){let i=1;for(let r=t;r<n;r++){if(e[r]<0)throw new Error("cannot get valid size from specified dimension range. Most likely the range contains negative values in them.");i*=Number(e[r])}return i}static computeStrides(e){let t=e.length;if(t===0)return[];if(t===1)return[1];let n=new Array(t);n[t-1]=1,n[t-2]=e[t-1];for(let i=t-3;i>=0;--i)n[i]=n[i+1]*e[i+1];return n}static normalizeAxis(e,t){if(e<-t&&e>=t)throw new Error("unsupported axis for this operation.");return e<0?e+t:e}static normalizeAxes(e,t){return e.map(n=>this.normalizeAxis(n,t??e.length))}static sortBasedOnPerm(e,t){return t?t.map(n=>e[n]):e.slice().reverse()}static padShape(e,t){let n=e.length;return e.map((i,r)=>i+t[r]+t[r+n])}static areEqual(e,t){return e.length!==t.length?!1:e.every((n,i)=>n===t[i])}},K0=class sv{static adjustPoolAttributes(e,t,n,i,r,o){if(!e&&n.length!==t.length-2)throw new Error("length of specified kernel shapes should be 2 less than length of input dimensions");if(e)for(let a=0;a<t.length-2;a++)a>=n.length?n.push(t[a+2]):n[a]=t[a+2];for(let a=0;a<n.length;a++)if(a<i.length){if(i[a]<0)throw new Error("strides should be greater than or equal to 1")}else i.push(1);for(let a=0;a<n.length;a++)if(a<r.length){if(r[a]<0)throw new Error("dilations should be greater than or equal to 1")}else r.push(1);for(let a=0;a<n.length*2;a++)if(a<o.length){if(o[a]<0)throw new Error("pad should be greater than or equal to 1")}else o.push(0);for(let a=0;a<n.length;a++){if(n[a]<=0)throw new Error("kernel shapes need to be greater than 0");if(o[a]>=n[a]||o[a+n.length]>=n[a])throw new Error("pads should be smaller than kernel")}}static adjustPadsBasedOnAutoPad(e,t,n,i,r,o,a){if(a){if(r.length!==2*(e.length-2))throw new Error("length of pads should be twice the length of data dimensions");if(t.length!==e.length-2)throw new Error("length of strides should be the length of data dimensions");if(i.length!==e.length-2)throw new Error("length of kernel shapes should be the length of data dimensions");for(let l=0;l<e.length-2;l++)sv.adjustPadAndReturnShape(e[l+(o?1:2)],t[l],n[l],i[l],r,l,l+e.length-2,a)}}static computePoolOutputShape(e,t,n,i,r,o,a){if(t.length<=0)throw new Error("input shape must be of size greater than 0");let l=[t[0],t[1]];return sv.computeShapeHelper(e,t,l,n,i,r,o,a),l}static computeConvOutputShape(e,t,n,i,r,o,a){if(e.length<=0||t.length<=0)throw new Error("invalid input tensor dims or invalid filter tensor dims");let l=[e[0],t[0]];return sv.computeShapeHelper(!1,e,l,n,i,r,o,a),l}static computeShapeHelper(e,t,n,i,r,o,a,l){if(e)for(let c=0;c<t.length-2;c++)n.push(1);else for(let c=0;c<t.length-2;c++)n.push(sv.adjustPadAndReturnShape(t[c+2],i[c],r[c],o[c],a,c,c+t.length-2,l))}static adjustPadAndReturnShape(e,t,n,i,r,o,a,l){let c=n*(i-1)+1;if(l&&l!=="NOTSET")switch(l){case"VALID":return r[o]=0,r[a]=0,Math.floor((e-c)/t+1);case"SAME_LOWER":case"SAME_UPPER":if(n!==1)throw new Error("Dilation not supported for SAME_UPPER or SAME_LOWER");{let d=((e+t-1)/t-1)*t+i-e;return r[o]=Math.floor(l==="SAME_LOWER"?(d+1)/2:d/2),r[a]=d-r[o],Math.floor((e+d-i)/t+1)}default:throw new Error("Unsupported AutoPad type")}else return Math.floor((e+r[o]+r[a]-c)/t+1)}},F4=class{static getShapeOfGemmResult(s,e,t,n,i){if(s.length!==2||t.length!==2)throw new Error("shape need to be of size 2");let r,o,a;e?(r=s[1],o=s[0]):(r=s[0],o=s[1]);let l=-1;if(n?(a=t[0],l=1):(a=t[1],l=0),t[l]!==o)throw new Error("dimension mismatch");if(r<=0||a<=0||o<=0)throw new Error("invalid shape specified");if(i&&!jf.isValidBroadcast(i,[r,a]))throw new Error("gemm: invalid bias shape for broadcast");return[r,a,o]}},L4=-34028234663852886e22,N4=34028234663852886e22}),c1,O4=Ze(()=>{"use strict";$t(),c1=(s,e)=>new(i1(e))(s)}),OD,YI,jG,XI,qG,QI,JI,ZI,KG,$4,lne=Ze(()=>{"use strict";xl(),OD=(s,e=!0)=>{if(s.byteLength%8!==0)throw new Error("Invalid Uint8Array length - must be a multiple of 8 (BigInt).");let t=s.byteLength/8,n=new BigInt64Array(s.buffer,s.byteOffset,t),i=new Int32Array(t);for(let r=0;r<t;r++){let o=n[r];if(o>2147483647n||o<-2147483648n)throw new Error(`Overflow occurred when converting BigInt to Int32 at index ${r}: ${o}`);i[r]=Number(o)}return e?new Uint8Array(i.buffer):i},YI=(s,e=!0)=>{if(s.byteLength%4!==0)throw new Error("Invalid Uint8Array length - must be a multiple of 4 (Int32).");let t=s.byteLength/4,n=new Int32Array(s.buffer,s.byteOffset,t),i=BigInt64Array.from(n,BigInt);return e?new Uint8Array(i.buffer):i},jG=1,XI=()=>jG++,qG=new Map([["float32",32],["float16",16],["int32",32],["uint32",32],["int64",64],["uint64",64],["int8",8],["uint8",8],["int4",4],["uint4",4]]),QI=(s,e)=>{let t=qG.get(s);if(!t)throw new Error("Unsupported data type.");return e.length>0?Math.ceil(e.reduce((n,i)=>n*i)*t/8):0},JI=class{constructor(s){this.shouldConvertInt64toInt32=!1,this.isInt64ToInt32Converted=!1;let{sessionId:e,context:t,tensor:n,dataType:i,shape:r,shouldConvertInt64toInt32:o=!1}=s;this.sessionId=e,this.mlContext=t,this.mlTensor=n,this.dataType=i,this.tensorShape=r,this.shouldConvertInt64toInt32=o}get tensor(){return this.mlTensor}get type(){return this.dataType}get shape(){return this.tensorShape}get byteLength(){return QI(this.dataType,this.tensorShape)}destroy(){dn("verbose",()=>"[WebNN] TensorWrapper.destroy"),this.mlTensor.destroy()}write(s){this.mlContext.writeTensor(this.mlTensor,s)}async read(s,e){if(s){let t=await this.mlContext.readTensor(this.mlTensor),n=YI(new Uint8Array(t));if(e){(e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength)).set(n);return}else return n.buffer}else return e?this.mlContext.readTensor(this.mlTensor,e):this.mlContext.readTensor(this.mlTensor)}canReuseTensor(s,e,t){return this.mlContext===s&&this.dataType===e&&this.tensorShape.length===t.length&&this.tensorShape.every((n,i)=>n===t[i])}setIsInt64ToInt32Converted(s){this.isInt64ToInt32Converted=s}},ZI=class{constructor(s,e){this.tensorManager=s,this.wrapper=e}get tensorWrapper(){return this.wrapper}releaseTensor(){this.tensorWrapper&&(this.tensorManager.releaseTensor(this.tensorWrapper),this.wrapper=void 0)}async ensureTensor(s,e,t,n){let i=e,r=this.tensorManager.getMLContext(s),o=i==="int64"&&!r.opSupportLimits().input.dataTypes.includes("int64");if(o&&(i="int32",dn("verbose",()=>"[WebNN] TensorIdTracker.ensureTensor: convert dataType from int64 to int32")),this.wrapper){if(this.wrapper.canReuseTensor(r,i,t))return this.wrapper.tensor;if(n){if(this.wrapper.byteLength!==QI(i,t))throw new Error("Unable to copy data to tensor with different size.");this.activeUpload=new Uint8Array(await this.wrapper.read())}this.tensorManager.releaseTensor(this.wrapper)}let a=typeof MLTensorUsage>"u"?void 0:MLTensorUsage.READ|MLTensorUsage.WRITE;return this.wrapper=await this.tensorManager.getCachedTensor(s,i,t,a,!0,!0,o),n&&this.activeUpload&&(this.wrapper.write(this.activeUpload),this.activeUpload=void 0),this.wrapper.tensor}upload(s){let e=s;if(this.wrapper)if(this.wrapper.shouldConvertInt64toInt32&&(e=OD(s,!0),this.wrapper.setIsInt64ToInt32Converted(!0)),e.byteLength===this.wrapper.byteLength){this.wrapper.write(e);return}else dn("verbose",()=>"Data size does not match tensor size. Releasing tensor."),this.releaseTensor();this.activeUpload?this.activeUpload.set(e):this.activeUpload=new Uint8Array(e)}async download(s){if(this.activeUpload){let e=this.wrapper?.isInt64ToInt32Converted?YI(this.activeUpload):this.activeUpload;if(s){s instanceof ArrayBuffer?new Uint8Array(s).set(e):new Uint8Array(s.buffer,s.byteOffset,s.byteLength).set(e);return}else return e.buffer}if(!this.wrapper)throw new Error("Tensor has not been created.");return s?this.wrapper.read(this.wrapper?.shouldConvertInt64toInt32,s):this.wrapper.read(this.wrapper?.shouldConvertInt64toInt32)}},KG=class{constructor(s){this.backend=s,this.tensorTrackersById=new Map,this.freeTensors=[],this.externalTensors=new Set}getMLContext(s){let e=this.backend.getMLContext(s);if(!e)throw new Error("MLContext not found for session.");return e}reserveTensorId(){let s=XI();return this.tensorTrackersById.set(s,new ZI(this)),s}releaseTensorId(s){let e=this.tensorTrackersById.get(s);e&&(this.tensorTrackersById.delete(s),e.tensorWrapper&&this.releaseTensor(e.tensorWrapper))}async ensureTensor(s,e,t,n,i){dn("verbose",()=>`[WebNN] TensorManager.ensureTensor {tensorId: ${e}, dataType: ${t}, shape: ${n}, copyOld: ${i}}`);let r=this.tensorTrackersById.get(e);if(!r)throw new Error("Tensor not found.");return r.ensureTensor(s,t,n,i)}upload(s,e){let t=this.tensorTrackersById.get(s);if(!t)throw new Error("Tensor not found.");t.upload(e)}async download(s,e){dn("verbose",()=>`[WebNN] TensorManager.download {tensorId: ${s}, dstBuffer: ${e?.byteLength}}`);let t=this.tensorTrackersById.get(s);if(!t)throw new Error("Tensor not found.");return t.download(e)}releaseTensorsForSession(s){for(let e of this.freeTensors)e.sessionId===s&&e.destroy();this.freeTensors=this.freeTensors.filter(e=>e.sessionId!==s)}registerTensor(s,e,t,n){let i=this.getMLContext(s),r=XI(),o=new JI({sessionId:s,context:i,tensor:e,dataType:t,shape:n});return this.tensorTrackersById.set(r,new ZI(this,o)),this.externalTensors.add(o),r}async getCachedTensor(s,e,t,n,i,r,o=!1){let a=this.getMLContext(s);for(let[c,d]of this.freeTensors.entries())if(d.canReuseTensor(a,e,t)){dn("verbose",()=>`[WebNN] Reusing tensor {dataType: ${e}, shape: ${t}}`);let u=this.freeTensors.splice(c,1)[0];return u.sessionId=s,u}dn("verbose",()=>`[WebNN] MLContext.createTensor {dataType: ${e}, shape: ${t}}`);let l=await a.createTensor({dataType:e,shape:t,dimensions:t,usage:n,writable:i,readable:r});return new JI({sessionId:s,context:a,tensor:l,dataType:e,shape:t,shouldConvertInt64toInt32:o})}releaseTensor(s){this.externalTensors.has(s)&&this.externalTensors.delete(s),this.freeTensors.push(s)}},$4=(...s)=>new KG(...s)}),R0,YG,B4,cne=Ze(()=>{"use strict";$t(),nh(),O4(),lne(),xl(),R0=new Map([[1,"float32"],[10,"float16"],[6,"int32"],[12,"uint32"],[7,"int64"],[13,"uint64"],[22,"int4"],[21,"uint4"],[3,"int8"],[2,"uint8"],[9,"uint8"]]),YG=(s,e)=>{if(s===e)return!0;if(s===void 0||e===void 0)return!1;let t=Object.keys(s).sort(),n=Object.keys(e).sort();return t.length===n.length&&t.every((i,r)=>i===n[r]&&s[i]===e[i])},B4=class{constructor(s){this.tensorManager=$4(this),this.mlContextBySessionId=new Map,this.sessionIdsByMLContext=new Map,this.mlContextCache=[],this.sessionGraphInputs=new Map,this.temporaryGraphInputs=[],this.temporarySessionTensorIds=new Map,l1(s.logLevel,!!s.debug)}get currentSessionId(){if(this.activeSessionId===void 0)throw new Error("No active session");return this.activeSessionId}onRunStart(s){dn("verbose",()=>`[WebNN] onRunStart {sessionId: ${s}}`),this.activeSessionId=s}onRunEnd(s){dn("verbose",()=>`[WebNN] onRunEnd {sessionId: ${s}}`);let e=this.temporarySessionTensorIds.get(s);if(e){for(let t of e)dn("verbose",()=>`[WebNN] releasing temporary tensor {tensorId: ${t}}`),this.tensorManager.releaseTensorId(t);this.temporarySessionTensorIds.delete(s),this.activeSessionId=void 0}}async createMLContext(s){if(s instanceof GPUDevice){let t=this.mlContextCache.findIndex(n=>n.gpuDevice===s);if(t!==-1)return this.mlContextCache[t].mlContext;{let n=await navigator.ml.createContext(s);return this.mlContextCache.push({gpuDevice:s,mlContext:n}),n}}else if(s===void 0){let t=this.mlContextCache.findIndex(n=>n.options===void 0&&n.gpuDevice===void 0);if(t!==-1)return this.mlContextCache[t].mlContext;{let n=await navigator.ml.createContext();return this.mlContextCache.push({mlContext:n}),n}}let e=this.mlContextCache.findIndex(t=>YG(t.options,s));if(e!==-1)return this.mlContextCache[e].mlContext;{let t=await navigator.ml.createContext(s);return this.mlContextCache.push({options:s,mlContext:t}),t}}registerMLContext(s,e){this.mlContextBySessionId.set(s,e);let t=this.sessionIdsByMLContext.get(e);t||(t=new Set,this.sessionIdsByMLContext.set(e,t)),t.add(s),this.temporaryGraphInputs.length>0&&(this.sessionGraphInputs.set(s,this.temporaryGraphInputs),this.temporaryGraphInputs=[])}onReleaseSession(s){this.sessionGraphInputs.delete(s);let e=this.mlContextBySessionId.get(s);if(!e)return;this.tensorManager.releaseTensorsForSession(s),this.mlContextBySessionId.delete(s);let t=this.sessionIdsByMLContext.get(e);if(t.delete(s),t.size===0){this.sessionIdsByMLContext.delete(e);let n=this.mlContextCache.findIndex(i=>i.mlContext===e);n!==-1&&this.mlContextCache.splice(n,1)}}getMLContext(s){return this.mlContextBySessionId.get(s)}reserveTensorId(){return this.tensorManager.reserveTensorId()}releaseTensorId(s){dn("verbose",()=>`[WebNN] releaseTensorId {tensorId: ${s}}`),this.tensorManager.releaseTensorId(s)}async ensureTensor(s,e,t,n,i){let r=R0.get(t);if(!r)throw new Error(`Unsupported ONNX data type: ${t}`);return this.tensorManager.ensureTensor(s??this.currentSessionId,e,r,n,i)}async createTemporaryTensor(s,e,t){dn("verbose",()=>`[WebNN] createTemporaryTensor {onnxDataType: ${e}, shape: ${t}}`);let n=R0.get(e);if(!n)throw new Error(`Unsupported ONNX data type: ${e}`);let i=this.tensorManager.reserveTensorId();await this.tensorManager.ensureTensor(s,i,n,t,!1);let r=this.temporarySessionTensorIds.get(s);return r?r.push(i):this.temporarySessionTensorIds.set(s,[i]),i}uploadTensor(s,e){if(!Nn().shouldTransferToMLTensor)throw new Error("Trying to upload to a MLTensor while shouldTransferToMLTensor is false");dn("verbose",()=>`[WebNN] uploadTensor {tensorId: ${s}, data: ${e.byteLength}}`),this.tensorManager.upload(s,e)}async downloadTensor(s,e){return this.tensorManager.download(s,e)}createMLTensorDownloader(s,e){return async()=>{let t=await this.tensorManager.download(s);return c1(t,e)}}registerMLTensor(s,e,t,n){let i=R0.get(t);if(!i)throw new Error(`Unsupported ONNX data type: ${t}`);let r=this.tensorManager.registerTensor(s,e,i,n);return dn("verbose",()=>`[WebNN] registerMLTensor {tensor: ${e}, dataType: ${i}, dimensions: ${n}} -> {tensorId: ${r}}`),r}registerMLConstant(s,e,t,n,i,r,o=!1){if(!r)throw new Error("External mounted files are not available.");let a=s;s.startsWith("./")&&(a=s.substring(2));let l=r.get(a);if(!l)throw new Error(`File with name ${a} not found in preloaded files.`);if(e+t>l.byteLength)throw new Error("Out of bounds: data offset and length exceed the external file data size.");let c=l.slice(e,e+t).buffer,d;switch(i.dataType){case"float32":d=new Float32Array(c);break;case"float16":d=typeof Float16Array<"u"&&Float16Array.from?new Float16Array(c):new Uint16Array(c);break;case"int32":d=new Int32Array(c);break;case"uint32":d=new Uint32Array(c);break;case"int64":o?(d=OD(new Uint8Array(c),!1),i.dataType="int32"):d=new BigInt64Array(c);break;case"uint64":d=new BigUint64Array(c);break;case"int8":d=new Int8Array(c);break;case"int4":case"uint4":case"uint8":d=new Uint8Array(c);break;default:throw new Error(`Unsupported data type: ${i.dataType} in creating WebNN Constant from external data.`)}return dn("verbose",()=>`[WebNN] registerMLConstant {dataType: ${i.dataType}, shape: ${i.shape}}} ${o?"(Note: it was int64 data type and registered to int32 as workaround)":""}`),n.constant(i,d)}registerGraphInput(s){this.temporaryGraphInputs.push(s)}isGraphInput(s,e){let t=this.sessionGraphInputs.get(s);return t?t.includes(e):!1}isInt64Supported(s){return!!this.mlContextBySessionId.get(s)?.opSupportLimits().input.dataTypes.includes("int64")}flush(){}}}),d1=Ze(()=>{"use strict"}),eD,F0,L0,XG,QG,tD,$D,JG,z4,dne=Ze(()=>{"use strict";xl(),d1(),eD=new Map([[64,250],[128,200],[256,200],[512,200],[2048,230],[4096,200],[8192,50],[16384,50],[32768,50],[65536,50],[131072,50],[262144,50],[524288,50],[1048576,50],[2097152,30],[4194304,20],[8388608,10],[12582912,10],[16777216,10],[26214400,15],[33554432,22],[44236800,2],[58982400,6],[67108864,6],[134217728,6],[167772160,6]]),F0=[],L0=s=>Math.ceil(Number(s)/16)*16,XG=s=>{for(let e=0;e<F0.length;e++){let t=F0[e];if(s<=t)return t}return Math.ceil(s/16)*16},QG=1,tD=()=>QG++,$D=async(s,e,t,n)=>{let i=L0(t),r=s.device.createBuffer({size:i,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ});try{let o=s.getCommandEncoder();s.endComputePass(),o.copyBufferToBuffer(e,0,r,0,i),s.flush(),await r.mapAsync(GPUMapMode.READ);let a=r.getMappedRange();if(n){let l=n();return l.set(new Uint8Array(a,0,t)),l}else return new Uint8Array(a.slice(0,t))}finally{r.destroy()}},JG=class{constructor(s){this.backend=s,this.storageCache=new Map,this.freeBuffers=new Map,this.freeUniformBuffers=new Map,this.buffersPending=[],this.capturedPendingBuffers=new Map;for(let[e]of eD)F0.push(e),this.freeBuffers.set(e,[]),this.freeUniformBuffers.set(e,[]);this.sessionCount=0}upload(s,e){let t=e.buffer,n=e.byteOffset,i=e.byteLength,r=L0(i),o=this.storageCache.get(s);if(!o)throw new Error("gpu data for uploading does not exist");if(Number(o.originalSize)!==i)throw new Error(`inconsistent data size. gpu data size=${o.originalSize}, data size=${i}`);let a=this.backend.device.createBuffer({mappedAtCreation:!0,size:r,usage:GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC}),l=a.getMappedRange();new Uint8Array(l).set(new Uint8Array(t,n,i)),a.unmap();let c=this.backend.device.createCommandEncoder();c.copyBufferToBuffer(a,0,o.gpuData.buffer,0,r),this.backend.device.queue.submit([c.finish()]),a.destroy(),dn("verbose",()=>`[WebGPU] GpuDataManager.upload(id=${s})`)}memcpy(s,e){let t=this.storageCache.get(s);if(!t)throw new Error("source gpu data for memcpy does not exist");let n=this.storageCache.get(e);if(!n)throw new Error("destination gpu data for memcpy does not exist");if(t.originalSize!==n.originalSize)throw new Error("inconsistent source and destination gpu data size");let i=L0(t.originalSize),r=this.backend.getCommandEncoder();this.backend.endComputePass(),r.copyBufferToBuffer(t.gpuData.buffer,0,n.gpuData.buffer,0,i)}registerExternalBuffer(s,e,t){let n;if(t){if(n=t[0],s===t[1])return dn("verbose",()=>`[WebGPU] GpuDataManager.registerExternalBuffer(size=${e}) => id=${n}, buffer is the same, skip.`),n;if(this.backend.capturedCommandList.has(this.backend.currentSessionId))throw new Error(`Registering a different external buffer under graph capture mode is not supported yet.
             Please use the previous external buffer!`)}else n=tD();return this.storageCache.set(n,{gpuData:{id:n,type:0,buffer:s},originalSize:e}),dn("verbose",()=>`[WebGPU] GpuDataManager.registerExternalBuffer(size=${e}) => id=${n}, registered.`),n}unregisterExternalBuffer(s){s!==void 0&&(this.storageCache.delete(s),dn("verbose",()=>`[WebGPU] GpuDataManager.unregisterExternalBuffer() => id=${s}`))}create(s,e=GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST){let t=XG(s),n,i=(e&GPUBufferUsage.STORAGE)===GPUBufferUsage.STORAGE,r=(e&GPUBufferUsage.UNIFORM)===GPUBufferUsage.UNIFORM;if(i||r){let a=(i?this.freeBuffers:this.freeUniformBuffers).get(t);a?a.length>0?n=a.pop():n=this.backend.device.createBuffer({size:t,usage:e}):n=this.backend.device.createBuffer({size:t,usage:e})}else n=this.backend.device.createBuffer({size:t,usage:e});let o={id:tD(),type:0,buffer:n};return this.storageCache.set(o.id,{gpuData:o,originalSize:Number(s)}),dn("verbose",()=>`[WebGPU] GpuDataManager.create(size=${s}) => id=${o.id}`),o}get(s){return this.storageCache.get(s)?.gpuData}release(s){let e=typeof s=="bigint"?Number(s):s,t=this.storageCache.get(e);if(!t){if(this.storageCache.size===0)return 0;throw new Error("releasing data does not exist")}return dn("verbose",()=>`[WebGPU] GpuDataManager.release(id=${e}), gpuDataId=${t.gpuData.id}`),this.storageCache.delete(e),this.buffersPending.push(t.gpuData.buffer),t.originalSize}async download(s,e){let t=this.storageCache.get(Number(s));if(!t)throw new Error("data does not exist");await $D(this.backend,t.gpuData.buffer,t.originalSize,e)}refreshPendingBuffers(){if(this.buffersPending.length!==0)if(this.backend.sessionStatus==="default"){for(let s of this.buffersPending){let e=eD.get(s.size);if((s.usage&GPUBufferUsage.STORAGE)===GPUBufferUsage.STORAGE){let t=this.freeBuffers.get(s.size)||[];e===void 0||t.length>=e?s.destroy():t.push(s)}else if((s.usage&GPUBufferUsage.UNIFORM)===GPUBufferUsage.UNIFORM){let t=this.freeUniformBuffers.get(s.size)||[];e===void 0||t.length>=e?s.destroy():t.push(s)}else s.destroy()}this.buffersPending=[]}else{let s=this.capturedPendingBuffers.get(this.backend.currentSessionId);s||(s=[],this.capturedPendingBuffers.set(this.backend.currentSessionId,s));for(let e of this.buffersPending)s.push(e);this.buffersPending=[]}}dispose(){this.freeBuffers.forEach(s=>{s.forEach(e=>{e.destroy()})}),this.freeUniformBuffers.forEach(s=>{s.forEach(e=>{e.destroy()})}),this.storageCache.forEach(s=>{s.gpuData.buffer.destroy()}),this.capturedPendingBuffers.forEach(s=>{s.forEach(e=>{e.destroy()})}),this.storageCache=new Map,this.freeBuffers=new Map,this.freeUniformBuffers=new Map,this.capturedPendingBuffers=new Map}onCreateSession(){this.sessionCount+=1}onReleaseSession(s){let e=this.capturedPendingBuffers.get(s);e&&(e.forEach(t=>{t.destroy()}),this.capturedPendingBuffers.delete(s)),this.sessionCount-=1,this.sessionCount===0&&(dn("warning",()=>"[WebGPU] Clearing webgpu buffer cache"),this.storageCache.forEach(t=>{t.gpuData.buffer.destroy()}),this.storageCache=new Map)}},z4=(...s)=>new JG(...s)}),ZG,Mn,cs=Ze(()=>{"use strict";ZG=class{constructor(s){Object.assign(this,s)}get cacheKey(){return this.key||(this.key=Object.getOwnPropertyNames(this).sort().map(s=>`${this[s]}`).join(";")),this.key}},Mn=s=>new ZG(s)}),qf,N0,Vs,Si,St,es,BD,Hf,Lc,Et,Yy,Ue,bt,U4,u1,eW,V4,qt=Ze(()=>{"use strict";$t(),Ht(),qf=64,N0=(s,e)=>{if(e===3)throw new Error("vec3 has same alignment as vec4, use vec4 instead");switch(Number(s)){case 10:return e>1?`vec${e}<f16>`:"f16";case 1:return e>1?`vec${e}<f32>`:"f32";case 6:return e>1?`vec${e}<i32>`:"i32";case 12:return e>1?`vec${e}<u32>`:"u32";case 7:if(e>1)throw new Error("currently not supported vecX of uint64 yet");return["vec2<u32>","i32"];case 13:if(e>1)throw new Error("currently not supported vecX of uint64 yet");return["vec2<u32>","u32"];case 9:if(e!==4)throw new Error("bool must be vec4");return["u32","vec4<bool>"];case 22:return"i32";case 21:return"u32";default:throw new Error(`Unknown data type: ${s}`)}},Vs=(s,e=1)=>{let t=N0(s,e);return typeof t=="string"?t:t[0]},Si=(s,e=1)=>{let t=N0(s,e);return typeof t=="string"?t:t[1]},St=(...s)=>{let e=[];return s.forEach(t=>{t.length!==0&&e.push({type:12,data:t},{type:12,data:Ie.computeStrides(t)})}),e},es=s=>s%4===0?4:s%2===0?2:1,BD=(s="f32",e,t="0")=>!e||e===1?`${s}(${t})`:`vec${e}<${s}>(${t})`,Hf=(s,e,t)=>s==="f32"?t:e===1?`f32(${t})`:`vec${e}<f32>(${t})`,Lc=(s,e)=>e===4?`(${s}.x + ${s}.y + ${s}.z + ${s}.w)`:e===2?`(${s}.x + ${s}.y)`:e===3?`(${s}.x + ${s}.y + ${s}.z)`:s,Et=(s,e,t,n)=>s.startsWith("uniforms.")&&t>4?typeof e=="string"?n==="f16"?`${s}[(${e}) / 8][(${e}) % 8 / 4][(${e}) % 8 % 4]`:`${s}[(${e}) / 4][(${e}) % 4]`:n==="f16"?`${s}[${Math.floor(e/8)}][${Math.floor(e%8/4)}][${e%8%4}]`:`${s}[${Math.floor(e/4)}][${e%4}]`:t>1?`${s}[${e}]`:s,Yy=(s,e,t,n,i)=>{let r=typeof t=="number",o=r?t:t.length,a=[...new Array(o).keys()],l=o<2?"u32":o<=4?`vec${o}<u32>`:`array<u32, ${o}>`,c=N0(e,i),d=typeof c=="string"?c:c[1],u=typeof c=="string"?c:c[0],h={indices:l,value:d,storage:u,tensor:e},p=oe=>typeof oe=="string"?oe:`${oe}u`,f={offsetToIndices:!1,indicesToOffset:!1,broadcastedIndicesToOffset:!1,set:!1,setByIndices:!1,get:!1,getByIndices:!1},_=r?"uniforms.":"",b=`${_}${s}_shape`,y=`${_}${s}_strides`,w="";for(let oe=0;oe<o-1;oe++)w+=`
    let dim${oe} = current / ${Et(y,oe,o)};
    let rest${oe} = current % ${Et(y,oe,o)};
    indices[${oe}] = dim${oe};
    current = rest${oe};
    `;w+=`indices[${o-1}] = current;`;let C=o<2?"":`
  fn o2i_${s}(offset: u32) -> ${h.indices} {
    var indices: ${h.indices};
    var current = offset;
    ${w}
    return indices;
  }`,M=oe=>(f.offsetToIndices=!0,o<2?oe:`o2i_${s}(${oe})`),S=[];if(o>=2)for(let oe=o-1;oe>=0;oe--)S.push(`${Et(y,oe,o)} * (indices[${oe}])`);let k=o<2?"":`
  fn i2o_${s}(indices: ${h.indices}) -> u32 {
    return ${S.join("+")};
  }`,T=oe=>(f.indicesToOffset=!0,o<2?oe:`i2o_${s}(${oe})`),P=(...oe)=>o===0?"0u":`${h.indices}(${oe.map(p).join(",")})`,R=(oe,te)=>o<2?`${oe}`:`${Et(oe,te,o)}`,O=(oe,te,j)=>o<2?`${oe}=${j};`:`${Et(oe,te,o)}=${j};`,H={},X=(oe,te)=>{f.broadcastedIndicesToOffset=!0;let j=`${te.name}broadcastedIndicesTo${s}Offset`;if(j in H)return`${j}(${oe})`;let G=[];for(let de=o-1;de>=0;de--){let be=te.indicesGet("outputIndices",de+te.rank-o);G.push(`${R(y,de)} * (${be} % ${R(b,de)})`)}return H[j]=`fn ${j}(outputIndices: ${te.type.indices}) -> u32 {
             return ${G.length>0?G.join("+"):"0u"};
           }`,`${j}(${oe})`},z=(oe,te)=>(()=>{if(h.storage===h.value)return`${s}[${oe}]=${te};`;if(h.storage==="vec2<u32>"&&h.value==="i32")return`${s}[${oe}]=vec2<u32>(u32(${te}), select(0u, 0xFFFFFFFFu, ${te} < 0));`;if(h.storage==="vec2<u32>"&&h.value==="u32")return`${s}[${oe}]=vec2<u32>(u32(${te}), 0u);`;if(h.storage==="u32"&&h.value==="vec4<bool>")return`${s}[${oe}]=dot(vec4<u32>(0x1, 0x100, 0x10000, 0x1000000), vec4<u32>(${te}));`;throw new Error(`not supported combination of storage type ${h.storage} and value type ${h.value} yet`)})(),ne=oe=>(()=>{if(h.storage===h.value)return`${s}[${oe}]`;if(h.storage==="vec2<u32>"&&h.value==="i32")return`i32(${s}[${oe}].x)`;if(h.storage==="vec2<u32>"&&h.value==="u32")return`u32(${s}[${oe}].x)`;if(h.storage==="u32"&&h.value==="vec4<bool>")return`vec4<bool>(bool(${s}[${oe}] & 0xFFu), bool(${s}[${oe}] & 0xFF00u), bool(${s}[${oe}] & 0xFF0000u), bool(${s}[${oe}] & 0xFF000000u))`;throw new Error(`not supported combination of storage type ${h.storage} and value type ${h.value} yet`)})(),re=o<2?"":`
  fn get_${s}ByIndices(indices: ${h.indices}) -> ${d} {
    return ${ne(`i2o_${s}(indices)`)};
  }`,Y=o<2?"":(()=>{let oe=a.map(j=>`d${j}: u32`).join(", "),te=a.map(j=>`d${j}`).join(", ");return`
  fn get_${s}(${oe}) -> ${d} {
    return get_${s}ByIndices(${P(te)});
  }`})(),se=(...oe)=>{if(oe.length!==o)throw new Error(`indices length must be ${o}`);let te=oe.map(p).join(",");return o===0?ne("0u"):o===1?ne(te[0]):(f.get=!0,f.getByIndices=!0,f.indicesToOffset=!0,`get_${s}(${te})`)},ue=oe=>o<2?ne(oe):(f.getByIndices=!0,f.indicesToOffset=!0,`get_${s}ByIndices(${oe})`),fe=o<2?"":`
  fn set_${s}ByIndices(indices: ${h.indices}, value: ${d}) {
    ${z(`i2o_${s}(indices)`,"value")}
  }`,Pe=o<2?"":(()=>{let oe=a.map(j=>`d${j}: u32`).join(", "),te=a.map(j=>`d${j}`).join(", ");return`
  fn set_${s}(${oe}, value: ${d}) {
    set_${s}ByIndices(${P(te)}, value);
  }`})();return{impl:()=>{let oe=[],te=!1;return f.offsetToIndices&&(oe.push(C),te=!0),f.indicesToOffset&&(oe.push(k),te=!0),f.broadcastedIndicesToOffset&&(Object.values(H).forEach(j=>oe.push(j)),te=!0),f.set&&(oe.push(Pe),te=!0),f.setByIndices&&(oe.push(fe),te=!0),f.get&&(oe.push(Y),te=!0),f.getByIndices&&(oe.push(re),te=!0),!r&&te&&oe.unshift(`const ${b} = ${h.indices}(${t.join(",")});`,`const ${y} = ${h.indices}(${Ie.computeStrides(t).join(",")});`),oe.join(`
`)},type:h,offsetToIndices:M,indicesToOffset:T,broadcastedIndicesToOffset:X,indices:P,indicesGet:R,indicesSet:O,set:(...oe)=>{if(oe.length!==o+1)throw new Error(`indices length must be ${o}`);let te=oe[o];if(typeof te!="string")throw new Error("value must be string");let j=oe.slice(0,o).map(p).join(",");return o===0?z("0u",te):o===1?z(j[0],te):(f.set=!0,f.setByIndices=!0,f.indicesToOffset=!0,`set_${s}(${j}, ${te})`)},setByOffset:z,setByIndices:(oe,te)=>o<2?z(oe,te):(f.setByIndices=!0,f.indicesToOffset=!0,`set_${s}ByIndices(${oe}, ${te});`),get:se,getByOffset:ne,getByIndices:ue,usage:n,name:s,strides:y,shape:b,rank:o}},Ue=(s,e,t,n=1)=>Yy(s,e,t,"input",n),bt=(s,e,t,n=1)=>Yy(s,e,t,"output",n),U4=(s,e,t)=>Yy(s,e,t,"atomicOutput",1),u1=(s,e,t,n=1)=>Yy(s,e,t,"internal",n),eW=class{constructor(s,e){this.normalizedDispatchGroup=s,this.limits=e,this.internalVariables=[],this.variables=[],this.uniforms=[],this.variableIndex=0}guardAgainstOutOfBoundsWorkgroupSizes(s){return`if (global_idx >= ${typeof s=="number"?`${s}u`:s}) { return; }`}mainStart(s=qf){let e=typeof s=="number"?s:s[0],t=typeof s=="number"?1:s[1],n=typeof s=="number"?1:s[2];if(e>this.limits.maxComputeWorkgroupSizeX||t>this.limits.maxComputeWorkgroupSizeY||n>this.limits.maxComputeWorkgroupSizeZ)throw new Error(`workgroup size [${e}, ${t}, ${n}] exceeds the maximum workgroup size [${this.limits.maxComputeWorkgroupSizeX}, ${this.limits.maxComputeWorkgroupSizeY}, ${this.limits.maxComputeWorkgroupSizeZ}].`);if(e*t*n>this.limits.maxComputeInvocationsPerWorkgroup)throw new Error(`workgroup size [${e}, ${t}, ${n}] exceeds the maximum workgroup invocations ${this.limits.maxComputeInvocationsPerWorkgroup}.`);let i=this.normalizedDispatchGroup[1]===1&&this.normalizedDispatchGroup[2]===1,r=i?`@builtin(global_invocation_id) global_id : vec3<u32>,
    @builtin(workgroup_id) workgroup_id : vec3<u32>,
    @builtin(local_invocation_index) local_idx : u32,
    @builtin(local_invocation_id) local_id : vec3<u32>`:`@builtin(global_invocation_id) global_id : vec3<u32>,
                                             @builtin(local_invocation_id) local_id : vec3<u32>,
    @builtin(local_invocation_index) local_idx : u32,
    @builtin(workgroup_id) workgroup_id : vec3<u32>,
    @builtin(num_workgroups) num_workgroups : vec3<u32>`,o=i?`let global_idx = global_id.x;
         let workgroup_index = workgroup_id.x;`:`let workgroup_index = workgroup_id.z * num_workgroups[0] * num_workgroups[1] +
             workgroup_id.y * num_workgroups[0] + workgroup_id.x;
         let global_idx = workgroup_index * ${e*t*n}u + local_idx;`;return`@compute @workgroup_size(${e}, ${t}, ${n})
  fn main(${r}) {
    ${o}
  `}appendVariableUniforms(s){s.rank!==0&&(s.shape.startsWith("uniforms.")&&this.uniforms.push({name:s.shape.replace("uniforms.",""),type:"u32",length:s.rank}),s.strides.startsWith("uniforms.")&&this.uniforms.push({name:s.strides.replace("uniforms.",""),type:"u32",length:s.rank}))}declareVariable(s,e){if(s.usage==="internal")throw new Error("cannot use internal variable with declareVariable(). use registerInternalVariables() instead.");this.variables.push(s),this.appendVariableUniforms(s);let t=s.usage==="input"?"read":"read_write",n=s.usage==="atomicOutput"?"atomic<i32>":s.type.storage;return`@group(0) @binding(${e}) var<storage, ${t}> ${s.name}: array<${n}>;`}declareVariables(...s){return s.map(e=>this.declareVariable(e,this.variableIndex++)).join(`
`)}registerInternalVariable(s){if(s.usage!=="internal")throw new Error("cannot use input or output variable with registerInternalVariable(). use declareVariables() instead.");this.internalVariables.push(s),this.appendVariableUniforms(s)}registerInternalVariables(...s){return s.forEach(e=>this.registerInternalVariable(e)),this}registerUniform(s,e,t=1){return this.uniforms.push({name:s,type:e,length:t}),this}registerUniforms(s){return this.uniforms=this.uniforms.concat(s),this}uniformDeclaration(){if(this.uniforms.length===0)return"";let s=[];for(let{name:e,type:t,length:n}of this.uniforms)if(n&&n>4)t==="f16"?s.push(`@align(16) ${e}:array<mat2x4<${t}>, ${Math.ceil(n/8)}>`):s.push(`${e}:array<vec4<${t}>, ${Math.ceil(n/4)}>`);else{let i=n==null||n===1?t:`vec${n}<${t}>`;s.push(`${e}:${i}`)}return`
      struct Uniforms { ${s.join(", ")} };
      @group(0) @binding(${this.variableIndex}) var<uniform> uniforms: Uniforms;`}get additionalImplementations(){return this.uniformDeclaration()+this.variables.map(s=>s.impl()).join(`
`)+this.internalVariables.map(s=>s.impl()).join(`
`)}get variablesInfo(){if(this.uniforms.length===0)return;let s=e=>[12,10,1,6][["u32","f16","f32","i32"].indexOf(e)];return this.uniforms.map(e=>[s(e.type),e.length??1])}},V4=(s,e)=>new eW(s,e)}),tW,nD,nW,sW,iW,rW,Er,G4,W4,Nc=Ze(()=>{"use strict";$t(),Ht(),cs(),qt(),tW=(s,e)=>{if(!s||s.length!==1)throw new Error("Transpose requires 1 input.");if(e.length!==0&&e.length!==s[0].dims.length)throw new Error(`perm size ${e.length} does not match input rank ${s[0].dims.length}`)},nD=(s,e)=>e.length!==0?e:[...new Array(s).keys()].reverse(),nW=(s,e)=>Ie.sortBasedOnPerm(s,nD(s.length,e)),sW=(s,e,t,n)=>{let i=`fn perm(i: ${n.type.indices}) -> ${t.type.indices} {
    var a: ${t.type.indices};`;for(let r=0;r<e;++r)i+=`a[${s[r]}]=i[${r}];`;return i+="return a;}"},iW=(s,e)=>{let t=[],n=[];for(let i=0;i<s.length;++i)s[i]!==1&&t.push(s[i]),s[e[i]]!==1&&n.push(e[i]);return{newShape:t,newPerm:n}},rW=(s,e)=>{let t=0;for(let n=0;n<s.length;++n)if(e[s[n]]!==1){if(s[n]<t)return!1;t=s[n]}return!0},Er=(s,e)=>{let t=s.dataType,n=s.dims.length,i=nD(n,e),r=nW(s.dims,i),o=s.dims,a=r,l=n<2||rW(i,s.dims),c;if(l)return c=f=>{let _=Ue("input",t,o,4),b=bt("output",t,a,4);return`
  ${f.registerUniform("output_size","u32").declareVariables(_,b)}
  ${f.mainStart()}
    ${f.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}
    output[global_idx] = input[global_idx];
  }`},{name:"TransposeCopy",shaderCache:{inputDependencies:["type"]},getRunData:()=>{let f=Ie.size(r);return{outputs:[{dims:r,dataType:s.dataType}],dispatchGroup:{x:Math.ceil(f/64/4)},programUniforms:[{type:12,data:Math.ceil(f/4)}]}},getShaderSource:c};let{newShape:d,newPerm:u}=iW(s.dims,i),h=Ie.areEqual(u,[2,3,1]),p=Ie.areEqual(u,[3,1,2]);if(d.length===2||h||p){o=h?[d[0],d[1]*d[2]]:p?[d[0]*d[1],d[2]]:d,a=[o[1],o[0]];let f=16;return c=_=>{let b=Ue("a",t,o.length),y=bt("output",t,a.length);return`
  ${_.registerUniform("output_size","u32").declareVariables(b,y)}
  var<workgroup> tile : array<array<${y.type.value}, ${f+1}>, ${f}>;
  ${_.mainStart([f,f,1])}
    let stride = (uniforms.output_shape[1] - 1) / ${f} + 1;
    let workgroup_id_x = workgroup_index % stride;
    let workgroup_id_y = workgroup_index / stride;
    let input_col = workgroup_id_y * ${f}u + local_id.x;
    let input_row = workgroup_id_x * ${f}u + local_id.y;
    if (input_row < uniforms.a_shape[0] && input_col < uniforms.a_shape[1]) {
      tile[local_id.y][local_id.x] = ${b.getByIndices(`${b.type.indices}(input_row, input_col)`)};
    }
    workgroupBarrier();

    let output_col = workgroup_id_x * ${f}u + local_id.x;
    let output_row = workgroup_id_y * ${f}u + local_id.y;
    if (output_row < uniforms.output_shape[0] && output_col < uniforms.output_shape[1]) {
      ${y.setByIndices(`${y.type.indices}(output_row, output_col)`,"tile[local_id.x][local_id.y]")}
    }
  }`},{name:"TransposeShared",shaderCache:{inputDependencies:["type"]},getRunData:()=>{let _=Ie.size(r);return{outputs:[{dims:r,dataType:s.dataType}],dispatchGroup:{x:Math.ceil(a[1]/f),y:Math.ceil(a[0]/f)},programUniforms:[{type:12,data:_},...St(o,a)]}},getShaderSource:c}}return c=f=>{let _=Ue("a",t,o.length),b=bt("output",t,a.length);return`
  ${f.registerUniform("output_size","u32").declareVariables(_,b)}

  ${sW(i,n,_,b)}

  ${f.mainStart()}
    ${f.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}

    let indices = ${b.offsetToIndices("global_idx")};
    let aIndices = perm(indices);

    ${b.setByOffset("global_idx",_.getByIndices("aIndices"))}
  }`},{name:"Transpose",shaderCache:{hint:`${e}`,inputDependencies:["rank"]},getRunData:()=>{let f=Ie.size(r);return{outputs:[{dims:r,dataType:s.dataType}],dispatchGroup:{x:Math.ceil(f/64)},programUniforms:[{type:12,data:f},...St(o,a)]}},getShaderSource:c}},G4=(s,e)=>{tW(s.inputs,e.perm),s.compute(Er(s.inputs[0],e.perm))},W4=s=>Mn({perm:s.perm})}),oW,aW,lW,cW,dW,uW,hW,pW,fW,mW,Co,H4,j4,q4,K4,Y4,X4,Q4,J4,Z4,eq,une=Ze(()=>{"use strict";$t(),Ht(),qt(),h1(),Nc(),oW={max:"select(bestValue, candidate, candidate > bestValue)",min:"select(bestValue, candidate, candidate < bestValue)",mean:"bestValue + candidate",sum:"bestValue + candidate",prod:"bestValue * candidate",sumSquare:"bestValue + candidate * candidate",logSumExp:"bestValue + exp(candidate)",l1:"bestValue + abs(candidate)",l2:"bestValue + candidate * candidate",logSum:"bestValue + candidate"},aW={max:"select(bestValue, candidate, candidate > bestValue)",min:"select(bestValue, candidate, candidate < bestValue)",mean:"bestValue + candidate",sum:"bestValue + candidate",prod:"bestValue * candidate",sumSquare:"bestValue + candidate",logSumExp:"bestValue + candidate",l1:"bestValue + candidate",l2:"bestValue + candidate",logSum:"bestValue + candidate"},lW={max:"_A[offset]",min:"_A[offset]",mean:"0",sum:"0",prod:"1",sumSquare:"0",logSumExp:"0",l1:"0",l2:"0",logSum:"0"},cW={max:"bestValue",min:"bestValue",sum:"bestValue",prod:"bestValue",sumSquare:"bestValue",logSumExp:"log(bestValue)",l1:"bestValue",l2:"sqrt(bestValue)",logSum:"log(bestValue)"},dW=(s,e)=>{let t=[];for(let n=e-s;n<e;++n)t.push(n);return t},uW=(s,e)=>{let t=[],n=s.length;for(let r=0;r<n;r++)e.indexOf(r)===-1&&t.push(s[r]);let i=e.map(r=>s[r]);return[t,i]},hW=(s,e)=>{let t=s.length+e.length,n=[],i=0;for(let r=0;r<t;r++)e.indexOf(r)===-1?n.push(s[i++]):n.push(1);return n},pW=(s,e)=>{for(let t=0;t<s.length;++t)if(s[s.length-t-1]!==e-1-t)return!1;return!0},fW=(s,e)=>{let t=[];if(!pW(s,e)){for(let n=0;n<e;++n)s.indexOf(n)===-1&&t.push(n);s.forEach(n=>t.push(n))}return t},mW=(s,e,t,n,i,r,o)=>{let a=t[0].dims,l=Ie.size(r),c=Ie.size(o),d=Ue("_A",t[0].dataType,a),u=bt("output",i,r),h=64;l===1&&(h=256);let p=`
          var<workgroup> aBestValues : array<f32, ${h}>;
       `,f=_=>`
        ${_.registerUniform("reduceSize","u32").declareVariables(d,u)}
        ${p}
        fn DIV_CEIL(a : u32, b : u32) -> u32 {
          return ((a - 1u) / b + 1u);
         }
         ${_.mainStart(h)}

          let outputIndex = global_idx / ${h};
          let offset = outputIndex * uniforms.reduceSize;

          var bestValue = f32(${lW[n]});
          let Length = uniforms.reduceSize;
          for (var k = local_idx; k < Length; k = k + ${h}) {
           let candidate = f32(${d.getByOffset("offset + k")});
           bestValue = ${oW[n]};
          }
          aBestValues[local_idx] = bestValue;
          workgroupBarrier();

         var reduceSize = min(Length, ${h}u);
         for (var currentSize = reduceSize / 2u; reduceSize > 1u;
             currentSize = reduceSize / 2u) {
           let interval = DIV_CEIL(reduceSize, 2u);
           if (local_idx < currentSize) {
            let candidate = aBestValues[local_idx + interval];
            bestValue = ${aW[n]};
            aBestValues[local_idx] = bestValue;
           }
           reduceSize = interval;
           workgroupBarrier();
         }

         if (local_idx == 0u) {
          ${u.setByOffset("outputIndex",`${n==="mean"?`${u.type.storage}(bestValue / f32(uniforms.reduceSize))`:`${u.type.storage}(${cW[n]})`}`)};
         }
        }`;return{name:s,shaderCache:{hint:`${e};${h}`,inputDependencies:["type"]},getShaderSource:f,getRunData:()=>({outputs:[{dims:r,dataType:i}],dispatchGroup:{x:l},programUniforms:[{type:12,data:c}]})}},Co=(s,e,t,n)=>{let i=s.inputs.length===1?t:zD(s.inputs,t),r=i.axes;r.length===0&&!i.noopWithEmptyAxes&&(r=s.inputs[0].dims.map((p,f)=>f));let o=Ie.normalizeAxes(r,s.inputs[0].dims.length),a=o,l=s.inputs[0],c=fW(a,s.inputs[0].dims.length);c.length>0&&(l=s.compute(Er(s.inputs[0],c),{inputs:[0],outputs:[-1]})[0],a=dW(a.length,l.dims.length));let[d,u]=uW(l.dims,a),h=d;i.keepDims&&(h=hW(d,o)),s.compute(mW(e,i.cacheKey,[l],n,s.inputs[0].dataType,h,u),{inputs:[l]})},H4=(s,e)=>{Co(s,"ReduceMeanShared",e,"mean")},j4=(s,e)=>{Co(s,"ReduceL1Shared",e,"l1")},q4=(s,e)=>{Co(s,"ReduceL2Shared",e,"l2")},K4=(s,e)=>{Co(s,"ReduceLogSumExpShared",e,"logSumExp")},Y4=(s,e)=>{Co(s,"ReduceMaxShared",e,"max")},X4=(s,e)=>{Co(s,"ReduceMinShared",e,"min")},Q4=(s,e)=>{Co(s,"ReduceProdShared",e,"prod")},J4=(s,e)=>{Co(s,"ReduceSumShared",e,"sum")},Z4=(s,e)=>{Co(s,"ReduceSumSquareShared",e,"sumSquare")},eq=(s,e)=>{Co(s,"ReduceLogSumShared",e,"logSum")}}),Ao,gW,Y0,zD,Po,_W,yW,vW,bW,wW,MW,TW,EW,xW,SW,ko,tq,nq,sq,iq,rq,oq,aq,lq,cq,dq,h1=Ze(()=>{"use strict";$t(),Ht(),cs(),qt(),une(),Ao=s=>{if(!s||s.length===0||s.length>2)throw new Error("Reduce op requires 1 or 2 inputs.");if(s.length===2&&s[1].dims.length!==1)throw new Error("Invalid axes input dims.")},gW=s=>["","",`var value = ${s.getByIndices("input_indices")};`,""],Y0=(s,e,t,n,i,r,o=!1,a=!1)=>{let l=[],c=t[0].dims,d=c.length,u=Ie.normalizeAxes(i,d),h=!a&&u.length===0;c.forEach((_,b)=>{h||u.indexOf(b)>=0?o&&l.push(1):l.push(_)});let p=l.length,f=Ie.size(l);return{name:s,shaderCache:e,getShaderSource:_=>{let b=[],y=Ue("_A",t[0].dataType,d),w=bt("output",r,p),C=n(y,w,u),M=C[2];for(let S=0,k=0;S<d;S++)h||u.indexOf(S)>=0?(o&&k++,M=`for(var j${S}: u32 = 0; j${S} < ${c[S]}; j${S}++) {
                  ${C[2].includes("last_index")?`let last_index = j${S};`:""}
                  ${y.indicesSet("input_indices",S,`j${S}`)}
                  ${M}
                }`):(b.push(`${y.indicesSet("input_indices",S,w.indicesGet("output_indices",k))};`),k++);return`

        ${_.registerUniform("output_size","u32").declareVariables(y,w)}

        ${_.mainStart()}
          ${_.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}
          var input_indices: ${y.type.indices};
          let output_indices = ${w.offsetToIndices("global_idx")};

          ${b.join(`
`)}
          ${C[0]}       // init ops for reduce max/min
          ${C[1]}
          ${M}
          ${C[3]}
          ${C.length===4?w.setByOffset("global_idx","value"):C.slice(4).join(`
`)}
        }`},getRunData:()=>({outputs:[{dims:l,dataType:r}],dispatchGroup:{x:Math.ceil(f/64)},programUniforms:[{type:12,data:f},...St(c,l)]})}},zD=(s,e)=>{let t=[];return s[1].dims[0]>0&&s[1].getBigInt64Array().forEach(n=>t.push(Number(n))),Mn({axes:t,keepDims:e.keepDims,noopWithEmptyAxes:e.noopWithEmptyAxes})},Po=(s,e,t,n)=>{let i=s.inputs,r=i.length===1?t:zD(i,t);s.compute(Y0(e,{hint:r.cacheKey,inputDependencies:["rank"]},[i[0]],r.noopWithEmptyAxes&&r.axes.length===0?gW:n,r.axes,i[0].dataType,r.keepDims,r.noopWithEmptyAxes),{inputs:[0]})},_W=(s,e)=>{Ao(s.inputs),Po(s,"ReduceLogSum",e,(t,n)=>[`var value = ${n.type.storage}(0);`,"",`value += ${t.getByIndices("input_indices")};`,"value = log(value);"])},yW=(s,e)=>{Ao(s.inputs),Po(s,"ReduceL1",e,(t,n)=>[`var value = ${n.type.storage}(0);`,"",`value += abs(${t.getByIndices("input_indices")});`,""])},vW=(s,e)=>{Ao(s.inputs),Po(s,"ReduceL2",e,(t,n)=>[`var t = ${n.type.value}(0); var value = ${n.type.value}(0);`,"",`t = ${t.getByIndices("input_indices")}; value += (t * t);`,"value = sqrt(value);"])},bW=(s,e)=>{Ao(s.inputs),Po(s,"ReduceLogSumExp",e,(t,n)=>[`var value = ${n.type.storage}(0);`,"",`value += exp(${t.getByIndices("input_indices")});`,"value = log(value);"])},wW=(s,e)=>{Ao(s.inputs),Po(s,"ReduceMax",e,(t,n,i)=>{let r=[];for(let o=0;o<t.rank;o++)(i.indexOf(o)>=0||i.length===0)&&r.push(t.indicesSet("input_indices",o,0));return[`${r.join(`
`)}`,`var value = ${t.getByIndices("input_indices")};`,`value = max(value, ${t.getByIndices("input_indices")});`,""]})},MW=(s,e)=>{Ao(s.inputs),Po(s,"ReduceMean",e,(t,n,i)=>{let r=1;for(let o=0;o<t.rank;o++)(i.indexOf(o)>=0||i.length===0)&&(r*=s.inputs[0].dims[o]);return["var sum = f32(0);","",`sum += f32(${t.getByIndices("input_indices")});`,`let value = ${n.type.value}(sum / ${r});`]})},TW=(s,e)=>{Ao(s.inputs),Po(s,"ReduceMin",e,(t,n,i)=>{let r=[];for(let o=0;o<t.rank;o++)(i.indexOf(o)>=0||i.length===0)&&r.push(`input_indices[${o}] = 0;`);return[`${r.join(`
`)}`,`var value = ${t.getByIndices("input_indices")};`,`value = min(value, ${t.getByIndices("input_indices")});`,""]})},EW=(s,e)=>{Ao(s.inputs),Po(s,"ReduceProd",e,(t,n)=>[`var value = ${n.type.storage}(1);`,"",`value *= ${t.getByIndices("input_indices")};`,""])},xW=(s,e)=>{Ao(s.inputs),Po(s,"ReduceSum",e,(t,n)=>[`var value = ${n.type.storage}(0);`,"",`value += ${t.getByIndices("input_indices")};`,""])},SW=(s,e)=>{Ao(s.inputs),Po(s,"ReduceSumSquare",e,(t,n)=>[`var t = ${n.type.value}(0); var value = ${n.type.value}(0);`,"",`t = ${t.getByIndices("input_indices")}; value += t * t;`,""])},ko=(s,e,t)=>{if(e.length===0)return t;let n=1,i=1;for(let r=0;r<e.length;r++)e.indexOf(r)===-1?n*=s[r]:i*=s[r];return i<32&&n>1024},tq=(s,e)=>{ko(s.inputs[0].dims,e.axes,e.noopWithEmptyAxes)?MW(s,e):H4(s,e)},nq=(s,e)=>{ko(s.inputs[0].dims,e.axes,e.noopWithEmptyAxes)?yW(s,e):j4(s,e)},sq=(s,e)=>{ko(s.inputs[0].dims,e.axes,e.noopWithEmptyAxes)?vW(s,e):q4(s,e)},iq=(s,e)=>{ko(s.inputs[0].dims,e.axes,e.noopWithEmptyAxes)?bW(s,e):K4(s,e)},rq=(s,e)=>{ko(s.inputs[0].dims,e.axes,e.noopWithEmptyAxes)?wW(s,e):Y4(s,e)},oq=(s,e)=>{ko(s.inputs[0].dims,e.axes,e.noopWithEmptyAxes)?TW(s,e):X4(s,e)},aq=(s,e)=>{ko(s.inputs[0].dims,e.axes,e.noopWithEmptyAxes)?EW(s,e):Q4(s,e)},lq=(s,e)=>{ko(s.inputs[0].dims,e.axes,e.noopWithEmptyAxes)?xW(s,e):J4(s,e)},cq=(s,e)=>{ko(s.inputs[0].dims,e.axes,e.noopWithEmptyAxes)?SW(s,e):Z4(s,e)},dq=(s,e)=>{ko(s.inputs[0].dims,e.axes,e.noopWithEmptyAxes)?_W(s,e):eq(s,e)}}),sD,uq,hq,UD,hne=Ze(()=>{"use strict";$t(),cs(),h1(),sD=s=>{if(!s||s.length===0||s.length>2)throw new Error("ArgMinMaxOp op requires 1 or 2 inputs.");if(s[0].dataType!==1)throw new Error("Invalid input type.")},uq=(s,e)=>{sD(s.inputs);let t=(n,i,r)=>{let o=[];for(let a=0;a<n.rank;a++)(r.indexOf(a)>=0||r.length===0)&&o.push(`input_indices[${a}] = 0;`);return[`${o.join(`
`)}`,`var value = ${n.getByIndices("input_indices")};
var best_index : i32 = 0;`,`if (${n.getByIndices("input_indices")} ${e.selectLastIndex>0?"<=":"<"} value) {
         value = ${n.getByIndices("input_indices")};
         best_index = i32(last_index);
       }`,"",i.setByOffset("global_idx","best_index")]};s.compute(Y0("ArgMin",{hint:e.cacheKey,inputDependencies:["rank"]},[s.inputs[0]],t,[e.axis],7,e.keepDims),{inputs:[0]})},hq=(s,e)=>{sD(s.inputs);let t=(n,i,r)=>{let o=[];for(let a=0;a<n.rank;a++)(r.indexOf(a)>=0||r.length===0)&&o.push(`input_indices[${a}] = 0;`);return[`${o.join(`
`)}`,`var value = ${n.getByIndices("input_indices")};
var best_index : i32 = 0;`,`if (${n.getByIndices("input_indices")} ${e.selectLastIndex>0?">=":">"} value) {
         value = ${n.getByIndices("input_indices")};
         best_index = i32(last_index);
       }`,"",i.setByOffset("global_idx","best_index")]};s.compute(Y0("argMax",{hint:e.cacheKey,inputDependencies:["rank"]},[s.inputs[0]],t,[e.axis],7,e.keepDims),{inputs:[0]})},UD=s=>Mn(s)}),CW,O0,AW,PW,kW,cv,IW,pq,p1=Ze(()=>{"use strict";$t(),Ht(),d1(),qt(),CW=(s,e)=>{let t=s[0],n=s[1],i=s[2],r=s[3],o=s[4],a=s[5];if(o&&a)throw new Error("Attention cannot have both past and attention_bias");if(t.dims.length!==3)throw new Error('Input "input" must have 3 dimensions');let l=t.dims[0],c=t.dims[1],d=t.dims[2];if(i.dims.length!==1)throw new Error('Input "bias" is expected to have 1 dimensions');if(n.dims.length!==2)throw new Error('Input "weights" is expected to have 2 dimensions');if(n.dims[0]!==d)throw new Error("Input 1 dimension 0 should have same length as dimension 2 of input 0");if(i.dims[0]!==n.dims[1])throw new Error('Input "bias" dimension 0 should have same length as dimension 1 of input "weights"');let u=i.dims[0]/3,h=u,p=h;if(e.qkvHiddenSizes.length>0){if(e.qkvHiddenSizes.length!==3)throw new Error("qkv_hidden_sizes attribute should have 3 elements");for(let C of e.qkvHiddenSizes)if(C%e.numHeads!==0)throw new Error("qkv_hidden_sizes should be divisible by num_heads");u=e.qkvHiddenSizes[0],h=e.qkvHiddenSizes[1],p=e.qkvHiddenSizes[2]}let f=c;if(u!==h)throw new Error("qkv_hidden_sizes first element should be same as the second");if(i.dims[0]!==u+h+p)throw new Error('Input "bias" dimension 0 should have same length as sum of Q/K/V hidden sizes');let _=0;if(o){if(h!==p)throw new Error('Input "past" expect k_hidden_size == v_hidden_size');if(o.dims.length!==5)throw new Error('Input "past" must have 5 dimensions');if(o.dims[0]!==2)throw new Error('Input "past" first dimension must be 2');if(o.dims[1]!==l)throw new Error('Input "past" second dimension must be batch_size');if(o.dims[2]!==e.numHeads)throw new Error('Input "past" third dimension must be num_heads');if(o.dims[4]!==h/e.numHeads)throw new Error('Input "past" fifth dimension must be k_hidden_size / num_heads');e.pastPresentShareBuffer||(_=o.dims[3])}let b=f+_,y=-1,w=0;if(r)throw new Error("Mask not supported");if(o)throw new Error("past is not supported");if(a){if(a.dims.length!==4)throw new Error('Input "attention_bias" must have 4 dimensions');if(a.dims[0]!==l||a.dims[1]!==e.numHeads||a.dims[2]!==c||a.dims[3]!==b)throw new Error('Expect "attention_bias" shape (batch_size, num_heads, sequence_length, total_sequence_length)')}return{batchSize:l,sequenceLength:c,pastSequenceLength:_,kvSequenceLength:f,totalSequenceLength:b,maxSequenceLength:y,inputHiddenSize:d,hiddenSize:u,vHiddenSize:p,headSize:Math.floor(u/e.numHeads),vHeadSize:Math.floor(p/e.numHeads),numHeads:e.numHeads,isUnidirectional:!1,pastPresentShareBuffer:!1,maskFilterValue:e.maskFilterValue,maskType:w,scale:e.scale,broadcastResPosBias:!1,passPastInKv:!1,qkvFormat:1}},O0=(s,e,t)=>e&&s?`
      let total_sequence_length_input = u32(${e.getByOffset("0")});
      let present_sequence_length = max(total_sequence_length_input, uniforms.past_sequence_length);
      let is_subsequent_prompt: bool = sequence_length > 1 && sequence_length != total_sequence_length_input;
      let is_first_prompt: bool = is_subsequent_prompt == false && sequence_length == total_sequence_length_input;
      total_sequence_length = u32(${s?.getByOffset("batchIdx")}) + 1;
      var past_sequence_length: u32 = 0;
      if (is_first_prompt == false) {
        past_sequence_length = total_sequence_length - sequence_length;
      }
       `:`
    ${t?"let past_sequence_length = uniforms.past_sequence_length":""};
    let present_sequence_length = total_sequence_length;
    `,AW=(s,e,t,n,i,r,o,a)=>{let l=es(o?1:r),c=64,d=r/l;d<c&&(c=32);let u=Math.ceil(r/l/c),h=[{type:12,data:e},{type:12,data:t},{type:12,data:n},{type:12,data:i},{type:12,data:d},{type:12,data:u}],p=Vs(s.dataType,l),f=Si(1,l),_=["type"];o&&_.push("type"),a&&_.push("type");let b=y=>{let w=bt("x",s.dataType,s.dims,l),C=[w],M=o?Ue("seq_lens",o.dataType,o.dims):void 0;M&&C.push(M);let S=a?Ue("total_sequence_length_input",a.dataType,a.dims):void 0;S&&C.push(S);let k=Si(s.dataType),T=[{name:"batch_size",type:"u32"},{name:"num_heads",type:"u32"},{name:"past_sequence_length",type:"u32"},{name:"sequence_length",type:"u32"},{name:"total_sequence_length",type:"u32"},{name:"elements_per_thread",type:"u32"}];return`
  var<workgroup> thread_max: array<f32, ${c}>;
  var<workgroup> thread_sum: array<f32, ${c}>;
  ${y.registerUniforms(T).declareVariables(...C)}
  ${y.mainStart([c,1,1])}
    let batchIdx = workgroup_id.z / uniforms.num_heads;
    let headIdx = workgroup_id.z % uniforms.num_heads;
    let sequence_length = uniforms.sequence_length;
    var total_sequence_length = uniforms.total_sequence_length;
    ${O0(M,S,!1)}
    let local_offset = local_idx * uniforms.elements_per_thread;
    let offset = (global_idx / ${c}) * uniforms.total_sequence_length + local_offset;
    let seq_causal_length = ${o?"u32(past_sequence_length + workgroup_id.y + 1)":"total_sequence_length"};
    var thread_max_vector = ${f}(-3.402823e+38f);
    for (var i: u32 = 0; i < uniforms.elements_per_thread && i + local_offset < seq_causal_length; i++) {
      thread_max_vector = max(${f}(x[offset + i]), thread_max_vector);
    }
    thread_max[local_idx] = ${(()=>{switch(l){case 1:return"thread_max_vector";case 2:return"max(thread_max_vector.x, thread_max_vector.y)";case 4:return"max(max(thread_max_vector.x, thread_max_vector.y), max(thread_max_vector.z, thread_max_vector.w))";default:throw new Error(`Unsupported components: ${l}`)}})()};
    workgroupBarrier();

    var max_value =  f32(-3.402823e+38f);
    for (var i = 0u; i < ${c}; i++) {
      max_value = max(thread_max[i], max_value);
    }

    var sum_vector = ${f}(0);
    for (var i: u32 = 0; i < uniforms.elements_per_thread && i + local_offset < seq_causal_length; i++) {
      sum_vector += exp(${f}(x[offset + i]) - max_value);
    }
    thread_sum[local_idx] = ${(()=>{switch(l){case 1:return"sum_vector";case 2:return"sum_vector.x + sum_vector.y";case 4:return"sum_vector.x + sum_vector.y + sum_vector.z + sum_vector.w";default:throw new Error(`Unsupported components: ${l}`)}})()};
    workgroupBarrier();

    var sum: f32 = 0;
    for (var i = 0u; i < ${c}; i++) {
      sum += thread_sum[i];
    }

    if (sum == 0) {
      for (var i: u32 = 0; i < uniforms.elements_per_thread && i + local_offset < seq_causal_length; i++) {
        x[offset + i] = ${w.type.value}(${k}(1.0) / ${k}(seq_causal_length));
      }
    } else {
      for (var i: u32 = 0; i < uniforms.elements_per_thread && i + local_offset < seq_causal_length; i++) {
        var f32input = ${f}(x[offset + i]);
        x[offset + i] = ${w.type.value}(exp(f32input - max_value) / sum);
      }
    }
      ${o?`
        for (var total_seq_id: u32 = seq_causal_length; total_seq_id + local_offset < uniforms.total_sequence_length; total_seq_id++) {
          x[offset + total_seq_id] = ${w.type.value}(${k}(0));
        }`:""};
  }`};return{name:"AttentionProbsSoftmax",shaderCache:{hint:`${c};${p};${l}`,inputDependencies:_},getShaderSource:b,getRunData:()=>({outputs:[],dispatchGroup:{x:1,y:i,z:e*t},programUniforms:h})}},PW=(s,e,t,n,i,r,o,a,l)=>{let c=o+r.kvSequenceLength,d=[r.batchSize,r.numHeads,r.sequenceLength,c],u=s>1&&n,h=r.kvNumHeads?r.kvNumHeads:r.numHeads,p=u?[r.batchSize,h,c,r.headSize]:void 0,f=r.nReps?r.nReps:1,_=r.scale===0?1/Math.sqrt(r.headSize):r.scale,b=es(r.headSize),y=r.headSize/b,w=12,C={x:Math.ceil(c/w),y:Math.ceil(r.sequenceLength/w),z:r.batchSize*r.numHeads},M=[{type:12,data:r.sequenceLength},{type:12,data:y},{type:12,data:c},{type:12,data:r.numHeads},{type:12,data:r.headSize},{type:1,data:_},{type:12,data:o},{type:12,data:r.kvSequenceLength},{type:12,data:f}],S=u&&n&&Ie.size(n.dims)>0,k=["type","type"];S&&k.push("type"),i&&k.push("type"),a&&k.push("type"),l&&k.push("type");let T=[{dims:d,dataType:e.dataType,gpuDataType:0}];u&&T.push({dims:p,dataType:e.dataType,gpuDataType:0});let P=R=>{let O=Ue("q",e.dataType,e.dims,b),H=Ue("key",t.dataType,t.dims,b),X=[O,H];if(S){let fe=Ue("past_key",n.dataType,n.dims,b);X.push(fe)}i&&X.push(Ue("attention_bias",i.dataType,i.dims));let z=a?Ue("seq_lens",a.dataType,a.dims):void 0;z&&X.push(z);let ne=l?Ue("total_sequence_length_input",l.dataType,l.dims):void 0;ne&&X.push(ne);let re=bt("output",e.dataType,d),Y=[re];u&&Y.push(bt("present_key",e.dataType,p,b));let se=Si(1,b),ue=[{name:"M",type:"u32"},{name:"K",type:"u32"},{name:"N",type:"u32"},{name:"num_heads",type:"u32"},{name:"head_size",type:"u32"},{name:"alpha",type:"f32"},{name:"past_sequence_length",type:"u32"},{name:"kv_sequence_length",type:"u32"},{name:"n_reps",type:"u32"}];return`
  const TILE_SIZE = ${w}u;

  var<workgroup> tileQ: array<${O.type.storage}, ${w*w}>;
  var<workgroup> tileK: array<${O.type.storage}, ${w*w}>;
  ${R.registerUniforms(ue).declareVariables(...X,...Y)}
  ${R.mainStart([w,w,1])}
    // x holds the N and y holds the M
    let headIdx = workgroup_id.z % uniforms.num_heads;
    let kvHeadIdx = ${f===1?"headIdx":"headIdx / uniforms.n_reps"};
    let kv_num_heads = ${f===1?"uniforms.num_heads":"uniforms.num_heads / uniforms.n_reps"};
    let batchIdx = workgroup_id.z / uniforms.num_heads;
    let m = workgroup_id.y * TILE_SIZE;
    let n = workgroup_id.x * TILE_SIZE;
    let sequence_length = uniforms.M;
    var total_sequence_length = uniforms.N;
    ${O0(z,ne,!0)}
    let absKvHeadIdx = batchIdx * kv_num_heads + kvHeadIdx;
    let qOffset = workgroup_id.z * uniforms.M * uniforms.K + m * uniforms.K;
    ${S&&u?"let pastKeyOffset = absKvHeadIdx * uniforms.past_sequence_length * uniforms.K;":""};
    let kOffset = absKvHeadIdx * uniforms.kv_sequence_length * uniforms.K;
    ${u?"let presentKeyOffset = absKvHeadIdx * uniforms.N * uniforms.K;":""}
    var value = ${se}(0);
    for (var w: u32 = 0u; w < uniforms.K; w += TILE_SIZE) {
      if (global_id.y < uniforms.M && w + local_id.x < uniforms.K) {
        tileQ[TILE_SIZE * local_id.y + local_id.x] = q[qOffset + local_id.y * uniforms.K + w + local_id.x];
      }
      if (n + local_id.y < uniforms.N && w + local_id.x < uniforms.K) {
        var idx = TILE_SIZE * local_id.y + local_id.x;
      ${S&&u?`
              if (n + local_id.y < past_sequence_length) {
                tileK[idx] = past_key[pastKeyOffset + (n + local_id.y) * uniforms.K + w + local_id.x];
              } else if (n + local_id.y - past_sequence_length < uniforms.kv_sequence_length) {
                tileK[idx] = key[kOffset + (n + local_id.y - past_sequence_length) * uniforms.K + w + local_id.x];
              }`:`
          if (n + local_id.y < uniforms.kv_sequence_length) {
            tileK[idx] = key[kOffset + (n + local_id.y) * uniforms.K + w + local_id.x];
          }`}
      ${u?`if (n + local_id.y < present_sequence_length) {
        present_key[presentKeyOffset + (n + local_id.y) * uniforms.K + w + local_id.x] = tileK[idx];
      }`:""}
      }
      workgroupBarrier();

      for (var k: u32 = 0u; k < TILE_SIZE && w+k < uniforms.K; k++) {
          value += ${se}(tileQ[TILE_SIZE * local_id.y + k] * tileK[TILE_SIZE * local_id.x + k]);
      }

      workgroupBarrier();
    }

    if (global_id.y < uniforms.M && global_id.x < total_sequence_length) {
      let headOffset = workgroup_id.z * uniforms.M * uniforms.N;
      let outputIdx = headOffset + global_id.y * uniforms.N + global_id.x;
      var sum: f32 = ${(()=>{switch(b){case 1:return"value";case 2:return"value.x + value.y";case 4:return"value.x + value.y + value.z + value.w";default:throw new Error(`Unsupported components: ${b}`)}})()};
        output[outputIdx] = ${re.type.value} (sum * uniforms.alpha) + ${i?"attention_bias[outputIdx]":"0.0"};
    }
  }`};return{name:"AttentionProbs",shaderCache:{hint:`${b};${i!==void 0};${n!==void 0};${s}`,inputDependencies:k},getRunData:()=>({outputs:T,dispatchGroup:C,programUniforms:M}),getShaderSource:P}},kW=(s,e,t,n,i,r,o=void 0,a=void 0)=>{let l=r+i.kvSequenceLength,c=i.nReps?i.nReps:1,d=i.vHiddenSize*c,u=s>1&&n,h=i.kvNumHeads?i.kvNumHeads:i.numHeads,p=u?[i.batchSize,h,l,i.headSize]:void 0,f=[i.batchSize,i.sequenceLength,d],_=12,b={x:Math.ceil(i.vHeadSize/_),y:Math.ceil(i.sequenceLength/_),z:i.batchSize*i.numHeads},y=[{type:12,data:i.sequenceLength},{type:12,data:l},{type:12,data:i.vHeadSize},{type:12,data:i.numHeads},{type:12,data:i.headSize},{type:12,data:d},{type:12,data:r},{type:12,data:i.kvSequenceLength},{type:12,data:c}],w=u&&n&&Ie.size(n.dims)>0,C=["type","type"];w&&C.push("type"),o&&C.push("type"),a&&C.push("type");let M=[{dims:f,dataType:e.dataType,gpuDataType:0}];u&&M.push({dims:p,dataType:e.dataType,gpuDataType:0});let S=k=>{let T=Ue("probs",e.dataType,e.dims),P=Ue("v",t.dataType,t.dims),R=[T,P];w&&R.push(Ue("past_value",n.dataType,n.dims));let O=o?Ue("seq_lens",o.dataType,o.dims):void 0;o&&R.push(O);let H=a?Ue("total_sequence_length_input",a.dataType,a.dims):void 0;a&&R.push(H);let X=[bt("output",e.dataType,f)];u&&X.push(bt("present_value",e.dataType,p));let z=[{name:"M",type:"u32"},{name:"K",type:"u32"},{name:"N",type:"u32"},{name:"num_heads",type:"u32"},{name:"head_size",type:"u32"},{name:"v_hidden_size",type:"u32"},{name:"past_sequence_length",type:"u32"},{name:"kv_sequence_length",type:"u32"},{name:"n_reps",type:"u32"}];return`
  const TILE_SIZE = ${_}u;
  var<workgroup> tileQ: array<${T.type.value}, ${_*_}>;
  var<workgroup> tileV: array<${T.type.value}, ${_*_}>;
  ${k.registerUniforms(z).declareVariables(...R,...X)}
  ${k.mainStart([_,_,1])}
   let headIdx = workgroup_id.z % uniforms.num_heads;
   let batchIdx = workgroup_id.z / uniforms.num_heads;
   let kvHeadIdx = ${c===1?"headIdx":"headIdx / uniforms.n_reps"};
   let kv_num_heads = ${c===1?"uniforms.num_heads":"uniforms.num_heads / uniforms.n_reps"};
   let m = global_id.y;
   let n = global_id.x;
   let sequence_length = uniforms.M;
   var total_sequence_length = uniforms.K;
   ${O0(O,H,!0)}
   let offsetA = workgroup_id.z * uniforms.M * uniforms.K + m * uniforms.K;
   let absKvHeadIdx = batchIdx * kv_num_heads + kvHeadIdx; // kvHeadIdx is relative to the batch
   ${w&&u?"let pastValueOffset = absKvHeadIdx * uniforms.N * uniforms.past_sequence_length + n;":""};
   let vOffset = absKvHeadIdx * uniforms.N * uniforms.kv_sequence_length + n;
   ${u?"let presentValueOffset = absKvHeadIdx * uniforms.N * uniforms.K + n;":""}
   var value = ${T.type.storage}(0);
   for (var w: u32 = 0u; w < uniforms.K; w += TILE_SIZE) {
      if (m < uniforms.M && w + local_id.x < uniforms.K) {
        tileQ[TILE_SIZE * local_id.y + local_id.x] = probs[offsetA + w + local_id.x];
      }
      if (n < uniforms.N && w + local_id.y < uniforms.K) {
        var idx = TILE_SIZE * local_id.y + local_id.x;
        ${w&&u?`
        if (w + local_id.y < past_sequence_length) {
          tileV[idx] = past_value[pastValueOffset + (w + local_id.y) * uniforms.N];
        } else if (w + local_id.y - past_sequence_length < uniforms.kv_sequence_length) {
          tileV[idx] = v[vOffset + (w + local_id.y - past_sequence_length) * uniforms.N];
        }
      `:`
            if (w + local_id.y < uniforms.kv_sequence_length) {
              tileV[idx] = v[vOffset + (w + local_id.y) * uniforms.N];
            }`}
        ${u?`
            if (w + local_id.y < present_sequence_length) {
          present_value[presentValueOffset + (w + local_id.y) * uniforms.N] = tileV[idx];
        }`:""}
      }
     workgroupBarrier();
     for (var k: u32 = 0u; k < TILE_SIZE && w+k < total_sequence_length; k++) {
       value += tileQ[TILE_SIZE * local_id.y + k] * tileV[TILE_SIZE * k + local_id.x];
     }
     workgroupBarrier();
   }

   // we need to transpose output from BNSH_v to BSND_v
   if (m < uniforms.M && n < uniforms.N) {
     let outputIdx = batchIdx * uniforms.M * uniforms.v_hidden_size + m * uniforms.v_hidden_size
       + headIdx * uniforms.N + n;
     output[outputIdx] = value;
   }
  }`};return{name:"AttentionScore",shaderCache:{hint:`${n!==void 0};${s}`,inputDependencies:C},getRunData:()=>({outputs:M,dispatchGroup:b,programUniforms:y}),getShaderSource:S}},cv=(s,e,t,n,i,r,o,a,l,c,d=void 0,u=void 0)=>{let h=Math.min(s.outputCount,1+(o?1:0)+(a?1:0)),p=h>1?c.pastSequenceLength:0,f=p+c.kvSequenceLength,_=l&&Ie.size(l.dims)>0?l:void 0,b=[e,t];h>1&&o&&Ie.size(o.dims)>0&&b.push(o),_&&b.push(_),d&&b.push(d),u&&b.push(u);let y=s.compute(PW(h,e,t,o,_,c,p,d,u),{inputs:b,outputs:h>1?[-1,1]:[-1]})[0];s.compute(AW(y,c.batchSize,c.numHeads,p,c.sequenceLength,f,d,u),{inputs:d&&u?[y,d,u]:[y],outputs:[]});let w=[y,n];h>1&&a&&Ie.size(a.dims)>0&&w.push(a),d&&w.push(d),u&&w.push(u),s.compute(kW(h,y,n,a,c,p,d,u),{inputs:w,outputs:h>1?[0,2]:[0]})},IW=(s,e)=>{let t=[e.batchSize,e.numHeads,e.sequenceLength,e.headSize],n=e.sequenceLength,i=e.inputHiddenSize,r=e.headSize,o=12,a={x:Math.ceil(e.headSize/o),y:Math.ceil(e.sequenceLength/o),z:e.batchSize*e.numHeads},l=[s.inputs[0],s.inputs[1],s.inputs[2]],c=[{type:12,data:n},{type:12,data:i},{type:12,data:r},{type:12,data:e.numHeads},{type:12,data:e.headSize},{type:12,data:e.hiddenSize},{type:12,data:e.hiddenSize+e.hiddenSize+e.vHiddenSize}],d=u=>{let h=bt("output_q",l[0].dataType,t),p=bt("output_k",l[0].dataType,t),f=bt("output_v",l[0].dataType,t),_=Ue("input",l[0].dataType,l[0].dims),b=Ue("weight",l[1].dataType,l[1].dims),y=Ue("bias",l[2].dataType,l[2].dims),w=_.type.storage,C=[{name:"M",type:"u32"},{name:"K",type:"u32"},{name:"N",type:"u32"},{name:"num_heads",type:"u32"},{name:"head_size",type:"u32"},{name:"hidden_size",type:"u32"},{name:"ldb",type:"u32"}];return`
  const TILE_SIZE = ${o}u;
  var<workgroup> tileInput: array<${w}, ${o*o}>;
  var<workgroup> tileWeightQ: array<${w}, ${o*o}>;
  var<workgroup> tileWeightK: array<${w}, ${o*o}>;
  var<workgroup> tileWeightV: array<${w}, ${o*o}>;
  ${u.registerUniforms(C).declareVariables(_,b,y,h,p,f)}
  ${u.mainStart([o,o,1])}
    let batchIndex = workgroup_id.z / uniforms.num_heads;
    let headNumber = workgroup_id.z % uniforms.num_heads;
    let m = global_id.y;
    let n = global_id.x;

    let inputOffset = batchIndex * (uniforms.M * uniforms.K) + m * uniforms.K;
    let biasOffsetQ = headNumber * uniforms.head_size;
    let biasOffsetK = uniforms.hidden_size + biasOffsetQ;
    let biasOffsetV = uniforms.hidden_size + biasOffsetK;

    var valueQ = ${w}(0);
    var valueK = ${w}(0);
    var valueV = ${w}(0);
    for (var w: u32 = 0u; w < uniforms.K; w += TILE_SIZE) {
      if (m < uniforms.M && w + local_id.x < uniforms.K) {
        tileInput[TILE_SIZE * local_id.y + local_id.x] = input[inputOffset + w + local_id.x];
      }
      if (n < uniforms.N && w + local_id.y < uniforms.K) {
        let offset = n + (w + local_id.y) * uniforms.ldb;
        tileWeightQ[TILE_SIZE * local_id.y + local_id.x] = weight[biasOffsetQ + offset];
        tileWeightK[TILE_SIZE * local_id.y + local_id.x] = weight[biasOffsetK + offset];
        tileWeightV[TILE_SIZE * local_id.y + local_id.x] = weight[biasOffsetV + offset];
      }
      workgroupBarrier();
      for (var k: u32 = 0u; k<TILE_SIZE && w+k < uniforms.K; k++) {
        let inputTileOffset = TILE_SIZE * local_id.y + k;
        let weightTileOffset = TILE_SIZE * k + local_id.x;
        valueQ += tileInput[inputTileOffset] * tileWeightQ[weightTileOffset];
        valueK += tileInput[inputTileOffset] * tileWeightK[weightTileOffset];
        valueV += tileInput[inputTileOffset] * tileWeightV[weightTileOffset];
      }

      workgroupBarrier();
    }

    let headOffset = (m * uniforms.N + n) % uniforms.head_size;
    valueQ += bias[headOffset + biasOffsetQ];
    valueK += bias[headOffset + biasOffsetK];
    valueV += bias[headOffset + biasOffsetV];

    let offset = workgroup_id.z * uniforms.M * uniforms.N;
    if (m < uniforms.M && n < uniforms.N) {
      let outputIdx = offset + m * uniforms.N + n;
      output_q[outputIdx] = valueQ;
      output_k[outputIdx] = valueK;
      output_v[outputIdx] = valueV;
    }
  }`};return s.compute({name:"AttentionPrepare",shaderCache:{inputDependencies:["type","type","type"]},getRunData:()=>({outputs:[{dims:t,dataType:s.inputs[0].dataType,gpuDataType:0},{dims:t,dataType:s.inputs[0].dataType,gpuDataType:0},{dims:t,dataType:s.inputs[0].dataType,gpuDataType:0}],dispatchGroup:a,programUniforms:c}),getShaderSource:d},{inputs:l,outputs:[-1,-1,-1]})},pq=(s,e)=>{let t=CW(s.inputs,e),[n,i,r]=IW(s,t);return cv(s,n,i,r,s.inputs[4],void 0,void 0,void 0,s.inputs[5],t)}}),DW,RW,FW,fq,pne=Ze(()=>{"use strict";No(),$t(),Ht(),cs(),qt(),DW=(s,e)=>{if(!s||s.length!==5)throw new Error("BatchNormalization requires 5 inputs");let t=(n,i,r)=>{let o=i.length;if(o!==n.length)throw new Error(`${r}: num dimensions != ${o}`);i.forEach((a,l)=>{if(a!==n[l])throw new Error(`${r}: dim[${l}] do not match`)})};if(s[0].dims.length>1){let n=e.format==="NHWC"?e.spatial?s[0].dims.slice(-1):s[0].dims.slice(-1).concat(s[0].dims.slice(1,s[0].dims.length-1)):s[0].dims.slice(1,e.spatial?2:void 0);t(s[1].dims,n,"Invalid input scale"),t(s[2].dims,n,"Invalid input B"),t(s[3].dims,n,"Invalid input mean"),t(s[4].dims,n,"Invalid input var")}else t(s[1].dims,[1],"Invalid input scale"),t(s[2].dims,[1],"Invalid input B"),t(s[3].dims,[1],"Invalid input mean"),t(s[4].dims,[1],"Invalid input var")},RW=(s,e)=>{let{epsilon:t,spatial:n,format:i}=e,r=s[0].dims,o=n?es(r[r.length-1]):1,a=i==="NHWC"&&r.length>1?o:1,l=Ie.size(r)/o,c=n,d=c?r.length:r,u=Ue("x",s[0].dataType,s[0].dims,o),h=Ue("scale",s[1].dataType,s[1].dims,a),p=Ue("bias",s[2].dataType,s[2].dims,a),f=Ue("inputMean",s[3].dataType,s[3].dims,a),_=Ue("inputVar",s[4].dataType,s[4].dims,a),b=bt("y",s[0].dataType,d,o),y=()=>{let C="";if(n)C=`let cOffset = ${r.length===1?"0u":i==="NHWC"?`outputIndices[${r.length-1}] / ${o}`:"outputIndices[1]"};`;else if(i==="NCHW")C=`
            ${b.indicesSet("outputIndices","0","0")}
            let cOffset = ${b.indicesToOffset("outputIndices")};`;else{C=`var cIndices = ${h.type.indices}(0);
                       cIndices[0] = outputIndices[${r.length-1}];`;for(let M=1;M<h.rank;M++)C+=`cIndices[${M}] = outputIndices[${M}];`;C+=`let cOffset = ${h.indicesToOffset("cIndices")};`}return C},w=C=>`
  const epsilon = ${t};
  ${C.registerUniform("outputSize","u32").declareVariables(u,h,p,f,_,b)}
  ${C.mainStart()}
  ${C.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}
    var outputIndices = ${b.offsetToIndices(`global_idx * ${o}`)};
    ${y()}
    let scale = ${h.getByOffset("cOffset")};
    let bias = ${p.getByOffset("cOffset")};
    let inputMean = ${f.getByOffset("cOffset")};
    let inputVar = ${_.getByOffset("cOffset")};
    let x = ${u.getByOffset("global_idx")};
    let value = (x - inputMean) * inverseSqrt(inputVar + epsilon) * scale + bias;
    ${b.setByOffset("global_idx","value")}
  }`;return{name:"BatchNormalization",shaderCache:{hint:`${e.epsilon}_${e.format}_${n}_${o}`,inputDependencies:c?["rank","type","type","type","type"]:void 0},getShaderSource:w,getRunData:()=>({outputs:[{dims:s[0].dims,dataType:s[0].dataType}],dispatchGroup:{x:Math.ceil(l/64)},programUniforms:c?[{type:12,data:l},...St(r)]:[{type:12,data:l}]})}},FW=s=>Mn(s),fq=(s,e)=>{let{inputs:t,outputCount:n}=s,i=FW({...e,outputCount:n});if(Un.webgpu.validateInputContent&&DW(t,i),e.trainingMode)throw new Error("BatchNormalization trainingMode is not supported yet.");s.compute(RW(t,i))}}),LW,NW,mq,fne=Ze(()=>{"use strict";Ht(),qt(),LW=s=>{if(s[0].dims.length!==3)throw new Error("input should have 3 dimensions");if(![320,640,1280].includes(s[0].dims[2]))throw new Error("number of channels should be 320, 640 or 1280");if(s[1].dims.length!==1)throw new Error("bias is expected to have 1 dimensions");if(s[0].dims[2]!==s[1].dims[0])throw new Error("last dimension of input and bias are not the same")},NW=s=>{let e=s[0].dims,t=s[0].dims[2],n=Ie.size(e)/4,i=s[0].dataType,r=Ue("input",i,e,4),o=Ue("bias",i,[t],4),a=Ue("residual",i,e,4),l=bt("output",i,e,4);return{name:"BiasAdd",getRunData:()=>({outputs:[{dims:e,dataType:s[0].dataType}],dispatchGroup:{x:Math.ceil(n/64)}}),getShaderSource:c=>`
  const channels = ${t}u / 4;
  ${c.declareVariables(r,o,a,l)}

  ${c.mainStart()}
    ${c.guardAgainstOutOfBoundsWorkgroupSizes(n)}
    let value = ${r.getByOffset("global_idx")}
      + ${o.getByOffset("global_idx % channels")} + ${a.getByOffset("global_idx")};
    ${l.setByOffset("global_idx","value")}
  }`}},mq=s=>{LW(s.inputs),s.compute(NW(s.inputs))}}),OW,bn,gq,_q,yq,vq,bq,wq,Mq,Tq,Eq,$W,xq,Sq,Cq,Aq,iv,Pq,H0,kq,Iq,Dq,Rq,Fq,Lq,Nq,Oq,$q,Bq,zq,Uq,Vq,Gq,Wq,Hq,iD,jq,VD,GD,qq,Kq,Yq,BW,zW,Xq,f1=Ze(()=>{"use strict";$t(),Ht(),cs(),qt(),OW=(s,e,t,n,i,r,o)=>{let a=Math.ceil(e/4),l="";typeof i=="string"?l=`${i}(a)`:l=i("a");let c=Ue("inputData",t,[a],4),d=bt("outputData",n,[a],4),u=[{name:"vec_size",type:"u32"}];return o&&u.push(...o),`
      ${s.registerUniforms(u).declareVariables(c,d)}

  ${r??""}

  ${s.mainStart()}
    ${s.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.vec_size")}

    let a = ${c.getByOffset("global_idx")};
    ${d.setByOffset("global_idx",l)}
  }`},bn=(s,e,t,n,i,r=s.dataType,o,a)=>{let l=[{type:12,data:Math.ceil(Ie.size(s.dims)/4)}];return o&&l.push(...o),{name:e,shaderCache:{hint:i,inputDependencies:["type"]},getShaderSource:c=>OW(c,Ie.size(s.dims),s.dataType,r,t,n,a),getRunData:c=>({outputs:[{dims:s.dims,dataType:r}],dispatchGroup:{x:Math.ceil(Ie.size(c[0].dims)/64/4)},programUniforms:l})}},gq=s=>{s.compute(bn(s.inputs[0],"Abs","abs"))},_q=s=>{s.compute(bn(s.inputs[0],"Acos","acos"))},yq=s=>{s.compute(bn(s.inputs[0],"Acosh","acosh"))},vq=s=>{s.compute(bn(s.inputs[0],"Asin","asin"))},bq=s=>{s.compute(bn(s.inputs[0],"Asinh","asinh"))},wq=s=>{s.compute(bn(s.inputs[0],"Atan","atan"))},Mq=s=>{s.compute(bn(s.inputs[0],"Atanh","atanh"))},Tq=s=>Mn(s),Eq=(s,e)=>{let t;switch(e.to){case 10:t="vec4<f16>";break;case 1:t="vec4<f32>";break;case 12:t="vec4<u32>";break;case 6:t="vec4<i32>";break;case 9:t="vec4<bool>";break;default:throw new RangeError(`not supported type (specified in attribute 'to' from 'Cast' operator): ${e.to}`)}s.compute(bn(s.inputs[0],"Cast",t,void 0,e.cacheKey,e.to))},$W=s=>{let e,t,n=s.length>=2&&s[1].data!==0,i=s.length>=3&&s[2].data!==0;switch(s[0].dataType){case 1:e=n?s[1].getFloat32Array()[0]:-34028234663852886e22,t=i?s[2].getFloat32Array()[0]:34028234663852886e22;break;case 10:e=n?s[1].getUint16Array()[0]:64511,t=i?s[2].getUint16Array()[0]:31743;break;default:throw new Error("Unsupport data type")}return Mn({min:e,max:t})},xq=(s,e)=>{let t=e||$W(s.inputs),n=Si(s.inputs[0].dataType);s.compute(bn(s.inputs[0],"Clip",i=>`clamp(${i}, vec4<${n}>(uniforms.min), vec4<${n}>(uniforms.max))`,void 0,t.cacheKey,void 0,[{type:s.inputs[0].dataType,data:t.min},{type:s.inputs[0].dataType,data:t.max}],[{name:"min",type:n},{name:"max",type:n}]),{inputs:[0]})},Sq=s=>{s.compute(bn(s.inputs[0],"Ceil","ceil"))},Cq=s=>{s.compute(bn(s.inputs[0],"Cos","cos"))},Aq=s=>{s.compute(bn(s.inputs[0],"Cosh","cosh"))},iv=s=>Mn(s),Pq=(s,e)=>{let t=Si(s.inputs[0].dataType);s.compute(bn(s.inputs[0],"Elu",n=>`elu_vf32(${n})`,`
  const elu_alpha_ = ${t}(${e.alpha});

  fn elu_f32(a: ${t}) -> ${t} {
  return select((exp(a) - 1.0) * elu_alpha_, a, a >= 0.0);
  }

  fn elu_vf32(v: vec4<${t}>) -> vec4<${t}> {
  return vec4(elu_f32(v.x), elu_f32(v.y), elu_f32(v.z), elu_f32(v.w));
  }`,e.cacheKey))},H0=(s="f32")=>`
const r0: ${s} = 0.3275911;
const r1: ${s} = 0.254829592;
const r2: ${s} = -0.284496736;
const r3: ${s} = 1.421413741;
const r4: ${s} = -1.453152027;
const r5: ${s} = 1.061405429;

fn erf_vf32(v: vec4<${s}>) -> vec4<${s}> {
  let absv = abs(v);
  let x = 1.0 / (1.0 + r0 * absv);
  return sign(v) * (1.0 - ((((r5 * x + r4) * x + r3) * x + r2) * x + r1) * x * exp(-absv * absv));
}`,kq=s=>{let e=Si(s.inputs[0].dataType);s.compute(bn(s.inputs[0],"Erf",t=>`erf_vf32(${t})`,H0(e)))},Iq=s=>{s.compute(bn(s.inputs[0],"Exp","exp"))},Dq=s=>{s.compute(bn(s.inputs[0],"Floor","floor"))},Rq=s=>{let e=Si(s.inputs[0].dataType);s.compute(bn(s.inputs[0],"Gelu",t=>`0.5 * ${t} * (1.0 + erf_vf32(${t} * 0.7071067811865475))`,H0(e)))},Fq=(s,e)=>{let t=Si(s.inputs[0].dataType);s.compute(bn(s.inputs[0],"LeakyRelu",n=>`select(leaky_relu_alpha_ * ${n}, ${n}, ${n} >= vec4<${t}>(0.0))`,`const leaky_relu_alpha_ = ${t}(${e.alpha});`,e.cacheKey))},Lq=s=>{s.compute(bn(s.inputs[0],"Not",e=>`!${e}`))},Nq=s=>{s.compute(bn(s.inputs[0],"Neg",e=>`-${e}`))},Oq=s=>{s.compute(bn(s.inputs[0],"Reciprocal",e=>`1.0/${e}`))},$q=s=>{let e=Si(s.inputs[0].dataType);s.compute(bn(s.inputs[0],"Relu",t=>`select(vec4<${e}>(0.0), ${t}, ${t} > vec4<${e}>(0.0))`))},Bq=s=>{s.compute(bn(s.inputs[0],"Sigmoid",e=>`(1.0 / (1.0 + exp(-${e})))`))},zq=s=>Mn(s),Uq=(s,e)=>{let t=Si(s.inputs[0].dataType);s.compute(bn(s.inputs[0],"HardSigmoid",n=>`max(vec4<${t}>(0.0), min(vec4<${t}>(1.0), ${e.alpha} * ${n} + vec4<${t}>(${e.beta})))`,void 0,e.cacheKey))},Vq=s=>{s.compute(bn(s.inputs[0],"Sin","sin"))},Gq=s=>{s.compute(bn(s.inputs[0],"Sinh","sinh"))},Wq=s=>{s.compute(bn(s.inputs[0],"Sqrt","sqrt"))},Hq=s=>{s.compute(bn(s.inputs[0],"Tan","tan"))},iD=s=>`sign(${s}) * (1 - exp(-2 * abs(${s}))) / (1 + exp(-2 * abs(${s})))`,jq=s=>{s.compute(bn(s.inputs[0],"Tanh",iD))},VD=(s="f32")=>`
const fast_gelu_a: ${s} = 0.5;
const fast_gelu_b: ${s} = 0.7978845608028654;
const fast_gelu_c: ${s} = 0.035677408136300125;

fn tanh_v(v: vec4<${s}>) -> vec4<${s}> {
  return ${iD("v")};
}
`,GD=s=>`(fast_gelu_a + fast_gelu_a * tanh_v(${s} * (fast_gelu_c * ${s} * ${s} + fast_gelu_b))) * ${s}`,qq=s=>{let e=Si(s.inputs[0].dataType);s.compute(bn(s.inputs[0],"FastGelu",GD,VD(e),void 0,s.inputs[0].dataType))},Kq=(s,e)=>{let t=Si(s.inputs[0].dataType);return s.compute(bn(s.inputs[0],"ThresholdedRelu",n=>`select(vec4<${t}>(0.0), ${n}, ${n} > thresholded_relu_alpha_)`,`const thresholded_relu_alpha_ = vec4<${t}>(${e.alpha});`,e.cacheKey)),0},Yq=s=>{s.compute(bn(s.inputs[0],"Log","log"))},BW=(s,e)=>`
const alpha = vec4<${s}>(${e});
const one = ${s}(1.0);
const zero = ${s}(0.0);

fn quick_gelu_impl(x: vec4<${s}>) -> vec4<${s}> {
  let v = x *alpha;
  var x1 : vec4<${s}>;
  for (var i = 0; i < 4; i = i + 1) {
    if (v[i] >= zero) {
      x1[i] = one / (one + exp(-v[i]));
    } else {
      x1[i] = one - one / (one + exp(v[i]));
    }
  }
  return x * x1;
}
`,zW=s=>`quick_gelu_impl(${s})`,Xq=(s,e)=>{let t=Si(s.inputs[0].dataType);s.compute(bn(s.inputs[0],"QuickGelu",zW,BW(t,e.alpha),e.cacheKey,s.inputs[0].dataType))}}),UW,VW,Qq,mne=Ze(()=>{"use strict";Ht(),qt(),f1(),UW=s=>{if(s[0].dims.length!==3)throw new Error("input should have 3 dimensions");if(![2560,5120,10240].includes(s[0].dims[2]))throw new Error("hidden state should be 2560, 5120 or 10240");if(s[1].dims.length!==1)throw new Error("bias is expected to have 1 dimensions");if(s[0].dims[2]!==s[1].dims[0])throw new Error("last dimension of input and bias are not the same")},VW=s=>{let e=s[0].dims.slice();e[2]=e[2]/2;let t=Ue("input",s[0].dataType,s[0].dims,4),n=Ue("bias",s[0].dataType,[s[0].dims[2]],4),i=bt("output",s[0].dataType,e,4),r=Ie.size(e)/4,o=Vs(s[0].dataType);return{name:"BiasSplitGelu",getRunData:()=>({outputs:[{dims:e,dataType:s[0].dataType}],dispatchGroup:{x:Math.ceil(r/64)}}),getShaderSource:a=>`
  const M_SQRT2 = sqrt(2.0);
  const halfChannels = ${s[0].dims[2]/4/2}u;

  ${a.declareVariables(t,n,i)}

  ${H0(o)}

  ${a.mainStart()}
    ${a.guardAgainstOutOfBoundsWorkgroupSizes(r)}
    let biasIdx = global_idx % halfChannels;
    let batchIndex = global_idx / halfChannels;
    let inputOffset = biasIdx + batchIndex * halfChannels * 2;
    let valueLeft = input[inputOffset] + bias[biasIdx];
    let valueRight = input[inputOffset + halfChannels] + bias[biasIdx + halfChannels];
    let geluRight = valueRight * 0.5 * (erf_vf32(valueRight / M_SQRT2) + 1);

    ${i.setByOffset("global_idx","valueLeft * geluRight")}
  }`}},Qq=s=>{UW(s.inputs),s.compute(VW(s.inputs))}}),GW,WW,Io,Jq,Zq,eK,tK,nK,sK,iK,rK,oK,aK,gne=Ze(()=>{"use strict";$t(),Ht(),qt(),GW=(s,e,t,n,i,r,o,a,l,c,d,u)=>{let h,p;typeof a=="string"?h=p=(w,C)=>`${a}((${w}),(${C}))`:typeof a=="function"?h=p=a:(h=a.scalar,p=a.vector);let f=bt("outputData",d,n.length,4),_=Ue("aData",l,e.length,4),b=Ue("bData",c,t.length,4),y;if(i)if(r){let w=Ie.size(e)===1,C=Ie.size(t)===1,M=e.length>0&&e[e.length-1]%4===0,S=t.length>0&&t[t.length-1]%4===0;w||C?y=f.setByOffset("global_idx",p(w?`${_.type.value}(${_.getByOffset("0")}.x)`:_.getByOffset("global_idx"),C?`${b.type.value}(${b.getByOffset("0")}.x)`:b.getByOffset("global_idx"))):y=`
            let outputIndices = ${f.offsetToIndices("global_idx * 4u")};
            let offsetA = ${_.broadcastedIndicesToOffset("outputIndices",f)};
            let offsetB = ${b.broadcastedIndicesToOffset("outputIndices",f)};
            ${f.setByOffset("global_idx",p(o||M?_.getByOffset("offsetA / 4u"):`${_.type.value}(${_.getByOffset("offsetA / 4u")}[offsetA % 4u])`,o||S?b.getByOffset("offsetB / 4u"):`${b.type.value}(${b.getByOffset("offsetB / 4u")}[offsetB % 4u])`))}
          `}else y=f.setByOffset("global_idx",p(_.getByOffset("global_idx"),b.getByOffset("global_idx")));else{if(!r)throw new Error("no necessary to use scalar implementation for element-wise binary op implementation.");let w=(C,M,S="")=>{let k=`aData[indexA${M}][componentA${M}]`,T=`bData[indexB${M}][componentB${M}]`;return`
            let outputIndices${M} = ${f.offsetToIndices(`global_idx * 4u + ${M}u`)};
            let offsetA${M} = ${_.broadcastedIndicesToOffset(`outputIndices${M}`,f)};
            let offsetB${M} = ${b.broadcastedIndicesToOffset(`outputIndices${M}`,f)};
            let indexA${M} = offsetA${M} / 4u;
            let indexB${M} = offsetB${M} / 4u;
            let componentA${M} = offsetA${M} % 4u;
            let componentB${M} = offsetB${M} % 4u;
            ${C}[${M}] = ${S}(${h(k,T)});
          `};d===9?y=`
            var data = vec4<u32>(0);
            ${w("data",0,"u32")}
            ${w("data",1,"u32")}
            ${w("data",2,"u32")}
            ${w("data",3,"u32")}
            outputData[global_idx] = dot(vec4<u32>(0x1, 0x100, 0x10000, 0x1000000), vec4<u32>(data));`:y=`
            ${w("outputData[global_idx]",0)}
            ${w("outputData[global_idx]",1)}
            ${w("outputData[global_idx]",2)}
            ${w("outputData[global_idx]",3)}
          `}return`
        ${s.registerUniform("vec_size","u32").declareVariables(_,b,f)}

        ${u??""}

        ${s.mainStart()}
        ${s.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.vec_size")}
        ${y}
      }`},WW=(s,e,t,n,i,r,o=t.dataType)=>{let a=t.dims.map(_=>Number(_)??1),l=n.dims.map(_=>Number(_)??1),c=!Ie.areEqual(a,l),d=a,u=Ie.size(a),h=!1,p=!1,f=[c];if(c){let _=jf.calcShape(a,l,!1);if(!_)throw new Error("Can't perform binary op on the given tensors");d=_.slice(),u=Ie.size(d);let b=Ie.size(a)===1,y=Ie.size(l)===1,w=a.length>0&&a[a.length-1]%4===0,C=l.length>0&&l[l.length-1]%4===0;f.push(b),f.push(y),f.push(w),f.push(C);let M=1;for(let S=1;S<d.length;S++){let k=a[a.length-S],T=l[l.length-S];if(k===T)M*=k;else break}M%4===0?(p=!0,h=!0):(b||y||w||C)&&(h=!0)}else h=!0;return f.push(h),{name:s,shaderCache:{hint:e+f.map(_=>_.toString()).join("_"),inputDependencies:["rank","rank"]},getShaderSource:_=>GW(_,a,l,d,h,c,p,i,t.dataType,n.dataType,o,r),getRunData:()=>({outputs:[{dims:d,dataType:o}],dispatchGroup:{x:Math.ceil(u/64/4)},programUniforms:[{type:12,data:Math.ceil(Ie.size(d)/4)},...St(a,l,d)]})}},Io=(s,e,t,n,i,r)=>{s.compute(WW(e,i??"",s.inputs[0],s.inputs[1],t,n,r))},Jq=s=>{Io(s,"Add",(e,t)=>`${e}+${t}`)},Zq=s=>{Io(s,"Div",(e,t)=>`${e}/${t}`)},eK=s=>{Io(s,"Equal",{scalar:(e,t)=>`u32(${e}==${t})`,vector:(e,t)=>`vec4<u32>(${e}==${t})`},void 0,void 0,9)},tK=s=>{Io(s,"Mul",(e,t)=>`${e}*${t}`)},nK=s=>{let e=Ue("input",s.inputs[0].dataType,s.inputs[0].dims).type.value;Io(s,"Pow",{scalar:(t,n)=>`pow_custom(${t},${n})`,vector:(t,n)=>`pow_vector_custom(${t},${n})`},`
    fn pow_custom(a : ${e}, b : ${e}) -> ${e} {
      if (b == ${e}(0.0)) {
        return ${e}(1.0);
      } else if (a < ${e}(0.0) && f32(b) != floor(f32(b))) {
        return ${e}(pow(f32(a), f32(b))); // NaN
      }
      return select(sign(a), ${e}(1.0), round(f32(abs(b) % ${e}(2.0))) != 1.0) * ${e}(${e==="i32"?"round":""}(pow(f32(abs(a)), f32(b))));
    }
    fn pow_vector_custom(a : vec4<${e}>, b : vec4<${e}>) -> vec4<${e}> {
      // TODO: implement vectorized pow
      return vec4<${e}>(pow_custom(a.x, b.x), pow_custom(a.y, b.y), pow_custom(a.z, b.z), pow_custom(a.w, b.w));
    }
      `)},sK=s=>{Io(s,"Sub",(e,t)=>`${e}-${t}`)},iK=s=>{Io(s,"Greater",{scalar:(e,t)=>`u32(${e}>${t})`,vector:(e,t)=>`vec4<u32>(${e}>${t})`},void 0,void 0,9)},rK=s=>{Io(s,"Less",{scalar:(e,t)=>`u32(${e}<${t})`,vector:(e,t)=>`vec4<u32>(${e}<${t})`},void 0,void 0,9)},oK=s=>{Io(s,"GreaterOrEqual",{scalar:(e,t)=>`u32(${e}>=${t})`,vector:(e,t)=>`vec4<u32>(${e}>=${t})`},void 0,void 0,9)},aK=s=>{Io(s,"LessOrEqual",{scalar:(e,t)=>`u32(${e}<=${t})`,vector:(e,t)=>`vec4<u32>(${e}<=${t})`},void 0,void 0,9)}}),HW,jW,qW,KW,lK,cK,_ne=Ze(()=>{"use strict";$t(),Ht(),cs(),qt(),HW=(s,e)=>{if(!s||s.length<1)throw new Error("too few inputs");let t=0,n=s[t],i=n.dataType,r=n.dims.length;s.forEach((o,a)=>{if(a!==t){if(o.dataType!==i)throw new Error("input tensors should be one type");if(o.dims.length!==r)throw new Error("input tensors should have the same shape");o.dims.forEach((l,c)=>{if(c!==e&&l!==n.dims[c])throw new Error("non concat dimensions must match")})}})},jW=(s,e)=>`
  fn calculateInputIndex(index: u32) -> u32 {
    let sizeInConcatAxis = array<u32, ${s}u>(${e});
    for (var i: u32 = 0u; i < ${s}; i += 1u ) {
      if (index < sizeInConcatAxis[i]) {
        return i;
      }
    }
    return ${s}u;
  }`,qW=(s,e)=>{let t=s.length,n=[];for(let i=0;i<t;++i){let r=e.setByOffset("global_idx",s[i].getByIndices("indices"));t===1?n.push(r):i===0?n.push(`if (inputIndex == ${i}u) { ${r} }`):i===t-1?n.push(`else { ${r} }`):n.push(`else if (inputIndex == ${i}) { ${r} }`)}return n.join(`
`)},KW=(s,e,t,n)=>{let i=Ie.size(t),r=new Array(s.length),o=new Array(s.length),a=0,l=[],c=[],d=[{type:12,data:i}];for(let _=0;_<s.length;++_)a+=s[_].dims[e],r[_]=a,c.push(s[_].dims.length),o[_]=Ue(`input${_}`,n,c[_]),l.push("rank"),d.push({type:12,data:r[_]});for(let _=0;_<s.length;++_)d.push(...St(s[_].dims));d.push(...St(t));let u=bt("output",n,t.length),h=u.indicesGet("indices",e),p=Array.from(Array(r.length).keys()).map(_=>`uniforms.sizeInConcatAxis${_}`).join(","),f=_=>`

  ${(()=>{_.registerUniform("outputSize","u32");for(let b=0;b<s.length;b++)_.registerUniform(`sizeInConcatAxis${b}`,"u32");return _.declareVariables(...o,u)})()}

  ${jW(r.length,p)}

  ${_.mainStart()}
    ${_.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}

    var indices = ${u.offsetToIndices("global_idx")};

    let inputIndex = calculateInputIndex(${h});
    if (inputIndex != 0u) {
      let sizeInConcatAxis = array<u32, ${r.length}u>(${p});
      ${h} -= sizeInConcatAxis[inputIndex - 1u];
    }

    ${qW(o,u)}
  }`;return{name:"Concat",shaderCache:{hint:`${e}`,inputDependencies:l},getRunData:()=>({outputs:[{dims:t,dataType:n}],dispatchGroup:{x:Math.ceil(i/64)},programUniforms:d}),getShaderSource:f}},lK=(s,e)=>{let t=s.inputs,n=t[0].dims,i=Ie.normalizeAxis(e.axis,n.length);HW(t,i);let r=n.slice();r[i]=t.reduce((a,l)=>a+(l.dims.length>i?l.dims[i]:0),0);let o=t.filter(a=>Ie.size(a.dims)>0);s.compute(KW(o,i,r,t[0].dataType),{inputs:o})},cK=s=>Mn({axis:s.axis})}),Zu,eh,th,m1,sh=Ze(()=>{"use strict";$t(),Ht(),Zu=(s,e,t="f32")=>{switch(s.activation){case"Relu":return`value = max(value, ${e}(0.0));`;case"Sigmoid":return`value = (${e}(1.0) / (${e}(1.0) + exp(-value)));`;case"Clip":return`value = clamp(value, ${e}(${t}(uniforms.clip_min)), ${e}(${t}(uniforms.clip_max)));`;case"HardSigmoid":return`value = max(${e}(0.0), min(${e}(1.0), ${t}(uniforms.alpha) * value + ${t}(uniforms.beta)));`;case"LeakyRelu":return`value = select(${t}(uniforms.alpha) * value, value, value >= ${e}(0.0));`;case"Tanh":return`let e2x = exp(-2.0 * abs(value));
              value = sign(value) * (1.0 - e2x) / (1.0 + e2x);
        `;case"":return"";default:throw new Error(`Unsupported activation ${s.activation}`)}},eh=(s,e)=>{s.activation==="Clip"?e.push({type:1,data:s.clipMax},{type:1,data:s.clipMin}):s.activation==="HardSigmoid"?e.push({type:1,data:s.alpha},{type:1,data:s.beta}):s.activation==="LeakyRelu"&&e.push({type:1,data:s.alpha})},th=(s,e)=>{s.activation==="Clip"?e.push({name:"clip_max",type:"f32"},{name:"clip_min",type:"f32"}):s.activation==="HardSigmoid"?e.push({name:"alpha",type:"f32"},{name:"beta",type:"f32"}):s.activation==="LeakyRelu"&&e.push({name:"alpha",type:"f32"})},m1=s=>{let e=s?.activation||"";if(e==="HardSigmoid"){let[t,n]=s?.activation_params||[.2,.5];return{activation:e,alpha:t,beta:n}}else if(e==="Clip"){let[t,n]=s?.activation_params||[L4,N4];return{activation:e,clipMax:n,clipMin:t}}else if(e==="LeakyRelu"){let[t]=s?.activation_params||[.01];return{activation:e,alpha:t}}return{activation:e}}}),ni,dK,g1=Ze(()=>{"use strict";ni=(s,e)=>{switch(s){case 1:return e;case 2:return`vec2<${e}>`;case 3:return`vec3<${e}>`;case 4:return`vec4<${e}>`;default:throw new Error(`${s}-component is not supported.`)}},dK=s=>`
      ${s?"value = value + getBiasByOutputCoords(coords);":""}
      `}),uK,yne=Ze(()=>{"use strict";uK=s=>`
fn getIndexFromCoords4D(coords : vec4<i32>, shape : vec4<i32>) -> i32 {
  return dot(coords, vec4<i32>(
      shape.y * shape.z * shape.w, shape.z * shape.w, shape.w, 1));
}
fn getOutputIndexFromCoords(coords : vec4<i32>) -> i32 {
  return dot(coords, vec4<i32>(
    i32(${s}.x), i32(${s}.y), i32(${s}.z), 1));
}
`}),ov,_1,y1=Ze(()=>{"use strict";$t(),Ht(),qt(),sh(),ov=(s,e,t,n,i)=>{let r=n-t;return`
      ${Array.from({length:t}).map((o,a)=>`
      if (${Et(e.shape,a,e.rank)} != 1) {
        ${e.indicesSet(s,a,Et(i,a+r,n))}
      } else {
        ${e.indicesSet(s,a,0)}
      }`).join("")}
`},_1=(s,e,t,n,i=!1,r)=>{let o=s[0].dims,a=s[1].dims,l=o[o.length-2],c=a[a.length-1],d=o[o.length-1],u=es(c),h=es(d),p=es(l),f=Ie.size(t)/u/p,_=s.length>2,b=n?n.slice(0,-2):t.slice(0,-2),y=[Ie.size(b),l,c],w=[{type:12,data:f},{type:12,data:l},{type:12,data:c},{type:12,data:d}];eh(e,w),w.push(...St(b,o,a)),_&&w.push(...St(s[2].dims)),w.push(...St(y));let C=M=>{let S=u1("batch_dims",s[0].dataType,b.length),k=Ue("a",s[0].dataType,o.length,h),T=Ue("b",s[1].dataType,a.length,u),P=bt("output",s[0].dataType,y.length,u),R=Vs(P.type.tensor),O=Zu(e,P.type.value,R),H=[k,T],X="";if(_){let re=i?u:1;H.push(Ue("bias",s[2].dataType,s[2].dims.length,re)),X=`${i?`value += bias[col / ${re}];`:`value += ${P.type.value}(bias[row + i]);`}`}let z=[{name:"output_size",type:"u32"},{name:"M",type:"u32"},{name:"N",type:"u32"},{name:"K",type:"u32"}];th(e,z);let ne=()=>{let re=`var a_data: ${k.type.value};`;for(let Y=0;Y<h;Y++)re+=`
              let b_data${Y} = b[(b_offset + (k + ${Y}) * uniforms.N + col) / ${u}];`;for(let Y=0;Y<p;Y++){re+=`a_data = a[(a_offset + (row + ${Y}) * uniforms.K + k) / ${h}];`;for(let se=0;se<h;se++)re+=`
            values[${Y}] = fma(${T.type.value}(a_data${h===1?"":`[${se}]`}), b_data${se}, values[${Y}]);
`}return re};return`
  ${M.registerUniforms(z).registerInternalVariables(S).declareVariables(...H,P)}
  ${M.mainStart()}
    ${M.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}
    let col = (global_idx % (uniforms.N / ${u})) * ${u};
    var index1 = global_idx / (uniforms.N / ${u});
    let stride1 = uniforms.M / ${p};
    let row = (index1 % stride1) * ${p};
    let batch = index1 / stride1;

    ${t.length===2?"":`let batch_indices = ${S.offsetToIndices("batch")};`}

    var a_indices: ${k.type.indices};
    ${ov("a_indices",k,k.rank-2,S.rank,"batch_indices")}
    ${k.indicesSet("a_indices",k.rank-2,0)}
    ${k.indicesSet("a_indices",k.rank-1,0)}
    let a_offset = ${k.indicesToOffset("a_indices")};

    var b_indices: ${T.type.indices};
    ${ov("b_indices",T,T.rank-2,S.rank,"batch_indices")}
    ${T.indicesSet("b_indices",T.rank-2,0)}
    ${T.indicesSet("b_indices",T.rank-1,0)}
    let b_offset = ${T.indicesToOffset("b_indices")};
    var values: array<${P.type.value}, ${p}>;
    for (var k: u32 = 0u; k < uniforms.K; k = k + ${h}) {
      ${ne()}
    }
    for (var i = 0u; i < ${p}u; i++) {
      var value = values[i];
      ${X}
      ${O}
      let cur_indices = ${P.type.indices}(batch, row + i, col);
      let offset = ${P.indicesToOffset("cur_indices")};
      ${P.setByOffset(`offset / ${u}`,"value")};
    }
  }
  `};return{name:"MatMulNaive",shaderCache:{hint:`${e.activation};${u};${h};${p};${i}`,inputDependencies:_?["rank","rank","rank"]:["rank","rank"]},getRunData:()=>({outputs:[{dims:r?r(t):t,dataType:s[0].dataType}],dispatchGroup:{x:Math.ceil(f/64)},programUniforms:w}),getShaderSource:C}}}),YW,XW,WD,rD,QW,HD,JW,X0,v1=Ze(()=>{"use strict";$t(),Ht(),qt(),sh(),y1(),g1(),YW=(s,e)=>s?`
        mm_Asub[inputRow][inputCol] = mm_readA(batch,
          kStart + inputRow,
          globalRowStart / innerElementSize + inputCol${e?", batchIndices":""});
        `:`
        mm_Asub[inputRow][inputCol] = mm_readA(batch,
          globalRow + innerRow,
          kStart / innerElementSize + inputCol${e?", batchIndices":""});
        `,XW=(s,e)=>s?`
        let ACached0 = mm_Asub[k * innerElementSize][localRow];
        let ACached1 = mm_Asub[k * innerElementSize + 1][localRow];
        let ACached2 = mm_Asub[k * innerElementSize + 2][localRow];
        ${e===3?"":"let ACached3 = mm_Asub[k * innerElementSize + 3][localRow];"}
        for (var i = 0; i < rowPerThread; i = i + 1) {
          acc[i] = BCached0 * ACached0[i] + acc[i];
          acc[i] = BCached1 * ACached1[i] + acc[i];
          acc[i] = BCached2 * ACached2[i] + acc[i];
          ${e===3?"":"acc[i] = BCached3 * ACached3[i] + acc[i];"}
        }`:`
        for (var i = 0; i < rowPerThread; i = i + 1) {
          let ACached = mm_Asub[tileRow + i][k];
          acc[i] = BCached0 * ACached.x + acc[i];
          acc[i] = BCached1 * ACached.y + acc[i];
          acc[i] = BCached2 * ACached.z + acc[i];
          ${e===3?"":"acc[i] = BCached3 * ACached.w + acc[i];"}
        }`,WD=(s,e,t="f32",n,i=!1,r=32,o=!1,a=32)=>{let l=e[1]*s[1],c=e[0]*s[0],d=i?l:r,u=i?r:l,h=d/e[0],p=r/e[1];if(!((i&&h===4&&s[1]===4||!i&&(h===3||h===4))&&d%e[0]===0&&r%e[1]===0&&s[0]===4))throw new Error(`If transposeA ${i} is true, innerElementSize ${h} and workPerThread[1] ${s[1]} must be 4.
      Otherwise, innerElementSize ${h} must be 3 or 4.
  tileAWidth ${d} must be divisible by workgroupSize[0]${e[0]}. tileInner ${r} must be divisible by workgroupSize[1] ${e[1]}. colPerThread ${s[0]} must be 4.`);return`
var<workgroup> mm_Asub: array<array<vec${h}<${t}>, ${d/h}>, ${u}>;
var<workgroup> mm_Bsub: array<array<vec4<${t}>, ${c/s[0]}>, ${r}>;

const rowPerThread = ${s[1]};
const colPerThread = ${s[0]};
const innerElementSize = ${h};
const tileInner = ${r};

@compute @workgroup_size(${e[0]}, ${e[1]}, ${e[2]})
fn main(@builtin(local_invocation_id) localId : vec3<u32>,
        @builtin(global_invocation_id) globalId : vec3<u32>,
        @builtin(workgroup_id) workgroupId : vec3<u32>) {
  let localRow = i32(localId.y);
  let tileRow = localRow * rowPerThread;
  let tileCol = i32(localId.x);

  let globalRow =i32(globalId.y) * rowPerThread;
  let globalCol = i32(globalId.x);
  let batch = ${o?"0":"i32(globalId.z)"};
  ${n?`let batchIndices = ${n.offsetToIndices("u32(batch)")};`:""}
  let globalRowStart = i32(workgroupId.y) * ${l};

  let num_tiles = ${o?`${Math.ceil(a/r)}`:"(uniforms.dim_inner - 1) / tileInner + 1"};
  var kStart = ${o?`i32(globalId.z) * ${a}`:"0"};

  var acc: array<vec4<${t}>, rowPerThread>;

  // Loop over shared dimension.
  let tileRowB = localRow * ${p};
  for (var t = 0; t < num_tiles; t = t + 1) {
      // Load one tile of A into local memory.
      for (var innerRow = 0; innerRow < rowPerThread; innerRow = innerRow + 1) {
          let inputRow = tileRow + innerRow;
          let inputCol = tileCol;
          ${YW(i,n)}
      }

      // Load one tile of B into local memory.
      for (var innerRow = 0; innerRow < ${p}; innerRow = innerRow + 1) {
          let inputRow = tileRowB + innerRow;
          let inputCol = tileCol;
          mm_Bsub[inputRow][inputCol] = mm_readB(batch, kStart + inputRow, globalCol${n?", batchIndices":""});
      }
      kStart = kStart + tileInner;
      workgroupBarrier();

      // Compute acc values for a single thread.
      for (var k = 0; k < tileInner / innerElementSize; k = k + 1) {
          let BCached0 = mm_Bsub[k * innerElementSize][tileCol];
          let BCached1 = mm_Bsub[k * innerElementSize + 1][tileCol];
          let BCached2 = mm_Bsub[k * innerElementSize + 2][tileCol];
          ${h===3?"":"let BCached3 = mm_Bsub[k * innerElementSize + 3][tileCol];"}

          ${XW(i,h)}
      }

      workgroupBarrier();
  }

  for (var innerRow = 0; innerRow < rowPerThread; innerRow = innerRow + 1) {
      mm_write(batch, globalRow + innerRow, globalCol, acc[innerRow]);
  }
}`},rD=(s,e)=>s?`
            mm_Asub[inputRow][inputCol] = mm_readA(batch,
              kStart + inputRow,
              globalRowStart + inputCol${e?", batchIndices":""});
            `:`
            mm_Asub[inputRow][inputCol] = mm_readA(batch,
              globalRowStart + inputRow,
              kStart + inputCol${e?", batchIndices":""});
            `,QW=s=>s?"let ACached = mm_Asub[k][tileRow + innerRow];":"let ACached = mm_Asub[tileRow + innerRow][k];",HD=(s,e,t="f32",n,i=!1,r=32,o=!1,a=32,l=!1)=>{let c=s[1]*e[1],d=s[0]*e[0],u=i?c:r,h=i?r:c;if(!(h%e[1]===0&&u%e[0]===0&&r%e[1]===0))throw new Error(`tileAHight ${h} must be divisible by workgroupSize[1]${e[1]}, tileAWidth ${u} must be divisible by workgroupSize[0]${e[0]}, tileInner ${r} must be divisible by workgroupSize[1]${e[1]}`);let p=h/e[1],f=u/e[0],_=r/e[1],b=l?`
    let localRow = i32(localId.y);
    let localCol = i32(localId.x);
    let globalRowStart = i32(workgroupId.y) * ${c};
    let globalColStart = i32(workgroupId.x) * ${d};

    // Loop over shared dimension.
    for (var t = 0; t < num_tiles; t = t + 1) {
      // Load one tile of A into local memory.
      for (var inputRow = localRow; inputRow < ${h}; inputRow = inputRow + ${e[1]}) {
        for (var inputCol = localCol; inputCol < ${u}; inputCol = inputCol + ${e[0]}) {
          ${rD(i,n)}
        }
      }
      // Load one tile of B into local memory.
      for (var inputRow = localRow; inputRow < ${r}; inputRow = inputRow + ${e[1]}) {
            for (var inputCol = localCol; inputCol < ${d}; inputCol = inputCol + ${e[0]}) {
          mm_Bsub[inputRow][inputCol] = mm_readB(batch,
            kStart + inputRow,
            globalColStart + inputCol${n?", batchIndices":""});
        }
      }
      kStart = kStart + tileInner;
      workgroupBarrier();

      // Compute acc values for a single thread.
      var BCached : array<${t}, colPerThread>;
      for (var k = 0; k < tileInner; k = k + 1) {
        for (var inner = 0; inner < colPerThread; inner = inner + 1) {
          BCached[inner] = mm_Bsub[k][localCol + inner * ${e[0]}];
        }
        for (var innerRow = 0; innerRow < rowPerThread; innerRow = innerRow + 1) {
          let ACached = ${i?`mm_Asub[k][localRow + innerRow * ${e[1]}];`:`mm_Asub[localRow + innerRow * ${e[1]}][k];`}
          for (var innerCol = 0; innerCol < colPerThread; innerCol = innerCol + 1) {
            acc[innerRow][innerCol] = acc[innerRow][innerCol] +
                ACached * BCached[innerCol];
          }
        }
      }
      workgroupBarrier();
    }
    for (var innerRow = 0; innerRow < rowPerThread; innerRow = innerRow + 1) {
      let gRow = globalRowStart + localRow + innerRow * ${e[1]};
      for (var innerCol = 0; innerCol < colPerThread; innerCol = innerCol + 1) {
        let gCol = globalColStart + localCol + innerCol * ${e[0]};
        mm_write(batch, gRow, gCol, acc[innerRow][innerCol]);
      }
    }
    `:`
let tileRow = i32(localId.y) * rowPerThread;
let tileCol = i32(localId.x) * colPerThread;

let globalRow = i32(globalId.y) * rowPerThread;
let globalCol = i32(globalId.x) * colPerThread;
let globalRowStart = i32(workgroupId.y) * ${c};

let tileRowA = i32(localId.y) * ${p};
let tileColA = i32(localId.x) * ${f};
let tileRowB = i32(localId.y) * ${_};
// Loop over shared dimension.
for (var t = 0; t < num_tiles; t = t + 1) {
  // Load one tile of A into local memory.
  for (var innerRow = 0; innerRow < ${p}; innerRow = innerRow + 1) {
    for (var innerCol = 0; innerCol < ${f}; innerCol = innerCol + 1) {
      let inputRow = tileRowA + innerRow;
      let inputCol = tileColA + innerCol;
      ${rD(i,n)}
    }
  }

  // Load one tile of B into local memory.
  for (var innerRow = 0; innerRow < ${_}; innerRow = innerRow + 1) {
    for (var innerCol = 0; innerCol < colPerThread; innerCol = innerCol + 1) {
      let inputRow = tileRowB + innerRow;
      let inputCol = tileCol + innerCol;
      mm_Bsub[inputRow][inputCol] = mm_readB(batch,
        kStart + inputRow,
        globalCol + innerCol${n?", batchIndices":""});
    }
  }
  kStart = kStart + tileInner;
  workgroupBarrier();

  // Compute acc values for a single thread.
  var BCached : array<${t}, colPerThread>;
  for (var k = 0; k < tileInner; k = k + 1) {
    for (var inner = 0; inner < colPerThread; inner = inner + 1) {
      BCached[inner] = mm_Bsub[k][tileCol + inner];
    }

    for (var innerRow = 0; innerRow < rowPerThread; innerRow = innerRow + 1) {
      ${QW(i)}
      for (var innerCol = 0; innerCol < colPerThread; innerCol = innerCol + 1) {
        acc[innerRow][innerCol] = acc[innerRow][innerCol] + ACached * BCached[innerCol];
      }
    }
  }

  workgroupBarrier();
}

for (var innerRow = 0; innerRow < rowPerThread; innerRow = innerRow + 1) {
  for (var innerCol = 0; innerCol < colPerThread; innerCol = innerCol + 1) {
    mm_write(batch, globalRow + innerRow, globalCol + innerCol,
        acc[innerRow][innerCol]);
  }
}
`;return`
  var<workgroup> mm_Asub : array<array<${t}, ${u}>, ${h}>;
  var<workgroup> mm_Bsub : array<array<${t}, ${d}>, ${r}>;
  const rowPerThread = ${s[1]};
  const colPerThread = ${s[0]};
  const tileInner = ${r};

@compute @workgroup_size(${e[0]}, ${e[1]}, ${e[2]})
fn main(@builtin(local_invocation_id) localId : vec3<u32>,
        @builtin(global_invocation_id) globalId : vec3<u32>,
        @builtin(workgroup_id) workgroupId : vec3<u32>) {
    let batch = ${o?"0":"i32(globalId.z)"};
    ${n?`let batchIndices = ${n.offsetToIndices("u32(batch)")};`:""}
    let num_tiles = ${o?`${Math.ceil(a/r)}`:"(uniforms.dim_inner - 1) / tileInner + 1"};
    var kStart = ${o?`i32(globalId.z) * ${a}`:"0"};

    var acc : array<array<${t}, colPerThread>, rowPerThread>;
    ${b}
  }
`},JW=(s,e,t,n,i=!1)=>{let[r,o,a,l]=n,c=Vs(n[0].type.tensor);return`
    fn mm_readA(batch: i32, row: i32, colIn: i32, batchIndices: ${r.type.indices}) -> ${ni(s,c)} {
      var value = ${ni(s,c)}(0.0);
      let col = colIn * ${s};
      if(row < uniforms.dim_a_outer && col < uniforms.dim_inner)
      {
        var aIndices: ${o.type.indices};
        ${ov("aIndices",o,o.rank-2,r.rank,"batchIndices")}
        ${o.indicesSet("aIndices",o.rank-2,"u32(row)")}
        ${o.indicesSet("aIndices",o.rank-1,"u32(colIn)")}
        value = ${o.getByIndices("aIndices")};
      }
      return value;
    }

    fn mm_readB(batch: i32, row: i32, colIn: i32, batchIndices: ${r.type.indices}) -> ${ni(s,c)} {
      var value = ${ni(s,c)}(0.0);
      let col = colIn * ${s};
      if(row < uniforms.dim_inner && col < uniforms.dim_b_outer)
      {
        var bIndices: ${a.type.indices};
        ${ov("bIndices",a,a.rank-2,r.rank,"batchIndices")}
        ${a.indicesSet("bIndices",a.rank-2,"u32(row)")}
        ${a.indicesSet("bIndices",a.rank-1,"u32(colIn)")}
        value = ${a.getByIndices("bIndices")};
      }
      return value;
    }

    fn mm_write(batch: i32, row: i32, colIn: i32, valueIn: ${ni(s,c)}) {
      let col = colIn * ${s};
      if (row < uniforms.dim_a_outer && col < uniforms.dim_b_outer) {
        var value = valueIn;
        let coords = vec3<i32>(batch, row, colIn);
        ${e?`value = value + ${i?"bias[colIn]":`${ni(s,c)}(bias[row])`};`:""}
        ${t}
        ${l.setByIndices("vec3<u32>(coords)","value")}
      }
    }
    `},X0=(s,e,t,n,i=!1,r)=>{let o=s[0].dims,a=s[1].dims,l=o.slice(0,-2),c=a.slice(0,-2),d=n?n.slice(0,-2):t.slice(0,-2),u=Ie.size(d),h=o[o.length-2],p=o[o.length-1],f=a[a.length-1],_=p%4===0&&f%4===0,b=h<=8?[4,1,1]:[4,4,1],y=[8,8,1],w=[Math.ceil(f/y[0]/b[0]),Math.ceil(h/y[1]/b[1]),Math.ceil(u/y[2]/b[2])],C=_?4:1,M=[...l,h,p/C],S=M.length,k=[...c,p,f/C],T=k.length,P=[u,h,f/C],R=[{type:6,data:h},{type:6,data:f},{type:6,data:p}];eh(e,R),R.push(...St(d,M,k));let O=["rank","rank"],H=s.length>2;H&&(R.push(...St(s[2].dims)),O.push("rank")),R.push(...St(P));let X=z=>{let ne=d.length,re=u1("batchDims",s[0].dataType,ne,1),Y=Vs(s[0].dataType),se=Ue("a",s[0].dataType,S,C),ue=Ue("b",s[1].dataType,T,C),fe=bt("result",s[0].dataType,P.length,C),Pe=[se,ue];if(H){let de=i?C:1;Pe.push(Ue("bias",s[2].dataType,s[2].dims.length,de))}let oe=[{name:"dim_a_outer",type:"i32"},{name:"dim_b_outer",type:"i32"},{name:"dim_inner",type:"i32"}];th(e,oe);let te=Vs(fe.type.tensor),j=Zu(e,fe.type.value,te),G=JW(C,H,j,[re,se,ue,fe],i);return`
  ${z.registerUniforms(oe).registerInternalVariables(re).declareVariables(...Pe,fe)}
  ${G}
  ${_?WD(b,y,Y,re):HD(b,y,Y,re)}
                   `};return{name:"MatMul",shaderCache:{hint:`${b};${e.activation};${_};${i}`,inputDependencies:O},getRunData:()=>({outputs:[{dims:r?r(t):t,dataType:s[0].dataType}],dispatchGroup:{x:w[0],y:w[1],z:w[2]},programUniforms:R}),getShaderSource:X}}}),ZW,hK,vne=Ze(()=>{"use strict";$t(),xl(),qt(),sh(),g1(),yne(),v1(),ZW=(s,e,t,n,i=!1,r,o=4,a=4,l=4,c="f32")=>{let d=R=>{switch(R){case 1:return"resData = x[xIndex];";case 3:return`resData = vec3<${c}>(x[xIndex], x[xIndex + 1], x[xIndex + 2]);`;case 4:return"resData = x[xIndex / 4];";default:throw new Error(`innerElementSize ${R} is not supported.`)}},u=R=>{switch(R){case 1:return"return w[row * i32(uniforms.w_shape[3]) + colIn];";case 4:return"return w[row * i32(uniforms.w_shape[3]) / 4 + colIn];";default:throw new Error(`innerElementSize ${R} is not supported.`)}},h=s?`
    let coord = vec4<i32>(batch, xRow, xCol, xCh);
    `:`
    let coord = vec4<i32>(batch, xCh, xRow, xCol);
    `,p=s?`
    let coords = vec4<i32>(
      batch,
      row / outWidth,
      row % outWidth,
      col);
    `:`
    let coords = vec4<i32>(
      batch,
      row,
      col / outWidth,
      col % outWidth);
    `,f=s?"i32(uniforms.x_shape[1])":"i32(uniforms.x_shape[2])",_=s?"i32(uniforms.x_shape[2])":"i32(uniforms.x_shape[3])",b=s?"row":"col",y=s?"col":"row",w=`
    let inChannels = i32(uniforms.w_shape[2]);
    let outWidth = ${s?"i32(uniforms.result_shape[2])":"i32(uniforms.result_shape[3])"};
    let outRow = ${b} / outWidth;
    let outCol = ${b} % outWidth;

    let WRow = ${y} / (i32(uniforms.w_shape[1]) * inChannels);
    let WCol = ${y} / inChannels % i32(uniforms.w_shape[1]);
    let xRow = outRow * uniforms.stride[0] + uniforms.dilation[0] * WRow - uniforms.pad[0];
    let xCol = outCol * uniforms.stride[1] + uniforms.dilation[1] * WCol - uniforms.pad[1];
    let xCh = ${y} % inChannels;
    var resData = ${ni(o,c)}(0.0);
    // The bounds checking is always needed since we use it to pad zero for
    // the 'same' padding type.
    if (xRow >= 0 && xRow < ${f} && xCol >= 0 && xCol < ${_}) {
      ${h}
      let xIndex = getIndexFromCoords4D(coord, vec4<i32>(uniforms.x_shape));
      ${d(o)}
    }
    return resData;`,C=s?e&&n?`
    let col = colIn * ${o};
    ${w}`:`
    let col = colIn * ${o};
    if (row < uniforms.dim_a_outer && col < uniforms.dim_inner) {
      ${w}
    }
    return ${ni(o,c)}(0.0);`:n&&t?`
    let col = colIn * ${o};
    ${w}`:`
    let col = colIn * ${o};
    if (row < uniforms.dim_inner && col < uniforms.dim_b_outer) {
      ${w}
    }
    return ${ni(o,c)}(0.0);`,M=s?n&&t?u(a):`
    let col = colIn * ${a};
    if (row < uniforms.dim_inner && col < uniforms.dim_b_outer) {
      ${u(a)}
    }
    return ${ni(a,c)}(0.0);`:`
    let col = colIn * ${a};
    if (row < uniforms.dim_inner && col < uniforms.dim_a_outer) {
      ${u(a)}
    }
    return ${ni(a,c)}(0.0);`,S=ni(l,c),k=ni(s?o:a,c),T=ni(s?a:o,c),P=Zu(r,S,c);return`
    fn mm_readA(batch: i32, row : i32, colIn : i32) -> ${k} {
      ${s?C:M}
    }

    fn mm_readB(batch: i32, row : i32, colIn : i32) -> ${T} {
      ${s?M:C}
    }

    fn mm_write(batch: i32, row : i32, colIn : i32, valueIn : ${S}) {
      let col = colIn * ${l};
      if (row < uniforms.dim_a_outer && col < uniforms.dim_b_outer)
      {
      var value = valueIn;
      let outWidth = ${s?"i32(uniforms.result_shape[2])":"i32(uniforms.result_shape[3])"};
      ${p}
      ${dK(i)}
      ${P}
      setOutputAtCoords(coords[0], coords[1], coords[2], coords[3], value);
      }
    }`},hK=(s,e,t,n,i,r,o,a,l)=>{let c=e.format==="NHWC",d=c?s[0].dims[3]:s[0].dims[1],u=t[0],h=c?t[2]:t[3],p=c?t[1]:t[2],f=c?t[3]:t[1],_=c&&(d%4===0||d%3===0)&&f%4===0,b=c?f:h*p,y=c?h*p:f,w=[8,8,1],C=n<=8?[4,1,1]:[4,4,1],M=[Math.ceil(b/w[0]/C[0]),Math.ceil(y/w[1]/C[1]),Math.ceil(u/w[2]/C[2])];dn("verbose",()=>`[conv2d_mm_webgpu] dispatch = ${M}`);let S=_?c&&d%4!==0?3:4:1,k=w[1]*C[1],T=w[0]*C[0],P=Math.max(w[0]*S,w[1]),R=n%k===0,O=i%T===0,H=r%P===0,X=_?[S,4,4]:[1,1,1],z=[{type:6,data:n},{type:6,data:i},{type:6,data:r},{type:6,data:[e.pads[0],e.pads[1]]},{type:6,data:e.strides},{type:6,data:e.dilations}];eh(e,z),z.push(...St(s[0].dims,s[1].dims));let ne=["rank","rank"];o&&(z.push(...St(s[2].dims)),ne.push("rank")),z.push(...St(t));let re=Y=>{let se=[{name:"dim_a_outer",type:"i32"},{name:"dim_b_outer",type:"i32"},{name:"dim_inner",type:"i32"},{name:"pad",type:"i32",length:2},{name:"stride",type:"i32",length:2},{name:"dilation",type:"i32",length:2}];th(e,se);let ue=_?4:1,fe=Vs(s[0].dataType),Pe=`
      fn setOutputAtIndex(flatIndex : i32, value : ${_?`vec4<${fe}>`:fe}) {
        result[flatIndex] = ${_?`vec4<${fe}>`:fe}(value);
      }
      fn setOutputAtCoords(d0 : i32, d1 : i32, d2 : i32, d3 : i32, value : ${_?`vec4<${fe}>`:fe}) {
        let flatIndex = getOutputIndexFromCoords(vec4<i32>(d0, d1, d2, d3));
        setOutputAtIndex(flatIndex ${_?"/ 4":""}, value);
      }`,oe=Ue("x",s[0].dataType,s[0].dims.length,S===3?1:S),te=Ue("w",s[1].dataType,s[1].dims.length,ue),j=[oe,te],G=bt("result",s[0].dataType,t.length,ue);if(o){let de=Ue("bias",s[2].dataType,s[2].dims.length,ue);j.push(de),Pe+=`
        fn getBiasByOutputCoords(coords : vec4<i32>) -> ${_?`vec4<${fe}>`:fe} {
          return bias[coords.${c?"w":"y"}${_?"/ 4":""}];
        }`}return`
        ${uK("uniforms.result_strides")}
        //struct Uniforms { xShape : vec4<i32>, wShape : vec4<i32>, outShape : vec4<i32>,
        //  outShapeStrides: vec3<i32>, filterDims : vec2<i32>, pad : vec2<i32>, stride : vec2<i32>,
        //  dilation : vec2<i32>, dimAOuter : i32, dimBOuter : i32, dimInner : i32 };
        ${Y.registerUniforms(se).declareVariables(...j,G)}
        ${Pe}
        ${ZW(c,R,O,H,o,e,X[0],X[1],X[2],fe)}
        ${_?WD(C,w,fe,void 0,!c,P):HD(C,w,fe,void 0,!c,P,!1,void 0,a)}`};return{name:"Conv2DMatMul",shaderCache:{hint:`${e.cacheKey};${S};${_};${R};${O};${H};${k};${T};${P}`,inputDependencies:ne},getRunData:()=>({outputs:[{dims:l?l(t):t,dataType:s[0].dataType}],dispatchGroup:{x:M[0],y:M[1],z:M[2]},programUniforms:z}),getShaderSource:re}}}),eH,oD,Xy,tH,aD,nH,pK,fK,bne=Ze(()=>{"use strict";$t(),xl(),Ht(),qt(),sh(),g1(),eH=s=>{let e=1;for(let t=0;t<s.length;t++)e*=s[t];return e},oD=s=>typeof s=="number"?[s,s,s]:s,Xy=(s,e)=>e<=1?s:s+(s-1)*(e-1),tH=(s,e,t,n=1)=>{let i=Xy(e,n);return Math.floor((s[0]*(t-1)-t+i)/2)},aD=(s,e,t,n,i)=>{i==null&&(i=tH(s,e[0],n[0]));let r=[0,0,0,t];for(let o=0;o<3;o++)s[o]+2*i>=e[o]&&(r[o]=Math.trunc((s[o]-e[o]+2*i)/n[o]+1));return r},nH=(s,e,t,n,i,r,o,a,l,c)=>{let d,u,h,p;if(s==="VALID"&&(s=0),typeof s=="number"){d={top:s,bottom:s,left:s,right:s,front:s,back:s};let f=aD([e,t,n,1],[a,l,c],1,[i,r,o],s);u=f[0],h=f[1],p=f[2]}else if(Array.isArray(s)){if(!s.every((_,b,y)=>_===y[0]))throw Error(`Unsupported padding parameter: ${s}`);d={top:s[0],bottom:s[1],left:s[2],right:s[3],front:s[4],back:s[5]};let f=aD([e,t,n,1],[a,l,c],1,[i,r,o],s[0]);u=f[0],h=f[1],p=f[2]}else if(s==="SAME_UPPER"){u=Math.ceil(e/i),h=Math.ceil(t/r),p=Math.ceil(n/o);let f=(u-1)*i+a-e,_=(h-1)*r+l-t,b=(p-1)*o+c-n,y=Math.floor(f/2),w=f-y,C=Math.floor(_/2),M=_-C,S=Math.floor(b/2),k=b-S;d={top:C,bottom:M,left:S,right:k,front:y,back:w}}else throw Error(`Unknown padding parameter: ${s}`);return{padInfo:d,outDepth:u,outHeight:h,outWidth:p}},pK=(s,e,t,n,i,r=!1,o="channelsLast")=>{let a,l,c,d,u;if(o==="channelsLast")[a,l,c,d,u]=s;else if(o==="channelsFirst")[a,u,l,c,d]=s;else throw new Error(`Unknown dataFormat ${o}`);let[h,,p,f,_]=e,[b,y,w]=oD(t),[C,M,S]=oD(n),k=Xy(p,C),T=Xy(f,M),P=Xy(_,S),{padInfo:R,outDepth:O,outHeight:H,outWidth:X}=nH(i,l,c,d,b,y,w,k,T,P),z=r?h*u:h,ne=[0,0,0,0,0];return o==="channelsFirst"?ne=[a,z,O,H,X]:o==="channelsLast"&&(ne=[a,O,H,X,z]),{batchSize:a,dataFormat:o,inDepth:l,inHeight:c,inWidth:d,inChannels:u,outDepth:O,outHeight:H,outWidth:X,outChannels:z,padInfo:R,strideDepth:b,strideHeight:y,strideWidth:w,filterDepth:p,filterHeight:f,filterWidth:_,effectiveFilterDepth:k,effectiveFilterHeight:T,effectiveFilterWidth:P,dilationDepth:C,dilationHeight:M,dilationWidth:S,inShape:s,outShape:ne,filterShape:e}},fK=(s,e,t,n,i,r)=>{let o=r==="channelsLast",a=o?s[0].dims[3]:s[0].dims[1],l=!1,c=[64,1,1],d={x:t.map((w,C)=>C)},u=[Math.ceil(eH(d.x.map(w=>t[w]))/c[0]),1,1];dn("verbose",()=>`[conv3d_naive_webgpu] dispatch = ${u}`);let h=l?o&&a%4!==0?3:4:1,p=Ie.size(t),f=[{type:12,data:p},{type:12,data:n},{type:12,data:i},{type:12,data:e.strides},{type:12,data:e.dilations}];eh(e,f),f.push(...St(s[0].dims,s[1].dims));let _=["rank","rank"],b=s.length===3;b&&(f.push(...St(s[2].dims)),_.push("rank")),f.push(...St(t));let y=w=>{let C=[{name:"output_size",type:"u32"},{name:"filter_dims",type:"u32",length:n.length},{name:"pads",type:"u32",length:i.length},{name:"strides",type:"u32",length:e.strides.length},{name:"dilations",type:"u32",length:e.dilations.length}];th(e,C);let M=l?4:1,S=Vs(s[0].dataType),k=Ue("x",s[0].dataType,s[0].dims.length,h===3?1:h),T=Ue("W",s[1].dataType,s[1].dims.length,M),P=[k,T],R=bt("result",s[0].dataType,t.length,M),O="";if(b){let z=Ue("bias",s[2].dataType,s[2].dims.length,M);P.push(z),O+=`
        fn getBiasByOutputCoords(coords : array<u32, 5>) -> ${l?`vec4<${S}>`:S} {
          return bias[${o?Et("coords",4,5):Et("coords",1,5)}${l?"/ 4":""}];
        }`}let H=ni(h,S),X=Zu(e,H,S);return`
            ${O}
            fn getX(d0 : u32, d1 : u32, d2 : u32, d3 : u32, d4 : u32) -> f32 {
              let aIndices = array<u32, 5>(d0, d1, d2, d3, d4);
              return ${k.getByIndices("aIndices")};
            }
            fn getW(d0 : u32, d1 : u32, d2 : u32, d3 : u32, d4 : u32) -> f32 {
              let aIndices = array<u32, 5>(d0, d1, d2, d3, d4);
              return ${T.getByIndices("aIndices")};
            }
          ${w.registerUniforms(C).declareVariables(...P,R)}
          ${w.mainStart()}
          ${w.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}
              let coords = ${R.offsetToIndices("global_idx")};
              let batch = ${Et("coords",0,k.rank)};
              let d2 = ${o?Et("coords",k.rank-1,k.rank):Et("coords",1,k.rank)};
              let xFRCCorner = vec3<u32>(${o?Et("coords",1,k.rank):Et("coords",2,k.rank)},
              ${o?Et("coords",2,k.rank):Et("coords",3,k.rank)},
              ${o?Et("coords",3,k.rank):Et("coords",4,k.rank)}) * uniforms.strides - uniforms.pads;
              let xFCorner = xFRCCorner.x;
              let xRCorner = xFRCCorner.y;
              let xCCorner = xFRCCorner.z;
              let xShapeY = ${o?Et("uniforms.x_shape",1,k.rank):Et("uniforms.x_shape",2,k.rank)};
              let xShapeZ = ${o?Et("uniforms.x_shape",2,k.rank):Et("uniforms.x_shape",3,k.rank)};
              let xShapeW = ${o?Et("uniforms.x_shape",3,k.rank):Et("uniforms.x_shape",4,k.rank)};
              let xShapeU = ${o?Et("uniforms.x_shape",4,k.rank):Et("uniforms.x_shape",1,k.rank)};
              let inputDepthNearestVec4 = (xShapeU / 4) * 4;
              let inputDepthVec4Remainder = xShapeU % 4;

              var value = 0.0;
              for (var wF = 0u; wF < uniforms.filter_dims[0]; wF++) {
                let xF = xFCorner + wF * uniforms.dilations[0];
                if (xF < 0 || xF >= xShapeY) {
                  continue;
                }

                for (var wR = 0u; wR < uniforms.filter_dims[1]; wR++) {
                  let xR = xRCorner + wR * uniforms.dilations[1];
                  if (xR < 0 || xR >= xShapeZ) {
                    continue;
                  }

                  for (var wC = 0u; wC < uniforms.filter_dims[2]; wC++) {
                    let xC = xCCorner + wC * uniforms.dilations[2];
                    if (xC < 0 || xC >= xShapeW) {
                      continue;
                    }

                    for (var d1 = 0u; d1 < inputDepthNearestVec4; d1 += 4) {
                      ${o?`let xValues = vec4<f32>(
                               getX(batch, xF, xR, xC, d1),
                               getX(batch, xF, xR, xC, d1 + 1),
                               getX(batch, xF, xR, xC, d1 + 2),
                               getX(batch, xF, xR, xC, d1 + 3));
                            `:`let xValues = vec4<f32>(
                               getX(batch, d1, xF, xR, xC),
                               getX(batch, d1 + 1, xF, xR, xC),
                               getX(batch, d1 + 2, xF, xR, xC),
                               getX(batch, d1 + 3, xF, xR, xC));
                            `}
                            let wValues = vec4<f32>(
                              getW(d2, d1, wF, wR, wC),
                              getW(d2, d1 + 1, wF, wR, wC),
                              getW(d2, d1 + 2, wF, wR, wC),
                              getW(d2, d1 + 3, wF, wR, wC));
                      value += dot(xValues, wValues);
                    }
                    if (inputDepthVec4Remainder == 1) {
                        ${o?`value += getX(batch, xF, xR, xC, inputDepthNearestVec4)
                          * getW(d2, inputDepthNearestVec4, wF, wR, wC);`:`value += getX(batch, inputDepthNearestVec4, xF, xR, xC)
                          * getW(d2, inputDepthNearestVec4, wF, wR, wC);`}
                    } else if (inputDepthVec4Remainder == 2) {
                      ${o?`let xValues = vec2<f32>(
                        getX(batch, xF, xR, xC, inputDepthNearestVec4),
                        getX(batch, xF, xR, xC, inputDepthNearestVec4 + 1));
                      `:`let xValues = vec2<f32>(
                        getX(batch, inputDepthNearestVec4, xF, xR, xC),
                        getX(batch, inputDepthNearestVec4 + 1, xF, xR, xC));
                    `}
                    let wValues = vec2<f32>(
                      getW(d2, inputDepthNearestVec4, wF, wR, wC),
                      getW(d2, inputDepthNearestVec4 + 1, wF, wR, wC));
                      value += dot(xValues, wValues);
                    } else if (inputDepthVec4Remainder == 3) {
                      ${o?`let xValues = vec3<f32>(
                        getX(batch, xF, xR, xC, inputDepthNearestVec4),
                        getX(batch, xF, xR, xC, inputDepthNearestVec4 + 1),
                        getX(batch, xF, xR, xC, inputDepthNearestVec4 + 2));
                      `:`let xValues = vec3<f32>(
                        getX(batch, inputDepthNearestVec4, xF, xR, xC),
                        getX(batch, inputDepthNearestVec4 + 1, xF, xR, xC),
                        getX(batch, inputDepthNearestVec4 + 2, xF, xR, xC));
                    `}
                    let wValues = vec3<f32>(
                      getW(d2, inputDepthNearestVec4, wF, wR, wC),
                      getW(d2, inputDepthNearestVec4 + 1, wF, wR, wC),
                      getW(d2, inputDepthNearestVec4 + 2, wF, wR, wC));
                      value += dot(xValues, wValues);
                    }
                  }
                }
              }
              ${b?"value = value + getBiasByOutputCoords(coords)":""};
              ${X}
              result[global_idx] = f32(value);
          }`};return{name:"Conv3DNaive",shaderCache:{hint:`${e.cacheKey};${o};${h};${b}`,inputDependencies:_},getRunData:()=>({outputs:[{dims:t,dataType:s[0].dataType}],dispatchGroup:{x:u[0],y:u[1],z:u[2]},programUniforms:f}),getShaderSource:y}}}),mK,gK,wne=Ze(()=>{"use strict";$t(),Ht(),qt(),sh(),mK=(s,e,t,n)=>{let i=s.length>2,r=i?"value += b[output_channel];":"",o=s[0].dims,a=s[1].dims,l=e.format==="NHWC",c=l?t[3]:t[1],d=c/e.group,u=l&&d>=4?es(c):1,h=Ie.size(t)/u,p=[{type:12,data:h},{type:12,data:e.dilations},{type:12,data:[e.strides[0],e.strides[1]]},{type:12,data:[e.pads[0],e.pads[1]]},{type:12,data:d}];eh(e,p),p.push(...St(o,[a[0],a[1],a[2],a[3]/u]));let f=i?["rank","rank","rank"]:["rank","rank"];p.push(...St([t[0],t[1],t[2],t[3]/u]));let _=b=>{let y=bt("output",s[0].dataType,t.length,u),w=Vs(y.type.tensor),C=Zu(e,y.type.value,w),M=Ue("x",s[0].dataType,o.length),S=Ue("w",s[1].dataType,a.length,u),k=[M,S];i&&k.push(Ue("b",s[2].dataType,s[2].dims,u));let T=[{name:"output_size",type:"u32"},{name:"dilations",type:"u32",length:e.dilations.length},{name:"strides",type:"u32",length:2},{name:"pads",type:"u32",length:2},{name:"output_channels_per_group",type:"u32"}];th(e,T);let P=l?`
      for (var wHeight: u32 = 0u; wHeight < uniforms.w_shape[0]; wHeight++) {
        let xHeight = xRCCorner.x + wHeight * uniforms.dilations[0];

        if (xHeight < 0u || xHeight >= uniforms.x_shape[1]) {
          continue;
        }

        for (var wWidth: u32 = 0u; wWidth < uniforms.w_shape[1]; wWidth++) {
          let xWidth = xRCCorner.y + wWidth * uniforms.dilations[1];
          if (xWidth < 0u || xWidth >= uniforms.x_shape[2]) {
            continue;
          }

          for (var wInChannel: u32 = 0u; wInChannel < uniforms.w_shape[2]; wInChannel++) {
            let input_channel = in_channel_offset + wInChannel;
            let xVal = ${M.get("batch","xHeight","xWidth","input_channel")};
            let wVal = ${S.get("wHeight","wWidth","wInChannel","output_channel")};
            value += xVal * wVal;
          }
        }
      }
      `:`
      for (var wInChannel: u32 = 0u; wInChannel < uniforms.w_shape[1]; wInChannel++) {
        let input_channel = in_channel_offset + wInChannel;
        for (var wHeight: u32 = 0u; wHeight < uniforms.w_shape[2]; wHeight++) {
          let xHeight = xRCCorner.x + wHeight * uniforms.dilations[0];

          if (xHeight < 0u || xHeight >= uniforms.x_shape[2]) {
            continue;
          }

          for (var wWidth: u32 = 0u; wWidth < uniforms.w_shape[3]; wWidth++) {
            let xWidth = xRCCorner.y + wWidth * uniforms.dilations[1];
            if (xWidth < 0u || xWidth >= uniforms.x_shape[3]) {
              continue;
            }

            let xVal = ${M.get("batch","input_channel","xHeight","xWidth")};
            let wVal = ${S.get("output_channel","wInChannel","wHeight","wWidth")};
            value += xVal * wVal;
          }
        }
      }
      `;return`
  ${b.registerUniforms(T).declareVariables(...k,y)}

  ${b.mainStart()}
    ${b.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}

    let outputIndices = ${y.offsetToIndices("global_idx")};
    let batch: u32 = outputIndices[0];
    let output_channel: u32 = outputIndices[${l?3:1}];
    let xRCCorner: vec2<u32> = vec2<u32>(outputIndices[${l?1:2}], outputIndices[${l?2:3}]) * uniforms.strides - uniforms.pads;
    let group_id: u32 = output_channel * ${u} / uniforms.output_channels_per_group;
    var in_channel_offset = group_id * uniforms.w_shape[${l?2:1}];

    var value: ${y.type.value} = ${y.type.value}(0);
    ${P}
    ${r}
    ${C}
    ${y.setByOffset("global_idx","value")}
  }`};return{name:"GroupedConv",shaderCache:{hint:`${e.cacheKey}_${u}`,inputDependencies:f},getRunData:()=>({outputs:[{dims:n?n(t):t,dataType:s[0].dataType}],dispatchGroup:{x:Math.ceil(h/64)},programUniforms:p}),getShaderSource:_}},gK=(s,e,t,n)=>{let i=s.length>2,r=es(t[3]),o=es(t[2]),a=Ie.size(t)/r/o,l=[s[0].dims[0],s[0].dims[1],s[0].dims[2],s[0].dims[3]/r],c=[s[1].dims[0],s[1].dims[1],s[1].dims[2],s[1].dims[3]/r],d=[t[0],t[1],t[2],t[3]/r],u=[{type:12,data:a},{type:6,data:[e.strides[0],e.strides[1]]},{type:6,data:[e.pads[0],e.pads[1]]}];eh(e,u),u.push(...St(l,c,d));let h=(o-1)*e.strides[1]+c[1],p=f=>{let _=bt("output",s[0].dataType,d.length,r),b=Vs(_.type.tensor),y=Zu(e,_.type.value,b),w=Ue("x",s[0].dataType,l.length,r),C=Ue("w",s[1].dataType,c.length,r),M=[w,C];i&&M.push(Ue("b",s[2].dataType,s[2].dims,r));let S=i?"value += b[output_channel];":"",k=[{name:"output_size",type:"u32"},{name:"strides",type:"i32",length:2},{name:"pads",type:"i32",length:2}];return th(e,k),`
  ${f.registerUniforms(k).declareVariables(...M,_)}
  ${f.mainStart()}
    ${f.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}
    let width0 = uniforms.output_shape[3];
    let output_channel = global_idx % width0;
    var index1 = global_idx / width0;
    let width1 = uniforms.output_shape[2] / ${o}u;
    let col = (index1 % width1) * ${o}u;
    index1 = index1 / width1;
    let row = index1 % uniforms.output_shape[1];
    let batch = index1 / uniforms.output_shape[1];

    let x_corner = vec2<i32>(i32(row), i32(col)) * uniforms.strides - uniforms.pads;

    var x_vals: array<${w.type.value}, ${h}>;
    var values: array<${_.type.value}, ${o}>;
    let input_channel = output_channel;
    // Use constant instead of uniform can give better performance for w's height/width.
    for (var w_height: u32 = 0u; w_height < ${c[0]}; w_height++) {
      let x_height = x_corner.x + i32(w_height);
      if (x_height >= 0 && u32(x_height) < uniforms.x_shape[1]) {
        for (var i = 0; i < ${h}; i++) {
          let x_width = x_corner.y + i;
          if (x_width >= 0 && u32(x_width) < uniforms.x_shape[2]) {
            x_vals[i] = ${w.get("batch","u32(x_height)","u32(x_width)","input_channel")};
          } else {
            x_vals[i] = ${w.type.value}(0);
          }
        }
        for (var w_width: u32 = 0u; w_width < ${c[1]}; w_width++) {
          let w_val = ${C.get("w_height","w_width","0","output_channel")};
          for (var i = 0u; i < ${o}u; i++) {
            values[i] = fma(x_vals[i * u32(uniforms.strides[1]) + w_width], w_val, values[i]);
          }
        }
      }
    }

    for (var i = 0u; i < ${o}u; i++) {
      var value = values[i];
      ${S}
      ${y}
      ${_.set("batch","row","col + i","output_channel","value")};
    }
  }`};return{name:"GroupedConv-Vectorize",shaderCache:{hint:`${e.cacheKey};${r};${o};${h};${c[0]};${c[1]}`,inputDependencies:i?["rank","rank","type"]:["rank","rank"]},getRunData:()=>({outputs:[{dims:n?n(t):t,dataType:s[0].dataType}],dispatchGroup:{x:Math.ceil(a/64)},programUniforms:u}),getShaderSource:p}}}),sH,$0,iH,B0,jD,lD,rH,oH,qD,Mne=Ze(()=>{"use strict";Ht(),vne(),bne(),v1(),wne(),sh(),y1(),Nc(),sH=(s,e,t,n,i,r)=>{let o=s[0],a=s.slice(r?1:2,r?3:4),l=a.length,c=e[0],d=e.slice(2).map((h,p)=>h+(h-1)*(t[p]-1)),u=a.map((h,p)=>h+n[p]+n[p+l]).map((h,p)=>Math.floor((h-d[p]+i[p])/i[p]));return u.splice(0,0,o),u.splice(r?3:1,0,c),u},$0=[2,3,1,0],iH=(s,e)=>{if(!s||s.length!==2&&s.length!==3)throw new Error("Conv requires 2 or 3 inputs");if(s[0].dims.length>5)throw new Error("greater than 5D is not supported");if(s[0].dims.length!==s[1].dims.length)throw new Error("filter does not have same dimension as input");let t=s[0].dims[e.format==="NHWC"?s[0].dims.length-1:1],n=s[1].dims[1]*e.group;if(t!==n)throw new Error("FILTER_IN_CHANNEL should be equal to DATA_CHANNEL");if(s.length===3&&(s[2].dims.length!==1||s[1].dims[0]!==s[2].dims[0]))throw new Error("invalid bias");let i=s[0].dims.length-2;if(e.dilations.length!==i)throw new Error(`dilations should be ${i}D`);if(e.strides.length!==i)throw new Error(`strides should be ${i}D`);if(e.pads.length!==i*2)throw new Error(`pads should be ${i*2}D`);if(e.kernelShape.length!==0&&e.kernelShape.length!==s[1].dims.length-2)throw new Error("invalid kernel shape")},B0=(s,e)=>{let t=s.kernelShape.slice();t.length<e[1].dims.length-2&&t.push(...Array(e[1].dims.length-2-t.length).fill(0));for(let r=2;r<e[1].dims.length;++r)t[r-2]===0&&(t[r-2]=e[1].dims[r]);let n=s.pads.slice();K0.adjustPadsBasedOnAutoPad(e[0].dims,s.strides,s.dilations,t,n,s.format==="NHWC",s.autoPad);let i=Object.assign({},s);return Object.assign(i,{kernelShape:t,pads:n}),i},jD=s=>{let e=m1(s),t=s.format,n=["NOTSET","VALID","SAME_UPPER","SAME_LOWER"][s.auto_pad],i=s.dilations,r=s.group,o=s.kernel_shape,a=s.pads,l=s.strides,c=s.w_is_const();return{autoPad:n,format:t,dilations:i,group:r,kernelShape:o,pads:a,strides:l,wIsConst:c,...e,cacheKey:`${s.format};${e.activation};`}},lD=(s,e,t,n)=>{let i=t.format==="NHWC",r=sH(e[0].dims,e[1].dims,t.dilations,t.pads,t.strides,i);if(t.group!==1){let k=[e[0]];if(i){let T=s.kernelCustomData.wT??s.compute(Er(e[1],$0),{inputs:[1],outputs:[t.wIsConst?-2:-1]})[0];t.wIsConst&&!s.kernelCustomData.wT&&(s.kernelCustomData.wT=T),k.push(T)}else k.push(e[1]);e.length===3&&k.push(e[2]),!s.adapterInfo.isArchitecture("ampere")&&i&&e[1].dims[0]===t.group&&e[1].dims[1]===1&&t.dilations[0]===1&&t.dilations[1]===1?s.compute(gK(k,t,r,n),{inputs:k}):s.compute(mK(k,t,r,n),{inputs:k});return}let o=e.length===3,a=e[0].dims[i?1:2],l=e[0].dims[i?2:3],c=e[0].dims[i?3:1],d=e[1].dims[2],u=e[1].dims[3],h=r[i?1:2],p=r[i?2:3],f=r[i?3:1],_=i&&d===a&&u===l&&t.pads[0]===0&&t.pads[1]===0;if(_||d===1&&u===1&&t.dilations[0]===1&&t.dilations[1]===1&&t.strides[0]===1&&t.strides[1]===1&&t.pads[0]===0&&t.pads[1]===0){let k=r[0],T,P,R,O=[];if(i){let z=s.kernelCustomData.wT??s.compute(Er(e[1],$0),{inputs:[1],outputs:[t.wIsConst?-2:-1]})[0];if(t.wIsConst&&!s.kernelCustomData.wT&&(s.kernelCustomData.wT=z),_){let ne=a*l*c;T=e[0].reshape([1,k,ne]),P=z.reshape([1,ne,f]),R=[1,k,f]}else T=e[0].reshape([k,a*l,c]),P=z.reshape([1,c,f]),R=[k,h*p,f];O.push(T),O.push(P)}else T=e[0].reshape([k,c,a*l]),P=e[1].reshape([1,f,c]),R=[k,f,h*p],O.push(P),O.push(T);o&&O.push(e[2]);let H=R[2],X=O[0].dims[O[0].dims.length-1];H<8&&X<8?s.compute(_1(O,t,r,R,i,n),{inputs:O}):s.compute(X0(O,t,r,R,i,n),{inputs:O});return}let b=!0,y=s.kernelCustomData.wT??s.compute(Er(e[1],$0),{inputs:[1],outputs:[t.wIsConst?-2:-1]})[0];t.wIsConst&&!s.kernelCustomData.wT&&(s.kernelCustomData.wT=y);let w=[e[0],y];o&&w.push(e[2]);let C=i?h*p:f,M=i?f:h*p,S=d*u*c;s.compute(hK(w,t,r,C,M,S,o,b,n),{inputs:w})},rH=(s,e)=>{let t=e.format==="NHWC",n=[s.inputs[0].reshape(t?[s.inputs[0].dims[0],1,s.inputs[0].dims[1],s.inputs[0].dims[2]]:[s.inputs[0].dims[0],s.inputs[0].dims[1],1,s.inputs[0].dims[2]]),s.inputs[1].reshape([s.inputs[1].dims[0],s.inputs[1].dims[1],1,s.inputs[1].dims[2]])];s.inputs.length===3&&n.push(s.inputs[2]);let i=[0,e.pads[0],0,e.pads[1]],r=[1].concat(e.strides),o=[1].concat(e.dilations),a=[1].concat(e.kernelShape),l=B0({...e,pads:i,strides:r,dilations:o,kernelShape:a},n);lD(s,n,l,c=>t?[c[0],c[2],c[3]]:[c[0],c[1],c[3]])},oH=(s,e,t)=>{let n=t.format==="NHWC"?"channelsLast":"channelsFirst",i=B0(t,e),r=t.autoPad==="NOTSET"?t.pads:t.autoPad,o=pK(e[0].dims,e[1].dims,t.strides,t.dilations,r,!1,n);s.compute(fK(e,i,o.outShape,[o.filterDepth,o.filterHeight,o.filterWidth],[o.padInfo.front,o.padInfo.top,o.padInfo.left],n))},qD=(s,e)=>{if(iH(s.inputs,e),s.inputs[0].dims.length===3)rH(s,e);else if(s.inputs[0].dims.length===5)oH(s,s.inputs,e);else{let t=B0(e,s.inputs);lD(s,s.inputs,t)}}}),_K,Tne=Ze(()=>{"use strict";$t(),xl(),Ht(),qt(),_K=(s,e,t)=>{let n=s.length>2,i=e.outputShape,r=e.format==="NHWC",o=e.group,a=s[1].dims,l=a[2]/o,c=a[3],d=r?es(l):1,u=r&&c===1&&l>=4,h=u?Math.floor(l/4)*4:Math.floor(l/d)*d,p=l-h,f=r?es(c):1,_=r?c===1?d:f:1,b=Ie.size(i)/f,y=[Math.ceil(b/64),1,1];dn("verbose",()=>`[conv2d_backprop_webgpu] dispatch = ${y}`);let w=["rank","rank"],C=[e.strides[0],e.strides[1]],M=[e.kernelShape[r?1:2],e.kernelShape[r?2:3]],S=[e.dilations[0],e.dilations[1]],k=[M[0]+(e.dilations[0]<=1?0:(e.kernelShape[r?1:2]-1)*(e.dilations[0]-1)),M[1]+(e.dilations[1]<=1?0:(e.kernelShape[r?2:3]-1)*(e.dilations[1]-1))],T=[k[0]-1-Math.floor((e.pads[0]+e.pads[2])/2),k[1]-1-Math.floor((e.pads[1]+e.pads[3])/2)],P=[{type:12,data:b},{type:12,data:C},{type:12,data:M},{type:12,data:S},{type:12,data:k},{type:6,data:T},{type:12,data:h},{type:12,data:l},{type:12,data:c},...St(s[0].dims,s[1].dims)];n&&(P.push(...St(s[2].dims)),w.push("rank")),P.push(...St(i));let R=O=>{let H=[{name:"output_size",type:"u32"},{name:"strides",type:"u32",length:C.length},{name:"filter_dims",type:"u32",length:M.length},{name:"dilations",type:"u32",length:M.length},{name:"effective_filter_dims",type:"u32",length:k.length},{name:"pads",type:"i32",length:T.length},{name:"input_channels_per_group_int",type:"u32"},{name:"input_channels_per_group",type:"u32"},{name:"output_channels_per_group",type:"u32"}],X=Vs(s[0].dataType),z=r?1:2,ne=r?2:3,re=r?3:1,Y=Ue("W",s[1].dataType,s[1].dims.length,_),se=Ue("Dy",s[0].dataType,s[0].dims.length,d),ue=[se,Y];n&&ue.push(Ue("bias",s[2].dataType,[i[re]].length,f));let fe=bt("result",s[0].dataType,i.length,f),Pe=()=>{let j="";if(u)d===4?j+=`
        let xValue = ${se.getByOffset("x_offset")};
        let wValue = ${Y.getByOffset("w_offset")};
        dotProd = dotProd + dot(xValue, wValue);
        x_offset += 1u;
        w_offset += 1u;`:d===2?j+=`
          dotProd = dotProd + dot(vec4<${X}>(${se.getByOffset("x_offset")}, ${se.getByOffset("x_offset + 1u")}), vec4<${X}>(${Y.getByOffset("w_offset")}, ${Y.getByOffset("w_offset + 1u")}));
          x_offset += 2u;
          w_offset += 2u;`:d===1&&(j+=`
          dotProd = dotProd + dot(vec4<${X}>(${se.getByOffset("x_offset")}, ${se.getByOffset("x_offset + 1u")}, ${se.getByOffset("x_offset + 2u")}, ${se.getByOffset("x_offset + 3u")}), vec4<${X}>(${Y.getByOffset("w_offset")}, ${Y.getByOffset("w_offset + 1u")}, ${Y.getByOffset("w_offset + 2u")}, ${Y.getByOffset("w_offset + 3u")}));
          x_offset += 4u;
          w_offset += 4u;`);else if(j+=`
                  let xValue = ${r?se.getByOffset(`${se.indicesToOffset(`${se.type.indices}(batch, idyR, idyC, inputChannel)`)} / ${d}`):se.get("batch","inputChannel","idyR","idyC")};
        `,d===1)j+=`
          let w_offset = ${Y.indicesToOffset(`${Y.type.indices}(u32(wRPerm), u32(wCPerm), inputChannel, wOutChannel)`)};
          let wValue = ${Y.getByOffset(`w_offset / ${_}`)};
          dotProd = dotProd + xValue * wValue;`;else for(let G=0;G<d;G++)j+=`
            let wValue${G} = ${Y.getByOffset(`${Y.indicesToOffset(`${Y.type.indices}(u32(wRPerm), u32(wCPerm), inputChannel + ${G}, wOutChannel)`)} / ${_}`)};
            dotProd = dotProd + xValue[${G}] * wValue${G};`;return j},oe=()=>{if(p===0)return"";if(!u)throw new Error(`packInputAs4 ${u} is not true.`);let j="";if(d===1){j+="dotProd = dotProd";for(let G=0;G<p;G++)j+=`
            + ${se.getByOffset(`x_offset + ${G}`)} * ${Y.getByOffset(`w_offset + ${G}`)}`;j+=";"}else if(d===2){if(p!==2)throw new Error(`Invalid inputChannelsRemainder ${p}.`);j+=`
          let xValue = ${se.getByOffset("x_offset")};
          let wValue = ${Y.getByOffset("w_offset")};
          dotProd = dotProd + dot(xValue, wValue);`}return j},te=`
            let outputIndices = ${fe.offsetToIndices(`global_idx * ${f}`)};
            let batch = ${fe.indicesGet("outputIndices",0)};
            let d1 = ${fe.indicesGet("outputIndices",re)};
            let r = ${fe.indicesGet("outputIndices",z)};
            let c = ${fe.indicesGet("outputIndices",ne)};
            let dyCorner = vec2<i32>(i32(r), i32(c)) - uniforms.pads;
            let dyRCorner = dyCorner.x;
            let dyCCorner = dyCorner.y;
            let groupId = d1 / uniforms.output_channels_per_group;
            let wOutChannel = d1 - groupId * uniforms.output_channels_per_group;
            // Convolve dy(?, ?, d2) with w(:, :, d1, d2) to compute dx(xR, xC, d1).
            // ? = to be determined. : = across all values in that axis.
            var dotProd = ${fe.type.value}(0.0);
            var wR: u32 = 0;
            if (uniforms.dilations.x == 1) {
              // Minimum wR >= 0 that satisfies (dyRCorner + wR) % (uniforms.strides.x) == 0
              wR = u32(((dyRCorner + i32(uniforms.strides.x) - 1) / i32(uniforms.strides.x)) * i32(uniforms.strides.x) - dyRCorner);
            }
            for (; wR < uniforms.effective_filter_dims.x; wR = wR + 1) {
              if (wR % uniforms.dilations.x != 0) {
                continue;
              }
              let dyR = (${X}(dyRCorner) + ${X}(wR)) / ${X}(uniforms.strides[0]);
              let wRPerm = uniforms.filter_dims.x - 1 - wR / uniforms.dilations.x;
              if (dyR < 0.0 || dyR >= ${X}(uniforms.Dy_shape[${z}]) || fract(dyR) > 0.0 ||
                  wRPerm < 0) {
                continue;
              }
              let idyR: u32 = u32(dyR);
              var wC: u32 = 0;
              if (uniforms.dilations.y == 1) {
                // Minimum wC >= 0 that satisfies (dyCCorner + wC) % (uniforms.strides.y) == 0
                wC = u32(((dyCCorner + i32(uniforms.strides.y) - 1) / i32(uniforms.strides.y)) * i32(uniforms.strides.y) - dyCCorner);
              }
              for (; wC < uniforms.effective_filter_dims.y; wC = wC + 1) {
                if (wC % uniforms.dilations.y != 0) {
                  continue;
                }
                let dyC = (${X}(dyCCorner) + ${X}(wC)) / ${X}(uniforms.strides.y);
                let wCPerm = uniforms.filter_dims.y - 1 - wC / uniforms.dilations.y;
                if (dyC < 0.0 || dyC >= ${X}(uniforms.Dy_shape[${ne}]) ||
                    fract(dyC) > 0.0 || wCPerm < 0) {
                  continue;
                }
                let idyC: u32 = u32(dyC);
                var inputChannel = groupId * uniforms.input_channels_per_group;
                ${u?`
                var x_offset = ${se.indicesToOffset(`${se.type.indices}(batch, idyR, idyC, inputChannel)`)} / ${d};
                var w_offset = ${Y.indicesToOffset(`${Y.type.indices}(wRPerm, wCPerm, inputChannel, wOutChannel)`)} / ${_};
                  `:""}
                for (var d2: u32 = 0; d2 < uniforms.input_channels_per_group_int; d2 = d2 + ${u?4:d}) {
                  ${Pe()}
                  inputChannel = inputChannel + ${u?4:d};
                }
                ${oe()}
                wC = wC + uniforms.strides.y - 1;
              }
              wR = wR + uniforms.strides[0] - 1;
            }
            let value = dotProd${n?` + bias[d1 / ${f}]`:""};
            ${fe.setByOffset("global_idx","value")};
          `;return`
    ${O.registerUniforms(H).declareVariables(...ue,fe)}
      ${O.mainStart()}
      ${O.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")};
    ${te}}`};return{name:"ConvTranspose2D",shaderCache:{hint:`${e.cacheKey};${d}${_}${f}${u}${p}`,inputDependencies:w},getRunData:()=>({dispatchGroup:{x:y[0],y:y[1],z:y[2]},outputs:[{dims:t?t(i):i,dataType:s[0].dataType}],programUniforms:P}),getShaderSource:R}}}),aH,lH,cH,cD,yK,dH,dD,uH,vK,Ene=Ze(()=>{"use strict";Tne(),sh(),Nc(),aH=(s,e,t,n,i,r)=>(s-1)*e+t+(n-1)*i+1-r,lH=(s,e,t,n,i)=>{let r=Math.floor(s/2);e==="SAME_UPPER"?(t[n]=r,t[i]=s-r):e==="SAME_LOWER"&&(t[n]=s-r,t[i]=r)},cH=(s,e,t,n,i,r,o,a,l,c)=>{let d=s.length-2,u=c.length===0;l.length<d&&l.push(...Array(d-l.length).fill(0));let h=s[0],p=e[a?3:1]*i;for(let f=0,_=s.length-d-(a?1:0);f<d;++f,++_){let b=s[_],y=u?b*o[f]:c[f],w=aH(b,o[f],r[f],e[_],t[f],y);lH(w,n,r,f,f+d),u&&c.push(o[f]*(b-1)+l[f]+(e[_]-1)*t[f]+1-r[f]-r[f+d])}c.splice(0,0,h),c.splice(a?3:1,0,p)},cD=(s,e)=>{let t=s.kernelShape.slice();if(s.kernelShape.length===0||s.kernelShape.reduce((u,h)=>u*h,1)===0){t.length=0;for(let u=2;u<e[1].dims.length;++u)t.push(e[1].dims[u])}let n=s.format==="NHWC";t.splice(0,0,e[1].dims[0]),t.splice(n?3:1,0,e[1].dims[1]);let i=s.pads.slice(),r=s.outputShape.slice(),o=s.outputPadding.slice(),a=e[0].dims,l=s.dilations.slice();if(l.reduce((u,h)=>u+h,0)===0){let u=e[0].dims.length-2;l=new Array(u).fill(1)}let c=s.strides.slice();if(c.reduce((u,h)=>u+h,0)===0){let u=e[0].dims.length-2;c=new Array(u).fill(1)}cH(a,t,l,s.autoPad,s.group,i,c,n,o,r);let d=Object.assign({},s);return Object.assign(d,{kernelShape:t,pads:i,outputPadding:o,outputShape:r,dilations:l,strides:c}),d},yK=s=>{let e=m1(s),t=s.format,n=["NOTSET","VALID","SAME_UPPER","SAME_LOWER"][typeof s.autoPad>"u"?0:s.autoPad],i=s.dilations,r=s.group,o=s.kernelShape,a=s.pads,l=s.strides,c=s.wIsConst(),d=s.outputPadding,u=s.outputShape;return{autoPad:n,format:t,dilations:i,group:r,kernelShape:o,outputPadding:d,outputShape:u,pads:a,strides:l,wIsConst:c,...e,cacheKey:`${s.format};${e.activation};`}},dH=(s,e)=>{if(!s||s.length!==2&&s.length!==3)throw new Error("Conv requires 2 or 3 inputs");if(s[0].dims.length!==4&&s[0].dims.length!==3)throw new Error("currently only support 2-dimensional conv");if(s[0].dims.length!==s[1].dims.length)throw new Error("filter does not have same dimension as input");let t=s[0].dims[e.format==="NHWC"?s[0].dims.length-1:1],n=s[1].dims[0];if(t!==n)throw new Error("FILTER_IN_CHANNEL should be equal to DATA_CHANNEL");let i=s[1].dims[1]*e.group;if(s.length===3&&(s[2].dims.length!==1||s[2].dims[0]!==i))throw new Error("invalid bias");let r=s[0].dims.length-2;if(e.dilations.reduce((o,a)=>o+a,0)>0&&e.dilations.length!==r)throw new Error(`dilations should be ${r}D`);if(e.strides.reduce((o,a)=>o+a,0)>0&&e.strides.length!==r)throw new Error(`strides should be ${r}D`);if(e.pads.reduce((o,a)=>o+a,0)>0&&e.pads.length!==r*2)throw new Error(`pads should be ${r*2}D`);if(e.outputPadding.length!==r&&e.outputPadding.length!==0)throw new Error(`output_padding should be ${r}D`);if(e.kernelShape.reduce((o,a)=>o+a,0)>0&&e.kernelShape.length!==0&&e.kernelShape.length!==s[1].dims.length-2)throw new Error("invalid kernel shape");if(e.outputShape.length!==0&&e.outputShape.length!==s[0].dims.length-2)throw new Error("invalid output shape")},dD=(s,e,t,n)=>{let i=s.kernelCustomData.wT??s.compute(Er(e[1],[2,3,0,1]),{inputs:[1],outputs:[t.wIsConst?-2:-1]})[0];t.wIsConst&&!s.kernelCustomData.wT&&(s.kernelCustomData.wT=i);let r=[e[0],i];e.length===3&&r.push(e[2]),s.compute(_K(r,t,n),{inputs:r})},uH=(s,e)=>{let t=e.format==="NHWC",n=[s.inputs[0].reshape(t?[s.inputs[0].dims[0],1,s.inputs[0].dims[1],s.inputs[0].dims[2]]:[s.inputs[0].dims[0],s.inputs[0].dims[1],1,s.inputs[0].dims[2]]),s.inputs[1].reshape([s.inputs[1].dims[0],s.inputs[1].dims[1],1,s.inputs[1].dims[2]])];s.inputs.length===3&&n.push(s.inputs[2]);let i=e.kernelShape;(i.length===0||i[0]===0)&&(i=[s.inputs[1].dims[2]]);let r=e.dilations;(r.length===0||r[0]===0)&&(r=[1]);let o=e.strides;(o.length===0||o[0]===0)&&(o=[1]);let a=e.pads;a.length===0&&(a=[0,0]),a=[0,a[0],0,a[1]],o=[1].concat(o),r=[1].concat(r),i=[1].concat(i);let l=e.outputPadding;l=[0].concat(l);let c=cD({...e,pads:a,strides:o,dilations:r,kernelShape:i,outputPadding:l},n);dD(s,n,c,d=>t?[d[0],d[2],d[3]]:[d[0],d[1],d[3]])},vK=(s,e)=>{if(dH(s.inputs,e),s.inputs[0].dims.length===3)uH(s,e);else{let t=cD(e,s.inputs);dD(s,s.inputs,t)}}}),hH,bK,wK,xne=Ze(()=>{"use strict";$t(),Ht(),cs(),qt(),hH=(s,e,t,n)=>{let i=Ie.size(e),r=e.length,o=Ue("input",s,r),a=bt("output",s,r),l=t.dataType===6?t.getInt32Array()[0]:Number(t.getBigInt64Array()[0]),c=Ie.normalizeAxis(l,r),d=u=>{let h=` i32(${o.indicesGet("inputIndices","uniforms.axis")}) `,p=Et("uniforms.input_shape","uniforms.axis",r),f=n.reverse?h+(n.exclusive?" + 1":""):"0",_=n.reverse?p:h+(n.exclusive?"":" + 1");return`
                ${u.registerUniform("outputSize","u32").registerUniform("axis","u32").declareVariables(o,a)}
                ${u.mainStart()}
                  ${u.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}
                  var inputIndices = ${a.offsetToIndices("global_idx")};
                  var sum = ${a.type.value}(0);
                  let first : i32 = ${f};
                  let last : i32 = ${_};
                  for (var i : i32 = first; i < last; i++) {
                    ${o.indicesSet("inputIndices","uniforms.axis","u32(i)")};
                    sum = sum + ${o.getByIndices("inputIndices")};
                  }
                  ${a.setByOffset("global_idx","sum")};
                }`};return{name:"CumSum",shaderCache:{hint:n.cacheKey,inputDependencies:["rank"]},getRunData:()=>({outputs:[{dims:e,dataType:s}],dispatchGroup:{x:Math.ceil(i/64)},programUniforms:[{type:12,data:i},{type:12,data:c},...St(e,e)]}),getShaderSource:d}},bK=(s,e)=>{let t=s.inputs[0].dims,n=s.inputs[0].dataType,i=s.inputs[1];s.compute(hH(n,t,i,e),{inputs:[0]})},wK=s=>{let e=s.exclusive===1,t=s.reverse===1;return Mn({exclusive:e,reverse:t})}}),pH,fH,mH,MK,TK,Sne=Ze(()=>{"use strict";$t(),Ht(),cs(),qt(),pH=s=>{if(!s||s.length!==1)throw new Error("DepthToSpace requires 1 input.");if(s[0].dims.length!==4)throw new Error("DepthToSpace requires 4D input.")},fH=(s,e,t,n)=>{let i=[];i.push(`fn perm(i: ${n.type.indices}) -> ${t.type.indices} {
    var a: ${t.type.indices};`);for(let r=0;r<e;++r)i.push(t.indicesSet("a",s[r],`i[${r}]`));return i.push("return a;}"),i.join(`
`)},mH=(s,e)=>{let t,n,i,r,o,a,l=e.format==="NHWC",c=e.blocksize,d=e.mode==="DCR";l?([t,n,i,r]=s.dims,o=d?[t,n,i,c,c,r/c**2]:[t,n,i,r/c**2,c,c],a=d?[0,1,3,2,4,5]:[0,1,4,2,5,3]):([t,n,i,r]=[s.dims[0],s.dims[2],s.dims[3],s.dims[1]],o=d?[t,c,c,r/c**2,n,i]:[t,r/c**2,c,c,n,i],a=d?[0,3,4,1,5,2]:[0,1,4,2,5,3]);let u=s.reshape(o),h=u.dims.length,p=s.dataType,f=Ue("a",p,h),_=bt("output",p,h),b=y=>`
  ${y.registerUniform("output_size","u32").declareVariables(f,_)}

  ${fH(a,h,f,_)}

  ${y.mainStart()}
    ${y.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}

    let indices = ${_.offsetToIndices("global_idx")};
    let aIndices = perm(indices);

    ${_.setByOffset("global_idx",f.getByIndices("aIndices"))}
  }`;return{name:"DepthToSpace",shaderCache:{hint:`${s.dims};${e.blocksize};${e.mode}`,inputDependencies:["rank"]},getRunData:y=>{let w=l?[t,n*c,i*c,r/c**2]:[t,r/c**2,n*c,i*c],C=Ie.size(w),M=u.dims,S=Ie.sortBasedOnPerm(M,a);return{outputs:[{dims:w,dataType:y[0].dataType}],dispatchGroup:{x:Math.ceil(C/64)},programUniforms:[{type:12,data:C},...St(M,S)]}},getShaderSource:b}},MK=(s,e)=>{pH(s.inputs),s.compute(mH(s.inputs[0],e))},TK=s=>Mn({blocksize:s.blocksize,mode:s.mode,format:s.format})}),z0,Qy,uD,gH,_H,yH,vH,hD,bH,EK,xK,Cne=Ze(()=>{"use strict";$t(),Ht(),cs(),qt(),z0="[a-zA-Z]|\\.\\.\\.",Qy="("+z0+")+",uD="^"+Qy+"$",gH="("+Qy+",)*"+Qy,_H="^"+gH+"$",yH=class{constructor(s=-1){this.symbolToIndices=new Map,this.inputIndex=s}addSymbol(s,e){let t=this.symbolToIndices.get(s);t===void 0?t=[e]:t.push(e),this.symbolToIndices.set(s,t)}},vH=class{constructor(s,e){this.equation=e,this.hasEllipsis=!1,this.symbolToInfo=new Map,this.lhs=new Array,this.outputDims=[];let[t,n]=e.includes("->")?e.split("->",2):[e,""];if(!t.match(RegExp(_H)))throw new Error("Invalid LHS term");if(t.split(",").forEach((i,r)=>{let o=s[r].dims.slice();if(!i.match(RegExp(uD)))throw new Error("Invalid LHS term");let a=this.processTerm(i,!0,o,r);this.lhs.push(a)}),n==="")n+=[...this.symbolToInfo.entries()].filter(([i,r])=>r.count===1||i==="...").map(([i])=>i).join("");else if(!n.match(RegExp(Qy)))throw new Error("Invalid RHS");n.match(RegExp(z0,"g"))?.forEach(i=>{if(i==="...")this.outputDims=this.outputDims.concat(this.ellipsisDims);else{let r=this.symbolToInfo.get(i);if(r===void 0)throw new Error("Invalid RHS symbol");this.outputDims.push(r.dimValue)}}),this.rhs=this.processTerm(n,!1,this.outputDims)}addSymbol(s,e,t){let n=this.symbolToInfo.get(s);if(n!==void 0){if(n.dimValue!==e&&n.count!==1)throw new Error("Dimension mismatch");n.count++,n.inputIndices.push(t)}else n={count:1,dimValue:e,inputIndices:[t]};this.symbolToInfo.set(s,n)}processTerm(s,e,t,n=-1){let i=t.length,r=!1,o=[],a=0;if(!s.match(RegExp(uD))&&!e&&s!=="")throw new Error("Invalid LHS term");let l=s.match(RegExp(z0,"g")),c=new yH(n);return l?.forEach((d,u)=>{if(d==="..."){if(r)throw new Error("Only one ellipsis is allowed per input term");r=!0;let h=i-l.length+1;if(h<0)throw new Error("Ellipsis out of bounds");if(o=t.slice(a,a+h),this.hasEllipsis){if(this.ellipsisDims.length!==o.length||this.ellipsisDims.toString()!==o.toString())throw new Error("Ellipsis dimensions mismatch")}else if(e)this.hasEllipsis=!0,this.ellipsisDims=o;else throw new Error("Ellipsis must be specified in the LHS");for(let p=0;p<o.length;p++){let f=String.fromCharCode(48+p);c.addSymbol(f,u+p),this.addSymbol(f,t[a++],n)}}else c.addSymbol(d,u+(this.hasEllipsis?this.ellipsisDims.length-1:0)),this.addSymbol(d,t[a++],n)}),c}},hD=s=>s+"_max",bH=(s,e,t,n)=>{let i=s.map(c=>c.length).map((c,d)=>Ue(`input${d}`,e,c)),r=Ie.size(n),o=bt("output",e,n.length),a=[...t.symbolToInfo.keys()].filter(c=>!t.rhs.symbolToIndices.has(c)),l=c=>{let d=[],u="var prod = 1.0;",h="var sum = 0.0;",p="sum += prod;",f=[],_=[],b=[],y=[],w=t.symbolToInfo.size===t.rhs.symbolToIndices.size;t.symbolToInfo.forEach((M,S)=>{if(t.rhs.symbolToIndices.has(S)){let k=t.rhs.symbolToIndices.get(S)?.[0];k!==void 0&&t.lhs.forEach((T,P)=>{if(M.inputIndices.includes(P)){let R=T.symbolToIndices.get(S);if(R===void 0)throw new Error("Invalid symbol error");R.forEach(O=>{d.push(`${i[P].indicesSet(`input${P}Indices`,O,o.indicesGet("outputIndices",k))}`)})}})}else t.lhs.forEach((k,T)=>{if(M.inputIndices.includes(T)){let P=k.symbolToIndices.get(S);if(P===void 0)throw new Error("Invalid symbol error");P.forEach(R=>{f.push(`${i[T].indicesSet(`input${T}Indices`,R,`${S}`)}`)}),y.push(`prod *= ${i[T].getByIndices(`input${T}Indices`)};`)}}),_.push(`for(var ${S}: u32 = 0; ${S} < uniforms.${hD(S)}; ${S}++) {`),b.push("}")});let C=w?[...d,`let sum = ${i.map((M,S)=>M.getByIndices(`input${S}Indices`)).join(" * ")};`]:[...d,h,..._,...f,u,...y,p,...b];return`
            ${c.registerUniforms(a.map(M=>({name:`${hD(M)}`,type:"u32"}))).registerUniform("outputSize","u32").declareVariables(...i,o)}

            ${c.mainStart()}
            ${c.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}
            var outputIndices = ${o.offsetToIndices("global_idx")};
            ${i.map((M,S)=>`var input${S}Indices: ${i[S].type.indices};`).join(`
`)}
            ${C.join(`
`)};
            ${o.setByOffset("global_idx","sum")};
          }`};return{name:"Einsum",shaderCache:{hint:t.equation,inputDependencies:s.map(()=>"rank")},getRunData:()=>{let c=a.filter(u=>t.symbolToInfo.has(u)).map(u=>({type:12,data:t.symbolToInfo.get(u)?.dimValue||0}));c.push({type:12,data:r});let d=s.map((u,h)=>[...St(u)]).reduce((u,h)=>u.concat(h),c);return d.push(...St(n)),{outputs:[{dims:n,dataType:e}],dispatchGroup:{x:Math.ceil(r/64)},programUniforms:d}},getShaderSource:l}},EK=(s,e)=>{let t=new vH(s.inputs,e.equation),n=t.outputDims,i=s.inputs.map((r,o)=>r.dims);s.compute(bH(i,s.inputs[0].dataType,t,n))},xK=s=>{let e=s.equation.replace(/\s+/g,"");return Mn({equation:e})}}),wH,pD,MH,TH,SK,Ane=Ze(()=>{"use strict";$t(),Ht(),qt(),wH=s=>{if(!s||s.length!==2)throw new Error("Expand requires 2 input.");let e=s[0].dims,t=Array.from(s[1].getBigInt64Array(),Number),n=t.length<e.length?0:t.length-e.length,i=e.length<t.length?0:e.length-t.length;for(;n<t.length&&i<e.length;++n,++i)if(t[n]!==e[i]&&t[n]!==1&&e[i]!==1)throw new Error("Expand requires shape to be broadcastable to input")},pD=(s,e)=>{let t=s.length-e.length,n=[];for(let i=0;i<t;++i)n.push(s[i]);for(let i=0;i<e.length;++i)n.push(e[i]===1?s[i+t]:e[i]);return n},MH=(s,e)=>s.length>e.length?pD(s,e):pD(e,s),TH=s=>{let e=s[0].dims,t=Array.from(s[1].getBigInt64Array(),Number),n=MH(e,t),i=s[0].dataType,r=i===9||Ie.size(e)===1,o=i===9||e.length>0&&e[e.length-1]%4===0?4:1,a=r||n.length>0&&n[n.length-1]%4===0?4:1,l=Math.ceil(Ie.size(n)/a),c=u=>{let h=Ue("input",i,e.length,o),p=bt("output",i,n.length,a),f;if(i===9){let _=(b,y,w="")=>`
          let outputIndices${y} = ${p.offsetToIndices(`outputOffset + ${y}u`)};
          let offset${y} = ${h.broadcastedIndicesToOffset(`outputIndices${y}`,p)};
          let index${y} = offset${y} / 4u;
          let component${y} = offset${y} % 4u;
          ${b}[${y}] = ${w}(${h.getByOffset(`index${y}`)}[component${y}]);
        `;f=`
        let outputOffset = global_idx * ${a};
        var data = vec4<u32>(0);
        ${_("data",0,"u32")}
        ${_("data",1,"u32")}
        ${_("data",2,"u32")}
        ${_("data",3,"u32")}
        ${p.setByOffset("global_idx","data")}
      }`}else f=`
        let outputIndices = ${p.offsetToIndices(`global_idx * ${a}`)};
        let inputOffset = ${h.broadcastedIndicesToOffset("outputIndices",p)};
        let data = ${p.type.value}(${h.getByOffset(`inputOffset / ${o}`)});
        ${p.setByOffset("global_idx","data")}
      }`;return`
    ${u.registerUniform("vec_size","u32").declareVariables(h,p)}
    ${u.mainStart()}
    ${u.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.vec_size")}
    ${f}`},d=[{type:12,data:l},...St(e,n)];return{name:"Expand",shaderCache:{hint:`${n.length};${o}${a}`,inputDependencies:["rank"]},getShaderSource:c,getRunData:()=>({outputs:[{dims:n,dataType:s[0].dataType}],dispatchGroup:{x:Math.ceil(l/64)},programUniforms:d})}},SK=s=>{wH(s.inputs),s.compute(TH(s.inputs),{inputs:[0]})}}),EH,CK,Pne=Ze(()=>{"use strict";$t(),Ht(),qt(),f1(),EH=s=>{let e=s[0].dataType,t=Ie.size(s[0].dims),n=Ie.size(s[1].dims),i=n%4===0,r=o=>{let a=Ue("x",e,[1],4),l=Ue("bias",e,[1],4),c=bt("y",e,[1],4),d=[{name:"output_vec_size",type:"u32"},{name:"bias_size",type:"u32"}],u=p=>`
      let bias${p}_offset: u32 = (global_idx * 4 + ${p}) % uniforms.bias_size;
      let bias${p} = ${l.getByOffset(`bias${p}_offset / 4`)}[bias${p}_offset % 4];`,h=i?`
      let bias = ${l.getByOffset("global_idx % (uniforms.bias_size / 4)")};`:`${u(0)}${u(1)}${u(2)}${u(3)}
      let bias = ${a.type.value}(bias0, bias1, bias2, bias3);`;return`${o.registerUniforms(d).declareVariables(a,l,c)}

    ${VD(Si(e))}

    ${o.mainStart(qf)}
      ${o.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_vec_size")}

      let x = ${a.getByOffset("global_idx")};
      ${h}
      let x_in = x + bias;
      ${c.setByOffset("global_idx",GD("x_in"))}
    }`};return{name:"FastGeluWithBias",shaderCache:{hint:`${i}`,inputDependencies:["type","type"]},getShaderSource:r,getRunData:o=>({outputs:[{dims:o[0].dims,dataType:o[0].dataType}],programUniforms:[{type:12,data:Math.ceil(t/4)},{type:12,data:n}],dispatchGroup:{x:Math.ceil(t/qf/4)}})}},CK=s=>{s.inputs.length<2||Ie.size(s.inputs[1].dims)===0?qq(s):s.compute(EH(s.inputs))}}),xH,SH,AK,PK,kne=Ze(()=>{"use strict";$t(),Ht(),cs(),qt(),xH=s=>{if(!s||s.length!==2)throw new Error("Gather requires 2 inputs.")},SH=(s,e)=>{let t=s[0].dims,n=s[1].dims,i=t.length,r=Ie.normalizeAxis(e.axis,i),o=t.slice(0);o.splice(r,1,...n);let a=t[r],l=s[0].dataType===9?4:1,c=Math.ceil(Ie.size(o)/l),d=[{type:12,data:c},{type:6,data:a},{type:12,data:r},...St(s[0].dims,s[1].dims,o)],u=h=>{let p=Ue("data",s[0].dataType,s[0].dims.length,l),f=Ue("inputIndices",s[1].dataType,s[1].dims.length),_=bt("output",s[0].dataType,o.length,l),b=w=>{let C=n.length,M=`var indicesIndices${w}  = ${f.type.indices}(0);`;for(let S=0;S<C;S++)M+=`${C>1?`indicesIndices${w}[${S}]`:`indicesIndices${w}`} = ${o.length>1?`outputIndices${w}[uniforms.axis + ${S}]`:`outputIndices${w}`};`;M+=`
          var idx${w} = ${f.getByIndices(`indicesIndices${w}`)};
          if (idx${w} < 0) {
            idx${w} = idx${w} + uniforms.axisDimLimit;
          }
          var dataIndices${w} : ${p.type.indices};
        `;for(let S=0,k=0;S<i;S++)S===r?(M+=`${i>1?`dataIndices${w}[${S}]`:`dataIndices${w}`} = u32(idx${w});`,k+=C):(M+=`${i>1?`dataIndices${w}[${S}]`:`dataIndices${w}`} = ${o.length>1?`outputIndices${w}[${k}]`:`outputIndices${w}`};`,k++);return M},y;if(s[0].dataType===9){let w=(C,M,S="")=>`
          let outputIndices${M} = ${_.offsetToIndices(`outputOffset + ${M}u`)};
          ${b(M)};
          let offset${M} = ${p.indicesToOffset(`dataIndices${M}`)};
          let index${M} = offset${M} / 4u;
          let component${M} = offset${M} % 4u;
          ${C}[${M}] = ${S}(${p.getByOffset(`index${M}`)}[component${M}]);
        `;y=`
        let outputOffset = global_idx * ${l};
        var value = vec4<u32>(0);
        ${w("value",0,"u32")}
        ${w("value",1,"u32")}
        ${w("value",2,"u32")}
        ${w("value",3,"u32")}
        ${_.setByOffset("global_idx","value")}
      `}else y=`
      let outputIndices = ${_.offsetToIndices("global_idx")};
      ${b("")};
      let value = ${p.getByIndices("dataIndices")};
      ${_.setByOffset("global_idx","value")};
      `;return`
      ${h.registerUniform("outputSize","u32").registerUniform("axisDimLimit","i32").registerUniform("axis","u32").declareVariables(p,f,_)}
      ${h.mainStart()}
        ${h.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}
        ${y}
      }`};return{name:"Gather",shaderCache:{hint:e.cacheKey,inputDependencies:["rank","rank"]},getRunData:()=>({outputs:[{dims:o,dataType:s[0].dataType}],dispatchGroup:{x:Math.ceil(c/64)},programUniforms:d}),getShaderSource:u}},AK=s=>Mn({axis:s.axis}),PK=(s,e)=>{let t=s.inputs;xH(t),s.compute(SH(s.inputs,e))}}),CH,kK,IK,Ine=Ze(()=>{"use strict";$t(),Ht(),qt(),CH=(s,e,t,n,i,r,o,a,l)=>{let c=[{type:12,data:r},{type:12,data:n},{type:12,data:i},{type:12,data:t},{type:12,data:o},{type:12,data:a},{type:12,data:l}],d=[r];c.push(...St(e.dims,d));let u=h=>{let p=Ue("indices_data",e.dataType,e.dims.length),f=bt("input_slice_offsets_data",12,1,1),_=[p,f],b=[{name:"output_size",type:"u32"},{name:"batch_dims",type:"u32"},{name:"input_dims",type:"u32",length:i.length},{name:"sizes_from_slice_dims_data",type:"u32",length:t.length},{name:"num_slices_per_batch",type:"u32"},{name:"input_batch_stride",type:"u32"},{name:"num_slice_dims",type:"u32"}];return`
  ${h.registerUniforms(b).declareVariables(..._)}
  ${h.mainStart()}
    ${h.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}
    let batch_idx = global_idx / uniforms.num_slices_per_batch;
    let base_offset = batch_idx * uniforms.input_batch_stride;

    let slice_indices_base_offset = global_idx * uniforms.num_slice_dims;
    var relative_slice_offset = 0;
    for (var dim_idx = 0u; dim_idx < uniforms.num_slice_dims; dim_idx ++) {
      var index = i32(indices_data[dim_idx + slice_indices_base_offset].x);
      let input_dim_idx = uniforms.batch_dims + dim_idx;
      if (index < 0) {
        ${i.length===1?"index += i32(uniforms.input_dims);":"index += i32(uniforms.input_dims[input_dim_idx]);"}
      }
      ${t.length===1?"relative_slice_offset += index * i32(uniforms.sizes_from_slice_dims_data);":"relative_slice_offset += index * i32(uniforms.sizes_from_slice_dims_data[dim_idx]);"}
    }

    input_slice_offsets_data[global_idx] =  base_offset + u32(relative_slice_offset);
  }`};return s.compute({name:"computeSliceOffsets",shaderCache:{hint:`${i.length}_${t.length}`,inputDependencies:["rank"]},getRunData:()=>({outputs:[{dims:d,dataType:s.inputs[1].dataType}],dispatchGroup:{x:Math.ceil(r/64)},programUniforms:c}),getShaderSource:u},{inputs:[e],outputs:[-1]})[0]},kK=(s,e)=>{let t=s.inputs,n=t[0].dims,i=t[0].dataType,r=t[1].dims,o=r[r.length-1],a=Ie.sizeToDimension(r,r.length-1),l=Ie.sizeFromDimension(n,e.batchDims+o),c=Ie.sizeToDimension(n,e.batchDims),d=Ie.sizeFromDimension(n,e.batchDims),u=a/c,h=new Array(o),p=l;for(let M=0;M<o;++M)h[o-1-M]=p,p*=n[e.batchDims+o-1-M];let f=CH(s,t[1],h,e.batchDims,n,a,u,d,o),_=e.batchDims+o;if(_>n.length)throw new Error("last dimension of indices must not be larger than rank of input tensor");let b=r.slice(0,-1).concat(n.slice(_)),y=Ie.size(b),w=[{type:12,data:y},{type:12,data:l},...St(t[0].dims,f.dims,b)],C=M=>{let S=Ue("data",t[0].dataType,t[0].dims.length),k=Ue("slice_offsets",12,f.dims.length),T=bt("output",t[0].dataType,b.length);return`
          ${M.registerUniform("output_size","u32").registerUniform("slice_size","u32").declareVariables(S,k,T)}
            ${M.mainStart()}
            ${M.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}
          let slice_offset = slice_offsets[global_idx / uniforms.slice_size];
          output[global_idx] = data[u32(slice_offset) + global_idx % uniforms.slice_size];
        }`};s.compute({name:"GatherND",shaderCache:{hint:e.cacheKey,inputDependencies:["rank","rank"]},getRunData:()=>({outputs:[{dims:b,dataType:i}],dispatchGroup:{x:Math.ceil(y/64)},programUniforms:w}),getShaderSource:C},{inputs:[t[0],f]})},IK=s=>({batchDims:s.batch_dims,cacheKey:""})}),AH,PH,DK,RK,Dne=Ze(()=>{"use strict";$t(),Ht(),cs(),qt(),AH=(s,e)=>{if(s.length<3||s.length>4)throw new Error("GatherBlockQuantized requires 3 or 4 inputs.");let t=Ie.normalizeAxis(e.quantizeAxis,s[0].dims.length),n=e.blockSize,i=s[0],r=s[2],o=s.length===4?s[3]:void 0;if(r.dims.length!==i.dims.length||!i.dims.map((a,l)=>l===t?Math.ceil(a/n)===r.dims[l]:a===r.dims[l]).reduce((a,l)=>a&&l,!0))throw new Error("Scales must have the same rank as the input tensor and the dims should match except on gatherAxis.");if(o){if(o.dataType!==i.dataType)throw new Error("Zero point must have the same data type as the input tensor.");if(o.dims.length!==r.dims.length||!o.dims.map((a,l)=>a===r.dims[l]).reduce((a,l)=>a&&l,!0))throw new Error("Zero point must have the same rank as the input tensor and the dims should match except on quantizeAxis.")}},PH=(s,e)=>{let t=s[0].dims,n=s[1].dims,i=t.length,r=Ie.normalizeAxis(e.gatherAxis,i),o=Ie.normalizeAxis(e.quantizeAxis,i),a=t.slice(0);a.splice(r,1,...n);let l=Ie.size(a),c=s[2].dataType,d=s[0].dataType===22,u=[{type:12,data:l},{type:12,data:o},{type:12,data:r},{type:12,data:e.blockSize},...St(...s.map((p,f)=>p.dims),a)],h=p=>{let f=Ue("data",s[0].dataType,s[0].dims.length),_=Ue("inputIndices",s[1].dataType,s[1].dims.length),b=Ue("scales",s[2].dataType,s[2].dims.length),y=s.length>3?Ue("zeroPoint",s[3].dataType,s[3].dims.length):void 0,w=bt("output",c,a.length),C=[f,_,b];y&&C.push(y);let M=[{name:"output_size",type:"u32"},{name:"quantize_axis",type:"u32"},{name:"gather_axis",type:"u32"},{name:"block_size",type:"u32"}];return`
        ${p.registerUniforms(M).declareVariables(...C,w)}
        ${p.mainStart()}
        let output_indices = ${w.offsetToIndices("global_idx")};
        var indices_indices = ${_.type.indices}(0);
        ${n.length>1?`
          for (var i: u32 = 0; i < ${n.length}; i++) {
            let index = ${w.indicesGet("output_indices","uniforms.gather_axis + i")};
            ${_.indicesSet("indices_indices","i","index")};
          }`:`indices_indices = ${w.indicesGet("output_indices","uniforms.gather_axis")};`};
        var data_indices = ${f.type.indices}(0);
        for (var i: u32 = 0; i < uniforms.gather_axis; i++) {
          let index = ${w.indicesGet("output_indices","i")};
          ${f.indicesSet("data_indices","i","index")};
        }
        var index_from_indices = ${_.getByIndices("indices_indices")};
        if (index_from_indices < 0) {
          index_from_indices += ${t[r]};
        }
        ${f.indicesSet("data_indices","uniforms.gather_axis","u32(index_from_indices)")};
        for (var i = uniforms.gather_axis + 1; i < ${a.length}; i++) {
          let index = ${w.indicesGet("output_indices",`i + ${n.length} - 1`)};
          ${f.indicesSet("data_indices","i","index")};
        }
        let data_offset = ${f.indicesToOffset("data_indices")};
        let data_index = data_offset % 8;
        // Convert 4-bit packed data to 8-bit packed data.
        let packed_4bit_quantized_data = ${f.getByOffset("data_offset / 8")};
        let packed_8bit_quantized_data = (packed_4bit_quantized_data >> (4 * (data_index % 2))) & 0x0f0f0f0f;
        let quantized_data_vec = ${d?"unpack4xI8":"unpack4xU8"}(u32(packed_8bit_quantized_data));
        let quantized_data = quantized_data_vec[data_index / 2];
        var scale_indices = data_indices;
        let quantize_axis_index = ${b.indicesGet("data_indices","uniforms.quantize_axis")} / uniforms.block_size;
        ${b.indicesSet("scale_indices","uniforms.quantize_axis","quantize_axis_index")};
        var scale = ${b.getByIndices("scale_indices")};
        ${y?`
              let zero_point_indices = scale_indices;
              let zero_point_offset = ${y.indicesToOffset("zero_point_indices")};
              let zero_point_index = zero_point_offset % 8;
              let packed_4bit_zero_points = ${y.getByOffset("zero_point_offset / 8")};
              let packed_8bit_zero_points = (packed_4bit_zero_points >> (4 * (zero_point_index % 2))) & 0x0f0f0f0f;
              let zero_point_vec = ${d?"unpack4xI8":"unpack4xU8"}(u32(packed_8bit_zero_points));
              let zero_point = zero_point_vec[zero_point_index / 2];`:"var zero_point = 0"};
        let dequantized_data = ${Si(c)}(quantized_data - zero_point) * scale;
        ${w.setByOffset("global_idx","dequantized_data")};
    }`};return{name:"GatherBlockQuantized",shaderCache:{hint:`${e.cacheKey};${s.filter((p,f)=>f!==1).map(p=>p.dims.join("_")).join(";")}`,inputDependencies:Array.from({length:s.length},(p,f)=>"rank")},getRunData:()=>({outputs:[{dims:a,dataType:c}],dispatchGroup:{x:Math.ceil(l/64)},programUniforms:u}),getShaderSource:h}},DK=(s,e)=>{let t=s.inputs;AH(t,e),s.compute(PH(s.inputs,e))},RK=s=>Mn({blockSize:s.blockSize,gatherAxis:s.gatherAxis,quantizeAxis:s.quantizeAxis})}),kH,IH,FK,LK,Rne=Ze(()=>{"use strict";$t(),Ht(),cs(),qt(),kH=s=>{if(!s||s.length!==2)throw new Error("GatherElements requires 2 inputs.");if(s[0].dims.length<1)throw new Error("GatherElements requires that the data input be rank >= 1.");if(s[0].dims.length!==s[1].dims.length)throw new Error(`GatherElements requires that the data input and
                     indices input tensors be of same rank.`)},IH=(s,e)=>{let t=s[0].dims,n=s[0].dataType,i=t.length,r=s[1].dims,o=s[1].dataType,a=Ie.normalizeAxis(e.axis,i),l=t[a],c=r.slice(0),d=Ie.size(c),u=Ue("input",n,i),h=Ue("indicesInput",o,r.length),p=bt("output",n,c.length),f=[{type:12,data:d},{type:6,data:l},{type:12,data:a}];return f.push(...St(t,r,c)),{name:"GatherElements",shaderCache:{inputDependencies:["rank","rank"]},getRunData:()=>({outputs:[{dims:c,dataType:s[0].dataType}],dispatchGroup:{x:Math.ceil(d/64)},programUniforms:f}),getShaderSource:_=>`
      ${_.registerUniform("outputSize","u32").registerUniform("axisDimLimit","i32").registerUniform("axis","u32").declareVariables(u,h,p)}
      ${_.mainStart()}
      ${_.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}

      let outputIndices = ${p.offsetToIndices("global_idx")};

      var idx = ${h.getByOffset("global_idx")};
      if (idx < 0) {
        idx = idx + uniforms.axisDimLimit;
      }
      var inputIndices = ${u.type.indices}(outputIndices);
      ${u.indicesSet("inputIndices","uniforms.axis","u32(idx)")};
      let value = ${u.getByIndices("inputIndices")};

      ${p.setByOffset("global_idx","value")};
  }`}},FK=s=>Mn({axis:s.axis}),LK=(s,e)=>{let t=s.inputs;kH(t),s.compute(IH(s.inputs,e))}}),DH,RH,NK,OK,Fne=Ze(()=>{"use strict";$t(),Ht(),qt(),DH=s=>{if(!s)throw new Error("Input is missing");if(s.length<2||s.length>3)throw new Error("Invaid input number.");if(s.length===3&&s[2].dims.length>2)throw new Error("Invalid input shape of C");if(s[0].dataType!==s[1].dataType||s.length===3&&s[0].dataType!==s[2].dataType)throw new Error("Input types are mismatched")},RH=(s,e)=>{let t=s[0].dims.slice(),n=s[1].dims.slice(),[i,r,o]=F4.getShapeOfGemmResult(t,e.transA,n,e.transB,s.length===3?s[2].dims:void 0),a=[i,r];if(!a)throw new Error("Can't use gemm on the given tensors");let l=16,c=Math.ceil(r/l),d=Math.ceil(i/l),u=!0,h=Ie.size(a),p=[{type:12,data:u?c:h},{type:12,data:i},{type:12,data:r},{type:12,data:o},{type:1,data:e.alpha},{type:1,data:e.beta}],f=["type","type"];s.length===3&&(p.push(...St(s[2].dims)),f.push("rank")),p.push(...St(a));let _=y=>{let w="";e.transA&&e.transB?w="value += a[k * uniforms.M + m] * b[n * uniforms.K + k];":e.transA&&!e.transB?w="value += a[k * uniforms.M + m] * b[k * uniforms.N + n];":!e.transA&&e.transB?w="value += a[m * uniforms.K + k] * b[n * uniforms.K + k];":!e.transA&&!e.transB&&(w="value += a[m * uniforms.K + k] * b[k * uniforms.N + n];");let C=e.alpha===1?"":"value *= uniforms.alpha;",M=Ue("a",s[0].dataType,s[0].dims),S=Ue("b",s[1].dataType,s[1].dims),k=M.type.value,T=null,P=[M,S];s.length===3&&(T=Ue("c",s[2].dataType,s[2].dims.length),P.push(T));let R=bt("output",s[0].dataType,a.length);P.push(R);let O=[{name:"output_size",type:"u32"},{name:"M",type:"u32"},{name:"N",type:"u32"},{name:"K",type:"u32"},{name:"alpha",type:"f32"},{name:"beta",type:"f32"}];return`
  ${y.registerUniforms(O).declareVariables(...P)}

  ${y.mainStart()}
    ${y.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}

    let m = global_idx / uniforms.N;
    let n = global_idx % uniforms.N;

    var value = ${k}(0);
    for (var k: u32 = 0u; k < uniforms.K; k++) {
      ${w}
    }

    ${C}
    ${T!=null?`let cOffset = ${T.broadcastedIndicesToOffset("vec2(m, n)",R)}; value += ${k}(uniforms.beta) * ${T.getByOffset("cOffset")};`:""}
    output[global_idx] = value;
  }`},b=y=>{let w=Ue("a",s[0].dataType,s[0].dims),C=Ue("b",s[1].dataType,s[1].dims),M=null,S=[w,C];s.length===3&&(M=Ue("c",s[2].dataType,s[2].dims.length),S.push(M));let k=bt("output",s[0].dataType,a.length);S.push(k);let T=[{name:"num_tile_n",type:"u32"},{name:"M",type:"u32"},{name:"N",type:"u32"},{name:"K",type:"u32"},{name:"alpha",type:"f32"},{name:"beta",type:"f32"}],P="",R="";e.transA&&e.transB?(R=`
      var col = tile_row_start + local_id.x;
      var row = k_start + local_id.y;
      if (col < uniforms.M && row < uniforms.K) {
        tile_a[local_id.y][local_id.x] = a[row * uniforms.M + col];
      } else {
        tile_a[local_id.y][local_id.x] = ${w.type.value}(0);
      }

      col = k_start + local_id.x;
      row = tile_col_start + local_id.y;
      if (col < uniforms.K && row < uniforms.N) {
        tile_b[local_id.y][local_id.x] = b[row * uniforms.K + col];
      } else {
        tile_b[local_id.y][local_id.x] = ${C.type.value}(0);
      }
      `,P="value += tile_a[k][local_id.y] * tile_b[local_id.x][k];"):e.transA&&!e.transB?(R=`
      var col = tile_row_start + local_id.x;
      var row = k_start + local_id.y;
      if (col < uniforms.M && row < uniforms.K) {
        tile_a[local_id.y][local_id.x] = a[row * uniforms.M + col];
      } else {
        tile_a[local_id.y][local_id.x] = ${w.type.value}(0);
      }

      col = tile_col_start + local_id.x;
      row = k_start + local_id.y;
      if (col < uniforms.N && row < uniforms.K) {
        tile_b[local_id.y][local_id.x] = b[row * uniforms.N + col];
      } else {
        tile_b[local_id.y][local_id.x] = ${C.type.value}(0);
      }
      `,P="value += tile_a[k][local_id.y] * tile_b[k][local_id.x];"):!e.transA&&e.transB?(R=`
      var col = k_start + local_id.x;
      var row = tile_row_start + local_id.y;
      if (col < uniforms.K && row < uniforms.M) {
        tile_a[local_id.y][local_id.x] = a[row * uniforms.K + col];
      } else {
        tile_a[local_id.y][local_id.x] = ${w.type.value}(0);
      }

      col = k_start + local_id.x;
      row = tile_col_start + local_id.y;
      if (col < uniforms.K && row < uniforms.N) {
        tile_b[local_id.y][local_id.x] = b[row * uniforms.K + col];
      } else {
        tile_b[local_id.y][local_id.x] = ${C.type.value}(0);
      }
      `,P="value += tile_a[local_id.y][k] * tile_b[local_id.x][k];"):!e.transA&&!e.transB&&(R=`
      var col = k_start + local_id.x;
      var row = tile_row_start + local_id.y;
      if (col < uniforms.K && row < uniforms.M) {
        tile_a[local_id.y][local_id.x] = a[row * uniforms.K + col];
      } else {
        tile_a[local_id.y][local_id.x] = ${w.type.value}(0);
      }

      col = tile_col_start + local_id.x;
      row = k_start + local_id.y;
      if (col < uniforms.N && row < uniforms.K) {
        tile_b[local_id.y][local_id.x] = b[row * uniforms.N + col];
      } else {
        tile_b[local_id.y][local_id.x] = ${C.type.value}(0);
      }
      `,P="value += tile_a[local_id.y][k] * tile_b[k][local_id.x];");let O=e.alpha===1?"":"value *= uniforms.alpha;";return`
  ${y.registerUniforms(T).declareVariables(...S)}
  var<workgroup> tile_a: array<array<${w.type.storage}, ${l}>, ${l}>;
  var<workgroup> tile_b: array<array<${C.type.storage}, ${l}>, ${l}>;
  ${y.mainStart([l,l,1])}
    let tile_col_start = (workgroup_index % uniforms.num_tile_n) * ${l};
    let tile_row_start = (workgroup_index / uniforms.num_tile_n) * ${l};
    let num_tiles = (uniforms.K - 1) / ${l} + 1;
    var k_start = 0u;
    var value = ${k.type.value}(0);
    for (var t: u32 = 0u; t < num_tiles; t++) {
      ${R}
      k_start = k_start + ${l};
      workgroupBarrier();

      for (var k: u32 = 0u; k < ${l}; k++) {
        ${P}
      }
      workgroupBarrier();
    }

    ${O}
    let m = tile_row_start + local_id.y;
    let n = tile_col_start + local_id.x;
    ${M!=null?`let cOffset = ${M.broadcastedIndicesToOffset("vec2(m, n)",k)}; value += ${k.type.value}(uniforms.beta) * ${M.getByOffset("cOffset")};`:""}
    if (m < uniforms.M && n < uniforms.N) {
      output[m * uniforms.N + n] = value;
    }
  }`};return u?{name:"GemmShared",shaderCache:{hint:`${e.cacheKey}`,inputDependencies:f},getRunData:()=>({outputs:[{dims:a,dataType:s[0].dataType}],dispatchGroup:{x:c*d},programUniforms:p}),getShaderSource:b}:{name:"Gemm",shaderCache:{hint:`${e.cacheKey}`,inputDependencies:f},getRunData:()=>({outputs:[{dims:a,dataType:s[0].dataType}],dispatchGroup:{x:Math.ceil(h/64)},programUniforms:p}),getShaderSource:_}},NK=s=>{let e=s.transA,t=s.transB,n=s.alpha,i=s.beta;return{transA:e,transB:t,alpha:n,beta:i,cacheKey:`${s.transA};${s.transB};${s.alpha===1}`}},OK=(s,e)=>{DH(s.inputs),s.compute(RH(s.inputs,e))}}),va,Tl,ju,qu,FH,LH,NH,OH,$H,BH,zH,UH,$K,BK,Lne=Ze(()=>{"use strict";$t(),Ht(),cs(),qt(),[va,Tl,ju,qu]=[0,1,2,3],FH=s=>{if(s[0].dims.length!==4)throw new Error("only 4-D tensor is supported.");if(s[0].dims.length!==s[1].dims.length)throw new Error("input dimensions must be equal to grid dimensions");if(s[0].dims.length-2!==s[1].dims[s[1].dims.length-1])throw new Error(`last dimension of grid must be equal to ${s[0].dims.length-2}`);if(s[0].dims[0]!==s[1].dims[0])throw new Error("grid batch size must match input batch size")},LH=`
  fn gs_get_cubic_coeffs(x: f32) -> vec4<f32> {
    let cubic_alpha = -0.75f;
    let x_abs = abs(x);
    var coeffs: vec4<f32>;
    coeffs[0] = (((cubic_alpha * (x_abs + 1) - 5 * cubic_alpha) * (x_abs + 1) + 8 * cubic_alpha) * (x_abs + 1) - 4 * cubic_alpha);
    coeffs[1] = (((cubic_alpha + 2) * x_abs - (cubic_alpha + 3)) * x_abs * x_abs + 1);
    coeffs[2] = (((cubic_alpha + 2) * (1 - x_abs) - (cubic_alpha + 3)) * (1 - x_abs) * (1 - x_abs) + 1);
    coeffs[3] = (((cubic_alpha * (2 - x_abs) - 5 * cubic_alpha) * (2 - x_abs) + 8 * cubic_alpha) * (2 - x_abs) - 4 * cubic_alpha);
    return coeffs;
  }
`,NH=s=>`
  fn gs_bicubic_interpolate(p: mat4x4<${s}>, x: f32, y: f32) -> ${s} {
    var v: vec4<f32>;
    var coeffs = gs_get_cubic_coeffs(x);
    for (var i = 0; i < 4; i++) {
      v[i] = coeffs[0] * p[i][0] + coeffs[1] * p[i][1] + coeffs[2] * p[i][2] + coeffs[3] * p[i][3];
    }
    coeffs = gs_get_cubic_coeffs(y);
    let pixel = ${s}(coeffs[0] * v[0] + coeffs[1] * v[1] + coeffs[2] * v[2] + coeffs[3] * v[3]);
    return pixel;
  }
`,OH=s=>`
  fn gs_denormalize(n: f32, length: i32) -> f32 {
    ${s.alignCorners===0?`
    // alignCorners: false => [-1, 1] to [-0.5, length - 0.5]
    return ((n + 1.0) * f32(length) - 1.0) / 2.0;
    `:`
    // alignCorners: true => [-1, 1] to [0, length - 1]
    return (n + 1.0) / 2.0 * (f32(length - 1));
    `}
  }
`,$H=s=>`
  ${s.paddingMode==="reflection"?`
      fn gs_reflect(x: i32, x_min: f32, x_max: f32) -> u32 {
        var dx = 0.0;
        var fx = f32(x);
        let range = x_max - x_min;
        if (fx < x_min) {
          dx = x_min - fx;
          let n = u32(dx / range);
          let r = dx - f32(n) * range;
          if (n % 2 == 0) {
            fx = x_min + r;
          } else {
            fx = x_max - r;
          }
        } else if (fx > x_max) {
          dx = fx - x_max;
          let n = u32(dx / range);
          let r = dx - f32(n) * range;
          if (n % 2 == 0) {
            fx = x_max - r;
          } else {
            fx = x_min + r;
          }
        }
        return u32(fx);
      }`:""}
`,BH=(s,e,t)=>`
  fn pixel_at_grid(r: i32, c: i32, H: i32, W: i32, batch: u32, channel: u32, border: vec4<f32>) -> ${e} {
     var pixel = ${e}(0);
     var indices = vec4<u32>(0);
     indices[${va}] = batch;
     indices[${Tl}] = channel;`+(()=>{switch(t.paddingMode){case"zeros":return`
          if (r >= 0 && r < H && c >=0 && c < W) {
            indices[${ju}] = u32(r);
            indices[${qu}] = u32(c);
          } else {
            return ${e}(0);
          }
        `;case"border":return`
          indices[${ju}] = u32(clamp(r, 0, H - 1));
          indices[${qu}] = u32(clamp(c, 0, W - 1));
        `;case"reflection":return`
          indices[${ju}] = gs_reflect(r, border[1], border[3]);
          indices[${qu}] = gs_reflect(c, border[0], border[2]);
        `;default:throw new Error(`padding mode ${t.paddingMode} is not supported`)}})()+`
    return ${s.getByIndices("indices")};
  }
`,zH=(s,e,t)=>(()=>{switch(t.mode){case"nearest":return`
          let result = pixel_at_grid(i32(round(y)), i32(round(x)), H_in, W_in, indices[${va}], indices[${Tl}], border);
        `;case"bilinear":return`
          let x1 = i32(floor(x));
          let y1 = i32(floor(y));
          let x2 = x1 + 1;
          let y2 = y1 + 1;

          let p11 = pixel_at_grid(y1, x1, H_in, W_in, indices[${va}], indices[${Tl}], border);
          let p12 = pixel_at_grid(y1, x2, H_in, W_in, indices[${va}], indices[${Tl}], border);
          let p21 = pixel_at_grid(y2, x1, H_in, W_in, indices[${va}], indices[${Tl}], border);
          let p22 = pixel_at_grid(y2, x2, H_in, W_in, indices[${va}], indices[${Tl}], border);

          let dx2 = ${e}(f32(x2) - x);
          let dx1 = ${e}(x - f32(x1));
          let dy2 = ${e}(f32(y2) - y);
          let dy1 = ${e}(y - f32(y1));
          let result = dy2 * (dx2 * p11 + dx1 * p12) + dy1 * (dx2 * p21 + dx1 * p22);
        `;case"bicubic":return`
          let x0 = i32(floor(x)) - 1;
          let y0 = i32(floor(y)) - 1;
          var p: mat4x4<${e}>;
          for (var h = 0; h < 4; h++) {
            for (var w = 0; w < 4; w++) {
              p[h][w] = pixel_at_grid(h + y0, w + x0, H_in, W_in, indices[${va}], indices[${Tl}], border);
            }
          }

          let dx = x - f32(x0 + 1);
          let dy = y - f32(y0 + 1);
          let result = gs_bicubic_interpolate(p, dx, dy);
        `;default:throw new Error(`mode ${t.mode} is not supported`)}})()+`${s.setByOffset("global_idx","result")}`,UH=(s,e)=>{let t=Ue("x",s[0].dataType,s[0].dims.length),n=[s[1].dims[0],s[1].dims[1],s[1].dims[2]],i=Ue("grid",s[1].dataType,n.length,2),r=[s[0].dims[0],s[0].dims[1],s[1].dims[1],s[1].dims[2]];e.format==="NHWC"&&(r=[s[0].dims[0],s[1].dims[1],s[1].dims[2],s[0].dims[3]],[va,Tl,ju,qu]=[0,3,1,2]);let o=bt("output",s[0].dataType,r.length),a=t.type.value,l=Ie.size(r),c=[{type:12,data:l},...St(s[0].dims,n,r)],d=u=>`
  ${u.registerUniform("output_size","u32").declareVariables(t,i,o)}
  ${LH}
  ${NH(a)}
  ${OH(e)}
  ${$H(e)}
  ${BH(t,a,e)}

  ${u.mainStart()}
    ${u.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}
      let H_in = i32(uniforms.x_shape[${ju}]);
      let W_in = i32(uniforms.x_shape[${qu}]);

      ${e.alignCorners===0?`
      let x_min = -0.5;
      let x_max = f32(W_in) - 0.5;
      let y_min = -0.5;
      let y_max = f32(H_in) - 0.5;
      `:`
      let x_min = 0.0;
      let x_max = f32(W_in) - 1.0;
      let y_min = 0.0;
      let y_max = f32(H_in) - 1.0;
      `};
      let border = vec4<f32>(x_min, y_min, x_max, y_max);

      let indices = ${o.offsetToIndices("global_idx")};
      var grid_indices = vec3<u32>(indices[${va}], indices[${ju}], indices[${qu}]);
      let nxy = ${i.getByIndices("grid_indices")};
      var x = gs_denormalize(f32(nxy[0]), W_in);
      var y = gs_denormalize(f32(nxy[1]), H_in);

      ${zH(o,a,e)}
  }`;return{name:"GridSample",shaderCache:{hint:`${e.cacheKey}`,inputDependencies:["type","type"]},getRunData:u=>{let h=Ie.size(r);return{outputs:[{dims:r,dataType:u[0].dataType}],dispatchGroup:{x:Math.ceil(h/64)},programUniforms:c}},getShaderSource:d}},$K=(s,e)=>{FH(s.inputs),s.compute(UH(s.inputs,e))},BK=s=>Mn({alignCorners:s.align_corners,mode:s.mode,paddingMode:s.padding_mode,format:s.format})}),$i,VH,zK,fD,GH,rv,UK,VK=Ze(()=>{"use strict";$t(),Ht(),cs(),d1(),p1(),qt(),Nc(),$i=(s,e)=>s.length>e&&s[e].dims.length>0?s[e]:void 0,VH=(s,e)=>{let t=s[0],n=$i(s,1),i=$i(s,2),r=$i(s,3),o=$i(s,4),a=$i(s,5),l=$i(s,6),c=$i(s,7);if(t.dims.length!==3&&t.dims.length!==5)throw new Error("Input query is expected to have 3 or 5 dimensions");let d=t.dims[0],u=t.dims[1],h=t.dims.length===3?t.dims[2]:e.numHeads*t.dims[4],p=u,f=0,_=0,b=Math.floor(h/e.numHeads);if(l&&c&&Ie.size(l.dims)&&Ie.size(c.dims)){if(l.dims.length!==4)throw new Error('Input "past_key" is expected to have 4 dimensions');if(l.dims[0]!==d||l.dims[1]!==e.numHeads||l.dims[3]!==b)throw new Error('Input "past_key" shape (batch_size, num_heads, past_sequence_length, head_size)');if(c.dims[0]!==d||c.dims[1]!==e.numHeads||c.dims[3]!==b)throw new Error('Input "past_value" shape (batch_size, num_heads, past_sequence_length, head_size)');if(l.dims[2]!==c.dims[2])throw new Error('Input "past_key" and "past_value" shall have same dim 2 (past_sequence_length)');if(c.dims.length!==4)throw new Error('Input "past_value" is expected to have 4 dimensions');f=l.dims[2],_=l.dims[2]}else if(l&&Ie.size(l.dims)||c&&Ie.size(c.dims))throw new Error('Input "past_key" and "past_value" shall be both present or both absent');let y;if(n&&Ie.size(n.dims)>0){if(t.dims.length!==3)throw new Error('Input "query" is expected to have 3 dimensions when key is given');if(n.dims.length<3||n.dims.length>5)throw new Error('Input "key" is expected to have 3, 4, or 5 dimensions');if(t.dims[0]!==n.dims[0])throw new Error('Input "query" and "key" shall have same dim 0 (batch size)');if(n.dims.length===3){if(n.dims[2]!==t.dims[2])throw new Error('Input "query" and "key" shall have same dim 2 (hidden_size)');y=2,p=n.dims[1]}else if(n.dims.length===5){if(n.dims[2]!==e.numHeads||n.dims[3]!==2||n.dims[4]!==b)throw new Error('Expect "key" shape (batch_size, kv_sequence_length, num_heads, 2, head_size) for packed kv');if(i)throw new Error('Expect "value" be none when "key" has packed kv format.');y=5,p=n.dims[1]}else{if(n.dims[1]!==e.numHeads||n.dims[3]!==b)throw new Error('Expect "key" shape (batch_size, num_heads, kv_sequence_length, head_size) for past_key');y=0,p=n.dims[2]}}else{if(t.dims.length!==5)throw new Error('Input "query" is expected to have 5 dimensions when key is empty');if(t.dims[2]!==e.numHeads||t.dims[3]!==3)throw new Error('Expect "query" shape (batch_size, kv_sequence_length, num_heads, 3, head_size) for packed kv');y=3}if(r&&Ie.size(r.dims)>0){if(r.dims.length!==1)throw new Error('Input "bias" is expected to have 1 dimension');if(n&&n.dims.length===5&&n.dims[3]===2)throw new Error("bias is not allowed for packed kv.")}let w=f+p,C=0;if(o&&Ie.size(o.dims)>0){C=8;let T=o.dims;throw T.length===1?T[0]===d?C=1:T[0]===3*d+2&&(C=3):T.length===2&&T[0]===d&&T[1]===w&&(C=5),C===8?new Error('Input "key_padding_mask" shape shall be (batch_size) or (batch_size, total_sequence_length)'):new Error("Mask not supported")}let M=!1,S=h;if(i&&Ie.size(i.dims)>0){if(i.dims.length!==3&&i.dims.length!==4)throw new Error('Input "value" is expected to have 3 or 4 dimensions');if(t.dims[0]!==i.dims[0])throw new Error('Input "query" and "value" shall have same dim 0 (batch_size)');if(i.dims.length===3){if(p!==i.dims[1])throw new Error('Input "key" and "value" shall have the same dim 1 (kv_sequence_length)');S=i.dims[2]}else{if(p!==i.dims[2])throw new Error('Input "key" and "value" shall have the same dim 2 (kv_sequence_length)');S=i.dims[1]*i.dims[3],M=!0}}let k=!1;if(o&&Ie.size(o.dims)>0)throw new Error("Key padding mask is not supported");if(a&&Ie.size(a.dims)>0){if(a.dims.length!==4)throw new Error('Input "attention_bias" is expected to have 4 dimensions');if(a.dims[0]!==d||a.dims[1]!==e.numHeads||a.dims[2]!==u||a.dims[3]!==w)throw new Error('Expect "attention_bias" shape (batch_size, num_heads, sequence_length, total_sequence_length)')}return{batchSize:d,sequenceLength:u,pastSequenceLength:f,kvSequenceLength:p,totalSequenceLength:w,maxSequenceLength:_,inputHiddenSize:0,hiddenSize:h,vHiddenSize:S,headSize:b,vHeadSize:Math.floor(S/e.numHeads),numHeads:e.numHeads,isUnidirectional:!1,pastPresentShareBuffer:!1,maskFilterValue:e.maskFilterValue,maskType:C,scale:e.scale,broadcastResPosBias:k,passPastInKv:M,qkvFormat:y}},zK=s=>Mn({...s}),fD=Mn({perm:[0,2,1,3]}),GH=(s,e,t,n,i,r,o)=>{let a=[n,i,r],l=Ie.size(a),c=[{type:12,data:l},{type:12,data:o},{type:12,data:r}],d=u=>{let h=bt("qkv_with_bias",e.dataType,a),p=Ue("qkv",e.dataType,a),f=Ue("bias",t.dataType,a),_=[{name:"output_size",type:"u32"},{name:"bias_offset",type:"u32"},{name:"hidden_size",type:"u32"}];return`
  ${u.registerUniforms(_).declareVariables(p,f,h)}
  ${u.mainStart()}
    ${u.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}
    let bias_offset_idx = (global_idx % uniforms.hidden_size) + uniforms.bias_offset;

    qkv_with_bias[global_idx] = qkv[global_idx] + bias[bias_offset_idx];
  }`};return s.compute({name:"MultiHeadAttentionAddBias",shaderCache:{inputDependencies:["type","type"]},getRunData:()=>({outputs:[{dims:a,dataType:e.dataType,gpuDataType:0}],dispatchGroup:{x:Math.ceil(l/64)},programUniforms:c}),getShaderSource:d},{inputs:[e,t],outputs:[-1]})[0]},rv=(s,e,t,n,i,r,o,a)=>{let l=r;if(o&&Ie.size(o.dims)>0){if(n===1)throw new Error("AddBiasReshape is not implemented. Please export your model with packed QKV or KV");return l=GH(s,r,o,e,n,t*i,a),l=l.reshape([e,n,t,i]),t===1||n===1?l:s.compute(Er(l,fD.perm),{inputs:[l],outputs:[-1]})[0]}else return r.dims.length===3&&(l=r.reshape([e,n,t,i])),t===1||n===1?l:s.compute(Er(l,fD.perm),{inputs:[l],outputs:[-1]})[0]},UK=(s,e)=>{let t=VH(s.inputs,e),n=s.inputs[0],i=$i(s.inputs,1),r=$i(s.inputs,2),o=$i(s.inputs,3),a=$i(s.inputs,4),l=$i(s.inputs,5),c=$i(s.inputs,6),d=$i(s.inputs,7);if(n.dims.length===5)throw new Error("Packed QKV is not implemented");if(i?.dims.length===5)throw new Error("Packed KV is not implemented");let u=i&&r&&i.dims.length===4&&r.dims.length===4,h=rv(s,t.batchSize,t.numHeads,t.sequenceLength,t.headSize,n,o,0);if(u)return cv(s,h,i,r,a,void 0,c,d,l,t);if(!i||!r)throw new Error("key and value must be provided");let p=rv(s,t.batchSize,t.numHeads,t.kvSequenceLength,t.headSize,i,o,t.hiddenSize),f=rv(s,t.batchSize,t.numHeads,t.kvSequenceLength,t.vHeadSize,r,o,2*t.hiddenSize);cv(s,h,p,f,a,void 0,c,d,l,t)}}),WH,HH,jH,qH,KD,GK,WK,HK=Ze(()=>{"use strict";$t(),Ht(),cs(),qt(),WH=s=>{if(!s||s.length<1)throw new Error("too few inputs")},HH=(s,e)=>{let t=[],n=e.numOutputs;return s[1].dims[0]>0&&(s[1].getBigInt64Array().forEach(i=>t.push(Number(i))),n=t.length),Mn({numOutputs:n,axis:e.axis,splitSizes:t})},jH=s=>`
fn calculateOutputIndex(index: u32) -> u32 {
    for (var i: u32 = 0u; i < ${s}u; i += 1u ) {
    if (index < ${Et("uniforms.size_in_split_axis","i",s)}) {
        return i;
    }
    }
    return ${s}u;
}`,qH=s=>{let e=s.length,t=[];for(let n=0;n<e;++n){let i=s[n].setByIndices("indices","input[global_idx]");e===1?t.push(i):n===0?t.push(`if (output_number == ${n}u) { ${i} }`):n===e-1?t.push(`else { ${i} }`):t.push(`else if (output_number == ${n}) { ${i} }`)}return`
      fn writeBufferData(output_number: u32, indices: ${s[0].type.indices}, global_idx: u32) {
        ${t.join(`
`)}
      }`},KD=(s,e)=>{let t=s[0].dims,n=Ie.size(t),i=s[0].dataType,r=Ie.normalizeAxis(e.axis,t.length),o=new Array(e.numOutputs),a=Ue("input",i,t.length),l=new Array(e.numOutputs),c=[],d=[],u=0,h=[{type:12,data:n}];for(let f=0;f<e.numOutputs;f++){u+=e.splitSizes[f],l[f]=u;let _=t.slice();_[r]=e.splitSizes[f],d.push(_),o[f]=bt(`output${f}`,i,_.length),c.push({dims:d[f],dataType:s[0].dataType})}h.push({type:12,data:l},...St(t,...d));let p=f=>`
  ${f.registerUniform("input_size","u32").registerUniform("size_in_split_axis","u32",l.length).declareVariables(a,...o)}
  ${jH(l.length)}
  ${qH(o)}

  ${f.mainStart()}
    ${f.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.input_size")}

    var indices = ${a.offsetToIndices("global_idx")};
    var index = ${a.indicesGet("indices",r)};
    let output_number = calculateOutputIndex(index);
    if (output_number != 0) {
      index -= ${Et("uniforms.size_in_split_axis","output_number - 1u",l.length)};
      ${a.indicesSet("indices",r,"index")};
    }
    writeBufferData(output_number, indices, global_idx);
  }`;return{name:"Split",shaderCache:{hint:e.cacheKey,inputDependencies:["rank"]},getShaderSource:p,getRunData:()=>({outputs:c,dispatchGroup:{x:Math.ceil(n/64)},programUniforms:h})}},GK=(s,e)=>{WH(s.inputs);let t=s.inputs.length===1?e:HH(s.inputs,e);s.compute(KD(s.inputs,t),{inputs:[0]})},WK=s=>{let e=s.axis,t=s.splitSizes,n=s.numOutputs<0?t.length:s.numOutputs;if(n!==t.length)throw new Error("numOutputs and splitSizes lengh must be equal");return Mn({axis:e,numOutputs:n,splitSizes:t})}}),KH,Q0,jK,qK=Ze(()=>{"use strict";$t(),Ht(),cs(),qt(),KH=(s,e)=>{let[t,n,i,r]=s,{numHeads:o,rotaryEmbeddingDim:a}=e;if(t.dims.length!==3&&t.dims.length!==4)throw new Error(`Input 'x' is expected to have 3 or 4 dimensions, got ${t.dims.length}`);if(!Ie.areEqual(n.dims,[])&&!Ie.areEqual(n.dims,[1])&&n.dims.length!==2)throw new Error(`Input 'position_ids' is expected to have 0, 1, or 2 dimensions, got ${n.dims.length}`);if(i.dims.length!==2)throw new Error(`Input 'cos_cache' is expected to have 2 dimensions, got ${i.dims.length}`);if(r.dims.length!==2)throw new Error(`Input 'sin_cache' is expected to have 2 dimensions, got ${r.dims.length}`);if(!Ie.areEqual(i.dims,r.dims))throw new Error("Inputs 'cos_cache' and 'sin_cache' are expected to have the same shape");if(a>0&&o===0)throw new Error("num_heads must be provided if rotary_embedding_dim is specified");let l=t.dims[0],c=t.dims[t.dims.length-2],d=i.dims[0],u=Ie.sizeFromDimension(t.dims,1)/c,h=a===0?i.dims[1]*2:u/o;if(a>h)throw new Error("rotary_embedding_dim must be less than or equal to head_size");if(n.dims.length===2){if(l!==n.dims[0])throw new Error(`Input 'position_ids' dimension 0 should be of size batch_size, got ${n.dims[0]}`);if(c!==n.dims[1])throw new Error(`Input 'position_ids' dimension 1 should be of size sequence_length, got ${n.dims[1]}`)}if(h/2!==i.dims[1]&&a/2!==i.dims[1])throw new Error(`Input 'cos_cache' dimension 1 should be same as head_size / 2 or rotary_embedding_dim / 2, got ${i.dims[1]}`);if(c>d)throw new Error("Updating cos_cache and sin_cache in RotaryEmbedding is not currently supported")},Q0=(s,e)=>{let{interleaved:t,numHeads:n,rotaryEmbeddingDim:i,scale:r}=e,o=s[0].dims[0],a=Ie.sizeFromDimension(s[0].dims,1),l=s[0].dims[s[0].dims.length-2],c=a/l,d=s[2].dims[1],u=i===0?d*2:c/n,h=new Array(o,l,c/u,u-d),p=Ie.computeStrides(h),f=[{type:1,data:r},{type:12,data:h},{type:12,data:p},...s[0].dims.length===3?new Array({type:12,data:[a,c,u,1]}):[],...s[0].dims.length===4?new Array({type:12,data:[a,u,l*u,1]}):[],...St(s[0].dims,s[1].dims,s[2].dims,s[3].dims,s[0].dims)],_=b=>{let y=Ue("input",s[0].dataType,s[0].dims.length),w=Ue("position_ids",s[1].dataType,s[1].dims.length),C=Ue("cos_cache",s[2].dataType,s[2].dims.length),M=Ue("sin_cache",s[3].dataType,s[3].dims.length),S=bt("output",s[0].dataType,s[0].dims.length);return b.registerUniforms([{name:"scale",type:"f32"},{name:"global_shape",type:"u32",length:h.length},{name:"global_strides",type:"u32",length:p.length},{name:"input_output_strides",type:"u32",length:p.length}]),`
        ${b.declareVariables(y,w,C,M,S)}

        ${b.mainStart(qf)}
          let half_rotary_emb_dim = uniforms.${C.name}_shape[1];
          let bsnh = global_idx / uniforms.global_strides % uniforms.global_shape;
          let size = uniforms.global_shape[0] * uniforms.global_strides[0];
          ${b.guardAgainstOutOfBoundsWorkgroupSizes("size")}

          if (bsnh[3] < half_rotary_emb_dim) {
            let position_ids_idx =
                ${w.broadcastedIndicesToOffset("bsnh.xy",bt("",w.type.tensor,2))};
            let position_id =
                u32(${w.getByOffset("position_ids_idx")}) + select(0, bsnh[1], position_ids_idx == 0);
            let i = dot(bsnh, uniforms.input_output_strides) + select(0, bsnh[3], ${t});
            let j = i + select(half_rotary_emb_dim, 1, ${t});
            let re = ${y.getByOffset("i")} * ${C.get("position_id","bsnh[3]")} -
                ${y.getByOffset("j")} * ${M.get("position_id","bsnh[3]")};
            ${S.setByOffset("i","re")}
            let im = ${y.getByOffset("i")} * ${M.get("position_id","bsnh[3]")} +
                ${y.getByOffset("j")} * ${C.get("position_id","bsnh[3]")};
            ${S.setByOffset("j","im")}
          } else {
            let k = dot(bsnh, uniforms.input_output_strides) + half_rotary_emb_dim;
            ${S.setByOffset("k",y.getByOffset("k"))}
          }
        }`};return{name:"RotaryEmbedding",shaderCache:{hint:Mn({interleaved:t}).cacheKey,inputDependencies:["rank","rank","rank","rank"]},getShaderSource:_,getRunData:()=>({outputs:[{dims:s[0].dims,dataType:s[0].dataType}],dispatchGroup:{x:Math.ceil(Ie.size(h)/qf)},programUniforms:f})}},jK=(s,e)=>{KH(s.inputs,e),s.compute(Q0(s.inputs,e))}}),YH,XH,mD,QH,KK,Nne=Ze(()=>{"use strict";cs(),$t(),p1(),VK(),HK(),Nc(),qK(),qt(),YH=(s,e)=>{if(e.doRotary&&s.length<=7)throw new Error("cos_cache and sin_cache inputs are required if do_rotary is specified");let t=s[0],n=s[1],i=s[2],r=s[3],o=s[4];if(e.doRotary!==0&&s.length<=7)throw new Error("cos_cast and sin_cache are expected if do_rotary attribute is non-zero");if(e.localWindowSize!==-1)throw new Error("Local attention is not supported");if(e.softcap!==0)throw new Error("Softcap is not supported");if(e.rotaryInterleaved!==0)throw new Error("Rotary interleaved is not supported");if(e.smoothSoftmax)throw new Error("Smooth softmax is not supported");if(t.dims.length!==3&&t.dims.length!==5)throw new Error("Input query is expected to have 3 or 5 dimensions");let a=!1,l=t.dims[0],c=t.dims[1],d=t.dims.length===3?a?t.dims[2]/3:t.dims[2]:e.numHeads*t.dims[4],u=c,h=0,p=!n||n.dims.length===0,f=Math.floor(p?d/(e.numHeads+2*e.kvNumHeads):d/e.numHeads);p&&(d=f*e.numHeads);let _=r&&r.dims.length!==0,b=o&&o.dims.length!==0;if(_&&r.dims.length===4&&r.dims[0]===l&&r.dims[1]!==e.kvNumHeads&&r.dims[2]===e.kvNumHeads&&r.dims[3]===f)throw new Error("BSNH pastKey/pastValue is not supported");if(_&&b){if(r.dims.length!==4)throw new Error('Input "past_key" is expected to have 4 dimensions');if(o.dims.length!==4)throw new Error('Input "past_value" is expected to have 4 dimensions');h=r.dims[2]}else if(_||b)throw new Error('Input "past_key" and "past_value" shall be both present or both absent');let y=1;if(n&&n.dims.length>0){if(t.dims.length!==3)throw new Error('Input "query" is expected to have 3 dimensions when key is given');if(n.dims.length<3||n.dims.length>5)throw new Error('Input "key" is expected to have 3, 4, or 5 dimensions');if(t.dims[0]!==n.dims[0])throw new Error('Input "query" and "key" shall have same dim 0 (batch size)');if(n.dims.length===3){if(t.dims[2]%n.dims[2]!==0)throw new Error('Dimension 2 of "query" should be a multiple of "key"');u=n.dims[1]}else if(n.dims.length===5){if(n.dims[2]!==e.numHeads||n.dims[3]!==2||n.dims[4]!==f)throw new Error('Expect "key" shape (batch_size, kv_sequence_length, num_heads, 2, head_size) for packed kv');if(i)throw new Error('Expect "value" be none when "key" has packed kv format.');u=n.dims[1]}else{if(n.dims[1]!==e.numHeads||n.dims[3]!==f)throw new Error('Expect "key" shape (batch_size, num_heads, kv_sequence_length, head_size) for past_key');u=n.dims[2]}}else{if(t.dims.length!==3&&t.dims.length!==5)throw new Error('Input "query" is expected to have 3 or 5 dimensions when key is empty');if(t.dims.length===5&&(t.dims[2]!==e.numHeads||t.dims[3]!==3))throw new Error('Expect "query" shape (batch_size, kv_sequence_length, num_heads, 3, head_size) for packed kv');y=3}let w=0,C=!1,M=e.kvNumHeads?f*e.kvNumHeads:d;if(i&&i.dims.length>0){if(i.dims.length!==3&&i.dims.length!==4)throw new Error('Input "value" is expected to have 3 or 4 dimensions');if(t.dims[0]!==i.dims[0])throw new Error('Input "query" and "value" shall have same dim 0 (batch_size)');if(i.dims.length===3){if(u!==i.dims[1])throw new Error('Input "key" and "value" shall have the same dim 1 (kv_sequence_length)');M=i.dims[2]}else{if(u!==i.dims[2])throw new Error('Input "past_key" and "past_value" shall have the same dim 2 (kv_sequence_length)');M=i.dims[1]*i.dims[3],C=!0}}let S=s.length>4?s[5]:void 0;if(S&&S.dims.length!==1&&S.dims[0]!==l)throw new Error('Input "seqlens" is expected to have 1 dimension and the same dim 0 as batch_size');return{batchSize:l,sequenceLength:c,pastSequenceLength:h,kvSequenceLength:u,totalSequenceLength:-1,maxSequenceLength:-1,inputHiddenSize:0,hiddenSize:d,vHiddenSize:M,headSize:f,vHeadSize:Math.floor(M/e.kvNumHeads),numHeads:e.numHeads,kvNumHeads:e.kvNumHeads,nReps:e.numHeads/e.kvNumHeads,pastPresentShareBuffer:!1,maskType:w,scale:e.scale,broadcastResPosBias:!1,passPastInKv:C,qkvFormat:y}},XH=Mn({perm:[0,2,1,3]}),mD=(s,e,t)=>{let n=e,i=t.kvNumHeads;return e.dims.length===3&&t.kvSequenceLength!==0&&(n=e.reshape([t.batchSize,t.kvSequenceLength,i,t.headSize]),n=s.compute(Er(n,XH.perm),{inputs:[n],outputs:[-1]})[0]),n},QH=(s,e,t,n)=>{let i=7,r=["type","type"],o=[s*e],a=s*e,l=[{type:12,data:a},{type:12,data:e},{type:12,data:s}],c=d=>{let u=Ue("seq_lens",t.dataType,t.dims),h=Ue("total_seq_lens",n.dataType,n.dims),p=bt("pos_ids",i,o),f=[{name:"output_size",type:"u32"},{name:"sequence_length",type:"u32"},{name:"batch_size",type:"u32"}];return`
  ${d.registerUniforms(f).declareVariables(u,h,p)}
  ${d.mainStart()}
    ${d.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}
    let total_sequence_length = u32(${h.getByOffset("0")});
    let is_subsequent_prompt = uniforms.sequence_length > 1 && uniforms.sequence_length != total_sequence_length;
    let is_first_prompt = !is_subsequent_prompt && uniforms.sequence_length == total_sequence_length;
    let batch_idx = global_idx / uniforms.sequence_length;
    let sequence_idx = i32(global_idx % uniforms.sequence_length);
    var pos_id: i32 = 0;
    let seqlen = ${u.getByOffset("batch_idx")};
    let total_seqlen = seqlen + 1;
    if (is_first_prompt) {
      if (sequence_idx < total_seqlen) {
        pos_id = sequence_idx;
      } else {
        pos_id = 1;
      }
      ${p.setByOffset("global_idx","pos_id")}
    } else if (is_subsequent_prompt) {
      let past_seqlen = total_seqlen - i32(uniforms.sequence_length);
      if (past_seqlen + sequence_idx < total_seqlen) {
        pos_id = past_seqlen + sequence_idx;
      } else {
        pos_id = 1;
      }
      ${p.setByOffset("global_idx","pos_id")}
    } else if (global_idx < uniforms.batch_size) {
      ${p.setByOffset("global_idx","seqlen")}
    };
  }
  `};return{name:"GeneratePositionIds",shaderCache:{hint:`${s};${e}`,inputDependencies:r},getRunData:()=>({outputs:[{dims:o,dataType:i}],dispatchGroup:{x:Math.ceil(a/64)},programUniforms:l}),getShaderSource:c}},KK=(s,e)=>{let t=YH(s.inputs,e);if(s.inputs[0].dims.length===5)throw new Error("Packed QKV is not implemented");if(s.inputs[1]?.dims.length===5)throw new Error("Packed KV is not implemented");let n=s.inputs[0],i=s.inputs[1]&&s.inputs[1].dims.length>0?s.inputs[1]:void 0,r=s.inputs[2]&&s.inputs[2].dims.length>0?s.inputs[2]:void 0,o=s.inputs[3]&&s.inputs[3].dims.length!==0?s.inputs[3]:void 0,a=s.inputs[4]&&s.inputs[4].dims.length!==0?s.inputs[4]:void 0,l=s.inputs.length>4?s.inputs[5]:void 0,c=s.inputs.length>5?s.inputs[6]:void 0,d=t.kvNumHeads?t.kvNumHeads:t.numHeads,u=Mn({axis:2,numOutputs:3,splitSizes:[t.numHeads*t.headSize,d*t.headSize,d*t.headSize]}),[h,p,f]=!i&&!r?s.compute(KD([n],u),{inputs:[n],outputs:[-1,-1,-1]}):[n,i,r],_,b;if(e.doRotary){let M=s.compute(QH(t.batchSize,t.sequenceLength,l,c),{inputs:[l,c],outputs:[-1]})[0],S=s.inputs[7],k=s.inputs[8],T=Mn({interleaved:e.rotaryInterleaved!==0,numHeads:t.numHeads,rotaryEmbeddingDim:0,scale:e.scale}),P=[h,M,S,k],R=[-1];_=s.compute(Q0(P,T),{inputs:P,outputs:R})[0],P.splice(0,1,p);let O=Mn({interleaved:e.rotaryInterleaved!==0,numHeads:t.kvNumHeads,rotaryEmbeddingDim:0,scale:e.scale});b=s.compute(Q0(P,O),{inputs:P,outputs:R})[0]}let y=rv(s,t.batchSize,t.numHeads,t.sequenceLength,t.headSize,e.doRotary?_:h,void 0,0),w=mD(s,e.doRotary?b:p,t),C=mD(s,f,t);cv(s,y,w,C,void 0,void 0,o,a,void 0,t,l,c)}}),gD,JH,ZH,YK,One=Ze(()=>{"use strict";$t(),Ht(),Nc(),qt(),gD=(s,e,t,n,i,r,o,a)=>{let l=es(r),c=l===1?"f32":`vec${l}f`,d=l===1?"vec2f":`mat2x${l}f`,u=i*o,h=64;u===1&&(h=256);let p=[i,o,r/l],f=[i,o,2],_=["rank","type","type"],b=[];b.push(...St(p,f));let y=w=>{let C=Ue("x",e.dataType,3,l),M=Ue("scale",t.dataType,t.dims),S=Ue("bias",n.dataType,n.dims),k=bt("output",1,3,2),T=[C,M,S,k];return`
  var<workgroup> workgroup_shared : array<${d}, ${h}>;
  const workgroup_size = ${h}u;
  ${w.declareVariables(...T)}
  ${w.mainStart(h)}
    let batch = workgroup_index / uniforms.x_shape[1];
    let channel = workgroup_index % uniforms.x_shape[1];
    let hight = uniforms.x_shape[2];
    // initialize workgroup memory
    var sum = ${c}(0);
    var squared_sum = ${c}(0);
    for (var h = local_idx; h < hight; h += workgroup_size) {
      let value = ${c}(${C.get("batch","channel","h")});
      sum += value;
      squared_sum += value * value;
    }
    workgroup_shared[local_idx] = ${d}(sum, squared_sum);
    workgroupBarrier();

    for (var currSize = workgroup_size >> 1;  currSize > 0; currSize = currSize >> 1) {
      if (local_idx < currSize) {
        workgroup_shared[local_idx] = workgroup_shared[local_idx] + workgroup_shared[local_idx + currSize];
      }
      workgroupBarrier();
    }
    if (local_idx == 0) {
      let sum_final = ${Lc("workgroup_shared[0][0]",l)} / f32(hight * ${l});
      let squared_sum_final = ${Lc("workgroup_shared[0][1]",l)} / f32(hight * ${l});

      let inv_std_dev = inverseSqrt(squared_sum_final - sum_final * sum_final + f32(${a}));
      let channel_scale = inv_std_dev * f32(scale[channel]);
      let channel_shift = f32(bias[channel]) - sum_final * channel_scale;
      output[workgroup_index] = vec2f(channel_scale, channel_shift);
    }
  }`};return s.compute({name:"InstanceNormComputeChannelScaleShift",shaderCache:{hint:`${l};${a};${h}`,inputDependencies:_},getRunData:()=>({outputs:[{dims:f,dataType:1}],dispatchGroup:{x:u},programUniforms:b}),getShaderSource:y},{inputs:[e,t,n],outputs:[-1]})[0]},JH=(s,e,t)=>{let n=e[0].dims,i=n,r=2,o=n[0],a=n[1],l=Ie.sizeFromDimension(n,r),c=es(l),d=Ie.size(i)/c,u=gD(s,e[0],e[1],e[2],o,l,a,t.epsilon),h=[o,a,l/c],p=[o,a],f=["type","none"],_=b=>{let y=Ue("x",e[0].dataType,h.length,c),w=Ue("scale_shift",1,p.length,2),C=bt("output",e[0].dataType,h.length,c),M=[y,w,C];return`
  ${b.registerUniform("output_size","u32").declareVariables(...M)}
  ${b.mainStart()}
  ${b.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}
      let outputIndices = ${C.offsetToIndices("global_idx")};
      let batch = outputIndices[0];
      let channel = outputIndices[1];
      let scale_shift = ${w.getByIndices("vec2<u32>(batch, channel)")};
      let value = ${y.getByOffset("global_idx")} * ${C.type.value}(scale_shift.x) + ${C.type.value}(scale_shift.y);
      ${C.setByOffset("global_idx","value")};
  }`};s.compute({name:"InstanceNormalization",shaderCache:{hint:`${c}`,inputDependencies:f},getRunData:()=>({outputs:[{dims:i,dataType:e[0].dataType}],dispatchGroup:{x:Math.ceil(d/64)},programUniforms:[{type:12,data:d},...St(h,p,h)]}),getShaderSource:_},{inputs:[e[0],u]})},ZH=(s,e,t)=>{let n=e[0].dims,i=n,r=n[0],o=n[n.length-1],a=Ie.sizeFromDimension(n,1)/o,l=es(o),c=Ie.size(i)/l,d=[{type:12,data:a},{type:12,data:Math.floor(o/l)}],u=["type","type"],h=!1,p=[0,n.length-1];for(let y=0;y<n.length-2;y++)h=h||n[y+1]!==1,p.push(y+1);h=h&&n[n.length-1]!==1;let f=h?s.compute(Er(s.inputs[0],p),{inputs:[s.inputs[0]],outputs:[-1]})[0]:s.inputs[0].reshape(Array.from({length:n.length},(y,w)=>n[p[w]])),_=gD(s,f,e[1],e[2],r,a,o,t.epsilon),b=y=>{let w=Vs(e[0].dataType),C=l===1?"vec2f":`mat${l}x2f`,M=T=>{let P=T===0?"x":"y",R=l===1?"f32":`vec${l}f`;switch(l){case 1:return`${w}(${R}(scale.${P}))`;case 2:return`vec2<${w}>(${R}(scale[0].${P}, scale[1].${P}))`;case 4:return`vec4<${w}>(${R}(scale[0].${P}, scale[1].${P}, scale[2].${P}, scale[3].${P}))`;default:throw new Error(`Not supported compoents ${l}`)}},S=Ue("input",e[0].dataType,e[0].dims,l),k=bt("output",e[0].dataType,i,l);return`
  @group(0) @binding(0) var<storage, read> input : array<${S.type.storage}>;
  @group(0) @binding(1) var<storage, read> scale_input : array<${C}>;
  @group(0) @binding(2) var<storage, read_write> output : array<${k.type.storage}>;
  struct Uniforms {H: u32, C : u32};
  @group(0) @binding(3) var<uniform> uniforms: Uniforms;

  ${y.mainStart()}
    let current_image_number = global_idx / (uniforms.C * uniforms.H);
    let current_channel_number = global_idx % uniforms.C;

    let scale_offset = current_image_number * uniforms.C + current_channel_number;
    let scale = scale_input[scale_offset];
    output[global_idx] = fma(input[global_idx], ${M(0)}, ${M(1)});
  }`};s.compute({name:"InstanceNormalizationNHWC",shaderCache:{hint:`${l}`,inputDependencies:u},getRunData:()=>({outputs:[{dims:i,dataType:e[0].dataType}],dispatchGroup:{x:Math.ceil(c/64)},programUniforms:d}),getShaderSource:b},{inputs:[e[0],_]})},YK=(s,e)=>{e.format==="NHWC"?ZH(s,s.inputs,e):JH(s,s.inputs,e)}}),ej,tj,XK,$ne=Ze(()=>{"use strict";$t(),Ht(),qt(),ej=s=>{if(!s||s.length<2)throw new Error("layerNorm requires at least 2 inputs.")},tj=(s,e,t)=>{let n=e.simplified,i=s[0].dims,r=s[1],o=!n&&s[2],a=i,l=Ie.normalizeAxis(e.axis,i.length),c=Ie.sizeToDimension(i,l),d=Ie.sizeFromDimension(i,l),u=Ie.size(r.dims),h=o?Ie.size(o.dims):0;if(u!==d||o&&h!==d)throw new Error(`Size of X.shape()[axis:] == ${d}.
       Size of scale and bias (if provided) must match this.
       Got scale size of ${u} and bias size of ${h}`);let p=[];for(let S=0;S<i.length;++S)S<l?p.push(i[S]):p.push(1);let f=es(d),_=["type","type"],b=[{type:12,data:c},{type:1,data:d},{type:12,data:Math.floor(d/f)},{type:1,data:e.epsilon}];o&&_.push("type");let y=t>1,w=t>2,C=S=>{let k=Vs(s[0].dataType),T=[Ue("x",s[0].dataType,s[0].dims,f),Ue("scale",r.dataType,r.dims,f)];o&&T.push(Ue("bias",o.dataType,o.dims,f)),T.push(bt("output",s[0].dataType,a,f)),y&&T.push(bt("mean_data_output",1,p)),w&&T.push(bt("inv_std_output",1,p));let P=[{name:"norm_count",type:"u32"},{name:"norm_size",type:"f32"},{name:"norm_size_vectorized",type:"u32"},{name:"epsilon",type:"f32"}];return`
  ${S.registerUniforms(P).declareVariables(...T)}
  ${S.mainStart()}
    ${S.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.norm_count")}
    let offset = global_idx * uniforms.norm_size_vectorized;
    var mean_vector = ${BD("f32",f)};
    var mean_square_vector = ${BD("f32",f)};

    for (var h: u32 = 0u; h < uniforms.norm_size_vectorized; h++) {
      let value = ${Hf(k,f,"x[h + offset]")};
      mean_vector += value;
      mean_square_vector += value * value;
    }
    let mean = ${Lc("mean_vector",f)} / uniforms.norm_size;
    let inv_std_dev = inverseSqrt(${Lc("mean_square_vector",f)} / uniforms.norm_size ${n?"":"- mean * mean"} + uniforms.epsilon);

    for (var j: u32 = 0; j < uniforms.norm_size_vectorized; j++) {
      let f32input = ${Hf(k,f,"x[j + offset]")};
      let f32scale = ${Hf(k,f,"scale[j]")};
      output[j + offset] = ${T[0].type.value}((f32input ${n?"":"- mean"}) * inv_std_dev * f32scale
        ${o?`+ ${Hf(k,f,"bias[j]")}`:""}
      );
    }

    ${y?"mean_data_output[global_idx] = mean":""};
    ${w?"inv_std_output[global_idx] = inv_std_dev":""};
  }`},M=[{dims:a,dataType:s[0].dataType}];return y&&M.push({dims:p,dataType:1}),w&&M.push({dims:p,dataType:1}),{name:"LayerNormalization",shaderCache:{hint:`${f};${t};${n}`,inputDependencies:_},getRunData:()=>({outputs:M,dispatchGroup:{x:Math.ceil(c/64)},programUniforms:b}),getShaderSource:C}},XK=(s,e)=>{ej(s.inputs),s.compute(tj(s.inputs,e,s.outputCount))}}),nj,QK,Bne=Ze(()=>{"use strict";Ht(),y1(),v1(),nj=s=>{if(!s||s.length!==2)throw new Error("MatMul requires 2 inputs.");if(s[0].dims[s[0].dims.length-1]!==s[1].dims[s[1].dims.length-2])throw new Error("shared dimension does not match.")},QK=s=>{nj(s.inputs);let e=jf.calcShape(s.inputs[0].dims,s.inputs[1].dims,!0);if(!e)throw new Error("Can't use matmul on the given tensors");let t=e[e.length-1],n=s.inputs[0].dims[s.inputs[0].dims.length-1];if(t<8&&n<8)s.compute(_1(s.inputs,{activation:""},e));else{let i=e[e.length-2],r=Ie.size(s.inputs[0].dims.slice(0,-2)),o=Ie.size(s.inputs[1].dims.slice(0,-2));if(r!==1&&i===1&&o===1){let a=s.inputs[0].reshape([1,r,n]),l=s.inputs[1].reshape([1,n,t]),c=[1,r,t],d=[a,l];s.compute(X0(d,{activation:""},e,c),{inputs:d})}else s.compute(X0(s.inputs,{activation:""},e))}}}),sj,ij,rj,JK,ZK,zne=Ze(()=>{"use strict";$t(),Ht(),cs(),qt(),sj=(s,e)=>{if(s.length<3||s.length>4)throw new Error("MatMulNBits requires 3 or 4 inputs");let t=s[0],n=t.dims.length;if(t.dims[n-1]!==e.k)throw new Error("The last dim of input shape does not match the k value");let i=Math.floor((e.k+e.blockSize-1)/e.blockSize),r=e.blockSize/8*e.bits,o=s[1];if(!Ie.areEqual(o.dims,[e.n,i,r]))throw new Error("The second inputs must be 3D tensor with shape N X nBlocksPerCol X blobSize");let a=s[2].dims;if(Ie.size(a)!==e.n*i)throw new Error("scales input size error.");if(s.length===4){let l=s[3].dims,c=e.bits>4?e.n*i:e.n*Math.floor((i+1)/2);if(Ie.size(l)!==c)throw new Error("zeroPoints input size error.")}},ij=(s,e)=>{let t=s[0].dims,n=t.length,i=t[n-2],r=e.k,o=e.n,a=t.slice(0,n-2),l=Ie.size(a),c=s[1].dims[2]/4,d=s[0].dataType,u=es(e.k),h=es(c),p=es(o),f=a.concat([i,o]),_=i>1&&o/p%2===0?2:1,b=Ie.size(f)/p/_,y=64,w=[],C=[l,i,r/u],M=Ie.convertShape(s[1].dims).slice();M.splice(-1,1,c/h),w.push(...St(C)),w.push(...St(M)),w.push(...St(s[2].dims)),s.length===4&&w.push(...St(Ie.convertShape(s[3].dims)));let S=[l,i,o/p];w.push(...St(S));let k=T=>{let P=C.length,R=Ue("a",s[0].dataType,P,u),O=Ue("b",12,M.length,h),H=Ue("scales",s[2].dataType,s[2].dims.length),X=[R,O,H],z=s.length===4?Ue("zero_points",12,s[3].dims.length):void 0;z&&X.push(z);let ne=S.length,re=bt("output",s[0].dataType,ne,p),Y=Vs(s[0].dataType),se=(()=>{switch(u){case 1:return`array<${Y}, 8>`;case 2:return`mat4x2<${Y}>`;case 4:return`mat2x4<${Y}>`;default:throw new Error(`${u}-component is not supported.`)}})(),ue=()=>{let oe=`
          // reuse a data
            var input_offset = ${R.indicesToOffset(`${R.type.indices}(batch, row, word_offset)`)};
            var a_data: ${se};
            for (var j: u32 = 0; j < ${8/u}; j++) {
              a_data[j] = ${R.getByOffset("input_offset")};
              input_offset++;
            }
          `;for(let te=0;te<p*_;te++)oe+=`
            b_value = ${h===1?`b${te}_data`:`b${te}_data[i]`};
            b_value_lower = unpack4xU8(b_value & b_mask);
            b_value_upper = unpack4xU8((b_value >> 4) & b_mask);
            b_quantized_values = ${se}(${Array.from({length:4},(j,G)=>`${Y}(b_value_lower[${G}]), ${Y}(b_value_upper[${G}])`).join(", ")});
            b_dequantized_values = ${u===1?`${se}(${Array.from({length:8},(j,G)=>`(b_quantized_values[${G}] - ${z?`zero_point${te}`:"zero_point"}) * scale${te}`).join(", ")});`:`(b_quantized_values - ${se}(${Array(8).fill(`${z?`zero_point${te}`:"zero_point"}`).join(",")})) * scale${te};`};
            workgroup_shared[local_id.x * ${_} + ${Math.floor(te/p)}]${p>1?`[${te%p}]`:""} += ${Array.from({length:8/u},(j,G)=>`${u===1?`a_data[${G}] * b_dequantized_values[${G}]`:`dot(a_data[${G}], b_dequantized_values[${G}])`}`).join(" + ")};
          `;return oe},fe=()=>{let oe=`
            var col_index = col * ${p};
            ${z?`
            let zero_point_bytes_per_col = (nBlocksPerCol + 1) / 2;
            var zero_point_byte_count: u32;
            var zero_point_word_index: u32;
            var zero_point_byte_offset: u32;
            let zero_point_nibble_offset: u32 = block & 0x1u;
            var zero_point_bits_offset: u32;
            var zero_point_word: u32;`:`
            // The default zero point is 8 for unsigned 4-bit quantization.
            let zero_point = ${Y}(8);`}
            `;for(let te=0;te<p*_;te++)oe+=`
            let scale${te} = ${H.getByOffset("col_index * nBlocksPerCol + block")};
            ${z?`
            zero_point_byte_count = col_index * zero_point_bytes_per_col + (block >> 0x1u);
            zero_point_word_index = zero_point_byte_count >> 0x2u;
            zero_point_byte_offset = zero_point_byte_count & 0x3u;
            zero_point_bits_offset = (zero_point_byte_offset << 3) + (zero_point_nibble_offset << 2);
            zero_point_word = ${z.getByOffset("zero_point_word_index")} >> zero_point_bits_offset;
            let zero_point${te} = ${Y}((zero_point_word) & 0xFu);`:""}
            col_index += 1;`;return oe},Pe=()=>{let oe=`col_index = col * ${p};`;for(let te=0;te<p*_;te++)oe+=`
            let b${te}_data = ${O.getByIndices(`${O.type.indices}(col_index, block, word)`)};
            col_index += 1;`;return oe+=`
            var b_value: u32;
            let b_mask: u32 = 0x0F0F0F0Fu;
            var b_value_lower: vec4<u32>;
            var b_value_upper: vec4<u32>;
            var b_quantized_values: ${se};
            var b_dequantized_values: ${se};`,oe};return`
        var<workgroup> workgroup_shared: array<${re.type.value}, ${_*y}>;
        ${T.declareVariables(...X,re)}
        ${T.mainStart([y,1,1])}
          let output_indices = ${re.offsetToIndices(`(global_idx / ${y}) * ${_}`)};
          let col = output_indices[2];
          let row = output_indices[1];
          let batch = output_indices[0];
          let nBlocksPerCol = uniforms.b_shape[1];

          for (var block = local_id.x; block < nBlocksPerCol; block += ${y}) {
            //process one block
            var word_offset: u32 = block * ${e.blockSize/u};
            ${fe()}
            for (var word: u32 = 0; word < ${c}; word += ${h}) {
              ${Pe()}
              for (var i: u32 = 0; i < ${h}; i++) {
                ${ue()}
                word_offset += ${8/u};
              }
            }
          }
          workgroupBarrier();

          if (local_id.x < ${_}) {
            var output_value: ${re.type.value} = ${re.type.value}(0);
            var workgroup_shared_offset: u32 = local_id.x;
            for (var b: u32 = 0u; b < ${y}u; b++) {
              output_value += workgroup_shared[workgroup_shared_offset];
              workgroup_shared_offset += ${_};
            }
            ${re.setByIndices(`${re.type.indices}(batch, row, col + local_id.x)`,"output_value")};
          }
        }`};return{name:"MatMulNBits",shaderCache:{hint:`${e.blockSize};${e.bits};${u};${h};${p};${_};${y}`,inputDependencies:Array(s.length).fill("rank")},getRunData:()=>({outputs:[{dims:f,dataType:d}],dispatchGroup:{x:b},programUniforms:w}),getShaderSource:k}},rj=(s,e)=>{let t=s[0].dims,n=t.length,i=t[n-2],r=e.k,o=e.n,a=t.slice(0,n-2),l=Ie.size(a),c=s[1].dims[2]/4,d=s[0].dataType,u=es(e.k),h=es(c),p=a.concat([i,o]),f=128,_=o%8===0?8:o%4===0?4:1,b=f/_,y=b*h*8,w=y/u,C=y/e.blockSize,M=Ie.size(p)/_,S=[],k=[l,i,r/u],T=Ie.convertShape(s[1].dims).slice();T.splice(-1,1,c/h),S.push(...St(k)),S.push(...St(T)),S.push(...St(s[2].dims)),s.length===4&&S.push(...St(Ie.convertShape(s[3].dims)));let P=[l,i,o];S.push(...St(P));let R=O=>{let H=k.length,X=Ue("a",s[0].dataType,H,u),z=Ue("b",12,T.length,h),ne=Ue("scales",s[2].dataType,s[2].dims.length),re=[X,z,ne],Y=s.length===4?Ue("zero_points",12,s[3].dims.length):void 0;Y&&re.push(Y);let se=P.length,ue=bt("output",s[0].dataType,se),fe=Vs(s[0].dataType),Pe=()=>{switch(u){case 1:return`
          let a_data0 = vec4<${fe}>(sub_a[word_offset], sub_a[word_offset + 1], sub_a[word_offset + 2], sub_a[word_offset + 3]);
          let a_data1 = vec4<${fe}>(sub_a[word_offset + 4], sub_a[word_offset + 5], sub_a[word_offset + 6], sub_a[word_offset + 7]);`;case 2:return`
          let a_data0 = vec4<${fe}>(sub_a[word_offset], sub_a[word_offset + 1]);
          let a_data1 = vec4<${fe}>(sub_a[word_offset + 2], sub_a[word_offset + 3]);`;case 4:return`
          let a_data0 = sub_a[word_offset];
          let a_data1 = sub_a[word_offset + 1];`;default:throw new Error(`${u}-component is not supported.`)}};return`
        var<workgroup> sub_a: array<${X.type.value}, ${w}>;
        var<workgroup> inter_results: array<array<${ue.type.value}, ${b}>, ${_}>;
        ${O.declareVariables(...re,ue)}
        ${O.mainStart([b,_,1])}
          let output_indices = ${ue.offsetToIndices(`workgroup_index * ${_}`)};
          let col = output_indices[2];
          let row = output_indices[1];
          let batch = output_indices[0];
          let n_blocks_per_col = uniforms.b_shape[1];
          let num_tiles =  (n_blocks_per_col - 1) / ${C} + 1;

          // Loop over shared dimension.
          for (var tile: u32 = 0; tile < num_tiles; tile += 1) {
            let a_col_start = tile * ${w};
            // load one tile A data into shared memory.
            for (var a_offset = local_idx; a_offset < ${w}; a_offset += ${f})
            {
              let a_col = a_col_start + a_offset;
              if (a_col < uniforms.a_shape[2])
              {
                sub_a[a_offset] = ${X.getByIndices(`${X.type.indices}(batch, row, a_col)`)};
              } else {
                sub_a[a_offset] = ${X.type.value}(0);
              }
            }
            workgroupBarrier();

            // each thread process one block
            let b_row = col + local_id.y;
            let block = tile * ${C} + local_id.x;
            ${Y?`
            let zero_point_bytes_per_col = (n_blocks_per_col + 1) / 2;
            let zero_point_byte_count = b_row * zero_point_bytes_per_col + (block >> 0x1u);
            let zero_point_word_index = zero_point_byte_count >> 0x2u;
            let zero_point_byte_offset = zero_point_byte_count & 0x3u;
            let zero_point_nibble_offset: u32 = block & 0x1u;
            let zero_point_bits_offset = (zero_point_byte_offset << 3) + (zero_point_nibble_offset << 2);
            let zero_point_word = ${Y.getByOffset("zero_point_word_index")} >> zero_point_bits_offset;
            let zero_point = ${fe}((zero_point_word) & 0xFu);`:`
            // The default zero point is 8 for unsigned 4-bit quantization.
            let zero_point = ${fe}(8);`}
            let scale = ${ne.getByOffset("b_row * n_blocks_per_col + block")};
            let b_data = ${z.getByIndices(`${z.type.indices}(b_row, block, 0)`)};
            var word_offset = local_id.x * ${e.blockSize/u};
            for (var i: u32 = 0; i < ${h}; i++) {
              ${Pe()}
              let b_value = ${h===1?"b_data":"b_data[i]"};
              let b_value_lower = unpack4xU8(b_value & 0x0F0F0F0Fu);
              let b_value_upper = unpack4xU8((b_value >> 4) & 0x0F0F0F0Fu);
              let b_quantized_values = mat2x4<${fe}>(${Array.from({length:4},(oe,te)=>`${fe}(b_value_lower[${te}]), ${fe}(b_value_upper[${te}])`).join(", ")});
              let b_dequantized_values = (b_quantized_values - mat2x4<${fe}>(${Array(8).fill("zero_point").join(",")})) * scale;
              inter_results[local_id.y][local_id.x] += ${Array.from({length:2},(oe,te)=>`${`dot(a_data${te}, b_dequantized_values[${te}])`}`).join(" + ")};
              word_offset += ${8/u};
            }
            workgroupBarrier();
          }

          if (local_idx < ${_}) {
            var output_value: ${ue.type.value} = ${ue.type.value}(0);
            for (var b = 0u; b < ${b}; b++) {
              output_value += inter_results[local_idx][b];
            }
            if (col + local_idx < uniforms.output_shape[2])
            {
              ${ue.setByIndices(`${ue.type.indices}(batch, row, col + local_idx)`,"output_value")}
            }
          }
        }`};return{name:"BlockwiseMatMulNBits32",shaderCache:{hint:`${e.blockSize};${u};${h};${b};${_}`,inputDependencies:Array(s.length).fill("rank")},getRunData:()=>({outputs:[{dims:p,dataType:d}],dispatchGroup:{x:M},programUniforms:S}),getShaderSource:R}},JK=(s,e)=>{sj(s.inputs,e),e.blockSize===32&&s.adapterInfo.isVendor("intel")&&s.adapterInfo.isArchitecture("gen-12lp")?s.compute(rj(s.inputs,e)):s.compute(ij(s.inputs,e))},ZK=s=>Mn(s)}),oj,aj,lj,cj,dj,uj,hj,pj,e5,Une=Ze(()=>{"use strict";$t(),Ht(),qt(),oj=s=>{if(!s||s.length<1)throw new Error("Too few inputs");if(s[0].dataType!==1&&s[0].dataType!==10)throw new Error("Input type must be float or float16.");if(s.length>=2){let e=s[0].dims.length*2===s[1].dims[0];if(s.length===4&&(e=s[3].dims[0]*2===s[1].dims[0]),!e)throw new Error("The pads should be a 1D tensor of shape [2 * input_rank] or [2 * num_axes].")}},aj=(s,e,t)=>{let n="";for(let i=e-1;i>=0;--i)n+=`
            k = i32(${s.indicesGet("indices",i)}) - ${Et("uniforms.pads",i,t)};
            if (k < 0) {
              break;
            }
            if (k >= i32(${Et("uniforms.x_shape",i,e)})) {
              break;
            }
            offset += k * i32(${Et("uniforms.x_strides",i,e)});
        `;return`
          value = ${s.type.value}(uniforms.constant_value);
          for (var i = 0; i < 1; i++) {
            var offset = 0;
            var k = 0;
            ${n}
            value = x[offset];
          }
      `},lj=(s,e,t)=>{let n="";for(let i=e-1;i>=0;--i)n+=`
                k = i32(${s.indicesGet("indices",i)}) - ${Et("uniforms.pads",i,t)};
                if (k < 0) {
                  k = -k;
                }
                {
                  let _2n_1 = 2 * (i32(${Et("uniforms.x_shape",i,e)}) - 1);
                  k = k % _2n_1;
                  if(k >= i32(${Et("uniforms.x_shape",i,e)})) {
                    k = _2n_1 - k;
                  }
                }
                offset += k * i32(${Et("uniforms.x_strides",i,e)});
            `;return`
              var offset = 0;
              var k = 0;
              ${n}
              value = x[offset];
          `},cj=(s,e,t)=>{let n="";for(let i=e-1;i>=0;--i)n+=`
                k = i32(${s.indicesGet("indices",i)}) - ${Et("uniforms.pads",i,t)};
                if (k < 0) {
                  k = 0;
                }
                if (k >= i32(${Et("uniforms.x_shape",i,e)})) {
                  k = i32(${Et("uniforms.x_shape",i,e)}) - 1;
                }
                offset += k * i32(${Et("uniforms.x_strides",i,e)});
            `;return`
              var offset = 0;
              var k = 0;
              ${n}
              value = x[offset];
          `},dj=(s,e,t)=>{let n="";for(let i=e-1;i>=0;--i)n+=`
                k = i32(${s.indicesGet("indices",i)}) - ${Et("uniforms.pads",i,t)};
                if (k < 0)  {
                  k += i32(${Et("uniforms.x_shape",i,e)}]);
                }
                if (k >= i32(${Et("uniforms.x_shape",i,e)})) {
                  k -= i32(${Et("uniforms.x_shape",i,e)});
                }
                offset += k * i32(${Et("uniforms.x_strides",i,e)});
            `;return`
              var offset = 0;
              var k = 0;
              ${n}
              value = x[offset];
          `},uj=(s,e,t)=>{switch(t.mode){case 0:return aj(s,e,t.pads.length);case 1:return lj(s,e,t.pads.length);case 2:return cj(s,e,t.pads.length);case 3:return dj(s,e,t.pads.length);default:throw new Error("Invalid mode")}},hj=(s,e)=>{let t=Ie.padShape(s[0].dims.slice(),e.pads),n=s[0].dims,i=Ie.size(t),r=[{type:12,data:i},{type:6,data:e.pads}],o=s.length>=3&&s[2].data;e.mode===0&&r.push({type:o?s[2].dataType:1,data:e.value}),r.push(...St(s[0].dims,t));let a=["rank"],l=c=>{let d=bt("output",s[0].dataType,t.length),u=Ue("x",s[0].dataType,n.length),h=u.type.value,p=uj(d,n.length,e),f=[{name:"output_size",type:"u32"},{name:"pads",type:"i32",length:e.pads.length}];return e.mode===0&&f.push({name:"constant_value",type:o?h:"f32"}),`
            ${c.registerUniforms(f).declareVariables(u,d)}
            ${c.mainStart()}
            ${c.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}

            let indices = ${d.offsetToIndices("global_idx")};

            var value = ${h}(0);
            ${p}
            output[global_idx] = value;
        }`};return{name:"Pad",shaderCache:{hint:`${e.mode}${o}`,inputDependencies:a},getRunData:()=>({outputs:[{dims:t,dataType:s[0].dataType}],dispatchGroup:{x:Math.ceil(Ie.size(t)/64)},programUniforms:r}),getShaderSource:l}},pj=(s,e)=>{if(s.length>1){let t=s[1].getBigInt64Array(),n=s.length>=3&&s[2].data?s[2].dataType===10?s[2].getUint16Array()[0]:s[2].getFloat32Array()[0]:0,i=s[0].dims.length,r=new Int32Array(2*i).fill(0);if(s.length>=4){let a=s[3].getBigInt64Array();for(let l=0;l<a.length;l++)r[Number(a[l])]=Number(t[l]),r[Number(a[l])+i]=Number(t[l+a.length])}else t.forEach((a,l)=>r[Number(l)]=Number(a));let o=[];return r.forEach(a=>o.push(a)),{mode:e.mode,value:n,pads:o}}else return e},e5=(s,e)=>{oj(s.inputs);let t=pj(s.inputs,e);s.compute(hj(s.inputs,t),{inputs:[0]})}}),Jy,_D,yD,vD,bD,fj,mj,wD,MD,t5,n5,TD,s5,i5,ED,r5,o5,a5,l5,Vne=Ze(()=>{"use strict";No(),$t(),Ht(),qt(),Jy=s=>{if(Un.webgpu.validateInputContent&&(!s||s.length!==1))throw new Error("Pool ops requires 1 input.")},_D=(s,e,t)=>{let n=e.format==="NHWC",i=s.dims.slice();n&&i.splice(1,0,i.pop());let r=Object.hasOwnProperty.call(e,"dilations"),o=e.kernelShape.slice(),a=e.strides.slice(),l=r?e.dilations.slice():[],c=e.pads.slice();K0.adjustPoolAttributes(t,i,o,a,l,c);let d=K0.computePoolOutputShape(t,i,a,l,o,c,e.autoPad),u=Object.assign({},e);r?Object.assign(u,{kernelShape:o,strides:a,pads:c,dilations:l,cacheKey:e.cacheKey}):Object.assign(u,{kernelShape:o,strides:a,pads:c,cacheKey:e.cacheKey});let h=d.slice();return h.push(h.splice(1,1)[0]),[u,n?h:d]},yD=(s,e)=>{let t=e.format==="NHWC",n=Ie.size(s),i=Ie.size(e.kernelShape),r=[{type:12,data:n},{type:12,data:i}],o=[{name:"outputSize",type:"u32"},{name:"kernelSize",type:"u32"}];if(e.kernelShape.length<=2){let a=e.kernelShape[e.kernelShape.length-1],l=e.strides[e.strides.length-1],c=e.pads[e.pads.length/2-1],d=e.pads[e.pads.length-1],u=!!(c+d);r.push({type:12,data:a},{type:12,data:l},{type:12,data:c},{type:12,data:d}),o.push({name:"kw",type:"u32"},{name:"sw",type:"u32"},{name:"pwStart",type:"u32"},{name:"pwEnd",type:"u32"});let h=!1;if(e.kernelShape.length===2){let p=e.kernelShape[e.kernelShape.length-2],f=e.strides[e.strides.length-2],_=e.pads[e.pads.length/2-2],b=e.pads[e.pads.length-2];h=!!(_+b),r.push({type:12,data:p},{type:12,data:f},{type:12,data:_},{type:12,data:b}),o.push({name:"kh",type:"u32"},{name:"sh",type:"u32"},{name:"phStart",type:"u32"},{name:"phEnd",type:"u32"})}return[r,o,!0,u,h]}else{if(t)throw new Error("Pooling with kernelShape.length > 2 is not supported for NHWC format.");let a=Ie.computeStrides(e.kernelShape);r.push({type:12,data:a},{type:12,data:e.pads},{type:12,data:e.strides}),o.push({name:"kernelStrides",type:"u32",length:a.length},{name:"pads",type:"u32",length:e.pads.length},{name:"strides",type:"u32",length:e.strides.length});let l=e.pads.reduce((c,d)=>c+d);return[r,o,!!l,!1,!1]}},vD=(s,e,t,n,i,r,o,a,l,c,d,u)=>{let h=i.format==="NHWC",p=e.type.value,f=bt("output",e.type.tensor,n);if(i.kernelShape.length<=2){let _="",b="",y="",w=t-(h?2:1);if(d?_=`
                for (var i: u32 = 0u; i < uniforms.kw; i++) {
                  xIndices[${w}] = indices[${w}] * uniforms.sw - uniforms.pwStart + i;
                  if (xIndices[${w}] < 0 || xIndices[${w}]
                      >= uniforms.x_shape[${w}]) {
                    pad++;
                    continue;
                  }
                  let x_val = x[${e.indicesToOffset("xIndices")}];
                  ${r}
                }`:_=`
                for (var i: u32 = 0u; i < uniforms.kw; i++) {
                  xIndices[${w}] = indices[${w}] * uniforms.sw - uniforms.pwStart + i;
                  let x_val = x[${e.indicesToOffset("xIndices")}];
                  ${r}
                }`,i.kernelShape.length===2){let C=t-(h?3:2);u?b=`
                for (var j: u32 = 0u; j < uniforms.kh; j++) {
                  xIndices[${C}] = indices[${C}] * uniforms.sh - uniforms.phStart + j;
                  if (xIndices[${C}] < 0 || xIndices[${C}] >= uniforms.x_shape[${C}]) {
                    pad += i32(uniforms.kw);
                    continue;
                  }
              `:b=`
                for (var j: u32 = 0u; j < uniforms.kh; j++) {
                  xIndices[${C}] = indices[${C}] * uniforms.sh - uniforms.phStart + j;
                `,y=`
              }
            `}return`
            ${s.registerUniforms(l).declareVariables(e,f)}

            ${s.mainStart()}
              ${s.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}

              let indices = ${f.offsetToIndices("global_idx")};
              var xIndices = ${f.offsetToIndices("global_idx")};

              var value = ${p}(${a});
              var pad = 0;
              ${b}
              ${_}
              ${y}
              ${o}

              output[global_idx] = value;
            }`}else{if(h)throw new Error("Pooling with kernelShape.length > 2 is not supported for NHWC format.");let _=i.kernelShape.length,b=i.pads.length,y="";return c?y=`
                if (xIndices[j] >= uniforms.x_shape[j]) {
                  pad++;
                  isPad = true;
                  break;
                }
              }
              if (!isPad) {
                let x_val = x[${e.indicesToOffset("xIndices")}];
                ${r}
              }`:y=`
              }
              let x_val = x[${e.indicesToOffset("xIndices")}];
              ${r}
            `,`
            ${s.registerUniforms(l).declareVariables(e,f)}

            ${s.mainStart()}
              ${s.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}
              let indices = ${f.offsetToIndices("global_idx")};
              var xIndices = ${f.offsetToIndices("global_idx")};

              var offsets: array<u32, ${_}>;

              var value = ${p}(${a});
              var pad = 0;
              var isPad = false;

              for (var i: u32 = 0u; i < uniforms.kernelSize; i++) {
                var offset = i;
                for (var j = 0u; j < ${_-1}u; j++) {
                  offsets[j] = offset / ${Et("uniforms.kernelStrides","j",_)};
                  offset -= offsets[j] * ${Et("uniforms.kernelStrides","j",_)};
                }
                offsets[${_-1}] = offset;

                isPad = false;
                for (var j = ${t-_}u; j < ${t}u; j++) {
                  xIndices[j] = indices[j] * ${Et("uniforms.strides",`j - ${t-_}u`,_)}
                    + offsets[j - ${t-_}u] - ${Et("uniforms.pads","j - 2u",b)};
                  ${y}
              }
              ${o}

              output[global_idx] = value;
            }`}},bD=s=>`${s.format};${s.ceilMode};${s.autoPad};${s.kernelShape.length}`,fj=s=>`${bD(s)};${s.countIncludePad}`,mj=s=>`${bD(s)};${s.storageOrder};${s.dilations}`,wD=s=>({format:s.format,autoPad:["NOTSET","VALID","SAME_UPPER","SAME_LOWER"][s.auto_pad],ceilMode:s.ceil_mode,kernelShape:s.kernel_shape,strides:s.strides,pads:s.pads}),MD=(s,e,t,n)=>{let[i,r]=_D(e,n,t),o=Ue("x",e.dataType,e.dims.length),a=o.type.value,l="value += x_val;",c="";i.countIncludePad?c+=`value /= ${a}(uniforms.kernelSize);`:c+=`value /= ${a}(i32(uniforms.kernelSize) - pad);`;let[d,u,h,p,f]=yD(r,i);d.push(...St(e.dims,r));let _=["rank"];return{name:s,shaderCache:{hint:`${n.cacheKey};${h};${p};${f}`,inputDependencies:_},getRunData:()=>({outputs:[{dims:r,dataType:e.dataType}],dispatchGroup:{x:Math.ceil(Ie.size(r)/64)},programUniforms:d}),getShaderSource:b=>vD(b,o,e.dims.length,r.length,i,l,c,0,u,h,p,f)}},t5=s=>{let e=s.count_include_pad!==0,t=wD(s);if(t.ceilMode!==0)throw new Error("using ceil() in shape computation is not yet supported for AveragePool");let n={countIncludePad:e,...t,cacheKey:""};return{...n,cacheKey:fj(n)}},n5=(s,e)=>{Jy(s.inputs),s.compute(MD("AveragePool",s.inputs[0],!1,e))},TD={autoPad:"",ceilMode:0,countIncludePad:!1,kernelShape:[],strides:[],pads:[],storageOrder:0,dilations:[]},s5=s=>{let e=s.format;return{format:e,...TD,cacheKey:e}},i5=(s,e)=>{Jy(s.inputs),s.compute(MD("GlobalAveragePool",s.inputs[0],!0,e))},ED=(s,e,t,n)=>{let[i,r]=_D(e,n,t),o=`
      value = max(x_val, value);
    `,a="",l=Ue("x",e.dataType,e.dims.length),c=["rank"],[d,u,h,p,f]=yD(r,i);return d.push(...St(e.dims,r)),{name:s,shaderCache:{hint:`${n.cacheKey};${h};${p};${f}`,inputDependencies:c},getRunData:()=>({outputs:[{dims:r,dataType:e.dataType}],dispatchGroup:{x:Math.ceil(Ie.size(r)/64)},programUniforms:d}),getShaderSource:_=>vD(_,l,e.dims.length,r.length,i,o,a,e.dataType===10?-65504:-1e5,u,h,p,f)}},r5=(s,e)=>{Jy(s.inputs),s.compute(ED("MaxPool",s.inputs[0],!1,e))},o5=s=>{let e=s.storage_order,t=s.dilations,n=wD(s);if(e!==0)throw new Error("column major storage order is not yet supported for MaxPool");if(n.ceilMode!==0)throw new Error("using ceil() in shape computation is not yet supported for MaxPool");let i={storageOrder:e,dilations:t,...n,cacheKey:""};return{...i,cacheKey:mj(i)}},a5=s=>{let e=s.format;return{format:e,...TD,cacheKey:e}},l5=(s,e)=>{Jy(s.inputs),s.compute(ED("GlobalMaxPool",s.inputs[0],!0,e))}}),gj,_j,c5,d5,Gne=Ze(()=>{"use strict";$t(),Ht(),cs(),qt(),gj=(s,e)=>{if(s.length<2||s.length>3)throw new Error("DequantizeLinear requires 2 or 3 inputs.");if(s.length===3&&s[1].dims===s[2].dims)throw new Error("x-scale and x-zero-point must have the same shape.");if(s.length===3&&s[0].dataType!==s[2].dataType)throw new Error("x and x-zero-point must have the same data type.");if(s[0].dataType===6&&s.length>2)throw new Error("In the case of dequantizing int32 there is no zero point.");if(s[1].dims.length!==0&&s[1].dims.length!==1&&s[1].dims.length!==s[0].dims.length)throw new Error("scale input must be a scalar, a 1D tensor, or have the same rank as the input tensor.");if(s.length>2){if(s[0].dataType!==s[2].dataType)throw new Error("x and x-zero-point must have the same data type.");if(s[1].dims.length!==s[2].dims.length)throw new Error("scale and zero-point inputs must have the same rank.");if(!s[1].dims.map((t,n)=>t===s[2].dims[n]).reduce((t,n)=>t&&n,!0))throw new Error("scale and zero-point inputs must have the same shape.")}if(e.blockSize>0){if(s[1].dims.length===0||s[1].dims.length===1&&s[1].dims[0]===1)throw new Error("blockSize must be set only for block quantization.");if(!s[1].dims.map((i,r)=>r===e.axis||i===s[0].dims[r]).reduce((i,r)=>i&&r,!0))throw new Error("For block qunatization, scale input shape to match the input shape except for the axis");if(s[1].dims.length!==s[0].dims.length)throw new Error("For block qunatization the scale input rank must be the same as the x rank.");let t=s[0].dims[e.axis],n=s[1].dims[e.axis];if(e.blockSize<Math.ceil(t/n)||e.blockSize>Math.ceil(t/(n-1)-1))throw new Error("blockSize must be with in the range [ceil(dI / Si), ceil(dI / (Si - 1) - 1)].")}},_j=(s,e)=>{let t=Ie.normalizeAxis(e.axis,s[0].dims.length),n=s[0].dataType,i=n===3,r=s[0].dims,o=s[1].dataType,a=Ie.size(r),l=n===3||n===2,c=l?[Math.ceil(Ie.size(s[0].dims)/4)]:s[0].dims,d=s[1].dims,u=s.length>2?s[2]:void 0,h=u?l?[Math.ceil(Ie.size(u.dims)/4)]:u.dims:void 0,p=d.length===0||d.length===1&&d[0]===1,f=p===!1&&d.length===1,_=es(a),b=p&&(!l||_===4),y=b?_:1,w=b&&!l?_:1,C=Ue("input",l?12:n,c.length,w),M=Ue("scale",o,d.length),S=u?Ue("zero_point",l?12:n,h.length):void 0,k=bt("output",o,r.length,y),T=[C,M];S&&T.push(S);let P=[c,d];u&&P.push(h);let R=[{type:12,data:a/y},{type:12,data:t},{type:12,data:e.blockSize},...St(...P,r)],O=H=>{let X=[{name:"output_size",type:"u32"},{name:"axis",type:"u32"},{name:"block_size",type:"u32"}];return`
      ${H.registerUniforms(X).declareVariables(...T,k)}
      ${H.mainStart()}
          ${H.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}
          let output_indices = ${k.offsetToIndices("global_idx")};

          // Set input x
          ${l?`
            let input = ${C.getByOffset("global_idx / 4")};
            let x_vec = ${i?"unpack4xI8(input)":"unpack4xU8(input)"};
            let x_value = ${y===1?"x_vec[global_idx % 4]":"x_vec"};`:`let x_value = ${C.getByOffset("global_idx")};`};

          // Set scale input
          ${p?`let scale_value= ${M.getByOffset("0")}`:f?`
            let scale_index = ${k.indicesGet("output_indices","uniforms.axis")};
            let scale_value= ${M.getByOffset("scale_index")};`:`
            var scale_indices: ${M.type.indices} = output_indices;
            let index = ${M.indicesGet("scale_indices","uniforms.axis")} / uniforms.block_size;
            ${M.indicesSet("scale_indices","uniforms.axis","index")};
            let scale_value= ${M.getByIndices("scale_indices")};`};

          // Set zero-point input
          ${S?p?l?`
                let zero_point_input = ${S.getByOffset("0")};
                let zero_point_vec =  ${i?"unpack4xI8(zero_point_input)":"unpack4xU8(zero_point_input)"};
                let zero_point_value= zero_point_vec[0]`:`let zero_point_value = ${S.getByOffset("0")}`:f?l?`
                let zero_point_index = ${k.indicesGet("output_indices","uniforms.axis")};
                let zero_point_input = ${S.getByOffset("zero_point_index / 4")};
                let zero_point_vec =  ${i?"unpack4xI8(zero_point_input)":"unpack4xU8(zero_point_input)"};
                let zero_point_value = zero_point_vec[zero_point_index % 4]`:`
                let zero_point_index = ${k.indicesGet("output_indices","uniforms.axis")};
                let zero_point_value = ${S.getByOffset("zero_point_index")};`:l?`
                let zero_point_offset = ${M.indicesToOffset("scale_indices")};
                let zero_point_input = ${S.getByOffset("zero_point_offset / 4")};
                let zero_point_vec = ${i?"unpack4xI8(zero_point_input)":"unpack4xU8(zero_point_input)"};
                let zero_point_value = zero_point_vec[zero_point_offset % 4];`:`let zero_point_value = ${S.getByIndices("scale_indices")};`:`let zero_point_value = ${l?i?"i32":"u32":C.type.value}(0);`};
      // Compute and write output
      ${k.setByOffset("global_idx",`${k.type.value}(x_value - zero_point_value) * scale_value`)};
      }`};return{name:"DequantizeLinear",shaderCache:{hint:e.cacheKey,inputDependencies:S?["rank","rank","rank"]:["rank","rank"]},getShaderSource:O,getRunData:()=>({outputs:[{dims:r,dataType:o}],dispatchGroup:{x:Math.ceil(a/y/64),y:1,z:1},programUniforms:R})}},c5=(s,e)=>{gj(s.inputs,e),s.compute(_j(s.inputs,e))},d5=s=>Mn({axis:s.axis,blockSize:s.blockSize})}),yj,vj,u5,Wne=Ze(()=>{"use strict";No(),$t(),qt(),yj=(s,e,t)=>{let n=s===e,i=s<e&&t<0,r=s>e&&t>0;if(n||i||r)throw new Error("Range these inputs' contents are invalid.")},vj=(s,e,t,n)=>{let i=Math.abs(Math.ceil((e-s)/t)),r=[i],o=i,a=[{type:12,data:o},{type:n,data:s},{type:n,data:t},...St(r)],l=c=>{let d=bt("output",n,r.length),u=d.type.value,h=[{name:"outputSize",type:"u32"},{name:"start",type:u},{name:"delta",type:u}];return`
        ${c.registerUniforms(h).declareVariables(d)}
        ${c.mainStart()}
        ${c.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}
        output[global_idx] = uniforms.start + ${u}(global_idx) * uniforms.delta;
      }`};return{name:"Range",shaderCache:{hint:`${n}`},getShaderSource:l,getRunData:()=>({outputs:[{dims:r,dataType:n}],dispatchGroup:{x:Math.ceil(o/64)},programUniforms:a})}},u5=s=>{let e=0,t=0,n=0;s.inputs[0].dataType===6?(e=s.inputs[0].getInt32Array()[0],t=s.inputs[1].getInt32Array()[0],n=s.inputs[2].getInt32Array()[0]):s.inputs[0].dataType===1&&(e=s.inputs[0].getFloat32Array()[0],t=s.inputs[1].getFloat32Array()[0],n=s.inputs[2].getFloat32Array()[0]),Un.webgpu.validateInputContent&&yj(e,t,n),s.compute(vj(e,t,n,s.inputs[0].dataType),{inputs:[]})}}),bj,xD,SD,wj,h5,p5,Hne=Ze(()=>{"use strict";$t(),Ht(),cs(),qt(),bj=(s,e,t,n)=>{if(s!=="none"&&n!=="i32"&&n!=="u32"&&n!=="f32")throw new Error(`Input ${n} is not supported with reduction ${s}.`);let i=`{
                var oldValue = 0;
                loop {
                  let newValueF32 =`,r=`;
                  let newValue = bitcast<i32>(newValueF32);
                  let res = atomicCompareExchangeWeak(&${e}, oldValue, newValue);
                  if res.exchanged {
                    break;
                  }
                  oldValue = res.old_value;
                }
              }`;switch(s){case"none":return`${e}=${t};`;case"add":return n==="i32"||n==="u32"?`atomicAdd(&${e}, bitcast<${n}>(${t}));`:`
              ${i}bitcast<${n}>(oldValue) + (${t})${r}`;case"max":return n==="i32"||n==="u32"?`atomicMax(&${e}, bitcast<${n}>(${t}));`:`
                ${i}max(bitcast<f32>(oldValue), (${t}))${r}`;case"min":return n==="i32"||n==="u32"?`atomicMin(&${e}, bitcast<${n}>(${t}));`:`${i}min(bitcast<${n}>(oldValue), (${t}))${r}`;case"mul":return`${i}(bitcast<${n}>(oldValue) * (${t}))${r}`;default:throw new Error(`Reduction ${s} is not supported.`)}},xD=(s,e)=>`${s===1?`
    let element_count_dim = uniforms.output_strides;
    let dim_value = uniforms.output_shape;`:`
    let element_count_dim = uniforms.output_strides[${e?"i - indices_start":"i"}];
    let dim_value = uniforms.output_shape[${e?"i - indices_start":"i"} + uniforms.last_index_dimension];`}
    
    if (index >= 0) {
      if (index >= i32(dim_value)) {
        index = i32(dim_value - 1);
      }
    } else {
      if (index < -i32(dim_value)) {
        index = 0;
      } else {
        index += i32(dim_value);
      }
    }
    data_offset += u32((u32(index) * element_count_dim));`,SD=(s,e,t)=>`for (var i = 0u; i < uniforms.num_updates_elements; i++) {
        let value = updates[uniforms.num_updates_elements * ${t?"global_idx":"idx"} + i];
        ${bj(s.reduction,"output[data_offset + i]","value",e)}
      }`,wj=(s,e)=>{let t=s[0].dims,n=s[1].dims,i=t,r=1,o=Math.ceil(Ie.size(n)/r),a=n[n.length-1],l=Ie.sizeFromDimension(t,a),c=Ie.sizeFromDimension(n,0)/a,d=[{type:12,data:o},{type:12,data:a},{type:12,data:l},...St(s[1].dims,s[2].dims,i)],u=h=>{let p=Ue("indices",s[1].dataType,s[1].dims.length),f=Ue("updates",s[2].dataType,s[2].dims.length,r),_=e.reduction!=="none"&&e.reduction!==""?U4("output",s[0].dataType,i.length):bt("output",s[0].dataType,i.length,r);return`
      ${h.registerUniform("output_size","u32").registerUniform("last_index_dimension","u32").registerUniform("num_updates_elements","u32").declareVariables(p,f,_)}
      ${h.mainStart()}
        ${h.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}
  var hasDuplicates = false;
  if (${e.reduction==="none"}) {
    for (var i = 0; i < ${c}; i = i + 1) {
      for (var j = i + 1; j < ${c}; j = j + 1) {
        var index_i = i32(indices[i].x);
        var index_j = i32(indices[j].x);
        if (index_i == index_j) {
          hasDuplicates = true;
          break;
        }
      }
      if (hasDuplicates) {
        break;
      }
    }
  }

  if (${e.reduction==="none"} && hasDuplicates) {
    if (global_idx != 0u) {
      return;
    }
    // Process each index-update pair individually when duplicates exist
    for (var idx = 0u; idx < ${c}u; idx++) {
      var data_offset = 0u;
      for (var i = 0u; i < uniforms.last_index_dimension; i++) {
        var index = i32(indices[idx * uniforms.last_index_dimension + i].x);
        ${xD(t.length,!1)}
      }
      ${SD(e,_.type.value,!1)}
    }
    return;
  }

  var data_offset = 0u;
  var indices_start = uniforms.last_index_dimension * global_idx;
  var indices_end = indices_start + uniforms.last_index_dimension;
  for (var i = indices_start; i < indices_end; i++) {
    var index = i32(indices[i].x);
    ${xD(t.length,!0)}
  }
  ${SD(e,_.type.value,!0)}
  }`};return{name:"ScatterND",shaderCache:{hint:`${e.cacheKey}_${e.reduction}`,inputDependencies:["rank","rank"]},getRunData:()=>({outputs:[{dims:i,dataType:s[0].dataType}],dispatchGroup:{x:Math.ceil(o/64)},programUniforms:d}),getShaderSource:u}},h5=s=>Mn({reduction:s.reduction}),p5=(s,e)=>{s.compute(wj(s.inputs,e),{inputs:[s.inputs[1],s.inputs[2]],outputs:[]})}}),Mj,Tj,Ej,CD,xj,Sj,Cj,Aj,Pj,kj,Ij,Dj,AD,Rj,Fj,Lj,Nj,Oj,f5,m5,jne=Ze(()=>{"use strict";$t(),Ht(),cs(),qt(),Mj=(s,e)=>{if(s.every(t=>t>0||(()=>{throw new Error("Resize requires scales input values to be positive")})),s.length>0){if(e.mode==="linear"){if(!(s.length===2||s.length===3||s.length===4&&s[0]===1&&s[1]===1||s.length===4&&s[0]===1&&s[3]===1||s.length===5&&s[0]===1&&s[1]===1))throw new Error(`For linear mode, Resize requires scales to be 2D, 3D, 4D with either two outermost or one innermost and
            one outermost scale values equal to 1, or 5D with two outermost scale values equal to 1`)}else if(e.mode==="cubic"&&!(s.length===2||s.length===4&&s[0]===1&&s[1]===1||s.length===4&&s[0]===1&&s[3]===1))throw new Error("Resize requires scales input size to be 2 or 4 for cubic mode")}},Tj=(s,e,t)=>{e.every(i=>i>=0&&i<t||(()=>{throw new Error("Resize requires axes input values to be positive and less than rank")}));let n=new Array(t).fill(1);return e.forEach((i,r)=>n[i]=s[r]),n},Ej=(s,e,t,n,i,r)=>{let[o,a,l]=t>10?[1,2,3]:[-1,s.length>1?1:-1,-1],c=s[0].dims.length;if(o>0&&s.length>o&&s[o].dims.length>0)s[o].getFloat32Array().forEach(d=>r.push(d));else if(e.coordinateTransformMode==="tf_crop_and_resize")throw new Error("Resize requires RoI input to be specified when coordinateTransformMode is tfCropAndResize");if(a>0&&s.length>a&&s[a].dims.length===1&&s[a].dims[0]>0){if(s[a].getFloat32Array().forEach(d=>n.push(d)),n.length!==0&&n.length!==c&&t>=18&&n.length!==e.axes.length)throw new Error("Resize requires scales input size to be same as input rank or axes size for opset 18 and up");Mj(n,e),e.axes.length>0&&Tj(n,e.axes,c).forEach((d,u)=>n[u]=d)}if(l>0&&s.length>l&&s[l].dims.length===1&&s[l].dims[0]>0&&(s[l].getBigInt64Array().forEach(d=>i.push(Number(d))),i.length!==0&&i.length!==c&&t>=18&&i.length!==e.axes.length))throw new Error("Resize requires sizes input size to be same as input rank or axes size for opset 18 and up");if(e.axes.length>0){if(n.length!==0&&n.length!==e.axes.length)throw new Error('Resize requires "scales" input size to be of axes rank when axes attributes is specified');if(i.length!==0&&i.length!==e.axes.length)throw new Error('Resize requires "sizes" input size to be of rank axes rank when axes attributes is specified')}if(typeof n<"u"&&typeof i<"u"&&n.length>0&&i.length>c)throw new Error("Resize requires only of scales or sizes to be specified")},CD=(s,e,t,n)=>`
  // The whole part and the fractional part are calculated separately due to inaccuracy of floating
  // point division. As an example, f32(21) / f32(7) may evaluate to 2.99... instead of 3, causing an
  // offset-by-one error later in floor().
  let big = (${s}) * (${e});
  let whole = ${n}(big / (${t}));
  let fract = ${n}(big % (${t})) / ${n}(${t});
  return whole + fract;
`,xj=(s,e)=>`fn getOriginalCoordinateFromResizedCoordinate(xResized: u32, xScale: f32, lengthResized: u32,
     lengthOriginal: u32, roiStart: f32, roiEnd: f32) -> ${e} { `+(()=>{switch(s){case"asymmetric":return`
          if (xScale < 1.0 || floor(xScale) != xScale) {
            return ${e}(xResized) / ${e}(xScale);
          } else {
            ${CD("xResized","lengthOriginal","lengthResized",e)}
          }
        `;case"pytorch_half_pixel":return`if (lengthResized > 1) {
                    return (${e}(xResized) + 0.5) / ${e}(xScale) - 0.5;
                  } else {
                    return 0.0;
                  }`;case"tf_half_pixel_for_nn":return`return (${e}(xResized) + 0.5) / ${e}(xScale);`;case"align_corners":return`if (lengthResized == 1) {
                    return 0.0;
                  } else {
                    ${CD("xResized","lengthOriginal - 1","lengthResized - 1",e)}
                  }`;case"tf_crop_and_resize":return`if (lengthResized > 1) {
                    return ${e}(roiStart) * ${e}(lengthOriginal - 1) +
                        (${e}(xResized) * ${e}(roiEnd - roiStart) * ${e}(lengthOriginal - 1)) /
                        ${e}(lengthResized - 1);
                  } else {
                    return 0.5 * ${e}(roiStart + roiEnd) * ${e}(lengthOriginal - 1);
                  }`;case"half_pixel_symmetric":return`const outputWidth = ${e}xScale * ${e}(lengthResized);
                  const adjustment = ${e}(lengthResized) / outputWidth;
                  const center = ${e}(lengthOriginal) / 2;
                  const offset = center * (1 - adjustment);
                  return offset + ((${e}(xResized) + 0.5) / ${e}(xScale)) - 0.5;`;case"half_pixel":return`return ((${e}(xResized) + 0.5) / ${e}(xScale)) - 0.5;`;default:throw new Error(`Coordinate transform mode ${s} is not supported`)}})()+"}",Sj=(s,e,t)=>`fn getNearestPixelFromOriginal(xOriginal: ${t}, isDownSample: bool) -> ${t} {`+(()=>{switch(s){case"round_prefer_ceil":return"if (fract(xOriginal) == 0.5) {             return ceil(xOriginal);           } else {             return round(xOriginal);           }";case"floor":return"return floor(xOriginal);";case"ceil":return"return ceil(xOriginal);";case"round_prefer_floor":return"if (fract(xOriginal) == 0.5) {                     return floor(xOriginal);                   } else {                     return round(xOriginal);                   }";case"simple":default:if(e<11)return"if (isDownSample)                     {                       return ceil(xOriginal);                     } else {                       return xOriginal;                     }";throw new Error(`Nearest mode ${s} is not supported`)}})()+"}",Cj=(s,e,t)=>{let n=new Array(t).fill(0).concat(new Array(t).fill(1)),i=s.length===0?n:s.slice();return e.length>0?(e.forEach((r,o)=>{n[r]=i[o],n[o+t]=i[e.length+o]}),n):i},Aj=(s,e,t,n)=>{let i=[];if(t.length>0)if(n.length>0){if(s.forEach(r=>i.push(r)),Math.max(...n)>s.length)throw new Error("axes is out of bound");n.forEach((r,o)=>i[r]=t[o])}else t.forEach(r=>i.push(r));else{if(e.length===0)throw new Error("Resize requires either scales or sizes.");i=s.map((r,o)=>Math.round(r*e[o]))}return i},Pj=(s,e,t)=>{let n=(()=>{switch(t.keepAspectRatioPolicy){case"not_larger":return t.axes.length>0?Math.min(...t.axes.map(r=>e[r]),Number.MAX_VALUE):Math.min(...e,Number.MAX_VALUE);case"not_smaller":return t.axes.length>0?Math.max(...t.axes.map(r=>e[r]),Number.MIN_VALUE):Math.max(...e,Number.MIN_VALUE);default:throw new Error(`Keep aspect ratio policy ${t.keepAspectRatioPolicy} is not supported`)}})();e.fill(1,0,e.length);let i=s.slice();return t.axes.length>0?(t.axes.forEach(r=>e[r]=n),t.axes.forEach(r=>i[r]=Math.round(s[r]*e[r]))):(e.fill(n,0,e.length),i.forEach((r,o)=>i[o]=Math.round(r*e[o]))),i},kj=(s,e,t,n,i)=>`
    fn calculateOriginalIndicesFromOutputIndices(output_indices: ${s.type.indices}) -> array<${s.type.value}, ${t.length}> {
      var original_indices: array<${s.type.value}, ${t.length}>;
      for (var i:u32 = 0; i < ${t.length}; i++) {
        var output_index = ${s.indicesGet("output_indices","i")};
        var scale = ${Et("uniforms.scales","i",n)};
        var roi_low = ${Et("uniforms.roi","i",i)};
        var roi_hi = ${Et("uniforms.roi",`i + ${e.length}`,i)};
        if (scale == 1.0) {
          original_indices[i] = ${s.type.value}(output_index);
        } else {
          var input_shape_i = ${Et("uniforms.input_shape","i",e.length)};
          var output_shape_i = ${Et("uniforms.output_shape","i",t.length)};
          original_indices[i] = getOriginalCoordinateFromResizedCoordinate(output_index, scale, output_shape_i,
                                                                           input_shape_i, roi_low, roi_hi);
        }
      }
      return original_indices;
    }`,Ij=(s,e,t,n,i,r,o)=>`
    fn calculateInputIndicesFromOutputIndices(output_indices: ${e.type.indices}) -> ${s.type.indices} {
      var input_indices: ${s.type.indices};
      for (var i:u32 = 0; i < ${n.length}; i++) {
        var output_index = ${e.indicesGet("output_indices","i")};
        var input_index: u32;
        var scale = ${Et("uniforms.scales","i",i)};
        if (scale == 1.0) {
          input_index = output_index;
        } else {
          var roi_low = ${Et("uniforms.roi","i",r)};
          var roi_hi = ${Et("uniforms.roi",`i + ${t.length}`,r)};
          var input_shape_i = ${Et("uniforms.input_shape","i",t.length)};
          var output_shape_i = ${Et("uniforms.output_shape","i",n.length)};
          var original_idx = getOriginalCoordinateFromResizedCoordinate(output_index, scale, output_shape_i,
                                                                        input_shape_i, roi_low, roi_hi);
          if (!${o} || (original_idx >= 0 && original_idx < ${e.type.value}(input_shape_i))) {
            if (original_idx < 0) {
              input_index = 0;
            } else if (original_idx > ${e.type.value}(input_shape_i - 1)) {
              input_index = input_shape_i - 1;
            } else {
              input_index = u32(getNearestPixelFromOriginal(original_idx, scale < 1));
            }
          } else {
            input_index = u32(original_idx);
          }
        }
        ${s.indicesSet("input_indices","i","input_index")}
      }
      return input_indices;
    }`,Dj=(s,e)=>`
    fn checkInputIndices(input_indices: ${s.type.indices}) -> bool {
      for (var i:u32 = 0; i < ${e.length}; i++) {
        var input_index = ${s.indicesGet("input_indices","i")};
        if (input_index < 0 || input_index >= ${Et("uniforms.input_shape","i",e.length)}) {
          return false;
        }
      }
      return true;
    }`,AD=(s,e,t,n)=>s.rank>n?`
    ${s.indicesSet("input_indices",e,"channel")};
    ${s.indicesSet("input_indices",t,"batch")};
`:"",Rj=(s,e,t,n,i)=>{let[r,o,a,l]=t.length===2?[-1,0,1,-1]:[0,2,3,1],c=s.type.value;return`
    fn getInputValue(batch: u32, channel: u32, row: u32, col: u32) -> ${c} {
      var input_indices: ${s.type.indices};
      ${s.indicesSet("input_indices",o,`max(0, min(row, ${t[o]} - 1))`)};
      ${s.indicesSet("input_indices",a,`max(0, min(col, ${t[a]} - 1))`)};
      ${AD(s,l,r,2)}
      return ${s.getByIndices("input_indices")};
    }

    fn bilinearInterpolation(output_indices: ${e.type.indices}) -> ${c} {
      var originalIndices = calculateOriginalIndicesFromOutputIndices(output_indices);
      var row:${c} = originalIndices[${o}];
      var col:${c} = originalIndices[${a}];
      ${n?`if (row < 0 || row > (${t[o]} - 1) || col < 0 || col > (${t[a]} - 1)) {
        return ${i};
      }`:""};
      row = max(0, min(row, ${t[o]} - 1));
      col = max(0, min(col, ${t[a]} - 1));
      var row1: u32 = u32(row);
      var col1: u32 = u32(col);
      var row2: u32 = u32(row + 1);
      var col2: u32 = u32(col + 1);
      var channel: u32 = ${t.length>2?`u32(originalIndices[${l}])`:"0"};
      var batch: u32 =  ${t.length>2?`u32(originalIndices[${r}])`:"0"};
      var x11: ${c} = getInputValue(batch, channel, row1, col1);
      var x12: ${c} = getInputValue(batch, channel, row1, col2);
      var x21: ${c} = getInputValue(batch, channel, row2, col1);
      var x22: ${c} = getInputValue(batch, channel, row2, col2);
      var dx1: ${c} = abs(row - ${c}(row1));
      var dx2: ${c} = abs(${c}(row2) - row);
      var dy1: ${c} = abs(col - ${c}(col1));
      var dy2: ${c} = abs(${c}(col2) - col);
      if (row1 == row2) {
        dx1 = 0.5;
        dx2 = 0.5;
      }
      if (col1 == col2) {
        dy1 = 0.5;
        dy2 = 0.5;
      }
      return (x11 * dx2 * dy2 + x12 * dx2 * dy1 + x21 * dx1 * dy2 + x22 * dx1 * dy1);
    }`},Fj=(s,e,t,n,i,r,o,a,l,c)=>{let d=t.length===2,u=!0,[h,p]=d?[0,1]:u?[2,3]:[1,2],f=s.type.value,_=b=>{let y=b===h?"row":"col";return`
      fn ${y}CubicInterpolation(input_indices: ${s.type.indices}, output_indices: ${e.type.indices}) -> ${f} {
        var output_index = ${e.indicesGet("output_indices",b)};
        var originalIdx: ${f} = getOriginalCoordinateFromResizedCoordinate(output_index, ${i[b]},
        ${n[b]}, ${t[b]}, ${r[b]}, ${r[b]} + ${t.length});
        var fractOriginalIdx: ${f} = originalIdx - floor(originalIdx);
        var coefs = getCubicInterpolationCoefs(fractOriginalIdx);

        if (${a} && (originalIdx < 0 || originalIdx > (${t[b]} - 1))) {
          return ${l};
        }
        var data: array<${f}, 4> = array<${f}, 4>(0.0, 0.0, 0.0, 0.0);
        for (var i: i32 = -1; i < 3; i++) {
          var ${y}: ${f} = originalIdx + ${f}(i);
          if (${y} < 0 || ${y} >= ${t[b]}) {
            ${c?`coefs[i + 1] = 0.0;
                        continue;`:a?`return ${l};`:`${y} = max(0, min(${y}, ${t[b]} - 1));`};
          }
        var input_indices_copy: ${s.type.indices} = input_indices;
          ${s.indicesSet("input_indices_copy",b,`u32(${y})`)};
          data[i + 1] = ${b===h?s.getByIndices("input_indices_copy"):"rowCubicInterpolation(input_indices_copy, output_indices)"};
        }
        return cubicInterpolation1D(data, coefs);
      }`};return`
    ${_(h)};
    ${_(p)};
  fn getCubicInterpolationCoefs(s: ${f}) -> array<${f}, 4> {
    var absS = abs(s);
    var coeffs: array<${f}, 4> = array<${f}, 4>(0.0, 0.0, 0.0, 0.0);
    var oneMinusAbsS: ${f} = 1.0 - absS;
    var twoMinusAbsS: ${f} = 2.0 - absS;
    var onePlusAbsS: ${f} = 1.0 + absS;
    coeffs[0] = ((${o} * onePlusAbsS - 5 * ${o}) * onePlusAbsS + 8 * ${o}) * onePlusAbsS - 4 * ${o};
    coeffs[1] = ((${o} + 2) * absS - (${o} + 3)) * absS * absS + 1;
    coeffs[2] = ((${o} + 2) * oneMinusAbsS - (${o} + 3)) * oneMinusAbsS * oneMinusAbsS + 1;
    coeffs[3] = ((${o} * twoMinusAbsS - 5 * ${o}) * twoMinusAbsS + 8 * ${o}) * twoMinusAbsS - 4 * ${o};
    return coeffs;
  }

  fn cubicInterpolation1D(x: array<${f}, 4>, coefs: array<${f}, 4>) -> ${f} {
    var coefsSum: ${f} = coefs[0] + coefs[1] + coefs[2] + coefs[3];
    return (x[0] * coefs[0] + x[1] * coefs[1]+ x[2] * coefs[2]+ x[3] * coefs[3]) / coefsSum;
  }

  fn bicubicInterpolation(output_indices: ${e.type.indices}) -> ${f} {
    var input_indices: ${s.type.indices} = output_indices;
    return colCubicInterpolation(input_indices, output_indices);
  }
    `},Lj=(s,e,t,n,i)=>{let[r,o,a,l,c]=t.length===3?[-1,0,1,2,-1]:[0,2,3,4,1],d=s.type.value;return`
    fn getInputValue(batch: u32, channel: u32, depth:u32, height: u32, width: u32) -> ${d} {
      var input_indices: ${s.type.indices};
      ${s.indicesSet("input_indices",o,`max(0, min(depth, ${t[o]} - 1))`)};
      ${s.indicesSet("input_indices",a,`max(0, min(height, ${t[a]} - 1))`)};
      ${s.indicesSet("input_indices",l,`max(0, min(width, ${t[l]} - 1))`)};
      ${AD(s,c,r,3)}
      return ${s.getByIndices("input_indices")};
    }

    fn trilinearInterpolation(output_indices: ${e.type.indices}) -> ${d} {
      var originalIndices = calculateOriginalIndicesFromOutputIndices(output_indices);
      var depth:${d} = originalIndices[${o}];
      var height:${d} = originalIndices[${a}];
      var width:${d} = originalIndices[${l}];
      ${n?`if (depth < 0 || depth > (${t[o]} - 1) || height < 0 || height > (${t[a]} - 1) || width < 0 || (width > ${t[l]} - 1)) {
      return ${i};
        }`:""};

    depth = max(0, min(depth, ${t[o]} - 1));
      height = max(0, min(height, ${t[a]} - 1));
      width = max(0, min(width, ${t[l]} - 1));
      var depth1: u32 = u32(depth);
      var height1: u32 = u32(height);
      var width1: u32 = u32(width);
      var depth2: u32 = u32(depth + 1);
      var height2: u32 = u32(height + 1);
      var width2: u32 = u32(width + 1);
      var channel: u32 = ${t.length>3?`u32(originalIndices[${c}])`:"0"};
      var batch: u32 =  ${t.length>3?`u32(originalIndices[${r}])`:"0"};

      var x111: ${d} = getInputValue(batch, channel, depth1, height1, width1);
      var x112: ${d} = getInputValue(batch, channel, depth1, height1, width2);
      var x121: ${d} = getInputValue(batch, channel, depth1, height2, width1);
      var x122: ${d} = getInputValue(batch, channel, depth1, height2, width2);
      var x211: ${d} = getInputValue(batch, channel, depth2, height1, width1);
      var x212: ${d} = getInputValue(batch, channel, depth2, height1, width2);
      var x221: ${d} = getInputValue(batch, channel, depth2, height2, width1);
      var x222: ${d} = getInputValue(batch, channel, depth2, height2, width2);
      var dx1: ${d} = abs(depth - ${d}(depth1));
      var dx2: ${d} = abs(${d}(depth2) - depth);
      var dy1: ${d} = abs(height - ${d}(height1));
      var dy2: ${d} = abs(${d}(height2) - height);
      var dz1: ${d} = abs(width - ${d}(width1));
      var dz2: ${d} = abs(${d}(width2) - width);
      if (depth1 == depth2) {
        dx1 = 0.5;
        dx2 = 0.5;
      }
      if (height1 == height2) {
        dy1 = 0.5;
        dy2 = 0.5;
      }
      if (width1 == width2) {
        dz1 = 0.5;
        dz2 = 0.5;
      }
      return (x111 * dx2 * dy2 * dz2 + x112 * dx2 * dy2 * dz1 + x121 * dx2 * dy1 *dz2 + x122 * dx2 * dy1 * dz1 +
              x211 * dx1 * dy2 * dz2 + x212 * dx1 * dy2 * dz1 + x221 * dx1 * dy1 *dz2 + x222 * dx1 * dy1 * dz1);
    }`},Nj=(s,e,t,n,i,r)=>{let o=s.dims,a=Cj(r,e.axes,o.length),l=Aj(o,n,i,e.axes),c=n.slice();n.length===0&&(c=o.map((w,C)=>w===0?1:l[C]/w),e.keepAspectRatioPolicy!=="stretch"&&(l=Pj(o,c,e)));let d=bt("output",s.dataType,l.length),u=Ue("input",s.dataType,o.length),h=Ie.size(l),p=o.length===l.length&&o.every((w,C)=>w===l[C]),f=e.coordinateTransformMode==="tf_crop_and_resize",_=e.extrapolationValue,b=u.type.value,y=w=>`
      ${p?"":`
      ${xj(e.coordinateTransformMode,b)};
      ${(()=>{switch(e.mode){case"nearest":return`
              ${Dj(u,o)};
              ${Sj(e.nearestMode,t,b)};
              ${Ij(u,d,o,l,c.length,a.length,f)};
              `;case"linear":return`
              ${kj(d,o,l,c.length,a.length)};
              ${(()=>{if(o.length===2||o.length===4)return`${Rj(u,d,o,f,_)}`;if(o.length===3||o.length===5)return`${Lj(u,d,o,f,_)}`;throw Error("Linear mode only supports input dims 2, 3, 4 and 5 are supported in linear mode.")})()};
            `;case"cubic":return`
            ${(()=>{if(o.length===2||o.length===4)return`${Fj(u,d,o,l,c,a,e.cubicCoeffA,f,e.extrapolationValue,e.excludeOutside)}`;throw Error("Cubic mode only supports input dims 2 and 4 are supported in linear mode.")})()};
            `;default:throw Error("Invalid resize mode")}})()};
      `}
      ${w.registerUniform("output_size","u32").registerUniform("scales","f32",c.length).registerUniform("roi","f32",a.length).declareVariables(u,d)}
      ${w.mainStart()}
        ${w.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}
        ${p?"output[global_idx] = input[global_idx];":`
        let output_indices = ${d.offsetToIndices("global_idx")};
        var input_indices: ${u.type.indices};
        ${(()=>{switch(e.mode){case"nearest":return`input_indices = calculateInputIndicesFromOutputIndices(output_indices);
                if (checkInputIndices(input_indices)) {
                  output[global_idx] = ${u.getByIndices("input_indices")};
                } else {
                  output[global_idx] = ${e.extrapolationValue};
                }`;case"linear":return`output[global_idx] = ${o.length===2||o.length===4?"bilinearInterpolation":"trilinearInterpolation"}(output_indices);`;case"cubic":return"output[global_idx] = bicubicInterpolation(output_indices);";default:throw Error(`Unsupported resize mode: ${e.mode}`)}})()};
`}
      }`;return{name:"Resize",shaderCache:{hint:`${e.cacheKey}|${t}|${c.length>0?e.mode==="cubic"?c:c.length:""}|${i.length>0?i:""}|${a.length>0?a:""}|${p}|${e.mode==="nearest"?o.length:o}`,inputDependencies:["rank"]},getShaderSource:y,getRunData:()=>({outputs:[{dims:l,dataType:s.dataType}],dispatchGroup:{x:Math.ceil(h/64)},programUniforms:[{type:12,data:h},{type:1,data:c},{type:1,data:a},...St(o,l)]})}},Oj=s=>{let e=s.customDataBuffer;return new Uint32Array(e,e.byteOffset,1)[0]},f5=(s,e)=>{let t=[],n=[],i=[],r=Oj(s);if(e.antialias!==0)throw Error("Only default value (0) for Antialias attribute is supported");Ej(s.inputs,e,r,t,n,i),s.compute(Nj(s.inputs[0],e,r,t,n,i),{inputs:[0]})},m5=s=>{let e=s.antialias,t=s.axes,n=s.coordinateTransformMode,i=s.cubicCoeffA,r=s.excludeOutside!==0,o=s.extrapolationValue,a=s.keepAspectRatioPolicy,l=s.mode,c=s.nearestMode===""?"simple":s.nearestMode;return Mn({antialias:e,axes:t,coordinateTransformMode:n,cubicCoeffA:i,excludeOutside:r,extrapolationValue:o,keepAspectRatioPolicy:a,mode:l,nearestMode:c})}}),$j,Bj,g5,qne=Ze(()=>{"use strict";$t(),Ht(),qt(),$j=s=>{if(!s||s.length<3)throw new Error("layerNorm requires at least 3 inputs.");let e=s[0],t=s[1],n=s[2];if(e.dataType!==t.dataType||e.dataType!==n.dataType)throw new Error("All inputs must have the same data type");if(e.dims.length!==3&&e.dims.length!==2)throw new Error("Input must be 2D or 3D");if(t.dims.length!==3&&t.dims.length!==2)throw new Error("Skip must be 2D or 3D");let i=e.dims[e.dims.length-1],r=e.dims[e.dims.length-2];if(t.dims[t.dims.length-1]!==i)throw new Error("Skip must have the same hidden size as input");if(t.dims[t.dims.length-2]!==r)throw new Error("Skip must have the same sequence length as input");if(n.dims.length!==1)throw new Error("Gamma must be 1D");if(n.dims[n.dims.length-1]!==i)throw new Error("Gamma must have the same hidden size as input");if(s.length>3){let o=s[3];if(o.dims.length!==1)throw new Error("Beta must be 1D");if(o.dims[o.dims.length-1]!==i)throw new Error("Beta must have the same hidden size as input")}if(s.length>4){let o=s[4];if(o.dims.length!==1)throw new Error("Bias must be 1D");if(o.dims[o.dims.length-1]!==i)throw new Error("Bias must have the same hidden size as input")}},Bj=(s,e,t,n)=>{let i=e.simplified,r=s[0].dims,o=Ie.size(r),a=r,l=o,c=r.slice(-1)[0],d=n?r.slice(0,-1).concat(1):[],u=!i&&s.length>3,h=s.length>4,p=n&&t>1,f=n&&t>2,_=t>3,b=64,y=es(c),w=[{type:12,data:l},{type:12,data:y},{type:12,data:c},{type:1,data:e.epsilon}],C=S=>{let k=[{name:"output_size",type:"u32"},{name:"components",type:"u32"},{name:"hidden_size",type:"u32"},{name:"epsilon",type:"f32"}],T=[Ue("x",s[0].dataType,s[0].dims,y),Ue("skip",s[1].dataType,s[1].dims,y),Ue("gamma",s[2].dataType,s[2].dims,y)];u&&T.push(Ue("beta",s[3].dataType,s[3].dims,y)),h&&T.push(Ue("bias",s[4].dataType,s[4].dims,y)),T.push(bt("output",s[0].dataType,a,y)),p&&T.push(bt("mean_output",1,d)),f&&T.push(bt("inv_std_output",1,d)),_&&T.push(bt("input_skip_bias_sum",s[0].dataType,a,y));let P=Vs(s[0].dataType),R=Vs(1,y);return`

      ${S.registerUniforms(k).declareVariables(...T)}
      var<workgroup> sum_shared : array<${R}, ${b}>;
      var<workgroup> sum_squared_shared : array<${R}, ${b}>;

      ${S.mainStart([b,1,1])}
        let ix = local_id.x;
        let iy = global_id.x / ${b};

        let hidden_size_vectorized: u32 = uniforms.hidden_size / uniforms.components;
        var stride = hidden_size_vectorized / ${b};
        let offset = ix * stride + iy * hidden_size_vectorized;
        let offset1d = stride * ix;
        if (ix == ${b-1}) {
          stride = hidden_size_vectorized - stride * ix;
        }
        for (var i: u32 = 0; i < stride; i++) {
          let skip_value = skip[offset + i];
          let bias_value = ${h?"bias[offset1d + i]":P+"(0.0)"};
          let input_value = x[offset + i];
          let value = input_value + skip_value + bias_value;
          ${_?"input_skip_bias_sum[offset + i] = value;":""}
          output[offset + i] = value;
          let f32_value = ${Hf(P,y,"value")};
          sum_shared[ix] += f32_value;
          sum_squared_shared[ix] += f32_value * f32_value;
        }
        workgroupBarrier();

        var reduce_size : u32 = ${b};
        for (var curr_size = reduce_size >> 1;  curr_size > 0; curr_size = reduce_size >> 1) {
          reduce_size = curr_size + (reduce_size & 1);
          if (ix < curr_size) {
            sum_shared[ix] += sum_shared[ix + reduce_size];
            sum_squared_shared[ix] += sum_squared_shared[ix + reduce_size];
          }
          workgroupBarrier();
        }

        let sum = sum_shared[0];
        let square_sum = sum_squared_shared[0];
        let mean = ${Lc("sum",y)} / f32(uniforms.hidden_size);
        let inv_std_dev = inverseSqrt(${Lc("square_sum",y)} / f32(uniforms.hidden_size) ${i?"":"- mean * mean"} + uniforms.epsilon);
        ${p?"mean_output[global_idx] = mean;":""}
        ${f?"inv_std_output[global_idx] = inv_std_dev;":""}

        for (var i: u32 = 0; i < stride; i++) {
          output[offset + i] = (output[offset + i] ${i?"":`- ${P}(mean)`}) *
            ${P}(inv_std_dev) * gamma[offset1d + i]
            ${u?"+ beta[offset1d + i]":""};
        }
      }`},M=[{dims:a,dataType:s[0].dataType}];return t>1&&M.push({dims:d,dataType:1}),t>2&&M.push({dims:d,dataType:1}),t>3&&M.push({dims:r,dataType:s[0].dataType}),{name:"SkipLayerNormalization",shaderCache:{hint:`${y};${p};${f};${_}`,inputDependencies:s.map((S,k)=>"type")},getShaderSource:C,getRunData:()=>({outputs:M,dispatchGroup:{x:Math.ceil(l/c)},programUniforms:w})}},g5=(s,e)=>{$j(s.inputs);let t=[0];s.outputCount>1&&t.push(-3),s.outputCount>2&&t.push(-3),s.outputCount>3&&t.push(3),s.compute(Bj(s.inputs,e,s.outputCount,!1),{outputs:t})}}),zj,Zy,Uj,PD,Vj,Gj,_5,y5,Kne=Ze(()=>{"use strict";$t(),Ht(),cs(),qt(),zj=(s,e)=>{if(!s||s.length<1)throw new Error("too few inputs");if(e.axes.length!==0){if(e.axes.length!==e.starts.length||e.axes.length!==e.ends.length)throw new Error("axes, starts and ends must have the same length")}else if(e.starts.length!==e.ends.length)throw new Error("starts and ends must have the same length");s.slice(1).forEach((t,n)=>{if(s[n+1].dataType!==6&&s[n+1].dataType!==7)throw new Error(`Input ${n} must be an array of int32 or int64`)})},Zy=(s,e)=>{let t=[];if(s.length>e)if(s[e].dataType===7)s[e].getBigInt64Array().forEach(n=>t.push(Number(n)));else if(s[e].dataType===6)s[e].getInt32Array().forEach(n=>t.push(Number(n)));else throw new Error(`Input ${e} must be an array of int32 or int64`);return t},Uj=(s,e)=>{if(s.length>1){let t=Zy(s,1),n=Zy(s,2),i=Zy(s,3);return i.length===0&&(i=[...Array(s[0].dims.length).keys()]),Mn({starts:t,ends:n,axes:i})}else return e},PD=(s,e,t,n,i)=>{let r=s;return s<0&&(r+=t[n[e]]),i[e]<0?Math.max(0,Math.min(r,t[n[e]]-1)):Math.max(0,Math.min(r,t[n[e]]))},Vj=(s,e,t)=>`fn calculateInputIndices(output_indices: ${e.type.indices}) -> ${s.type.indices} {
          var input_indices: ${s.type.indices};
          var carry = 0u;
          for (var i = ${t.length}; i >= 0; i--) {
            let input_shape_i = ${Et("uniforms.input_shape","i",t.length)};
            let steps_i = ${Et("uniforms.steps","i",t.length)};
            let signs_i = ${Et("uniforms.signs","i",t.length)};
            let starts_i = ${Et("uniforms.starts","i",t.length)};
            var output_index = ${e.indicesGet("output_indices","i")};
            var input_index = output_index * steps_i + starts_i + carry;
            carry = input_index / input_shape_i;
            input_index = input_index % input_shape_i;
            if (signs_i < 0) {
              input_index = input_shape_i - input_index - 1u + starts_i;
            }
            ${s.indicesSet("input_indices","i","input_index")};
          }
          return input_indices;
      }`,Gj=(s,e)=>{let t=s[0].dims,n=Ie.size(t),i=e.axes.length>0?Ie.normalizeAxes(e.axes,t.length):[...Array(t.length).keys()],r=Zy(s,4);r.forEach(y=>y!==0||(()=>{throw new Error("step cannot be 0")})),r.length===0&&(r=Array(i.length).fill(1));let o=e.starts.map((y,w)=>PD(y,w,t,i,r)),a=e.ends.map((y,w)=>PD(y,w,t,i,r));if(i.length!==o.length||i.length!==a.length)throw new Error("start, ends and axes should have the same number of elements");if(i.length!==t.length)for(let y=0;y<t.length;++y)i.includes(y)||(o.splice(y,0,0),a.splice(y,0,t[y]),r.splice(y,0,1));let l=r.map(y=>Math.sign(y));r.forEach((y,w,C)=>{if(y<0){let M=(a[w]-o[w])/y,S=o[w],k=S+M*r[w];o[w]=k,a[w]=S,C[w]=-y}});let c=t.slice(0);i.forEach((y,w)=>{c[y]=Math.ceil((a[y]-o[y])/r[y])});let d={dims:c,dataType:s[0].dataType},u=bt("output",s[0].dataType,c.length),h=Ue("input",s[0].dataType,s[0].dims.length),p=Ie.size(c),f=[{name:"outputSize",type:"u32"},{name:"starts",type:"u32",length:o.length},{name:"signs",type:"i32",length:l.length},{name:"steps",type:"u32",length:r.length}],_=[{type:12,data:p},{type:12,data:o},{type:6,data:l},{type:12,data:r},...St(s[0].dims,c)],b=y=>`
      ${y.registerUniforms(f).declareVariables(h,u)}
        ${Vj(h,u,t)}
        ${y.mainStart()}
          ${y.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}
          let output_indices = ${u.offsetToIndices("global_idx")};
          let input_indices = calculateInputIndices(output_indices);
          ${u.setByOffset("global_idx",h.getByIndices("input_indices"))}
      }`;return{name:"Slice",shaderCache:{hint:`${l.length}_${o.length}_${r.length}`,inputDependencies:["rank"]},getShaderSource:b,getRunData:()=>({outputs:[d],dispatchGroup:{x:Math.ceil(n/64)},programUniforms:_})}},_5=(s,e)=>{zj(s.inputs,e);let t=Uj(s.inputs,e);s.compute(Gj(s.inputs,t),{inputs:[0]})},y5=s=>{let e=s.starts,t=s.ends,n=s.axes;return Mn({starts:e,ends:t,axes:n})}}),Wj,Hj,v5,b5,Yne=Ze(()=>{"use strict";$t(),Ht(),cs(),Nc(),qt(),Wj=s=>{if(!s||s.length!==1)throw new Error("Softmax op requires 1 input.")},Hj=(s,e)=>{let t=s.inputs[0],n=t.dims,i=Ie.size(n),r=n.length,o=Ie.normalizeAxis(e.axis,r),a=o<n.length-1,l,c=[];a?(c=Array.from({length:r},(T,P)=>P),c[o]=r-1,c[r-1]=o,l=s.compute(Er(t,c),{inputs:[t],outputs:[-1]})[0]):l=t;let d=l.dims,u=d[r-1],h=i/u,p=es(u),f=u/p,_=64;h===1&&(_=256);let b=(T,P)=>P===4?`max(max(${T}.x, ${T}.y), max(${T}.z, ${T}.w))`:P===2?`max(${T}.x, ${T}.y)`:P===3?`max(max(${T}.x, ${T}.y), ${T}.z)`:T,y=Ue("x",l.dataType,l.dims,p),w=bt("result",l.dataType,l.dims,p),C=y.type.value,M=Vs(l.dataType)==="f32"?`var threadMax = ${C}(-3.402823e+38f);`:`var threadMax = ${C}(-65504.0h);`,S=T=>`
      var<workgroup> rowMaxShared : ${C};
      var<workgroup> rowSumShared : ${C};
      var<workgroup> threadShared : array<${C}, ${_}>;

      fn getValue(row: i32, col: i32, row_stride: i32) -> ${C} {
        let index = row * row_stride + col;
        return x[index];
      }

      fn setValue(row: i32, col: i32, row_stride: i32, value: ${C}) {
        let index = row * row_stride + col;
        result[index] = value;
      }
      ${T.registerUniform("packedCols","i32").declareVariables(y,w)}
      ${T.mainStart(_)}
        let gindex = i32(global_idx);
        let lindex = i32(local_idx);
        const wg = ${_};
        let row = gindex / wg;
        let cols = uniforms.packedCols;
        let row_stride : i32 = uniforms.packedCols;

        // find the rows max
        ${M}
        for (var col = lindex; col < cols; col += wg) {
          let value = getValue(row, col, row_stride);
          threadMax = max(threadMax, value);
        }
        if (lindex < cols) {
          threadShared[lindex] = threadMax;
        }
        workgroupBarrier();

        var reduceSize = min(cols, wg);
        for (var currSize = reduceSize >> 1;  currSize > 0; currSize = reduceSize >> 1) {
          reduceSize = currSize + (reduceSize & 1);
          if (lindex < currSize) {
            threadShared[lindex] = max(threadShared[lindex], threadShared[lindex + reduceSize]);
          }
          workgroupBarrier();
        }
        if (lindex == 0) {
          rowMaxShared = ${C}(${b("threadShared[0]",p)});
        }
        workgroupBarrier();

        // find the rows sum
        var threadSum = ${C}(0.0);
        for (var col = lindex; col < cols; col += wg) {
          let subExp = exp(getValue(row, col, row_stride) - rowMaxShared);
          threadSum += subExp;
        }
        threadShared[lindex] = threadSum;
        workgroupBarrier();

        for (var currSize = wg >> 1;  currSize > 0; currSize = currSize >> 1) {
          if (lindex < currSize) {
            threadShared[lindex] = threadShared[lindex] + threadShared[lindex + currSize];
          }
          workgroupBarrier();
        }
        if (lindex == 0) {
          rowSumShared = ${C}(${Lc("threadShared[0]",p)});
        }
        workgroupBarrier();

        // calculate final value for each element in the row
        for (var col = lindex; col < cols; col += wg) {
          let value = exp(getValue(row, col, row_stride) - rowMaxShared) / rowSumShared;
          setValue(row, col, row_stride, value);
        }
      }`,k=s.compute({name:"Softmax",shaderCache:{hint:`${p};${_}`,inputDependencies:["type"]},getRunData:()=>({outputs:[{dims:d,dataType:l.dataType}],dispatchGroup:{x:h},programUniforms:[{type:6,data:f}]}),getShaderSource:S},{inputs:[l],outputs:[a?-1:0]})[0];a&&s.compute(Er(k,c),{inputs:[k]})},v5=(s,e)=>{Wj(s.inputs),Hj(s,e)},b5=s=>Mn({axis:s.axis})}),kD,jj,qj,Kj,w5,Xne=Ze(()=>{"use strict";$t(),Ht(),qt(),kD=s=>Array.from(s.getBigInt64Array(),Number),jj=s=>{if(!s||s.length!==2)throw new Error("Tile requires 2 inputs.");if(s[0].dataType!==1&&s[0].dataType!==10&&s[0].dataType!==6&&s[0].dataType!==12)throw new Error("Tile only support float, float16, int32, and uint32 data types");if(s[1].dataType!==7)throw new Error("Tile `repeats` input should be of int64 data type");if(s[1].dims.length!==1)throw new Error("Tile `repeats` input should be 1-D");if(kD(s[1]).length!==s[0].dims.length)throw new Error("Tile `repeats` input should have same number of elements as rank of input data tensor")},qj=(s,e)=>{let t=[];for(let n=0;n<s.length;++n)t.push(s[n]*e[n]);return t},Kj=(s,e)=>{let t=s[0].dims,n=e??kD(s[1]),i=qj(t,n),r=Ie.size(i),o=s[0].dataType,a=Ue("input",o,t.length),l=bt("output",o,i.length),c=d=>`
      const inputShape = ${a.indices(...t)};
      ${d.registerUniform("output_size","u32").declareVariables(a,l)}
      ${d.mainStart()}
      ${d.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}
      let output_indices = ${l.offsetToIndices("global_idx")};
      var input_indices: ${a.type.indices};
      for (var i = 0; i < ${t.length}; i++) {
        let input_dim_i = ${a.indicesGet("uniforms.input_shape","i")};
        let input_dim_value = ${l.indicesGet("output_indices","i")}  % input_dim_i;

        ${a.indicesSet("input_indices","i","input_dim_value")}
      }
      ${l.setByOffset("global_idx",a.getByIndices("input_indices"))}
    }`;return{name:"Tile",shaderCache:{hint:`${n}`,inputDependencies:["rank"]},getRunData:()=>({outputs:[{dims:i,dataType:s[0].dataType}],dispatchGroup:{x:Math.ceil(r/64)},programUniforms:[{type:12,data:r},...St(s[0].dims,i)]}),getShaderSource:c}},w5=s=>{jj(s.inputs),s.compute(Kj(s.inputs),{inputs:[0]})}}),Yj,Xj,M5,Qne=Ze(()=>{"use strict";$t(),Ht(),qt(),Yj=(s,e,t,n,i)=>{let r=bt("output_data",i,t.length,4),o=Ue("a_data",e[1].dataType,e[1].dims.length,4),a=Ue("b_data",e[2].dataType,e[2].dims.length,4),l=Ue("c_data",e[0].dataType,e[0].dims.length,4),c,d=(u,h,p)=>`select(${h}, ${u}, ${p})`;if(!n)c=r.setByOffset("global_idx",d(o.getByOffset("global_idx"),a.getByOffset("global_idx"),l.getByOffset("global_idx")));else{let u=(h,p,f="")=>{let _=`a_data[index_a${p}][component_a${p}]`,b=`b_data[index_b${p}][component_b${p}]`,y=`bool(c_data[index_c${p}] & (0xffu << (component_c${p} * 8)))`;return`
            let output_indices${p} = ${r.offsetToIndices(`global_idx * 4u + ${p}u`)};
            let offset_a${p} = ${o.broadcastedIndicesToOffset(`output_indices${p}`,r)};
            let offset_b${p} = ${a.broadcastedIndicesToOffset(`output_indices${p}`,r)};
            let offset_c${p} = ${l.broadcastedIndicesToOffset(`output_indices${p}`,r)};
            let index_a${p} = offset_a${p} / 4u;
            let index_b${p} = offset_b${p} / 4u;
            let index_c${p} = offset_c${p} / 4u;
            let component_a${p} = offset_a${p} % 4u;
            let component_b${p} = offset_b${p} % 4u;
            let component_c${p} = offset_c${p} % 4u;
            ${h}[${p}] = ${f}(${d(_,b,y)});
          `};i===9?c=`
            var data = vec4<u32>(0);
            ${u("data",0,"u32")}
            ${u("data",1,"u32")}
            ${u("data",2,"u32")}
            ${u("data",3,"u32")}
            output_data[global_idx] = dot(vec4<u32>(0x1, 0x100, 0x10000, 0x1000000), vec4<u32>(data));`:c=`
            ${u("output_data[global_idx]",0)}
            ${u("output_data[global_idx]",1)}
            ${u("output_data[global_idx]",2)}
            ${u("output_data[global_idx]",3)}
          `}return`
        ${s.registerUniform("vec_size","u32").declareVariables(l,o,a,r)}
        ${s.mainStart()}
        ${s.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.vec_size")}
        ${c}
      }`},Xj=s=>{let e=s[1].dims,t=s[2].dims,n=s[0].dims,i=s[1].dataType,r=!(Ie.areEqual(e,t)&&Ie.areEqual(t,n)),o=e,a=Ie.size(e);if(r){let c=jf.calcShape(jf.calcShape(e,t,!1),n,!1);if(!c)throw new Error("Can't perform where op on the given tensors");o=c,a=Ie.size(o)}let l=Math.ceil(a/4);return{name:"Where",shaderCache:{inputDependencies:["rank","rank","rank"]},getShaderSource:c=>Yj(c,s,o,r,i),getRunData:()=>({outputs:[{dims:o,dataType:i}],dispatchGroup:{x:Math.ceil(a/64/4)},programUniforms:[{type:12,data:l},...St(n,e,t,o)]})}},M5=s=>{s.compute(Xj(s.inputs))}}),T5,Jne=Ze(()=>{"use strict";hne(),p1(),pne(),fne(),mne(),gne(),_ne(),Mne(),Ene(),xne(),Sne(),Cne(),Ane(),Pne(),kne(),Ine(),Dne(),Rne(),Fne(),Lne(),Nne(),One(),$ne(),Bne(),zne(),VK(),Une(),Vne(),Gne(),Wne(),Hne(),h1(),jne(),qK(),qne(),Kne(),Yne(),HK(),Xne(),Nc(),f1(),Qne(),T5=new Map([["Abs",[gq]],["Acos",[_q]],["Acosh",[yq]],["Add",[Jq]],["ArgMax",[hq,UD]],["ArgMin",[uq,UD]],["Asin",[vq]],["Asinh",[bq]],["Atan",[wq]],["Atanh",[Mq]],["Attention",[pq]],["AveragePool",[n5,t5]],["BatchNormalization",[fq]],["BiasAdd",[mq]],["BiasSplitGelu",[Qq]],["Cast",[Eq,Tq]],["Ceil",[Sq]],["Clip",[xq]],["Concat",[lK,cK]],["Conv",[qD,jD]],["ConvTranspose",[vK,yK]],["Cos",[Cq]],["Cosh",[Aq]],["CumSum",[bK,wK]],["DepthToSpace",[MK,TK]],["DequantizeLinear",[c5,d5]],["Div",[Zq]],["Einsum",[EK,xK]],["Elu",[Pq,iv]],["Equal",[eK]],["Erf",[kq]],["Exp",[Iq]],["Expand",[SK]],["FastGelu",[CK]],["Floor",[Dq]],["FusedConv",[qD,jD]],["Gather",[PK,AK]],["GatherElements",[LK,FK]],["GatherBlockQuantized",[DK,RK]],["GatherND",[kK,IK]],["Gelu",[Rq]],["Gemm",[OK,NK]],["GlobalAveragePool",[i5,s5]],["GlobalMaxPool",[l5,a5]],["Greater",[iK]],["GreaterOrEqual",[oK]],["GridSample",[$K,BK]],["GroupQueryAttention",[KK]],["HardSigmoid",[Uq,zq]],["InstanceNormalization",[YK]],["LayerNormalization",[XK]],["LeakyRelu",[Fq,iv]],["Less",[rK]],["LessOrEqual",[aK]],["Log",[Yq]],["MatMul",[QK]],["MatMulNBits",[JK,ZK]],["MaxPool",[r5,o5]],["Mul",[tK]],["MultiHeadAttention",[UK,zK]],["Neg",[Nq]],["Not",[Lq]],["Pad",[e5]],["Pow",[nK]],["QuickGelu",[Xq,iv]],["Range",[u5]],["Reciprocal",[Oq]],["ReduceMin",[oq]],["ReduceMean",[tq]],["ReduceMax",[rq]],["ReduceSum",[lq]],["ReduceProd",[aq]],["ReduceL1",[nq]],["ReduceL2",[sq]],["ReduceLogSum",[dq]],["ReduceLogSumExp",[iq]],["ReduceSumSquare",[cq]],["Relu",[$q]],["Resize",[f5,m5]],["RotaryEmbedding",[jK]],["ScatterND",[p5,h5]],["Sigmoid",[Bq]],["Sin",[Vq]],["Sinh",[Gq]],["Slice",[_5,y5]],["SkipLayerNormalization",[g5]],["Split",[GK,WK]],["Sqrt",[Wq]],["Softmax",[v5,b5]],["Sub",[sK]],["Tan",[Hq]],["Tanh",[jq]],["ThresholdedRelu",[Kq,iv]],["Tile",[w5]],["Transpose",[G4,W4]],["Where",[M5]]])}),E5,Zne=Ze(()=>{"use strict";No(),xl(),qt(),E5=class{constructor(s){this.backend=s,this.repo=new Map,this.attributesBound=!1}getArtifact(s){return this.repo.get(s)}setArtifact(s,e){this.repo.set(s,e)}run(s,e,t,n,i){Lo(s.programInfo.name);let r=this.backend.device,o=this.backend.getComputePassEncoder();this.backend.writeTimestamp(this.backend.pendingDispatchNumber*2);let a=[];for(let c of e)a.push({binding:a.length,resource:{buffer:c.buffer}});for(let c of t)a.push({binding:a.length,resource:{buffer:c.buffer}});i&&a.push({binding:a.length,resource:i});let l=r.createBindGroup({layout:s.computePipeline.getBindGroupLayout(0),entries:a,label:s.programInfo.name});if(this.backend.sessionStatus==="capturing"){let c={kernelId:this.backend.currentKernelId,computePipeline:s.computePipeline,bindGroup:l,dispatchGroup:n};this.backend.capturedCommandList.get(this.backend.currentSessionId).push(c)}o.setPipeline(s.computePipeline),o.setBindGroup(0,l),o.dispatchWorkgroups(...n),this.backend.writeTimestamp(this.backend.pendingDispatchNumber*2+1),this.backend.pendingDispatchNumber++,(this.backend.pendingDispatchNumber>=this.backend.maxDispatchNumber||this.backend.queryType==="at-passes")&&this.backend.endComputePass(),this.backend.pendingDispatchNumber>=this.backend.maxDispatchNumber&&this.backend.flush(),Hr(s.programInfo.name)}dispose(){}build(s,e){Lo(s.name);let t=this.backend.device,n=[];[{feature:"shader-f16",extension:"f16"},{feature:"subgroups",extension:"subgroups"}].forEach(c=>{t.features.has(c.feature)&&n.push(`enable ${c.extension};`)});let i=V4(e,this.backend.device.limits),r=s.getShaderSource(i),o=`${n.join(`
`)}
${i.additionalImplementations}
${r}`,a=t.createShaderModule({code:o,label:s.name});dn("verbose",()=>`[WebGPU] ${s.name} shader code: ${o}`);let l=t.createComputePipeline({compute:{module:a,entryPoint:"main"},layout:"auto",label:s.name});return Hr(s.name),{programInfo:s,computePipeline:l,uniformVariablesInfo:i.variablesInfo}}normalizeDispatchGroupSize(s){let e=typeof s=="number"?s:s.x,t=typeof s=="number"?1:s.y||1,n=typeof s=="number"?1:s.z||1,i=this.backend.device.limits.maxComputeWorkgroupsPerDimension;if(e<=i&&t<=i&&n<=i)return[e,t,n];let r=e*t*n,o=Math.ceil(Math.sqrt(r));if(o>i){if(o=Math.ceil(Math.cbrt(r)),o>i)throw new Error("Total dispatch size exceeds WebGPU maximum.");return[o,o,o]}else return[o,o,1]}}}),x5={};Kf(x5,{WebGpuBackend:()=>S5});var Qj,Jj,Zj,S5,ese=Ze(()=>{"use strict";No(),$t(),xl(),O4(),dne(),Jne(),Zne(),Qj=(s,e)=>{if(e.length!==s.length)throw new Error(`inputDependencies length ${e.length} is not equal to inputTensors length ${s.length}.`);let t=[];for(let n=0;n<s.length;++n){let i=s[n].dataType;switch(e[n]){case"none":{t.push("");break}case"type":{t.push(`${i}`);break}case"rank":{let r=s[n].dims.length;t.push(`${i};${r}`);break}case"dims":{let r=s[n].dims.join(",");t.push(`${i};${r}`);break}default:throw new Error(`unsupported input dependency: ${e[n]}`)}}return t.join("|")},Jj=(s,e,t)=>{let n=s.name;return s.shaderCache?.hint&&(n+="["+s.shaderCache.hint+"]"),n+=":"+t+`:${Qj(e,s.shaderCache?.inputDependencies??new Array(e.length).fill("dims"))}`,n},Zj=class{constructor(s){s&&(this.architecture=s.architecture,this.vendor=s.vendor)}isArchitecture(s){return this.architecture===s}isVendor(s){return this.vendor===s}},S5=class{constructor(){this.currentSessionId=null,this.currentKernelId=null,this.commandEncoder=null,this.computePassEncoder=null,this.maxDispatchNumber=16,this.pendingDispatchNumber=0,this.pendingKernels=[],this.pendingQueries=new Map,this.sessionStatus="default",this.capturedCommandList=new Map,this.capturedPendingKernels=new Map,this.sessionExternalDataMapping=new Map}get currentKernelCustomData(){if(this.currentKernelId===null)throw new Error("currentKernelCustomData(): currentKernelId is null. (should not happen)");let s=this.kernelCustomData.get(this.currentKernelId);return s||(s={},this.kernelCustomData.set(this.currentKernelId,s)),s}async initialize(s,e){this.env=s;let t=[],n={requiredLimits:{maxComputeWorkgroupStorageSize:e.limits.maxComputeWorkgroupStorageSize,maxComputeWorkgroupsPerDimension:e.limits.maxComputeWorkgroupsPerDimension,maxStorageBufferBindingSize:e.limits.maxStorageBufferBindingSize,maxBufferSize:e.limits.maxBufferSize,maxComputeInvocationsPerWorkgroup:e.limits.maxComputeInvocationsPerWorkgroup,maxComputeWorkgroupSizeX:e.limits.maxComputeWorkgroupSizeX,maxComputeWorkgroupSizeY:e.limits.maxComputeWorkgroupSizeY,maxComputeWorkgroupSizeZ:e.limits.maxComputeWorkgroupSizeZ},requiredFeatures:t},i=r=>e.features.has(r)&&t.push(r)&&!0;i("chromium-experimental-timestamp-query-inside-passes")||i("timestamp-query"),i("shader-f16"),i("subgroups"),this.device=await e.requestDevice(n),this.adapterInfo=new Zj(e.info||await e.requestAdapterInfo()),this.gpuDataManager=z4(this),this.programManager=new E5(this),this.kernels=new Map,this.kernelPersistentData=new Map,this.kernelCustomData=new Map,l1(s.logLevel,!!s.debug),this.device.onuncapturederror=r=>{r.error instanceof GPUValidationError&&console.error(`An uncaught WebGPU validation error was raised: ${r.error.message}`)},Object.defineProperty(this.env.webgpu,"device",{value:this.device,writable:!1,enumerable:!0,configurable:!1}),Object.defineProperty(this.env.webgpu,"adapter",{value:e,writable:!1,enumerable:!0,configurable:!1}),this.setQueryType()}dispose(){typeof this.querySet<"u"&&this.querySet.destroy(),this.gpuDataManager.dispose()}getCommandEncoder(){return this.commandEncoder||(this.commandEncoder=this.device.createCommandEncoder()),this.commandEncoder}getComputePassEncoder(){if(!this.computePassEncoder){let s=this.getCommandEncoder(),e={};this.queryType==="at-passes"&&(e.timestampWrites={querySet:this.querySet,beginningOfPassWriteIndex:this.pendingDispatchNumber*2,endOfPassWriteIndex:this.pendingDispatchNumber*2+1}),this.computePassEncoder=s.beginComputePass(e)}return this.computePassEncoder}endComputePass(){this.computePassEncoder&&(this.computePassEncoder.end(),this.computePassEncoder=null)}flush(){if(!this.commandEncoder)return;Lo(),this.endComputePass();let s;this.queryType!=="none"&&(this.commandEncoder.resolveQuerySet(this.querySet,0,this.pendingDispatchNumber*2,this.queryResolveBuffer,0),s=this.device.createBuffer({size:this.pendingDispatchNumber*2*8,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),this.pendingQueries.set(s,this.pendingKernels),this.pendingKernels=[],this.commandEncoder.copyBufferToBuffer(this.queryResolveBuffer,0,s,0,this.pendingDispatchNumber*2*8)),this.device.queue.submit([this.commandEncoder.finish()]),this.gpuDataManager.refreshPendingBuffers(),this.commandEncoder=null,this.pendingDispatchNumber=0,this.queryType!=="none"&&s.mapAsync(GPUMapMode.READ).then(()=>{let e=new BigUint64Array(s.getMappedRange()),t=this.pendingQueries.get(s);for(let n=0;n<e.length/2;n++){let i=t[n],r=i.kernelId,o=this.kernels.get(r),a=o.kernelType,l=o.kernelName,c=i.programName,d=i.inputTensorViews,u=i.outputTensorViews,h=e[n*2],p=e[n*2+1];typeof this.queryTimeBase>"u"&&(this.queryTimeBase=h);let f=Number(h-this.queryTimeBase),_=Number(p-this.queryTimeBase);if(!Number.isSafeInteger(f)||!Number.isSafeInteger(_))throw new RangeError("incorrect timestamp range");if(this.env.webgpu.profiling?.ondata)this.env.webgpu.profiling.ondata({version:1,inputsMetadata:d.map(b=>({dims:b.dims,dataType:El(b.dataType)})),outputsMetadata:u.map(b=>({dims:b.dims,dataType:El(b.dataType)})),kernelId:r,kernelType:a,kernelName:l,programName:c,startTime:f,endTime:_});else{let b="";d.forEach((w,C)=>{b+=`input[${C}]: [${w.dims}] | ${El(w.dataType)}, `});let y="";u.forEach((w,C)=>{y+=`output[${C}]: [${w.dims}] | ${El(w.dataType)}, `}),console.log(`[profiling] kernel "${r}|${a}|${l}|${c}" ${b}${y}execution time: ${_-f} ns`)}lv("GPU",`${c}::${h}::${p}`)}s.unmap(),this.pendingQueries.delete(s)}),Hr()}run(s,e,t,n,i,r){Lo(s.name);let o=[];for(let w=0;w<e.length;++w){let C=e[w].data;if(C===0)continue;let M=this.gpuDataManager.get(C);if(!M)throw new Error(`no GPU data for input: ${C}`);o.push(M)}let{outputs:a,dispatchGroup:l,programUniforms:c}=s.getRunData(e),d=t.length===0?a.map((w,C)=>C):t;if(d.length!==a.length)throw new Error(`Output size ${d.length} must be equal to ${a.length}.`);let u=[],h=[];for(let w=0;w<a.length;++w){if(!Number.isInteger(d[w])||d[w]<-3||d[w]>=r)throw new Error(`Invalid output index: ${d[w]}`);if(d[w]===-3)continue;let C=d[w]===-1,M=d[w]===-2,S=C||M?i(a[w].dataType,a[w].dims):n(d[w],a[w].dataType,a[w].dims);if(u.push(S),S.data===0)continue;let k=this.gpuDataManager.get(S.data);if(!k)throw new Error(`no GPU data for output: ${S.data}`);if(C&&this.temporaryData.push(k),M){let T=this.kernelPersistentData.get(this.currentKernelId);T||(T=[],this.kernelPersistentData.set(this.currentKernelId,T)),T.push(k)}h.push(k)}if(o.length!==e.length||h.length!==u.length){if(h.length===0)return Hr(s.name),u;throw new Error(`Program ${s.name} has zero-sized tensor(s) in inputs or outputs. This is not supported now.`)}let p;if(c){let w=0,C=[];c.forEach(T=>{let P=typeof T.data=="number"?[T.data]:T.data;if(P.length===0)return;let R=T.type===10?2:4,O,H;T.type===10?(H=P.length>4?16:P.length>2?8:P.length*R,O=P.length>4?16:R*P.length):(H=P.length<=2?P.length*R:16,O=16),w=Math.ceil(w/H)*H,C.push(w);let X=T.type===10?8:4;w+=P.length>4?Math.ceil(P.length/X)*O:P.length*R});let M=16;w=Math.ceil(w/M)*M;let S=new ArrayBuffer(w);c.forEach((T,P)=>{let R=C[P],O=typeof T.data=="number"?[T.data]:T.data;if(T.type===6)new Int32Array(S,R,O.length).set(O);else if(T.type===12)new Uint32Array(S,R,O.length).set(O);else if(T.type===10)new Uint16Array(S,R,O.length).set(O);else if(T.type===1)new Float32Array(S,R,O.length).set(O);else throw new Error(`Unsupported uniform type: ${El(T.type)}`)});let k=this.gpuDataManager.create(w,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM);this.device.queue.writeBuffer(k.buffer,0,S,0,w),this.gpuDataManager.release(k.id),p={offset:0,size:w,buffer:k.buffer}}let f=this.programManager.normalizeDispatchGroupSize(l),_=f[1]===1&&f[2]===1,b=Jj(s,e,_),y=this.programManager.getArtifact(b);if(y||(y=this.programManager.build(s,f),this.programManager.setArtifact(b,y),dn("info",()=>`[artifact] key: ${b}, programName: ${s.name}`)),c&&y.uniformVariablesInfo){if(c.length!==y.uniformVariablesInfo.length)throw new Error(`Uniform variables count mismatch: expect ${y.uniformVariablesInfo.length}, got ${c.length} in program "${y.programInfo.name}".`);for(let w=0;w<c.length;w++){let C=c[w],M=C.type,S=typeof C.data=="number"?1:C.data.length,[k,T]=y.uniformVariablesInfo[w];if(M!==k||S!==T)throw new Error(`Uniform variable ${w} mismatch: expect type ${k} with size ${T}, got type ${M} with size ${S} in program "${y.programInfo.name}".`)}}if(dn("info",()=>`[ProgramManager] run "${s.name}" (key=${b}) with ${f[0]}x${f[1]}x${f[2]}`),this.queryType!=="none"||this.sessionStatus==="capturing"){let w={kernelId:this.currentKernelId,programName:y.programInfo.name,inputTensorViews:e,outputTensorViews:u};this.pendingKernels.push(w),this.sessionStatus==="capturing"&&this.capturedPendingKernels.get(this.currentSessionId).push(w)}return this.programManager.run(y,o,h,f,p),Hr(s.name),u}upload(s,e){this.gpuDataManager.upload(s,e)}memcpy(s,e){this.gpuDataManager.memcpy(s,e)}async download(s,e){await this.gpuDataManager.download(s,e)}alloc(s){return this.gpuDataManager.create(s).id}free(s){return this.gpuDataManager.release(s)}createKernel(s,e,t,n){let i=T5.get(s);if(!i)throw new Error(`kernel not implemented: ${s}`);let r={kernelType:s,kernelName:n,kernelEntry:i[0],attributes:[i[1],t]};this.kernels.set(e,r)}releaseKernel(s){let e=this.kernelPersistentData.get(s);if(e){for(let t of e)this.gpuDataManager.release(t.id);this.kernelPersistentData.delete(s)}this.kernelCustomData.delete(s),this.kernels.delete(s)}computeKernel(s,e,t){let n=this.kernels.get(s);if(!n)throw new Error(`kernel not created: ${s}`);let i=n.kernelType,r=n.kernelName,o=n.kernelEntry,a=n.attributes;if(this.currentKernelId!==null)throw new Error(`kernel "[${i}] ${r}" is not allowed to be called recursively`);this.currentKernelId=s,a[0]&&(a[1]=a[0](a[1]),a[0]=void 0),dn("info",()=>`[WebGPU] Start to run kernel "[${i}] ${r}"...`);let l=this.env.debug;this.temporaryData=[];try{return l&&this.device.pushErrorScope("validation"),o(e,a[1]),0}catch(c){return t.push(Promise.resolve(`[WebGPU] Kernel "[${i}] ${r}" failed. ${c}`)),1}finally{l&&t.push(this.device.popErrorScope().then(c=>c?`GPU validation error for kernel "[${i}] ${r}": ${c.message}`:null));for(let c of this.temporaryData)this.gpuDataManager.release(c.id);this.temporaryData=[],this.currentKernelId=null}}registerBuffer(s,e,t,n){let i=this.sessionExternalDataMapping.get(s);i||(i=new Map,this.sessionExternalDataMapping.set(s,i));let r=i.get(e),o=this.gpuDataManager.registerExternalBuffer(t,n,r);return i.set(e,[o,t]),o}unregisterBuffers(s){let e=this.sessionExternalDataMapping.get(s);e&&(e.forEach(t=>this.gpuDataManager.unregisterExternalBuffer(t[0])),this.sessionExternalDataMapping.delete(s))}getBuffer(s){let e=this.gpuDataManager.get(s);if(!e)throw new Error(`no GPU data for buffer: ${s}`);return e.buffer}createDownloader(s,e,t){return async()=>{let n=await $D(this,s,e);return c1(n.buffer,t)}}writeTimestamp(s){this.queryType==="inside-passes"&&this.computePassEncoder.writeTimestamp(this.querySet,s)}setQueryType(){this.queryType="none",(this.env.webgpu.profiling?.mode==="default"||(typeof this.env.trace>"u"?this.env.wasm.trace:this.env.trace))&&(this.device.features.has("chromium-experimental-timestamp-query-inside-passes")?this.queryType="inside-passes":this.device.features.has("timestamp-query")&&(this.queryType="at-passes"),this.queryType!=="none"&&typeof this.querySet>"u"&&(this.querySet=this.device.createQuerySet({type:"timestamp",count:this.maxDispatchNumber*2}),this.queryResolveBuffer=this.device.createBuffer({size:this.maxDispatchNumber*2*8,usage:GPUBufferUsage.COPY_SRC|GPUBufferUsage.QUERY_RESOLVE})))}captureBegin(){dn("info","captureBegin"),this.capturedCommandList.get(this.currentSessionId)||this.capturedCommandList.set(this.currentSessionId,[]),this.capturedPendingKernels.get(this.currentSessionId)||this.capturedPendingKernels.set(this.currentSessionId,[]),this.flush(),this.sessionStatus="capturing"}captureEnd(){dn("info","captureEnd"),this.flush(),this.sessionStatus="default"}replay(){dn("info","replay"),this.sessionStatus="replaying";let s=this.capturedCommandList.get(this.currentSessionId),e=this.capturedPendingKernels.get(this.currentSessionId),t=s.length;this.pendingKernels=[];for(let n=0;n<t;n++){let i=this.getComputePassEncoder(),r=s[n];this.writeTimestamp(this.pendingDispatchNumber*2),i.setPipeline(r.computePipeline),i.setBindGroup(0,r.bindGroup),i.dispatchWorkgroups(...r.dispatchGroup),this.writeTimestamp(this.pendingDispatchNumber*2+1),this.pendingDispatchNumber++,this.queryType!=="none"&&this.pendingKernels.push(e[n]),(this.pendingDispatchNumber>=this.maxDispatchNumber||this.queryType==="at-passes")&&this.endComputePass(),this.pendingDispatchNumber>=this.maxDispatchNumber&&this.flush()}this.flush(),this.sessionStatus="default"}onCreateSession(){this.gpuDataManager.onCreateSession()}onReleaseSession(s){this.unregisterBuffers(s),this.capturedCommandList.has(s)&&this.capturedCommandList.delete(s),this.capturedPendingKernels.has(s)&&this.capturedPendingKernels.delete(s),this.gpuDataManager.onReleaseSession(s)}onRunStart(s){this.currentSessionId=s,this.setQueryType()}}}),C5={};Kf(C5,{init:()=>A5});var U0,e4,A5,tse=Ze(()=>{"use strict";$t(),xl(),Ht(),cne(),U0=class P5{constructor(e,t,n,i){this.module=e,this.dataType=t,this.data=n,this.dims=i}getFloat32Array(){if(this.dataType!==1)throw new Error("Invalid data type");let e=Ie.size(this.dims);return e===0?new Float32Array:new Float32Array(this.module.HEAP8.buffer,this.data,e)}getBigInt64Array(){if(this.dataType!==7)throw new Error("Invalid data type");let e=Ie.size(this.dims);return e===0?new BigInt64Array:new BigInt64Array(this.module.HEAP8.buffer,this.data,e)}getInt32Array(){if(this.dataType!==6)throw new Error("Invalid data type");let e=Ie.size(this.dims);return e===0?new Int32Array:new Int32Array(this.module.HEAP8.buffer,this.data,e)}getUint16Array(){if(this.dataType!==10&&this.dataType!==4)throw new Error("Invalid data type");let e=Ie.size(this.dims);return e===0?new Uint16Array:new Uint16Array(this.module.HEAP8.buffer,this.data,e)}reshape(e){if(Ie.size(e)!==Ie.size(this.dims))throw new Error("Invalid new shape");return new P5(this.module,this.dataType,this.data,e)}},e4=class{constructor(s,e,t){this.module=s,this.backend=e,this.customDataOffset=0,this.customDataSize=0,this.adapterInfo=e.adapterInfo;let n=s.PTR_SIZE,i=t/s.PTR_SIZE,r=n===4?"i32":"i64";this.opKernelContext=Number(s.getValue(n*i++,r));let o=Number(s.getValue(n*i++,r));this.outputCount=Number(s.getValue(n*i++,r)),this.customDataOffset=Number(s.getValue(n*i++,"*")),this.customDataSize=Number(s.getValue(n*i++,r));let a=[];for(let l=0;l<o;l++){let c=Number(s.getValue(n*i++,r)),d=Number(s.getValue(n*i++,"*")),u=Number(s.getValue(n*i++,r)),h=[];for(let p=0;p<u;p++)h.push(Number(s.getValue(n*i++,r)));a.push(new U0(s,c,d,h))}this.inputs=a}get kernelCustomData(){return this.backend.currentKernelCustomData}get customDataBuffer(){return this.module.HEAPU8.subarray(this.customDataOffset,this.customDataOffset+this.customDataSize)}compute(s,e){let t=e?.inputs?.map(o=>typeof o=="number"?this.inputs[o]:o)??this.inputs,n=e?.outputs??[],i=(o,a,l)=>new U0(this.module,a,this.output(o,l),l),r=(o,a)=>{let l=Qu(o,a);if(!l)throw new Error(`Unsupported data type: ${o}`);let c=l>0?this.backend.gpuDataManager.create(l).id:0;return new U0(this.module,o,c,a)};return this.backend.run(s,t,n,i,r,this.outputCount)}output(s,e){let t=this.module.stackSave();try{let n=this.module.PTR_SIZE,i=n===4?"i32":"i64",r=this.module.stackAlloc((1+e.length)*n);this.module.setValue(r,e.length,i);for(let o=0;o<e.length;o++)this.module.setValue(r+n*(o+1),e[o],i);return this.module._JsepOutput(this.opKernelContext,s,r)}catch(n){throw new Error(`Failed to generate kernel's output[${s}] with dims [${e}]. If you are running with pre-allocated output, please make sure the output type/dims are correct. Error: ${n}`)}finally{this.module.stackRestore(t)}}},A5=async(s,e,t,n)=>{let i=e.jsepInit;if(!i)throw new Error("Failed to initialize JSEP. The WebAssembly module is not built with JSEP support.");if(s==="webgpu"){let r=(ese(),av(x5)).WebGpuBackend,o=new r;await o.initialize(t,n),i("webgpu",[o,a=>o.alloc(Number(a)),a=>o.free(a),(a,l,c,d=!1)=>{if(d)dn("verbose",()=>`[WebGPU] jsepCopyGpuToGpu: src=${Number(a)}, dst=${Number(l)}, size=${Number(c)}`),o.memcpy(Number(a),Number(l));else{dn("verbose",()=>`[WebGPU] jsepCopyCpuToGpu: dataOffset=${Number(a)}, gpuDataId=${Number(l)}, size=${Number(c)}`);let u=e.HEAPU8.subarray(Number(a>>>0),Number(a>>>0)+Number(c));o.upload(Number(l),u)}},async(a,l,c)=>{dn("verbose",()=>`[WebGPU] jsepCopyGpuToCpu: gpuDataId=${a}, dataOffset=${l}, size=${c}`),await o.download(Number(a),()=>e.HEAPU8.subarray(Number(l)>>>0,Number(l+c)>>>0))},(a,l,c)=>o.createKernel(a,Number(l),c,e.UTF8ToString(e._JsepGetNodeName(Number(l)))),a=>o.releaseKernel(a),(a,l,c,d)=>{dn("verbose",()=>`[WebGPU] jsepRun: sessionHandle=${c}, kernel=${a}, contextDataOffset=${l}`);let u=new e4(e,o,Number(l));return o.computeKernel(Number(a),u,d)},()=>o.captureBegin(),()=>o.captureEnd(),()=>o.replay()])}else{let r=new B4(t);i("webnn",[r,()=>r.reserveTensorId(),o=>r.releaseTensorId(o),async(o,a,l,c,d)=>r.ensureTensor(o,a,l,c,d),(o,a)=>{r.uploadTensor(o,a)},async(o,a)=>r.downloadTensor(o,a)])}}}),t4,b1,w1,Rc,n4,ID,J0,M1,T1,DD,E1,x1,S1,k5=Ze(()=>{"use strict";one(),ane(),$t(),nh(),s1(),R4(),t4=(s,e)=>{Nn()._OrtInit(s,e)!==0&&An("Can't initialize onnxruntime.")},b1=async s=>{t4(s.wasm.numThreads,q0(s.logLevel))},w1=async(s,e)=>{Nn().asyncInit?.();{let t=(tse(),av(C5)).init;if(e==="webgpu"){if(typeof navigator>"u"||!navigator.gpu)throw new Error("WebGPU is not supported in current environment");let n=s.webgpu.adapter;if(n){if(typeof n.limits!="object"||typeof n.features!="object"||typeof n.requestDevice!="function")throw new Error("Invalid GPU adapter set in `env.webgpu.adapter`. It must be a GPUAdapter object.")}else{let i=s.webgpu.powerPreference;if(i!==void 0&&i!=="low-power"&&i!=="high-performance")throw new Error(`Invalid powerPreference setting: "${i}"`);let r=s.webgpu.forceFallbackAdapter;if(r!==void 0&&typeof r!="boolean")throw new Error(`Invalid forceFallbackAdapter setting: "${r}"`);if(n=await navigator.gpu.requestAdapter({powerPreference:i,forceFallbackAdapter:r}),!n)throw new Error('Failed to get GPU adapter. You may need to enable flag "--enable-unsafe-webgpu" if you are using Chrome.')}await t("webgpu",Nn(),s,n)}if(e==="webnn"){if(typeof navigator>"u"||!navigator.ml)throw new Error("WebNN is not supported in current environment");await t("webnn",Nn(),s)}}},Rc=new Map,n4=s=>{let e=Nn(),t=e.stackSave();try{let n=e.PTR_SIZE,i=e.stackAlloc(2*n);e._OrtGetInputOutputCount(s,i,i+n)!==0&&An("Can't get session input/output count.");let r=n===4?"i32":"i64";return[Number(e.getValue(i,r)),Number(e.getValue(i+n,r))]}finally{e.stackRestore(t)}},ID=(s,e)=>{let t=Nn(),n=t.stackSave(),i=0;try{let r=t.PTR_SIZE,o=t.stackAlloc(2*r);t._OrtGetInputOutputMetadata(s,e,o,o+r)!==0&&An("Can't get session input/output metadata.");let a=Number(t.getValue(o,"*"));i=Number(t.getValue(o+r,"*"));let l=t.HEAP32[i/4];if(l===0)return[a,0];let c=t.HEAPU32[i/4+1],d=[];for(let u=0;u<c;u++){let h=Number(t.getValue(i+8+u*r,"*"));d.push(h!==0?t.UTF8ToString(h):Number(t.getValue(i+8+(u+c)*r,"*")))}return[a,l,d]}finally{t.stackRestore(n),i!==0&&t._OrtFree(i)}},J0=s=>{let e=Nn(),t=e._malloc(s.byteLength);if(t===0)throw new Error(`Can't create a session. failed to allocate a buffer of size ${s.byteLength}.`);return e.HEAPU8.set(s,t),[t,s.byteLength]},M1=async(s,e)=>{let t,n,i=Nn();Array.isArray(s)?[t,n]=s:s.buffer===i.HEAPU8.buffer?[t,n]=[s.byteOffset,s.byteLength]:[t,n]=J0(s);let r=0,o=0,a=0,l=[],c=[],d=[];try{if([o,l]=await D4(e),e?.externalData&&i.mountExternalData){let M=[];for(let S of e.externalData){let k=typeof S=="string"?S:S.path;M.push(a1(typeof S=="string"?S:S.data).then(T=>{i.mountExternalData(k,T)}))}await Promise.all(M)}for(let M of e?.executionProviders??[])if((typeof M=="string"?M:M.name)==="webnn"){if(i.shouldTransferToMLTensor=!1,typeof M!="string"){let S=M,k=S?.context,T=S?.gpuDevice,P=S?.deviceType,R=S?.powerPreference;k?i.currentContext=k:T?i.currentContext=await i.webnnCreateMLContext(T):i.currentContext=await i.webnnCreateMLContext({deviceType:P,powerPreference:R})}else i.currentContext=await i.webnnCreateMLContext();break}r=await i._OrtCreateSession(t,n,o),i.webgpuOnCreateSession?.(r),r===0&&An("Can't create a session."),i.jsepOnCreateSession?.(),i.currentContext&&(i.webnnRegisterMLContext(r,i.currentContext),i.currentContext=void 0,i.shouldTransferToMLTensor=!0);let[u,h]=n4(r),p=!!e?.enableGraphCapture,f=[],_=[],b=[],y=[],w=[];for(let M=0;M<u;M++){let[S,k,T]=ID(r,M);S===0&&An("Can't get an input name."),c.push(S);let P=i.UTF8ToString(S);f.push(P),b.push(k===0?{name:P,isTensor:!1}:{name:P,isTensor:!0,type:El(k),shape:T})}for(let M=0;M<h;M++){let[S,k,T]=ID(r,M+u);S===0&&An("Can't get an output name."),d.push(S);let P=i.UTF8ToString(S);_.push(P),y.push(k===0?{name:P,isTensor:!1}:{name:P,isTensor:!0,type:El(k),shape:T});{if(p&&e?.preferredOutputLocation===void 0){w.push("gpu-buffer");continue}let R=typeof e?.preferredOutputLocation=="string"?e.preferredOutputLocation:e?.preferredOutputLocation?.[P]??"cpu";if(R!=="cpu"&&R!=="cpu-pinned"&&R!=="gpu-buffer"&&R!=="ml-tensor")throw new Error(`Not supported preferred output location: ${R}.`);if(p&&R!=="gpu-buffer")throw new Error(`Not supported preferred output location: ${R}. Only 'gpu-buffer' location is supported when enableGraphCapture is true.`);w.push(R)}}let C=null;return w.some(M=>M==="gpu-buffer"||M==="ml-tensor")&&(a=i._OrtCreateBinding(r),a===0&&An("Can't create IO binding."),C={handle:a,outputPreferredLocations:w,outputPreferredLocationsEncoded:w.map(M=>ND(M))}),Rc.set(r,[r,c,d,C,p,!1]),[r,f,_,b,y]}catch(u){throw c.forEach(h=>i._OrtFree(h)),d.forEach(h=>i._OrtFree(h)),a!==0&&i._OrtReleaseBinding(a)!==0&&An("Can't release IO binding."),r!==0&&i._OrtReleaseSession(r)!==0&&An("Can't release session."),u}finally{i._free(t),o!==0&&i._OrtReleaseSessionOptions(o)!==0&&An("Can't release session options."),l.forEach(u=>i._free(u)),i.unmountExternalData?.()}},T1=s=>{let e=Nn(),t=Rc.get(s);if(!t)throw new Error(`cannot release session. invalid session id: ${s}`);let[n,i,r,o,a]=t;o&&(a&&e._OrtClearBoundOutputs(o.handle)!==0&&An("Can't clear bound outputs."),e._OrtReleaseBinding(o.handle)!==0&&An("Can't release IO binding.")),e.jsepOnReleaseSession?.(s),e.webnnOnReleaseSession?.(s),e.webgpuOnReleaseSession?.(s),i.forEach(l=>e._OrtFree(l)),r.forEach(l=>e._OrtFree(l)),e._OrtReleaseSession(n)!==0&&An("Can't release session."),Rc.delete(s)},DD=async(s,e,t,n,i,r,o=!1)=>{if(!s){e.push(0);return}let a=Nn(),l=a.PTR_SIZE,c=s[0],d=s[1],u=s[3],h=u,p,f;if(c==="string"&&(u==="gpu-buffer"||u==="ml-tensor"))throw new Error("String tensor is not supported on GPU.");if(o&&u!=="gpu-buffer")throw new Error(`External buffer must be provided for input/output index ${r} when enableGraphCapture is true.`);if(u==="gpu-buffer"){let y=s[2].gpuBuffer;f=Qu(Wf(c),d);{let w=a.jsepRegisterBuffer;if(!w)throw new Error('Tensor location "gpu-buffer" is not supported without using WebGPU.');p=w(n,r,y,f)}}else if(u==="ml-tensor"){let y=s[2].mlTensor;f=Qu(Wf(c),d);let w=a.webnnRegisterMLTensor;if(!w)throw new Error('Tensor location "ml-tensor" is not supported without using WebNN.');p=w(n,y,Wf(c),d)}else{let y=s[2];if(Array.isArray(y)){f=l*y.length,p=a._malloc(f),t.push(p);for(let w=0;w<y.length;w++){if(typeof y[w]!="string")throw new TypeError(`tensor data at index ${w} is not a string`);a.setValue(p+w*l,Do(y[w],t),"*")}}else{let w=a.webnnIsGraphInput;if(c!=="string"&&w){let C=a.UTF8ToString(i);if(w(n,C)){let M=Wf(c);f=Qu(M,d),h="ml-tensor";let S=a.webnnCreateTemporaryTensor,k=a.webnnUploadTensor;if(!S||!k)throw new Error('Tensor location "ml-tensor" is not supported without using WebNN.');let T=await S(n,M,d);k(T,new Uint8Array(y.buffer,y.byteOffset,y.byteLength)),p=T}else f=y.byteLength,p=a._malloc(f),t.push(p),a.HEAPU8.set(new Uint8Array(y.buffer,y.byteOffset,f),p)}else f=y.byteLength,p=a._malloc(f),t.push(p),a.HEAPU8.set(new Uint8Array(y.buffer,y.byteOffset,f),p)}}let _=a.stackSave(),b=a.stackAlloc(4*d.length);try{d.forEach((w,C)=>a.setValue(b+C*l,w,l===4?"i32":"i64"));let y=a._OrtCreateTensor(Wf(c),p,f,b,d.length,ND(h));y===0&&An(`Can't create tensor for input/output. session=${n}, index=${r}.`),e.push(y)}finally{a.stackRestore(_)}},E1=async(s,e,t,n,i,r)=>{let o=Nn(),a=o.PTR_SIZE,l=Rc.get(s);if(!l)throw new Error(`cannot run inference. invalid session id: ${s}`);let c=l[0],d=l[1],u=l[2],h=l[3],p=l[4],f=l[5],_=e.length,b=n.length,y=0,w=[],C=[],M=[],S=[],k=o.stackSave(),T=o.stackAlloc(_*a),P=o.stackAlloc(_*a),R=o.stackAlloc(b*a),O=o.stackAlloc(b*a);try{[y,w]=I4(r);for(let z=0;z<_;z++)await DD(t[z],C,S,s,d[e[z]],e[z],p);for(let z=0;z<b;z++)await DD(i[z],M,S,s,u[n[z]],_+n[z],p);for(let z=0;z<_;z++)o.setValue(T+z*a,C[z],"*"),o.setValue(P+z*a,d[e[z]],"*");for(let z=0;z<b;z++)o.setValue(R+z*a,M[z],"*"),o.setValue(O+z*a,u[n[z]],"*");if(h&&!f){let{handle:z,outputPreferredLocations:ne,outputPreferredLocationsEncoded:re}=h;if(d.length!==_)throw new Error(`input count from feeds (${_}) is expected to be always equal to model's input count (${d.length}).`);for(let Y=0;Y<_;Y++){let se=e[Y];await o._OrtBindInput(z,d[se],C[Y])!==0&&An(`Can't bind input[${Y}] for session=${s}.`)}for(let Y=0;Y<b;Y++){let se=n[Y];i[Y]?.[3]?o._OrtBindOutput(z,u[se],M[Y],0)!==0&&An(`Can't bind pre-allocated output[${Y}] for session=${s}.`):o._OrtBindOutput(z,u[se],0,re[se])!==0&&An(`Can't bind output[${Y}] to ${ne[Y]} for session=${s}.`)}Rc.set(s,[c,d,u,h,p,!0])}o.jsepOnRunStart?.(c),o.webnnOnRunStart?.(c);let H;h?H=await o._OrtRunWithBinding(c,h.handle,b,R,y):H=await o._OrtRun(c,P,T,_,O,b,R,y),H!==0&&An("failed to call OrtRun().");let X=[];for(let z=0;z<b;z++){let ne=Number(o.getValue(R+z*a,"*"));if(ne===M[z]){X.push(i[z]);continue}let re=o.stackSave(),Y=o.stackAlloc(4*a),se=!1,ue,fe=0;try{o._OrtGetTensorData(ne,Y,Y+a,Y+2*a,Y+3*a)!==0&&An(`Can't access output tensor data on index ${z}.`);let Pe=a===4?"i32":"i64",oe=Number(o.getValue(Y,Pe));fe=o.getValue(Y+a,"*");let te=o.getValue(Y+a*2,"*"),j=Number(o.getValue(Y+a*3,Pe)),G=[];for(let xe=0;xe<j;xe++)G.push(Number(o.getValue(te+xe*a,Pe)));o._OrtFree(te)!==0&&An("Can't free memory for tensor dims.");let de=G.reduce((xe,Oe)=>xe*Oe,1);ue=El(oe);let be=h?.outputPreferredLocations[n[z]];if(ue==="string"){if(be==="gpu-buffer"||be==="ml-tensor")throw new Error("String tensor is not supported on GPU.");let xe=[];for(let Oe=0;Oe<de;Oe++){let je=o.getValue(fe+Oe*a,"*"),dt=o.getValue(fe+(Oe+1)*a,"*"),Re=Oe===de-1?void 0:dt-je;xe.push(o.UTF8ToString(je,Re))}X.push([ue,G,xe,"cpu"])}else if(be==="gpu-buffer"&&de>0){let xe=o.jsepGetBuffer;if(!xe)throw new Error('preferredLocation "gpu-buffer" is not supported without using WebGPU.');let Oe=xe(fe),je=Qu(oe,de);if(je===void 0||!r1(ue))throw new Error(`Unsupported data type: ${ue}`);se=!0,X.push([ue,G,{gpuBuffer:Oe,download:o.jsepCreateDownloader(Oe,je,ue),dispose:()=>{o._OrtReleaseTensor(ne)!==0&&An("Can't release tensor.")}},"gpu-buffer"])}else if(be==="ml-tensor"&&de>0){let xe=o.webnnEnsureTensor,Oe=o.webnnIsInt64Supported;if(!xe||!Oe)throw new Error('preferredLocation "ml-tensor" is not supported without using WebNN.');if(Qu(oe,de)===void 0||!o1(ue))throw new Error(`Unsupported data type: ${ue}`);if(ue==="int64"&&!Oe(s))throw new Error('preferredLocation "ml-tensor" for int64 output is not supported by current WebNN Context.');let je=await xe(s,fe,oe,G,!1);se=!0,X.push([ue,G,{mlTensor:je,download:o.webnnCreateMLTensorDownloader(fe,ue),dispose:()=>{o.webnnReleaseTensorId(fe),o._OrtReleaseTensor(ne)}},"ml-tensor"])}else{let xe=i1(ue),Oe=new xe(de);new Uint8Array(Oe.buffer,Oe.byteOffset,Oe.byteLength).set(o.HEAPU8.subarray(fe,fe+Oe.byteLength)),X.push([ue,G,Oe,"cpu"])}}finally{o.stackRestore(re),ue==="string"&&fe&&o._free(fe),se||o._OrtReleaseTensor(ne),o.webnnOnRunEnd?.(c)}}return h&&!p&&(o._OrtClearBoundOutputs(h.handle)!==0&&An("Can't clear bound outputs."),Rc.set(s,[c,d,u,h,p,!1])),X}finally{o.stackRestore(k),C.forEach(H=>o._OrtReleaseTensor(H)),M.forEach(H=>o._OrtReleaseTensor(H)),S.forEach(H=>o._free(H)),y!==0&&o._OrtReleaseRunOptions(y),w.forEach(H=>o._free(H))}},x1=s=>{let e=Nn(),t=Rc.get(s);if(!t)throw new Error("invalid session id");let n=t[0],i=e._OrtEndProfiling(n);i===0&&An("Can't get an profile file name."),e._OrtFree(i)},S1=s=>{let e=[];for(let t of s){let n=t[2];!Array.isArray(n)&&"buffer"in n&&e.push(n.buffer)}return e}}),Fc,Gr,Gf,ev,tv,V0,RD,G0,Ku,Yu,s4,I5,D5,R5,F5,L5,N5,O5,$5=Ze(()=>{"use strict";No(),k5(),nh(),t1(),Fc=()=>!!Un.wasm.proxy&&typeof document<"u",Gf=!1,ev=!1,tv=!1,G0=new Map,Ku=(s,e)=>{let t=G0.get(s);t?t.push(e):G0.set(s,[e])},Yu=()=>{if(Gf||!ev||tv||!Gr)throw new Error("worker not ready")},s4=s=>{switch(s.data.type){case"init-wasm":Gf=!1,s.data.err?(tv=!0,RD[1](s.data.err)):(ev=!0,RD[0]()),V0&&(URL.revokeObjectURL(V0),V0=void 0);break;case"init-ep":case"copy-from":case"create":case"release":case"run":case"end-profiling":{let e=G0.get(s.data.type);s.data.err?e.shift()[1](s.data.err):e.shift()[0](s.data.out);break}default:}},I5=async()=>{if(!ev){if(Gf)throw new Error("multiple calls to 'initWasm()' detected.");if(tv)throw new Error("previous call to 'initWasm()' failed.");if(Gf=!0,Fc())return new Promise((s,e)=>{Gr?.terminate(),P4().then(([t,n])=>{try{Gr=n,Gr.onerror=r=>e(r),Gr.onmessage=s4,RD=[s,e];let i={type:"init-wasm",in:Un};!i.in.wasm.wasmPaths&&(t||LD)&&(i.in.wasm.wasmPaths={wasm:new URL("ort-wasm-simd-threaded.jsep.wasm",Ro.url).href}),Gr.postMessage(i),V0=t}catch(i){e(i)}},e)});try{await n1(Un.wasm),await b1(Un),ev=!0}catch(s){throw tv=!0,s}finally{Gf=!1}}},D5=async s=>{if(Fc())return Yu(),new Promise((e,t)=>{Ku("init-ep",[e,t]);let n={type:"init-ep",in:{epName:s,env:Un}};Gr.postMessage(n)});await w1(Un,s)},R5=async s=>Fc()?(Yu(),new Promise((e,t)=>{Ku("copy-from",[e,t]);let n={type:"copy-from",in:{buffer:s}};Gr.postMessage(n,[s.buffer])})):J0(s),F5=async(s,e)=>{if(Fc()){if(e?.preferredOutputLocation)throw new Error('session option "preferredOutputLocation" is not supported for proxy.');return Yu(),new Promise((t,n)=>{Ku("create",[t,n]);let i={type:"create",in:{model:s,options:{...e}}},r=[];s instanceof Uint8Array&&r.push(s.buffer),Gr.postMessage(i,r)})}else return M1(s,e)},L5=async s=>{if(Fc())return Yu(),new Promise((e,t)=>{Ku("release",[e,t]);let n={type:"release",in:s};Gr.postMessage(n)});T1(s)},N5=async(s,e,t,n,i,r)=>{if(Fc()){if(t.some(o=>o[3]!=="cpu"))throw new Error("input tensor on GPU is not supported for proxy.");if(i.some(o=>o))throw new Error("pre-allocated output tensor is not supported for proxy.");return Yu(),new Promise((o,a)=>{Ku("run",[o,a]);let l=t,c={type:"run",in:{sessionId:s,inputIndices:e,inputs:l,outputIndices:n,options:r}};Gr.postMessage(c,S1(l))})}else return E1(s,e,t,n,i,r)},O5=async s=>{if(Fc())return Yu(),new Promise((e,t)=>{Ku("end-profiling",[e,t]);let n={type:"end-profiling",in:s};Gr.postMessage(n)});x1(s)}}),FD,i4,B5,nse=Ze(()=>{"use strict";No(),$5(),$t(),e1(),R4(),FD=(s,e)=>{switch(s.location){case"cpu":return[s.type,s.dims,s.data,"cpu"];case"gpu-buffer":return[s.type,s.dims,{gpuBuffer:s.gpuBuffer},"gpu-buffer"];case"ml-tensor":return[s.type,s.dims,{mlTensor:s.mlTensor},"ml-tensor"];default:throw new Error(`invalid data location: ${s.location} for ${e()}`)}},i4=s=>{switch(s[3]){case"cpu":return new Fo(s[0],s[2],s[1]);case"gpu-buffer":{let e=s[0];if(!r1(e))throw new Error(`not supported data type: ${e} for deserializing GPU tensor`);let{gpuBuffer:t,download:n,dispose:i}=s[2];return Fo.fromGpuBuffer(t,{dataType:e,dims:s[1],download:n,dispose:i})}case"ml-tensor":{let e=s[0];if(!o1(e))throw new Error(`not supported data type: ${e} for deserializing MLTensor tensor`);let{mlTensor:t,download:n,dispose:i}=s[2];return Fo.fromMLTensor(t,{dataType:e,dims:s[1],download:n,dispose:i})}default:throw new Error(`invalid data location: ${s[3]}`)}},B5=class{async fetchModelAndCopyToWasmMemory(s){return R5(await a1(s))}async loadModel(s,e){Lo();let t;typeof s=="string"?t=await this.fetchModelAndCopyToWasmMemory(s):t=s,[this.sessionId,this.inputNames,this.outputNames,this.inputMetadata,this.outputMetadata]=await F5(t,e),Hr()}async dispose(){return L5(this.sessionId)}async run(s,e,t){Lo();let n=[],i=[];Object.entries(s).forEach(u=>{let h=u[0],p=u[1],f=this.inputNames.indexOf(h);if(f===-1)throw new Error(`invalid input '${h}'`);n.push(p),i.push(f)});let r=[],o=[];Object.entries(e).forEach(u=>{let h=u[0],p=u[1],f=this.outputNames.indexOf(h);if(f===-1)throw new Error(`invalid output '${h}'`);r.push(p),o.push(f)});let a=n.map((u,h)=>FD(u,()=>`input "${this.inputNames[i[h]]}"`)),l=r.map((u,h)=>u?FD(u,()=>`output "${this.outputNames[o[h]]}"`):null),c=await N5(this.sessionId,i,a,o,l,t),d={};for(let u=0;u<c.length;u++)d[this.outputNames[o[u]]]=r[u]??i4(c[u]);return Hr(),d}startProfiling(){}endProfiling(){O5(this.sessionId)}}}),z5={};Kf(z5,{OnnxruntimeWebAssemblyBackend:()=>XD,initializeFlags:()=>YD,wasmBackend:()=>U5});var YD,XD,U5,sse=Ze(()=>{"use strict";No(),$5(),nse(),YD=()=>{(typeof Un.wasm.initTimeout!="number"||Un.wasm.initTimeout<0)&&(Un.wasm.initTimeout=0);let s=Un.wasm.simd;if(typeof s!="boolean"&&s!==void 0&&s!=="fixed"&&s!=="relaxed"&&(console.warn(`Property "env.wasm.simd" is set to unknown value "${s}". Reset it to \`false\` and ignore SIMD feature checking.`),Un.wasm.simd=!1),typeof Un.wasm.proxy!="boolean"&&(Un.wasm.proxy=!1),typeof Un.wasm.trace!="boolean"&&(Un.wasm.trace=!1),typeof Un.wasm.numThreads!="number"||!Number.isInteger(Un.wasm.numThreads)||Un.wasm.numThreads<=0)if(typeof self<"u"&&!self.crossOriginIsolated)Un.wasm.numThreads=1;else{let e=typeof navigator>"u"?Gte("node:os").cpus().length:navigator.hardwareConcurrency;Un.wasm.numThreads=Math.min(4,Math.ceil((e||1)/2))}},XD=class{async init(s){YD(),await I5(),await D5(s)}async createInferenceSessionHandler(s,e){let t=new B5;return await t.loadModel(s,e),t}},U5=new XD});No();No();No();var ise="1.22.0-dev.20250409-89f8206ba4",rse=T4;{let s=(sse(),av(z5)).wasmBackend;Ju("webgpu",s,5),Ju("webnn",s,5),Ju("cpu",s,10),Ju("wasm",s,10)}Object.defineProperty(Un.versions,"web",{value:ise,enumerable:!0});var ase={};var ose={"onnxruntime-common":s=>{s.exports=LI},"onnxruntime-web":s=>{s.exports=C1},"?2ce3":()=>{},"?7992":()=>{},"?5af5":()=>{},"?2b25":()=>{},"?db59":()=>{},"?383f":()=>{},"?fa4b":()=>{},"./node_modules/@huggingface/jinja/dist/index.js":(s,e,t)=>{t.r(e),t.d(e,{Environment:()=>Pt,Interpreter:()=>un,Template:()=>zi,parse:()=>xe,tokenize:()=>u});var n=Object.freeze({Text:"Text",NumericLiteral:"NumericLiteral",StringLiteral:"StringLiteral",Identifier:"Identifier",Equals:"Equals",OpenParen:"OpenParen",CloseParen:"CloseParen",OpenStatement:"OpenStatement",CloseStatement:"CloseStatement",OpenExpression:"OpenExpression",CloseExpression:"CloseExpression",OpenSquareBracket:"OpenSquareBracket",CloseSquareBracket:"CloseSquareBracket",OpenCurlyBracket:"OpenCurlyBracket",CloseCurlyBracket:"CloseCurlyBracket",Comma:"Comma",Dot:"Dot",Colon:"Colon",Pipe:"Pipe",CallOperator:"CallOperator",AdditiveBinaryOperator:"AdditiveBinaryOperator",MultiplicativeBinaryOperator:"MultiplicativeBinaryOperator",ComparisonBinaryOperator:"ComparisonBinaryOperator",UnaryOperator:"UnaryOperator",Comment:"Comment"}),i=class{constructor(F,ie){this.value=F,this.type=ie}};function r(F){return/\w/.test(F)}function o(F){return/[0-9]/.test(F)}function a(F){return/\s/.test(F)}var l=[["{%",n.OpenStatement],["%}",n.CloseStatement],["{{",n.OpenExpression],["}}",n.CloseExpression],["(",n.OpenParen],[")",n.CloseParen],["{",n.OpenCurlyBracket],["}",n.CloseCurlyBracket],["[",n.OpenSquareBracket],["]",n.CloseSquareBracket],[",",n.Comma],[".",n.Dot],[":",n.Colon],["|",n.Pipe],["<=",n.ComparisonBinaryOperator],[">=",n.ComparisonBinaryOperator],["==",n.ComparisonBinaryOperator],["!=",n.ComparisonBinaryOperator],["<",n.ComparisonBinaryOperator],[">",n.ComparisonBinaryOperator],["+",n.AdditiveBinaryOperator],["-",n.AdditiveBinaryOperator],["~",n.AdditiveBinaryOperator],["*",n.MultiplicativeBinaryOperator],["/",n.MultiplicativeBinaryOperator],["%",n.MultiplicativeBinaryOperator],["=",n.Equals]],c=new Map([["n",`
`],["t","	"],["r","\r"],["b","\b"],["f","\f"],["v","\v"],["'","'"],['"','"'],["\\","\\"]]);function d(F,ie={}){return F.endsWith(`
`)&&(F=F.slice(0,-1)),ie.lstrip_blocks&&(F=F.replace(/^[ \t]*({[#%-])/gm,"$1")),ie.trim_blocks&&(F=F.replace(/([#%-]})\n/g,"$1")),F.replace(/{%\s*(end)?generation\s*%}/gs,"")}function u(F,ie={}){let q=[],ee=d(F,ie),ae=0,ye=0,Le=rt=>{let Lt="";for(;rt(ee[ae]);){if(ee[ae]==="\\"){if(++ae,ae>=ee.length)throw new SyntaxError("Unexpected end of input");let ut=ee[ae++],Nt=c.get(ut);if(Nt===void 0)throw new SyntaxError(`Unexpected escaped character: ${ut}`);Lt+=Nt;continue}if(Lt+=ee[ae++],ae>=ee.length)throw new SyntaxError("Unexpected end of input")}return Lt},ht=()=>{let rt=q.at(-1);rt&&rt.type===n.Text&&(rt.value=rt.value.trimEnd(),rt.value===""&&q.pop())},wt=()=>{for(;ae<ee.length&&a(ee[ae]);)++ae};e:for(;ae<ee.length;){let rt=q.at(-1)?.type;if(rt===void 0||rt===n.CloseStatement||rt===n.CloseExpression||rt===n.Comment){let ut="";for(;ae<ee.length&&!(ee[ae]==="{"&&(ee[ae+1]==="%"||ee[ae+1]==="{"||ee[ae+1]==="#"));)ut+=ee[ae++];if(ut.length>0){q.push(new i(ut,n.Text));continue}}if(ee[ae]==="{"&&ee[ae+1]==="#"){ae+=2;let ut=ee[ae]==="-";ut&&++ae;let Nt="";for(;ee[ae]!=="#"||ee[ae+1]!=="}";){if(ae+2>=ee.length)throw new SyntaxError("Missing end of comment tag");Nt+=ee[ae++]}let hn=Nt.endsWith("-");hn&&(Nt=Nt.slice(0,-1)),ut&&ht(),q.push(new i(Nt,n.Comment)),ae+=2,hn&&wt();continue}if(ee.slice(ae,ae+3)==="{%-"){ht(),q.push(new i("{%",n.OpenStatement)),ae+=3;continue}if(ee.slice(ae,ae+3)==="{{-"){ht(),q.push(new i("{{",n.OpenExpression)),ye=0,ae+=3;continue}if(Le(a),ee.slice(ae,ae+3)==="-%}"){q.push(new i("%}",n.CloseStatement)),ae+=3,wt();continue}if(ee.slice(ae,ae+3)==="-}}"){q.push(new i("}}",n.CloseExpression)),ae+=3,wt();continue}let Lt=ee[ae];if(Lt==="-"||Lt==="+"){let ut=q.at(-1)?.type;if(ut===n.Text||ut===void 0)throw new SyntaxError(`Unexpected character: ${Lt}`);switch(ut){case n.Identifier:case n.NumericLiteral:case n.StringLiteral:case n.CloseParen:case n.CloseSquareBracket:break;default:{++ae;let Nt=Le(o);q.push(new i(`${Lt}${Nt}`,Nt.length>0?n.NumericLiteral:n.UnaryOperator));continue}}}for(let[ut,Nt]of l){if(ut==="}}"&&ye>0)continue;if(ee.slice(ae,ae+ut.length)===ut){q.push(new i(ut,Nt)),Nt===n.OpenExpression?ye=0:Nt===n.OpenCurlyBracket?++ye:Nt===n.CloseCurlyBracket&&--ye,ae+=ut.length;continue e}}if(Lt==="'"||Lt==='"'){++ae;let ut=Le(Nt=>Nt!==Lt);q.push(new i(ut,n.StringLiteral)),++ae;continue}if(o(Lt)){let ut=Le(o);if(ee[ae]==="."&&o(ee[ae+1])){++ae;let Nt=Le(o);ut=`${ut}.${Nt}`}q.push(new i(ut,n.NumericLiteral));continue}if(r(Lt)){let ut=Le(r);q.push(new i(ut,n.Identifier));continue}throw new SyntaxError(`Unexpected character: ${Lt}`)}return q}var h=class{constructor(){Z(this,"type","Statement")}},p=class extends h{constructor(ie){super();Z(this,"type","Program");this.body=ie}},f=class extends h{constructor(ie,q,ee){super();Z(this,"type","If");this.test=ie,this.body=q,this.alternate=ee}},_=class extends h{constructor(ie,q,ee,ae){super();Z(this,"type","For");this.loopvar=ie,this.iterable=q,this.body=ee,this.defaultBlock=ae}},b=class extends h{constructor(){super(...arguments);Z(this,"type","Break")}},y=class extends h{constructor(){super(...arguments);Z(this,"type","Continue")}},w=class extends h{constructor(ie,q,ee){super();Z(this,"type","Set");this.assignee=ie,this.value=q,this.body=ee}},C=class extends h{constructor(ie,q,ee){super();Z(this,"type","Macro");this.name=ie,this.args=q,this.body=ee}},M=class extends h{constructor(ie){super();Z(this,"type","Comment");this.value=ie}},S=class extends h{constructor(){super(...arguments);Z(this,"type","Expression")}},k=class extends S{constructor(ie,q,ee){super();Z(this,"type","MemberExpression");this.object=ie,this.property=q,this.computed=ee}},T=class extends S{constructor(ie,q){super();Z(this,"type","CallExpression");this.callee=ie,this.args=q}},P=class extends S{constructor(ie){super();Z(this,"type","Identifier");this.value=ie}},R=class extends S{constructor(ie){super();Z(this,"type","Literal");this.value=ie}},O=class extends R{constructor(){super(...arguments);Z(this,"type","IntegerLiteral")}},H=class extends R{constructor(){super(...arguments);Z(this,"type","FloatLiteral")}},X=class extends R{constructor(){super(...arguments);Z(this,"type","StringLiteral")}},z=class extends R{constructor(){super(...arguments);Z(this,"type","ArrayLiteral")}},ne=class extends R{constructor(){super(...arguments);Z(this,"type","TupleLiteral")}},re=class extends R{constructor(){super(...arguments);Z(this,"type","ObjectLiteral")}},Y=class extends S{constructor(ie,q,ee){super();Z(this,"type","BinaryExpression");this.operator=ie,this.left=q,this.right=ee}},se=class extends S{constructor(ie,q){super();Z(this,"type","FilterExpression");this.operand=ie,this.filter=q}},ue=class extends h{constructor(ie,q){super();Z(this,"type","FilterStatement");this.filter=ie,this.body=q}},fe=class extends S{constructor(ie,q){super();Z(this,"type","SelectExpression");this.lhs=ie,this.test=q}},Pe=class extends S{constructor(ie,q,ee){super();Z(this,"type","TestExpression");this.operand=ie,this.negate=q,this.test=ee}},oe=class extends S{constructor(ie,q){super();Z(this,"type","UnaryExpression");this.operator=ie,this.argument=q}},te=class extends S{constructor(ie=void 0,q=void 0,ee=void 0){super();Z(this,"type","SliceExpression");this.start=ie,this.stop=q,this.step=ee}},j=class extends S{constructor(ie,q){super();Z(this,"type","KeywordArgumentExpression");this.key=ie,this.value=q}},G=class extends S{constructor(ie){super();Z(this,"type","SpreadExpression");this.argument=ie}},de=class extends h{constructor(ie,q,ee){super();Z(this,"type","CallStatement");this.call=ie,this.callerArgs=q,this.body=ee}},be=class extends S{constructor(ie,q,ee){super();Z(this,"type","Ternary");this.condition=ie,this.trueExpr=q,this.falseExpr=ee}};function xe(F){let ie=new p([]),q=0;function ee(Ke,tt){let _t=F[q++];if(!_t||_t.type!==Ke)throw new Error(`Parser Error: ${tt}. ${_t.type} !== ${Ke}.`);return _t}function ae(Ke){if(!wt(Ke))throw new SyntaxError(`Expected ${Ke}`);++q}function ye(){switch(F[q].type){case n.Comment:return new M(F[q++].value);case n.Text:return rt();case n.OpenStatement:return Lt();case n.OpenExpression:return ut();default:throw new SyntaxError(`Unexpected token type: ${F[q].type}`)}}function Le(...Ke){return q+Ke.length<=F.length&&Ke.every((tt,_t)=>tt===F[q+_t].type)}function ht(...Ke){return F[q]?.type===n.OpenStatement&&F[q+1]?.type===n.Identifier&&Ke.includes(F[q+1]?.value)}function wt(...Ke){return q+Ke.length<=F.length&&Ke.every((tt,_t)=>F[q+_t].type==="Identifier"&&tt===F[q+_t].value)}function rt(){return new X(ee(n.Text,"Expected text token").value)}function Lt(){if(ee(n.OpenStatement,"Expected opening statement token"),F[q].type!==n.Identifier)throw new SyntaxError(`Unknown statement, got ${F[q].type}`);let Ke=F[q].value,tt;switch(Ke){case"set":++q,tt=Nt();break;case"if":++q,tt=hn(),ee(n.OpenStatement,"Expected {% token"),ae("endif"),ee(n.CloseStatement,"Expected %} token");break;case"macro":++q,tt=Fn(),ee(n.OpenStatement,"Expected {% token"),ae("endmacro"),ee(n.CloseStatement,"Expected %} token");break;case"for":++q,tt=Hs(),ee(n.OpenStatement,"Expected {% token"),ae("endfor"),ee(n.CloseStatement,"Expected %} token");break;case"call":{++q;let _t=null;Le(n.OpenParen)&&(_t=Xn());let kn=mi();if(kn.type!=="Identifier")throw new SyntaxError("Expected identifier following call statement");let Fa=Xn();ee(n.CloseStatement,"Expected closing statement token");let jo=[];for(;!ht("endcall");)jo.push(ye());ee(n.OpenStatement,"Expected '{%'"),ae("endcall"),ee(n.CloseStatement,"Expected closing statement token");let La=new T(kn,Fa);tt=new de(La,_t,jo);break}case"break":++q,ee(n.CloseStatement,"Expected closing statement token"),tt=new b;break;case"continue":++q,ee(n.CloseStatement,"Expected closing statement token"),tt=new y;break;case"filter":{++q;let _t=mi();_t instanceof P&&Le(n.OpenParen)&&(_t=Ai(_t)),ee(n.CloseStatement,"Expected closing statement token");let kn=[];for(;!ht("endfilter");)kn.push(ye());ee(n.OpenStatement,"Expected '{%'"),ae("endfilter"),ee(n.CloseStatement,"Expected '%}'"),tt=new ue(_t,kn);break}default:throw new SyntaxError(`Unknown statement type: ${Ke}`)}return tt}function ut(){ee(n.OpenExpression,"Expected opening expression token");let Ke=Fs();return ee(n.CloseExpression,"Expected closing expression token"),Ke}function Nt(){let Ke=ns(),tt=null,_t=[];if(Le(n.Equals))++q,tt=ns();else{for(ee(n.CloseStatement,"Expected %} token");!ht("endset");)_t.push(ye());ee(n.OpenStatement,"Expected {% token"),ae("endset")}return ee(n.CloseStatement,"Expected closing statement token"),new w(Ke,tt,_t)}function hn(){let Ke=Fs();ee(n.CloseStatement,"Expected closing statement token");let tt=[],_t=[];for(;!ht("elif","else","endif");)tt.push(ye());if(ht("elif")){++q,++q;let kn=hn();_t.push(kn)}else if(ht("else"))for(++q,++q,ee(n.CloseStatement,"Expected closing statement token");!ht("endif");)_t.push(ye());return new f(Ke,tt,_t)}function Fn(){let Ke=mi();if(Ke.type!=="Identifier")throw new SyntaxError("Expected identifier following macro statement");let tt=Xn();ee(n.CloseStatement,"Expected closing statement token");let _t=[];for(;!ht("endmacro");)_t.push(ye());return new C(Ke,tt,_t)}function ns(Ke=!1){let tt=Ke?mi:Fs,_t=[tt()],kn=Le(n.Comma);for(;kn&&(++q,_t.push(tt()),!!Le(n.Comma)););return kn?new ne(_t):_t[0]}function Hs(){let Ke=ns(!0);if(!(Ke instanceof P||Ke instanceof ne))throw new SyntaxError(`Expected identifier/tuple for the loop variable, got ${Ke.type} instead`);if(!wt("in"))throw new SyntaxError("Expected `in` keyword following loop variable");++q;let tt=Fs();ee(n.CloseStatement,"Expected closing statement token");let _t=[];for(;!ht("endfor","else");)_t.push(ye());let kn=[];if(ht("else"))for(++q,++q,ee(n.CloseStatement,"Expected closing statement token");!ht("endfor");)kn.push(ye());return new _(Ke,tt,_t,kn)}function Fs(){return js()}function js(){let Ke=Qr();if(wt("if")){++q;let tt=Qr();if(wt("else")){++q;let _t=js();return new be(tt,Ke,_t)}else return new fe(Ke,tt)}return Ke}function Qr(){let Ke=Vo();for(;wt("or");){let tt=F[q];++q;let _t=Vo();Ke=new Y(tt,Ke,_t)}return Ke}function Vo(){let Ke=us();for(;wt("and");){let tt=F[q];++q;let _t=us();Ke=new Y(tt,Ke,_t)}return Ke}function us(){let Ke;for(;wt("not");){let tt=F[q];++q;let _t=us();Ke=new oe(tt,_t)}return Ke??Ra()}function Ra(){let Ke=Pr();for(;;){let tt;if(wt("not","in"))tt=new i("not in",n.Identifier),q+=2;else if(wt("in"))tt=F[q++];else if(Le(n.ComparisonBinaryOperator))tt=F[q++];else break;let _t=Pr();Ke=new Y(tt,Ke,_t)}return Ke}function Pr(){let Ke=Wo();for(;Le(n.AdditiveBinaryOperator);){let tt=F[q];++q;let _t=Wo();Ke=new Y(tt,Ke,_t)}return Ke}function si(){let Ke=Go(mi());return Le(n.OpenParen)?Ai(Ke):Ke}function Ai(Ke){let tt=new T(Ke,Xn());return tt=Go(tt),Le(n.OpenParen)&&(tt=Ai(tt)),tt}function Xn(){ee(n.OpenParen,"Expected opening parenthesis for arguments list");let Ke=ss();return ee(n.CloseParen,"Expected closing parenthesis for arguments list"),Ke}function ss(){let Ke=[];for(;!Le(n.CloseParen);){let tt;if(F[q].type===n.MultiplicativeBinaryOperator&&F[q].value==="*"){++q;let _t=Fs();tt=new G(_t)}else if(tt=Fs(),Le(n.Equals)){if(++q,!(tt instanceof P))throw new SyntaxError("Expected identifier for keyword argument");let _t=Fs();tt=new j(tt,_t)}Ke.push(tt),Le(n.Comma)&&++q}return Ke}function Jr(){let Ke=[],tt=!1;for(;!Le(n.CloseSquareBracket);)Le(n.Colon)?(Ke.push(void 0),++q,tt=!0):(Ke.push(Fs()),Le(n.Colon)&&(++q,tt=!0));if(Ke.length===0)throw new SyntaxError("Expected at least one argument for member/slice expression");if(tt){if(Ke.length>3)throw new SyntaxError("Expected 0-3 arguments for slice expression");return new te(...Ke)}return Ke[0]}function Go(Ke){for(;Le(n.Dot)||Le(n.OpenSquareBracket);){let tt=F[q];++q;let _t,kn=tt.type===n.OpenSquareBracket;if(kn)_t=Jr(),ee(n.CloseSquareBracket,"Expected closing square bracket");else if(_t=mi(),_t.type!=="Identifier")throw new SyntaxError("Expected identifier following dot operator");Ke=new k(Ke,_t,kn)}return Ke}function Wo(){let Ke=Ho();for(;Le(n.MultiplicativeBinaryOperator);){let tt=F[q++],_t=Ho();Ke=new Y(tt,Ke,_t)}return Ke}function Ho(){let Ke=kr();for(;wt("is");){++q;let tt=wt("not");tt&&++q;let _t=mi();if(!(_t instanceof P))throw new SyntaxError("Expected identifier for the test");Ke=new Pe(Ke,tt,_t)}return Ke}function kr(){let Ke=si();for(;Le(n.Pipe);){++q;let tt=mi();if(!(tt instanceof P))throw new SyntaxError("Expected identifier for the filter");Le(n.OpenParen)&&(tt=Ai(tt)),Ke=new se(Ke,tt)}return Ke}function mi(){let Ke=F[q++];switch(Ke.type){case n.NumericLiteral:{let tt=Ke.value;return tt.includes(".")?new H(Number(tt)):new O(Number(tt))}case n.StringLiteral:{let tt=Ke.value;for(;Le(n.StringLiteral);)tt+=F[q++].value;return new X(tt)}case n.Identifier:return new P(Ke.value);case n.OpenParen:{let tt=ns();return ee(n.CloseParen,"Expected closing parenthesis, got ${tokens[current].type} instead."),tt}case n.OpenSquareBracket:{let tt=[];for(;!Le(n.CloseSquareBracket);)tt.push(Fs()),Le(n.Comma)&&++q;return++q,new z(tt)}case n.OpenCurlyBracket:{let tt=new Map;for(;!Le(n.CloseCurlyBracket);){let _t=Fs();ee(n.Colon,"Expected colon between key and value in object literal");let kn=Fs();tt.set(_t,kn),Le(n.Comma)&&++q}return++q,new re(tt)}default:throw new SyntaxError(`Unexpected token: ${Ke.type}`)}}for(;q<F.length;)ie.body.push(ye());return ie}function Oe(F,ie,q=1){ie===void 0&&(ie=F,F=0);let ee=[];for(let ae=F;ae<ie;ae+=q)ee.push(ae);return ee}function je(F,ie,q,ee=1){let ae=Math.sign(ee);ae>=0?(ie=(ie??(ie=0))<0?Math.max(F.length+ie,0):Math.min(ie,F.length),q=(q??(q=F.length))<0?Math.max(F.length+q,0):Math.min(q,F.length)):(ie=(ie??(ie=F.length-1))<0?Math.max(F.length+ie,-1):Math.min(ie,F.length-1),q=(q??(q=-1))<-1?Math.max(F.length+q,-1):Math.min(q,F.length-1));let ye=[];for(let Le=ie;ae*Le<ae*q;Le+=ee)ye.push(F[Le]);return ye}function dt(F){return F.replace(/\b\w/g,ie=>ie.toUpperCase())}function Re(F){return U(new Date,F)}function U(F,ie){let q=new Intl.DateTimeFormat(void 0,{month:"long"}),ee=new Intl.DateTimeFormat(void 0,{month:"short"}),ae=ye=>ye<10?"0"+ye:ye.toString();return ie.replace(/%[YmdbBHM%]/g,ye=>{switch(ye){case"%Y":return F.getFullYear().toString();case"%m":return ae(F.getMonth()+1);case"%d":return ae(F.getDate());case"%b":return ee.format(F);case"%B":return q.format(F);case"%H":return ae(F.getHours());case"%M":return ae(F.getMinutes());case"%%":return"%";default:return ye}})}function pe(F){return F.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Ce(F,ie,q,ee){if(ee===0)return F;let ae=ee==null||ee<0?1/0:ee,ye=ie.length===0?new RegExp("(?=)","gu"):new RegExp(pe(ie),"gu");return F.replaceAll(ye,Le=>ae>0?(--ae,q):Le)}var Fe=class extends Error{},Ve=class extends Error{},De=class{constructor(F=void 0){Z(this,"type","RuntimeValue");Z(this,"value");Z(this,"builtins",new Map);this.value=F}__bool__(){return new $e(!!this.value)}toString(){return String(this.value)}},Ee=class extends De{constructor(){super(...arguments);Z(this,"type","IntegerValue")}},ze=class extends De{constructor(){super(...arguments);Z(this,"type","FloatValue")}toString(){return this.value%1===0?this.value.toFixed(1):this.value.toString()}},Se=class extends De{constructor(){super(...arguments);Z(this,"type","StringValue");Z(this,"builtins",new Map([["upper",new We(()=>new Se(this.value.toUpperCase()))],["lower",new We(()=>new Se(this.value.toLowerCase()))],["strip",new We(()=>new Se(this.value.trim()))],["title",new We(()=>new Se(dt(this.value)))],["capitalize",new We(()=>new Se(this.value.charAt(0).toUpperCase()+this.value.slice(1)))],["length",new Ee(this.value.length)],["rstrip",new We(()=>new Se(this.value.trimEnd()))],["lstrip",new We(()=>new Se(this.value.trimStart()))],["startswith",new We(ie=>{if(ie.length===0)throw new Error("startswith() requires at least one argument");let q=ie[0];if(q instanceof Se)return new $e(this.value.startsWith(q.value));if(q instanceof Xe){for(let ee of q.value){if(!(ee instanceof Se))throw new Error("startswith() tuple elements must be strings");if(this.value.startsWith(ee.value))return new $e(!0)}return new $e(!1)}throw new Error("startswith() argument must be a string or tuple of strings")})],["endswith",new We(ie=>{if(ie.length===0)throw new Error("endswith() requires at least one argument");let q=ie[0];if(q instanceof Se)return new $e(this.value.endsWith(q.value));if(q instanceof Xe){for(let ee of q.value){if(!(ee instanceof Se))throw new Error("endswith() tuple elements must be strings");if(this.value.endsWith(ee.value))return new $e(!0)}return new $e(!1)}throw new Error("endswith() argument must be a string or tuple of strings")})],["split",new We(ie=>{let q=ie[0]??new at;if(!(q instanceof Se||q instanceof at))throw new Error("sep argument must be a string or null");let ee=ie[1]??new Ee(-1);if(!(ee instanceof Ee))throw new Error("maxsplit argument must be a number");let ae=[];if(q instanceof at){let ye=this.value.trimStart();for(let{0:Le,index:ht}of ye.matchAll(/\S+/g)){if(ee.value!==-1&&ae.length>=ee.value&&ht!==void 0){ae.push(Le+ye.slice(ht+Le.length));break}ae.push(Le)}}else{if(q.value==="")throw new Error("empty separator");ae=this.value.split(q.value),ee.value!==-1&&ae.length>ee.value&&ae.push(ae.splice(ee.value).join(q.value))}return new Xe(ae.map(ye=>new Se(ye)))})],["replace",new We(ie=>{if(ie.length<2)throw new Error("replace() requires at least two arguments");let q=ie[0],ee=ie[1];if(!(q instanceof Se&&ee instanceof Se))throw new Error("replace() arguments must be strings");let ae;if(ie.length>2?ie[2].type==="KeywordArgumentsValue"?ae=ie[2].value.get("count")??new at:ae=ie[2]:ae=new at,!(ae instanceof Ee||ae instanceof at))throw new Error("replace() count argument must be a number or null");return new Se(Ce(this.value,q.value,ee.value,ae.value))})]]))}},$e=class extends De{constructor(){super(...arguments);Z(this,"type","BooleanValue")}};function et(F,ie,q,ee=!0){let ae=q??0;switch(F.type){case"NullValue":return"null";case"UndefinedValue":return ee?"null":"undefined";case"IntegerValue":case"FloatValue":case"StringValue":case"BooleanValue":return JSON.stringify(F.value);case"ArrayValue":case"ObjectValue":{let ye=ie?" ".repeat(ie):"",Le=`
`+ye.repeat(ae),ht=Le+ye;if(F.type==="ArrayValue"){let wt=F.value.map(rt=>et(rt,ie,ae+1,ee));return ie?`[${ht}${wt.join(`,${ht}`)}${Le}]`:`[${wt.join(", ")}]`}else{let wt=Array.from(F.value.entries()).map(([rt,Lt])=>{let ut=`"${rt}": ${et(Lt,ie,ae+1,ee)}`;return ie?`${ht}${ut}`:ut});return ie?`{${wt.join(",")}${Le}}`:`{${wt.join(", ")}}`}}default:throw new Error(`Cannot convert to JSON: ${F.type}`)}}var Ge=class extends De{constructor(){super(...arguments);Z(this,"type","ObjectValue");Z(this,"builtins",new Map([["get",new We(([ie,q])=>{if(!(ie instanceof Se))throw new Error(`Object key must be a string: got ${ie.type}`);return this.value.get(ie.value)??q??new at})],["items",new We(()=>this.items())],["keys",new We(()=>this.keys())],["values",new We(()=>this.values())],["dictsort",new We(ie=>{let q=new Map,ee=ie.filter(wt=>wt instanceof Ye?(q=wt.value,!1):!0),ae=ee.at(0)??q.get("case_sensitive")??new $e(!1);if(!(ae instanceof $e))throw new Error("case_sensitive must be a boolean");let ye=ee.at(1)??q.get("by")??new Se("key");if(!(ye instanceof Se))throw new Error("by must be a string");if(!["key","value"].includes(ye.value))throw new Error("by must be either 'key' or 'value'");let Le=ee.at(2)??q.get("reverse")??new $e(!1);if(!(Le instanceof $e))throw new Error("reverse must be a boolean");let ht=Array.from(this.value.entries()).map(([wt,rt])=>new Xe([new Se(wt),rt])).sort((wt,rt)=>{let Lt=ye.value==="key"?0:1,ut=wt.value[Lt],Nt=rt.value[Lt],hn=rn(ut,Nt,ae.value);return Le.value?-hn:hn});return new Xe(ht)})]]))}__bool__(){return new $e(this.value.size>0)}items(){return new Xe(Array.from(this.value.entries()).map(([ie,q])=>new Xe([new Se(ie),q])))}keys(){return new Xe(Array.from(this.value.keys()).map(ie=>new Se(ie)))}values(){return new Xe(Array.from(this.value.values()))}toString(){return et(this,null,0,!1)}},Ye=class extends Ge{constructor(){super(...arguments);Z(this,"type","KeywordArgumentsValue")}},Xe=class extends De{constructor(){super(...arguments);Z(this,"type","ArrayValue");Z(this,"builtins",new Map([["length",new Ee(this.value.length)]]))}__bool__(){return new $e(this.value.length>0)}toString(){return et(this,null,0,!1)}},gt=class extends Xe{constructor(){super(...arguments);Z(this,"type","TupleValue")}},We=class extends De{constructor(){super(...arguments);Z(this,"type","FunctionValue")}},at=class extends De{constructor(){super(...arguments);Z(this,"type","NullValue")}},Qe=class extends De{constructor(){super(...arguments);Z(this,"type","UndefinedValue")}},Pt=class{constructor(F){Z(this,"variables",new Map([["namespace",new We(F=>{if(F.length===0)return new Ge(new Map);if(F.length!==1||!(F[0]instanceof Ge))throw new Error("`namespace` expects either zero arguments or a single object argument");return F[0]})]]));Z(this,"tests",new Map([["boolean",F=>F.type==="BooleanValue"],["callable",F=>F instanceof We],["odd",F=>{if(!(F instanceof Ee))throw new Error(`cannot odd on ${F.type}`);return F.value%2!==0}],["even",F=>{if(!(F instanceof Ee))throw new Error(`cannot even on ${F.type}`);return F.value%2===0}],["false",F=>F.type==="BooleanValue"&&!F.value],["true",F=>F.type==="BooleanValue"&&F.value],["none",F=>F.type==="NullValue"],["string",F=>F.type==="StringValue"],["number",F=>F instanceof Ee||F instanceof ze],["integer",F=>F instanceof Ee],["iterable",F=>F.type==="ArrayValue"||F.type==="StringValue"],["mapping",F=>F.type==="ObjectValue"],["lower",F=>{let ie=F.value;return F.type==="StringValue"&&ie===ie.toLowerCase()}],["upper",F=>{let ie=F.value;return F.type==="StringValue"&&ie===ie.toUpperCase()}],["none",F=>F.type==="NullValue"],["defined",F=>F.type!=="UndefinedValue"],["undefined",F=>F.type==="UndefinedValue"],["equalto",(F,ie)=>F.value===ie.value],["eq",(F,ie)=>F.value===ie.value]]));this.parent=F}set(F,ie){return this.declareVariable(F,ds(ie))}declareVariable(F,ie){if(this.variables.has(F))throw new SyntaxError(`Variable already declared: ${F}`);return this.variables.set(F,ie),ie}setVariable(F,ie){return this.variables.set(F,ie),ie}resolve(F){if(this.variables.has(F))return this;if(this.parent)return this.parent.resolve(F);throw new Error(`Unknown variable: ${F}`)}lookupVariable(F){try{return this.resolve(F).variables.get(F)??new Qe}catch{return new Qe}}};function st(F){F.set("false",!1),F.set("true",!0),F.set("none",null),F.set("raise_exception",ie=>{throw new Error(ie)}),F.set("range",Oe),F.set("strftime_now",Re),F.set("True",!0),F.set("False",!1),F.set("None",null)}function zt(F,ie){let q=ie.split("."),ee=F;for(let ae of q)if(ee instanceof Ge)ee=ee.value.get(ae)??new Qe;else if(ee instanceof Xe){let ye=parseInt(ae,10);if(!isNaN(ye)&&ye>=0&&ye<ee.value.length)ee=ee.value[ye];else return new Qe}else return new Qe;return ee}function rn(F,ie,q=!1){if(F instanceof at&&ie instanceof at)return 0;if(F instanceof at||ie instanceof at)throw new Error(`Cannot compare ${F.type} with ${ie.type}`);if(F instanceof Qe&&ie instanceof Qe)return 0;if(F instanceof Qe||ie instanceof Qe)throw new Error(`Cannot compare ${F.type} with ${ie.type}`);let ee=ye=>ye instanceof Ee||ye instanceof ze||ye instanceof $e,ae=ye=>ye instanceof $e?ye.value?1:0:ye.value;if(ee(F)&&ee(ie)){let ye=ae(F),Le=ae(ie);return ye<Le?-1:ye>Le?1:0}if(F.type!==ie.type)throw new Error(`Cannot compare different types: ${F.type} and ${ie.type}`);switch(F.type){case"StringValue":{let ye=F.value,Le=ie.value;return q||(ye=ye.toLowerCase(),Le=Le.toLowerCase()),ye<Le?-1:ye>Le?1:0}default:throw new Error(`Cannot compare type: ${F.type}`)}}var un=class{constructor(F){Z(this,"global");this.global=F??new Pt}run(F){return this.evaluate(F,this.global)}evaluateBinaryExpression(F,ie){let q=this.evaluate(F.left,ie);switch(F.operator.value){case"and":return q.__bool__().value?this.evaluate(F.right,ie):q;case"or":return q.__bool__().value?q:this.evaluate(F.right,ie)}let ee=this.evaluate(F.right,ie);switch(F.operator.value){case"==":return new $e(q.value==ee.value);case"!=":return new $e(q.value!=ee.value)}if(q instanceof Qe||ee instanceof Qe){if(ee instanceof Qe&&["in","not in"].includes(F.operator.value))return new $e(F.operator.value==="not in");throw new Error(`Cannot perform operation ${F.operator.value} on undefined values`)}else{if(q instanceof at||ee instanceof at)throw new Error("Cannot perform operation on null values");if(F.operator.value==="~")return new Se(q.value.toString()+ee.value.toString());if((q instanceof Ee||q instanceof ze)&&(ee instanceof Ee||ee instanceof ze)){let ae=q.value,ye=ee.value;switch(F.operator.value){case"+":case"-":case"*":{let Le=F.operator.value==="+"?ae+ye:F.operator.value==="-"?ae-ye:ae*ye;return q instanceof ze||ee instanceof ze?new ze(Le):new Ee(Le)}case"/":return new ze(ae/ye);case"%":{let Le=ae%ye;return q instanceof ze||ee instanceof ze?new ze(Le):new Ee(Le)}case"<":return new $e(ae<ye);case">":return new $e(ae>ye);case">=":return new $e(ae>=ye);case"<=":return new $e(ae<=ye)}}else if(q instanceof Xe&&ee instanceof Xe)switch(F.operator.value){case"+":return new Xe(q.value.concat(ee.value))}else if(ee instanceof Xe){let ae=ee.value.find(ye=>ye.value===q.value)!==void 0;switch(F.operator.value){case"in":return new $e(ae);case"not in":return new $e(!ae)}}}if(q instanceof Se||ee instanceof Se)switch(F.operator.value){case"+":return new Se(q.value.toString()+ee.value.toString())}if(q instanceof Se&&ee instanceof Se)switch(F.operator.value){case"in":return new $e(ee.value.includes(q.value));case"not in":return new $e(!ee.value.includes(q.value))}if(q instanceof Se&&ee instanceof Ge)switch(F.operator.value){case"in":return new $e(ee.value.has(q.value));case"not in":return new $e(!ee.value.has(q.value))}throw new SyntaxError(`Unknown operator "${F.operator.value}" between ${q.type} and ${ee.type}`)}evaluateArguments(F,ie){let q=[],ee=new Map;for(let ae of F)if(ae.type==="SpreadExpression"){let ye=ae,Le=this.evaluate(ye.argument,ie);if(!(Le instanceof Xe))throw new Error(`Cannot unpack non-iterable type: ${Le.type}`);for(let ht of Le.value)q.push(ht)}else if(ae.type==="KeywordArgumentExpression"){let ye=ae;ee.set(ye.key.value,this.evaluate(ye.value,ie))}else{if(ee.size>0)throw new Error("Positional arguments must come before keyword arguments");q.push(this.evaluate(ae,ie))}return[q,ee]}applyFilter(F,ie,q){if(ie.type==="Identifier"){let ee=ie;if(ee.value==="tojson")return new Se(et(F));if(F instanceof Xe)switch(ee.value){case"list":return F;case"first":return F.value[0];case"last":return F.value[F.value.length-1];case"length":return new Ee(F.value.length);case"reverse":return new Xe(F.value.slice().reverse());case"sort":return new Xe(F.value.slice().sort((ae,ye)=>rn(ae,ye,!1)));case"join":return new Se(F.value.map(ae=>ae.value).join(""));case"string":return new Se(et(F,null,0,!1));case"unique":{let ae=new Set,ye=[];for(let Le of F.value)ae.has(Le.value)||(ae.add(Le.value),ye.push(Le));return new Xe(ye)}default:throw new Error(`Unknown ArrayValue filter: ${ee.value}`)}else if(F instanceof Se)switch(ee.value){case"length":case"upper":case"lower":case"title":case"capitalize":{let ae=F.builtins.get(ee.value);if(ae instanceof We)return ae.value([],q);if(ae instanceof Ee)return ae;throw new Error(`Unknown StringValue filter: ${ee.value}`)}case"trim":return new Se(F.value.trim());case"indent":return new Se(F.value.split(`
`).map((ae,ye)=>ye===0||ae.length===0?ae:"    "+ae).join(`
`));case"join":case"string":return F;case"int":{let ae=parseInt(F.value,10);return new Ee(isNaN(ae)?0:ae)}case"float":{let ae=parseFloat(F.value);return new ze(isNaN(ae)?0:ae)}default:throw new Error(`Unknown StringValue filter: ${ee.value}`)}else if(F instanceof Ee||F instanceof ze)switch(ee.value){case"abs":return F instanceof Ee?new Ee(Math.abs(F.value)):new ze(Math.abs(F.value));case"int":return new Ee(Math.floor(F.value));case"float":return new ze(F.value);default:throw new Error(`Unknown NumericValue filter: ${ee.value}`)}else if(F instanceof Ge)switch(ee.value){case"items":return new Xe(Array.from(F.value.entries()).map(([ae,ye])=>new Xe([new Se(ae),ye])));case"length":return new Ee(F.value.size);default:{let ae=F.builtins.get(ee.value);if(ae)return ae instanceof We?ae.value([],q):ae;throw new Error(`Unknown ObjectValue filter: ${ee.value}`)}}else if(F instanceof $e)switch(ee.value){case"bool":return new $e(F.value);case"int":return new Ee(F.value?1:0);case"float":return new ze(F.value?1:0);case"string":return new Se(F.value?"true":"false");default:throw new Error(`Unknown BooleanValue filter: ${ee.value}`)}throw new Error(`Cannot apply filter "${ee.value}" to type: ${F.type}`)}else if(ie.type==="CallExpression"){let ee=ie;if(ee.callee.type!=="Identifier")throw new Error(`Unknown filter: ${ee.callee.type}`);let ae=ee.callee.value;if(ae==="tojson"){let[,ye]=this.evaluateArguments(ee.args,q),Le=ye.get("indent")??new at;if(!(Le instanceof Ee||Le instanceof at))throw new Error("If set, indent must be a number");return new Se(et(F,Le.value))}else if(ae==="join"){let ye;if(F instanceof Se)ye=Array.from(F.value);else if(F instanceof Xe)ye=F.value.map(rt=>rt.value);else throw new Error(`Cannot apply filter "${ae}" to type: ${F.type}`);let[Le,ht]=this.evaluateArguments(ee.args,q),wt=Le.at(0)??ht.get("separator")??new Se("");if(!(wt instanceof Se))throw new Error("separator must be a string");return new Se(ye.join(wt.value))}else if(ae==="int"||ae==="float"){let[ye,Le]=this.evaluateArguments(ee.args,q),ht=ye.at(0)??Le.get("default")??(ae==="int"?new Ee(0):new ze(0));if(F instanceof Se){let wt=ae==="int"?parseInt(F.value,10):parseFloat(F.value);return isNaN(wt)?ht:ae==="int"?new Ee(wt):new ze(wt)}else{if(F instanceof Ee||F instanceof ze)return F;if(F instanceof $e)return ae==="int"?new Ee(F.value?1:0):new ze(F.value?1:0);throw new Error(`Cannot apply filter "${ae}" to type: ${F.type}`)}}else if(ae==="default"){let[ye,Le]=this.evaluateArguments(ee.args,q),ht=ye[0]??new Se(""),wt=ye[1]??Le.get("boolean")??new $e(!1);if(!(wt instanceof $e))throw new Error("`default` filter flag must be a boolean");return F instanceof Qe||wt.value&&!F.__bool__().value?ht:F}if(F instanceof Xe){switch(ae){case"sort":{let[ye,Le]=this.evaluateArguments(ee.args,q),ht=ye.at(0)??Le.get("reverse")??new $e(!1);if(!(ht instanceof $e))throw new Error("reverse must be a boolean");let wt=ye.at(1)??Le.get("case_sensitive")??new $e(!1);if(!(wt instanceof $e))throw new Error("case_sensitive must be a boolean");let rt=ye.at(2)??Le.get("attribute")??new at;if(!(rt instanceof Se||rt instanceof Ee||rt instanceof at))throw new Error("attribute must be a string, integer, or null");let Lt=ut=>{if(rt instanceof at)return ut;let Nt=rt instanceof Ee?String(rt.value):rt.value;return zt(ut,Nt)};return new Xe(F.value.slice().sort((ut,Nt)=>{let hn=Lt(ut),Fn=Lt(Nt),ns=rn(hn,Fn,wt.value);return ht.value?-ns:ns}))}case"selectattr":case"rejectattr":{let ye=ae==="selectattr";if(F.value.some(ut=>!(ut instanceof Ge)))throw new Error(`\`${ae}\` can only be applied to array of objects`);if(ee.args.some(ut=>ut.type!=="StringLiteral"))throw new Error(`arguments of \`${ae}\` must be strings`);let[Le,ht,wt]=ee.args.map(ut=>this.evaluate(ut,q)),rt;if(ht){let ut=q.tests.get(ht.value);if(!ut)throw new Error(`Unknown test: ${ht.value}`);rt=ut}else rt=(...ut)=>ut[0].__bool__().value;let Lt=F.value.filter(ut=>{let Nt=ut.value.get(Le.value),hn=Nt?rt(Nt,wt):!1;return ye?hn:!hn});return new Xe(Lt)}case"map":{let[,ye]=this.evaluateArguments(ee.args,q);if(ye.has("attribute")){let Le=ye.get("attribute");if(!(Le instanceof Se))throw new Error("attribute must be a string");let ht=ye.get("default"),wt=F.value.map(rt=>{if(!(rt instanceof Ge))throw new Error("items in map must be an object");let Lt=zt(rt,Le.value);return Lt instanceof Qe?ht??new Qe:Lt});return new Xe(wt)}else throw new Error("`map` expressions without `attribute` set are not currently supported.")}}throw new Error(`Unknown ArrayValue filter: ${ae}`)}else if(F instanceof Se){switch(ae){case"indent":{let[ye,Le]=this.evaluateArguments(ee.args,q),ht=ye.at(0)??Le.get("width")??new Ee(4);if(!(ht instanceof Ee))throw new Error("width must be a number");let wt=ye.at(1)??Le.get("first")??new $e(!1),rt=ye.at(2)??Le.get("blank")??new $e(!1),Lt=F.value.split(`
`),ut=" ".repeat(ht.value),Nt=Lt.map((hn,Fn)=>!wt.value&&Fn===0||!rt.value&&hn.length===0?hn:ut+hn);return new Se(Nt.join(`
`))}case"replace":{let ye=F.builtins.get("replace");if(!(ye instanceof We))throw new Error("replace filter not available");let[Le,ht]=this.evaluateArguments(ee.args,q);return ye.value([...Le,new Ye(ht)],q)}}throw new Error(`Unknown StringValue filter: ${ae}`)}else if(F instanceof Ge){let ye=F.builtins.get(ae);if(ye&&ye instanceof We){let[Le,ht]=this.evaluateArguments(ee.args,q);return ht.size>0&&Le.push(new Ye(ht)),ye.value(Le,q)}throw new Error(`Unknown ObjectValue filter: ${ae}`)}else throw new Error(`Cannot apply filter "${ae}" to type: ${F.type}`)}throw new Error(`Unknown filter: ${ie.type}`)}evaluateFilterExpression(F,ie){let q=this.evaluate(F.operand,ie);return this.applyFilter(q,F.filter,ie)}evaluateTestExpression(F,ie){let q=this.evaluate(F.operand,ie),ee=ie.tests.get(F.test.value);if(!ee)throw new Error(`Unknown test: ${F.test.value}`);let ae=ee(q);return new $e(F.negate?!ae:ae)}evaluateSelectExpression(F,ie){return this.evaluate(F.test,ie).__bool__().value?this.evaluate(F.lhs,ie):new Qe}evaluateUnaryExpression(F,ie){let q=this.evaluate(F.argument,ie);switch(F.operator.value){case"not":return new $e(!q.value);default:throw new SyntaxError(`Unknown operator: ${F.operator.value}`)}}evaluateTernaryExpression(F,ie){return this.evaluate(F.condition,ie).__bool__().value?this.evaluate(F.trueExpr,ie):this.evaluate(F.falseExpr,ie)}evalProgram(F,ie){return this.evaluateBlock(F.body,ie)}evaluateBlock(F,ie){let q="";for(let ee of F){let ae=this.evaluate(ee,ie);ae.type!=="NullValue"&&ae.type!=="UndefinedValue"&&(q+=ae.toString())}return new Se(q)}evaluateIdentifier(F,ie){return ie.lookupVariable(F.value)}evaluateCallExpression(F,ie){let[q,ee]=this.evaluateArguments(F.args,ie);ee.size>0&&q.push(new Ye(ee));let ae=this.evaluate(F.callee,ie);if(ae.type!=="FunctionValue")throw new Error(`Cannot call something that is not a function: got ${ae.type}`);return ae.value(q,ie)}evaluateSliceExpression(F,ie,q){if(!(F instanceof Xe||F instanceof Se))throw new Error("Slice object must be an array or string");let ee=this.evaluate(ie.start,q),ae=this.evaluate(ie.stop,q),ye=this.evaluate(ie.step,q);if(!(ee instanceof Ee||ee instanceof Qe))throw new Error("Slice start must be numeric or undefined");if(!(ae instanceof Ee||ae instanceof Qe))throw new Error("Slice stop must be numeric or undefined");if(!(ye instanceof Ee||ye instanceof Qe))throw new Error("Slice step must be numeric or undefined");return F instanceof Xe?new Xe(je(F.value,ee.value,ae.value,ye.value)):new Se(je(Array.from(F.value),ee.value,ae.value,ye.value).join(""))}evaluateMemberExpression(F,ie){let q=this.evaluate(F.object,ie),ee;if(F.computed){if(F.property.type==="SliceExpression")return this.evaluateSliceExpression(q,F.property,ie);ee=this.evaluate(F.property,ie)}else ee=new Se(F.property.value);let ae;if(q instanceof Ge){if(!(ee instanceof Se))throw new Error(`Cannot access property with non-string: got ${ee.type}`);ae=q.value.get(ee.value)??q.builtins.get(ee.value)}else if(q instanceof Xe||q instanceof Se)if(ee instanceof Ee)ae=q.value.at(ee.value),q instanceof Se&&(ae=new Se(q.value.at(ee.value)));else if(ee instanceof Se)ae=q.builtins.get(ee.value);else throw new Error(`Cannot access property with non-string/non-number: got ${ee.type}`);else{if(!(ee instanceof Se))throw new Error(`Cannot access property with non-string: got ${ee.type}`);ae=q.builtins.get(ee.value)}return ae instanceof De?ae:new Qe}evaluateSet(F,ie){let q=F.value?this.evaluate(F.value,ie):this.evaluateBlock(F.body,ie);if(F.assignee.type==="Identifier"){let ee=F.assignee.value;ie.setVariable(ee,q)}else if(F.assignee.type==="TupleLiteral"){let ee=F.assignee;if(!(q instanceof Xe))throw new Error(`Cannot unpack non-iterable type in set: ${q.type}`);let ae=q.value;if(ae.length!==ee.value.length)throw new Error(`Too ${ee.value.length>ae.length?"few":"many"} items to unpack in set`);for(let ye=0;ye<ee.value.length;++ye){let Le=ee.value[ye];if(Le.type!=="Identifier")throw new Error(`Cannot unpack to non-identifier in set: ${Le.type}`);ie.setVariable(Le.value,ae[ye])}}else if(F.assignee.type==="MemberExpression"){let ee=F.assignee,ae=this.evaluate(ee.object,ie);if(!(ae instanceof Ge))throw new Error("Cannot assign to member of non-object");if(ee.property.type!=="Identifier")throw new Error("Cannot assign to member with non-identifier property");ae.value.set(ee.property.value,q)}else throw new Error(`Invalid LHS inside assignment expression: ${JSON.stringify(F.assignee)}`);return new at}evaluateIf(F,ie){let q=this.evaluate(F.test,ie);return this.evaluateBlock(q.__bool__().value?F.body:F.alternate,ie)}evaluateFor(F,ie){let q=new Pt(ie),ee,ae;if(F.iterable.type==="SelectExpression"){let rt=F.iterable;ae=this.evaluate(rt.lhs,q),ee=rt.test}else ae=this.evaluate(F.iterable,q);if(!(ae instanceof Xe||ae instanceof Ge))throw new Error(`Expected iterable or object type in for loop: got ${ae.type}`);ae instanceof Ge&&(ae=ae.keys());let ye=[],Le=[];for(let rt=0;rt<ae.value.length;++rt){let Lt=new Pt(q),ut=ae.value[rt],Nt;if(F.loopvar.type==="Identifier")Nt=hn=>hn.setVariable(F.loopvar.value,ut);else if(F.loopvar.type==="TupleLiteral"){let hn=F.loopvar;if(ut.type!=="ArrayValue")throw new Error(`Cannot unpack non-iterable type: ${ut.type}`);let Fn=ut;if(hn.value.length!==Fn.value.length)throw new Error(`Too ${hn.value.length>Fn.value.length?"few":"many"} items to unpack`);Nt=ns=>{for(let Hs=0;Hs<hn.value.length;++Hs){if(hn.value[Hs].type!=="Identifier")throw new Error(`Cannot unpack non-identifier type: ${hn.value[Hs].type}`);ns.setVariable(hn.value[Hs].value,Fn.value[Hs])}}}else throw new Error(`Invalid loop variable(s): ${F.loopvar.type}`);ee&&(Nt(Lt),!this.evaluate(ee,Lt).__bool__().value)||(ye.push(ut),Le.push(Nt))}let ht="",wt=!0;for(let rt=0;rt<ye.length;++rt){let Lt=new Map([["index",new Ee(rt+1)],["index0",new Ee(rt)],["revindex",new Ee(ye.length-rt)],["revindex0",new Ee(ye.length-rt-1)],["first",new $e(rt===0)],["last",new $e(rt===ye.length-1)],["length",new Ee(ye.length)],["previtem",rt>0?ye[rt-1]:new Qe],["nextitem",rt<ye.length-1?ye[rt+1]:new Qe]]);q.setVariable("loop",new Ge(Lt)),Le[rt](q);try{let ut=this.evaluateBlock(F.body,q);ht+=ut.value}catch(ut){if(ut instanceof Ve)continue;if(ut instanceof Fe)break;throw ut}wt=!1}if(wt){let rt=this.evaluateBlock(F.defaultBlock,q);ht+=rt.value}return new Se(ht)}evaluateMacro(F,ie){return ie.setVariable(F.name.value,new We((q,ee)=>{let ae=new Pt(ee);q=q.slice();let ye;q.at(-1)?.type==="KeywordArgumentsValue"&&(ye=q.pop());for(let Le=0;Le<F.args.length;++Le){let ht=F.args[Le],wt=q[Le];if(ht.type==="Identifier"){let rt=ht;if(!wt)throw new Error(`Missing positional argument: ${rt.value}`);ae.setVariable(rt.value,wt)}else if(ht.type==="KeywordArgumentExpression"){let rt=ht,Lt=wt??ye?.value.get(rt.key.value)??this.evaluate(rt.value,ae);ae.setVariable(rt.key.value,Lt)}else throw new Error(`Unknown argument type: ${ht.type}`)}return this.evaluateBlock(F.body,ae)})),new at}evaluateCallStatement(F,ie){let q=new We((ht,wt)=>{let rt=new Pt(wt);if(F.callerArgs)for(let Lt=0;Lt<F.callerArgs.length;++Lt){let ut=F.callerArgs[Lt];if(ut.type!=="Identifier")throw new Error(`Caller parameter must be an identifier, got ${ut.type}`);rt.setVariable(ut.value,ht[Lt]??new Qe)}return this.evaluateBlock(F.body,rt)}),[ee,ae]=this.evaluateArguments(F.call.args,ie);ee.push(new Ye(ae));let ye=this.evaluate(F.call.callee,ie);if(ye.type!=="FunctionValue")throw new Error(`Cannot call something that is not a function: got ${ye.type}`);let Le=new Pt(ie);return Le.setVariable("caller",q),ye.value(ee,Le)}evaluateFilterStatement(F,ie){let q=this.evaluateBlock(F.body,ie);return this.applyFilter(q,F.filter,ie)}evaluate(F,ie){if(!F)return new Qe;switch(F.type){case"Program":return this.evalProgram(F,ie);case"Set":return this.evaluateSet(F,ie);case"If":return this.evaluateIf(F,ie);case"For":return this.evaluateFor(F,ie);case"Macro":return this.evaluateMacro(F,ie);case"CallStatement":return this.evaluateCallStatement(F,ie);case"Break":throw new Fe;case"Continue":throw new Ve;case"IntegerLiteral":return new Ee(F.value);case"FloatLiteral":return new ze(F.value);case"StringLiteral":return new Se(F.value);case"ArrayLiteral":return new Xe(F.value.map(q=>this.evaluate(q,ie)));case"TupleLiteral":return new gt(F.value.map(q=>this.evaluate(q,ie)));case"ObjectLiteral":{let q=new Map;for(let[ee,ae]of F.value){let ye=this.evaluate(ee,ie);if(!(ye instanceof Se))throw new Error(`Object keys must be strings: got ${ye.type}`);q.set(ye.value,this.evaluate(ae,ie))}return new Ge(q)}case"Identifier":return this.evaluateIdentifier(F,ie);case"CallExpression":return this.evaluateCallExpression(F,ie);case"MemberExpression":return this.evaluateMemberExpression(F,ie);case"UnaryExpression":return this.evaluateUnaryExpression(F,ie);case"BinaryExpression":return this.evaluateBinaryExpression(F,ie);case"FilterExpression":return this.evaluateFilterExpression(F,ie);case"FilterStatement":return this.evaluateFilterStatement(F,ie);case"TestExpression":return this.evaluateTestExpression(F,ie);case"SelectExpression":return this.evaluateSelectExpression(F,ie);case"Ternary":return this.evaluateTernaryExpression(F,ie);case"Comment":return new at;default:throw new SyntaxError(`Unknown node type: ${F.type}`)}}};function ds(F){switch(typeof F){case"number":return Number.isInteger(F)?new Ee(F):new ze(F);case"string":return new Se(F);case"boolean":return new $e(F);case"undefined":return new Qe;case"object":return F===null?new at:Array.isArray(F)?new Xe(F.map(ds)):new Ge(new Map(Object.entries(F).map(([ie,q])=>[ie,ds(q)])));case"function":return new We((ie,q)=>{let ee=F(...ie.map(ae=>ae.value))??null;return ds(ee)});default:throw new Error(`Cannot convert to runtime value: ${F}`)}}var _n=`
`,xs="{%- ",Ia=" -%}";function Dl(F){switch(F.operator.type){case"MultiplicativeBinaryOperator":return 4;case"AdditiveBinaryOperator":return 3;case"ComparisonBinaryOperator":return 2;case"Identifier":return F.operator.value==="and"?1:F.operator.value==="in"||F.operator.value==="not in"?2:0}return 0}function Rl(F,ie="	"){let q=typeof ie=="number"?" ".repeat(ie):ie;return Ws(F.body,0,q).replace(/\n$/,"")}function Yn(...F){return xs+F.join(" ")+Ia}function Ws(F,ie,q){return F.map(ee=>sr(ee,ie,q)).join(_n)}function sr(F,ie,q){let ee=q.repeat(ie);switch(F.type){case"Program":return Ws(F.body,ie,q);case"If":return Da(F,ie,q);case"For":return Rt(F,ie,q);case"Set":return zo(F,ie,q);case"Macro":return In(F,ie,q);case"Break":return ee+Yn("break");case"Continue":return ee+Yn("continue");case"CallStatement":return Uo(F,ie,q);case"FilterStatement":return Bi(F,ie,q);case"Comment":return ee+"{# "+F.value+" #}";default:return ee+"{{- "+Kt(F)+" -}}"}}function Da(F,ie,q){let ee=q.repeat(ie),ae=[],ye=F;for(;ye&&(ae.push({test:ye.test,body:ye.body}),ye.alternate.length===1&&ye.alternate[0].type==="If");)ye=ye.alternate[0];let Le=ee+Yn("if",Kt(ae[0].test))+_n+Ws(ae[0].body,ie+1,q);for(let ht=1;ht<ae.length;++ht)Le+=_n+ee+Yn("elif",Kt(ae[ht].test))+_n+Ws(ae[ht].body,ie+1,q);return ye&&ye.alternate.length>0&&(Le+=_n+ee+Yn("else")+_n+Ws(ye.alternate,ie+1,q)),Le+=_n+ee+Yn("endif"),Le}function Rt(F,ie,q){let ee=q.repeat(ie),ae="";if(F.iterable.type==="SelectExpression"){let Le=F.iterable;ae=`${Kt(Le.lhs)} if ${Kt(Le.test)}`}else ae=Kt(F.iterable);let ye=ee+Yn("for",Kt(F.loopvar),"in",ae)+_n+Ws(F.body,ie+1,q);return F.defaultBlock.length>0&&(ye+=_n+ee+Yn("else")+_n+Ws(F.defaultBlock,ie+1,q)),ye+=_n+ee+Yn("endfor"),ye}function zo(F,ie,q){let ee=q.repeat(ie),ae=Kt(F.assignee),ye=F.value?Kt(F.value):"",Le=ee+Yn("set",`${ae}${F.value?" = "+ye:""}`);return F.body.length===0?Le:Le+_n+Ws(F.body,ie+1,q)+_n+ee+Yn("endset")}function In(F,ie,q){let ee=q.repeat(ie),ae=F.args.map(Kt).join(", ");return ee+Yn("macro",`${F.name.value}(${ae})`)+_n+Ws(F.body,ie+1,q)+_n+ee+Yn("endmacro")}function Uo(F,ie,q){let ee=q.repeat(ie),ae=F.callerArgs&&F.callerArgs.length>0?`(${F.callerArgs.map(Kt).join(", ")})`:"",ye=Kt(F.call),Le=ee+Yn(`call${ae}`,ye)+_n;return Le+=Ws(F.body,ie+1,q)+_n,Le+=ee+Yn("endcall"),Le}function Bi(F,ie,q){let ee=q.repeat(ie),ae=F.filter.type==="Identifier"?F.filter.value:Kt(F.filter),ye=ee+Yn("filter",ae)+_n;return ye+=Ws(F.body,ie+1,q)+_n,ye+=ee+Yn("endfilter"),ye}function Kt(F,ie=-1){switch(F.type){case"SpreadExpression":return`*${Kt(F.argument)}`;case"Identifier":return F.value;case"IntegerLiteral":return`${F.value}`;case"FloatLiteral":return`${F.value}`;case"StringLiteral":return JSON.stringify(F.value);case"BinaryExpression":{let q=F,ee=Dl(q),ae=Kt(q.left,ee),ye=Kt(q.right,ee+1),Le=`${ae} ${q.operator.value} ${ye}`;return ee<ie?`(${Le})`:Le}case"UnaryExpression":{let q=F;return q.operator.value+(q.operator.value==="not"?" ":"")+Kt(q.argument,1/0)}case"CallExpression":{let q=F,ee=q.args.map(Kt).join(", ");return`${Kt(q.callee)}(${ee})`}case"MemberExpression":{let q=F,ee=Kt(q.object);["Identifier","MemberExpression","CallExpression","StringLiteral","IntegerLiteral","FloatLiteral","ArrayLiteral","TupleLiteral","ObjectLiteral"].includes(q.object.type)||(ee=`(${ee})`);let ae=Kt(q.property);return!q.computed&&q.property.type!=="Identifier"&&(ae=`(${ae})`),q.computed?`${ee}[${ae}]`:`${ee}.${ae}`}case"FilterExpression":{let q=F,ee=Kt(q.operand,1/0);return q.filter.type==="CallExpression"?`${ee} | ${Kt(q.filter)}`:`${ee} | ${q.filter.value}`}case"SelectExpression":{let q=F;return`${Kt(q.lhs)} if ${Kt(q.test)}`}case"TestExpression":{let q=F;return`${Kt(q.operand)} is${q.negate?" not":""} ${q.test.value}`}case"ArrayLiteral":case"TupleLiteral":{let q=F.value.map(Kt),ee=F.type==="ArrayLiteral"?"[]":"()";return`${ee[0]}${q.join(", ")}${ee[1]}`}case"ObjectLiteral":return`{${Array.from(F.value.entries()).map(([ee,ae])=>`${Kt(ee)}: ${Kt(ae)}`).join(", ")}}`;case"SliceExpression":{let q=F,ee=q.start?Kt(q.start):"",ae=q.stop?Kt(q.stop):"",ye=q.step?`:${Kt(q.step)}`:"";return`${ee}:${ae}${ye}`}case"KeywordArgumentExpression":{let q=F;return`${q.key.value}=${Kt(q.value)}`}case"Ternary":{let q=F,ee=`${Kt(q.trueExpr)} if ${Kt(q.condition,0)} else ${Kt(q.falseExpr)}`;return ie>-1?`(${ee})`:ee}default:throw new Error(`Unknown expression type: ${F.type}`)}}var zi=class{constructor(F){Z(this,"parsed");let ie=u(F,{lstrip_blocks:!0,trim_blocks:!0});this.parsed=xe(ie)}render(F){let ie=new Pt;if(st(ie),F)for(let[ae,ye]of Object.entries(F))ie.set(ae,ye);return new un(ie).run(this.parsed).value}format(F){return Rl(this.parsed,F?.indent||"	")}}},"./src/backends/onnx.js":(s,e,t)=>{var n;t.r(e),t.d(e,{Tensor:()=>a.Tensor,createInferenceSession:()=>b,deviceToExecutionProviders:()=>f,isONNXProxy:()=>k,isONNXTensor:()=>M,runInferenceSession:()=>C});var i=t("./src/env.js"),r=t("?2ce3"),o=t("onnxruntime-web"),a=t("onnxruntime-common");let l=Object.freeze({auto:null,gpu:null,cpu:"cpu",wasm:"wasm",webgpu:"webgpu",cuda:"cuda",dml:"dml",webnn:{name:"webnn",deviceType:"cpu"},"webnn-npu":{name:"webnn",deviceType:"npu"},"webnn-gpu":{name:"webnn",deviceType:"gpu"},"webnn-cpu":{name:"webnn",deviceType:"cpu"}}),c=[],d,u,h=Symbol.for("onnxruntime");if(h in globalThis)u=globalThis[h];else if(i.apis.IS_NODE_ENV){switch(u=r??(n||(n=t.t(r,2))),process.platform){case"win32":c.push("dml");break;case"linux":process.arch==="x64"&&c.push("cuda");break;case"darwin":break}c.push("cpu"),d=["cpu"]}else u=o,i.apis.IS_WEBNN_AVAILABLE&&c.push("webnn-npu","webnn-gpu","webnn-cpu","webnn"),i.apis.IS_WEBGPU_AVAILABLE&&c.push("webgpu"),c.push("wasm"),d=["wasm"];let p=u.InferenceSession;function f(T=null){if(!T)return d;switch(T){case"auto":return c;case"gpu":return c.filter(P=>["webgpu","cuda","dml","webnn-gpu"].includes(P))}if(c.includes(T))return[l[T]??T];throw new Error(`Unsupported device: "${T}". Should be one of: ${c.join(", ")}.`)}let _=null;async function b(T,P,R){_&&await _;let O=p.create(T,P);_??(_=O);let H=await O;return H.config=R,H}let y=Promise.resolve(),w=i.apis.IS_BROWSER_ENV||i.apis.IS_WEBWORKER_ENV;async function C(T,P){let R=()=>T.run(P);return await(w?y=y.then(R):R())}function M(T){return T instanceof u.Tensor}let S=u?.env;S?.wasm&&(!(typeof ServiceWorkerGlobalScope<"u"&&self instanceof ServiceWorkerGlobalScope)&&!S.wasm.wasmPaths&&(S.wasm.wasmPaths=`https://cdn.jsdelivr.net/npm/@huggingface/transformers@${i.env.version}/dist/`),S.wasm.proxy=!1),S?.webgpu&&(S.webgpu.powerPreference="high-performance");function k(){return S?.wasm?.proxy}i.env.backends.onnx=S},"./src/base/feature_extraction_utils.js":(s,e,t)=>{t.r(e),t.d(e,{FeatureExtractor:()=>o,validate_audio_inputs:()=>a});var n=t("./src/utils/constants.js"),i=t("./src/utils/generic.js"),r=t("./src/utils/hub.js");class o extends i.Callable{constructor(c){super(),this.config=c}static async from_pretrained(c,d={}){let u=await(0,r.getModelJSON)(c,n.FEATURE_EXTRACTOR_NAME,!0,d);return new this(u)}}function a(l,c){if(!(l instanceof Float32Array||l instanceof Float64Array))throw new Error(`${c} expects input to be a Float32Array or a Float64Array, but got ${l?.constructor?.name??typeof l} instead. If using the feature extractor directly, remember to use \`read_audio(url, sampling_rate)\` to obtain the raw audio data of the file/url.`)}},"./src/base/image_processors_utils.js":(s,e,t)=>{t.r(e),t.d(e,{ImageProcessor:()=>S,center_to_corners_format:()=>h,post_process_instance_segmentation:()=>M,post_process_object_detection:()=>p,post_process_panoptic_segmentation:()=>C,post_process_semantic_segmentation:()=>f});var n=t("./src/utils/generic.js"),i=t("./src/utils/tensor.js"),r=t("./src/utils/maths.js"),o=t("./src/utils/image.js"),a=t("./src/utils/core.js"),l=t("./src/utils/hub.js"),c=t("./src/utils/constants.js");function d(k,T,P=0,R=null){let O=k/T,H=(0,r.bankers_round)(O)*T;return R!==null&&H>R&&(H=Math.floor(O)*T),H<P&&(H=Math.ceil(O)*T),H}function u([k,T],P){return[Math.max(Math.floor(k/P),1)*P,Math.max(Math.floor(T/P),1)*P]}function h([k,T,P,R]){return[k-P/2,T-R/2,k+P/2,T+R/2]}function p(k,T=.5,P=null,R=!1){let O=k.logits,H=k.pred_boxes,[X,z,ne]=O.dims;if(P!==null&&P.length!==X)throw Error("Make sure that you pass in as many target sizes as the batch dimension of the logits");let re=[];for(let Y=0;Y<X;++Y){let se=P!==null?P[Y]:null,ue={boxes:[],classes:[],scores:[]},fe=O[Y],Pe=H[Y];for(let oe=0;oe<z;++oe){let te=fe[oe],j=[],G;if(R){G=te.sigmoid().data;for(let de=0;de<G.length;++de)G[de]>T&&j.push(de)}else{let de=(0,r.max)(te.data)[1];if(de===ne-1||(G=(0,r.softmax)(te.data),G[de]<T))continue;j.push(de)}for(let de of j){let be=Pe[oe].data;be=h(be),se!==null&&(be=be.map((xe,Oe)=>xe*se[(Oe+1)%2])),ue.boxes.push(be),ue.classes.push(de),ue.scores.push(G[de])}}re.push(ue)}return re}function f(k,T=null){let P=k.logits,R=P.dims[0];if(T!==null&&T.length!==R)throw Error("Make sure that you pass in as many target sizes as the batch dimension of the logits");let O=[];for(let H=0;H<R;++H){let X=T!==null?T[H]:null,z=P[H];X!==null&&(z=(0,i.interpolate)(z,X,"bilinear",!1));let[ne,re]=X??z.dims.slice(-2),Y=new i.Tensor("int32",new Int32Array(ne*re),[ne,re]),se=z[0].data,ue=Y.data;for(let oe=1;oe<z.dims[0];++oe){let te=z[oe].data;for(let j=0;j<te.length;++j)te[j]>se[j]&&(se[j]=te[j],ue[j]=oe)}let fe=new Array(z.dims[0]);for(let oe=0;oe<ue.length;++oe){let te=ue[oe];fe[te]=te}let Pe=fe.filter(oe=>oe!==void 0);O.push({segmentation:Y,labels:Pe})}return O}function _(k,T,P,R){let O=[],H=[],X=[];for(let z=0;z<k.dims[0];++z){let ne=k[z],re=T[z],Y=(0,r.max)(ne.data)[1];if(Y===R)continue;let ue=(0,r.softmax)(ne.data)[Y];ue>P&&(O.push(re),H.push(ue),X.push(Y))}return[O,H,X]}function b(k,T,P,R=.5,O=.8){let H=[],X=0,z=0,ne=T[P].data;for(let Y=0;Y<k.length;++Y)k[Y]===P&&(H.push(Y),++X),ne[Y]>=R&&++z;let re=X>0&&z>0;return re&&(re=X/z>O),[re,H]}function y(k,T,P,R,O,H=null,X=null){let[z,ne]=X??k[0].dims,re=new i.Tensor("int32",new Int32Array(z*ne),[z,ne]),Y=[];if(X!==null)for(let oe=0;oe<k.length;++oe)k[oe]=(0,i.interpolate)(k[oe],X,"bilinear",!1);let se=new Int32Array(k[0].data.length),ue=new Float32Array(k[0].data.length);for(let oe=0;oe<k.length;++oe){let te=T[oe],j=k[oe].data;for(let G=0;G<j.length;++G)j[G]*=te,j[G]>ue[G]&&(se[G]=oe,ue[G]=j[G])}let fe=0,Pe=re.data;for(let oe=0;oe<P.length;++oe){let te=P[oe],[j,G]=b(se,k,oe,R,O);if(j){++fe;for(let de of G)Pe[de]=fe;Y.push({id:fe,label_id:te,score:T[oe]})}}return[re,Y]}function w(k,T,P=28,R=56*56,O=14*14*4*1280){if(k<P||T<P)throw new Error(`height:${k} or width:${T} must be larger than factor:${P}`);if(Math.max(k,T)/Math.min(k,T)>200)throw new Error(`absolute aspect ratio must be smaller than 200, got ${Math.max(k,T)/Math.min(k,T)}`);let H=Math.round(k/P)*P,X=Math.round(T/P)*P;if(H*X>O){let z=Math.sqrt(k*T/O);H=Math.floor(k/z/P)*P,X=Math.floor(T/z/P)*P}else if(H*X<R){let z=Math.sqrt(R/(k*T));H=Math.ceil(k*z/P)*P,X=Math.ceil(T*z/P)*P}return[H,X]}function C(k,T=.5,P=.5,R=.8,O=null,H=null){O===null&&(console.warn("`label_ids_to_fuse` unset. No instance will be fused."),O=new Set);let X=k.class_queries_logits??k.logits,ne=(k.masks_queries_logits??k.pred_masks).sigmoid(),[re,Y,se]=X.dims;if(se-=1,H!==null&&H.length!==re)throw Error("Make sure that you pass in as many target sizes as the batch dimension of the logits");let ue=[];for(let fe=0;fe<re;++fe){let Pe=H!==null?H[fe]:null,oe=X[fe],te=ne[fe],[j,G,de]=_(oe,te,T,se);if(de.length===0){let[Oe,je]=Pe??te.dims.slice(-2),dt=new i.Tensor("int32",new Int32Array(Oe*je).fill(-1),[Oe,je]);ue.push({segmentation:dt,segments_info:[]});continue}let[be,xe]=y(j,G,de,P,R,O,Pe);ue.push({segmentation:be,segments_info:xe})}return ue}function M(k,T=.5,P=null){throw new Error("`post_process_instance_segmentation` is not yet implemented.")}class S extends n.Callable{constructor(T){super(),this.image_mean=T.image_mean??T.mean,this.image_std=T.image_std??T.std,this.resample=T.resample??2,this.do_rescale=T.do_rescale??!0,this.rescale_factor=T.rescale_factor??1/255,this.do_normalize=T.do_normalize,this.do_thumbnail=T.do_thumbnail,this.size=T.size??T.image_size,this.do_resize=T.do_resize??this.size!==void 0,this.size_divisibility=T.size_divisibility??T.size_divisor,this.do_center_crop=T.do_center_crop,this.crop_size=T.crop_size,this.do_convert_rgb=T.do_convert_rgb??!0,this.do_crop_margin=T.do_crop_margin,this.pad_size=T.pad_size,this.do_pad=T.do_pad,this.min_pixels=T.min_pixels,this.max_pixels=T.max_pixels,this.do_pad&&!this.pad_size&&this.size&&this.size.width!==void 0&&this.size.height!==void 0&&(this.pad_size=this.size),this.do_flip_channel_order=T.do_flip_channel_order??!1,this.config=T}async thumbnail(T,P,R=2){let O=T.height,H=T.width,X=P.height,z=P.width,ne=Math.min(O,X),re=Math.min(H,z);return ne===O&&re===H?T:(O>H?re=Math.floor(H*ne/O):H>O&&(ne=Math.floor(O*re/H)),await T.resize(re,ne,{resample:R}))}async crop_margin(T,P=200){let R=T.clone().grayscale(),O=(0,r.min)(R.data)[0],X=(0,r.max)(R.data)[0]-O;if(X===0)return T;let z=P/255,ne=R.width,re=R.height,Y=0,se=0,ue=R.data;for(let fe=0;fe<R.height;++fe){let Pe=fe*R.width;for(let oe=0;oe<R.width;++oe)(ue[Pe+oe]-O)/X<z&&(ne=Math.min(ne,oe),re=Math.min(re,fe),Y=Math.max(Y,oe),se=Math.max(se,fe))}return T=await T.crop([ne,re,Y,se]),T}pad_image(T,P,R,{mode:O="constant",center:H=!1,constant_values:X=0}={}){let[z,ne,re]=P,Y,se;if(typeof R=="number"?(Y=R,se=R):R==="square"?Y=se=Math.max(z,ne):(Y=R.width,se=R.height),Y!==ne||se!==z){let ue=new Float32Array(Y*se*re);if(Array.isArray(X))for(let oe=0;oe<ue.length;++oe)ue[oe]=X[oe%re];else X!==0&&ue.fill(X);let[fe,Pe]=H?[Math.floor((Y-ne)/2),Math.floor((se-z)/2)]:[0,0];for(let oe=0;oe<z;++oe){let te=(oe+Pe)*Y,j=oe*ne;for(let G=0;G<ne;++G){let de=(te+G+fe)*re,be=(j+G)*re;for(let xe=0;xe<re;++xe)ue[de+xe]=T[be+xe]}}if(O==="symmetric"){if(H)throw new Error("`center` padding is not supported when `mode` is set to `symmetric`.");let oe=z-1,te=ne-1;for(let j=0;j<se;++j){let G=j*Y,de=(0,a.calculateReflectOffset)(j,oe)*ne;for(let be=0;be<Y;++be){if(j<z&&be<ne)continue;let xe=(G+be)*re,Oe=(de+(0,a.calculateReflectOffset)(be,te))*re;for(let je=0;je<re;++je)ue[xe+je]=T[Oe+je]}}}T=ue,P=[se,Y,re]}return[T,P]}rescale(T){for(let P=0;P<T.length;++P)T[P]=this.rescale_factor*T[P]}get_resize_output_image_size(T,P){let[R,O]=T.size,H,X;if(this.do_thumbnail){let{height:z,width:ne}=P;H=Math.min(z,ne)}else Number.isInteger(P)?(H=P,X=this.config.max_size??H):P!==void 0&&(H=P.shortest_edge,X=P.longest_edge);if(H!==void 0||X!==void 0){let z=H===void 0?1:Math.max(H/R,H/O),ne=R*z,re=O*z,Y=X===void 0?1:Math.min(X/ne,X/re),se=Math.floor(Number((ne*Y).toFixed(2))),ue=Math.floor(Number((re*Y).toFixed(2)));return this.size_divisibility!==void 0&&([se,ue]=u([se,ue],this.size_divisibility)),[se,ue]}else if(P!==void 0&&P.width!==void 0&&P.height!==void 0){let z=P.width,ne=P.height;if(this.config.keep_aspect_ratio&&this.config.ensure_multiple_of){let re=ne/O,Y=z/R;Math.abs(1-Y)<Math.abs(1-re)?re=Y:Y=re,ne=d(re*O,this.config.ensure_multiple_of),z=d(Y*R,this.config.ensure_multiple_of)}return[z,ne]}else{if(this.size_divisibility!==void 0)return u([R,O],this.size_divisibility);if(this.min_pixels!==void 0&&this.max_pixels!==void 0){let z=this.config.patch_size*this.config.merge_size;return w(O,R,z,this.min_pixels,this.max_pixels)}else throw new Error(`Could not resize image due to unsupported \`this.size\` option in config: ${JSON.stringify(P)}`)}}async resize(T){let[P,R]=this.get_resize_output_image_size(T,this.size);return await T.resize(P,R,{resample:this.resample})}async preprocess(T,{do_normalize:P=null,do_pad:R=null,do_convert_rgb:O=null,do_convert_grayscale:H=null,do_flip_channel_order:X=null}={}){this.do_crop_margin&&(T=await this.crop_margin(T));let[z,ne]=T.size;if(O??this.do_convert_rgb?T=T.rgb():H&&(T=T.grayscale()),this.do_resize&&(T=await this.resize(T)),this.do_thumbnail&&(T=await this.thumbnail(T,this.size,this.resample)),this.do_center_crop){let fe,Pe;Number.isInteger(this.crop_size)?(fe=this.crop_size,Pe=this.crop_size):(fe=this.crop_size.width,Pe=this.crop_size.height),T=await T.center_crop(fe,Pe)}let re=[T.height,T.width],Y=Float32Array.from(T.data),se=[T.height,T.width,T.channels];if(this.do_rescale&&this.rescale(Y),P??this.do_normalize){let fe=this.image_mean;Array.isArray(this.image_mean)||(fe=new Array(T.channels).fill(fe));let Pe=this.image_std;if(Array.isArray(this.image_std)||(Pe=new Array(T.channels).fill(Pe)),fe.length!==T.channels||Pe.length!==T.channels)throw new Error(`When set to arrays, the length of \`image_mean\` (${fe.length}) and \`image_std\` (${Pe.length}) must match the number of channels in the image (${T.channels}).`);for(let oe=0;oe<Y.length;oe+=T.channels)for(let te=0;te<T.channels;++te)Y[oe+te]=(Y[oe+te]-fe[te])/Pe[te]}if(R??this.do_pad){if(this.pad_size)[Y,se]=this.pad_image(Y,[T.height,T.width,T.channels],this.pad_size);else if(this.size_divisibility){let[fe,Pe]=u([se[1],se[0]],this.size_divisibility);[Y,se]=this.pad_image(Y,se,{width:fe,height:Pe})}}if(X??this.do_flip_channel_order){if(se[2]!==3)throw new Error("Flipping channel order is only supported for RGB images.");for(let fe=0;fe<Y.length;fe+=3){let Pe=Y[fe];Y[fe]=Y[fe+2],Y[fe+2]=Pe}}let ue=new i.Tensor("float32",Y,se).permute(2,0,1);return{original_size:[ne,z],reshaped_input_size:re,pixel_values:ue}}async _call(T,...P){Array.isArray(T)||(T=[T]);let R=await Promise.all(T.map(H=>this.preprocess(H)));return{pixel_values:(0,i.stack)(R.map(H=>H.pixel_values),0),original_sizes:R.map(H=>H.original_size),reshaped_input_sizes:R.map(H=>H.reshaped_input_size)}}static async from_pretrained(T,P={}){let R=await(0,l.getModelJSON)(T,c.IMAGE_PROCESSOR_NAME,!0,P);return new this(R)}}},"./src/base/processing_utils.js":(s,e,t)=>{t.r(e),t.d(e,{Processor:()=>o});var n=t("./src/utils/constants.js"),i=t("./src/utils/generic.js"),r=t("./src/utils/hub.js");class o extends i.Callable{constructor(l,c,d){super(),this.config=l,this.components=c,this.chat_template=d}get image_processor(){return this.components.image_processor}get tokenizer(){return this.components.tokenizer}get feature_extractor(){return this.components.feature_extractor}apply_chat_template(l,c={}){if(!this.tokenizer)throw new Error("Unable to apply chat template without a tokenizer.");return this.tokenizer.apply_chat_template(l,{tokenize:!1,chat_template:this.chat_template??void 0,...c})}batch_decode(...l){if(!this.tokenizer)throw new Error("Unable to decode without a tokenizer.");return this.tokenizer.batch_decode(...l)}decode(...l){if(!this.tokenizer)throw new Error("Unable to decode without a tokenizer.");return this.tokenizer.decode(...l)}async _call(l,...c){for(let d of[this.image_processor,this.feature_extractor,this.tokenizer])if(d)return d(l,...c);throw new Error("No image processor, feature extractor, or tokenizer found.")}static async from_pretrained(l,c={}){let[d,u,h]=await Promise.all([this.uses_processor_config?(0,r.getModelJSON)(l,n.PROCESSOR_NAME,!0,c):{},Promise.all(this.classes.filter(p=>p in this).map(async p=>{let f=await this[p].from_pretrained(l,c);return[p.replace(/_class$/,""),f]})).then(Object.fromEntries),this.uses_chat_template_file?(0,r.getModelText)(l,n.CHAT_TEMPLATE_NAME,!0,c):null]);return new this(d,u,h)}}Z(o,"classes",["image_processor_class","tokenizer_class","feature_extractor_class"]),Z(o,"uses_processor_config",!1),Z(o,"uses_chat_template_file",!1)},"./src/configs.js":(s,e,t)=>{t.r(e),t.d(e,{AutoConfig:()=>d,PretrainedConfig:()=>c,getCacheShapes:()=>a});var n=t("./src/utils/core.js"),i=t("./src/utils/hub.js");async function r(u,h){return await(0,i.getModelJSON)(u,"config.json",!0,h)}function o(u){let h={},p={};switch(u.model_type){case"llava":case"paligemma":case"gemma3":case"florence2":case"llava_onevision":case"idefics3":case"ultravox":case"voxtral":case"smolvlm":case"gemma3n":case"mistral3":p=o(u.text_config);break;case"moondream1":p=o(u.phi_config);break;case"musicgen":p=o(u.decoder);break;case"multi_modality":p=o(u.language_config);break;case"gpt2":case"gptj":case"jais":case"codegen":case"gpt_bigcode":h.num_heads="n_head",h.num_layers="n_layer",h.hidden_size="n_embd";break;case"gpt_neox":case"stablelm":case"opt":case"falcon":case"modernbert-decoder":h.num_heads="num_attention_heads",h.num_layers="num_hidden_layers",h.hidden_size="hidden_size";break;case"llama":case"llama4_text":case"nanochat":case"arcee":case"lfm2":case"smollm3":case"olmo":case"olmo2":case"mobilellm":case"granite":case"granitemoehybrid":case"cohere":case"mistral":case"starcoder2":case"qwen2":case"qwen2_vl":case"phi":case"phi3":case"phi3_v":case"llava_qwen2":h.num_heads="num_key_value_heads",h.num_layers="num_hidden_layers",h.hidden_size="hidden_size",h.num_attention_heads="num_attention_heads",h.dim_kv="head_dim";break;case"qwen3":case"gemma":case"gemma2":case"vaultgemma":case"gemma3_text":case"gemma3n_text":case"glm":case"helium":case"ernie4_5":case"ministral":case"ministral3":h.num_heads="num_key_value_heads",h.num_layers="num_hidden_layers",h.dim_kv="head_dim";break;case"openelm":h.num_heads="num_kv_heads",h.num_layers="num_transformer_layers",h.dim_kv="head_dim";break;case"gpt_neo":case"donut-swin":h.num_heads="num_heads",h.num_layers="num_layers",h.hidden_size="hidden_size";break;case"bloom":h.num_heads="n_head",h.num_layers="n_layer",h.hidden_size="hidden_size";break;case"mpt":h.num_heads="n_heads",h.num_layers="n_layers",h.hidden_size="d_model";break;case"exaone":h.num_heads="num_key_value_heads",h.num_layers="num_layers",h.dim_kv="head_dim",h.num_attention_heads="num_attention_heads";break;case"t5":case"mt5":case"longt5":h.num_decoder_layers="num_decoder_layers",h.num_decoder_heads="num_heads",h.decoder_dim_kv="d_kv",h.num_encoder_layers="num_layers",h.num_encoder_heads="num_heads",h.encoder_dim_kv="d_kv";break;case"bart":case"mbart":case"marian":case"whisper":case"lite-whisper":case"m2m_100":case"blenderbot":case"blenderbot-small":case"florence2_language":h.num_decoder_layers="decoder_layers",h.num_decoder_heads="decoder_attention_heads",h.decoder_hidden_size="d_model",h.num_encoder_layers="encoder_layers",h.num_encoder_heads="encoder_attention_heads",h.encoder_hidden_size="d_model";break;case"speecht5":h.num_decoder_layers="decoder_layers",h.num_decoder_heads="decoder_attention_heads",h.decoder_hidden_size="hidden_size",h.num_encoder_layers="encoder_layers",h.num_encoder_heads="encoder_attention_heads",h.encoder_hidden_size="hidden_size";break;case"trocr":h.num_encoder_layers=h.num_decoder_layers="decoder_layers",h.num_encoder_heads=h.num_decoder_heads="decoder_attention_heads",h.encoder_hidden_size=h.decoder_hidden_size="d_model";break;case"musicgen_decoder":h.num_encoder_layers=h.num_decoder_layers="num_hidden_layers",h.num_encoder_heads=h.num_decoder_heads="num_attention_heads",h.encoder_hidden_size=h.decoder_hidden_size="hidden_size";break;case"moonshine":h.num_decoder_layers="decoder_num_hidden_layers",h.num_decoder_heads="decoder_num_key_value_heads",h.num_encoder_layers="encoder_num_hidden_layers",h.num_encoder_heads="encoder_num_key_value_heads",h.encoder_hidden_size=h.decoder_hidden_size="hidden_size";break;case"vision-encoder-decoder":let _=o(u.decoder),b="num_decoder_layers"in _,y=(0,n.pick)(u,["model_type","is_encoder_decoder"]);return b?(y.num_decoder_layers=_.num_decoder_layers,y.num_decoder_heads=_.num_decoder_heads,y.decoder_hidden_size=_.decoder_hidden_size,y.num_encoder_layers=_.num_encoder_layers,y.num_encoder_heads=_.num_encoder_heads,y.encoder_hidden_size=_.encoder_hidden_size):(y.num_layers=_.num_layers,y.num_heads=_.num_heads,y.hidden_size=_.hidden_size),y}let f={...p,...(0,n.pick)(u,["model_type","multi_query","is_encoder_decoder"])};for(let _ in h)f[_]=u[h[_]];return f}function a(u,h){if(u.model_type==="lfm2"){let p=h?.prefix??"past_key_values",f=p==="present"?"present":"past",_={},{layer_types:b,num_attention_heads:y,num_key_value_heads:w,hidden_size:C,conv_L_cache:M}=u,S=C/y,k=h?.batch_size??1;for(let T=0;T<b.length;++T)if(b[T]==="full_attention")for(let P of["key","value"])_[`${p}.${T}.${P}`]=[k,w,0,S];else if(b[T]==="conv")_[`${f}_conv.${T}`]=[k,C,M];else throw new Error(`Unsupported layer type: ${b[T]}`);return _}return l(u,h)}function l(u,{prefix:h="past_key_values",batch_size:p=1}={}){let f={},_=u.normalized_config;if(_.is_encoder_decoder&&"num_encoder_heads"in _&&"num_decoder_heads"in _){let b=_.encoder_dim_kv??_.encoder_hidden_size/_.num_encoder_heads,y=_.decoder_dim_kv??_.decoder_hidden_size/_.num_decoder_heads,w=[p,_.num_encoder_heads,0,b],C=[p,_.num_decoder_heads,0,y];for(let M=0;M<_.num_decoder_layers;++M)f[`${h}.${M}.encoder.key`]=w,f[`${h}.${M}.encoder.value`]=w,f[`${h}.${M}.decoder.key`]=C,f[`${h}.${M}.decoder.value`]=C}else{let b=_.num_heads,y=_.num_layers,w=_.dim_kv??_.hidden_size/(_.num_attention_heads??b);if(_.model_type==="falcon"){let C=[p*b,0,w];for(let M=0;M<y;++M)f[`${h}.${M}.key`]=C,f[`${h}.${M}.value`]=C}else if(_.multi_query){let C=[p*b,0,2*w];for(let M=0;M<y;++M)f[`${h}.${M}.key_value`]=C}else if(_.model_type==="bloom"){let C=[p*b,w,0],M=[p*b,0,w];for(let S=0;S<y;++S)f[`${h}.${S}.key`]=C,f[`${h}.${S}.value`]=M}else if(_.model_type==="openelm")for(let C=0;C<y;++C){let M=[p,b[C],0,w];f[`${h}.${C}.key`]=M,f[`${h}.${C}.value`]=M}else{let C=[p,b,0,w];for(let M=0;M<y;++M)f[`${h}.${M}.key`]=C,f[`${h}.${M}.value`]=C}}return f}class c{constructor(h){Z(this,"model_type",null);Z(this,"is_encoder_decoder",!1);Z(this,"max_position_embeddings");Z(this,"transformers.js_config");Object.assign(this,h),this.normalized_config=o(this)}static async from_pretrained(h,{progress_callback:p=null,config:f=null,cache_dir:_=null,local_files_only:b=!1,revision:y="main"}={}){f&&!(f instanceof c)&&(f=new c(f));let w=f??await r(h,{progress_callback:p,config:f,cache_dir:_,local_files_only:b,revision:y});return new this(w)}}class d{static async from_pretrained(...h){return c.from_pretrained(...h)}}},"./src/env.js":(s,e,t)=>{t.r(e),t.d(e,{apis:()=>w,env:()=>P});var n=t("?db59"),i=t("?383f"),r=t("?fa4b");let o="3.8.1",a=typeof window<"u"&&typeof window.document<"u",l=typeof self<"u"&&["DedicatedWorkerGlobalScope","ServiceWorkerGlobalScope","SharedWorkerGlobalScope"].includes(self.constructor?.name),c=typeof self<"u"&&"caches"in self,d=typeof navigator<"u"&&"gpu"in navigator,u=typeof navigator<"u"&&"ml"in navigator,h=typeof process<"u",p=h&&process?.release?.name==="node",f=!R(n),_=!R(i),b=typeof globalThis.Deno<"u",y=typeof globalThis.Bun<"u",w=Object.freeze({IS_BROWSER_ENV:a,IS_WEBWORKER_ENV:l,IS_WEB_CACHE_AVAILABLE:c,IS_WEBGPU_AVAILABLE:d,IS_WEBNN_AVAILABLE:u,IS_PROCESS_AVAILABLE:h,IS_NODE_ENV:p,IS_FS_AVAILABLE:f,IS_PATH_AVAILABLE:_}),C=f&&_,M="./";if(C){let O=Object(ase).url;O?M=i.dirname(i.dirname(r.fileURLToPath(O))):typeof __dirname<"u"&&(M=i.dirname(__dirname))}let S=C?i.join(M,"/.cache/"):null,k="/models/",T=C?i.join(M,k):k,P={version:o,backends:{onnx:{}},allowRemoteModels:!0,remoteHost:"https://huggingface.co/",remotePathTemplate:"{model}/resolve/{revision}/",allowLocalModels:!(a||l),localModelPath:T,useFS:f,useBrowserCache:c&&!b,useFSCache:f,cacheDir:S,useCustomCache:!1,customCache:null};function R(O){return Object.keys(O).length===0}},"./src/generation/configuration_utils.js":(s,e,t)=>{t.r(e),t.d(e,{GenerationConfig:()=>i});var n=t("./src/utils/core.js");class i{constructor(o){Z(this,"max_length",20);Z(this,"max_new_tokens",null);Z(this,"min_length",0);Z(this,"min_new_tokens",null);Z(this,"early_stopping",!1);Z(this,"max_time",null);Z(this,"do_sample",!1);Z(this,"num_beams",1);Z(this,"num_beam_groups",1);Z(this,"penalty_alpha",null);Z(this,"use_cache",!0);Z(this,"temperature",1);Z(this,"top_k",50);Z(this,"top_p",1);Z(this,"typical_p",1);Z(this,"epsilon_cutoff",0);Z(this,"eta_cutoff",0);Z(this,"diversity_penalty",0);Z(this,"repetition_penalty",1);Z(this,"encoder_repetition_penalty",1);Z(this,"length_penalty",1);Z(this,"no_repeat_ngram_size",0);Z(this,"bad_words_ids",null);Z(this,"force_words_ids",null);Z(this,"renormalize_logits",!1);Z(this,"constraints",null);Z(this,"forced_bos_token_id",null);Z(this,"forced_eos_token_id",null);Z(this,"remove_invalid_values",!1);Z(this,"exponential_decay_length_penalty",null);Z(this,"suppress_tokens",null);Z(this,"streamer",null);Z(this,"begin_suppress_tokens",null);Z(this,"forced_decoder_ids",null);Z(this,"guidance_scale",null);Z(this,"num_return_sequences",1);Z(this,"output_attentions",!1);Z(this,"output_hidden_states",!1);Z(this,"output_scores",!1);Z(this,"return_dict_in_generate",!1);Z(this,"pad_token_id",null);Z(this,"bos_token_id",null);Z(this,"eos_token_id",null);Z(this,"encoder_no_repeat_ngram_size",0);Z(this,"decoder_start_token_id",null);Z(this,"generation_kwargs",{});Object.assign(this,(0,n.pick)(o,Object.getOwnPropertyNames(this)))}}},"./src/generation/logits_process.js":(s,e,t)=>{t.r(e),t.d(e,{ClassifierFreeGuidanceLogitsProcessor:()=>w,ForcedBOSTokenLogitsProcessor:()=>c,ForcedEOSTokenLogitsProcessor:()=>d,LogitsProcessor:()=>o,LogitsProcessorList:()=>l,LogitsWarper:()=>a,MinLengthLogitsProcessor:()=>_,MinNewTokensLengthLogitsProcessor:()=>b,NoBadWordsLogitsProcessor:()=>y,NoRepeatNGramLogitsProcessor:()=>p,RepetitionPenaltyLogitsProcessor:()=>f,SuppressTokensAtBeginLogitsProcessor:()=>u,TemperatureLogitsWarper:()=>C,TopKLogitsWarper:()=>S,TopPLogitsWarper:()=>M,WhisperTimeStampLogitsProcessor:()=>h});var n=t("./src/utils/generic.js"),i=t("./src/utils/tensor.js"),r=t("./src/utils/maths.js");class o extends n.Callable{_call(T,P){throw Error("`_call` should be implemented in a subclass")}}class a extends n.Callable{_call(T,P){throw Error("`_call` should be implemented in a subclass")}}class l extends n.Callable{constructor(){super(),this.processors=[]}push(T){this.processors.push(T)}extend(T){this.processors.push(...T)}_call(T,P){let R=P;for(let O of this.processors)R=O(T,R);return R}[Symbol.iterator](){return this.processors.values()}}class c extends o{constructor(T){super(),this.bos_token_id=T}_call(T,P){for(let R=0;R<T.length;++R)if(T[R].length===1){let O=P[R].data;O.fill(-1/0),O[this.bos_token_id]=0}return P}}class d extends o{constructor(T,P){super(),this.max_length=T,this.eos_token_id=Array.isArray(P)?P:[P]}_call(T,P){for(let R=0;R<T.length;++R)if(T[R].length===this.max_length-1){let O=P[R].data;O.fill(-1/0);for(let H of this.eos_token_id)O[H]=0}return P}}class u extends o{constructor(T,P){super(),this.begin_suppress_tokens=T,this.begin_index=P}_call(T,P){for(let R=0;R<T.length;++R)if(T[R].length===this.begin_index){let O=P[R].data;for(let H of this.begin_suppress_tokens)O[H]=-1/0}return P}}class h extends o{constructor(T,P){super(),this.eos_token_id=Array.isArray(T.eos_token_id)?T.eos_token_id[0]:T.eos_token_id,this.no_timestamps_token_id=T.no_timestamps_token_id,this.timestamp_begin=this.no_timestamps_token_id+1,this.begin_index=P.length,P.at(-1)===this.no_timestamps_token_id&&(this.begin_index-=1),this.max_initial_timestamp_index=T.max_initial_timestamp_index}_call(T,P){for(let R=0;R<T.length;++R){let O=P[R].data;if(O[this.no_timestamps_token_id]=-1/0,T[R].length===this.begin_index-1){O.fill(-1/0),O[this.timestamp_begin]=0;continue}let H=T[R].slice(this.begin_index),X=H.length>=1&&H[H.length-1]>=this.timestamp_begin,z=H.length<2||H[H.length-2]>=this.timestamp_begin;if(X&&(z?O.subarray(this.timestamp_begin).fill(-1/0):O.subarray(0,this.eos_token_id).fill(-1/0)),T[R].length===this.begin_index&&this.max_initial_timestamp_index!==null){let se=this.timestamp_begin+this.max_initial_timestamp_index;O.subarray(se+1).fill(-1/0)}let ne=(0,r.log_softmax)(O),re=Math.log(ne.subarray(this.timestamp_begin).map(Math.exp).reduce((se,ue)=>se+ue)),Y=(0,r.max)(ne.subarray(0,this.timestamp_begin))[0];re>Y&&O.subarray(0,this.timestamp_begin).fill(-1/0)}return P}}class p extends o{constructor(T){super(),this.no_repeat_ngram_size=T}getNgrams(T){let P=T.length,R=[];for(let H=0;H<P+1-this.no_repeat_ngram_size;++H){let X=[];for(let z=0;z<this.no_repeat_ngram_size;++z)X.push(T[H+z]);R.push(X.map(Number))}let O=new Map;for(let H of R){let X=H.slice(0,H.length-1),z=JSON.stringify(X),ne=O.get(z)??[];ne.push(H[H.length-1]),O.set(z,ne)}return O}getGeneratedNgrams(T,P){let R=P.slice(P.length+1-this.no_repeat_ngram_size,P.length);return T.get(JSON.stringify(R.map(Number)))??[]}calcBannedNgramTokens(T){let P=[];if(T.length+1<this.no_repeat_ngram_size)return P;{let R=this.getNgrams(T);return this.getGeneratedNgrams(R,T)}}_call(T,P){for(let R=0;R<T.length;++R){let O=P[R].data,H=this.calcBannedNgramTokens(T[R]);for(let X of H)O[X]=-1/0}return P}}class f extends o{constructor(T){super(),this.penalty=T}_call(T,P){for(let R=0;R<T.length;++R){let O=P[R].data;for(let H of new Set(T[R])){let X=Number(H);O[X]<0?O[X]*=this.penalty:O[X]/=this.penalty}}return P}}class _ extends o{constructor(T,P){super(),this.min_length=T,this.eos_token_id=Array.isArray(P)?P:[P]}_call(T,P){for(let R=0;R<T.length;++R)if(T[R].length<this.min_length){let O=P[R].data;for(let H of this.eos_token_id)O[H]=-1/0}return P}}class b extends o{constructor(T,P,R){super(),this.prompt_length_to_skip=T,this.min_new_tokens=P,this.eos_token_id=Array.isArray(R)?R:[R]}_call(T,P){for(let R=0;R<T.length;++R)if(T[R].length-this.prompt_length_to_skip<this.min_new_tokens){let H=P[R].data;for(let X of this.eos_token_id)H[X]=-1/0}return P}}class y extends o{constructor(T,P){super(),this.bad_words_ids=T,this.eos_token_id=Array.isArray(P)?P:[P]}_call(T,P){for(let R=0;R<T.length;++R){let O=P[R].data,H=T[R];for(let X of this.bad_words_ids){if(H.length<X.length-1)continue;let z=!0;for(let ne=1;ne<=X.length-1;++ne)if(X.at(-ne-1)!=H.at(-ne)){z=!1;break}z&&(O[X.at(-1)]=-1/0)}}return P}}class w extends o{constructor(T){if(super(),T<=1)throw new Error(`Require guidance scale >1 to use the classifier free guidance processor, got guidance scale ${T}.`);this.guidance_scale=T}_call(T,P){if(P.dims[0]!==2*T.length)throw new Error(`Logits should have twice the batch size of the input ids, the first half of batches corresponding to the conditional inputs, and the second half of batches corresponding to the unconditional inputs. Got batch size ${P.dims[0]} for the logits and ${T.length} for the input ids.`);let R=T.length,O=P.slice([0,R],null),H=P.slice([R,P.dims[0]],null);for(let X=0;X<H.data.length;++X)H.data[X]+=(O.data[X]-H.data[X])*this.guidance_scale;return H}}class C extends a{constructor(T){if(super(),typeof T!="number"||T<=0){let P=`\`temperature\` (=${T}) must be a strictly positive float, otherwise your next token scores will be invalid.`;T===0&&(P+=" If you're looking for greedy decoding strategies, set `do_sample=false`.")}this.temperature=T}_call(T,P){let R=P.data;for(let O=0;O<R.length;++O)R[O]/=this.temperature;return P}}class M extends a{constructor(T,{filter_value:P=-1/0,min_tokens_to_keep:R=1}={}){if(super(),T<0||T>1)throw new Error(`\`top_p\` must be a float > 0 and < 1, but is ${T}`);if(!Number.isInteger(R)||R<1)throw new Error(`\`min_tokens_to_keep\` must be a positive integer, but is ${R}`);this.top_p=T,this.filter_value=P,this.min_tokens_to_keep=R}}class S extends a{constructor(T,{filter_value:P=-1/0,min_tokens_to_keep:R=1}={}){if(super(),!Number.isInteger(T)||T<0)throw new Error(`\`top_k\` must be a positive integer, but is ${T}`);this.top_k=Math.max(T,R),this.filter_value=P}}},"./src/generation/logits_sampler.js":(s,e,t)=>{t.r(e),t.d(e,{LogitsSampler:()=>a});var n=t("./src/utils/generic.js"),i=t("./src/utils/tensor.js"),r=t("./src/utils/maths.js"),o=t("./src/generation/configuration_utils.js");class a extends n.Callable{constructor(h){super(),this.generation_config=h}async _call(h){return this.sample(h)}async sample(h){throw Error("sample should be implemented in subclasses.")}getLogits(h,p){let f=h.dims.at(-1),_=h.data;if(p===-1)_=_.slice(-f);else{let b=p*f;_=_.slice(b,b+f)}return _}randomSelect(h){let p=0;for(let _=0;_<h.length;++_)p+=h[_];let f=Math.random()*p;for(let _=0;_<h.length;++_)if(f-=h[_],f<=0)return _;return 0}static getSampler(h){if(h.do_sample)return new c(h);if(h.num_beams>1)return new d(h);if(h.num_return_sequences>1)throw Error(`num_return_sequences has to be 1 when doing greedy search, but is ${h.num_return_sequences}.`);return new l(h)}}class l extends a{async sample(h){let p=(0,r.max)(h.data)[1];return[[BigInt(p),0]]}}class c extends a{async sample(h){let p=h.dims.at(-1);this.generation_config.top_k>0&&(p=Math.min(this.generation_config.top_k,p));let[f,_]=await(0,i.topk)(h,p),b=(0,r.softmax)(f.data);return Array.from({length:this.generation_config.num_beams},()=>{let y=this.randomSelect(b);return[_.data[y],Math.log(b[y])]})}}class d extends a{async sample(h){let p=h.dims.at(-1);this.generation_config.top_k>0&&(p=Math.min(this.generation_config.top_k,p));let[f,_]=await(0,i.topk)(h,p),b=(0,r.softmax)(f.data);return Array.from({length:this.generation_config.num_beams},(y,w)=>[_.data[w],Math.log(b[w])])}}},"./src/generation/stopping_criteria.js":(s,e,t)=>{t.r(e),t.d(e,{EosTokenCriteria:()=>a,InterruptableStoppingCriteria:()=>l,MaxLengthCriteria:()=>o,StoppingCriteria:()=>i,StoppingCriteriaList:()=>r});var n=t("./src/utils/generic.js");class i extends n.Callable{_call(d,u){throw Error("StoppingCriteria needs to be subclassed")}}class r extends n.Callable{constructor(){super(),this.criteria=[]}push(d){this.criteria.push(d)}extend(d){d instanceof r?d=d.criteria:d instanceof i&&(d=[d]),this.criteria.push(...d)}_call(d,u){let h=new Array(d.length).fill(!1);for(let p of this.criteria){let f=p(d,u);for(let _=0;_<h.length;++_)h[_]||(h[_]=f[_])}return h}[Symbol.iterator](){return this.criteria.values()}}class o extends i{constructor(d,u=null){super(),this.max_length=d,this.max_position_embeddings=u}_call(d){return d.map(u=>u.length>=this.max_length)}}class a extends i{constructor(d){super(),Array.isArray(d)||(d=[d]),this.eos_token_id=d}_call(d,u){return d.map(h=>{let p=h.at(-1);return this.eos_token_id.some(f=>p==f)})}}class l extends i{constructor(){super(),this.interrupted=!1}interrupt(){this.interrupted=!0}reset(){this.interrupted=!1}_call(d,u){return new Array(d.length).fill(this.interrupted)}}},"./src/generation/streamers.js":(s,e,t)=>{t.r(e),t.d(e,{BaseStreamer:()=>o,TextStreamer:()=>l,WhisperTextStreamer:()=>c});var n=t("./src/utils/core.js"),i=t("./src/tokenizers.js"),r=t("./src/env.js");class o{put(u){throw Error("Not implemented")}end(){throw Error("Not implemented")}}let a=r.apis.IS_PROCESS_AVAILABLE?d=>process.stdout.write(d):d=>console.log(d);class l extends o{constructor(u,{skip_prompt:h=!1,callback_function:p=null,token_callback_function:f=null,skip_special_tokens:_=!0,decode_kwargs:b={},...y}={}){super(),this.tokenizer=u,this.skip_prompt=h,this.callback_function=p??a,this.token_callback_function=f,this.decode_kwargs={skip_special_tokens:_,...b,...y},this.token_cache=[],this.print_len=0,this.next_tokens_are_prompt=!0}put(u){if(u.length>1)throw Error("TextStreamer only supports batch size of 1");let h=this.next_tokens_are_prompt;if(h&&(this.next_tokens_are_prompt=!1,this.skip_prompt))return;let p=u[0];this.token_callback_function?.(p),this.token_cache=(0,n.mergeArrays)(this.token_cache,p);let f=this.tokenizer.decode(this.token_cache,this.decode_kwargs),_;h||f.endsWith(`
`)?(_=f.slice(this.print_len),this.token_cache=[],this.print_len=0):f.length>0&&(0,i.is_chinese_char)(f.charCodeAt(f.length-1))?(_=f.slice(this.print_len),this.print_len+=_.length):(_=f.slice(this.print_len,f.lastIndexOf(" ")+1),this.print_len+=_.length),this.on_finalized_text(_,!1)}end(){let u;this.token_cache.length>0?(u=this.tokenizer.decode(this.token_cache,this.decode_kwargs).slice(this.print_len),this.token_cache=[],this.print_len=0):u="",this.next_tokens_are_prompt=!0,this.on_finalized_text(u,!0)}on_finalized_text(u,h){u.length>0&&this.callback_function?.(u),h&&this.callback_function===a&&r.apis.IS_PROCESS_AVAILABLE&&this.callback_function?.(`
`)}}class c extends l{constructor(u,{skip_prompt:h=!1,callback_function:p=null,token_callback_function:f=null,on_chunk_start:_=null,on_chunk_end:b=null,on_finalize:y=null,time_precision:w=.02,skip_special_tokens:C=!0,decode_kwargs:M={}}={}){super(u,{skip_prompt:h,skip_special_tokens:C,callback_function:p,token_callback_function:f,decode_kwargs:M}),this.timestamp_begin=u.timestamp_begin,this.on_chunk_start=_,this.on_chunk_end=b,this.on_finalize=y,this.time_precision=w,this.waiting_for_timestamp=!1}put(u){if(u.length>1)throw Error("WhisperTextStreamer only supports batch size of 1");let h=u[0];if(h.length===1){let p=Number(h[0])-this.timestamp_begin;if(p>=0){let f=p*this.time_precision;this.waiting_for_timestamp?this.on_chunk_end?.(f):this.on_chunk_start?.(f),this.waiting_for_timestamp=!this.waiting_for_timestamp,this.token_callback_function?.(h);return}}return super.put(u)}end(){super.end(),this.on_finalize?.()}}},"./src/models.js":(s,e,t)=>{t.r(e),t.d(e,{ASTForAudioClassification:()=>yb,ASTModel:()=>_b,ASTPreTrainedModel:()=>Th,AlbertForMaskedLM:()=>pt,AlbertForQuestionAnswering:()=>it,AlbertForSequenceClassification:()=>ct,AlbertModel:()=>nt,AlbertPreTrainedModel:()=>Ne,ArceeForCausalLM:()=>Rb,ArceeModel:()=>$a,ArceePreTrainedModel:()=>vs,AutoModel:()=>kC,AutoModelForAudioClassification:()=>fB,AutoModelForAudioFrameClassification:()=>gB,AutoModelForAudioTextToText:()=>xB,AutoModelForCTC:()=>pB,AutoModelForCausalLM:()=>nB,AutoModelForDepthEstimation:()=>bB,AutoModelForDocumentQuestionAnswering:()=>_B,AutoModelForImageClassification:()=>oB,AutoModelForImageFeatureExtraction:()=>TB,AutoModelForImageMatting:()=>yB,AutoModelForImageSegmentation:()=>aB,AutoModelForImageTextToText:()=>EB,AutoModelForImageToImage:()=>vB,AutoModelForMaskGeneration:()=>hB,AutoModelForMaskedLM:()=>sB,AutoModelForNormalEstimation:()=>wB,AutoModelForObjectDetection:()=>dB,AutoModelForPoseEstimation:()=>MB,AutoModelForQuestionAnswering:()=>iB,AutoModelForSemanticSegmentation:()=>lB,AutoModelForSeq2SeqLM:()=>J$,AutoModelForSequenceClassification:()=>X$,AutoModelForSpeechSeq2Seq:()=>Z$,AutoModelForTextToSpectrogram:()=>eB,AutoModelForTextToWaveform:()=>tB,AutoModelForTokenClassification:()=>Q$,AutoModelForUniversalSegmentation:()=>cB,AutoModelForVision2Seq:()=>rB,AutoModelForXVector:()=>mB,AutoModelForZeroShotObjectDetection:()=>uB,BartForConditionalGeneration:()=>On,BartForSequenceClassification:()=>ys,BartModel:()=>ir,BartPretrainedModel:()=>Ss,BaseModelOutput:()=>Ce,BeitForImageClassification:()=>mL,BeitModel:()=>fL,BeitPreTrainedModel:()=>VS,BertForMaskedLM:()=>De,BertForQuestionAnswering:()=>Se,BertForSequenceClassification:()=>Ee,BertForTokenClassification:()=>ze,BertModel:()=>Ve,BertPreTrainedModel:()=>Fe,BlenderbotForConditionalGeneration:()=>hs,BlenderbotModel:()=>rs,BlenderbotPreTrainedModel:()=>Qn,BlenderbotSmallForConditionalGeneration:()=>Na,BlenderbotSmallModel:()=>Pi,BlenderbotSmallPreTrainedModel:()=>Wn,BloomForCausalLM:()=>O2,BloomModel:()=>N2,BloomPreTrainedModel:()=>kS,CLIPModel:()=>Ch,CLIPPreTrainedModel:()=>to,CLIPSegForImageSegmentation:()=>sd,CLIPSegModel:()=>rr,CLIPSegPreTrainedModel:()=>Ol,CLIPTextModel:()=>Pb,CLIPTextModelWithProjection:()=>Mm,CLIPVisionModel:()=>kb,CLIPVisionModelWithProjection:()=>Tm,CamembertForMaskedLM:()=>ye,CamembertForQuestionAnswering:()=>wt,CamembertForSequenceClassification:()=>Le,CamembertForTokenClassification:()=>ht,CamembertModel:()=>ae,CamembertPreTrainedModel:()=>ee,CausalLMOutput:()=>Bl,CausalLMOutputWithPast:()=>LY,ChineseCLIPModel:()=>nd,ChineseCLIPPreTrainedModel:()=>Sm,ClapAudioModelWithProjection:()=>DO,ClapModel:()=>kO,ClapPreTrainedModel:()=>Ub,ClapTextModelWithProjection:()=>IO,CodeGenForCausalLM:()=>Q,CodeGenModel:()=>W,CodeGenPreTrainedModel:()=>B,CohereForCausalLM:()=>m2,CohereModel:()=>f2,CoherePreTrainedModel:()=>bS,ConvBertForMaskedLM:()=>Rt,ConvBertForQuestionAnswering:()=>Uo,ConvBertForSequenceClassification:()=>zo,ConvBertForTokenClassification:()=>In,ConvBertModel:()=>Da,ConvBertPreTrainedModel:()=>sr,ConvNextForImageClassification:()=>cN,ConvNextModel:()=>lN,ConvNextPreTrainedModel:()=>sC,ConvNextV2ForImageClassification:()=>uN,ConvNextV2Model:()=>dN,ConvNextV2PreTrainedModel:()=>iC,DFineForObjectDetection:()=>AL,DFineModel:()=>CL,DFinePreTrainedModel:()=>KS,DINOv3ConvNextModel:()=>vN,DINOv3ConvNextPreTrainedModel:()=>yN,DINOv3ViTModel:()=>_N,DINOv3ViTPreTrainedModel:()=>gN,DPTForDepthEstimation:()=>WL,DPTModel:()=>GL,DPTPreTrainedModel:()=>eC,DacDecoderModel:()=>b$,DacDecoderOutput:()=>_$,DacEncoderModel:()=>v$,DacEncoderOutput:()=>g$,DacModel:()=>y$,DacPreTrainedModel:()=>Kb,DebertaForMaskedLM:()=>ut,DebertaForQuestionAnswering:()=>Fn,DebertaForSequenceClassification:()=>Nt,DebertaForTokenClassification:()=>hn,DebertaModel:()=>Lt,DebertaPreTrainedModel:()=>rt,DebertaV2ForMaskedLM:()=>Fs,DebertaV2ForQuestionAnswering:()=>Vo,DebertaV2ForSequenceClassification:()=>js,DebertaV2ForTokenClassification:()=>Qr,DebertaV2Model:()=>Hs,DebertaV2PreTrainedModel:()=>ns,DecisionTransformerModel:()=>ZO,DecisionTransformerPreTrainedModel:()=>JO,DeiTForImageClassification:()=>RL,DeiTModel:()=>DL,DeiTPreTrainedModel:()=>XS,DepthAnythingForDepthEstimation:()=>jL,DepthAnythingPreTrainedModel:()=>HL,DepthProForDepthEstimation:()=>QL,DepthProPreTrainedModel:()=>XL,DetrForObjectDetection:()=>_L,DetrForSegmentation:()=>GS,DetrModel:()=>gL,DetrObjectDetectionOutput:()=>WS,DetrPreTrainedModel:()=>Fb,DetrSegmentationOutput:()=>yL,Dinov2ForImageClassification:()=>pN,Dinov2Model:()=>hN,Dinov2PreTrainedModel:()=>rC,Dinov2WithRegistersForImageClassification:()=>mN,Dinov2WithRegistersModel:()=>fN,Dinov2WithRegistersPreTrainedModel:()=>oC,DistilBertForMaskedLM:()=>Xn,DistilBertForQuestionAnswering:()=>Ai,DistilBertForSequenceClassification:()=>Pr,DistilBertForTokenClassification:()=>si,DistilBertModel:()=>Ra,DistilBertPreTrainedModel:()=>us,DonutSwinModel:()=>aN,DonutSwinPreTrainedModel:()=>oN,EdgeTamModel:()=>kN,EfficientNetForImageClassification:()=>BO,EfficientNetModel:()=>$O,EfficientNetPreTrainedModel:()=>bC,ElectraForMaskedLM:()=>zi,ElectraForQuestionAnswering:()=>q,ElectraForSequenceClassification:()=>F,ElectraForTokenClassification:()=>ie,ElectraModel:()=>Kt,ElectraPreTrainedModel:()=>Bi,Ernie4_5ForCausalLM:()=>xO,Ernie4_5Model:()=>EO,Ernie4_5PreTrainedModel:()=>mC,EsmForMaskedLM:()=>Go,EsmForSequenceClassification:()=>Wo,EsmForTokenClassification:()=>Ho,EsmModel:()=>Jr,EsmPreTrainedModel:()=>ss,ExaoneForCausalLM:()=>s2,ExaoneModel:()=>n2,ExaonePreTrainedModel:()=>fS,FalconForCausalLM:()=>PO,FalconModel:()=>AO,FalconPreTrainedModel:()=>_C,FastViTForImageClassification:()=>sL,FastViTModel:()=>nL,FastViTPreTrainedModel:()=>OS,Florence2ForConditionalGeneration:()=>Tb,Florence2PreTrainedModel:()=>Mb,GLPNForDepthEstimation:()=>rN,GLPNModel:()=>iN,GLPNPreTrainedModel:()=>nC,GPT2LMHeadModel:()=>km,GPT2Model:()=>Pm,GPT2PreTrainedModel:()=>id,GPTBigCodeForCausalLM:()=>I,GPTBigCodeModel:()=>x,GPTBigCodePreTrainedModel:()=>Fh,GPTJForCausalLM:()=>Lm,GPTJModel:()=>Fm,GPTJPreTrainedModel:()=>Rh,GPTNeoForCausalLM:()=>rd,GPTNeoModel:()=>Dm,GPTNeoPreTrainedModel:()=>Ih,GPTNeoXForCausalLM:()=>Rm,GPTNeoXModel:()=>Dh,GPTNeoXPreTrainedModel:()=>od,Gemma2ForCausalLM:()=>v2,Gemma2Model:()=>y2,Gemma2PreTrainedModel:()=>MS,Gemma3ForCausalLM:()=>T2,Gemma3Model:()=>M2,Gemma3PreTrainedModel:()=>ES,Gemma3nForConditionalGeneration:()=>bm,Gemma3nPreTrainedModel:()=>Cb,GemmaForCausalLM:()=>_2,GemmaModel:()=>g2,GemmaPreTrainedModel:()=>wS,GlmForCausalLM:()=>t2,GlmModel:()=>e2,GlmPreTrainedModel:()=>pS,GraniteForCausalLM:()=>u2,GraniteModel:()=>d2,GraniteMoeHybridForCausalLM:()=>p2,GraniteMoeHybridModel:()=>h2,GraniteMoeHybridPreTrainedModel:()=>vS,GranitePreTrainedModel:()=>yS,GroundingDinoForObjectDetection:()=>wN,GroundingDinoPreTrainedModel:()=>bN,GroupViTModel:()=>tL,GroupViTPreTrainedModel:()=>eL,HeliumForCausalLM:()=>ZF,HeliumModel:()=>JF,HeliumPreTrainedModel:()=>hS,HieraForImageClassification:()=>LL,HieraModel:()=>FL,HieraPreTrainedModel:()=>QS,HubertForCTC:()=>sO,HubertForSequenceClassification:()=>iO,HubertModel:()=>nO,HubertPreTrainedModel:()=>wY,IJepaForImageClassification:()=>H2,IJepaModel:()=>W2,IJepaPreTrainedModel:()=>FS,Idefics3ForConditionalGeneration:()=>eo,Idefics3PreTrainedModel:()=>td,ImageMattingOutput:()=>CB,JAISLMHeadModel:()=>Im,JAISModel:()=>kh,JAISPreTrainedModel:()=>Ph,JinaCLIPModel:()=>Db,JinaCLIPPreTrainedModel:()=>xt,JinaCLIPTextModel:()=>Cm,JinaCLIPVisionModel:()=>Am,Lfm2ForCausalLM:()=>YF,Lfm2Model:()=>KF,Lfm2PreTrainedModel:()=>dS,LiteWhisperForConditionalGeneration:()=>vb,Llama4ForCausalLM:()=>vt,Llama4PreTrainedModel:()=>lt,LlamaForCausalLM:()=>qe,LlamaModel:()=>Be,LlamaPreTrainedModel:()=>ge,LlavaForConditionalGeneration:()=>Nl,LlavaOnevisionForConditionalGeneration:()=>ym,LlavaPreTrainedModel:()=>_m,LlavaQwen2ForCausalLM:()=>vm,LongT5ForConditionalGeneration:()=>qs,LongT5Model:()=>Cn,LongT5PreTrainedModel:()=>Gn,M2M100ForConditionalGeneration:()=>LN,M2M100Model:()=>FN,M2M100PreTrainedModel:()=>cC,MBartForCausalLM:()=>Ir,MBartForConditionalGeneration:()=>Zr,MBartForSequenceClassification:()=>Ns,MBartModel:()=>Ui,MBartPreTrainedModel:()=>Ls,MPNetForMaskedLM:()=>jo,MPNetForQuestionAnswering:()=>ve,MPNetForSequenceClassification:()=>La,MPNetForTokenClassification:()=>ed,MPNetModel:()=>Fa,MPNetPreTrainedModel:()=>kn,MT5ForConditionalGeneration:()=>_s,MT5Model:()=>is,MT5PreTrainedModel:()=>gs,MarianMTModel:()=>RN,MarianModel:()=>DN,MarianPreTrainedModel:()=>lC,MaskFormerForInstanceSegmentation:()=>sN,MaskFormerModel:()=>nN,MaskFormerPreTrainedModel:()=>tC,MaskedLMOutput:()=>Os,Metric3DForDepthEstimation:()=>ZL,Metric3DPreTrainedModel:()=>JL,Metric3Dv2ForDepthEstimation:()=>tN,Metric3Dv2PreTrainedModel:()=>eN,MgpstrForSceneTextRecognition:()=>i$,MgpstrModelOutput:()=>n$,MgpstrPreTrainedModel:()=>s$,MimiDecoderModel:()=>m$,MimiDecoderOutput:()=>h$,MimiEncoderModel:()=>f$,MimiEncoderOutput:()=>u$,MimiModel:()=>p$,MimiPreTrainedModel:()=>qb,Ministral3ForCausalLM:()=>TO,Ministral3Model:()=>MO,Ministral3PreTrainedModel:()=>fC,MinistralForCausalLM:()=>wO,MinistralModel:()=>bO,MinistralPreTrainedModel:()=>pC,Mistral3ForConditionalGeneration:()=>Sb,MistralForCausalLM:()=>vO,MistralModel:()=>yO,MistralPreTrainedModel:()=>hC,MobileBertForMaskedLM:()=>Ke,MobileBertForQuestionAnswering:()=>_t,MobileBertForSequenceClassification:()=>tt,MobileBertModel:()=>mi,MobileBertPreTrainedModel:()=>kr,MobileLLMForCausalLM:()=>r2,MobileLLMModel:()=>i2,MobileLLMPreTrainedModel:()=>mS,MobileNetV1ForImageClassification:()=>UO,MobileNetV1ForSemanticSegmentation:()=>VO,MobileNetV1Model:()=>zO,MobileNetV1PreTrainedModel:()=>Gb,MobileNetV2ForImageClassification:()=>WO,MobileNetV2ForSemanticSegmentation:()=>HO,MobileNetV2Model:()=>GO,MobileNetV2PreTrainedModel:()=>Wb,MobileNetV3ForImageClassification:()=>qO,MobileNetV3ForSemanticSegmentation:()=>KO,MobileNetV3Model:()=>jO,MobileNetV3PreTrainedModel:()=>Hb,MobileNetV4ForImageClassification:()=>XO,MobileNetV4ForSemanticSegmentation:()=>QO,MobileNetV4Model:()=>YO,MobileNetV4PreTrainedModel:()=>jb,MobileViTForImageClassification:()=>aL,MobileViTModel:()=>oL,MobileViTPreTrainedModel:()=>$S,MobileViTV2ForImageClassification:()=>cL,MobileViTV2Model:()=>lL,MobileViTV2PreTrainedModel:()=>BS,ModelOutput:()=>pe,ModernBertDecoderForCausalLM:()=>un,ModernBertDecoderModel:()=>rn,ModernBertDecoderPreTrainedModel:()=>zt,ModernBertForMaskedLM:()=>Qe,ModernBertForSequenceClassification:()=>Pt,ModernBertForTokenClassification:()=>st,ModernBertModel:()=>at,ModernBertPreTrainedModel:()=>We,Moondream1ForConditionalGeneration:()=>wb,MoonshineForConditionalGeneration:()=>bb,MoonshineModel:()=>cS,MoonshinePreTrainedModel:()=>xh,MptForCausalLM:()=>B2,MptModel:()=>$2,MptPreTrainedModel:()=>IS,MultiModalityCausalLM:()=>t$,MultiModalityPreTrainedModel:()=>e$,MusicgenForCausalLM:()=>xY,MusicgenForConditionalGeneration:()=>MC,MusicgenModel:()=>EY,MusicgenPreTrainedModel:()=>wC,NanoChatForCausalLM:()=>En,NanoChatModel:()=>cn,NanoChatPreTrainedModel:()=>Vt,NeoBertForMaskedLM:()=>Ge,NeoBertForQuestionAnswering:()=>gt,NeoBertForSequenceClassification:()=>Ye,NeoBertForTokenClassification:()=>Xe,NeoBertModel:()=>et,NeoBertPreTrainedModel:()=>$e,NomicBertModel:()=>_n,NomicBertPreTrainedModel:()=>ds,OPTForCausalLM:()=>U2,OPTModel:()=>z2,OPTPreTrainedModel:()=>DS,Olmo2ForCausalLM:()=>c2,Olmo2Model:()=>l2,Olmo2PreTrainedModel:()=>_S,OlmoForCausalLM:()=>a2,OlmoModel:()=>o2,OlmoPreTrainedModel:()=>gS,OpenELMForCausalLM:()=>x2,OpenELMModel:()=>E2,OpenELMPreTrainedModel:()=>xS,OwlViTForObjectDetection:()=>uL,OwlViTModel:()=>dL,OwlViTPreTrainedModel:()=>zS,Owlv2ForObjectDetection:()=>pL,Owlv2Model:()=>hL,Owlv2PreTrainedModel:()=>US,PaliGemmaForConditionalGeneration:()=>xb,PaliGemmaPreTrainedModel:()=>Eb,ParakeetForCTC:()=>UN,ParakeetPreTrainedModel:()=>zN,PatchTSMixerForPrediction:()=>l$,PatchTSMixerModel:()=>a$,PatchTSMixerPreTrainedModel:()=>EC,PatchTSTForPrediction:()=>o$,PatchTSTModel:()=>r$,PatchTSTPreTrainedModel:()=>TC,Phi3ForCausalLM:()=>L2,Phi3Model:()=>F2,Phi3PreTrainedModel:()=>PS,Phi3VForCausalLM:()=>wm,Phi3VPreTrainedModel:()=>Ab,PhiForCausalLM:()=>R2,PhiModel:()=>D2,PhiPreTrainedModel:()=>AS,PreTrainedModel:()=>U,PretrainedMixin:()=>yn,PvtForImageClassification:()=>Y2,PvtModel:()=>K2,PvtPreTrainedModel:()=>LS,PyAnnoteForAudioFrameClassification:()=>GN,PyAnnoteModel:()=>VN,PyAnnotePreTrainedModel:()=>dC,QuestionAnsweringModelOutput:()=>ii,Qwen2ForCausalLM:()=>C2,Qwen2Model:()=>S2,Qwen2PreTrainedModel:()=>SS,Qwen2VLForConditionalGeneration:()=>I2,Qwen2VLPreTrainedModel:()=>k2,Qwen3ForCausalLM:()=>P2,Qwen3Model:()=>A2,Qwen3PreTrainedModel:()=>CS,RFDetrForObjectDetection:()=>xL,RFDetrModel:()=>EL,RFDetrObjectDetectionOutput:()=>SL,RFDetrPreTrainedModel:()=>qS,RTDetrForObjectDetection:()=>bL,RTDetrModel:()=>vL,RTDetrObjectDetectionOutput:()=>Nm,RTDetrPreTrainedModel:()=>HS,RTDetrV2ForObjectDetection:()=>ML,RTDetrV2Model:()=>wL,RTDetrV2ObjectDetectionOutput:()=>TL,RTDetrV2PreTrainedModel:()=>jS,ResNetForImageClassification:()=>OL,ResNetModel:()=>NL,ResNetPreTrainedModel:()=>JS,RoFormerForMaskedLM:()=>Dl,RoFormerForQuestionAnswering:()=>Ws,RoFormerForSequenceClassification:()=>Rl,RoFormerForTokenClassification:()=>Yn,RoFormerModel:()=>Ia,RoFormerPreTrainedModel:()=>xs,RobertaForMaskedLM:()=>ob,RobertaForQuestionAnswering:()=>lb,RobertaForSequenceClassification:()=>hm,RobertaForTokenClassification:()=>ab,RobertaModel:()=>rb,RobertaPreTrainedModel:()=>qo,Sam2ImageSegmentationOutput:()=>AN,Sam2Model:()=>Ob,Sam2PreTrainedModel:()=>PN,Sam3TrackerModel:()=>IN,SamImageSegmentationOutput:()=>CN,SamModel:()=>SN,SamPreTrainedModel:()=>xN,SapiensForDepthEstimation:()=>KL,SapiensForNormalEstimation:()=>YL,SapiensForSemanticSegmentation:()=>qL,SapiensPreTrainedModel:()=>Nb,SegformerForImageClassification:()=>FO,SegformerForSemanticSegmentation:()=>LO,SegformerModel:()=>TY,SegformerPreTrainedModel:()=>Vb,Seq2SeqLMOutput:()=>FY,SequenceClassifierOutput:()=>Gt,SiglipModel:()=>Em,SiglipPreTrainedModel:()=>Ah,SiglipTextModel:()=>Ib,SiglipVisionModel:()=>xm,SmolLM3ForCausalLM:()=>QF,SmolLM3Model:()=>XF,SmolLM3PreTrainedModel:()=>uS,SmolVLMForConditionalGeneration:()=>Sh,SnacDecoderModel:()=>T$,SnacEncoderModel:()=>M$,SnacModel:()=>w$,SnacPreTrainedModel:()=>Yb,SpeechT5ForSpeechToText:()=>hO,SpeechT5ForTextToSpeech:()=>pO,SpeechT5HifiGan:()=>fO,SpeechT5Model:()=>MY,SpeechT5PreTrainedModel:()=>zb,SqueezeBertForMaskedLM:()=>le,SqueezeBertForQuestionAnswering:()=>_e,SqueezeBertForSequenceClassification:()=>me,SqueezeBertModel:()=>J,SqueezeBertPreTrainedModel:()=>$,StableLmForCausalLM:()=>OO,StableLmModel:()=>NO,StableLmPreTrainedModel:()=>vC,Starcoder2ForCausalLM:()=>CO,Starcoder2Model:()=>SO,Starcoder2PreTrainedModel:()=>gC,StyleTextToSpeech2Model:()=>uO,StyleTextToSpeech2PreTrainedModel:()=>dO,SupertonicForConditionalGeneration:()=>uC,SupertonicPreTrainedModel:()=>mO,Swin2SRForImageSuperResolution:()=>VL,Swin2SRModel:()=>UL,Swin2SRPreTrainedModel:()=>ZS,SwinForImageClassification:()=>BL,SwinForSemanticSegmentation:()=>zL,SwinModel:()=>$L,SwinPreTrainedModel:()=>Lb,T5ForConditionalGeneration:()=>ln,T5Model:()=>pn,T5PreTrainedModel:()=>Bt,TableTransformerForObjectDetection:()=>kL,TableTransformerModel:()=>PL,TableTransformerObjectDetectionOutput:()=>IL,TableTransformerPreTrainedModel:()=>YS,TokenClassifierOutput:()=>Cs,TrOCRForCausalLM:()=>_O,TrOCRPreTrainedModel:()=>gO,UltravoxModel:()=>xC,UltravoxPreTrainedModel:()=>c$,UniSpeechForCTC:()=>qN,UniSpeechForSequenceClassification:()=>KN,UniSpeechModel:()=>jN,UniSpeechPreTrainedModel:()=>$b,UniSpeechSatForAudioFrameClassification:()=>JN,UniSpeechSatForCTC:()=>XN,UniSpeechSatForSequenceClassification:()=>QN,UniSpeechSatModel:()=>YN,UniSpeechSatPreTrainedModel:()=>Om,VaultGemmaForCausalLM:()=>w2,VaultGemmaModel:()=>b2,VaultGemmaPreTrainedModel:()=>TS,ViTForImageClassification:()=>G2,ViTMAEModel:()=>Q2,ViTMAEPreTrainedModel:()=>X2,ViTMSNForImageClassification:()=>Z2,ViTMSNModel:()=>J2,ViTMSNPreTrainedModel:()=>NS,ViTModel:()=>V2,ViTPreTrainedModel:()=>RS,VisionEncoderDecoderModel:()=>gm,VitMatteForImageMatting:()=>rL,VitMattePreTrainedModel:()=>iL,VitPoseForPoseEstimation:()=>q2,VitPosePreTrainedModel:()=>j2,VitsModel:()=>yC,VitsModelOutput:()=>AB,VitsPreTrainedModel:()=>RO,VoxtralForConditionalGeneration:()=>d$,Wav2Vec2BertForCTC:()=>eO,Wav2Vec2BertForSequenceClassification:()=>tO,Wav2Vec2BertModel:()=>ZN,Wav2Vec2BertPreTrainedModel:()=>Bb,Wav2Vec2ForAudioFrameClassification:()=>BN,Wav2Vec2ForCTC:()=>ON,Wav2Vec2ForSequenceClassification:()=>$N,Wav2Vec2Model:()=>NN,Wav2Vec2PreTrainedModel:()=>$l,WavLMForAudioFrameClassification:()=>cO,WavLMForCTC:()=>oO,WavLMForSequenceClassification:()=>aO,WavLMForXVector:()=>lO,WavLMModel:()=>rO,WavLMPreTrainedModel:()=>Lh,WeSpeakerResNetModel:()=>HN,WeSpeakerResNetPreTrainedModel:()=>WN,WhisperForConditionalGeneration:()=>Oa,WhisperModel:()=>mm,WhisperPreTrainedModel:()=>Eh,XLMForQuestionAnswering:()=>pb,XLMForSequenceClassification:()=>ub,XLMForTokenClassification:()=>hb,XLMModel:()=>cb,XLMPreTrainedModel:()=>Fl,XLMRobertaForMaskedLM:()=>mb,XLMRobertaForQuestionAnswering:()=>fm,XLMRobertaForSequenceClassification:()=>gb,XLMRobertaForTokenClassification:()=>pm,XLMRobertaModel:()=>fb,XLMRobertaPreTrainedModel:()=>Ll,XLMWithLMHeadModel:()=>db,XVectorOutput:()=>SB,YolosForObjectDetection:()=>TN,YolosModel:()=>MN,YolosObjectDetectionOutput:()=>EN,YolosPreTrainedModel:()=>aC});var n=t("./src/configs.js"),i=t("./src/backends/onnx.js"),r=t("./src/utils/dtypes.js"),o=t("./src/utils/generic.js"),a=t("./src/utils/core.js"),l=t("./src/utils/hub.js"),c=t("./src/utils/constants.js"),d=t("./src/generation/logits_process.js"),u=t("./src/generation/configuration_utils.js"),h=t("./src/utils/tensor.js"),p=t("./src/utils/image.js"),f=t("./src/utils/maths.js"),_=t("./src/generation/stopping_criteria.js"),b=t("./src/generation/logits_sampler.js"),y=t("./src/env.js"),w=t("./src/models/whisper/generation_whisper.js"),C=t("./src/models/whisper/common_whisper.js");let M={EncoderOnly:0,EncoderDecoder:1,Seq2Seq:2,Vision2Seq:3,DecoderOnly:4,MaskGeneration:5,ImageTextToText:6,Musicgen:7,MultiModality:8,Phi3V:9,AudioTextToText:10,AutoEncoder:11,ImageAudioTextToText:12,Supertonic:13},S=new Map,k=new Map,T=new Map;async function P(A,D,V){let he=V.config?.["transformers.js_config"]??{},Te=V.device??he.device;Te&&typeof Te!="string"&&(Te.hasOwnProperty(D)?Te=Te[D]:(console.warn(`device not specified for "${D}". Using the default device.`),Te=null));let Me=Te??(y.apis.IS_NODE_ENV?"cpu":"wasm"),ke=(0,i.deviceToExecutionProviders)(Me),He=he.device_config??{};He.hasOwnProperty(Me)&&(he={...he,...He[Me]});let Je=V.dtype??he.dtype;if(typeof Je!="string"&&(Je&&Je.hasOwnProperty(D)?Je=Je[D]:(Je=r.DEFAULT_DEVICE_DTYPE_MAPPING[Me]??r.DATA_TYPES.fp32,console.warn(`dtype not specified for "${D}". Using the default dtype (${Je}) for this device (${Me}).`))),Je===r.DATA_TYPES.auto){let en=he.dtype;typeof en!="string"&&(en=en?.[D]),en&&en!==r.DATA_TYPES.auto&&r.DATA_TYPES.hasOwnProperty(en)?Je=en:Je=r.DEFAULT_DEVICE_DTYPE_MAPPING[Me]??r.DATA_TYPES.fp32}let ot=Je;if(r.DEFAULT_DTYPE_SUFFIX_MAPPING.hasOwnProperty(ot)){if(ot===r.DATA_TYPES.fp16&&Me==="webgpu"&&!await(0,r.isWebGpuFp16Supported)())throw new Error(`The device (${Me}) does not support fp16.`)}else throw new Error(`Invalid dtype: ${ot}. Should be one of: ${Object.keys(r.DATA_TYPES).join(", ")}`);let Ct=he.kv_cache_dtype,Ot=Ct?typeof Ct=="string"?Ct:Ct[ot]??"float32":void 0;if(Ot&&!["float32","float16"].includes(Ot))throw new Error(`Invalid kv_cache_dtype: ${Ot}. Should be one of: float32, float16`);let Ut={dtype:ot,kv_cache_dtype:Ot,device:Me},Zt=r.DEFAULT_DTYPE_SUFFIX_MAPPING[ot],It=`${D}${Zt}.onnx`,Wt=`${V.subfolder??""}/${It}`,Mt={...V.session_options};Mt.executionProviders??(Mt.executionProviders=ke);let Xt=he.free_dimension_overrides;Xt?Mt.freeDimensionOverrides??(Mt.freeDimensionOverrides=Xt):Me.startsWith("webnn")&&!Mt.freeDimensionOverrides&&console.warn(`WebNN does not currently support dynamic shapes and requires 'free_dimension_overrides' to be set in config.json, preferably as a field within config["transformers.js_config"]["device_config"]["${Me}"]. When 'free_dimension_overrides' is not set, you may experience significant performance degradation.`);let fn=y.apis.IS_NODE_ENV&&y.env.useFSCache,Ln=(0,l.getModelFile)(A,Wt,!0,V,fn),$n=V.use_external_data_format??he.use_external_data_format,Hn=[];if($n){let en;typeof $n=="object"?$n.hasOwnProperty(It)?en=$n[It]:$n.hasOwnProperty(D)?en=$n[D]:en=!1:en=$n;let jn=+en;if(jn>l.MAX_EXTERNAL_DATA_CHUNKS)throw new Error(`The number of external data chunks (${jn}) exceeds the maximum allowed value (${l.MAX_EXTERNAL_DATA_CHUNKS}).`);for(let Ks=0;Ks<jn;++Ks){let Ko=`${It}_data${Ks===0?"":"_"+Ks}`,$m=`${V.subfolder??""}/${Ko}`;Hn.push(new Promise(async(ki,no)=>{let Oh=await(0,l.getModelFile)(A,$m,!0,V,fn);ki(Oh instanceof Uint8Array?{path:Ko,data:Oh}:Ko)}))}}else Mt.externalData!==void 0&&(Hn=Mt.externalData.map(async en=>{if(typeof en.data=="string"){let jn=await(0,l.getModelFile)(A,en.data,!0,V);return{...en,data:jn}}return en}));if(Hn.length>0){let en=await Promise.all(Hn);y.apis.IS_NODE_ENV||(Mt.externalData=en)}if(Me==="webgpu"){let en=(0,n.getCacheShapes)(V.config,{prefix:"present"});if(Object.keys(en).length>0&&!(0,i.isONNXProxy)()){let jn={};for(let Ks in en)jn[Ks]="gpu-buffer";Mt.preferredOutputLocation=jn}}return{buffer_or_path:await Ln,session_options:Mt,session_config:Ut}}async function R(A,D,V){return Object.fromEntries(await Promise.all(Object.keys(D).map(async he=>{let{buffer_or_path:Te,session_options:Me,session_config:ke}=await P(A,D[he],V),He=await(0,i.createInferenceSession)(Te,Me,ke);return[he,He]})))}async function O(A,D,V){return Object.fromEntries(await Promise.all(Object.keys(D).map(async he=>{let Te=await(0,l.getModelJSON)(A,D[he],!1,V);return[he,Te]})))}function H(A,D){let V=Object.create(null),he=[];for(let ke of A.inputNames){let He=D[ke];if(!(He instanceof h.Tensor)){he.push(ke);continue}V[ke]=(0,i.isONNXProxy)()?He.clone():He}if(he.length>0)throw new Error(`An error occurred during model execution: "Missing the following inputs: ${he.join(", ")}.`);let Te=Object.keys(D).length,Me=A.inputNames.length;if(Te>Me){let ke=Object.keys(D).filter(He=>!A.inputNames.includes(He));console.warn(`WARNING: Too many inputs were provided (${Te} > ${Me}). The following inputs will be ignored: "${ke.join(", ")}".`)}return V}async function X(A,D){let V=H(A,D);try{let he=Object.fromEntries(Object.entries(V).map(([Me,ke])=>[Me,ke.ort_tensor])),Te=await(0,i.runInferenceSession)(A,he);return z(Te)}catch(he){let Te=Object.fromEntries(Object.entries(V).map(([Me,ke])=>{let He={type:ke.type,dims:ke.dims,location:ke.location};return He.location!=="gpu-buffer"&&(He.data=ke.data),[Me,He]}));throw console.error(`An error occurred during model execution: "${he}".`),console.error("Inputs given to model:",Te),he}}function z(A){for(let D in A)(0,i.isONNXTensor)(A[D])?A[D]=new h.Tensor(A[D]):typeof A[D]=="object"&&z(A[D]);return A}function ne(A){if(A instanceof h.Tensor)return A;if(A.length===0)throw Error("items must be non-empty");if(Array.isArray(A[0])){if(A.some(D=>D.length!==A[0].length))throw Error("Unable to create tensor, you should probably activate truncation and/or padding with 'padding=True' and/or 'truncation=True' to have batched tensors with the same length.");return new h.Tensor("int64",BigInt64Array.from(A.flat().map(D=>BigInt(D))),[A.length,A[0].length])}else return new h.Tensor("int64",BigInt64Array.from(A.map(D=>BigInt(D))),[1,A.length])}function re(A){return new h.Tensor("bool",[A],[1])}async function Y(A,D){let{encoder_outputs:V,input_ids:he,decoder_input_ids:Te,...Me}=D;if(!V){let He=(0,a.pick)(D,A.sessions.model.inputNames);V=(await se(A,He)).last_hidden_state}return Me.input_ids=Te,Me.encoder_hidden_states=V,A.sessions.decoder_model_merged.inputNames.includes("encoder_attention_mask")&&(Me.encoder_attention_mask=D.attention_mask),await fe(A,Me,!0)}async function se(A,D){let V=A.sessions.model,he=(0,a.pick)(D,V.inputNames);if(V.inputNames.includes("inputs_embeds")&&!he.inputs_embeds){if(!D.input_ids)throw new Error("Both `input_ids` and `inputs_embeds` are missing in the model inputs.");he.inputs_embeds=await A.encode_text({input_ids:D.input_ids})}if(V.inputNames.includes("token_type_ids")&&!he.token_type_ids){if(!he.input_ids)throw new Error("Both `input_ids` and `token_type_ids` are missing in the model inputs.");he.token_type_ids=(0,h.zeros_like)(he.input_ids)}if(V.inputNames.includes("pixel_mask")&&!he.pixel_mask){if(!he.pixel_values)throw new Error("Both `pixel_values` and `pixel_mask` are missing in the model inputs.");let Te=he.pixel_values.dims;he.pixel_mask=(0,h.ones)([Te[0],Te[2],Te[3]])}return await X(V,he)}async function ue(A,D){let V=await A.encode(D);return await A.decode(V)}async function fe(A,D,V=!1){let he=A.sessions[V?"decoder_model_merged":"model"],{past_key_values:Te,...Me}=D;if(he.inputNames.includes("use_cache_branch")&&(Me.use_cache_branch=re(!!Te)),he.inputNames.includes("position_ids")&&Me.attention_mask&&!Me.position_ids){let He=["paligemma","gemma3_text","gemma3"].includes(A.config.model_type)?1:0;Me.position_ids=xe(Me,Te,He)}A.addPastKeyValues(Me,Te);let ke=(0,a.pick)(Me,he.inputNames);return await X(he,ke)}function Pe({modality_token_id:A,inputs_embeds:D,modality_features:V,input_ids:he,attention_mask:Te}){let Me=he.tolist().map(ot=>ot.reduce((Ct,Ot,Ut)=>(Ot==A&&Ct.push(Ut),Ct),[])),ke=Me.reduce((ot,Ct)=>ot+Ct.length,0),He=V.dims[0];if(ke!==He)throw new Error(`Number of tokens and features do not match: tokens: ${ke}, features ${He}`);let Je=0;for(let ot=0;ot<Me.length;++ot){let Ct=Me[ot],Ot=D[ot];for(let Ut=0;Ut<Ct.length;++Ut)Ot[Ct[Ut]].data.set(V[Je++].data)}return{inputs_embeds:D,attention_mask:Te}}function oe({image_token_id:A,inputs_embeds:D,image_features:V,input_ids:he,attention_mask:Te}){return Pe({modality_token_id:A,inputs_embeds:D,modality_features:V,input_ids:he,attention_mask:Te})}function te({audio_token_id:A,inputs_embeds:D,audio_features:V,input_ids:he,attention_mask:Te}){return Pe({modality_token_id:A,inputs_embeds:D,modality_features:V,input_ids:he,attention_mask:Te})}async function j(A,{encode_function:D,merge_function:V,modality_input_name:he,modality_output_name:Te,input_ids:Me=null,attention_mask:ke=null,position_ids:He=null,inputs_embeds:Je=null,past_key_values:ot=null,generation_config:Ct=null,logits_processor:Ot=null,...Ut}){let Zt=Ut[he];if(!Je){if(Je=await A.encode_text({input_ids:Me,...Ut}),Zt&&Me.dims[1]!==1){let Wt=await D({[he]:Zt,...Ut});({inputs_embeds:Je,attention_mask:ke}=V({[Te]:Wt,inputs_embeds:Je,input_ids:Me,attention_mask:ke}))}else if(ot&&Zt&&Me.dims[1]===1){let Wt=Me.dims[1],Mt=Object.values(ot)[0].dims.at(-2);ke=(0,h.cat)([(0,h.ones)([Me.dims[0],Mt]),ke.slice(null,[ke.dims[1]-Wt,ke.dims[1]])],1)}}if(!He&&A.config.model_type==="qwen2_vl"){let{image_grid_thw:Wt,video_grid_thw:Mt}=Ut;[He]=A.get_rope_index(Me,Wt,Mt,ke)}return await fe(A,{inputs_embeds:Je,past_key_values:ot,attention_mask:ke,position_ids:He,generation_config:Ct,logits_processor:Ot},!0)}async function G(A,D){return await j(A,{...D,modality_input_name:"audio_values",modality_output_name:"audio_features",encode_function:A.encode_audio.bind(A),merge_function:A._merge_input_ids_with_audio_features.bind(A)})}async function de(A,D){return await j(A,{...D,modality_input_name:"pixel_values",modality_output_name:"image_features",encode_function:A.encode_image.bind(A),merge_function:A._merge_input_ids_with_image_features.bind(A)})}function be(A,D=0){let[V,he]=A.dims,Te=A.data,Me=new BigInt64Array(Te.length);for(let ke=0;ke<V;++ke){let He=ke*he,Je=BigInt(D);for(let ot=0;ot<he;++ot){let Ct=He+ot;Te[Ct]===0n?Me[Ct]=BigInt(1):(Me[Ct]=Je,Je+=Te[Ct])}}return{data:Me,dims:A.dims}}function xe(A,D=null,V=0){let{input_ids:he,inputs_embeds:Te,attention_mask:Me}=A,{data:ke,dims:He}=be(Me,V),Je=new h.Tensor("int64",ke,He);if(D){let ot=-(he??Te).dims.at(1);Je=Je.slice(null,[ot,null])}return Je}function Oe(A,D,V,he){let Te=V.past_key_values?Object.values(V.past_key_values)[0].dims.at(-2):0;if(!V.attention_mask){let Me;for(let ke of["input_ids","inputs_embeds","position_ids"])if(V[ke]){Me=V[ke].dims;break}if(!Me)throw new Error("attention_mask is not provided, and unable to infer its shape from model inputs.");V.attention_mask=(0,h.ones)([Me[0],Te+Me[1]])}if(V.past_key_values){let{input_ids:Me,attention_mask:ke}=V;ke&&ke.dims[1]>Me.dims[1]||Te<Me.dims[1]&&(V.input_ids=Me.slice(null,[Te,null]))}return V}function je(A,D,V,he){return V.past_key_values&&(D=D.map(Te=>[Te.at(-1)])),{...V,decoder_input_ids:ne(D)}}function dt(A,...D){return A.config.is_encoder_decoder?je(A,...D):Oe(A,...D)}function Re(A,D,V,he){let Te=!!V.past_key_values;if(he.guidance_scale!==null&&he.guidance_scale>1&&(Te?V.input_ids=(0,h.cat)([V.input_ids,V.input_ids],0):(V.input_ids=(0,h.cat)([V.input_ids,(0,h.full_like)(V.input_ids,BigInt(he.pad_token_id))],0),V.attention_mask=(0,h.cat)([V.attention_mask,(0,h.full_like)(V.attention_mask,0n)],0))),(Te||!V.pixel_values)&&(V.pixel_values=(0,h.full)([0,0,3,384,384],1)),Te){let He=0>0?1:0,Je=1;V.images_seq_mask=new h.Tensor("bool",new Array(1).fill(!0).fill(!1,0,1),[Je,1]),V.images_emb_mask=new h.Tensor("bool",new Array(0).fill(!!He),[Je,1,0])}return V}class U extends o.Callable{constructor(V,he,Te){super();Z(this,"main_input_name","input_ids");Z(this,"forward_params",["input_ids","attention_mask"]);this.config=V,this.sessions=he,this.configs=Te;let Me=T.get(this.constructor),ke=S.get(Me);switch(this.can_generate=!1,this._forward=null,this._prepare_inputs_for_generation=null,ke){case M.DecoderOnly:this.can_generate=!0,this._forward=fe,this._prepare_inputs_for_generation=Oe;break;case M.Seq2Seq:case M.Vision2Seq:case M.Musicgen:this.can_generate=!0,this._forward=Y,this._prepare_inputs_for_generation=je;break;case M.EncoderDecoder:this._forward=Y;break;case M.ImageTextToText:this.can_generate=!0,this._forward=de,this._prepare_inputs_for_generation=dt;break;case M.AudioTextToText:this.can_generate=!0,this._forward=G,this._prepare_inputs_for_generation=dt;break;case M.Phi3V:case M.ImageAudioTextToText:this.can_generate=!0,this._prepare_inputs_for_generation=dt;break;case M.MultiModality:this.can_generate=!0,this._prepare_inputs_for_generation=Re;break;case M.AutoEncoder:this._forward=ue;break;default:this._forward=se;break}this.can_generate&&this.forward_params.push("past_key_values"),this.custom_config=this.config["transformers.js_config"]??{}}async dispose(){let V=[];for(let he of Object.values(this.sessions))he?.handler?.dispose&&V.push(he.handler.dispose());return await Promise.all(V)}static async from_pretrained(V,{progress_callback:he=null,config:Te=null,cache_dir:Me=null,local_files_only:ke=!1,revision:He="main",model_file_name:Je=null,subfolder:ot="onnx",device:Ct=null,dtype:Ot=null,use_external_data_format:Ut=null,session_options:Zt={}}={}){let It={progress_callback:he,config:Te,cache_dir:Me,local_files_only:ke,revision:He,model_file_name:Je,subfolder:ot,device:Ct,dtype:Ot,use_external_data_format:Ut,session_options:Zt},Wt=T.get(this),Mt=S.get(Wt);Te=It.config=await n.AutoConfig.from_pretrained(V,It);let Xt;if(Mt===M.DecoderOnly)Xt=await Promise.all([R(V,{model:It.model_file_name??"model"},It),O(V,{generation_config:"generation_config.json"},It)]);else if(Mt===M.Seq2Seq||Mt===M.Vision2Seq)Xt=await Promise.all([R(V,{model:"encoder_model",decoder_model_merged:"decoder_model_merged"},It),O(V,{generation_config:"generation_config.json"},It)]);else if(Mt===M.MaskGeneration)Xt=await Promise.all([R(V,{model:"vision_encoder",prompt_encoder_mask_decoder:"prompt_encoder_mask_decoder"},It)]);else if(Mt===M.EncoderDecoder)Xt=await Promise.all([R(V,{model:"encoder_model",decoder_model_merged:"decoder_model_merged"},It)]);else if(Mt===M.ImageTextToText){let fn={embed_tokens:"embed_tokens",vision_encoder:"vision_encoder",decoder_model_merged:"decoder_model_merged"};Te.is_encoder_decoder&&(fn.model="encoder_model"),Xt=await Promise.all([R(V,fn,It),O(V,{generation_config:"generation_config.json"},It)])}else if(Mt===M.AudioTextToText){let fn={embed_tokens:"embed_tokens",audio_encoder:"audio_encoder",decoder_model_merged:"decoder_model_merged"};Xt=await Promise.all([R(V,fn,It),O(V,{generation_config:"generation_config.json"},It)])}else if(Mt===M.ImageAudioTextToText){let fn={embed_tokens:"embed_tokens",audio_encoder:"audio_encoder",vision_encoder:"vision_encoder",decoder_model_merged:"decoder_model_merged"};Xt=await Promise.all([R(V,fn,It),O(V,{generation_config:"generation_config.json"},It)])}else if(Mt===M.Musicgen)Xt=await Promise.all([R(V,{model:"text_encoder",decoder_model_merged:"decoder_model_merged",encodec_decode:"encodec_decode"},It),O(V,{generation_config:"generation_config.json"},It)]);else if(Mt===M.MultiModality)Xt=await Promise.all([R(V,{prepare_inputs_embeds:"prepare_inputs_embeds",model:"language_model",lm_head:"lm_head",gen_head:"gen_head",gen_img_embeds:"gen_img_embeds",image_decode:"image_decode"},It),O(V,{generation_config:"generation_config.json"},It)]);else if(Mt===M.Phi3V)Xt=await Promise.all([R(V,{prepare_inputs_embeds:"prepare_inputs_embeds",model:"model",vision_encoder:"vision_encoder"},It),O(V,{generation_config:"generation_config.json"},It)]);else if(Mt===M.AutoEncoder)Xt=await Promise.all([R(V,{encoder_model:"encoder_model",decoder_model:"decoder_model"},It)]);else if(Mt===M.Supertonic)Xt=await Promise.all([R(V,{text_encoder:"text_encoder",latent_denoiser:"latent_denoiser",voice_decoder:"voice_decoder"},It)]);else{if(Mt!==M.EncoderOnly){let fn=Wt??Te?.model_type;fn!=="custom"&&console.warn(`Model type for '${fn}' not found, assuming encoder-only architecture. Please report this at ${c.GITHUB_ISSUE_URL}.`)}Xt=await Promise.all([R(V,{model:It.model_file_name??"model"},It)])}return new this(Te,...Xt)}async _call(V){return await this.forward(V)}async forward(V){return await this._forward(this,V)}get generation_config(){return this.configs?.generation_config??null}_get_logits_processor(V,he,Te=null){let Me=new d.LogitsProcessorList;if(V.repetition_penalty!==null&&V.repetition_penalty!==1&&Me.push(new d.RepetitionPenaltyLogitsProcessor(V.repetition_penalty)),V.no_repeat_ngram_size!==null&&V.no_repeat_ngram_size>0&&Me.push(new d.NoRepeatNGramLogitsProcessor(V.no_repeat_ngram_size)),V.bad_words_ids!==null&&Me.push(new d.NoBadWordsLogitsProcessor(V.bad_words_ids,V.eos_token_id)),V.min_length!==null&&V.eos_token_id!==null&&V.min_length>0&&Me.push(new d.MinLengthLogitsProcessor(V.min_length,V.eos_token_id)),V.min_new_tokens!==null&&V.eos_token_id!==null&&V.min_new_tokens>0&&Me.push(new d.MinNewTokensLengthLogitsProcessor(he,V.min_new_tokens,V.eos_token_id)),V.forced_bos_token_id!==null&&Me.push(new d.ForcedBOSTokenLogitsProcessor(V.forced_bos_token_id)),V.forced_eos_token_id!==null&&Me.push(new d.ForcedEOSTokenLogitsProcessor(V.max_length,V.forced_eos_token_id)),V.begin_suppress_tokens!==null){let ke=he>1||V.forced_bos_token_id===null?he:he+1;Me.push(new d.SuppressTokensAtBeginLogitsProcessor(V.begin_suppress_tokens,ke))}return V.guidance_scale!==null&&V.guidance_scale>1&&Me.push(new d.ClassifierFreeGuidanceLogitsProcessor(V.guidance_scale)),V.temperature===0&&V.do_sample&&(console.warn("`do_sample` changed to false because `temperature: 0` implies greedy sampling (always selecting the most likely token), which is incompatible with `do_sample: true`."),V.do_sample=!1),V.do_sample&&V.temperature!==null&&V.temperature!==1&&Me.push(new d.TemperatureLogitsWarper(V.temperature)),Te!==null&&Me.extend(Te),Me}_prepare_generation_config(V,he,Te=u.GenerationConfig){let Me={...this.config};for(let He of["decoder","generator","text_config"])He in Me&&Object.assign(Me,Me[He]);let ke=new Te(Me);return Object.assign(ke,this.generation_config??{}),V&&Object.assign(ke,V),he&&Object.assign(ke,(0,a.pick)(he,Object.getOwnPropertyNames(ke))),ke}_get_stopping_criteria(V,he=null){let Te=new _.StoppingCriteriaList;return V.max_length!==null&&Te.push(new _.MaxLengthCriteria(V.max_length,this.config.max_position_embeddings??null)),V.eos_token_id!==null&&Te.push(new _.EosTokenCriteria(V.eos_token_id)),he&&Te.extend(he),Te}_validate_model_class(){if(!this.can_generate){let V=[AC,PC,CC,SC],he=T.get(this.constructor),Te=new Set,Me=this.config.model_type;for(let He of V){let Je=He.get(Me);Je&&Te.add(Je[0])}let ke=`The current model class (${he}) is not compatible with \`.generate()\`, as it doesn't have a language model head.`;throw Te.size>0&&(ke+=` Please use the following class instead: ${[...Te].join(", ")}`),Error(ke)}}prepare_inputs_for_generation(...V){return this._prepare_inputs_for_generation(this,...V)}_update_model_kwargs_for_generation({generated_input_ids:V,outputs:he,model_inputs:Te,is_encoder_decoder:Me}){return Te.past_key_values=this.getPastKeyValues(he,Te.past_key_values),Te.input_ids=new h.Tensor("int64",V.flat(),[V.length,1]),Me?"decoder_attention_mask"in Te:Te.attention_mask=(0,h.cat)([Te.attention_mask,(0,h.ones)([Te.attention_mask.dims[0],1])],1),Te.position_ids=null,Te}_prepare_model_inputs({inputs:V,bos_token_id:he,model_kwargs:Te}){let Me=(0,a.pick)(Te,this.forward_params),ke=this.main_input_name;if(ke in Me){if(V)throw new Error("`inputs`: {inputs}` were passed alongside {input_name} which is not allowed. Make sure to either pass {inputs} or {input_name}=...")}else Me[ke]=V;return{inputs_tensor:Me[ke],model_inputs:Me,model_input_name:ke}}async _prepare_encoder_decoder_kwargs_for_generation({inputs_tensor:V,model_inputs:he,model_input_name:Te,generation_config:Me}){if(this.sessions.model.inputNames.includes("inputs_embeds")&&!he.inputs_embeds&&"_prepare_inputs_embeds"in this){let{input_ids:He,pixel_values:Je,attention_mask:ot,...Ct}=he,Ot=await this._prepare_inputs_embeds(he);he={...Ct,...(0,a.pick)(Ot,["inputs_embeds","attention_mask"])}}let{last_hidden_state:ke}=await se(this,he);if(Me.guidance_scale!==null&&Me.guidance_scale>1)ke=(0,h.cat)([ke,(0,h.full_like)(ke,0)],0),"attention_mask"in he&&(he.attention_mask=(0,h.cat)([he.attention_mask,(0,h.zeros_like)(he.attention_mask)],0));else if(he.decoder_input_ids){let He=ne(he.decoder_input_ids).dims[0];if(He!==ke.dims[0]){if(ke.dims[0]!==1)throw new Error(`The encoder outputs have a different batch size (${ke.dims[0]}) than the decoder inputs (${He}).`);ke=(0,h.cat)(Array.from({length:He},()=>ke),0)}}return he.encoder_outputs=ke,he}_prepare_decoder_input_ids_for_generation({batch_size:V,model_input_name:he,model_kwargs:Te,decoder_start_token_id:Me,bos_token_id:ke,generation_config:He}){let{decoder_input_ids:Je,...ot}=Te;if(!(Je instanceof h.Tensor)){if(Je)Array.isArray(Je[0])||(Je=Array.from({length:V},()=>Je));else if(Me??(Me=ke),this.config.model_type==="musicgen")Je=Array.from({length:V*this.config.decoder.num_codebooks},()=>[Me]);else if(Array.isArray(Me)){if(Me.length!==V)throw new Error(`\`decoder_start_token_id\` expcted to have length ${V} but got ${Me.length}`);Je=Me}else Je=Array.from({length:V},()=>[Me]);Je=ne(Je)}return Te.decoder_attention_mask=(0,h.ones_like)(Je),{input_ids:Je,model_inputs:ot}}async generate({inputs:V=null,generation_config:he=null,logits_processor:Te=null,stopping_criteria:Me=null,streamer:ke=null,...He}){this._validate_model_class(),he=this._prepare_generation_config(he,He);let{inputs_tensor:Je,model_inputs:ot,model_input_name:Ct}=this._prepare_model_inputs({inputs:V,model_kwargs:He}),Ot=this.config.is_encoder_decoder;Ot&&("encoder_outputs"in ot||(ot=await this._prepare_encoder_decoder_kwargs_for_generation({inputs_tensor:Je,model_inputs:ot,model_input_name:Ct,generation_config:he})));let Ut;Ot?{input_ids:Ut,model_inputs:ot}=this._prepare_decoder_input_ids_for_generation({batch_size:ot[Ct].dims.at(0),model_input_name:Ct,model_kwargs:ot,decoder_start_token_id:he.decoder_start_token_id,bos_token_id:he.bos_token_id,generation_config:he}):Ut=ot[Ct];let Zt=Ut.dims.at(-1);he.max_new_tokens!==null&&(he.max_length=Zt+he.max_new_tokens);let It=this._get_logits_processor(he,Zt,Te),Wt=this._get_stopping_criteria(he,Me),Mt=ot[Ct].dims.at(0),Xt=b.LogitsSampler.getSampler(he),fn=new Array(Mt).fill(0),Ln=Ut.tolist();ke&&ke.put(Ln);let $n,Hn={};for(;;){if(ot=this.prepare_inputs_for_generation(Ln,ot,he),$n=await this.forward(ot),he.output_attentions&&he.return_dict_in_generate){let ki=this.getAttentions($n);for(let no in ki)no in Hn||(Hn[no]=[]),Hn[no].push(ki[no])}let jn=$n.logits.slice(null,-1,null),Ks=It(Ln,jn),Ko=[];for(let ki=0;ki<Ks.dims.at(0);++ki){let no=Ks[ki],Oh=await Xt(no);for(let[Xb,Qb]of Oh){let Jb=BigInt(Xb);fn[ki]+=Qb,Ln[ki].push(Jb),Ko.push([Jb]);break}}if(ke&&ke.put(Ko),Wt(Ln).every(ki=>ki))break;ot=this._update_model_kwargs_for_generation({generated_input_ids:Ko,outputs:$n,model_inputs:ot,is_encoder_decoder:Ot})}ke&&ke.end();let bs=this.getPastKeyValues($n,ot.past_key_values,!0),en=new h.Tensor("int64",Ln.flat(),[Ln.length,Ln[0].length]);if(he.return_dict_in_generate)return{sequences:en,past_key_values:bs,...Hn};for(let jn of Object.values($n))jn.location==="gpu-buffer"&&jn.dispose();return en}getPastKeyValues(V,he,Te=!1){let Me=Object.create(null);for(let ke in V)if(ke.startsWith("present")){let He=ke.replace("present_conv","past_conv").replace("present","past_key_values"),Je=ke.includes("encoder");if(Je&&he?Me[He]=he[He]:Me[He]=V[ke],he&&(!Je||Te)){let ot=he[He];ot.location==="gpu-buffer"&&ot.dispose()}}return Me}getAttentions(V){let he={};for(let Te of["cross_attentions","encoder_attentions","decoder_attentions"])for(let Me in V)Me.startsWith(Te)&&(Te in he||(he[Te]=[]),he[Te].push(V[Me]));return he}addPastKeyValues(V,he){if(he)Object.assign(V,he);else{let Te=this.sessions.decoder_model_merged??this.sessions.model,Me=(V[this.main_input_name]??V.attention_mask)?.dims?.[0]??1,ke=Te?.config?.kv_cache_dtype??"float32",He=ke==="float16"?h.DataTypeMap.float16:h.DataTypeMap.float32,Je=(0,n.getCacheShapes)(this.config,{batch_size:Me});for(let ot in Je){let Ct=Je[ot].reduce((Ot,Ut)=>Ot*Ut,1);V[ot]=new h.Tensor(ke,new He(Ct),Je[ot])}}}async encode_image({pixel_values:V}){return(await X(this.sessions.vision_encoder,{pixel_values:V})).image_features}async encode_text({input_ids:V}){return(await X(this.sessions.embed_tokens,{input_ids:V})).inputs_embeds}async encode_audio({audio_values:V}){return(await X(this.sessions.audio_encoder,{audio_values:V})).audio_features}}class pe{}class Ce extends pe{constructor({last_hidden_state:D,hidden_states:V=null,attentions:he=null}){super(),this.last_hidden_state=D,this.hidden_states=V,this.attentions=he}}class Fe extends U{}class Ve extends Fe{}class De extends Fe{async _call(D){return new Os(await super._call(D))}}class Ee extends Fe{async _call(D){return new Gt(await super._call(D))}}class ze extends Fe{async _call(D){return new Cs(await super._call(D))}}class Se extends Fe{async _call(D){return new ii(await super._call(D))}}class $e extends U{}class et extends $e{}class Ge extends $e{async _call(D){return new Os(await super._call(D))}}class Ye extends $e{async _call(D){return new Gt(await super._call(D))}}class Xe extends $e{async _call(D){return new Cs(await super._call(D))}}class gt extends $e{async _call(D){return new ii(await super._call(D))}}class We extends U{}class at extends We{}class Qe extends We{async _call(D){return new Os(await super._call(D))}}class Pt extends We{async _call(D){return new Gt(await super._call(D))}}class st extends We{async _call(D){return new Cs(await super._call(D))}}class zt extends U{}class rn extends zt{}class un extends zt{}class ds extends U{}class _n extends ds{}class xs extends U{}class Ia extends xs{}class Dl extends xs{async _call(D){return new Os(await super._call(D))}}class Rl extends xs{async _call(D){return new Gt(await super._call(D))}}class Yn extends xs{async _call(D){return new Cs(await super._call(D))}}class Ws extends xs{async _call(D){return new ii(await super._call(D))}}class sr extends U{}class Da extends sr{}class Rt extends sr{async _call(D){return new Os(await super._call(D))}}class zo extends sr{async _call(D){return new Gt(await super._call(D))}}class In extends sr{async _call(D){return new Cs(await super._call(D))}}class Uo extends sr{async _call(D){return new ii(await super._call(D))}}class Bi extends U{}class Kt extends Bi{}class zi extends Bi{async _call(D){return new Os(await super._call(D))}}class F extends Bi{async _call(D){return new Gt(await super._call(D))}}class ie extends Bi{async _call(D){return new Cs(await super._call(D))}}class q extends Bi{async _call(D){return new ii(await super._call(D))}}class ee extends U{}class ae extends ee{}class ye extends ee{async _call(D){return new Os(await super._call(D))}}class Le extends ee{async _call(D){return new Gt(await super._call(D))}}class ht extends ee{async _call(D){return new Cs(await super._call(D))}}class wt extends ee{async _call(D){return new ii(await super._call(D))}}class rt extends U{}class Lt extends rt{}class ut extends rt{async _call(D){return new Os(await super._call(D))}}class Nt extends rt{async _call(D){return new Gt(await super._call(D))}}class hn extends rt{async _call(D){return new Cs(await super._call(D))}}class Fn extends rt{async _call(D){return new ii(await super._call(D))}}class ns extends U{}class Hs extends ns{}class Fs extends ns{async _call(D){return new Os(await super._call(D))}}class js extends ns{async _call(D){return new Gt(await super._call(D))}}class Qr extends ns{async _call(D){return new Cs(await super._call(D))}}class Vo extends ns{async _call(D){return new ii(await super._call(D))}}class us extends U{}class Ra extends us{}class Pr extends us{async _call(D){return new Gt(await super._call(D))}}class si extends us{async _call(D){return new Cs(await super._call(D))}}class Ai extends us{async _call(D){return new ii(await super._call(D))}}class Xn extends us{async _call(D){return new Os(await super._call(D))}}class ss extends U{}class Jr extends ss{}class Go extends ss{async _call(D){return new Os(await super._call(D))}}class Wo extends ss{async _call(D){return new Gt(await super._call(D))}}class Ho extends ss{async _call(D){return new Cs(await super._call(D))}}class kr extends U{}class mi extends kr{}class Ke extends kr{async _call(D){return new Os(await super._call(D))}}class tt extends kr{async _call(D){return new Gt(await super._call(D))}}class _t extends kr{async _call(D){return new ii(await super._call(D))}}class kn extends U{}class Fa extends kn{}class jo extends kn{async _call(D){return new Os(await super._call(D))}}class La extends kn{async _call(D){return new Gt(await super._call(D))}}class ed extends kn{async _call(D){return new Cs(await super._call(D))}}class ve extends kn{async _call(D){return new ii(await super._call(D))}}class $ extends U{}class J extends ${}class le extends ${async _call(D){return new Os(await super._call(D))}}class me extends ${async _call(D){return new Gt(await super._call(D))}}class _e extends ${async _call(D){return new ii(await super._call(D))}}class Ne extends U{}class nt extends Ne{}class ct extends Ne{async _call(D){return new Gt(await super._call(D))}}class it extends Ne{async _call(D){return new ii(await super._call(D))}}class pt extends Ne{async _call(D){return new Os(await super._call(D))}}class Bt extends U{constructor(){super(...arguments);Z(this,"forward_params",["input_ids","attention_mask","encoder_outputs","decoder_input_ids","decoder_attention_mask","past_key_values"])}}class pn extends Bt{}class ln extends Bt{}class Gn extends U{}class Cn extends Gn{}class qs extends Gn{}class gs extends U{}class is extends gs{}class _s extends gs{}class Ss extends U{}class ir extends Ss{}class On extends Ss{}class ys extends Ss{async _call(D){return new Gt(await super._call(D))}}class Ls extends U{}class Ui extends Ls{}class Zr extends Ls{}class Ns extends Ls{async _call(D){return new Gt(await super._call(D))}}class Ir extends Ls{}class Qn extends U{}class rs extends Qn{}class hs extends Qn{}class Wn extends U{}class Pi extends Wn{}class Na extends Wn{}class qo extends U{}class rb extends qo{}class ob extends qo{async _call(D){return new Os(await super._call(D))}}class hm extends qo{async _call(D){return new Gt(await super._call(D))}}class ab extends qo{async _call(D){return new Cs(await super._call(D))}}class lb extends qo{async _call(D){return new ii(await super._call(D))}}class Fl extends U{}class cb extends Fl{}class db extends Fl{async _call(D){return new Os(await super._call(D))}}class ub extends Fl{async _call(D){return new Gt(await super._call(D))}}class hb extends Fl{async _call(D){return new Cs(await super._call(D))}}class pb extends Fl{async _call(D){return new ii(await super._call(D))}}class Ll extends U{}class fb extends Ll{}class mb extends Ll{async _call(D){return new Os(await super._call(D))}}class gb extends Ll{async _call(D){return new Gt(await super._call(D))}}class pm extends Ll{async _call(D){return new Cs(await super._call(D))}}class fm extends Ll{async _call(D){return new ii(await super._call(D))}}class Th extends U{}class _b extends Th{}class yb extends Th{}class Eh extends U{constructor(){super(...arguments);Z(this,"requires_attention_mask",!1);Z(this,"main_input_name","input_features");Z(this,"forward_params",["input_features","attention_mask","decoder_input_ids","decoder_attention_mask","past_key_values"])}}class mm extends Eh{}class Oa extends Eh{_prepare_generation_config(D,V){return super._prepare_generation_config(D,V,w.WhisperGenerationConfig)}_retrieve_init_tokens(D){let V=[D.decoder_start_token_id],he=D.language,Te=D.task;if(D.is_multilingual){he||(console.warn("No language specified - defaulting to English (en)."),he="en");let ke=`<|${(0,C.whisper_language_to_code)(he)}|>`;V.push(D.lang_to_id[ke]),V.push(D.task_to_id[Te??"transcribe"])}else if(he||Te)throw new Error("Cannot specify `task` or `language` for an English-only model. If the model is intended to be multilingual, pass `is_multilingual=true` to generate, or update the generation config.");return!D.return_timestamps&&D.no_timestamps_token_id&&V.at(-1)!==D.no_timestamps_token_id?V.push(D.no_timestamps_token_id):D.return_timestamps&&V.at(-1)===D.no_timestamps_token_id&&(console.warn("<|notimestamps|> prompt token is removed from generation_config since `return_timestamps` is set to `true`."),V.pop()),V.filter(Me=>Me!=null)}async generate({inputs:D=null,generation_config:V=null,logits_processor:he=null,stopping_criteria:Te=null,...Me}){V=this._prepare_generation_config(V,Me);let ke=Me.decoder_input_ids??this._retrieve_init_tokens(V);if(V.return_timestamps&&(he??(he=new d.LogitsProcessorList),he.push(new d.WhisperTimeStampLogitsProcessor(V,ke))),V.begin_suppress_tokens&&(he??(he=new d.LogitsProcessorList),he.push(new d.SuppressTokensAtBeginLogitsProcessor(V.begin_suppress_tokens,ke.length))),V.return_token_timestamps){if(!V.alignment_heads)throw new Error("Model generation config has no `alignment_heads`, token-level timestamps not available. See https://gist.github.com/hollance/42e32852f24243b748ae6bc1f985b13a on how to add this property to the generation config.");V.task==="translate"&&console.warn("Token-level timestamps may not be reliable for task 'translate'."),V.output_attentions=!0,V.return_dict_in_generate=!0}let He=await super.generate({inputs:D,generation_config:V,logits_processor:he,decoder_input_ids:ke,...Me});return V.return_token_timestamps&&(He.token_timestamps=this._extract_token_timestamps(He,V.alignment_heads,V.num_frames)),He}_extract_token_timestamps(D,V,he=null,Te=.02){if(!D.cross_attentions)throw new Error("Model outputs must contain cross attentions to extract timestamps. This is most likely because the model was not exported with `output_attentions=True`.");he==null&&console.warn("`num_frames` has not been set, meaning the entire audio will be analyzed. This may lead to inaccurate token-level timestamps for short audios (< 30 seconds).");let Me=this.config.median_filter_width;Me===void 0&&(console.warn("Model config has no `median_filter_width`, using default value of 7."),Me=7);let ke=D.cross_attentions,He=Array.from({length:this.config.decoder_layers},(Wt,Mt)=>(0,h.cat)(ke.map(Xt=>Xt[Mt]),2)),Je=(0,h.stack)(V.map(([Wt,Mt])=>{if(Wt>=He.length)throw new Error(`Layer index ${Wt} is out of bounds for cross attentions (length ${He.length}).`);return he?He[Wt].slice(null,Mt,null,[0,he]):He[Wt].slice(null,Mt)})).transpose(1,0,2,3),[ot,Ct]=(0,h.std_mean)(Je,-2,0,!0),Ot=Je.clone();for(let Wt=0;Wt<Ot.dims[0];++Wt){let Mt=Ot[Wt];for(let Xt=0;Xt<Mt.dims[0];++Xt){let fn=Mt[Xt],Ln=ot[Wt][Xt][0].data,$n=Ct[Wt][Xt][0].data;for(let Hn=0;Hn<fn.dims[0];++Hn){let bs=fn[Hn].data;for(let en=0;en<bs.length;++en)bs[en]=(bs[en]-$n[en])/Ln[en];bs.set((0,f.medianFilter)(bs,Me))}}}let Ut=[(0,h.mean)(Ot,1)],Zt=D.sequences.dims,It=new h.Tensor("float32",new Float32Array(Zt[0]*Zt[1]),Zt);for(let Wt=0;Wt<Zt[0];++Wt){let Mt=Ut[Wt].neg().squeeze_(0),[Xt,fn]=(0,f.dynamic_time_warping)(Mt.tolist()),Ln=Array.from({length:Xt.length-1},(bs,en)=>Xt[en+1]-Xt[en]),$n=(0,a.mergeArrays)([1],Ln).map(bs=>!!bs),Hn=[];for(let bs=0;bs<$n.length;++bs)$n[bs]&&Hn.push(fn[bs]*Te);It[Wt].data.set(Hn,1)}return It}}class vb extends Oa{}class xh extends U{constructor(){super(...arguments);Z(this,"requires_attention_mask",!1);Z(this,"main_input_name","input_values");Z(this,"forward_params",["input_values","decoder_input_ids","past_key_values"])}}class cS extends xh{}class bb extends xh{}class gm extends U{constructor(){super(...arguments);Z(this,"main_input_name","pixel_values");Z(this,"forward_params",["pixel_values","decoder_input_ids","encoder_hidden_states","past_key_values"])}}class _m extends U{constructor(){super(...arguments);Z(this,"forward_params",["input_ids","attention_mask","pixel_values","position_ids","past_key_values"])}}class Nl extends _m{_merge_input_ids_with_image_features(D){let V=D.image_features.dims.at(-1),he=D.image_features.view(-1,V);return oe({image_token_id:this.config.image_token_index,...D,image_features:he})}}class ym extends Nl{}class wb extends Nl{}class Mb extends U{constructor(){super(...arguments);Z(this,"forward_params",["input_ids","inputs_embeds","attention_mask","pixel_values","encoder_outputs","decoder_input_ids","decoder_inputs_embeds","decoder_attention_mask","past_key_values"]);Z(this,"main_input_name","inputs_embeds")}}class Tb extends Mb{_merge_input_ids_with_image_features({inputs_embeds:D,image_features:V,input_ids:he,attention_mask:Te}){return{inputs_embeds:(0,h.cat)([V,D],1),attention_mask:(0,h.cat)([(0,h.ones)(V.dims.slice(0,2)),Te],1)}}async _prepare_inputs_embeds({input_ids:D,pixel_values:V,inputs_embeds:he,attention_mask:Te}){if(!D&&!V)throw new Error("Either `input_ids` or `pixel_values` should be provided.");let Me,ke;return D&&(Me=await this.encode_text({input_ids:D})),V&&(ke=await this.encode_image({pixel_values:V})),Me&&ke?{inputs_embeds:he,attention_mask:Te}=this._merge_input_ids_with_image_features({inputs_embeds:Me,image_features:ke,input_ids:D,attention_mask:Te}):he=Me||ke,{inputs_embeds:he,attention_mask:Te}}async forward({input_ids:D,pixel_values:V,attention_mask:he,decoder_input_ids:Te,decoder_attention_mask:Me,encoder_outputs:ke,past_key_values:He,inputs_embeds:Je,decoder_inputs_embeds:ot}){if(Je||({inputs_embeds:Je,attention_mask:he}=await this._prepare_inputs_embeds({input_ids:D,pixel_values:V,inputs_embeds:Je,attention_mask:he})),!ke){let{last_hidden_state:Ut}=await se(this,{inputs_embeds:Je,attention_mask:he});ke=Ut}if(!ot){if(!Te)throw new Error("Either `decoder_input_ids` or `decoder_inputs_embeds` should be provided.");ot=await this.encode_text({input_ids:Te})}return await fe(this,{inputs_embeds:ot,attention_mask:Me,encoder_attention_mask:he,encoder_hidden_states:ke,past_key_values:He},!0)}}class Eb extends U{constructor(){super(...arguments);Z(this,"forward_params",["input_ids","attention_mask","pixel_values","position_ids","past_key_values"])}}class xb extends Eb{_merge_input_ids_with_image_features(D){let V=D.image_features.dims.at(-1),he=D.image_features.view(-1,V);return oe({image_token_id:this.config.image_token_index,...D,image_features:he})}}class vm extends _m{_merge_input_ids_with_image_features(D){let V=D.image_features.dims.at(-1),he=D.image_features.view(-1,V);return oe({image_token_id:this.config.image_token_index,...D,image_features:he})}}class Sb extends vm{}class Cb extends U{constructor(){super(...arguments);Z(this,"forward_params",["input_ids","attention_mask","inputs_embeds","per_layer_inputs","position_ids","pixel_values","input_features","input_features_mask","past_key_values"])}}class bm extends Cb{async forward({input_ids:D=null,attention_mask:V=null,pixel_values:he=null,input_features:Te=null,input_features_mask:Me=null,position_ids:ke=null,inputs_embeds:He=null,per_layer_inputs:Je=null,past_key_values:ot=null,generation_config:Ct=null,logits_processor:Ot=null,...Ut}){if((!He||!Je)&&({inputs_embeds:He,per_layer_inputs:Je}=await X(this.sessions.embed_tokens,{input_ids:D}),D.dims[1]!==1)){if(he){let{image_features:It}=await X(this.sessions.vision_encoder,{pixel_values:he});({inputs_embeds:He,attention_mask:V}=this._merge_input_ids_with_image_features({image_features:It,inputs_embeds:He,input_ids:D,attention_mask:V}))}if(Te){let{audio_features:It}=await X(this.sessions.audio_encoder,{input_features:Te,input_features_mask:Me});({inputs_embeds:He,attention_mask:V}=this._merge_input_ids_with_audio_features({audio_features:It,inputs_embeds:He,input_ids:D,attention_mask:V}))}}return await fe(this,{inputs_embeds:He,per_layer_inputs:Je,past_key_values:ot,attention_mask:V,position_ids:ke,generation_config:Ct,logits_processor:Ot},!0)}_merge_input_ids_with_image_features(D){let V=D.image_features.dims.at(-1),he=D.image_features.view(-1,V);return oe({image_token_id:this.config.image_token_id,...D,image_features:he})}_merge_input_ids_with_audio_features(D){let V=D.audio_features.dims.at(-1),he=D.audio_features.view(-1,V);return te({audio_token_id:this.config.audio_token_id,...D,audio_features:he})}}class td extends U{constructor(){super(...arguments);Z(this,"forward_params",["input_ids","attention_mask","pixel_values","pixel_attention_mask","position_ids","past_key_values"])}}class eo extends td{async encode_image({pixel_values:D,pixel_attention_mask:V}){return(await X(this.sessions.vision_encoder,{pixel_values:D,pixel_attention_mask:V})).image_features}_merge_input_ids_with_image_features(D){let V=D.image_features.dims.at(-1),he=D.image_features.view(-1,V);return oe({image_token_id:this.config.image_token_id,...D,image_features:he})}}class Sh extends eo{}class Ab extends U{constructor(){super(...arguments);Z(this,"forward_params",["input_ids","inputs_embeds","attention_mask","position_ids","pixel_values","image_sizes","past_key_values"])}}class wm extends Ab{async forward({input_ids:D=null,attention_mask:V=null,pixel_values:he=null,image_sizes:Te=null,position_ids:Me=null,inputs_embeds:ke=null,past_key_values:He=null,generation_config:Je=null,logits_processor:ot=null,...Ct}){if(!ke){let Ut;if(he&&D.dims[1]!==1){if(!Te)throw new Error("`image_sizes` must be provided when `pixel_values` is provided.");({image_features:Ut}=await X(this.sessions.vision_encoder,{pixel_values:he,image_sizes:Te}))}else{let Zt=this.config.normalized_config.hidden_size;Ut=new h.Tensor("float32",[],[0,Zt])}({inputs_embeds:ke}=await X(this.sessions.prepare_inputs_embeds,{input_ids:D,image_features:Ut}))}return await fe(this,{inputs_embeds:ke,past_key_values:He,attention_mask:V,position_ids:Me,generation_config:Je,logits_processor:ot},!1)}}class to extends U{}class Ch extends to{}class Pb extends to{static async from_pretrained(D,V={}){return super.from_pretrained(D,{...V,model_file_name:V.model_file_name??"text_model"})}}class Mm extends to{static async from_pretrained(D,V={}){return super.from_pretrained(D,{...V,model_file_name:V.model_file_name??"text_model"})}}class kb extends to{static async from_pretrained(D,V={}){return super.from_pretrained(D,{...V,model_file_name:V.model_file_name??"vision_model"})}}class Tm extends to{static async from_pretrained(D,V={}){return super.from_pretrained(D,{...V,model_file_name:V.model_file_name??"vision_model"})}}class Ah extends U{}class Em extends Ah{}class Ib extends Ah{static async from_pretrained(D,V={}){return super.from_pretrained(D,{...V,model_file_name:V.model_file_name??"text_model"})}}class xm extends to{static async from_pretrained(D,V={}){return super.from_pretrained(D,{...V,model_file_name:V.model_file_name??"vision_model"})}}class Sm extends U{}class nd extends Sm{}class xt extends U{}class Db extends xt{async forward(D){let V=!D.input_ids,he=!D.pixel_values;if(V&&he)throw new Error("Either `input_ids` or `pixel_values` should be provided.");if(V&&(D.input_ids=(0,h.ones)([D.pixel_values.dims[0],1])),he){let{image_size:ot}=this.config.vision_config;D.pixel_values=(0,h.full)([0,3,ot,ot],0)}let{text_embeddings:Te,image_embeddings:Me,l2norm_text_embeddings:ke,l2norm_image_embeddings:He}=await super.forward(D),Je={};return V||(Je.text_embeddings=Te,Je.l2norm_text_embeddings=ke),he||(Je.image_embeddings=Me,Je.l2norm_image_embeddings=He),Je}}class Cm extends xt{static async from_pretrained(D,V={}){return super.from_pretrained(D,{...V,model_file_name:V.model_file_name??"text_model"})}}class Am extends xt{static async from_pretrained(D,V={}){return super.from_pretrained(D,{...V,model_file_name:V.model_file_name??"vision_model"})}}class Ol extends U{}class rr extends Ol{}class sd extends Ol{}class id extends U{}class Pm extends id{}class km extends id{}class Ph extends U{}class kh extends Ph{}class Im extends Ph{}class Ih extends U{}class Dm extends Ih{}class rd extends Ih{}class od extends U{}class Dh extends od{}class Rm extends od{}class Rh extends U{}class Fm extends Rh{}class Lm extends Rh{}class Fh extends U{}class x extends Fh{}class I extends Fh{}class B extends U{}class W extends B{}class Q extends B{}class ge extends U{}class Be extends ge{}class qe extends ge{}class lt extends U{}class vt extends lt{}class Vt extends U{}class cn extends Vt{}class En extends Vt{}class vs extends U{}class $a extends vs{}class Rb extends vs{}class dS extends U{}class KF extends dS{}class YF extends dS{}class uS extends U{}class XF extends uS{}class QF extends uS{}class hS extends U{}class JF extends hS{}class ZF extends hS{}class pS extends U{}class e2 extends pS{}class t2 extends pS{}class fS extends U{}class n2 extends fS{}class s2 extends fS{}class mS extends U{}class i2 extends mS{}class r2 extends mS{}class gS extends U{}class o2 extends gS{}class a2 extends gS{}class _S extends U{}class l2 extends _S{}class c2 extends _S{}class yS extends U{}class d2 extends yS{}class u2 extends yS{}class vS extends U{}class h2 extends vS{}class p2 extends vS{}class bS extends U{}class f2 extends bS{}class m2 extends bS{}class wS extends U{}class g2 extends wS{}class _2 extends wS{}class MS extends U{}class y2 extends MS{}class v2 extends MS{}class TS extends U{}class b2 extends TS{}class w2 extends TS{}class ES extends U{}class M2 extends ES{}class T2 extends ES{}class xS extends U{}class E2 extends xS{}class x2 extends xS{}class SS extends U{}class S2 extends SS{}class C2 extends SS{}class CS extends U{}class A2 extends CS{}class P2 extends CS{}class k2 extends U{constructor(){super(...arguments);Z(this,"forward_params",["input_ids","attention_mask","position_ids","past_key_values","pixel_values","image_grid_thw"])}}class I2 extends k2{get_rope_index(D,V,he,Te){let{vision_config:Me,image_token_id:ke,video_token_id:He,vision_start_token_id:Je}=this.config,ot=Me.spatial_merge_size??2,Ct=[];if(V||he){let Ot=D.tolist();Te||(Te=(0,h.ones_like)(D));let Ut=Te.tolist(),Zt=Array.from({length:3},fn=>Array.from({length:D.dims[0]},Ln=>Array.from({length:D.dims[1]},$n=>1))),It=V?V.tolist():[],Wt=he?he.tolist():[],Mt=0,Xt=0;for(let fn=0;fn<Ot.length;++fn){let Ln=Ot[fn].filter((qn,As)=>Ut[fn][As]==1),Hn=Ln.reduce((qn,As,zl)=>(As==Je&&qn.push(zl),qn),[]).map(qn=>Ln[qn+1]),bs=Hn.filter(qn=>qn==ke).length,en=Hn.filter(qn=>qn==He).length,jn=[],Ks=0,Ko=bs,$m=en;for(let qn=0;qn<Hn.length;++qn){let As=Ln.findIndex((ld,so)=>so>Ks&&ld==ke),zl=Ln.findIndex((ld,so)=>so>Ks&&ld==He),ad=Ko>0&&As!==-1?As:Ln.length+1,$h=$m>0&&zl!==-1?zl:Ln.length+1,Zb,IC,DC,RC;ad<$h?([IC,DC,RC]=It[Mt],++Mt,--Ko,Zb=ad):([IC,DC,RC]=Wt[Xt],++Xt,--$m,Zb=$h);let[NY,FC,ew]=[Number(IC),Math.floor(Number(DC)/ot),Math.floor(Number(RC)/ot)],LC=Zb-Ks,PB=jn.length>0?(0,f.max)(jn.at(-1))[0]+1:0;jn.push(Array.from({length:3*LC},(ld,so)=>PB+so%LC));let NC=LC+PB,tw=NY*FC*ew,OY=Array.from({length:tw},(ld,so)=>NC+Math.floor(so/(FC*ew))),$Y=Array.from({length:tw},(ld,so)=>NC+Math.floor(so/ew)%FC),BY=Array.from({length:tw},(ld,so)=>NC+so%ew);jn.push([OY,$Y,BY].flat()),Ks=Zb+tw}if(Ks<Ln.length){let qn=jn.length>0?(0,f.max)(jn.at(-1))[0]+1:0,As=Ln.length-Ks;jn.push(Array.from({length:3*As},(zl,ad)=>qn+ad%As))}let ki=jn.reduce((qn,As)=>qn+As.length,0),no=new Array(ki),Oh=0;for(let qn=0;qn<3;++qn)for(let As=0;As<jn.length;++As){let zl=jn[As],ad=zl.length/3;for(let $h=qn*ad;$h<(qn+1)*ad;++$h)no[Oh++]=zl[$h]}let Xb=0,Qb=Ut[fn];for(let qn=0;qn<Qb.length;++qn)if(Qb[qn]==1){for(let As=0;As<3;++As)Zt[As][fn][qn]=no[As*ki/3+Xb];++Xb}let Jb=(0,f.max)(no)[0];Ct.push(Jb+1-Ot[fn].length)}return[new h.Tensor("int64",Zt.flat(1/0),[3,D.dims[0],D.dims[1]]),new h.Tensor("int64",Ct,[Ct.length,1])]}else if(Te){let{data:Ot,dims:Ut}=be(Te),Zt=BigInt64Array.from({length:3*Ot.length},(Wt,Mt)=>Ot[Mt%Ot.length]),It=Array.from({length:Ut[0]},(Wt,Mt)=>(0,f.max)(Ot.subarray(Ut[1]*Mt,Ut[1]*(Mt+1)))[0]+1n+BigInt(Ut[1]));return[new h.Tensor("int64",Zt,[3,...Ut]),new h.Tensor("int64",It,[It.length,1])]}else{let[Ot,Ut]=D.dims,Zt=BigInt64Array.from({length:3*Ot*Ut},(It,Wt)=>BigInt(Math.floor(Wt%Ut/Ot)));return[new h.Tensor("int64",Zt,[3,...D.dims]),(0,h.zeros)([Ot,1])]}}async encode_image({pixel_values:D,image_grid_thw:V}){return(await X(this.sessions.vision_encoder,{pixel_values:D,grid_thw:V})).image_features}_merge_input_ids_with_image_features(D){return oe({image_token_id:this.config.image_token_id,...D})}prepare_inputs_for_generation(D,V,he){if(V.attention_mask&&!V.position_ids)if(!V.past_key_values)[V.position_ids,V.rope_deltas]=this.get_rope_index(V.input_ids,V.image_grid_thw,V.video_grid_thw,V.attention_mask);else{V.pixel_values=null;let Te=BigInt(Object.values(V.past_key_values)[0].dims.at(-2)),Me=V.rope_deltas.map(ke=>Te+ke);V.position_ids=(0,h.stack)([Me,Me,Me],0)}return V}}class AS extends U{}class D2 extends AS{}class R2 extends AS{}class PS extends U{}class F2 extends PS{}class L2 extends PS{}class kS extends U{}class N2 extends kS{}class O2 extends kS{}class IS extends U{}class $2 extends IS{}class B2 extends IS{}class DS extends U{}class z2 extends DS{}class U2 extends DS{}class RS extends U{}class V2 extends RS{}class G2 extends RS{async _call(D){return new Gt(await super._call(D))}}class FS extends U{}class W2 extends FS{}class H2 extends FS{async _call(D){return new Gt(await super._call(D))}}class j2 extends U{}class q2 extends j2{}class LS extends U{}class K2 extends LS{}class Y2 extends LS{async _call(D){return new Gt(await super._call(D))}}class X2 extends U{}class Q2 extends X2{}class NS extends U{}class J2 extends NS{}class Z2 extends NS{async _call(D){return new Gt(await super._call(D))}}class eL extends U{}class tL extends eL{}class OS extends U{}class nL extends OS{}class sL extends OS{async _call(D){return new Gt(await super._call(D))}}class iL extends U{}class rL extends iL{async _call(D){return new CB(await super._call(D))}}class $S extends U{}class oL extends $S{}class aL extends $S{async _call(D){return new Gt(await super._call(D))}}class BS extends U{}class lL extends BS{}class cL extends BS{async _call(D){return new Gt(await super._call(D))}}class zS extends U{}class dL extends zS{}class uL extends zS{}class US extends U{}class hL extends US{}class pL extends US{}class VS extends U{}class fL extends VS{}class mL extends VS{async _call(D){return new Gt(await super._call(D))}}class Fb extends U{}class gL extends Fb{}class _L extends Fb{async _call(D){return new WS(await super._call(D))}}class GS extends Fb{async _call(D){return new yL(await super._call(D))}}class WS extends pe{constructor({logits:D,pred_boxes:V}){super(),this.logits=D,this.pred_boxes=V}}class yL extends pe{constructor({logits:D,pred_boxes:V,pred_masks:he}){super(),this.logits=D,this.pred_boxes=V,this.pred_masks=he}}class HS extends U{}class vL extends HS{}class bL extends HS{async _call(D){return new Nm(await super._call(D))}}class Nm extends pe{constructor({logits:D,pred_boxes:V}){super(),this.logits=D,this.pred_boxes=V}}class jS extends U{}class wL extends jS{}class ML extends jS{async _call(D){return new TL(await super._call(D))}}class TL extends Nm{}class qS extends U{}class EL extends qS{}class xL extends qS{async _call(D){return new SL(await super._call(D))}}class SL extends Nm{}class KS extends U{}class CL extends KS{}class AL extends KS{async _call(D){return new Nm(await super._call(D))}}class YS extends U{}class PL extends YS{}class kL extends YS{async _call(D){return new IL(await super._call(D))}}class IL extends WS{}class XS extends U{}class DL extends XS{}class RL extends XS{async _call(D){return new Gt(await super._call(D))}}class QS extends U{}class FL extends QS{}class LL extends QS{async _call(D){return new Gt(await super._call(D))}}class JS extends U{}class NL extends JS{}class OL extends JS{async _call(D){return new Gt(await super._call(D))}}class Lb extends U{}class $L extends Lb{}class BL extends Lb{async _call(D){return new Gt(await super._call(D))}}class zL extends Lb{}class ZS extends U{}class UL extends ZS{}class VL extends ZS{}class eC extends U{}class GL extends eC{}class WL extends eC{}class HL extends U{}class jL extends HL{}class Nb extends U{}class qL extends Nb{}class KL extends Nb{}class YL extends Nb{}class XL extends U{}class QL extends XL{}class JL extends U{}class ZL extends JL{}class eN extends U{}class tN extends eN{}class tC extends U{}class nN extends tC{}class sN extends tC{}class nC extends U{}class iN extends nC{}class rN extends nC{}class oN extends U{}class aN extends oN{}class sC extends U{}class lN extends sC{}class cN extends sC{async _call(D){return new Gt(await super._call(D))}}class iC extends U{}class dN extends iC{}class uN extends iC{async _call(D){return new Gt(await super._call(D))}}class rC extends U{}class hN extends rC{}class pN extends rC{async _call(D){return new Gt(await super._call(D))}}class oC extends U{}class fN extends oC{}class mN extends oC{async _call(D){return new Gt(await super._call(D))}}class gN extends U{}class _N extends gN{}class yN extends U{}class vN extends yN{}class bN extends U{}class wN extends bN{}class aC extends U{}class MN extends aC{}class TN extends aC{async _call(D){return new EN(await super._call(D))}}class EN extends pe{constructor({logits:D,pred_boxes:V}){super(),this.logits=D,this.pred_boxes=V}}class xN extends U{}class SN extends xN{async get_image_embeddings({pixel_values:D}){return await se(this,{pixel_values:D})}async forward(D){!D.image_embeddings||!D.image_positional_embeddings?D={...D,...await this.get_image_embeddings(D)}:D={...D},D.input_labels??(D.input_labels=(0,h.ones)(D.input_points.dims.slice(0,-1)));let V={image_embeddings:D.image_embeddings,image_positional_embeddings:D.image_positional_embeddings};return D.input_points&&(V.input_points=D.input_points),D.input_labels&&(V.input_labels=D.input_labels),D.input_boxes&&(V.input_boxes=D.input_boxes),await X(this.sessions.prompt_encoder_mask_decoder,V)}async _call(D){return new CN(await super._call(D))}}class CN extends pe{constructor({iou_scores:D,pred_masks:V}){super(),this.iou_scores=D,this.pred_masks=V}}class AN extends pe{constructor({iou_scores:D,pred_masks:V,object_score_logits:he}){super(),this.iou_scores=D,this.pred_masks=V,this.object_score_logits=he}}class PN extends U{}class Ob extends PN{async get_image_embeddings({pixel_values:D}){return await se(this,{pixel_values:D})}async forward(D){let{num_feature_levels:V}=this.config.vision_config;if(Array.from({length:V},(ke,He)=>`image_embeddings.${He}`).some(ke=>!D[ke])?D={...D,...await this.get_image_embeddings(D)}:D={...D},D.input_points){if(D.input_boxes&&D.input_boxes.dims[1]!==1)throw new Error("When both `input_points` and `input_boxes` are provided, the number of boxes per image must be 1.");let ke=D.input_points.dims;D.input_labels??(D.input_labels=(0,h.ones)(ke.slice(0,-1))),D.input_boxes??(D.input_boxes=(0,h.full)([ke[0],0,4],0))}else if(D.input_boxes){let ke=D.input_boxes.dims;D.input_labels=(0,h.full)([ke[0],ke[1],0],-1n),D.input_points=(0,h.full)([ke[0],1,0,2],0)}else throw new Error("At least one of `input_points` or `input_boxes` must be provided.");let Te=this.sessions.prompt_encoder_mask_decoder,Me=(0,a.pick)(D,Te.inputNames);return await X(Te,Me)}async _call(D){return new AN(await super._call(D))}}class kN extends Ob{}class IN extends Ob{}class lC extends U{}class DN extends lC{}class RN extends lC{}class cC extends U{}class FN extends cC{}class LN extends cC{}class $l extends U{}class NN extends $l{}class ON extends $l{async _call(D){return new Bl(await super._call(D))}}class $N extends $l{async _call(D){return new Gt(await super._call(D))}}class BN extends $l{async _call(D){return new Cs(await super._call(D))}}class zN extends U{}class UN extends zN{async _call(D){return new Bl(await super._call(D))}}class dC extends U{}class VN extends dC{}class GN extends dC{async _call(D){return new Cs(await super._call(D))}}class WN extends U{}class HN extends WN{}class $b extends U{}class jN extends $b{}class qN extends $b{async _call(D){return new Bl(await super._call(D))}}class KN extends $b{async _call(D){return new Gt(await super._call(D))}}class Om extends U{}class YN extends Om{}class XN extends Om{async _call(D){return new Bl(await super._call(D))}}class QN extends Om{async _call(D){return new Gt(await super._call(D))}}class JN extends Om{async _call(D){return new Cs(await super._call(D))}}class Bb extends U{}class ZN extends Bb{}class eO extends Bb{async _call(D){return new Bl(await super._call(D))}}class tO extends Bb{async _call(D){return new Gt(await super._call(D))}}class wY extends U{}class nO extends $l{}class sO extends $l{async _call(D){return new Bl(await super._call(D))}}class iO extends $l{async _call(D){return new Gt(await super._call(D))}}class Lh extends U{}class rO extends Lh{}class oO extends Lh{async _call(D){return new Bl(await super._call(D))}}class aO extends Lh{async _call(D){return new Gt(await super._call(D))}}class lO extends Lh{async _call(D){return new SB(await super._call(D))}}class cO extends Lh{async _call(D){return new Cs(await super._call(D))}}class dO extends U{}class uO extends dO{}class zb extends U{}class MY extends zb{}class hO extends zb{}class pO extends zb{async generate_speech(D,V,{threshold:he=.5,minlenratio:Te=0,maxlenratio:Me=20,vocoder:ke=null}={}){let He={input_ids:D},{encoder_outputs:Je,encoder_attention_mask:ot}=await se(this,He),Ct=Je.dims[1]/this.config.reduction_factor,Ot=Math.floor(Ct*Me),Ut=Math.floor(Ct*Te),Zt=this.config.num_mel_bins,It=[],Wt=null,Mt=null,Xt=0;for(;;){++Xt;let $n=re(!!Mt),Hn;Mt?Hn=Mt.output_sequence_out:Hn=new h.Tensor("float32",new Float32Array(Zt),[1,1,Zt]);let bs={use_cache_branch:$n,output_sequence:Hn,encoder_attention_mask:ot,speaker_embeddings:V,encoder_hidden_states:Je};this.addPastKeyValues(bs,Wt),Mt=await X(this.sessions.decoder_model_merged,bs),Wt=this.getPastKeyValues(Mt,Wt);let{prob:en,spectrum:jn}=Mt;if(It.push(jn),Xt>=Ut&&(Array.from(en.data).filter(Ks=>Ks>=he).length>0||Xt>=Ot))break}let fn=(0,h.cat)(It),{waveform:Ln}=await X(ke.sessions.model,{spectrogram:fn});return{spectrogram:fn,waveform:Ln}}}class fO extends U{constructor(){super(...arguments);Z(this,"main_input_name","spectrogram")}}class mO extends U{}class uC extends mO{async generate_speech({input_ids:D,attention_mask:V,style:he,num_inference_steps:Te=5,speed:Me=1.05}){let{sampling_rate:ke,chunk_compress_factor:He,base_chunk_size:Je,latent_dim:ot}=this.config,{last_hidden_state:Ct,durations:Ot}=await X(this.sessions.text_encoder,{input_ids:D,attention_mask:V,style:he});Ot.div_(Me);let Ut=Ot.max().item()*ke,Zt=Je*He,It=Math.floor((Ut+Zt-1)/Zt),Wt=D.dims[0],Mt=(0,h.ones)([Wt,It]),Xt=(0,h.full)([Wt],Te),fn=(0,h.randn)([Wt,ot*He,It]);for(let $n=0;$n<Te;++$n){let Hn=(0,h.full)([Wt],$n);({denoised_latents:fn}=await X(this.sessions.latent_denoiser,{style:he,noisy_latents:fn,latent_mask:Mt,encoder_outputs:Ct,attention_mask:V,timestep:Hn,num_inference_steps:Xt}))}let{waveform:Ln}=await X(this.sessions.voice_decoder,{latents:fn});return{waveform:Ln,durations:Ot}}}class gO extends U{}class _O extends gO{}class hC extends U{}class yO extends hC{}class vO extends hC{}class pC extends U{}class bO extends pC{}class wO extends pC{}class fC extends U{}class MO extends fC{}class TO extends fC{}class mC extends U{}class EO extends mC{}class xO extends mC{}class gC extends U{}class SO extends gC{}class CO extends gC{}class _C extends U{}class AO extends _C{}class PO extends _C{}class Ub extends U{}class kO extends Ub{}class IO extends Ub{static async from_pretrained(D,V={}){return super.from_pretrained(D,{...V,model_file_name:V.model_file_name??"text_model"})}}class DO extends Ub{static async from_pretrained(D,V={}){return super.from_pretrained(D,{...V,model_file_name:V.model_file_name??"audio_model"})}}class RO extends U{}class yC extends RO{async _call(D){return new AB(await super._call(D))}}class Vb extends U{}class TY extends Vb{}class FO extends Vb{}class LO extends Vb{}class vC extends U{}class NO extends vC{}class OO extends vC{}class bC extends U{}class $O extends bC{}class BO extends bC{async _call(D){return new Gt(await super._call(D))}}class wC extends U{}class EY extends wC{}class xY extends wC{}class MC extends U{constructor(){super(...arguments);Z(this,"forward_params",["input_ids","attention_mask","encoder_outputs","decoder_input_ids","decoder_attention_mask","past_key_values"])}_apply_and_filter_by_delay_pattern_mask(V){let[he,Te]=V.dims,Me=this.config.decoder.num_codebooks,ke=Te-Me,He=0;for(let Ct=0;Ct<V.size;++Ct){if(V.data[Ct]===this.config.decoder.pad_token_id)continue;let Ot=Ct%Te,Ut=Math.floor(Ct/Te)%Me,Zt=Ot-Ut;Zt>0&&Zt<=ke&&(V.data[He++]=V.data[Ct])}let Je=Math.floor(he/Me),ot=He/(Je*Me);return new h.Tensor(V.type,V.data.slice(0,He),[Je,Me,ot])}prepare_inputs_for_generation(V,he,Te){let Me=structuredClone(V);for(let He=0;He<Me.length;++He)for(let Je=0;Je<Me[He].length;++Je)He%this.config.decoder.num_codebooks>=Je&&(Me[He][Je]=BigInt(this.config.decoder.pad_token_id));return Te.guidance_scale!==null&&Te.guidance_scale>1&&(Me=Me.concat(Me)),super.prepare_inputs_for_generation(Me,he,Te)}async generate(V){let he=await super.generate(V),Te=this._apply_and_filter_by_delay_pattern_mask(he).unsqueeze_(0),{audio_values:Me}=await X(this.sessions.encodec_decode,{audio_codes:Te});return Me}}class Gb extends U{}class zO extends Gb{}class UO extends Gb{async _call(D){return new Gt(await super._call(D))}}class VO extends Gb{}class Wb extends U{}class GO extends Wb{}class WO extends Wb{async _call(D){return new Gt(await super._call(D))}}class HO extends Wb{}class Hb extends U{}class jO extends Hb{}class qO extends Hb{async _call(D){return new Gt(await super._call(D))}}class KO extends Hb{}class jb extends U{}class YO extends jb{}class XO extends jb{async _call(D){return new Gt(await super._call(D))}}class QO extends jb{}class JO extends U{}class ZO extends JO{}class e$ extends U{}class t$ extends e${constructor(...V){super(...V);Z(this,"forward_params",["input_ids","pixel_values","images_seq_mask","images_emb_mask","attention_mask","position_ids","past_key_values"]);this._generation_mode="text"}async forward(V){let he=this._generation_mode??"text",Te;if(he==="text"||!V.past_key_values){let ot=this.sessions.prepare_inputs_embeds,Ct=(0,a.pick)(V,ot.inputNames);Te=await X(ot,Ct)}else{let ot=this.sessions.gen_img_embeds,Ct=(0,a.pick)({image_ids:V.input_ids},ot.inputNames);Te=await X(ot,Ct)}let Me={...V,...Te},ke=await fe(this,Me),He=this.sessions[he==="text"?"lm_head":"gen_head"];if(!He)throw new Error(`Unable to find "${He}" generation head`);let Je=await X(He,(0,a.pick)(ke,He.inputNames));return{...Te,...ke,...Je}}async generate(V){return this._generation_mode="text",super.generate(V)}async generate_images(V){this._generation_mode="image";let he=(V.inputs??V[this.main_input_name]).dims[1],Me=(await super.generate(V)).slice(null,[he,null]),ke=this.sessions.image_decode,{decoded_image:He}=await X(ke,{generated_tokens:Me}),Je=He.add_(1).mul_(255/2).clamp_(0,255).to("uint8"),ot=[];for(let Ct of Je){let Ot=p.RawImage.fromTensor(Ct);ot.push(Ot)}return ot}}class n$ extends pe{constructor({char_logits:D,bpe_logits:V,wp_logits:he}){super(),this.char_logits=D,this.bpe_logits=V,this.wp_logits=he}get logits(){return[this.char_logits,this.bpe_logits,this.wp_logits]}}class s$ extends U{}class i$ extends s${async _call(D){return new n$(await super._call(D))}}class TC extends U{}class r$ extends TC{}class o$ extends TC{}class EC extends U{}class a$ extends EC{}class l$ extends EC{}class c$ extends U{constructor(){super(...arguments);Z(this,"forward_params",["input_ids","attention_mask","position_ids","audio_values","past_key_values"])}}class xC extends c${_merge_input_ids_with_audio_features(D){let V=D.audio_features.dims.at(-1),he=D.audio_features.view(-1,V);return te({audio_token_id:this.config.ignore_index??this.config.audio_token_id,...D,audio_features:he})}}class d$ extends xC{}class qb extends U{constructor(){super(...arguments);Z(this,"main_input_name","input_values");Z(this,"forward_params",["input_values"])}}class u$ extends pe{constructor({audio_codes:D}){super(),this.audio_codes=D}}class h$ extends pe{constructor({audio_values:D}){super(),this.audio_values=D}}class p$ extends qb{async encode(D){return new u$(await X(this.sessions.encoder_model,D))}async decode(D){return new h$(await X(this.sessions.decoder_model,D))}}class f$ extends qb{static async from_pretrained(D,V={}){return super.from_pretrained(D,{...V,model_file_name:V.model_file_name??"encoder_model"})}}class m$ extends qb{static async from_pretrained(D,V={}){return super.from_pretrained(D,{...V,model_file_name:V.model_file_name??"decoder_model"})}}class Kb extends U{constructor(){super(...arguments);Z(this,"main_input_name","input_values");Z(this,"forward_params",["input_values"])}}class g$ extends pe{constructor({audio_codes:D}){super(),this.audio_codes=D}}class _$ extends pe{constructor({audio_values:D}){super(),this.audio_values=D}}class y$ extends Kb{async encode(D){return new g$(await X(this.sessions.encoder_model,D))}async decode(D){return new _$(await X(this.sessions.decoder_model,D))}}class v$ extends Kb{static async from_pretrained(D,V={}){return super.from_pretrained(D,{...V,model_file_name:V.model_file_name??"encoder_model"})}}class b$ extends Kb{static async from_pretrained(D,V={}){return super.from_pretrained(D,{...V,model_file_name:V.model_file_name??"decoder_model"})}}class Yb extends U{constructor(){super(...arguments);Z(this,"main_input_name","input_values");Z(this,"forward_params",["input_values"])}}class w$ extends Yb{async encode(D){return await X(this.sessions.encoder_model,D)}async decode(D){return await X(this.sessions.decoder_model,D)}}class M$ extends Yb{static async from_pretrained(D,V={}){return super.from_pretrained(D,{...V,model_file_name:V.model_file_name??"encoder_model"})}}class T$ extends Yb{static async from_pretrained(D,V={}){return super.from_pretrained(D,{...V,model_file_name:V.model_file_name??"decoder_model"})}}class yn{static async from_pretrained(D,{progress_callback:V=null,config:he=null,cache_dir:Te=null,local_files_only:Me=!1,revision:ke="main",model_file_name:He=null,subfolder:Je="onnx",device:ot=null,dtype:Ct=null,use_external_data_format:Ot=null,session_options:Ut={}}={}){let Zt={progress_callback:V,config:he,cache_dir:Te,local_files_only:Me,revision:ke,model_file_name:He,subfolder:Je,device:ot,dtype:Ct,use_external_data_format:Ot,session_options:Ut};if(Zt.config=await n.AutoConfig.from_pretrained(D,Zt),!this.MODEL_CLASS_MAPPINGS)throw new Error("`MODEL_CLASS_MAPPINGS` not implemented for this type of `AutoClass`: "+this.name);let It=Zt.config.model_type;for(let Wt of this.MODEL_CLASS_MAPPINGS){let Mt=Wt.get(It);if(!Mt){for(let Xt of Wt.values())if(Xt[0]===It){Mt=Xt;break}if(!Mt)continue}return await Mt[1].from_pretrained(D,Zt)}if(this.BASE_IF_FAIL)return Y$.has(It)||console.warn(`Unknown model class "${It}", attempting to construct from base class.`),await U.from_pretrained(D,Zt);throw Error(`Unsupported model type: ${It}`)}}Z(yn,"MODEL_CLASS_MAPPINGS",null),Z(yn,"BASE_IF_FAIL",!1);let SY=new Map([["bert",["BertModel",Ve]],["neobert",["NeoBertModel",et]],["modernbert",["ModernBertModel",at]],["nomic_bert",["NomicBertModel",_n]],["roformer",["RoFormerModel",Ia]],["electra",["ElectraModel",Kt]],["esm",["EsmModel",Jr]],["convbert",["ConvBertModel",Da]],["camembert",["CamembertModel",ae]],["deberta",["DebertaModel",Lt]],["deberta-v2",["DebertaV2Model",Hs]],["mpnet",["MPNetModel",Fa]],["albert",["AlbertModel",nt]],["distilbert",["DistilBertModel",Ra]],["roberta",["RobertaModel",rb]],["xlm",["XLMModel",cb]],["xlm-roberta",["XLMRobertaModel",fb]],["clap",["ClapModel",kO]],["clip",["CLIPModel",Ch]],["clipseg",["CLIPSegModel",rr]],["chinese_clip",["ChineseCLIPModel",nd]],["siglip",["SiglipModel",Em]],["jina_clip",["JinaCLIPModel",Db]],["mobilebert",["MobileBertModel",mi]],["squeezebert",["SqueezeBertModel",J]],["wav2vec2",["Wav2Vec2Model",NN]],["wav2vec2-bert",["Wav2Vec2BertModel",ZN]],["unispeech",["UniSpeechModel",jN]],["unispeech-sat",["UniSpeechSatModel",YN]],["hubert",["HubertModel",nO]],["wavlm",["WavLMModel",rO]],["audio-spectrogram-transformer",["ASTModel",_b]],["vits",["VitsModel",yC]],["pyannote",["PyAnnoteModel",VN]],["wespeaker-resnet",["WeSpeakerResNetModel",HN]],["detr",["DetrModel",gL]],["rt_detr",["RTDetrModel",vL]],["rt_detr_v2",["RTDetrV2Model",wL]],["rf_detr",["RFDetrModel",EL]],["d_fine",["DFineModel",CL]],["table-transformer",["TableTransformerModel",PL]],["vit",["ViTModel",V2]],["ijepa",["IJepaModel",W2]],["pvt",["PvtModel",K2]],["vit_msn",["ViTMSNModel",J2]],["vit_mae",["ViTMAEModel",Q2]],["groupvit",["GroupViTModel",tL]],["fastvit",["FastViTModel",nL]],["mobilevit",["MobileViTModel",oL]],["mobilevitv2",["MobileViTV2Model",lL]],["owlvit",["OwlViTModel",dL]],["owlv2",["Owlv2Model",hL]],["beit",["BeitModel",fL]],["deit",["DeiTModel",DL]],["hiera",["HieraModel",FL]],["convnext",["ConvNextModel",lN]],["convnextv2",["ConvNextV2Model",dN]],["dinov2",["Dinov2Model",hN]],["dinov2_with_registers",["Dinov2WithRegistersModel",fN]],["dinov3_vit",["DINOv3ViTModel",_N]],["dinov3_convnext",["DINOv3ConvNextModel",vN]],["resnet",["ResNetModel",NL]],["swin",["SwinModel",$L]],["swin2sr",["Swin2SRModel",UL]],["donut-swin",["DonutSwinModel",aN]],["yolos",["YolosModel",MN]],["dpt",["DPTModel",GL]],["glpn",["GLPNModel",iN]],["hifigan",["SpeechT5HifiGan",fO]],["efficientnet",["EfficientNetModel",$O]],["decision_transformer",["DecisionTransformerModel",ZO]],["patchtst",["PatchTSTForPrediction",r$]],["patchtsmixer",["PatchTSMixerForPrediction",a$]],["mobilenet_v1",["MobileNetV1Model",zO]],["mobilenet_v2",["MobileNetV2Model",GO]],["mobilenet_v3",["MobileNetV3Model",jO]],["mobilenet_v4",["MobileNetV4Model",YO]],["maskformer",["MaskFormerModel",nN]],["mgp-str",["MgpstrForSceneTextRecognition",i$]],["style_text_to_speech_2",["StyleTextToSpeech2Model",uO]]]),CY=new Map([["t5",["T5Model",pn]],["longt5",["LongT5Model",Cn]],["mt5",["MT5Model",is]],["bart",["BartModel",ir]],["mbart",["MBartModel",Ui]],["marian",["MarianModel",DN]],["whisper",["WhisperModel",mm]],["m2m_100",["M2M100Model",FN]],["blenderbot",["BlenderbotModel",rs]],["blenderbot-small",["BlenderbotSmallModel",Pi]]]),AY=new Map([["mimi",["MimiModel",p$]],["dac",["DacModel",y$]],["snac",["SnacModel",w$]]]),PY=new Map([["bloom",["BloomModel",N2]],["jais",["JAISModel",kh]],["gpt2",["GPT2Model",Pm]],["gptj",["GPTJModel",Fm]],["gpt_bigcode",["GPTBigCodeModel",x]],["gpt_neo",["GPTNeoModel",Dm]],["gpt_neox",["GPTNeoXModel",Dh]],["codegen",["CodeGenModel",W]],["llama",["LlamaModel",Be]],["nanochat",["NanoChatModel",cn]],["arcee",["ArceeModel",$a]],["lfm2",["Lfm2Model",KF]],["smollm3",["SmolLM3Model",XF]],["exaone",["ExaoneModel",n2]],["olmo",["OlmoModel",o2]],["olmo2",["Olmo2Model",l2]],["mobilellm",["MobileLLMModel",i2]],["granite",["GraniteModel",d2]],["granitemoehybrid",["GraniteMoeHybridModel",h2]],["cohere",["CohereModel",f2]],["gemma",["GemmaModel",g2]],["gemma2",["Gemma2Model",y2]],["vaultgemma",["VaultGemmaModel",b2]],["gemma3_text",["Gemma3Model",M2]],["helium",["HeliumModel",JF]],["glm",["GlmModel",e2]],["openelm",["OpenELMModel",E2]],["qwen2",["Qwen2Model",S2]],["qwen3",["Qwen3Model",A2]],["phi",["PhiModel",D2]],["phi3",["Phi3Model",F2]],["mpt",["MptModel",$2]],["opt",["OPTModel",z2]],["mistral",["MistralModel",yO]],["ministral",["MinistralModel",bO]],["ministral3",["Ministral3Model",MO]],["ernie4_5",["Ernie4_5Model",EO]],["starcoder2",["Starcoder2Model",SO]],["falcon",["FalconModel",AO]],["stablelm",["StableLmModel",NO]],["modernbert-decoder",["ModernBertDecoderModel",rn]]]),SC=new Map([["speecht5",["SpeechT5ForSpeechToText",hO]],["whisper",["WhisperForConditionalGeneration",Oa]],["lite-whisper",["LiteWhisperForConditionalGeneration",vb]],["moonshine",["MoonshineForConditionalGeneration",bb]]]),E$=new Map([["speecht5",["SpeechT5ForTextToSpeech",pO]]]),x$=new Map([["vits",["VitsModel",yC]],["musicgen",["MusicgenForConditionalGeneration",MC]],["supertonic",["SupertonicForConditionalGeneration",uC]]]),S$=new Map([["bert",["BertForSequenceClassification",Ee]],["neobert",["NeoBertForSequenceClassification",Ye]],["modernbert",["ModernBertForSequenceClassification",Pt]],["roformer",["RoFormerForSequenceClassification",Rl]],["electra",["ElectraForSequenceClassification",F]],["esm",["EsmForSequenceClassification",Wo]],["convbert",["ConvBertForSequenceClassification",zo]],["camembert",["CamembertForSequenceClassification",Le]],["deberta",["DebertaForSequenceClassification",Nt]],["deberta-v2",["DebertaV2ForSequenceClassification",js]],["mpnet",["MPNetForSequenceClassification",La]],["albert",["AlbertForSequenceClassification",ct]],["distilbert",["DistilBertForSequenceClassification",Pr]],["roberta",["RobertaForSequenceClassification",hm]],["xlm",["XLMForSequenceClassification",ub]],["xlm-roberta",["XLMRobertaForSequenceClassification",gb]],["bart",["BartForSequenceClassification",ys]],["mbart",["MBartForSequenceClassification",Ns]],["mobilebert",["MobileBertForSequenceClassification",tt]],["squeezebert",["SqueezeBertForSequenceClassification",me]]]),C$=new Map([["bert",["BertForTokenClassification",ze]],["neobert",["NeoBertForTokenClassification",Xe]],["modernbert",["ModernBertForTokenClassification",st]],["roformer",["RoFormerForTokenClassification",Yn]],["electra",["ElectraForTokenClassification",ie]],["esm",["EsmForTokenClassification",Ho]],["convbert",["ConvBertForTokenClassification",In]],["camembert",["CamembertForTokenClassification",ht]],["deberta",["DebertaForTokenClassification",hn]],["deberta-v2",["DebertaV2ForTokenClassification",Qr]],["mpnet",["MPNetForTokenClassification",ed]],["distilbert",["DistilBertForTokenClassification",si]],["roberta",["RobertaForTokenClassification",ab]],["xlm",["XLMForTokenClassification",hb]],["xlm-roberta",["XLMRobertaForTokenClassification",pm]]]),CC=new Map([["t5",["T5ForConditionalGeneration",ln]],["longt5",["LongT5ForConditionalGeneration",qs]],["mt5",["MT5ForConditionalGeneration",_s]],["bart",["BartForConditionalGeneration",On]],["mbart",["MBartForConditionalGeneration",Zr]],["marian",["MarianMTModel",RN]],["m2m_100",["M2M100ForConditionalGeneration",LN]],["blenderbot",["BlenderbotForConditionalGeneration",hs]],["blenderbot-small",["BlenderbotSmallForConditionalGeneration",Na]]]),AC=new Map([["bloom",["BloomForCausalLM",O2]],["gpt2",["GPT2LMHeadModel",km]],["jais",["JAISLMHeadModel",Im]],["gptj",["GPTJForCausalLM",Lm]],["gpt_bigcode",["GPTBigCodeForCausalLM",I]],["gpt_neo",["GPTNeoForCausalLM",rd]],["gpt_neox",["GPTNeoXForCausalLM",Rm]],["codegen",["CodeGenForCausalLM",Q]],["llama",["LlamaForCausalLM",qe]],["nanochat",["NanoChatForCausalLM",En]],["llama4_text",["Llama4ForCausalLM",vt]],["arcee",["ArceeForCausalLM",Rb]],["lfm2",["Lfm2ForCausalLM",YF]],["smollm3",["SmolLM3ForCausalLM",QF]],["exaone",["ExaoneForCausalLM",s2]],["olmo",["OlmoForCausalLM",a2]],["olmo2",["Olmo2ForCausalLM",c2]],["mobilellm",["MobileLLMForCausalLM",r2]],["granite",["GraniteForCausalLM",u2]],["granitemoehybrid",["GraniteMoeHybridForCausalLM",p2]],["cohere",["CohereForCausalLM",m2]],["gemma",["GemmaForCausalLM",_2]],["gemma2",["Gemma2ForCausalLM",v2]],["vaultgemma",["VaultGemmaForCausalLM",w2]],["gemma3_text",["Gemma3ForCausalLM",T2]],["helium",["HeliumForCausalLM",ZF]],["glm",["GlmForCausalLM",t2]],["openelm",["OpenELMForCausalLM",x2]],["qwen2",["Qwen2ForCausalLM",C2]],["qwen3",["Qwen3ForCausalLM",P2]],["phi",["PhiForCausalLM",R2]],["phi3",["Phi3ForCausalLM",L2]],["mpt",["MptForCausalLM",B2]],["opt",["OPTForCausalLM",U2]],["mbart",["MBartForCausalLM",Ir]],["mistral",["MistralForCausalLM",vO]],["ministral",["MinistralForCausalLM",wO]],["ministral3",["Ministral3ForCausalLM",TO]],["ernie4_5",["Ernie4_5ForCausalLM",xO]],["starcoder2",["Starcoder2ForCausalLM",CO]],["falcon",["FalconForCausalLM",PO]],["trocr",["TrOCRForCausalLM",_O]],["stablelm",["StableLmForCausalLM",OO]],["modernbert-decoder",["ModernBertDecoderForCausalLM",un]],["phi3_v",["Phi3VForCausalLM",wm]]]),kY=new Map([["multi_modality",["MultiModalityCausalLM",t$]]]),A$=new Map([["bert",["BertForMaskedLM",De]],["neobert",["NeoBertForMaskedLM",Ge]],["modernbert",["ModernBertForMaskedLM",Qe]],["roformer",["RoFormerForMaskedLM",Dl]],["electra",["ElectraForMaskedLM",zi]],["esm",["EsmForMaskedLM",Go]],["convbert",["ConvBertForMaskedLM",Rt]],["camembert",["CamembertForMaskedLM",ye]],["deberta",["DebertaForMaskedLM",ut]],["deberta-v2",["DebertaV2ForMaskedLM",Fs]],["mpnet",["MPNetForMaskedLM",jo]],["albert",["AlbertForMaskedLM",pt]],["distilbert",["DistilBertForMaskedLM",Xn]],["roberta",["RobertaForMaskedLM",ob]],["xlm",["XLMWithLMHeadModel",db]],["xlm-roberta",["XLMRobertaForMaskedLM",mb]],["mobilebert",["MobileBertForMaskedLM",Ke]],["squeezebert",["SqueezeBertForMaskedLM",le]]]),P$=new Map([["bert",["BertForQuestionAnswering",Se]],["neobert",["NeoBertForQuestionAnswering",gt]],["roformer",["RoFormerForQuestionAnswering",Ws]],["electra",["ElectraForQuestionAnswering",q]],["convbert",["ConvBertForQuestionAnswering",Uo]],["camembert",["CamembertForQuestionAnswering",wt]],["deberta",["DebertaForQuestionAnswering",Fn]],["deberta-v2",["DebertaV2ForQuestionAnswering",Vo]],["mpnet",["MPNetForQuestionAnswering",ve]],["albert",["AlbertForQuestionAnswering",it]],["distilbert",["DistilBertForQuestionAnswering",Ai]],["roberta",["RobertaForQuestionAnswering",lb]],["xlm",["XLMForQuestionAnswering",pb]],["xlm-roberta",["XLMRobertaForQuestionAnswering",fm]],["mobilebert",["MobileBertForQuestionAnswering",_t]],["squeezebert",["SqueezeBertForQuestionAnswering",_e]]]),PC=new Map([["vision-encoder-decoder",["VisionEncoderDecoderModel",gm]],["idefics3",["Idefics3ForConditionalGeneration",eo]],["smolvlm",["SmolVLMForConditionalGeneration",Sh]]]),k$=new Map([["llava",["LlavaForConditionalGeneration",Nl]],["llava_onevision",["LlavaOnevisionForConditionalGeneration",ym]],["moondream1",["Moondream1ForConditionalGeneration",wb]],["florence2",["Florence2ForConditionalGeneration",Tb]],["qwen2-vl",["Qwen2VLForConditionalGeneration",I2]],["idefics3",["Idefics3ForConditionalGeneration",eo]],["smolvlm",["SmolVLMForConditionalGeneration",Sh]],["paligemma",["PaliGemmaForConditionalGeneration",xb]],["llava_qwen2",["LlavaQwen2ForCausalLM",vm]],["gemma3n",["Gemma3nForConditionalGeneration",bm]],["mistral3",["Mistral3ForConditionalGeneration",Sb]]]),I$=new Map([["ultravox",["UltravoxModel",xC]],["voxtral",["VoxtralForConditionalGeneration",d$]]]),IY=new Map([["vision-encoder-decoder",["VisionEncoderDecoderModel",gm]]]),D$=new Map([["vit",["ViTForImageClassification",G2]],["ijepa",["IJepaForImageClassification",H2]],["pvt",["PvtForImageClassification",Y2]],["vit_msn",["ViTMSNForImageClassification",Z2]],["fastvit",["FastViTForImageClassification",sL]],["mobilevit",["MobileViTForImageClassification",aL]],["mobilevitv2",["MobileViTV2ForImageClassification",cL]],["beit",["BeitForImageClassification",mL]],["deit",["DeiTForImageClassification",RL]],["hiera",["HieraForImageClassification",LL]],["convnext",["ConvNextForImageClassification",cN]],["convnextv2",["ConvNextV2ForImageClassification",uN]],["dinov2",["Dinov2ForImageClassification",pN]],["dinov2_with_registers",["Dinov2WithRegistersForImageClassification",mN]],["resnet",["ResNetForImageClassification",OL]],["swin",["SwinForImageClassification",BL]],["segformer",["SegformerForImageClassification",FO]],["efficientnet",["EfficientNetForImageClassification",BO]],["mobilenet_v1",["MobileNetV1ForImageClassification",UO]],["mobilenet_v2",["MobileNetV2ForImageClassification",WO]],["mobilenet_v3",["MobileNetV3ForImageClassification",qO]],["mobilenet_v4",["MobileNetV4ForImageClassification",XO]]]),R$=new Map([["detr",["DetrForObjectDetection",_L]],["rt_detr",["RTDetrForObjectDetection",bL]],["rt_detr_v2",["RTDetrV2ForObjectDetection",ML]],["rf_detr",["RFDetrForObjectDetection",xL]],["d_fine",["DFineForObjectDetection",AL]],["table-transformer",["TableTransformerForObjectDetection",kL]],["yolos",["YolosForObjectDetection",TN]]]),F$=new Map([["owlvit",["OwlViTForObjectDetection",uL]],["owlv2",["Owlv2ForObjectDetection",pL]],["grounding-dino",["GroundingDinoForObjectDetection",wN]]]),Nh=new Map([["detr",["DetrForSegmentation",GS]],["clipseg",["CLIPSegForImageSegmentation",sd]]]),L$=new Map([["segformer",["SegformerForSemanticSegmentation",LO]],["sapiens",["SapiensForSemanticSegmentation",qL]],["swin",["SwinForSemanticSegmentation",zL]],["mobilenet_v1",["MobileNetV1ForSemanticSegmentation",VO]],["mobilenet_v2",["MobileNetV2ForSemanticSegmentation",HO]],["mobilenet_v3",["MobileNetV3ForSemanticSegmentation",KO]],["mobilenet_v4",["MobileNetV4ForSemanticSegmentation",QO]]]),N$=new Map([["detr",["DetrForSegmentation",GS]],["maskformer",["MaskFormerForInstanceSegmentation",sN]]]),O$=new Map([["sam",["SamModel",SN]],["sam2",["Sam2Model",Ob]],["edgetam",["EdgeTamModel",kN]],["sam3_tracker",["Sam3TrackerModel",IN]]]),$$=new Map([["wav2vec2",["Wav2Vec2ForCTC",ON]],["wav2vec2-bert",["Wav2Vec2BertForCTC",eO]],["unispeech",["UniSpeechForCTC",qN]],["unispeech-sat",["UniSpeechSatForCTC",XN]],["wavlm",["WavLMForCTC",oO]],["hubert",["HubertForCTC",sO]],["parakeet_ctc",["ParakeetForCTC",UN]]]),B$=new Map([["wav2vec2",["Wav2Vec2ForSequenceClassification",$N]],["wav2vec2-bert",["Wav2Vec2BertForSequenceClassification",tO]],["unispeech",["UniSpeechForSequenceClassification",KN]],["unispeech-sat",["UniSpeechSatForSequenceClassification",QN]],["wavlm",["WavLMForSequenceClassification",aO]],["hubert",["HubertForSequenceClassification",iO]],["audio-spectrogram-transformer",["ASTForAudioClassification",yb]]]),z$=new Map([["wavlm",["WavLMForXVector",lO]]]),U$=new Map([["unispeech-sat",["UniSpeechSatForAudioFrameClassification",JN]],["wavlm",["WavLMForAudioFrameClassification",cO]],["wav2vec2",["Wav2Vec2ForAudioFrameClassification",BN]],["pyannote",["PyAnnoteForAudioFrameClassification",GN]]]),V$=new Map([["vitmatte",["VitMatteForImageMatting",rL]]]),DY=new Map([["patchtst",["PatchTSTForPrediction",o$]],["patchtsmixer",["PatchTSMixerForPrediction",l$]]]),G$=new Map([["swin2sr",["Swin2SRForImageSuperResolution",VL]]]),W$=new Map([["dpt",["DPTForDepthEstimation",WL]],["depth_anything",["DepthAnythingForDepthEstimation",jL]],["glpn",["GLPNForDepthEstimation",rN]],["sapiens",["SapiensForDepthEstimation",KL]],["depth_pro",["DepthProForDepthEstimation",QL]],["metric3d",["Metric3DForDepthEstimation",ZL]],["metric3dv2",["Metric3Dv2ForDepthEstimation",tN]]]),H$=new Map([["sapiens",["SapiensForNormalEstimation",YL]]]),j$=new Map([["vitpose",["VitPoseForPoseEstimation",q2]]]),q$=new Map([["clip",["CLIPVisionModelWithProjection",Tm]],["siglip",["SiglipVisionModel",xm]],["jina_clip",["JinaCLIPVisionModel",Am]]]),K$=[[SY,M.EncoderOnly],[CY,M.EncoderDecoder],[PY,M.DecoderOnly],[AY,M.AutoEncoder],[S$,M.EncoderOnly],[C$,M.EncoderOnly],[CC,M.Seq2Seq],[SC,M.Seq2Seq],[AC,M.DecoderOnly],[kY,M.MultiModality],[A$,M.EncoderOnly],[P$,M.EncoderOnly],[PC,M.Vision2Seq],[k$,M.ImageTextToText],[I$,M.AudioTextToText],[D$,M.EncoderOnly],[Nh,M.EncoderOnly],[N$,M.EncoderOnly],[L$,M.EncoderOnly],[V$,M.EncoderOnly],[DY,M.EncoderOnly],[G$,M.EncoderOnly],[W$,M.EncoderOnly],[H$,M.EncoderOnly],[j$,M.EncoderOnly],[R$,M.EncoderOnly],[F$,M.EncoderOnly],[O$,M.MaskGeneration],[$$,M.EncoderOnly],[B$,M.EncoderOnly],[E$,M.Seq2Seq],[x$,M.EncoderOnly],[z$,M.EncoderOnly],[U$,M.EncoderOnly],[q$,M.EncoderOnly]];for(let[A,D]of K$)for(let[V,he]of A.values())S.set(V,D),T.set(he,V),k.set(V,he);let RY=[["MusicgenForConditionalGeneration",MC,M.Musicgen],["Phi3VForCausalLM",wm,M.Phi3V],["CLIPTextModelWithProjection",Mm,M.EncoderOnly],["SiglipTextModel",Ib,M.EncoderOnly],["JinaCLIPTextModel",Cm,M.EncoderOnly],["ClapTextModelWithProjection",IO,M.EncoderOnly],["ClapAudioModelWithProjection",DO,M.EncoderOnly],["DacEncoderModel",v$,M.EncoderOnly],["DacDecoderModel",b$,M.EncoderOnly],["MimiEncoderModel",f$,M.EncoderOnly],["MimiDecoderModel",m$,M.EncoderOnly],["SnacEncoderModel",M$,M.EncoderOnly],["SnacDecoderModel",T$,M.EncoderOnly],["Gemma3nForConditionalGeneration",bm,M.ImageAudioTextToText],["SupertonicForConditionalGeneration",uC,M.Supertonic]];for(let[A,D,V]of RY)S.set(A,V),T.set(D,A),k.set(A,D);let Y$=new Map([["modnet",Nh],["birefnet",Nh],["isnet",Nh],["ben",Nh]]);for(let[A,D]of Y$.entries())D.set(A,["PreTrainedModel",U]),S.set(A,M.EncoderOnly),T.set(U,A),k.set(A,U);class kC extends yn{}Z(kC,"MODEL_CLASS_MAPPINGS",K$.map(D=>D[0])),Z(kC,"BASE_IF_FAIL",!0);class X$ extends yn{}Z(X$,"MODEL_CLASS_MAPPINGS",[S$]);class Q$ extends yn{}Z(Q$,"MODEL_CLASS_MAPPINGS",[C$]);class J$ extends yn{}Z(J$,"MODEL_CLASS_MAPPINGS",[CC]);class Z$ extends yn{}Z(Z$,"MODEL_CLASS_MAPPINGS",[SC]);class eB extends yn{}Z(eB,"MODEL_CLASS_MAPPINGS",[E$]);class tB extends yn{}Z(tB,"MODEL_CLASS_MAPPINGS",[x$]);class nB extends yn{}Z(nB,"MODEL_CLASS_MAPPINGS",[AC]);class sB extends yn{}Z(sB,"MODEL_CLASS_MAPPINGS",[A$]);class iB extends yn{}Z(iB,"MODEL_CLASS_MAPPINGS",[P$]);class rB extends yn{}Z(rB,"MODEL_CLASS_MAPPINGS",[PC]);class oB extends yn{}Z(oB,"MODEL_CLASS_MAPPINGS",[D$]);class aB extends yn{}Z(aB,"MODEL_CLASS_MAPPINGS",[Nh]);class lB extends yn{}Z(lB,"MODEL_CLASS_MAPPINGS",[L$]);class cB extends yn{}Z(cB,"MODEL_CLASS_MAPPINGS",[N$]);class dB extends yn{}Z(dB,"MODEL_CLASS_MAPPINGS",[R$]);class uB extends yn{}Z(uB,"MODEL_CLASS_MAPPINGS",[F$]);class hB extends yn{}Z(hB,"MODEL_CLASS_MAPPINGS",[O$]);class pB extends yn{}Z(pB,"MODEL_CLASS_MAPPINGS",[$$]);class fB extends yn{}Z(fB,"MODEL_CLASS_MAPPINGS",[B$]);class mB extends yn{}Z(mB,"MODEL_CLASS_MAPPINGS",[z$]);class gB extends yn{}Z(gB,"MODEL_CLASS_MAPPINGS",[U$]);class _B extends yn{}Z(_B,"MODEL_CLASS_MAPPINGS",[IY]);class yB extends yn{}Z(yB,"MODEL_CLASS_MAPPINGS",[V$]);class vB extends yn{}Z(vB,"MODEL_CLASS_MAPPINGS",[G$]);class bB extends yn{}Z(bB,"MODEL_CLASS_MAPPINGS",[W$]);class wB extends yn{}Z(wB,"MODEL_CLASS_MAPPINGS",[H$]);class MB extends yn{}Z(MB,"MODEL_CLASS_MAPPINGS",[j$]);class TB extends yn{}Z(TB,"MODEL_CLASS_MAPPINGS",[q$]);class EB extends yn{}Z(EB,"MODEL_CLASS_MAPPINGS",[k$]);class xB extends yn{}Z(xB,"MODEL_CLASS_MAPPINGS",[I$]);class FY extends pe{constructor({logits:D,past_key_values:V,encoder_outputs:he,decoder_attentions:Te=null,cross_attentions:Me=null}){super(),this.logits=D,this.past_key_values=V,this.encoder_outputs=he,this.decoder_attentions=Te,this.cross_attentions=Me}}class Gt extends pe{constructor({logits:D,...V}){super(),this.logits=D;let he=Object.values(V);he.length>0&&(this.attentions=he)}}class SB extends pe{constructor({logits:D,embeddings:V}){super(),this.logits=D,this.embeddings=V}}class Cs extends pe{constructor({logits:D}){super(),this.logits=D}}class Os extends pe{constructor({logits:D}){super(),this.logits=D}}class ii extends pe{constructor({start_logits:D,end_logits:V}){super(),this.start_logits=D,this.end_logits=V}}class Bl extends pe{constructor({logits:D}){super(),this.logits=D}}class LY extends pe{constructor({logits:D,past_key_values:V}){super(),this.logits=D,this.past_key_values=V}}class CB extends pe{constructor({alphas:D}){super(),this.alphas=D}}class AB extends pe{constructor({waveform:D,spectrogram:V}){super(),this.waveform=D,this.spectrogram=V}}},"./src/models/audio_spectrogram_transformer/feature_extraction_audio_spectrogram_transformer.js":(s,e,t)=>{t.r(e),t.d(e,{ASTFeatureExtractor:()=>o});var n=t("./src/base/feature_extraction_utils.js"),i=t("./src/utils/tensor.js"),r=t("./src/utils/audio.js");class o extends n.FeatureExtractor{constructor(l){super(l);let c=this.config.sampling_rate,d=(0,r.mel_filter_bank)(257,this.config.num_mel_bins,20,Math.floor(c/2),c,null,"kaldi",!0);this.mel_filters=d,this.window=(0,r.window_function)(400,"hann",{periodic:!1}),this.mean=this.config.mean,this.std=this.config.std}async _extract_fbank_features(l,c){return(0,r.spectrogram)(l,this.window,400,160,{fft_length:512,power:2,center:!1,preemphasis:.97,mel_filters:this.mel_filters,log_mel:"log",mel_floor:1192092955078125e-22,remove_dc_offset:!0,max_num_frames:c,transpose:!0})}async _call(l){(0,n.validate_audio_inputs)(l,"ASTFeatureExtractor");let c=await this._extract_fbank_features(l,this.config.max_length);if(this.config.do_normalize){let d=this.std*2,u=c.data;for(let h=0;h<u.length;++h)u[h]=(u[h]-this.mean)/d}return{input_values:c.unsqueeze_(0)}}}},"./src/models/auto/feature_extraction_auto.js":(s,e,t)=>{t.r(e),t.d(e,{AutoFeatureExtractor:()=>a});var n=t("./src/utils/constants.js"),i=t("./src/utils/hub.js"),r=t("./src/base/feature_extraction_utils.js"),o=t("./src/models/feature_extractors.js");class a{static async from_pretrained(c,d={}){let u=await(0,i.getModelJSON)(c,n.FEATURE_EXTRACTOR_NAME,!0,d),h=u.feature_extractor_type,p=o[h];if(!p)throw new Error(`Unknown feature_extractor_type: '${h}'. Please report this at ${n.GITHUB_ISSUE_URL}.`);return new p(u)}}},"./src/models/auto/image_processing_auto.js":(s,e,t)=>{t.r(e),t.d(e,{AutoImageProcessor:()=>a});var n=t("./src/utils/constants.js"),i=t("./src/utils/hub.js"),r=t("./src/base/image_processors_utils.js"),o=t("./src/models/image_processors.js");class a{static async from_pretrained(c,d={}){let u=await(0,i.getModelJSON)(c,n.IMAGE_PROCESSOR_NAME,!0,d),h=u.image_processor_type??u.feature_extractor_type,p=o[h?.replace(/Fast$/,"")];return p||(h!==void 0&&console.warn(`Image processor type '${h}' not found, assuming base ImageProcessor. Please report this at ${n.GITHUB_ISSUE_URL}.`),p=r.ImageProcessor),new p(u)}}},"./src/models/auto/processing_auto.js":(s,e,t)=>{t.r(e),t.d(e,{AutoProcessor:()=>c});var n=t("./src/utils/constants.js"),i=t("./src/utils/hub.js"),r=t("./src/base/processing_utils.js"),o=t("./src/models/processors.js"),a=t("./src/models/image_processors.js"),l=t("./src/models/feature_extractors.js");class c{static async from_pretrained(u,h={}){let p=await(0,i.getModelJSON)(u,n.IMAGE_PROCESSOR_NAME,!0,h),{image_processor_type:f,feature_extractor_type:_,processor_class:b}=p;if(b&&o[b])return o[b].from_pretrained(u,h);if(!f&&!_)throw new Error("No `image_processor_type` or `feature_extractor_type` found in the config.");let y={};if(f){let C=a[f.replace(/Fast$/,"")];if(!C)throw new Error(`Unknown image_processor_type: '${f}'.`);y.image_processor=new C(p)}if(_){let C=a[_];if(C)y.image_processor=new C(p);else{let M=l[_];if(!M)throw new Error(`Unknown feature_extractor_type: '${_}'.`);y.feature_extractor=new M(p)}}let w={};return new r.Processor(w,y,null)}}},"./src/models/beit/image_processing_beit.js":(s,e,t)=>{t.r(e),t.d(e,{BeitFeatureExtractor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{}},"./src/models/bit/image_processing_bit.js":(s,e,t)=>{t.r(e),t.d(e,{BitImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{}},"./src/models/chinese_clip/image_processing_chinese_clip.js":(s,e,t)=>{t.r(e),t.d(e,{ChineseCLIPFeatureExtractor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{}},"./src/models/clap/feature_extraction_clap.js":(s,e,t)=>{t.r(e),t.d(e,{ClapFeatureExtractor:()=>o});var n=t("./src/base/feature_extraction_utils.js"),i=t("./src/utils/tensor.js"),r=t("./src/utils/audio.js");class o extends n.FeatureExtractor{constructor(l){super(l),this.mel_filters=(0,r.mel_filter_bank)(this.config.nb_frequency_bins,this.config.feature_size,this.config.frequency_min,this.config.frequency_max,this.config.sampling_rate,null,"htk"),this.mel_filters_slaney=(0,r.mel_filter_bank)(this.config.nb_frequency_bins,this.config.feature_size,this.config.frequency_min,this.config.frequency_max,this.config.sampling_rate,"slaney","slaney"),this.window=(0,r.window_function)(this.config.fft_window_size,"hann")}async _get_input_mel(l,c,d,u){let h,p=!1,f=l.length-c;if(f>0)if(d==="rand_trunc"){p=!0;let _=Math.floor(Math.random()*(f+1));l=l.subarray(_,_+c),h=await this._extract_fbank_features(l,this.mel_filters_slaney,this.config.nb_max_samples)}else throw new Error(`Truncation strategy "${d}" not implemented`);else{if(f<0){let _=new Float64Array(c);if(_.set(l),u==="repeat")for(let b=l.length;b<c;b+=l.length)_.set(l.subarray(0,Math.min(l.length,c-b)),b);else if(u==="repeatpad")for(let b=l.length;b<-f;b+=l.length)_.set(l,b);l=_}if(d==="fusion")throw new Error(`Truncation strategy "${d}" not implemented`);h=await this._extract_fbank_features(l,this.mel_filters_slaney,this.config.nb_max_samples)}return h.unsqueeze_(0)}async _extract_fbank_features(l,c,d=null){return(0,r.spectrogram)(l,this.window,this.config.fft_window_size,this.config.hop_length,{power:2,mel_filters:c,log_mel:"dB",max_num_frames:d,do_pad:!1,transpose:!0})}async _call(l,{max_length:c=null}={}){return(0,n.validate_audio_inputs)(l,"ClapFeatureExtractor"),{input_features:(await this._get_input_mel(l,c??this.config.nb_max_samples,this.config.truncation,this.config.padding)).unsqueeze_(0)}}}},"./src/models/clip/image_processing_clip.js":(s,e,t)=>{t.r(e),t.d(e,{CLIPFeatureExtractor:()=>r,CLIPImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{}class r extends i{}},"./src/models/convnext/image_processing_convnext.js":(s,e,t)=>{t.r(e),t.d(e,{ConvNextFeatureExtractor:()=>r,ConvNextImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{constructor(a){super(a),this.crop_pct=this.config.crop_pct??224/256}async resize(a){let l=this.size?.shortest_edge;if(l===void 0)throw new Error("Size dictionary must contain 'shortest_edge' key.");if(l<384){let c=Math.floor(l/this.crop_pct),[d,u]=this.get_resize_output_image_size(a,{shortest_edge:c});a=await a.resize(d,u,{resample:this.resample}),a=await a.center_crop(l,l)}else a=await a.resize(l,l,{resample:this.resample});return a}}class r extends i{}},"./src/models/dac/feature_extraction_dac.js":(s,e,t)=>{t.r(e),t.d(e,{DacFeatureExtractor:()=>i});var n=t("./src/models/encodec/feature_extraction_encodec.js");class i extends n.EncodecFeatureExtractor{}},"./src/models/deit/image_processing_deit.js":(s,e,t)=>{t.r(e),t.d(e,{DeiTFeatureExtractor:()=>r,DeiTImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{}class r extends i{}},"./src/models/detr/image_processing_detr.js":(s,e,t)=>{t.r(e),t.d(e,{DetrFeatureExtractor:()=>o,DetrImageProcessor:()=>r});var n=t("./src/base/image_processors_utils.js"),i=t("./src/utils/tensor.js");class r extends n.ImageProcessor{async _call(l){let c=await super._call(l),d=[c.pixel_values.dims[0],64,64],u=(0,i.full)(d,1n);return{...c,pixel_mask:u}}post_process_object_detection(...l){return(0,n.post_process_object_detection)(...l)}post_process_panoptic_segmentation(...l){return(0,n.post_process_panoptic_segmentation)(...l)}post_process_instance_segmentation(...l){return(0,n.post_process_instance_segmentation)(...l)}}class o extends r{}},"./src/models/dinov3_vit/image_processing_dinov3_vit.js":(s,e,t)=>{t.r(e),t.d(e,{DINOv3ViTImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{}},"./src/models/donut/image_processing_donut.js":(s,e,t)=>{t.r(e),t.d(e,{DonutFeatureExtractor:()=>r,DonutImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{pad_image(a,l,c,d={}){let[u,h,p]=l,f=this.image_mean;Array.isArray(this.image_mean)||(f=new Array(p).fill(f));let _=this.image_std;Array.isArray(_)||(_=new Array(p).fill(f));let b=f.map((y,w)=>-y/_[w]);return super.pad_image(a,l,c,{center:!0,constant_values:b,...d})}}class r extends i{}},"./src/models/dpt/image_processing_dpt.js":(s,e,t)=>{t.r(e),t.d(e,{DPTFeatureExtractor:()=>r,DPTImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{}class r extends i{}},"./src/models/efficientnet/image_processing_efficientnet.js":(s,e,t)=>{t.r(e),t.d(e,{EfficientNetImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{constructor(o){super(o),this.include_top=this.config.include_top??!0,this.include_top&&(this.image_std=this.image_std.map(a=>a*a))}}},"./src/models/encodec/feature_extraction_encodec.js":(s,e,t)=>{t.r(e),t.d(e,{EncodecFeatureExtractor:()=>r});var n=t("./src/base/feature_extraction_utils.js"),i=t("./src/utils/tensor.js");class r extends n.FeatureExtractor{async _call(a){(0,n.validate_audio_inputs)(a,"EncodecFeatureExtractor"),a instanceof Float64Array&&(a=new Float32Array(a));let l=this.config.feature_size;if(a.length%l!==0)throw new Error(`The length of the audio data must be a multiple of the number of channels (${l}).`);let c=[1,l,a.length/l];return{input_values:new i.Tensor("float32",a,c)}}}},"./src/models/feature_extractors.js":(s,e,t)=>{t.r(e),t.d(e,{ASTFeatureExtractor:()=>n.ASTFeatureExtractor,ClapFeatureExtractor:()=>r.ClapFeatureExtractor,DacFeatureExtractor:()=>o.DacFeatureExtractor,EncodecFeatureExtractor:()=>i.EncodecFeatureExtractor,Gemma3nAudioFeatureExtractor:()=>a.Gemma3nAudioFeatureExtractor,ImageFeatureExtractor:()=>y.ImageProcessor,MoonshineFeatureExtractor:()=>l.MoonshineFeatureExtractor,ParakeetFeatureExtractor:()=>c.ParakeetFeatureExtractor,PyAnnoteFeatureExtractor:()=>d.PyAnnoteFeatureExtractor,SeamlessM4TFeatureExtractor:()=>u.SeamlessM4TFeatureExtractor,SnacFeatureExtractor:()=>h.SnacFeatureExtractor,SpeechT5FeatureExtractor:()=>p.SpeechT5FeatureExtractor,Wav2Vec2FeatureExtractor:()=>f.Wav2Vec2FeatureExtractor,WeSpeakerFeatureExtractor:()=>_.WeSpeakerFeatureExtractor,WhisperFeatureExtractor:()=>b.WhisperFeatureExtractor});var n=t("./src/models/audio_spectrogram_transformer/feature_extraction_audio_spectrogram_transformer.js"),i=t("./src/models/encodec/feature_extraction_encodec.js"),r=t("./src/models/clap/feature_extraction_clap.js"),o=t("./src/models/dac/feature_extraction_dac.js"),a=t("./src/models/gemma3n/feature_extraction_gemma3n.js"),l=t("./src/models/moonshine/feature_extraction_moonshine.js"),c=t("./src/models/parakeet/feature_extraction_parakeet.js"),d=t("./src/models/pyannote/feature_extraction_pyannote.js"),u=t("./src/models/seamless_m4t/feature_extraction_seamless_m4t.js"),h=t("./src/models/snac/feature_extraction_snac.js"),p=t("./src/models/speecht5/feature_extraction_speecht5.js"),f=t("./src/models/wav2vec2/feature_extraction_wav2vec2.js"),_=t("./src/models/wespeaker/feature_extraction_wespeaker.js"),b=t("./src/models/whisper/feature_extraction_whisper.js"),y=t("./src/base/image_processors_utils.js")},"./src/models/florence2/processing_florence2.js":(s,e,t)=>{t.r(e),t.d(e,{Florence2Processor:()=>o});var n=t("./src/base/processing_utils.js"),i=t("./src/models/auto/image_processing_auto.js"),r=t("./src/tokenizers.js");class o extends n.Processor{constructor(l,c,d){super(l,c,d);let{tasks_answer_post_processing_type:u,task_prompts_without_inputs:h,task_prompts_with_input:p}=this.image_processor.config;this.tasks_answer_post_processing_type=new Map(Object.entries(u??{})),this.task_prompts_without_inputs=new Map(Object.entries(h??{})),this.task_prompts_with_input=new Map(Object.entries(p??{})),this.regexes={quad_boxes:/(.+?)<loc_(\d+)><loc_(\d+)><loc_(\d+)><loc_(\d+)><loc_(\d+)><loc_(\d+)><loc_(\d+)><loc_(\d+)>/gm,bboxes:/([^<]+)?<loc_(\d+)><loc_(\d+)><loc_(\d+)><loc_(\d+)>/gm},this.size_per_bin=1e3}construct_prompts(l){typeof l=="string"&&(l=[l]);let c=[];for(let d of l)if(this.task_prompts_without_inputs.has(d))c.push(this.task_prompts_without_inputs.get(d));else{for(let[u,h]of this.task_prompts_with_input)if(d.includes(u)){c.push(h.replaceAll("{input}",d).replaceAll(u,""));break}c.length!==l.length&&c.push(d)}return c}post_process_generation(l,c,d){let u=this.tasks_answer_post_processing_type.get(c)??"pure_text";l=l.replaceAll("<s>","").replaceAll("</s>","");let h;switch(u){case"pure_text":h=l;break;case"description_with_bboxes":case"bboxes":case"phrase_grounding":case"ocr":let p=u==="ocr"?"quad_boxes":"bboxes",f=l.matchAll(this.regexes[p]),_=[],b=[];for(let[y,w,...C]of f)_.push(w?w.trim():_.at(-1)??""),b.push(C.map((M,S)=>(Number(M)+.5)/this.size_per_bin*d[S%2]));h={labels:_,[p]:b};break;default:throw new Error(`Task "${c}" (of type "${u}") not yet implemented.`)}return{[c]:h}}async _call(l,c=null,d={}){if(!l&&!c)throw new Error("Either text or images must be provided");let u=await this.image_processor(l,d),h=c?this.tokenizer(this.construct_prompts(c),d):{};return{...u,...h}}}Z(o,"tokenizer_class",r.AutoTokenizer),Z(o,"image_processor_class",i.AutoImageProcessor)},"./src/models/gemma3n/feature_extraction_gemma3n.js":(s,e,t)=>{t.r(e),t.d(e,{Gemma3nAudioFeatureExtractor:()=>o});var n=t("./src/base/feature_extraction_utils.js"),i=t("./src/utils/tensor.js"),r=t("./src/utils/audio.js");class o extends n.FeatureExtractor{constructor(l){super(l);let{fft_length:c,feature_size:d,min_frequency:u,max_frequency:h,sampling_rate:p,frame_length:f}=this.config,_=(0,r.mel_filter_bank)(Math.floor(1+c/2),d,u,h,p,null,"htk",!1);this.mel_filters=_,this.window=(0,r.window_function)(f,"hann")}async _extract_fbank_features(l,c){return(0,r.spectrogram)(l,this.window,this.config.frame_length,this.config.hop_length,{fft_length:this.config.fft_length,center:!1,onesided:!0,preemphasis:this.config.preemphasis,preemphasis_htk_flavor:this.config.preemphasis_htk_flavor,mel_filters:this.mel_filters,log_mel:"log",mel_floor:this.config.mel_floor,remove_dc_offset:!1,transpose:!0})}async _call(l,{max_length:c=48e4,truncation:d=!0,padding:u=!0,pad_to_multiple_of:h=128}={}){if((0,n.validate_audio_inputs)(l,"Gemma3nAudioFeatureExtractor"),d&&l.length>c&&(l=l.slice(0,c)),u&&l.length%h!==0){let _=h-l.length%h,b=new Float64Array(l.length+_);b.set(l),this.config.padding_value!==0&&b.fill(this.config.padding_value,l.length),l=b}let p=await this._extract_fbank_features(l,this.config.max_length),f=(0,i.full)([1,p.dims[0]],!0);return{input_features:p.unsqueeze_(0),input_features_mask:f}}}},"./src/models/gemma3n/processing_gemma3n.js":(s,e,t)=>{t.r(e),t.d(e,{Gemma3nProcessor:()=>c});var n=t("./src/base/processing_utils.js"),i=t("./src/models/auto/image_processing_auto.js"),r=t("./src/models/auto/feature_extraction_auto.js"),o=t("./src/tokenizers.js"),a=t("./src/utils/image.js"),l=t("./src/utils/audio.js");class c extends n.Processor{constructor(u,h,p){super(u,h,p),this.audio_seq_length=this.config.audio_seq_length,this.image_seq_length=this.config.image_seq_length;let{audio_token_id:f,boa_token:_,audio_token:b,eoa_token:y,image_token_id:w,boi_token:C,image_token:M,eoi_token:S}=this.tokenizer.config;this.audio_token_id=f,this.boa_token=_,this.audio_token=b;let k=b.repeat(this.audio_seq_length);this.full_audio_sequence=`

${_}${k}${y}

`,this.image_token_id=w,this.boi_token=C,this.image_token=M;let T=M.repeat(this.image_seq_length);this.full_image_sequence=`

${C}${T}${S}

`}async _call(u,h=null,p=null,f={}){typeof u=="string"&&(u=[u]);let _;p&&(_=await this.feature_extractor(p,f),u=u.map(w=>w.replaceAll(this.audio_token,this.full_audio_sequence)));let b;return h&&(b=await this.image_processor(h,f),u=u.map(w=>w.replaceAll(this.image_token,this.full_image_sequence))),{...this.tokenizer(u,f),...b,..._}}}Z(c,"image_processor_class",i.AutoImageProcessor),Z(c,"feature_extractor_class",r.AutoFeatureExtractor),Z(c,"tokenizer_class",o.AutoTokenizer),Z(c,"uses_processor_config",!0),Z(c,"uses_chat_template_file",!0)},"./src/models/glpn/image_processing_glpn.js":(s,e,t)=>{t.r(e),t.d(e,{GLPNFeatureExtractor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{}},"./src/models/grounding_dino/image_processing_grounding_dino.js":(s,e,t)=>{t.r(e),t.d(e,{GroundingDinoImageProcessor:()=>r});var n=t("./src/base/image_processors_utils.js"),i=t("./src/utils/tensor.js");class r extends n.ImageProcessor{async _call(a){let l=await super._call(a),c=l.pixel_values.dims,d=(0,i.ones)([c[0],c[2],c[3]]);return{...l,pixel_mask:d}}}},"./src/models/grounding_dino/processing_grounding_dino.js":(s,e,t)=>{t.r(e),t.d(e,{GroundingDinoProcessor:()=>l});var n=t("./src/base/processing_utils.js"),i=t("./src/models/auto/image_processing_auto.js"),r=t("./src/tokenizers.js"),o=t("./src/base/image_processors_utils.js");function a(c,d){let h=c.dims.at(-1)-1,p=c.tolist();p.fill(!1,0,1),p.fill(!1,h);let f=d.tolist();return p.map((_,b)=>_?b:null).filter(_=>_!==null).map(_=>f[_])}class l extends n.Processor{async _call(d,u,h={}){let p=d?await this.image_processor(d,h):{};return{...u?this.tokenizer(u,h):{},...p}}post_process_grounded_object_detection(d,u,{box_threshold:h=.25,text_threshold:p=.25,target_sizes:f=null}={}){let{logits:_,pred_boxes:b}=d,y=_.dims[0];if(f!==null&&f.length!==y)throw Error("Make sure that you pass in as many target sizes as the batch dimension of the logits");let w=_.dims.at(1),C=_.sigmoid(),M=C.max(-1).tolist(),S=b.tolist().map(T=>T.map(P=>(0,o.center_to_corners_format)(P))),k=[];for(let T=0;T<y;++T){let P=f!==null?f[T]:null;P!==null&&(S[T]=S[T].map(z=>z.map((ne,re)=>ne*P[(re+1)%2])));let R=M[T],O=[],H=[],X=[];for(let z=0;z<w;++z){let ne=R[z];if(ne<=h)continue;let re=S[T][z],Y=C[T][z];O.push(ne),X.push(re);let se=a(Y.gt(p),u[T]);H.push(se)}k.push({scores:O,boxes:X,labels:this.batch_decode(H)})}return k}}Z(l,"tokenizer_class",r.AutoTokenizer),Z(l,"image_processor_class",i.AutoImageProcessor)},"./src/models/idefics3/image_processing_idefics3.js":(s,e,t)=>{t.r(e),t.d(e,{Idefics3ImageProcessor:()=>r});var n=t("./src/base/image_processors_utils.js"),i=t("./src/utils/tensor.js");class r extends n.ImageProcessor{constructor(a){super(a),this.do_image_splitting=a.do_image_splitting??!0,this.max_image_size=a.max_image_size}get_resize_for_vision_encoder(a,l){let[c,d]=a.dims.slice(-2),u=d/c;return d>=c?(d=Math.ceil(d/l)*l,c=Math.floor(d/u),c=Math.ceil(c/l)*l):(c=Math.ceil(c/l)*l,d=Math.floor(c*u),d=Math.ceil(d/l)*l),{height:c,width:d}}async _call(a,{do_image_splitting:l=null,return_row_col_info:c=!1}={}){let d;if(!Array.isArray(a))d=[[a]];else{if(a.length===0||!a[0])throw new Error("No images provided.");Array.isArray(a[0])?d=a:d=[a]}let u=[],h=[],p=[],f=[],_=[];for(let T of d){let P=await Promise.all(T.map(H=>this.preprocess(H)));f.push(...P.map(H=>H.original_size)),_.push(...P.map(H=>H.reshaped_input_size)),P.forEach(H=>H.pixel_values.unsqueeze_(0));let{longest_edge:R}=this.max_image_size,O;if(l??this.do_image_splitting){let H=new Array(P.length),X=new Array(P.length);O=await Promise.all(P.map(async(z,ne)=>{let re=this.get_resize_for_vision_encoder(z.pixel_values,R),Y=await(0,i.interpolate_4d)(z.pixel_values,{size:[re.height,re.width]}),{frames:se,num_splits_h:ue,num_splits_w:fe}=await this.split_image(Y,this.max_image_size);return H[ne]=ue,X[ne]=fe,(0,i.cat)(se,0)})),h.push(H),p.push(X)}else{let H=[R,R];O=await Promise.all(P.map(X=>(0,i.interpolate_4d)(X.pixel_values,{size:H}))),h.push(new Array(P.length).fill(0)),p.push(new Array(P.length).fill(0))}u.push((0,i.cat)(O,0))}let b=u.length,[y,w,C,M]=u[0].dims,S,k;if(b===1)S=u[0].unsqueeze_(0),k=(0,i.full)([b,y,C,M],!0);else{let T=Math.max(...u.map(O=>O.dims.at(0)));k=(0,i.full)([b,T,C,M],!0);let P=k.data,R=T*C*M;for(let O=0;O<b;++O){let H=u[O].dims[0];if(H<T){u[O]=(0,i.cat)([u[O],(0,i.full)([T-H,w,C,M],0)],0);let X=O*R+H*C*M,z=(O+1)*R;P.fill(!1,X,z)}}S=(0,i.stack)(u,0)}return{pixel_values:S,pixel_attention_mask:k,original_sizes:f,reshaped_input_sizes:_,...c?{rows:h,cols:p}:{}}}async split_image(a,{longest_edge:l}){let c=l,d=l,u=[],[h,p]=a.dims.slice(-2),f=0,_=0;if(h>c||p>d){f=Math.ceil(h/c),_=Math.ceil(p/d);let b=Math.ceil(h/f),y=Math.ceil(p/_);for(let M=0;M<f;++M)for(let S=0;S<_;++S){let k,T,P,R;M===f-1?(T=h-b,R=h):(T=M*b,R=(M+1)*b),S===_-1?(k=p-y,P=p):(k=S*y,P=(S+1)*y);let O=[T,k],H=[R,P],X=await(0,i.slice)(a,O,H,[2,3]);u.push(X)}let w=c,C=d;(h!==w||p!==C)&&(a=await(0,i.interpolate_4d)(a,{size:[w,C]}))}return u.push(a),{frames:u,num_splits_h:f,num_splits_w:_}}}},"./src/models/idefics3/processing_idefics3.js":(s,e,t)=>{t.r(e),t.d(e,{Idefics3Processor:()=>u});var n=t("./src/base/processing_utils.js"),i=t("./src/models/auto/image_processing_auto.js"),r=t("./src/tokenizers.js"),o=t("./src/utils/image.js"),a=t("./src/utils/core.js");function l(h,p,f,_,b,y){let w="";for(let C=0;C<p;++C){for(let M=0;M<f;++M)w+=_+`<row_${C+1}_col_${M+1}>`+b.repeat(h);w+=`
`}return w+=`
${_}${y}`+b.repeat(h)+`${_}`,w}function c(h,p,f,_){return`${p}${_}`+f.repeat(h)+`${p}`}function d(h,p,f,_,b,y){return h===0&&p===0?c(f,_,b,y):l(f,h,p,_,b,y)}class u extends n.Processor{constructor(){super(...arguments);Z(this,"fake_image_token","<fake_token_around_image>");Z(this,"image_token","<image>");Z(this,"global_img_token","<global-img>")}async _call(f,_=null,b={}){b.return_row_col_info??(b.return_row_col_info=!0);let y;_&&(y=await this.image_processor(_,b)),Array.isArray(f)||(f=[f]);let w=y.rows??[new Array(f.length).fill(0)],C=y.cols??[new Array(f.length).fill(0)],M=this.config.image_seq_len,S=[],k=[];for(let P=0;P<f.length;++P){let R=f[P],O=w[P],H=C[P];S.push((0,a.count)(R,this.image_token));let X=O.map((re,Y)=>d(re,H[Y],M,this.fake_image_token,this.image_token,this.global_img_token)),z=R.split(this.image_token);if(z.length===0)throw new Error("The image token should be present in the text.");let ne=z[0];for(let re=0;re<X.length;++re)ne+=X[re]+z[re+1];k.push(ne)}return{...this.tokenizer(k),...y}}}Z(u,"image_processor_class",i.AutoImageProcessor),Z(u,"tokenizer_class",r.AutoTokenizer),Z(u,"uses_processor_config",!0)},"./src/models/image_processors.js":(s,e,t)=>{t.r(e),t.d(e,{BeitFeatureExtractor:()=>n.BeitFeatureExtractor,BitImageProcessor:()=>i.BitImageProcessor,CLIPFeatureExtractor:()=>o.CLIPFeatureExtractor,CLIPImageProcessor:()=>o.CLIPImageProcessor,ChineseCLIPFeatureExtractor:()=>r.ChineseCLIPFeatureExtractor,ConvNextFeatureExtractor:()=>a.ConvNextFeatureExtractor,ConvNextImageProcessor:()=>a.ConvNextImageProcessor,DINOv3ViTImageProcessor:()=>d.DINOv3ViTImageProcessor,DPTFeatureExtractor:()=>h.DPTFeatureExtractor,DPTImageProcessor:()=>h.DPTImageProcessor,DeiTFeatureExtractor:()=>l.DeiTFeatureExtractor,DeiTImageProcessor:()=>l.DeiTImageProcessor,DetrFeatureExtractor:()=>c.DetrFeatureExtractor,DetrImageProcessor:()=>c.DetrImageProcessor,DonutFeatureExtractor:()=>u.DonutFeatureExtractor,DonutImageProcessor:()=>u.DonutImageProcessor,EfficientNetImageProcessor:()=>p.EfficientNetImageProcessor,GLPNFeatureExtractor:()=>f.GLPNFeatureExtractor,GroundingDinoImageProcessor:()=>_.GroundingDinoImageProcessor,Idefics3ImageProcessor:()=>b.Idefics3ImageProcessor,JinaCLIPImageProcessor:()=>w.JinaCLIPImageProcessor,LlavaOnevisionImageProcessor:()=>C.LlavaOnevisionImageProcessor,Mask2FormerImageProcessor:()=>M.Mask2FormerImageProcessor,MaskFormerFeatureExtractor:()=>S.MaskFormerFeatureExtractor,MaskFormerImageProcessor:()=>S.MaskFormerImageProcessor,MobileNetV1FeatureExtractor:()=>k.MobileNetV1FeatureExtractor,MobileNetV1ImageProcessor:()=>k.MobileNetV1ImageProcessor,MobileNetV2FeatureExtractor:()=>T.MobileNetV2FeatureExtractor,MobileNetV2ImageProcessor:()=>T.MobileNetV2ImageProcessor,MobileNetV3FeatureExtractor:()=>P.MobileNetV3FeatureExtractor,MobileNetV3ImageProcessor:()=>P.MobileNetV3ImageProcessor,MobileNetV4FeatureExtractor:()=>R.MobileNetV4FeatureExtractor,MobileNetV4ImageProcessor:()=>R.MobileNetV4ImageProcessor,MobileViTFeatureExtractor:()=>O.MobileViTFeatureExtractor,MobileViTImageProcessor:()=>O.MobileViTImageProcessor,NougatImageProcessor:()=>H.NougatImageProcessor,OwlViTFeatureExtractor:()=>z.OwlViTFeatureExtractor,OwlViTImageProcessor:()=>z.OwlViTImageProcessor,Owlv2ImageProcessor:()=>X.Owlv2ImageProcessor,Phi3VImageProcessor:()=>ne.Phi3VImageProcessor,PixtralImageProcessor:()=>re.PixtralImageProcessor,PvtImageProcessor:()=>Y.PvtImageProcessor,Qwen2VLImageProcessor:()=>se.Qwen2VLImageProcessor,RTDetrImageProcessor:()=>ue.RTDetrImageProcessor,Sam2ImageProcessor:()=>Pe.Sam2ImageProcessor,Sam3ImageProcessor:()=>oe.Sam3ImageProcessor,SamImageProcessor:()=>fe.SamImageProcessor,SegformerFeatureExtractor:()=>te.SegformerFeatureExtractor,SegformerImageProcessor:()=>te.SegformerImageProcessor,SiglipImageProcessor:()=>j.SiglipImageProcessor,SmolVLMImageProcessor:()=>G.SmolVLMImageProcessor,Swin2SRImageProcessor:()=>de.Swin2SRImageProcessor,VLMImageProcessor:()=>y.VLMImageProcessor,ViTFeatureExtractor:()=>be.ViTFeatureExtractor,ViTImageProcessor:()=>be.ViTImageProcessor,VitMatteImageProcessor:()=>xe.VitMatteImageProcessor,VitPoseImageProcessor:()=>Oe.VitPoseImageProcessor,YolosFeatureExtractor:()=>je.YolosFeatureExtractor,YolosImageProcessor:()=>je.YolosImageProcessor});var n=t("./src/models/beit/image_processing_beit.js"),i=t("./src/models/bit/image_processing_bit.js"),r=t("./src/models/chinese_clip/image_processing_chinese_clip.js"),o=t("./src/models/clip/image_processing_clip.js"),a=t("./src/models/convnext/image_processing_convnext.js"),l=t("./src/models/deit/image_processing_deit.js"),c=t("./src/models/detr/image_processing_detr.js"),d=t("./src/models/dinov3_vit/image_processing_dinov3_vit.js"),u=t("./src/models/donut/image_processing_donut.js"),h=t("./src/models/dpt/image_processing_dpt.js"),p=t("./src/models/efficientnet/image_processing_efficientnet.js"),f=t("./src/models/glpn/image_processing_glpn.js"),_=t("./src/models/grounding_dino/image_processing_grounding_dino.js"),b=t("./src/models/idefics3/image_processing_idefics3.js"),y=t("./src/models/janus/image_processing_janus.js"),w=t("./src/models/jina_clip/image_processing_jina_clip.js"),C=t("./src/models/llava_onevision/image_processing_llava_onevision.js"),M=t("./src/models/mask2former/image_processing_mask2former.js"),S=t("./src/models/maskformer/image_processing_maskformer.js"),k=t("./src/models/mobilenet_v1/image_processing_mobilenet_v1.js"),T=t("./src/models/mobilenet_v2/image_processing_mobilenet_v2.js"),P=t("./src/models/mobilenet_v3/image_processing_mobilenet_v3.js"),R=t("./src/models/mobilenet_v4/image_processing_mobilenet_v4.js"),O=t("./src/models/mobilevit/image_processing_mobilevit.js"),H=t("./src/models/nougat/image_processing_nougat.js"),X=t("./src/models/owlv2/image_processing_owlv2.js"),z=t("./src/models/owlvit/image_processing_owlvit.js"),ne=t("./src/models/phi3_v/image_processing_phi3_v.js"),re=t("./src/models/pixtral/image_processing_pixtral.js"),Y=t("./src/models/pvt/image_processing_pvt.js"),se=t("./src/models/qwen2_vl/image_processing_qwen2_vl.js"),ue=t("./src/models/rt_detr/image_processing_rt_detr.js"),fe=t("./src/models/sam/image_processing_sam.js"),Pe=t("./src/models/sam2/image_processing_sam2.js"),oe=t("./src/models/sam3/image_processing_sam3.js"),te=t("./src/models/segformer/image_processing_segformer.js"),j=t("./src/models/siglip/image_processing_siglip.js"),G=t("./src/models/smolvlm/image_processing_smolvlm.js"),de=t("./src/models/swin2sr/image_processing_swin2sr.js"),be=t("./src/models/vit/image_processing_vit.js"),xe=t("./src/models/vitmatte/image_processing_vitmatte.js"),Oe=t("./src/models/vitpose/image_processing_vitpose.js"),je=t("./src/models/yolos/image_processing_yolos.js")},"./src/models/janus/image_processing_janus.js":(s,e,t)=>{t.r(e),t.d(e,{VLMImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{constructor(o){super({do_pad:!0,pad_size:{width:o.image_size,height:o.image_size},...o}),this.constant_values=this.config.background_color.map(a=>a*this.rescale_factor)}pad_image(o,a,l,c){return super.pad_image(o,a,l,{constant_values:this.constant_values,center:!0,...c})}}},"./src/models/janus/processing_janus.js":(s,e,t)=>{t.r(e),t.d(e,{VLChatProcessor:()=>c});var n=t("./src/base/processing_utils.js"),i=t("./src/models/auto/image_processing_auto.js"),r=t("./src/tokenizers.js"),o=t("./src/utils/core.js"),a=t("./src/utils/tensor.js"),l=t("./src/utils/image.js");class c extends n.Processor{constructor(u,h,p){super(u,h,p),this.image_tag=this.config.image_tag,this.image_start_tag=this.config.image_start_tag,this.image_end_tag=this.config.image_end_tag,this.num_image_tokens=this.config.num_image_tokens}async _call(u,{images:h=null,chat_template:p="default"}={}){h?Array.isArray(h)||(h=[h]):h=await Promise.all(u.filter(O=>O.images).flatMap(O=>O.images).map(O=>l.RawImage.read(O)));let f=this.tokenizer,_=f.apply_chat_template(u,{tokenize:!1,add_generation_prompt:!0,chat_template:p}),b=O=>f.encode(O,{add_special_tokens:!1}),y=_.split(this.image_tag),w=y.length-1;if(h.length!==w)throw new Error(`Number of images provided (${h.length}) does not match number of "${this.image_tag}" image tags (${w})`);let[C,M,S]=f.model.convert_tokens_to_ids([this.image_tag,this.image_start_tag,this.image_end_tag]),k=b(y[0]),T=new Array(k.length).fill(!1);for(let O=1;O<y.length;++O){let H=new Array(this.num_image_tokens).fill(C),X=b(y[O]);k=(0,o.mergeArrays)(k,[M],H,[S],X);let z=new Array(this.num_image_tokens).fill(!0);T=(0,o.mergeArrays)(T,[!1],z,[!1],new Array(X.length).fill(!1))}let P=[1,k.length],R={input_ids:new a.Tensor("int64",k,P),attention_mask:new a.Tensor("int64",new Array(k.length).fill(1),P),images_seq_mask:new a.Tensor("bool",T,P),images_emb_mask:new a.Tensor("bool",new Array(w*this.num_image_tokens).fill(!0),[1,w,this.num_image_tokens])};if(h&&h.length>0){let O=await this.image_processor(h);return O.pixel_values.unsqueeze_(0),{...R,...O}}return R}}Z(c,"image_processor_class",i.AutoImageProcessor),Z(c,"tokenizer_class",r.AutoTokenizer),Z(c,"uses_processor_config",!0)},"./src/models/jina_clip/image_processing_jina_clip.js":(s,e,t)=>{t.r(e),t.d(e,{JinaCLIPImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{constructor(o){let{resize_mode:a,fill_color:l,interpolation:c,size:d,...u}=o,h=a==="squash"?{width:d,height:d}:a==="shortest"?{shortest_edge:d}:{longest_edge:d},p=c==="bicubic"?3:2;super({...u,size:h,resample:p,do_center_crop:!0,crop_size:d,do_normalize:!0})}}},"./src/models/jina_clip/processing_jina_clip.js":(s,e,t)=>{t.r(e),t.d(e,{JinaCLIPProcessor:()=>o});var n=t("./src/base/processing_utils.js"),i=t("./src/models/auto/image_processing_auto.js"),r=t("./src/tokenizers.js");class o extends n.Processor{async _call(l=null,c=null,d={}){if(!l&&!c)throw new Error("Either text or images must be provided");let u=l?this.tokenizer(l,d):{},h=c?await this.image_processor(c,d):{};return{...u,...h}}}Z(o,"tokenizer_class",r.AutoTokenizer),Z(o,"image_processor_class",i.AutoImageProcessor)},"./src/models/llava/processing_llava.js":(s,e,t)=>{t.r(e),t.d(e,{LlavaProcessor:()=>o});var n=t("./src/base/processing_utils.js"),i=t("./src/models/auto/image_processing_auto.js"),r=t("./src/tokenizers.js");class o extends n.Processor{async _call(l,c=null,d={}){let u=await this.image_processor(l,d);if(c){let[p,f]=u.pixel_values.dims.slice(-2),{image_token:_,patch_size:b,num_additional_image_tokens:y}=this.config,w=Math.floor(p/b)*Math.floor(f/b)+y;c=structuredClone(c),Array.isArray(c)||(c=[c]);for(let C=0;C<c.length;++C)c[C]=c[C].replace(_,_.repeat(w))}let h=c?this.tokenizer(c,d):{};return{...u,...h}}}Z(o,"tokenizer_class",r.AutoTokenizer),Z(o,"image_processor_class",i.AutoImageProcessor),Z(o,"uses_processor_config",!0)},"./src/models/llava_onevision/image_processing_llava_onevision.js":(s,e,t)=>{t.r(e),t.d(e,{LlavaOnevisionImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{}},"./src/models/mask2former/image_processing_mask2former.js":(s,e,t)=>{t.r(e),t.d(e,{Mask2FormerImageProcessor:()=>i});var n=t("./src/models/maskformer/image_processing_maskformer.js");class i extends n.MaskFormerImageProcessor{}},"./src/models/maskformer/image_processing_maskformer.js":(s,e,t)=>{t.r(e),t.d(e,{MaskFormerFeatureExtractor:()=>r,MaskFormerImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{post_process_panoptic_segmentation(...a){return(0,n.post_process_panoptic_segmentation)(...a)}post_process_instance_segmentation(...a){return(0,n.post_process_instance_segmentation)(...a)}}class r extends i{}},"./src/models/mgp_str/processing_mgp_str.js":(s,e,t)=>{t.r(e),t.d(e,{MgpstrProcessor:()=>l});var n=t("./src/base/processing_utils.js"),i=t("./src/models/auto/image_processing_auto.js"),r=t("./src/tokenizers.js"),o=t("./src/utils/maths.js");let a={char:["char_decode",1],bpe:["bpe_decode",2],wp:["wp_decode",102]};class l extends n.Processor{get char_tokenizer(){return this.components.char_tokenizer}get bpe_tokenizer(){return this.components.bpe_tokenizer}get wp_tokenizer(){return this.components.wp_tokenizer}_decode_helper(d,u){if(!a.hasOwnProperty(u))throw new Error(`Format ${u} is not supported.`);let[h,p]=a[u],f=this[h].bind(this),[_,b]=d.dims,y=[],w=[],C=d.tolist();for(let S=0;S<_;++S){let k=C[S],T=[],P=[];for(let O=1;O<b;++O){let[H,X]=(0,o.max)((0,o.softmax)(k[O]));if(P.push(H),X==p)break;T.push(X)}let R=P.length>0?P.reduce((O,H)=>O*H,1):0;w.push(T),y.push(R)}return[f(w),y]}char_decode(d){return this.char_tokenizer.batch_decode(d).map(u=>u.replaceAll(" ",""))}bpe_decode(d){return this.bpe_tokenizer.batch_decode(d)}wp_decode(d){return this.wp_tokenizer.batch_decode(d).map(u=>u.replaceAll(" ",""))}batch_decode([d,u,h]){let[p,f]=this._decode_helper(d,"char"),[_,b]=this._decode_helper(u,"bpe"),[y,w]=this._decode_helper(h,"wp"),C=[],M=[];for(let S=0;S<p.length;++S){let[k,T]=(0,o.max)([f[S],b[S],w[S]]);C.push([p[S],_[S],y[S]][T]),M.push(k)}return{generated_text:C,scores:M,char_preds:p,bpe_preds:_,wp_preds:y}}static async from_pretrained(...d){let u=await super.from_pretrained(...d),h=await r.AutoTokenizer.from_pretrained("Xenova/gpt2"),p=await r.AutoTokenizer.from_pretrained("Xenova/bert-base-uncased");return u.components={image_processor:u.image_processor,char_tokenizer:u.tokenizer,bpe_tokenizer:h,wp_tokenizer:p},u}async _call(d,u=null){let h=await this.image_processor(d);return u&&(h.labels=this.tokenizer(u).input_ids),h}}Z(l,"tokenizer_class",r.AutoTokenizer),Z(l,"image_processor_class",i.AutoImageProcessor)},"./src/models/mobilenet_v1/image_processing_mobilenet_v1.js":(s,e,t)=>{t.r(e),t.d(e,{MobileNetV1FeatureExtractor:()=>r,MobileNetV1ImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{}class r extends i{}},"./src/models/mobilenet_v2/image_processing_mobilenet_v2.js":(s,e,t)=>{t.r(e),t.d(e,{MobileNetV2FeatureExtractor:()=>r,MobileNetV2ImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{}class r extends i{}},"./src/models/mobilenet_v3/image_processing_mobilenet_v3.js":(s,e,t)=>{t.r(e),t.d(e,{MobileNetV3FeatureExtractor:()=>r,MobileNetV3ImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{}class r extends i{}},"./src/models/mobilenet_v4/image_processing_mobilenet_v4.js":(s,e,t)=>{t.r(e),t.d(e,{MobileNetV4FeatureExtractor:()=>r,MobileNetV4ImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{}class r extends i{}},"./src/models/mobilevit/image_processing_mobilevit.js":(s,e,t)=>{t.r(e),t.d(e,{MobileViTFeatureExtractor:()=>r,MobileViTImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{}class r extends i{}},"./src/models/moonshine/feature_extraction_moonshine.js":(s,e,t)=>{t.r(e),t.d(e,{MoonshineFeatureExtractor:()=>r});var n=t("./src/base/feature_extraction_utils.js"),i=t("./src/utils/tensor.js");class r extends n.FeatureExtractor{async _call(a){(0,n.validate_audio_inputs)(a,"MoonshineFeatureExtractor"),a instanceof Float64Array&&(a=new Float32Array(a));let l=[1,a.length];return{input_values:new i.Tensor("float32",a,l)}}}},"./src/models/moonshine/processing_moonshine.js":(s,e,t)=>{t.r(e),t.d(e,{MoonshineProcessor:()=>o});var n=t("./src/models/auto/feature_extraction_auto.js"),i=t("./src/tokenizers.js"),r=t("./src/base/processing_utils.js");class o extends r.Processor{async _call(l){return await this.feature_extractor(l)}}Z(o,"tokenizer_class",i.AutoTokenizer),Z(o,"feature_extractor_class",n.AutoFeatureExtractor)},"./src/models/nougat/image_processing_nougat.js":(s,e,t)=>{t.r(e),t.d(e,{NougatImageProcessor:()=>i});var n=t("./src/models/donut/image_processing_donut.js");class i extends n.DonutImageProcessor{}},"./src/models/owlv2/image_processing_owlv2.js":(s,e,t)=>{t.r(e),t.d(e,{Owlv2ImageProcessor:()=>i});var n=t("./src/models/owlvit/image_processing_owlvit.js");class i extends n.OwlViTImageProcessor{}},"./src/models/owlvit/image_processing_owlvit.js":(s,e,t)=>{t.r(e),t.d(e,{OwlViTFeatureExtractor:()=>r,OwlViTImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{post_process_object_detection(...a){return(0,n.post_process_object_detection)(...a)}}class r extends i{}},"./src/models/owlvit/processing_owlvit.js":(s,e,t)=>{t.r(e),t.d(e,{OwlViTProcessor:()=>o});var n=t("./src/base/processing_utils.js"),i=t("./src/models/auto/image_processing_auto.js"),r=t("./src/tokenizers.js");class o extends n.Processor{}Z(o,"tokenizer_class",r.AutoTokenizer),Z(o,"image_processor_class",i.AutoImageProcessor)},"./src/models/paligemma/processing_paligemma.js":(s,e,t)=>{t.r(e),t.d(e,{PaliGemmaProcessor:()=>l});var n=t("./src/base/processing_utils.js"),i=t("./src/models/auto/image_processing_auto.js"),r=t("./src/tokenizers.js");let o="<image>";function a(c,d,u,h,p){return`${h.repeat(u*p)}${d}${c}
`}class l extends n.Processor{async _call(d,u=null,h={}){u||(console.warn("You are using PaliGemma without a text prefix. It will perform as a picture-captioning model."),u=""),Array.isArray(d)||(d=[d]),Array.isArray(u)||(u=[u]);let p=this.tokenizer.bos_token,f=this.image_processor.config.image_seq_length,_;u.some(w=>w.includes(o))?_=u.map(w=>{let C=w.replaceAll(o,o.repeat(f)),M=C.lastIndexOf(o),S=M===-1?0:M+o.length;return C.slice(0,S)+p+C.slice(S)+`
`}):(console.warn("You are passing both `text` and `images` to `PaliGemmaProcessor`. The processor expects special image tokens in the text, as many tokens as there are images per each text. It is recommended to add `<image>` tokens in the very beginning of your text. For this call, we will infer how many images each text has and add special tokens."),_=u.map(w=>a(w,p,f,o,d.length)));let b=this.tokenizer(_,h);return{...await this.image_processor(d,h),...b}}}Z(l,"tokenizer_class",r.AutoTokenizer),Z(l,"image_processor_class",i.AutoImageProcessor),Z(l,"uses_processor_config",!1)},"./src/models/parakeet/feature_extraction_parakeet.js":(s,e,t)=>{t.r(e),t.d(e,{ParakeetFeatureExtractor:()=>a});var n=t("./src/base/feature_extraction_utils.js"),i=t("./src/utils/tensor.js"),r=t("./src/utils/audio.js");let o=1e-5;class a extends n.FeatureExtractor{constructor(c){var h;super(c),(h=this.config).mel_filters??(h.mel_filters=(0,r.mel_filter_bank)(Math.floor(1+this.config.n_fft/2),this.config.feature_size,0,this.config.sampling_rate/2,this.config.sampling_rate,"slaney","slaney"));let d=(0,r.window_function)(this.config.win_length,"hann",{periodic:!1});this.window=new Float64Array(this.config.n_fft);let u=Math.floor((this.config.n_fft-this.config.win_length)/2);this.window.set(d,u)}async _extract_fbank_features(c){let d=this.config.preemphasis;c=new Float64Array(c);for(let h=c.length-1;h>=1;--h)c[h]-=d*c[h-1];return await(0,r.spectrogram)(c,this.window,this.window.length,this.config.hop_length,{fft_length:this.config.n_fft,power:2,mel_filters:this.config.mel_filters,log_mel:"log",mel_floor:-1/0,pad_mode:"constant",center:!0,transpose:!0,mel_offset:2**-24})}async _call(c){(0,n.validate_audio_inputs)(c,"ParakeetFeatureExtractor");let d=await this._extract_fbank_features(c),u=Math.floor((c.length+Math.floor(this.config.n_fft/2)*2-this.config.n_fft)/this.config.hop_length),h=d.data;h.fill(0,u*d.dims[1]);let[p,f]=d.dims,_=new Float64Array(f),b=new Float64Array(f);for(let C=0;C<u;++C){let M=C*f;for(let S=0;S<f;++S){let k=h[M+S];_[S]+=k,b[S]+=k*k}}let y=u>1?u-1:1;for(let C=0;C<f;++C){let M=_[C]/u,S=(b[C]-u*M*M)/y,T=1/(Math.sqrt(S)+o);for(let P=0;P<u;++P){let R=P*f+C;h[R]=(h[R]-M)*T}}let w=new BigInt64Array(p);return w.fill(1n,0,u),{input_features:d.unsqueeze_(0),attention_mask:new i.Tensor("int64",w,[1,p])}}}},"./src/models/phi3_v/image_processing_phi3_v.js":(s,e,t)=>{t.r(e),t.d(e,{Phi3VImageProcessor:()=>d});var n=t("./src/base/image_processors_utils.js"),i=t("./src/utils/tensor.js");let r=336,o=[2,3],{ceil:a,floor:l,sqrt:c}=Math;class d extends n.ImageProcessor{constructor(h){super({...h,do_normalize:!0,do_pad:!0,pad_size:"custom",do_convert_rgb:!0,do_resize:!0}),this._num_crops=h.num_crops}calc_num_image_tokens_from_image_size(h,p){let{num_img_tokens:f}=this.config;return l((l(p/r)*l(h/r)+1)*f+1+(l(p/r)+1)*c(f))}get_resize_output_image_size(h,p){let f=this._num_crops,[_,b]=h.size,y=_/b,w=1;for(;w*Math.ceil(w/y)<=f;)w+=1;w-=1;let C=Math.floor(w*336),M=Math.floor(C/y);return[C,M]}pad_image(h,p,f,_={}){let[b,y]=p,w=r*a(b/r),C=r*a(y/r),M=[1,1,1].map((S,k)=>(S-this.image_mean[k])/this.image_std[k]);return super.pad_image(h,p,{width:C,height:w},{center:!0,constant_values:M,..._})}async _call(h,{num_crops:p=null}={}){if(this._num_crops=p??(p=this.config.num_crops),p<4||c(p)%1!==0)throw new Error("num_crops must be a square number >= 4");Array.isArray(h)||(h=[h]);let f=h.length,_=await Promise.all(h.map(T=>this.preprocess(T))),b=_.map(T=>T.original_size),y=_.map(T=>T.reshaped_input_size),w=[];for(let{pixel_values:T}of _){T.unsqueeze_(0);let[P,R]=T.dims.slice(-2),O=await(0,i.interpolate_4d)(T,{size:[r,r],mode:"bicubic"});if(p>0){let H=[],X=c(p),z=l(R/X),ne=l(P/X);for(let Y=0;Y<X;++Y)for(let se=0;se<X;++se){let ue,fe,Pe,oe;Y===X-1?(fe=P-ne,oe=P):(fe=Y*ne,oe=(Y+1)*ne),se===X-1?(ue=R-z,Pe=R):(ue=se*z,Pe=(se+1)*z);let te=[fe,ue],j=[oe,Pe],G=await(0,i.slice)(T,te,j,o);H.push(G)}let re=await(0,i.interpolate_4d)((0,i.cat)(H,0),{size:[r,r],mode:"bicubic"});w.push((0,i.cat)([O,re],0))}else w.push(O)}let C=(0,i.stack)(w,0),M=y.map(T=>T.map(P=>r*a(P/r))),S=new i.Tensor("int64",M.flat(),[f,2]),k=M.map(([T,P])=>this.calc_num_image_tokens_from_image_size(P,T));return{pixel_values:C,original_sizes:b,reshaped_input_sizes:y,image_sizes:S,num_img_tokens:k}}}},"./src/models/phi3_v/processing_phi3_v.js":(s,e,t)=>{t.r(e),t.d(e,{Phi3VProcessor:()=>c});var n=t("./src/base/processing_utils.js"),i=t("./src/models/auto/image_processing_auto.js"),r=t("./src/tokenizers.js"),o=t("./src/utils/image.js");let a="<|image|>",l=/<\|image_\d+\|>/g;class c extends n.Processor{async _call(u,h=null,{padding:p=!0,truncation:f=!0,num_crops:_=null}={}){Array.isArray(u)||(u=[u]);let b,y;if(h){y=await this.image_processor(h,{num_crops:_});let{num_img_tokens:w}=y,C=u.map((S,k)=>S.split(l).join(a.repeat(w[k])));b=this.tokenizer(C,{padding:p,truncation:f});let M=this.tokenizer.model.convert_tokens_to_ids([a])[0];b.input_ids.map_(S=>S==M?-S:S)}else b=this.tokenizer(u);return{...b,...y}}}Z(c,"image_processor_class",i.AutoImageProcessor),Z(c,"tokenizer_class",r.AutoTokenizer)},"./src/models/pixtral/image_processing_pixtral.js":(s,e,t)=>{t.r(e),t.d(e,{PixtralImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{get_resize_output_image_size(o,a){let{longest_edge:l}=a;if(l===void 0)throw new Error("size must contain 'longest_edge'");let[c,d]=o.size,u=Math.max(c,d)/l,h=c,p=d;u>1&&(h=Math.floor(c/u),p=Math.floor(d/u));let{patch_size:f,spatial_merge_size:_}=this.config;if(!_)throw new Error("config must contain 'spatial_merge_size'");let b=f*_,y=Math.floor((h-1)/b)+1,w=Math.floor((p-1)/b)+1;return[y*b,w*b]}}},"./src/models/pixtral/processing_pixtral.js":(s,e,t)=>{t.r(e),t.d(e,{PixtralProcessor:()=>o});var n=t("./src/base/processing_utils.js"),i=t("./src/models/auto/image_processing_auto.js"),r=t("./src/tokenizers.js");class o extends n.Processor{async _call(l,c=null,d={}){let u=await this.image_processor(l,d);if(c){let[p,f]=u.pixel_values.dims.slice(-2),{image_token:_,image_break_token:b,image_end_token:y,patch_size:w,spatial_merge_size:C}=this.config,M=w*C,S=Math.floor(p/M),k=Math.floor(f/M);c=structuredClone(c),Array.isArray(c)||(c=[c]);for(let T=0;T<c.length;++T){let P=_.repeat(k),R=P+b,O=P+y,H=R.repeat(S-1)+O;c[T]=c[T].replace(_,H)}}let h=c?this.tokenizer(c,d):{};return{...u,...h}}}Z(o,"tokenizer_class",r.AutoTokenizer),Z(o,"image_processor_class",i.AutoImageProcessor),Z(o,"uses_processor_config",!0)},"./src/models/processors.js":(s,e,t)=>{t.r(e),t.d(e,{Florence2Processor:()=>n.Florence2Processor,Gemma3nProcessor:()=>i.Gemma3nProcessor,GroundingDinoProcessor:()=>r.GroundingDinoProcessor,Idefics3Processor:()=>o.Idefics3Processor,JinaCLIPProcessor:()=>l.JinaCLIPProcessor,LlavaProcessor:()=>c.LlavaProcessor,MgpstrProcessor:()=>d.MgpstrProcessor,MoonshineProcessor:()=>u.MoonshineProcessor,OwlViTProcessor:()=>h.OwlViTProcessor,PaliGemmaProcessor:()=>p.PaliGemmaProcessor,Phi3VProcessor:()=>f.Phi3VProcessor,PixtralProcessor:()=>_.PixtralProcessor,PyAnnoteProcessor:()=>b.PyAnnoteProcessor,Qwen2VLProcessor:()=>y.Qwen2VLProcessor,Sam2Processor:()=>C.Sam2Processor,Sam2VideoProcessor:()=>C.Sam2VideoProcessor,SamProcessor:()=>w.SamProcessor,SmolVLMProcessor:()=>M.SmolVLMProcessor,SpeechT5Processor:()=>S.SpeechT5Processor,UltravoxProcessor:()=>k.UltravoxProcessor,VLChatProcessor:()=>a.VLChatProcessor,VoxtralProcessor:()=>T.VoxtralProcessor,Wav2Vec2Processor:()=>P.Wav2Vec2Processor,Wav2Vec2ProcessorWithLM:()=>R.Wav2Vec2ProcessorWithLM,WhisperProcessor:()=>O.WhisperProcessor});var n=t("./src/models/florence2/processing_florence2.js"),i=t("./src/models/gemma3n/processing_gemma3n.js"),r=t("./src/models/grounding_dino/processing_grounding_dino.js"),o=t("./src/models/idefics3/processing_idefics3.js"),a=t("./src/models/janus/processing_janus.js"),l=t("./src/models/jina_clip/processing_jina_clip.js"),c=t("./src/models/llava/processing_llava.js"),d=t("./src/models/mgp_str/processing_mgp_str.js"),u=t("./src/models/moonshine/processing_moonshine.js"),h=t("./src/models/owlvit/processing_owlvit.js"),p=t("./src/models/paligemma/processing_paligemma.js"),f=t("./src/models/phi3_v/processing_phi3_v.js"),_=t("./src/models/pixtral/processing_pixtral.js"),b=t("./src/models/pyannote/processing_pyannote.js"),y=t("./src/models/qwen2_vl/processing_qwen2_vl.js"),w=t("./src/models/sam/processing_sam.js"),C=t("./src/models/sam2/processing_sam2.js"),M=t("./src/models/smolvlm/processing_smolvlm.js"),S=t("./src/models/speecht5/processing_speecht5.js"),k=t("./src/models/ultravox/processing_ultravox.js"),T=t("./src/models/voxtral/processing_voxtral.js"),P=t("./src/models/wav2vec2/processing_wav2vec2.js"),R=t("./src/models/wav2vec2_with_lm/processing_wav2vec2_with_lm.js"),O=t("./src/models/whisper/processing_whisper.js")},"./src/models/pvt/image_processing_pvt.js":(s,e,t)=>{t.r(e),t.d(e,{PvtImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{}},"./src/models/pyannote/feature_extraction_pyannote.js":(s,e,t)=>{t.r(e),t.d(e,{PyAnnoteFeatureExtractor:()=>o});var n=t("./src/base/feature_extraction_utils.js"),i=t("./src/utils/tensor.js"),r=t("./src/utils/maths.js");class o extends n.FeatureExtractor{async _call(l){(0,n.validate_audio_inputs)(l,"PyAnnoteFeatureExtractor"),l instanceof Float64Array&&(l=new Float32Array(l));let c=[1,1,l.length];return{input_values:new i.Tensor("float32",l,c)}}samples_to_frames(l){return(l-this.config.offset)/this.config.step}post_process_speaker_diarization(l,c){let d=c/this.samples_to_frames(c)/this.config.sampling_rate,u=[];for(let h of l.tolist()){let p=[],f=-1;for(let _=0;_<h.length;++_){let b=(0,r.softmax)(h[_]),[y,w]=(0,r.max)(b),[C,M]=[_,_+1];w!==f?(f=w,p.push({id:w,start:C,end:M,score:y})):(p.at(-1).end=M,p.at(-1).score+=y)}u.push(p.map(({id:_,start:b,end:y,score:w})=>({id:_,start:b*d,end:y*d,confidence:w/(y-b)})))}return u}}},"./src/models/pyannote/processing_pyannote.js":(s,e,t)=>{t.r(e),t.d(e,{PyAnnoteProcessor:()=>r});var n=t("./src/base/processing_utils.js"),i=t("./src/models/pyannote/feature_extraction_pyannote.js");class r extends n.Processor{async _call(a){return await this.feature_extractor(a)}post_process_speaker_diarization(...a){return this.feature_extractor.post_process_speaker_diarization(...a)}get sampling_rate(){return this.feature_extractor.config.sampling_rate}}Z(r,"feature_extractor_class",i.PyAnnoteFeatureExtractor)},"./src/models/qwen2_vl/image_processing_qwen2_vl.js":(s,e,t)=>{t.r(e),t.d(e,{Qwen2VLImageProcessor:()=>r});var n=t("./src/base/image_processors_utils.js"),i=t("./src/utils/tensor.js");class r extends n.ImageProcessor{async _call(a,...l){let{pixel_values:c,original_sizes:d,reshaped_input_sizes:u}=await super._call(a,...l),h=c,{temporal_patch_size:p,merge_size:f,patch_size:_}=this.config;h.dims[0]===1&&(h=(0,i.cat)(Array.from({length:p},()=>h),0));let b=h.dims[0]/p,y=h.dims[1],w=Math.floor(h.dims[2]/_),C=Math.floor(h.dims[3]/_),M=h.view(b,p,y,Math.floor(w/f),f,_,Math.floor(C/f),f,_).permute(0,3,6,4,7,2,1,5,8).view(b*w*C,y*p*_*_),S=new i.Tensor("int64",[b,w,C],[1,3]);return{pixel_values:M,image_grid_thw:S,original_sizes:d,reshaped_input_sizes:u}}}},"./src/models/qwen2_vl/processing_qwen2_vl.js":(s,e,t)=>{t.r(e),t.d(e,{Qwen2VLProcessor:()=>a});var n=t("./src/base/processing_utils.js"),i=t("./src/models/auto/image_processing_auto.js"),r=t("./src/tokenizers.js"),o=t("./src/utils/image.js");class a extends n.Processor{async _call(c,d=null,...u){Array.isArray(c)||(c=[c]);let h,p;if(d&&(h=await this.image_processor(d),p=h.image_grid_thw),p){let _=this.image_processor.config.merge_size**2,b=0,y=p.tolist();c=c.map(w=>{for(;w.includes("<|image_pad|>");){let C=Number(y[b++].reduce((M,S)=>M*S,1n));w=w.replace("<|image_pad|>","<|placeholder|>".repeat(Math.floor(C/_)))}return w.replaceAll("<|placeholder|>","<|image_pad|>")})}return{...this.tokenizer(c),...h}}}Z(a,"image_processor_class",i.AutoImageProcessor),Z(a,"tokenizer_class",r.AutoTokenizer)},"./src/models/rt_detr/image_processing_rt_detr.js":(s,e,t)=>{t.r(e),t.d(e,{RTDetrImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{post_process_object_detection(...o){return(0,n.post_process_object_detection)(...o)}}},"./src/models/sam/image_processing_sam.js":(s,e,t)=>{t.r(e),t.d(e,{SamImageProcessor:()=>o});var n=t("./src/base/image_processors_utils.js"),i=t("./src/utils/core.js"),r=t("./src/utils/tensor.js");class o extends n.ImageProcessor{reshape_input_points(l,c,d,u=!1){l=structuredClone(l);let h=(0,i.calculateDimensions)(l);if(h.length===3)u||(h=[1,...h]),l=[l];else if(h.length!==4)throw Error("The input_points must be a 4D tensor of shape `batch_size`, `point_batch_size`, `nb_points_per_image`, `2`.");for(let p=0;p<l.length;++p){let[f,_]=c[p],[b,y]=d[p],w=[y/_,b/f];for(let C=0;C<l[p].length;++C)for(let M=0;M<l[p][C].length;++M)for(let S=0;S<l[p][C][M].length;++S)l[p][C][M][S]*=w[S%2]}return new r.Tensor("float32",Float32Array.from(l.flat(1/0)),h)}add_input_labels(l,c){let d=(0,i.calculateDimensions)(l);if(d.length===2)d=[1,...d],l=[l];else if(d.length!==3)throw Error("The input_points must be a 4D tensor of shape `batch_size`, `point_batch_size`, `nb_points_per_image`, `2`.");if(d.some((u,h)=>u!==c.dims[h]))throw Error(`The first ${d.length} dimensions of 'input_points' and 'input_labels' must be the same.`);return new r.Tensor("int64",l.flat(1/0).map(BigInt),d)}async _call(l,{input_points:c=null,input_labels:d=null,input_boxes:u=null}={}){let h=await super._call(l);if(c&&(h.input_points=this.reshape_input_points(c,h.original_sizes,h.reshaped_input_sizes)),d){if(!h.input_points)throw Error("`input_points` must be provided if `input_labels` are provided.");h.input_labels=this.add_input_labels(d,h.input_points)}return u&&(h.input_boxes=this.reshape_input_points(u,h.original_sizes,h.reshaped_input_sizes,!0)),h}async post_process_masks(l,c,d,{mask_threshold:u=0,binarize:h=!0,pad_size:p=null}={}){let f=[];p=p??this.pad_size??this.size;let _=[p.height,p.width];for(let b=0;b<c.length;++b){let y=c[b],w=d[b],C=await(0,r.interpolate_4d)(l[b],{mode:"bilinear",size:_});if(C=C.slice(null,null,[0,w[0]],[0,w[1]]),C=await(0,r.interpolate_4d)(C,{mode:"bilinear",size:y}),h){let M=C.data,S=new Uint8Array(M.length);for(let k=0;k<M.length;++k)M[k]>u&&(S[k]=1);C=new r.Tensor("bool",S,C.dims)}f.push(C)}return f}generate_crop_boxes(l,c,{crop_n_layers:d=0,overlap_ratio:u=512/1500,points_per_crop:h=32,crop_n_points_downscale_factor:p=1}={}){}}},"./src/models/sam/processing_sam.js":(s,e,t)=>{t.r(e),t.d(e,{SamProcessor:()=>r});var n=t("./src/base/processing_utils.js"),i=t("./src/models/auto/image_processing_auto.js");class r extends n.Processor{async _call(...a){return await this.image_processor(...a)}post_process_masks(...a){return this.image_processor.post_process_masks(...a)}reshape_input_points(...a){return this.image_processor.reshape_input_points(...a)}}Z(r,"image_processor_class",i.AutoImageProcessor)},"./src/models/sam2/image_processing_sam2.js":(s,e,t)=>{t.r(e),t.d(e,{Sam2ImageProcessor:()=>n.SamImageProcessor});var n=t("./src/models/sam/image_processing_sam.js")},"./src/models/sam2/processing_sam2.js":(s,e,t)=>{t.r(e),t.d(e,{Sam2Processor:()=>i,Sam2VideoProcessor:()=>r});var n=t("./src/models/sam/processing_sam.js");class i extends n.SamProcessor{}class r extends i{}},"./src/models/sam3/image_processing_sam3.js":(s,e,t)=>{t.r(e),t.d(e,{Sam3ImageProcessor:()=>n.Sam2ImageProcessor});var n=t("./src/models/sam2/image_processing_sam2.js")},"./src/models/seamless_m4t/feature_extraction_seamless_m4t.js":(s,e,t)=>{t.r(e),t.d(e,{SeamlessM4TFeatureExtractor:()=>o});var n=t("./src/base/feature_extraction_utils.js"),i=t("./src/utils/tensor.js"),r=t("./src/utils/audio.js");class o extends n.FeatureExtractor{constructor(l){super(l);let c=this.config.sampling_rate,d=(0,r.mel_filter_bank)(257,this.config.num_mel_bins,20,Math.floor(c/2),c,null,"kaldi",!0);this.mel_filters=d,this.window=(0,r.window_function)(400,"povey",{periodic:!1})}async _extract_fbank_features(l,c){return l=l.map(d=>d*32768),(0,r.spectrogram)(l,this.window,400,160,{fft_length:512,power:2,center:!1,preemphasis:.97,mel_filters:this.mel_filters,log_mel:"log",mel_floor:1192092955078125e-22,remove_dc_offset:!0,max_num_frames:c,transpose:!0})}async _call(l,{padding:c=!0,pad_to_multiple_of:d=2,do_normalize_per_mel_bins:u=!0,return_attention_mask:h=!0}={}){(0,n.validate_audio_inputs)(l,"SeamlessM4TFeatureExtractor");let p=await this._extract_fbank_features(l,this.config.max_length);if(u){let[S,k]=p.dims,T=p.data;for(let P=0;P<k;++P){let R=0;for(let z=0;z<S;++z)R+=T[z*k+P];let O=R/S,H=0;for(let z=0;z<S;++z)H+=(T[z*k+P]-O)**2;H/=S-1;let X=Math.sqrt(H+1e-7);for(let z=0;z<S;++z){let ne=z*k+P;T[ne]=(T[ne]-O)/X}}}let f;if(c){let[S,k]=p.dims,T=p.data,P=S%d;if(P>0){let R=new Float32Array(k*(S+P));R.set(T),R.fill(this.config.padding_value,T.length);let O=S+P;p=new i.Tensor(p.type,R,[O,k]),h&&(f=new i.Tensor("int64",new BigInt64Array(O),[1,O]),f.data.fill(1n,0,S))}}let[_,b]=p.dims,y=this.config.stride;if(_%y!==0)throw new Error(`The number of frames (${_}) must be a multiple of the stride (${y}).`);let C=p.view(1,Math.floor(_/y),b*y),M={input_features:C};if(h){let S=C.dims[1],k=new BigInt64Array(S);if(f){let T=f.data;for(let P=1,R=0;P<_;P+=y,++R)k[R]=T[P]}else k.fill(1n);M.attention_mask=new i.Tensor("int64",k,[1,S])}return M}}},"./src/models/segformer/image_processing_segformer.js":(s,e,t)=>{t.r(e),t.d(e,{SegformerFeatureExtractor:()=>r,SegformerImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{post_process_semantic_segmentation(...a){return(0,n.post_process_semantic_segmentation)(...a)}}class r extends i{}},"./src/models/siglip/image_processing_siglip.js":(s,e,t)=>{t.r(e),t.d(e,{SiglipImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{}},"./src/models/smolvlm/image_processing_smolvlm.js":(s,e,t)=>{t.r(e),t.d(e,{SmolVLMImageProcessor:()=>n.Idefics3ImageProcessor});var n=t("./src/models/idefics3/image_processing_idefics3.js")},"./src/models/smolvlm/processing_smolvlm.js":(s,e,t)=>{t.r(e),t.d(e,{SmolVLMProcessor:()=>n.Idefics3Processor});var n=t("./src/models/idefics3/processing_idefics3.js")},"./src/models/snac/feature_extraction_snac.js":(s,e,t)=>{t.r(e),t.d(e,{SnacFeatureExtractor:()=>i});var n=t("./src/models/dac/feature_extraction_dac.js");class i extends n.DacFeatureExtractor{}},"./src/models/speecht5/feature_extraction_speecht5.js":(s,e,t)=>{t.r(e),t.d(e,{SpeechT5FeatureExtractor:()=>i});var n=t("./src/base/feature_extraction_utils.js");class i extends n.FeatureExtractor{}},"./src/models/speecht5/processing_speecht5.js":(s,e,t)=>{t.r(e),t.d(e,{SpeechT5Processor:()=>o});var n=t("./src/base/processing_utils.js"),i=t("./src/tokenizers.js"),r=t("./src/models/auto/feature_extraction_auto.js");class o extends n.Processor{async _call(l){return await this.feature_extractor(l)}}Z(o,"tokenizer_class",i.AutoTokenizer),Z(o,"feature_extractor_class",r.AutoFeatureExtractor)},"./src/models/swin2sr/image_processing_swin2sr.js":(s,e,t)=>{t.r(e),t.d(e,{Swin2SRImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{pad_image(o,a,l,c={}){let[d,u,h]=a;return super.pad_image(o,a,{width:u+(l-u%l)%l,height:d+(l-d%l)%l},{mode:"symmetric",center:!1,constant_values:-1,...c})}}},"./src/models/ultravox/processing_ultravox.js":(s,e,t)=>{t.r(e),t.d(e,{UltravoxProcessor:()=>o});var n=t("./src/models/auto/feature_extraction_auto.js"),i=t("./src/tokenizers.js"),r=t("./src/base/processing_utils.js");class o extends r.Processor{async _call(l,c=null,d={}){if(Array.isArray(l))throw new Error("Batched inputs are not supported yet.");let u={};if(c){let p=c.length,{input_features:f}=await this.feature_extractor(c,{...d,max_length:p}),_=Math.round(p/this.config.encoder_ds_factor+1e-4),b=1+Math.ceil(_/this.config.stack_factor);u.audio_token_len=[b],u.audio_values=f;let y=this.config.audio_placeholder;if(!l.includes(y))throw new Error(`The input text does not contain the image token ${y}.`);l=l.replaceAll(y,y.repeat(b))}return{...this.tokenizer(l,{add_special_tokens:!1,...d}),...u}}}Z(o,"tokenizer_class",i.AutoTokenizer),Z(o,"feature_extractor_class",n.AutoFeatureExtractor),Z(o,"uses_processor_config",!0)},"./src/models/vit/image_processing_vit.js":(s,e,t)=>{t.r(e),t.d(e,{ViTFeatureExtractor:()=>r,ViTImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{}class r extends i{}},"./src/models/vitmatte/image_processing_vitmatte.js":(s,e,t)=>{t.r(e),t.d(e,{VitMatteImageProcessor:()=>r});var n=t("./src/base/image_processors_utils.js"),i=t("./src/utils/tensor.js");class r extends n.ImageProcessor{async _call(a,l){Array.isArray(a)||(a=[a]),Array.isArray(l)||(l=[l]);let c=await Promise.all(a.map(h=>this.preprocess(h))),d=await Promise.all(l.map(h=>this.preprocess(h,{do_normalize:!1,do_convert_rgb:!1,do_convert_grayscale:!0})));return{pixel_values:(0,i.stack)(c.map((h,p)=>(0,i.cat)([h.pixel_values,d[p].pixel_values],0)),0),original_sizes:c.map(h=>h.original_size),reshaped_input_sizes:c.map(h=>h.reshaped_input_size)}}}},"./src/models/vitpose/image_processing_vitpose.js":(s,e,t)=>{t.r(e),t.d(e,{VitPoseImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{post_process_pose_estimation(o,a,{threshold:l=null}={}){let c=o.tolist(),[d,u,h,p]=o.dims,f=[];for(let _=0;_<d;++_){let b=c[_],y=a[_],w=[];for(let C=0;C<y.length;++C){let M=y[C],S=[],k=[],T=[],P=M.at(-2)/p,R=M.at(-1)/h;for(let O=0;O<b.length;++O){let[H,X]=[0,0],z=0,ne=-1/0,re=b[O];for(let se=0;se<re.length;++se){let ue=re[se];for(let fe=0;fe<ue.length;++fe){let Pe=ue[fe];z+=Pe,ne=Math.max(ne,Pe),H+=(fe+.5)*Pe,X+=se*Pe}}if(l!=null&&ne<l)continue;let Y=[P*H/z,R*X/z];S.push(Y),T.push(O),k.push(ne)}w.push({bbox:M,scores:k,labels:T,keypoints:S})}f.push(w)}return f}}},"./src/models/voxtral/processing_voxtral.js":(s,e,t)=>{t.r(e),t.d(e,{VoxtralProcessor:()=>u});var n=t("./src/models/auto/feature_extraction_auto.js"),i=t("./src/tokenizers.js"),r=t("./src/base/processing_utils.js"),o=t("./src/utils/tensor.js");let a="[AUDIO]",l="[BEGIN_AUDIO]",c=375;function d(h,p){let f=[];for(let _=0;_<h.length;_+=p)f.push(h.subarray(_,Math.min(_+p,h.length)));return f}class u extends r.Processor{async _call(p,f=null,_={}){if(Array.isArray(p))throw new Error("Batched inputs are not supported yet.");let b={};if(f){if(!p.includes(a))throw new Error(`The input text does not contain the audio token ${a}.`);Array.isArray(f)||(f=[f]);let w=p.split(a),C=w.length-1;if(C!==f.length)throw new Error(`The number of audio inputs (${f.length}) does not match the number of audio tokens in the text (${C}).`);let M=this.feature_extractor.config.n_samples,S=f.map(O=>d(O,M)),k=S.map(O=>O.length),T=S.flat(),P=(await Promise.all(T.map(O=>this.feature_extractor(O,_)))).map(O=>O.input_features);b.audio_values=P.length>1?(0,o.cat)(P,0):P[0];let R=w[0];for(let O=0;O<k.length;++O){R+=l;for(let H=0;H<k[O];++H)R+=a.repeat(c);R+=w[O+1]}p=R}return{...this.tokenizer(p,{add_special_tokens:!1,..._}),...b}}}Z(u,"tokenizer_class",i.AutoTokenizer),Z(u,"feature_extractor_class",n.AutoFeatureExtractor),Z(u,"uses_processor_config",!1)},"./src/models/wav2vec2/feature_extraction_wav2vec2.js":(s,e,t)=>{t.r(e),t.d(e,{Wav2Vec2FeatureExtractor:()=>r});var n=t("./src/base/feature_extraction_utils.js"),i=t("./src/utils/tensor.js");class r extends n.FeatureExtractor{_zero_mean_unit_var_norm(a){let c=a.reduce((u,h)=>u+h,0)/a.length,d=a.reduce((u,h)=>u+(h-c)**2,0)/a.length;return a.map(u=>(u-c)/Math.sqrt(d+1e-7))}async _call(a){(0,n.validate_audio_inputs)(a,"Wav2Vec2FeatureExtractor"),a instanceof Float64Array&&(a=new Float32Array(a));let l=a;this.config.do_normalize&&(l=this._zero_mean_unit_var_norm(l));let c=[1,l.length];return{input_values:new i.Tensor("float32",l,c),attention_mask:new i.Tensor("int64",new BigInt64Array(l.length).fill(1n),c)}}}},"./src/models/wav2vec2/processing_wav2vec2.js":(s,e,t)=>{t.r(e),t.d(e,{Wav2Vec2Processor:()=>o});var n=t("./src/tokenizers.js"),i=t("./src/models/auto/feature_extraction_auto.js"),r=t("./src/base/processing_utils.js");class o extends r.Processor{async _call(l){return await this.feature_extractor(l)}}Z(o,"tokenizer_class",n.AutoTokenizer),Z(o,"feature_extractor_class",i.AutoFeatureExtractor)},"./src/models/wav2vec2_with_lm/processing_wav2vec2_with_lm.js":(s,e,t)=>{t.r(e),t.d(e,{Wav2Vec2ProcessorWithLM:()=>o});var n=t("./src/tokenizers.js"),i=t("./src/models/auto/feature_extraction_auto.js"),r=t("./src/base/processing_utils.js");class o extends r.Processor{async _call(l){return await this.feature_extractor(l)}}Z(o,"tokenizer_class",n.AutoTokenizer),Z(o,"feature_extractor_class",i.AutoFeatureExtractor)},"./src/models/wespeaker/feature_extraction_wespeaker.js":(s,e,t)=>{t.r(e),t.d(e,{WeSpeakerFeatureExtractor:()=>o});var n=t("./src/base/feature_extraction_utils.js"),i=t("./src/utils/tensor.js"),r=t("./src/utils/audio.js");class o extends n.FeatureExtractor{constructor(l){super(l);let c=this.config.sampling_rate,d=(0,r.mel_filter_bank)(257,this.config.num_mel_bins,20,Math.floor(c/2),c,null,"kaldi",!0);this.mel_filters=d,this.window=(0,r.window_function)(400,"hamming",{periodic:!1}),this.min_num_frames=this.config.min_num_frames}async _extract_fbank_features(l){return l=l.map(c=>c*32768),(0,r.spectrogram)(l,this.window,400,160,{fft_length:512,power:2,center:!1,preemphasis:.97,mel_filters:this.mel_filters,log_mel:"log",mel_floor:1192092955078125e-22,remove_dc_offset:!0,transpose:!0,min_num_frames:this.min_num_frames})}async _call(l){(0,n.validate_audio_inputs)(l,"WeSpeakerFeatureExtractor");let c=(await this._extract_fbank_features(l)).unsqueeze_(0);if(this.config.fbank_centering_span===null){let d=c.mean(1).data,u=c.data,[h,p,f]=c.dims;for(let _=0;_<h;++_){let b=_*p*f,y=_*f;for(let w=0;w<p;++w){let C=b+w*f;for(let M=0;M<f;++M)u[C+M]-=d[y+M]}}}return{input_features:c}}}},"./src/models/whisper/common_whisper.js":(s,e,t)=>{t.r(e),t.d(e,{WHISPER_LANGUAGE_MAPPING:()=>i,WHISPER_TO_LANGUAGE_CODE_MAPPING:()=>r,whisper_language_to_code:()=>o});let n=[["en","english"],["zh","chinese"],["de","german"],["es","spanish"],["ru","russian"],["ko","korean"],["fr","french"],["ja","japanese"],["pt","portuguese"],["tr","turkish"],["pl","polish"],["ca","catalan"],["nl","dutch"],["ar","arabic"],["sv","swedish"],["it","italian"],["id","indonesian"],["hi","hindi"],["fi","finnish"],["vi","vietnamese"],["he","hebrew"],["uk","ukrainian"],["el","greek"],["ms","malay"],["cs","czech"],["ro","romanian"],["da","danish"],["hu","hungarian"],["ta","tamil"],["no","norwegian"],["th","thai"],["ur","urdu"],["hr","croatian"],["bg","bulgarian"],["lt","lithuanian"],["la","latin"],["mi","maori"],["ml","malayalam"],["cy","welsh"],["sk","slovak"],["te","telugu"],["fa","persian"],["lv","latvian"],["bn","bengali"],["sr","serbian"],["az","azerbaijani"],["sl","slovenian"],["kn","kannada"],["et","estonian"],["mk","macedonian"],["br","breton"],["eu","basque"],["is","icelandic"],["hy","armenian"],["ne","nepali"],["mn","mongolian"],["bs","bosnian"],["kk","kazakh"],["sq","albanian"],["sw","swahili"],["gl","galician"],["mr","marathi"],["pa","punjabi"],["si","sinhala"],["km","khmer"],["sn","shona"],["yo","yoruba"],["so","somali"],["af","afrikaans"],["oc","occitan"],["ka","georgian"],["be","belarusian"],["tg","tajik"],["sd","sindhi"],["gu","gujarati"],["am","amharic"],["yi","yiddish"],["lo","lao"],["uz","uzbek"],["fo","faroese"],["ht","haitian creole"],["ps","pashto"],["tk","turkmen"],["nn","nynorsk"],["mt","maltese"],["sa","sanskrit"],["lb","luxembourgish"],["my","myanmar"],["bo","tibetan"],["tl","tagalog"],["mg","malagasy"],["as","assamese"],["tt","tatar"],["haw","hawaiian"],["ln","lingala"],["ha","hausa"],["ba","bashkir"],["jw","javanese"],["su","sundanese"]],i=new Map(n),r=new Map([...n.map(([a,l])=>[l,a]),["burmese","my"],["valencian","ca"],["flemish","nl"],["haitian","ht"],["letzeburgesch","lb"],["pushto","ps"],["panjabi","pa"],["moldavian","ro"],["moldovan","ro"],["sinhalese","si"],["castilian","es"]]);function o(a){a=a.toLowerCase();let l=r.get(a);if(l===void 0){let c=a.match(/^<\|([a-z]{2})\|>$/);if(c&&(a=c[1]),i.has(a))l=a;else{let u=a.length===2?i.keys():i.values();throw new Error(`Language "${a}" is not supported. Must be one of: ${JSON.stringify(Array.from(u))}`)}}return l}},"./src/models/whisper/feature_extraction_whisper.js":(s,e,t)=>{t.r(e),t.d(e,{WhisperFeatureExtractor:()=>a});var n=t("./src/base/feature_extraction_utils.js"),i=t("./src/utils/tensor.js"),r=t("./src/utils/audio.js"),o=t("./src/utils/maths.js");class a extends n.FeatureExtractor{constructor(c){var d;super(c),(d=this.config).mel_filters??(d.mel_filters=(0,r.mel_filter_bank)(Math.floor(1+this.config.n_fft/2),this.config.feature_size,0,8e3,this.config.sampling_rate,"slaney","slaney")),this.window=(0,r.window_function)(this.config.n_fft,"hann")}async _extract_fbank_features(c){let d=await(0,r.spectrogram)(c,this.window,this.config.n_fft,this.config.hop_length,{power:2,mel_filters:this.config.mel_filters,log_mel:"log10",max_num_frames:Math.min(Math.floor(c.length/this.config.hop_length),this.config.nb_max_frames)}),u=d.data,h=(0,o.max)(u)[0];for(let p=0;p<u.length;++p)u[p]=(Math.max(u[p],h-8)+4)/4;return d}async _call(c,{max_length:d=null}={}){(0,n.validate_audio_inputs)(c,"WhisperFeatureExtractor");let u,h=d??this.config.n_samples;return c.length>h?(c.length>this.config.n_samples&&console.warn("Attempting to extract features for audio longer than 30 seconds. If using a pipeline to extract transcript from a long audio clip, remember to specify `chunk_length_s` and/or `stride_length_s`."),u=c.slice(0,h)):(u=new Float32Array(h),u.set(c)),{input_features:(await this._extract_fbank_features(u)).unsqueeze_(0)}}}},"./src/models/whisper/generation_whisper.js":(s,e,t)=>{t.r(e),t.d(e,{WhisperGenerationConfig:()=>i});var n=t("./src/generation/configuration_utils.js");class i extends n.GenerationConfig{constructor(){super(...arguments);Z(this,"return_timestamps",null);Z(this,"return_token_timestamps",null);Z(this,"num_frames",null);Z(this,"alignment_heads",null);Z(this,"task",null);Z(this,"language",null);Z(this,"no_timestamps_token_id",null);Z(this,"prompt_ids",null);Z(this,"is_multilingual",null);Z(this,"lang_to_id",null);Z(this,"task_to_id",null);Z(this,"max_initial_timestamp_index",1)}}},"./src/models/whisper/processing_whisper.js":(s,e,t)=>{t.r(e),t.d(e,{WhisperProcessor:()=>o});var n=t("./src/models/auto/feature_extraction_auto.js"),i=t("./src/tokenizers.js"),r=t("./src/base/processing_utils.js");class o extends r.Processor{async _call(l){return await this.feature_extractor(l)}}Z(o,"tokenizer_class",i.AutoTokenizer),Z(o,"feature_extractor_class",n.AutoFeatureExtractor)},"./src/models/yolos/image_processing_yolos.js":(s,e,t)=>{t.r(e),t.d(e,{YolosFeatureExtractor:()=>r,YolosImageProcessor:()=>i});var n=t("./src/base/image_processors_utils.js");class i extends n.ImageProcessor{post_process_object_detection(...a){return(0,n.post_process_object_detection)(...a)}}class r extends i{}},"./src/ops/registry.js":(s,e,t)=>{t.r(e),t.d(e,{TensorOpRegistry:()=>o});var n=t("./src/backends/onnx.js"),i=t("./src/utils/tensor.js");let r=async(a,l,c)=>{let d=await(0,n.createInferenceSession)(new Uint8Array(a),l);return async u=>{let h=(0,n.isONNXProxy)(),p=Object.fromEntries(Object.entries(u).map(([_,b])=>[_,(h?b.clone():b).ort_tensor])),f=await(0,n.runInferenceSession)(d,p);return Array.isArray(c)?c.map(_=>new i.Tensor(f[_])):new i.Tensor(f[c])}};class o{static get nearest_interpolate_4d(){return this._nearest_interpolate_4d||(this._nearest_interpolate_4d=r([8,10,18,0,58,129,1,10,41,10,1,120,10,0,10,0,10,1,115,18,1,121,34,6,82,101,115,105,122,101,42,18,10,4,109,111,100,101,34,7,110,101,97,114,101,115,116,160,1,3,18,1,114,90,31,10,1,120,18,26,10,24,8,1,18,20,10,3,18,1,98,10,3,18,1,99,10,3,18,1,104,10,3,18,1,119,90,15,10,1,115,18,10,10,8,8,7,18,4,10,2,8,4,98,31,10,1,121,18,26,10,24,8,1,18,20,10,3,18,1,98,10,3,18,1,99,10,3,18,1,104,10,3,18,1,119,66,2,16,21],this.session_options,"y")),this._nearest_interpolate_4d}static get bilinear_interpolate_4d(){return this._bilinear_interpolate_4d||(this._bilinear_interpolate_4d=r([8,9,18,0,58,128,1,10,40,10,1,120,10,0,10,0,10,1,115,18,1,121,34,6,82,101,115,105,122,101,42,17,10,4,109,111,100,101,34,6,108,105,110,101,97,114,160,1,3,18,1,114,90,31,10,1,120,18,26,10,24,8,1,18,20,10,3,18,1,98,10,3,18,1,99,10,3,18,1,104,10,3,18,1,119,90,15,10,1,115,18,10,10,8,8,7,18,4,10,2,8,4,98,31,10,1,121,18,26,10,24,8,1,18,20,10,3,18,1,98,10,3,18,1,99,10,3,18,1,104,10,3,18,1,119,66,2,16,20],this.session_options,"y")),this._bilinear_interpolate_4d}static get bicubic_interpolate_4d(){return this._bicubic_interpolate_4d||(this._bicubic_interpolate_4d=r([8,9,18,0,58,127,10,39,10,1,120,10,0,10,0,10,1,115,18,1,121,34,6,82,101,115,105,122,101,42,16,10,4,109,111,100,101,34,5,99,117,98,105,99,160,1,3,18,1,114,90,31,10,1,120,18,26,10,24,8,1,18,20,10,3,18,1,98,10,3,18,1,99,10,3,18,1,104,10,3,18,1,119,90,15,10,1,115,18,10,10,8,8,7,18,4,10,2,8,4,98,31,10,1,121,18,26,10,24,8,1,18,20,10,3,18,1,98,10,3,18,1,99,10,3,18,1,104,10,3,18,1,119,66,2,16,20],this.session_options,"y")),this._bicubic_interpolate_4d}static get matmul(){return this._matmul||(this._matmul=r([8,9,18,0,58,55,10,17,10,1,97,10,1,98,18,1,99,34,6,77,97,116,77,117,108,18,1,114,90,9,10,1,97,18,4,10,2,8,1,90,9,10,1,98,18,4,10,2,8,1,98,9,10,1,99,18,4,10,2,8,1,66,2,16,20],this.session_options,"c")),this._matmul}static get stft(){return this._stft||(this._stft=r([8,7,18,0,58,148,1,10,38,10,1,115,10,1,106,10,1,119,10,1,108,18,1,111,34,4,83,84,70,84,42,15,10,8,111,110,101,115,105,100,101,100,24,1,160,1,2,18,1,115,90,26,10,1,115,18,21,10,19,8,1,18,15,10,3,18,1,98,10,3,18,1,115,10,3,18,1,99,90,11,10,1,106,18,6,10,4,8,7,18,0,90,16,10,1,119,18,11,10,9,8,1,18,5,10,3,18,1,119,90,11,10,1,108,18,6,10,4,8,7,18,0,98,31,10,1,111,18,26,10,24,8,1,18,20,10,3,18,1,98,10,3,18,1,102,10,3,18,1,100,10,3,18,1,99,66,2,16,17],this.session_options,"o")),this._stft}static get rfft(){return this._rfft||(this._rfft=r([8,9,18,0,58,97,10,33,10,1,120,10,0,10,1,97,18,1,121,34,3,68,70,84,42,15,10,8,111,110,101,115,105,100,101,100,24,1,160,1,2,18,1,100,90,21,10,1,120,18,16,10,14,8,1,18,10,10,3,18,1,115,10,3,18,1,99,90,11,10,1,97,18,6,10,4,8,7,18,0,98,21,10,1,121,18,16,10,14,8,1,18,10,10,3,18,1,115,10,3,18,1,99,66,2,16,20],this.session_options,"y")),this._rfft}static get top_k(){return this._top_k||(this._top_k=r([8,10,18,0,58,73,10,18,10,1,120,10,1,107,18,1,118,18,1,105,34,4,84,111,112,75,18,1,116,90,9,10,1,120,18,4,10,2,8,1,90,15,10,1,107,18,10,10,8,8,7,18,4,10,2,8,1,98,9,10,1,118,18,4,10,2,8,1,98,9,10,1,105,18,4,10,2,8,7,66,2,16,21],this.session_options,["v","i"])),this._top_k}static get slice(){return this._slice||(this._slice=r([8,7,18,0,58,96,10,25,10,1,120,10,1,115,10,1,101,10,1,97,10,1,116,18,1,121,34,5,83,108,105,99,101,18,1,114,90,9,10,1,120,18,4,10,2,8,1,90,9,10,1,115,18,4,10,2,8,7,90,9,10,1,101,18,4,10,2,8,7,90,9,10,1,97,18,4,10,2,8,7,90,9,10,1,116,18,4,10,2,8,7,98,9,10,1,121,18,4,10,2,8,1,66,2,16,13],this.session_options,"y")),this._slice}}Z(o,"session_options",{})},"./src/pipelines.js":(s,e,t)=>{t.r(e),t.d(e,{AudioClassificationPipeline:()=>z,AutomaticSpeechRecognitionPipeline:()=>re,BackgroundRemovalPipeline:()=>fe,DepthEstimationPipeline:()=>be,DocumentQuestionAnsweringPipeline:()=>j,FeatureExtractionPipeline:()=>H,FillMaskPipeline:()=>M,ImageClassificationPipeline:()=>se,ImageFeatureExtractionPipeline:()=>X,ImageSegmentationPipeline:()=>ue,ImageToImagePipeline:()=>de,ImageToTextPipeline:()=>Y,ObjectDetectionPipeline:()=>oe,Pipeline:()=>b,QuestionAnsweringPipeline:()=>C,SummarizationPipeline:()=>k,Text2TextGenerationPipeline:()=>S,TextClassificationPipeline:()=>y,TextGenerationPipeline:()=>R,TextToAudioPipeline:()=>G,TokenClassificationPipeline:()=>w,TranslationPipeline:()=>T,ZeroShotAudioClassificationPipeline:()=>ne,ZeroShotClassificationPipeline:()=>O,ZeroShotImageClassificationPipeline:()=>Pe,ZeroShotObjectDetectionPipeline:()=>te,pipeline:()=>je});var n=t("./src/tokenizers.js"),i=t("./src/models.js"),r=t("./src/models/auto/processing_auto.js"),o=t("./src/base/processing_utils.js"),a=t("./src/utils/generic.js"),l=t("./src/utils/core.js"),c=t("./src/utils/maths.js"),d=t("./src/utils/audio.js"),u=t("./src/utils/tensor.js"),h=t("./src/utils/image.js");async function p(Re){return Array.isArray(Re)||(Re=[Re]),await Promise.all(Re.map(U=>h.RawImage.read(U)))}async function f(Re,U){return Array.isArray(Re)||(Re=[Re]),await Promise.all(Re.map(pe=>typeof pe=="string"||pe instanceof URL?(0,d.read_audio)(pe,U):pe instanceof Float64Array?new Float32Array(pe):pe))}function _(Re,U){U&&(Re=Re.map(De=>De|0));let[pe,Ce,Fe,Ve]=Re;return{xmin:pe,ymin:Ce,xmax:Fe,ymax:Ve}}class b extends a.Callable{constructor({task:U,model:pe,tokenizer:Ce=null,processor:Fe=null}){super(),this.task=U,this.model=pe,this.tokenizer=Ce,this.processor=Fe}async dispose(){await this.model.dispose()}}class y extends b{constructor(U){super(U)}async _call(U,{top_k:pe=1}={}){let Ce=this.tokenizer(U,{padding:!0,truncation:!0}),Fe=await this.model(Ce),Ve=this.model.config.problem_type==="multi_label_classification"?ze=>ze.sigmoid():ze=>new u.Tensor("float32",(0,c.softmax)(ze.data),ze.dims),De=this.model.config.id2label,Ee=[];for(let ze of Fe.logits){let Se=Ve(ze),$e=await(0,u.topk)(Se,pe),et=$e[0].tolist(),Ye=$e[1].tolist().map((Xe,gt)=>({label:De?De[Xe]:`LABEL_${Xe}`,score:et[gt]}));pe===1?Ee.push(...Ye):Ee.push(Ye)}return Array.isArray(U)||pe===1?Ee:Ee[0]}}class w extends b{constructor(U){super(U)}async _call(U,{ignore_labels:pe=["O"]}={}){let Ce=Array.isArray(U),Fe=this.tokenizer(Ce?U:[U],{padding:!0,truncation:!0}),De=(await this.model(Fe)).logits,Ee=this.model.config.id2label,ze=[];for(let Se=0;Se<De.dims[0];++Se){let $e=Fe.input_ids[Se],et=De[Se],Ge=[];for(let Ye=0;Ye<et.dims[0];++Ye){let Xe=et[Ye],gt=(0,c.max)(Xe.data)[1],We=Ee?Ee[gt]:`LABEL_${gt}`;if(pe.includes(We))continue;let at=this.tokenizer.decode([$e[Ye].item()],{skip_special_tokens:!0});if(at==="")continue;let Qe=(0,c.softmax)(Xe.data);Ge.push({entity:We,score:Qe[gt],index:Ye,word:at})}ze.push(Ge)}return Ce?ze:ze[0]}}class C extends b{constructor(U){super(U)}async _call(U,pe,{top_k:Ce=1}={}){let Fe=this.tokenizer(U,{text_pair:pe,padding:!0,truncation:!0}),{start_logits:Ve,end_logits:De}=await this.model(Fe),Ee=Fe.input_ids.tolist(),ze=Fe.attention_mask.tolist(),Se=this.tokenizer.all_special_ids,$e=[];for(let et=0;et<Ve.dims[0];++et){let Ge=Ee[et],Ye=Ge.findIndex(st=>st==this.tokenizer.sep_token_id),Xe=ze[et].map((st,zt)=>st==1&&(zt===0||zt>Ye&&Se.findIndex(rn=>rn==Ge[zt])===-1)),gt=Ve[et].tolist(),We=De[et].tolist();for(let st=1;st<gt.length;++st)(ze[et]==0||st<=Ye||Se.findIndex(zt=>zt==Ge[st])!==-1)&&(gt[st]=-1/0,We[st]=-1/0);let at=(0,c.softmax)(gt).map((st,zt)=>[st,zt]),Qe=(0,c.softmax)(We).map((st,zt)=>[st,zt]);at[0][0]=0,Qe[0][0]=0;let Pt=(0,l.product)(at,Qe).filter(st=>st[0][1]<=st[1][1]).map(st=>[st[0][1],st[1][1],st[0][0]*st[1][0]]).sort((st,zt)=>zt[2]-st[2]);for(let st=0;st<Math.min(Pt.length,Ce);++st){let[zt,rn,un]=Pt[st],ds=Ge.slice(zt,rn+1),_n=this.tokenizer.decode(ds,{skip_special_tokens:!0});$e.push({answer:_n,score:un})}}return Ce===1?$e[0]:$e}}class M extends b{constructor(U){super(U)}async _call(U,{top_k:pe=5}={}){let Ce=this.tokenizer(U,{padding:!0,truncation:!0}),{logits:Fe}=await this.model(Ce),Ve=[],De=Ce.input_ids.tolist();for(let Ee=0;Ee<De.length;++Ee){let ze=De[Ee],Se=ze.findIndex(Xe=>Xe==this.tokenizer.mask_token_id);if(Se===-1)throw Error(`Mask token (${this.tokenizer.mask_token}) not found in text.`);let $e=Fe[Ee][Se],et=await(0,u.topk)(new u.Tensor("float32",(0,c.softmax)($e.data),$e.dims),pe),Ge=et[0].tolist(),Ye=et[1].tolist();Ve.push(Ye.map((Xe,gt)=>{let We=ze.slice();return We[Se]=Xe,{score:Ge[gt],token:Number(Xe),token_str:this.tokenizer.decode([Xe]),sequence:this.tokenizer.decode(We,{skip_special_tokens:!0})}}))}return Array.isArray(U)?Ve:Ve[0]}}class S extends b{constructor(pe){super(pe);Z(this,"_key","generated_text")}async _call(pe,Ce={}){Array.isArray(pe)||(pe=[pe]),this.model.config.prefix&&(pe=pe.map(Se=>this.model.config.prefix+Se));let Fe=this.model.config.task_specific_params;Fe&&Fe[this.task]&&Fe[this.task].prefix&&(pe=pe.map(Se=>Fe[this.task].prefix+Se));let Ve=this.tokenizer,De={padding:!0,truncation:!0},Ee;this instanceof T&&"_build_translation_inputs"in Ve?Ee=Ve._build_translation_inputs(pe,De,Ce):Ee=Ve(pe,De);let ze=await this.model.generate({...Ee,...Ce});return Ve.batch_decode(ze,{skip_special_tokens:!0}).map(Se=>({[this._key]:Se}))}}class k extends S{constructor(pe){super(pe);Z(this,"_key","summary_text")}}class T extends S{constructor(pe){super(pe);Z(this,"_key","translation_text")}}function P(Re){return Array.isArray(Re)&&Re.every(U=>"role"in U&&"content"in U)}class R extends b{constructor(U){super(U)}async _call(U,pe={}){let Ce=!1,Fe=!1,Ve=pe.add_special_tokens??(this.tokenizer.add_bos_token||this.tokenizer.add_eos_token)??!1,De;if(typeof U=="string")De=U=[U];else if(Array.isArray(U)&&U.every(Ye=>typeof Ye=="string"))Ce=!0,De=U;else{if(P(U))U=[U];else if(Array.isArray(U)&&U.every(P))Ce=!0;else throw new Error("Input must be a string, an array of strings, a Chat, or an array of Chats");Fe=!0,De=U.map(Ye=>this.tokenizer.apply_chat_template(Ye,{tokenize:!1,add_generation_prompt:!0})),Ve=!1}let Ee=Fe?!1:pe.return_full_text??!0;this.tokenizer.padding_side="left";let ze=this.tokenizer(De,{add_special_tokens:Ve,padding:!0,truncation:!0}),Se=await this.model.generate({...ze,...pe}),$e=this.tokenizer.batch_decode(Se,{skip_special_tokens:!0}),et;!Ee&&ze.input_ids.dims.at(-1)>0&&(et=this.tokenizer.batch_decode(ze.input_ids,{skip_special_tokens:!0}).map(Ye=>Ye.length));let Ge=Array.from({length:U.length},Ye=>[]);for(let Ye=0;Ye<$e.length;++Ye){let Xe=Math.floor(Ye/Se.dims[0]*U.length);et&&($e[Ye]=$e[Ye].slice(et[Xe])),Ge[Xe].push({generated_text:Fe?[...U[Xe],{role:"assistant",content:$e[Ye]}]:$e[Ye]})}return!Ce&&Ge.length===1?Ge[0]:Ge}}class O extends b{constructor(U){super(U),this.label2id=Object.fromEntries(Object.entries(this.model.config.label2id).map(([pe,Ce])=>[pe.toLowerCase(),Ce])),this.entailment_id=this.label2id.entailment,this.entailment_id===void 0&&(console.warn("Could not find 'entailment' in label2id mapping. Using 2 as entailment_id."),this.entailment_id=2),this.contradiction_id=this.label2id.contradiction??this.label2id.not_entailment,this.contradiction_id===void 0&&(console.warn("Could not find 'contradiction' in label2id mapping. Using 0 as contradiction_id."),this.contradiction_id=0)}async _call(U,pe,{hypothesis_template:Ce="This example is {}.",multi_label:Fe=!1}={}){let Ve=Array.isArray(U);Ve||(U=[U]),Array.isArray(pe)||(pe=[pe]);let De=pe.map(Se=>Ce.replace("{}",Se)),Ee=Fe||pe.length===1,ze=[];for(let Se of U){let $e=[];for(let Ye of De){let Xe=this.tokenizer(Se,{text_pair:Ye,padding:!0,truncation:!0}),gt=await this.model(Xe);Ee?$e.push([gt.logits.data[this.contradiction_id],gt.logits.data[this.entailment_id]]):$e.push(gt.logits.data[this.entailment_id])}let Ge=(Ee?$e.map(Ye=>(0,c.softmax)(Ye)[1]):(0,c.softmax)($e)).map((Ye,Xe)=>[Ye,Xe]).sort((Ye,Xe)=>Xe[0]-Ye[0]);ze.push({sequence:Se,labels:Ge.map(Ye=>pe[Ye[1]]),scores:Ge.map(Ye=>Ye[0])})}return Ve?ze:ze[0]}}class H extends b{constructor(U){super(U)}async _call(U,{pooling:pe="none",normalize:Ce=!1,quantize:Fe=!1,precision:Ve="binary"}={}){let De=this.tokenizer(U,{padding:!0,truncation:!0}),Ee=await this.model(De),ze=Ee.last_hidden_state??Ee.logits??Ee.token_embeddings;switch(pe){case"none":break;case"mean":ze=(0,u.mean_pooling)(ze,De.attention_mask);break;case"first_token":case"cls":ze=ze.slice(null,0);break;case"last_token":case"eos":ze=ze.slice(null,-1);break;default:throw Error(`Pooling method '${pe}' not supported.`)}return Ce&&(ze=ze.normalize(2,-1)),Fe&&(ze=(0,u.quantize_embeddings)(ze,Ve)),ze}}class X extends b{constructor(U){super(U)}async _call(U,{pool:pe=null}={}){let Ce=await p(U),{pixel_values:Fe}=await this.processor(Ce),Ve=await this.model({pixel_values:Fe}),De;if(pe){if(!("pooler_output"in Ve))throw Error("No pooled output was returned. Make sure the model has a 'pooler' layer when using the 'pool' option.");De=Ve.pooler_output}else De=Ve.last_hidden_state??Ve.logits??Ve.image_embeds;return De}}class z extends b{constructor(U){super(U)}async _call(U,{top_k:pe=5}={}){let Ce=this.processor.feature_extractor.config.sampling_rate,Fe=await f(U,Ce),Ve=this.model.config.id2label,De=[];for(let Ee of Fe){let ze=await this.processor(Ee),$e=(await this.model(ze)).logits[0],et=await(0,u.topk)(new u.Tensor("float32",(0,c.softmax)($e.data),$e.dims),pe),Ge=et[0].tolist(),Xe=et[1].tolist().map((gt,We)=>({label:Ve?Ve[gt]:`LABEL_${gt}`,score:Ge[We]}));De.push(Xe)}return Array.isArray(U)?De:De[0]}}class ne extends b{constructor(U){super(U)}async _call(U,pe,{hypothesis_template:Ce="This is a sound of {}."}={}){let Fe=!Array.isArray(U);Fe&&(U=[U]);let Ve=pe.map($e=>Ce.replace("{}",$e)),De=this.tokenizer(Ve,{padding:!0,truncation:!0}),Ee=this.processor.feature_extractor.config.sampling_rate,ze=await f(U,Ee),Se=[];for(let $e of ze){let et=await this.processor($e),Ge=await this.model({...De,...et}),Ye=(0,c.softmax)(Ge.logits_per_audio.data);Se.push([...Ye].map((Xe,gt)=>({score:Xe,label:pe[gt]})))}return Fe?Se[0]:Se}}class re extends b{constructor(U){super(U)}async _call(U,pe={}){switch(this.model.config.model_type){case"whisper":case"lite-whisper":return this._call_whisper(U,pe);case"wav2vec2":case"wav2vec2-bert":case"unispeech":case"unispeech-sat":case"hubert":case"parakeet_ctc":return this._call_wav2vec2(U,pe);case"moonshine":return this._call_moonshine(U,pe);default:throw new Error(`AutomaticSpeechRecognitionPipeline does not support model type '${this.model.config.model_type}'.`)}}async _call_wav2vec2(U,pe){pe.language&&console.warn('`language` parameter is not yet supported for `wav2vec2` models, defaulting to "English".'),pe.task&&console.warn('`task` parameter is not yet supported for `wav2vec2` models, defaulting to "transcribe".');let Ce=!Array.isArray(U);Ce&&(U=[U]);let Fe=this.processor.feature_extractor.config.sampling_rate,Ve=await f(U,Fe),De=[];for(let Ee of Ve){let ze=await this.processor(Ee),$e=(await this.model(ze)).logits[0],et=[];for(let Ye of $e)et.push((0,c.max)(Ye.data)[1]);let Ge=this.tokenizer.decode(et,{skip_special_tokens:!0}).trim();De.push({text:Ge})}return Ce?De[0]:De}async _call_whisper(U,pe){let Ce=pe.return_timestamps??!1,Fe=pe.chunk_length_s??0,Ve=pe.force_full_sequences??!1,De=pe.stride_length_s??null,Ee={...pe};Ce==="word"&&(Ee.return_token_timestamps=!0,Ee.return_timestamps=!1);let ze=!Array.isArray(U);ze&&(U=[U]);let Se=this.processor.feature_extractor.config.chunk_length/this.model.config.max_source_positions,$e=this.processor.feature_extractor.config.hop_length,et=this.processor.feature_extractor.config.sampling_rate,Ge=await f(U,et),Ye=[];for(let Xe of Ge){let gt=[];if(Fe>0){if(De===null)De=Fe/6;else if(Fe<=De)throw Error("`chunk_length_s` must be larger than `stride_length_s`.");let Qe=et*Fe,Pt=et*De,st=Qe-2*Pt,zt=0;for(;;){let rn=zt+Qe,un=Xe.subarray(zt,rn),ds=await this.processor(un),_n=zt===0,xs=rn>=Xe.length;if(gt.push({stride:[un.length,_n?0:Pt,xs?0:Pt],input_features:ds.input_features,is_last:xs}),xs)break;zt+=st}}else gt=[{stride:[Xe.length,0,0],input_features:(await this.processor(Xe)).input_features,is_last:!0}];for(let Qe of gt){Ee.num_frames=Math.floor(Qe.stride[0]/$e);let Pt=await this.model.generate({inputs:Qe.input_features,...Ee});Ce==="word"?(Qe.tokens=Pt.sequences.tolist()[0],Qe.token_timestamps=Pt.token_timestamps.tolist()[0].map(st=>(0,c.round)(st,2))):Qe.tokens=Pt[0].tolist(),Qe.stride=Qe.stride.map(st=>st/et)}let[We,at]=this.tokenizer._decode_asr(gt,{time_precision:Se,return_timestamps:Ce,force_full_sequences:Ve});Ye.push({text:We,...at})}return ze?Ye[0]:Ye}async _call_moonshine(U,pe){let Ce=!Array.isArray(U);Ce&&(U=[U]);let Fe=this.processor.feature_extractor.config.sampling_rate,Ve=await f(U,Fe),De=[];for(let Ee of Ve){let ze=await this.processor(Ee),Se=Math.floor(Ee.length/Fe)*6,$e=await this.model.generate({max_new_tokens:Se,...pe,...ze}),et=this.processor.batch_decode($e,{skip_special_tokens:!0})[0];De.push({text:et})}return Ce?De[0]:De}}class Y extends b{constructor(U){super(U)}async _call(U,pe={}){let Ce=Array.isArray(U),Fe=await p(U),{pixel_values:Ve}=await this.processor(Fe),De=[];for(let Ee of Ve){Ee.dims=[1,...Ee.dims];let ze=await this.model.generate({inputs:Ee,...pe}),Se=this.tokenizer.batch_decode(ze,{skip_special_tokens:!0}).map($e=>({generated_text:$e.trim()}));De.push(Se)}return Ce?De:De[0]}}class se extends b{constructor(U){super(U)}async _call(U,{top_k:pe=5}={}){let Ce=await p(U),{pixel_values:Fe}=await this.processor(Ce),Ve=await this.model({pixel_values:Fe}),De=this.model.config.id2label,Ee=[];for(let ze of Ve.logits){let Se=await(0,u.topk)(new u.Tensor("float32",(0,c.softmax)(ze.data),ze.dims),pe),$e=Se[0].tolist(),Ge=Se[1].tolist().map((Ye,Xe)=>({label:De?De[Ye]:`LABEL_${Ye}`,score:$e[Xe]}));Ee.push(Ge)}return Array.isArray(U)?Ee:Ee[0]}}class ue extends b{constructor(U){super(U),this.subtasks_mapping={panoptic:"post_process_panoptic_segmentation",instance:"post_process_instance_segmentation",semantic:"post_process_semantic_segmentation"}}async _call(U,{threshold:pe=.5,mask_threshold:Ce=.5,overlap_mask_area_threshold:Fe=.8,label_ids_to_fuse:Ve=null,target_sizes:De=null,subtask:Ee=null}={}){if(Array.isArray(U)&&U.length!==1)throw Error("Image segmentation pipeline currently only supports a batch size of 1.");let Se=await p(U),$e=Se.map(Qe=>[Qe.height,Qe.width]),et=await this.processor(Se),{inputNames:Ge,outputNames:Ye}=this.model.sessions.model;if(!Ge.includes("pixel_values")){if(Ge.length!==1)throw Error(`Expected a single input name, but got ${Ge.length} inputs: ${Ge}.`);let Qe=Ge[0];if(Qe in et)throw Error(`Input name ${Qe} already exists in the inputs.`);et[Qe]=et.pixel_values}let Xe=await this.model(et),gt=null;if(Ee!==null)gt=this.subtasks_mapping[Ee];else if(this.processor.image_processor){for(let[Qe,Pt]of Object.entries(this.subtasks_mapping))if(Pt in this.processor.image_processor){gt=this.processor.image_processor[Pt].bind(this.processor.image_processor),Ee=Qe;break}}let We=this.model.config.id2label,at=[];if(Ee)if(Ee==="panoptic"||Ee==="instance"){let Qe=gt(Xe,pe,Ce,Fe,Ve,De??$e)[0],Pt=Qe.segmentation;for(let st of Qe.segments_info){let zt=new Uint8ClampedArray(Pt.data.length);for(let un=0;un<Pt.data.length;++un)Pt.data[un]===st.id&&(zt[un]=255);let rn=new h.RawImage(zt,Pt.dims[1],Pt.dims[0],1);at.push({score:st.score,label:We[st.label_id],mask:rn})}}else if(Ee==="semantic"){let{segmentation:Qe,labels:Pt}=gt(Xe,De??$e)[0];for(let st of Pt){let zt=new Uint8ClampedArray(Qe.data.length);for(let un=0;un<Qe.data.length;++un)Qe.data[un]===st&&(zt[un]=255);let rn=new h.RawImage(zt,Qe.dims[1],Qe.dims[0],1);at.push({score:null,label:We[st],mask:rn})}}else throw Error(`Subtask ${Ee} not supported.`);else{let Pt=Xe[Ye[0]];for(let st=0;st<$e.length;++st){let zt=$e[st],rn=Pt[st];rn.data.some(ds=>ds<-1e-5||ds>1+1e-5)&&rn.sigmoid_();let un=await h.RawImage.fromTensor(rn.mul_(255).to("uint8")).resize(zt[1],zt[0]);at.push({label:null,score:null,mask:un})}}return at}}class fe extends ue{constructor(U){super(U)}async _call(U,pe={}){if(Array.isArray(U)&&U.length!==1)throw Error("Background removal pipeline currently only supports a batch size of 1.");let Fe=await p(U),Ve=await super._call(U,pe);return Fe.map((Ee,ze)=>{let Se=Ee.clone();return Se.putAlpha(Ve[ze].mask),Se})}}class Pe extends b{constructor(U){super(U)}async _call(U,pe,{hypothesis_template:Ce="This is a photo of {}"}={}){let Fe=Array.isArray(U),Ve=await p(U),De=pe.map(Ge=>Ce.replace("{}",Ge)),Ee=this.tokenizer(De,{padding:this.model.config.model_type==="siglip"?"max_length":!0,truncation:!0}),{pixel_values:ze}=await this.processor(Ve),Se=await this.model({...Ee,pixel_values:ze}),$e=this.model.config.model_type==="siglip"?Ge=>Ge.sigmoid().data:Ge=>(0,c.softmax)(Ge.data),et=[];for(let Ge of Se.logits_per_image){let Xe=[...$e(Ge)].map((gt,We)=>({score:gt,label:pe[We]}));Xe.sort((gt,We)=>We.score-gt.score),et.push(Xe)}return Fe?et:et[0]}}class oe extends b{constructor(U){super(U)}async _call(U,{threshold:pe=.9,percentage:Ce=!1}={}){let Fe=Array.isArray(U);if(Fe&&U.length!==1)throw Error("Object detection pipeline currently only supports a batch size of 1.");let Ve=await p(U),De=Ce?null:Ve.map(Ye=>[Ye.height,Ye.width]),{pixel_values:Ee,pixel_mask:ze}=await this.processor(Ve),Se=await this.model({pixel_values:Ee,pixel_mask:ze}),$e=this.processor.image_processor.post_process_object_detection(Se,pe,De),et=this.model.config.id2label,Ge=$e.map(Ye=>Ye.boxes.map((Xe,gt)=>({score:Ye.scores[gt],label:et[Ye.classes[gt]],box:_(Xe,!Ce)})));return Fe?Ge:Ge[0]}}class te extends b{constructor(U){super(U)}async _call(U,pe,{threshold:Ce=.1,top_k:Fe=null,percentage:Ve=!1}={}){let De=Array.isArray(U),Ee=await p(U),ze=this.tokenizer(pe,{padding:!0,truncation:!0}),Se=await this.processor(Ee),$e=[];for(let et=0;et<Ee.length;++et){let Ge=Ee[et],Ye=Ve?null:[[Ge.height,Ge.width]],Xe=Se.pixel_values[et].unsqueeze_(0),gt=await this.model({...ze,pixel_values:Xe}),We;if("post_process_grounded_object_detection"in this.processor){let at=this.processor.post_process_grounded_object_detection(gt,ze.input_ids,{box_threshold:Ce,text_threshold:Ce,target_sizes:Ye})[0];We=at.boxes.map((Qe,Pt)=>({score:at.scores[Pt],label:at.labels[Pt],box:_(Qe,!Ve)}))}else{let at=this.processor.image_processor.post_process_object_detection(gt,Ce,Ye,!0)[0];We=at.boxes.map((Qe,Pt)=>({score:at.scores[Pt],label:pe[at.classes[Pt]],box:_(Qe,!Ve)}))}We.sort((at,Qe)=>Qe.score-at.score),Fe!==null&&(We=We.slice(0,Fe)),$e.push(We)}return De?$e:$e[0]}}class j extends b{constructor(U){super(U)}async _call(U,pe,Ce={}){let Fe=(await p(U))[0],{pixel_values:Ve}=await this.processor(Fe),De=`<s_docvqa><s_question>${pe}</s_question><s_answer>`,Ee=this.tokenizer(De,{add_special_tokens:!1,padding:!0,truncation:!0}).input_ids,ze=await this.model.generate({inputs:Ve,max_length:this.model.config.decoder.max_position_embeddings,decoder_input_ids:Ee,...Ce}),$e=this.tokenizer.batch_decode(ze)[0].match(/<s_answer>(.*?)<\/s_answer>/),et=null;return $e&&$e.length>=2&&(et=$e[1].trim()),[{answer:et}]}}class G extends b{constructor(pe){super(pe);Z(this,"DEFAULT_VOCODER_ID","Xenova/speecht5_hifigan");this.vocoder=pe.vocoder??null}async _prepare_speaker_embeddings(pe){if((typeof pe=="string"||pe instanceof URL)&&(pe=new Float32Array(await(await fetch(pe)).arrayBuffer())),pe instanceof Float32Array)pe=new u.Tensor("float32",pe,[pe.length]);else if(!(pe instanceof u.Tensor))throw new Error("Speaker embeddings must be a `Tensor`, `Float32Array`, `string`, or `URL`.");return pe}async _call(pe,{speaker_embeddings:Ce=null,num_inference_steps:Fe,speed:Ve}={}){return this.processor?this._call_text_to_spectrogram(pe,{speaker_embeddings:Ce}):this.model.config.model_type==="supertonic"?this._call_supertonic(pe,{speaker_embeddings:Ce,num_inference_steps:Fe,speed:Ve}):this._call_text_to_waveform(pe)}async _call_supertonic(pe,{speaker_embeddings:Ce,num_inference_steps:Fe,speed:Ve}){if(!Ce)throw new Error("Speaker embeddings must be provided for Supertonic models.");Ce=await this._prepare_speaker_embeddings(Ce);let{sampling_rate:De,style_dim:Ee}=this.model.config;Ce=Ce.view(1,-1,Ee);let ze=this.tokenizer(pe,{padding:!0,truncation:!0}),{waveform:Se}=await this.model.generate_speech({...ze,style:Ce,num_inference_steps:Fe,speed:Ve});return new d.RawAudio(Se.data,De)}async _call_text_to_waveform(pe){let Ce=this.tokenizer(pe,{padding:!0,truncation:!0}),{waveform:Fe}=await this.model(Ce),Ve=this.model.config.sampling_rate;return new d.RawAudio(Fe.data,Ve)}async _call_text_to_spectrogram(pe,{speaker_embeddings:Ce}){this.vocoder||(console.log("No vocoder specified, using default HifiGan vocoder."),this.vocoder=await i.AutoModel.from_pretrained(this.DEFAULT_VOCODER_ID,{dtype:"fp32"}));let{input_ids:Fe}=this.tokenizer(pe,{padding:!0,truncation:!0});Ce=await this._prepare_speaker_embeddings(Ce),Ce=Ce.view(1,-1);let{waveform:Ve}=await this.model.generate_speech(Fe,Ce,{vocoder:this.vocoder}),De=this.processor.feature_extractor.config.sampling_rate;return new d.RawAudio(Ve.data,De)}}class de extends b{constructor(U){super(U)}async _call(U){let pe=await p(U),Ce=await this.processor(pe),Fe=await this.model(Ce),Ve=[];for(let De of Fe.reconstruction){let Ee=De.squeeze().clamp_(0,1).mul_(255).round_().to("uint8");Ve.push(h.RawImage.fromTensor(Ee))}return Ve.length>1?Ve:Ve[0]}}class be extends b{constructor(U){super(U)}async _call(U){let pe=await p(U),Ce=await this.processor(pe),{predicted_depth:Fe}=await this.model(Ce),Ve=[];for(let De=0;De<pe.length;++De){let Ee=Fe[De],[ze,Se]=Ee.dims.slice(-2),[$e,et]=pe[De].size,Ge=(await(0,u.interpolate_4d)(Ee.view(1,1,ze,Se),{size:[et,$e],mode:"bilinear"})).view(et,$e),Ye=Ge.min().item(),Xe=Ge.max().item(),gt=Ge.sub(Ye).div_(Xe-Ye).mul_(255).to("uint8").unsqueeze(0),We=h.RawImage.fromTensor(gt);Ve.push({predicted_depth:Ge,depth:We})}return Ve.length>1?Ve:Ve[0]}}let xe=Object.freeze({"text-classification":{tokenizer:n.AutoTokenizer,pipeline:y,model:i.AutoModelForSequenceClassification,default:{model:"Xenova/distilbert-base-uncased-finetuned-sst-2-english"},type:"text"},"token-classification":{tokenizer:n.AutoTokenizer,pipeline:w,model:i.AutoModelForTokenClassification,default:{model:"Xenova/bert-base-multilingual-cased-ner-hrl"},type:"text"},"question-answering":{tokenizer:n.AutoTokenizer,pipeline:C,model:i.AutoModelForQuestionAnswering,default:{model:"Xenova/distilbert-base-cased-distilled-squad"},type:"text"},"fill-mask":{tokenizer:n.AutoTokenizer,pipeline:M,model:i.AutoModelForMaskedLM,default:{model:"Xenova/bert-base-uncased"},type:"text"},summarization:{tokenizer:n.AutoTokenizer,pipeline:k,model:i.AutoModelForSeq2SeqLM,default:{model:"Xenova/distilbart-cnn-6-6"},type:"text"},translation:{tokenizer:n.AutoTokenizer,pipeline:T,model:i.AutoModelForSeq2SeqLM,default:{model:"Xenova/t5-small"},type:"text"},"text2text-generation":{tokenizer:n.AutoTokenizer,pipeline:S,model:i.AutoModelForSeq2SeqLM,default:{model:"Xenova/flan-t5-small"},type:"text"},"text-generation":{tokenizer:n.AutoTokenizer,pipeline:R,model:i.AutoModelForCausalLM,default:{model:"Xenova/gpt2"},type:"text"},"zero-shot-classification":{tokenizer:n.AutoTokenizer,pipeline:O,model:i.AutoModelForSequenceClassification,default:{model:"Xenova/distilbert-base-uncased-mnli"},type:"text"},"audio-classification":{pipeline:z,model:i.AutoModelForAudioClassification,processor:r.AutoProcessor,default:{model:"Xenova/wav2vec2-base-superb-ks"},type:"audio"},"zero-shot-audio-classification":{tokenizer:n.AutoTokenizer,pipeline:ne,model:i.AutoModel,processor:r.AutoProcessor,default:{model:"Xenova/clap-htsat-unfused"},type:"multimodal"},"automatic-speech-recognition":{tokenizer:n.AutoTokenizer,pipeline:re,model:[i.AutoModelForSpeechSeq2Seq,i.AutoModelForCTC],processor:r.AutoProcessor,default:{model:"Xenova/whisper-tiny.en"},type:"multimodal"},"text-to-audio":{tokenizer:n.AutoTokenizer,pipeline:G,model:[i.AutoModelForTextToWaveform,i.AutoModelForTextToSpectrogram],processor:[r.AutoProcessor,null],default:{model:"Xenova/speecht5_tts"},type:"text"},"image-to-text":{tokenizer:n.AutoTokenizer,pipeline:Y,model:i.AutoModelForVision2Seq,processor:r.AutoProcessor,default:{model:"Xenova/vit-gpt2-image-captioning"},type:"multimodal"},"image-classification":{pipeline:se,model:i.AutoModelForImageClassification,processor:r.AutoProcessor,default:{model:"Xenova/vit-base-patch16-224"},type:"multimodal"},"image-segmentation":{pipeline:ue,model:[i.AutoModelForImageSegmentation,i.AutoModelForSemanticSegmentation,i.AutoModelForUniversalSegmentation],processor:r.AutoProcessor,default:{model:"Xenova/detr-resnet-50-panoptic"},type:"multimodal"},"background-removal":{pipeline:fe,model:[i.AutoModelForImageSegmentation,i.AutoModelForSemanticSegmentation,i.AutoModelForUniversalSegmentation],processor:r.AutoProcessor,default:{model:"Xenova/modnet"},type:"image"},"zero-shot-image-classification":{tokenizer:n.AutoTokenizer,pipeline:Pe,model:i.AutoModel,processor:r.AutoProcessor,default:{model:"Xenova/clip-vit-base-patch32"},type:"multimodal"},"object-detection":{pipeline:oe,model:i.AutoModelForObjectDetection,processor:r.AutoProcessor,default:{model:"Xenova/detr-resnet-50"},type:"multimodal"},"zero-shot-object-detection":{tokenizer:n.AutoTokenizer,pipeline:te,model:i.AutoModelForZeroShotObjectDetection,processor:r.AutoProcessor,default:{model:"Xenova/owlvit-base-patch32"},type:"multimodal"},"document-question-answering":{tokenizer:n.AutoTokenizer,pipeline:j,model:i.AutoModelForDocumentQuestionAnswering,processor:r.AutoProcessor,default:{model:"Xenova/donut-base-finetuned-docvqa"},type:"multimodal"},"image-to-image":{pipeline:de,model:i.AutoModelForImageToImage,processor:r.AutoProcessor,default:{model:"Xenova/swin2SR-classical-sr-x2-64"},type:"image"},"depth-estimation":{pipeline:be,model:i.AutoModelForDepthEstimation,processor:r.AutoProcessor,default:{model:"Xenova/dpt-large"},type:"image"},"feature-extraction":{tokenizer:n.AutoTokenizer,pipeline:H,model:i.AutoModel,default:{model:"Xenova/all-MiniLM-L6-v2"},type:"text"},"image-feature-extraction":{processor:r.AutoProcessor,pipeline:X,model:[i.AutoModelForImageFeatureExtraction,i.AutoModel],default:{model:"Xenova/vit-base-patch16-224-in21k"},type:"image"}}),Oe=Object.freeze({"sentiment-analysis":"text-classification",ner:"token-classification",asr:"automatic-speech-recognition","text-to-speech":"text-to-audio",embeddings:"feature-extraction"});async function je(Re,U=null,{progress_callback:pe=null,config:Ce=null,cache_dir:Fe=null,local_files_only:Ve=!1,revision:De="main",device:Ee=null,dtype:ze=null,subfolder:Se="onnx",use_external_data_format:$e=null,model_file_name:et=null,session_options:Ge={}}={}){Re=Oe[Re]??Re;let Ye=xe[Re.split("_",1)[0]];if(!Ye)throw Error(`Unsupported pipeline: ${Re}. Must be one of [${Object.keys(xe)}]`);U||(U=Ye.default.model,console.log(`No model specified. Using default model: "${U}".`));let Xe={progress_callback:pe,config:Ce,cache_dir:Fe,local_files_only:Ve,revision:De,device:Ee,dtype:ze,subfolder:Se,use_external_data_format:$e,model_file_name:et,session_options:Ge},gt=new Map([["tokenizer",Ye.tokenizer],["model",Ye.model],["processor",Ye.processor]]),We=await dt(gt,U,Xe);We.task=Re,(0,l.dispatchCallback)(pe,{status:"ready",task:Re,model:U});let at=Ye.pipeline;return new at(We)}async function dt(Re,U,pe){let Ce=Object.create(null),Fe=[];for(let[Ve,De]of Re.entries()){if(!De)continue;let Ee;Array.isArray(De)?Ee=new Promise(async(ze,Se)=>{let $e;for(let et of De){if(et===null){ze(null);return}try{ze(await et.from_pretrained(U,pe));return}catch(Ge){if(Ge.message?.includes("Unsupported model type"))$e=Ge;else if(Ge.message?.includes("Could not locate file"))$e=Ge;else{Se(Ge);return}}}Se($e)}):Ee=De.from_pretrained(U,pe),Ce[Ve]=Ee,Fe.push(Ee)}await Promise.all(Fe);for(let[Ve,De]of Object.entries(Ce))Ce[Ve]=await De;return Ce}},"./src/tokenizers.js":(s,e,t)=>{t.r(e),t.d(e,{AlbertTokenizer:()=>In,AutoTokenizer:()=>ed,BartTokenizer:()=>rt,BertTokenizer:()=>zo,BlenderbotSmallTokenizer:()=>tt,BlenderbotTokenizer:()=>Ke,BloomTokenizer:()=>hn,CLIPTokenizer:()=>Wo,CamembertTokenizer:()=>ae,CodeGenTokenizer:()=>Go,CodeLlamaTokenizer:()=>Hs,CohereTokenizer:()=>jo,ConvBertTokenizer:()=>ie,DebertaTokenizer:()=>Kt,DebertaV2Tokenizer:()=>zi,DistilBertTokenizer:()=>ee,ElectraTokenizer:()=>Le,EsmTokenizer:()=>us,FalconTokenizer:()=>Qr,GPT2Tokenizer:()=>wt,GPTNeoXTokenizer:()=>Vo,GemmaTokenizer:()=>Pr,Grok1Tokenizer:()=>si,HerbertTokenizer:()=>F,LlamaTokenizer:()=>ns,M2M100Tokenizer:()=>ss,MBart50Tokenizer:()=>ut,MBartTokenizer:()=>Lt,MPNetTokenizer:()=>js,MarianTokenizer:()=>kr,MgpstrTokenizer:()=>La,MobileBertTokenizer:()=>Uo,NllbTokenizer:()=>Xn,NougatTokenizer:()=>kn,PreTrainedTokenizer:()=>Rt,Qwen2Tokenizer:()=>Ra,RoFormerTokenizer:()=>q,RobertaTokenizer:()=>Nt,SiglipTokenizer:()=>Ho,SpeechT5Tokenizer:()=>_t,SqueezeBertTokenizer:()=>Bi,T5Tokenizer:()=>ht,TokenizerModel:()=>H,VitsTokenizer:()=>Fa,Wav2Vec2CTCTokenizer:()=>mi,WhisperTokenizer:()=>Jr,XLMRobertaTokenizer:()=>Fs,XLMTokenizer:()=>ye,is_chinese_char:()=>C});var n=t("./src/utils/generic.js"),i=t("./src/utils/core.js"),r=t("./src/utils/hub.js"),o=t("./src/utils/maths.js"),a=t("./src/utils/tensor.js"),l=t("./src/utils/data-structures.js"),c=t("./node_modules/@huggingface/jinja/dist/index.js"),d=t("./src/models/whisper/common_whisper.js");async function u(ve,$){let J=await Promise.all([(0,r.getModelJSON)(ve,"tokenizer.json",!0,$),(0,r.getModelJSON)(ve,"tokenizer_config.json",!0,$)]);return $.legacy!==null&&(J[1].legacy=$.legacy),J}function h(ve,$){let J=[],le=0;for(let me of ve.matchAll($)){let _e=me[0];le<me.index&&J.push(ve.slice(le,me.index)),_e.length>0&&J.push(_e),le=me.index+_e.length}return le<ve.length&&J.push(ve.slice(le)),J}function p(ve,$=!0){if(ve.Regex!==void 0){let J=ve.Regex.replace(/\\([#&~])/g,"$1");for(let[le,me]of R)J=J.replaceAll(le,me);return new RegExp(J,"gu")}else if(ve.String!==void 0){let J=(0,i.escapeRegExp)(ve.String);return new RegExp($?J:`(${J})`,"gu")}else return console.warn("Unknown pattern type:",ve),null}function f(ve){return new Map(Object.entries(ve))}function _(ve){let $=ve.dims;switch($.length){case 1:return ve.tolist();case 2:if($[0]!==1)throw new Error("Unable to decode tensor with `batch size !== 1`. Use `tokenizer.batch_decode(...)` for batched inputs.");return ve.tolist()[0];default:throw new Error(`Expected tensor to have 1-2 dimensions, got ${$.length}.`)}}function b(ve){return ve.replace(/ \./g,".").replace(/ \?/g,"?").replace(/ \!/g,"!").replace(/ ,/g,",").replace(/ \' /g,"'").replace(/ n\'t/g,"n't").replace(/ \'m/g,"'m").replace(/ \'s/g,"'s").replace(/ \'ve/g,"'ve").replace(/ \'re/g,"'re")}function y(ve){return ve.replace(/\p{M}/gu,"")}function w(ve){return y(ve.toLowerCase())}function C(ve){return ve>=19968&&ve<=40959||ve>=13312&&ve<=19903||ve>=131072&&ve<=173791||ve>=173824&&ve<=177983||ve>=177984&&ve<=178207||ve>=178208&&ve<=183983||ve>=63744&&ve<=64255||ve>=194560&&ve<=195103}function M(ve,$,J){let le=[],me=0;for(;me<ve.length;){if(le.push(ve[me]),($.get(ve[me])??J)!==J){++me;continue}for(;++me<ve.length&&($.get(ve[me])??J)===J;)$.get(le.at(-1))!==J&&(le[le.length-1]+=ve[me])}return le}function S(ve){return ve.match(/\S+/g)||[]}let k="\\p{P}\\u0021-\\u002F\\u003A-\\u0040\\u005B-\\u0060\\u007B-\\u007E",T=new RegExp(`^[${k}]+$`,"gu"),P=".,!?\u2026\u3002\uFF0C\u3001\u0964\u06D4\u060C",R=new Map([["(?i:'s|'t|'re|'ve|'m|'ll|'d)","(?:'([sS]|[tT]|[rR][eE]|[vV][eE]|[mM]|[lL][lL]|[dD]))"],["(?i:[sdmt]|ll|ve|re)","(?:[sS]|[dD]|[mM]|[tT]|[lL][lL]|[vV][eE]|[rR][eE])"],["[^\\r\\n\\p{L}\\p{N}]?+","[^\\r\\n\\p{L}\\p{N}]?"],["[^\\s\\p{L}\\p{N}]++","[^\\s\\p{L}\\p{N}]+"],[` ?[^(\\s|[${P}])]+`,` ?[^\\s${P}]+`]]);class O{constructor($){this.content=$.content,this.id=$.id,this.single_word=$.single_word??!1,this.lstrip=$.lstrip??!1,this.rstrip=$.rstrip??!1,this.special=$.special??!1,this.normalized=$.normalized??null}}class H extends n.Callable{constructor($){super(),this.config=$,this.vocab=[],this.tokens_to_ids=new Map,this.unk_token_id=void 0,this.unk_token=void 0,this.end_of_word_suffix=void 0,this.fuse_unk=this.config.fuse_unk??!1}static fromConfig($,...J){switch($.type){case"WordPiece":return new X($);case"Unigram":return new z($,...J);case"BPE":return new Y($);default:if($.vocab)return Array.isArray($.vocab)?new z($,...J):Object.hasOwn($,"continuing_subword_prefix")&&Object.hasOwn($,"unk_token")?Object.hasOwn($,"merges")?new Y($):new X($):new se($,...J);throw new Error(`Unknown TokenizerModel type: ${$.type}`)}}_call($){return $=this.encode($),this.fuse_unk&&($=M($,this.tokens_to_ids,this.unk_token_id)),$}encode($){throw Error("encode should be implemented in subclass.")}convert_tokens_to_ids($){return $.map(J=>this.tokens_to_ids.get(J)??this.unk_token_id)}convert_ids_to_tokens($){return $.map(J=>this.vocab[J]??this.unk_token)}}class X extends H{constructor($){super($),this.tokens_to_ids=f($.vocab),this.unk_token_id=this.tokens_to_ids.get($.unk_token),this.unk_token=$.unk_token,this.max_input_chars_per_word=$.max_input_chars_per_word??100,this.vocab=new Array(this.tokens_to_ids.size);for(let[J,le]of this.tokens_to_ids)this.vocab[le]=J}encode($){let J=[];for(let le of $){let me=[...le];if(me.length>this.max_input_chars_per_word){J.push(this.unk_token);continue}let _e=!1,Ne=0,nt=[];for(;Ne<me.length;){let ct=me.length,it=null;for(;Ne<ct;){let pt=me.slice(Ne,ct).join("");if(Ne>0&&(pt=this.config.continuing_subword_prefix+pt),this.tokens_to_ids.has(pt)){it=pt;break}--ct}if(it===null){_e=!0;break}nt.push(it),Ne=ct}_e?J.push(this.unk_token):J.push(...nt)}return J}}class z extends H{constructor($,J){super($);let le=$.vocab.length;this.vocab=new Array(le),this.scores=new Array(le);for(let me=0;me<le;++me)[this.vocab[me],this.scores[me]]=$.vocab[me];this.unk_token_id=$.unk_id,this.unk_token=this.vocab[$.unk_id],this.tokens_to_ids=new Map(this.vocab.map((me,_e)=>[me,_e])),this.bos_token=" ",this.bos_token_id=this.tokens_to_ids.get(this.bos_token),this.eos_token=J.eos_token,this.eos_token_id=this.tokens_to_ids.get(this.eos_token),this.unk_token=this.vocab[this.unk_token_id],this.minScore=(0,o.min)(this.scores)[0],this.unk_score=this.minScore-10,this.scores[this.unk_token_id]=this.unk_score,this.trie=new l.CharTrie,this.trie.extend(this.vocab),this.fuse_unk=!0}populateNodes($){let J=$.chars,le=1,me=0;for(;me<J.length;){let _e=!1,Ne=[],nt=J.slice(me).join(""),ct=this.trie.commonPrefixSearch(nt);for(let it of ct){Ne.push(it);let pt=this.tokens_to_ids.get(it),Bt=this.scores[pt],pn=(0,i.len)(it);$.insert(me,pn,Bt,pt),!_e&&pn===le&&(_e=!0)}_e||$.insert(me,le,this.unk_score,this.unk_token_id),me+=le}}tokenize($){let J=new l.TokenLattice($,this.bos_token_id,this.eos_token_id);return this.populateNodes(J),J.tokens()}encode($){let J=[];for(let le of $){let me=this.tokenize(le);J.push(...me)}return J}}let ne=(()=>{let ve=[...Array.from({length:94},(me,_e)=>_e+33),...Array.from({length:12},(me,_e)=>_e+161),...Array.from({length:82},(me,_e)=>_e+174)],$=ve.slice(),J=0;for(let me=0;me<256;++me)ve.includes(me)||(ve.push(me),$.push(256+J),J+=1);let le=$.map(me=>String.fromCharCode(me));return Object.fromEntries(ve.map((me,_e)=>[me,le[_e]]))})(),re=(0,i.reverseDictionary)(ne);class Y extends H{constructor($){super($),this.tokens_to_ids=f($.vocab),this.unk_token_id=this.tokens_to_ids.get($.unk_token),this.unk_token=$.unk_token,this.vocab=new Array(this.tokens_to_ids.size);for(let[le,me]of this.tokens_to_ids)this.vocab[me]=le;let J=Array.isArray($.merges[0]);this.merges=J?$.merges:$.merges.map(le=>le.split(" ",2)),this.bpe_ranks=new Map(this.merges.map((le,me)=>[JSON.stringify(le),me])),this.end_of_word_suffix=$.end_of_word_suffix,this.continuing_subword_suffix=$.continuing_subword_suffix??null,this.byte_fallback=this.config.byte_fallback??!1,this.byte_fallback&&(this.text_encoder=new TextEncoder),this.ignore_merges=this.config.ignore_merges??!1,this.max_length_to_cache=256,this.cache_capacity=1e4,this.cache=new l.LRUCache(this.cache_capacity)}clear_cache(){this.cache.clear()}bpe($){if($.length===0)return[];let J=this.cache.get($);if(J!==void 0)return J;let le=Array.from($);this.end_of_word_suffix&&(le[le.length-1]+=this.end_of_word_suffix);let me=[];if(le.length>1){let _e=new l.PriorityQueue((ct,it)=>ct.score<it.score),Ne={token:le[0],bias:0,prev:null,next:null},nt=Ne;for(let ct=1;ct<le.length;++ct){let it={bias:ct/le.length,token:le[ct],prev:nt,next:null};nt.next=it,this._add_node(_e,nt),nt=it}for(;!_e.isEmpty();){let ct=_e.pop();if(ct.deleted||!ct.next||ct.next.deleted)continue;if(ct.deleted=!0,ct.next.deleted=!0,ct.prev){let pt={...ct.prev};ct.prev.deleted=!0,ct.prev=pt,pt.prev?pt.prev.next=pt:Ne=pt}let it={token:ct.token+ct.next.token,bias:ct.bias,prev:ct.prev,next:ct.next.next};it.prev?(it.prev.next=it,this._add_node(_e,it.prev)):Ne=it,it.next&&(it.next.prev=it,this._add_node(_e,it))}for(let ct=Ne;ct!==null;ct=ct.next)me.push(ct.token)}else me=le;if(this.continuing_subword_suffix)for(let _e=0;_e<me.length-1;++_e)me[_e]+=this.continuing_subword_suffix;return $.length<this.max_length_to_cache&&this.cache.put($,me),me}_add_node($,J){let le=this.bpe_ranks.get(JSON.stringify([J.token,J.next.token]));le!==void 0&&(J.score=le+J.bias,$.push(J))}encode($){let J=[];for(let le of $){if(this.ignore_merges&&this.tokens_to_ids.has(le)){J.push(le);continue}let me=this.bpe(le);for(let _e of me)if(this.tokens_to_ids.has(_e))J.push(_e);else if(this.byte_fallback){let Ne=Array.from(this.text_encoder.encode(_e)).map(nt=>`<0x${nt.toString(16).toUpperCase().padStart(2,"0")}>`);Ne.every(nt=>this.tokens_to_ids.has(nt))?J.push(...Ne):J.push(this.unk_token)}else J.push(this.unk_token)}return J}}class se extends H{constructor($,J){super($),this.tokens_to_ids=f(J.target_lang?$.vocab[J.target_lang]:$.vocab),this.bos_token=J.bos_token,this.bos_token_id=this.tokens_to_ids.get(this.bos_token),this.eos_token=J.eos_token,this.eos_token_id=this.tokens_to_ids.get(this.eos_token),this.pad_token=J.pad_token,this.pad_token_id=this.tokens_to_ids.get(this.pad_token),this.unk_token=J.unk_token,this.unk_token_id=this.tokens_to_ids.get(this.unk_token),this.vocab=new Array(this.tokens_to_ids.size);for(let[le,me]of this.tokens_to_ids)this.vocab[me]=le}encode($){return $}}class ue extends n.Callable{constructor($){super(),this.config=$}static fromConfig($){if($===null)return null;switch($.type){case"BertNormalizer":return new dt($);case"Precompiled":return new _n($);case"Sequence":return new je($);case"Replace":return new fe($);case"NFC":return new oe($);case"NFD":return new te($);case"NFKC":return new j($);case"NFKD":return new G($);case"Strip":return new de($);case"StripAccents":return new be($);case"Lowercase":return new xe($);case"Prepend":return new Oe($);default:throw new Error(`Unknown Normalizer type: ${$.type}`)}}normalize($){throw Error("normalize should be implemented in subclass.")}_call($){return this.normalize($)}}class fe extends ue{normalize($){let J=p(this.config.pattern);return J===null?$:$.replaceAll(J,this.config.content)}}class Pe extends ue{constructor(){super(...arguments);Z(this,"form")}normalize(J){return J=J.normalize(this.form),J}}class oe extends Pe{constructor(){super(...arguments);Z(this,"form","NFC")}}class te extends Pe{constructor(){super(...arguments);Z(this,"form","NFD")}}class j extends Pe{constructor(){super(...arguments);Z(this,"form","NFKC")}}class G extends Pe{constructor(){super(...arguments);Z(this,"form","NFKD")}}class de extends ue{normalize($){return this.config.strip_left&&this.config.strip_right?$=$.trim():(this.config.strip_left&&($=$.trimStart()),this.config.strip_right&&($=$.trimEnd())),$}}class be extends ue{normalize($){return $=y($),$}}class xe extends ue{normalize($){return $=$.toLowerCase(),$}}class Oe extends ue{normalize($){return $=this.config.prepend+$,$}}class je extends ue{constructor($){super($),this.normalizers=$.normalizers.map(J=>ue.fromConfig(J))}normalize($){return this.normalizers.reduce((J,le)=>le.normalize(J),$)}}class dt extends ue{_tokenize_chinese_chars($){let J=[];for(let le=0;le<$.length;++le){let me=$[le],_e=me.charCodeAt(0);C(_e)?(J.push(" "),J.push(me),J.push(" ")):J.push(me)}return J.join("")}stripAccents($){return $.normalize("NFD").replace(/\p{Mn}/gu,"")}_is_control($){switch($){case"	":case`
`:case"\r":return!1;default:return/^\p{Cc}|\p{Cf}|\p{Co}|\p{Cs}$/u.test($)}}_clean_text($){let J=[];for(let le of $){let me=le.charCodeAt(0);me===0||me===65533||this._is_control(le)||(/^\s$/.test(le)?J.push(" "):J.push(le))}return J.join("")}normalize($){return this.config.clean_text&&($=this._clean_text($)),this.config.handle_chinese_chars&&($=this._tokenize_chinese_chars($)),this.config.lowercase?($=$.toLowerCase(),this.config.strip_accents!==!1&&($=this.stripAccents($))):this.config.strip_accents&&($=this.stripAccents($)),$}}class Re extends n.Callable{static fromConfig($){if($===null)return null;switch($.type){case"BertPreTokenizer":return new U($);case"Sequence":return new xs($);case"Whitespace":return new Ia($);case"WhitespaceSplit":return new Dl($);case"Metaspace":return new un($);case"ByteLevel":return new pe($);case"Split":return new Ce($);case"Punctuation":return new Fe($);case"Digits":return new Ve($);case"Replace":return new Rl($);case"FixedLength":return new Yn($);default:throw new Error(`Unknown PreTokenizer type: ${$.type}`)}}pre_tokenize_text($,J){throw Error("pre_tokenize_text should be implemented in subclass.")}pre_tokenize($,J){return(Array.isArray($)?$.map(le=>this.pre_tokenize_text(le,J)):this.pre_tokenize_text($,J)).flat()}_call($,J){return this.pre_tokenize($,J)}}class U extends Re{constructor($){super(),this.pattern=new RegExp(`[^\\s${k}]+|[${k}]`,"gu")}pre_tokenize_text($,J){return $.trim().match(this.pattern)||[]}}class pe extends Re{constructor($){super(),this.config=$,this.add_prefix_space=this.config.add_prefix_space,this.trim_offsets=this.config.trim_offsets,this.use_regex=this.config.use_regex??!0,this.pattern=/'s|'t|'re|'ve|'m|'ll|'d| ?\p{L}+| ?\p{N}+| ?[^\s\p{L}\p{N}]+|\s+(?!\S)|\s+/gu,this.byte_encoder=ne,this.text_encoder=new TextEncoder}pre_tokenize_text($,J){return this.add_prefix_space&&!$.startsWith(" ")&&($=" "+$),(this.use_regex?$.match(this.pattern)||[]:[$]).map(me=>Array.from(this.text_encoder.encode(me),_e=>this.byte_encoder[_e]).join(""))}}class Ce extends Re{constructor($){super(),this.config=$,this.pattern=p(this.config.pattern,this.config.invert)}pre_tokenize_text($,J){return this.pattern===null?[]:this.config.invert?$.match(this.pattern)||[]:this.config.behavior?.toLowerCase()==="removed"?$.split(this.pattern).filter(le=>le):h($,this.pattern)}}class Fe extends Re{constructor($){super(),this.config=$,this.pattern=new RegExp(`[^${k}]+|[${k}]+`,"gu")}pre_tokenize_text($,J){return $.match(this.pattern)||[]}}class Ve extends Re{constructor($){super(),this.config=$;let J=`[^\\d]+|\\d${this.config.individual_digits?"":"+"}`;this.pattern=new RegExp(J,"gu")}pre_tokenize_text($,J){return $.match(this.pattern)||[]}}class De extends n.Callable{constructor($){super(),this.config=$}static fromConfig($){if($===null)return null;switch($.type){case"TemplateProcessing":return new Se($);case"ByteLevel":return new $e($);case"RobertaProcessing":return new ze($);case"BertProcessing":return new Ee($);case"Sequence":return new et($);default:throw new Error(`Unknown PostProcessor type: ${$.type}`)}}post_process($,...J){throw Error("post_process should be implemented in subclass.")}_call($,...J){return this.post_process($,...J)}}class Ee extends De{constructor($){super($),this.cls=$.cls[0],this.sep=$.sep[0]}post_process($,J=null,{add_special_tokens:le=!0}={}){le&&($=(0,i.mergeArrays)([this.cls],$,[this.sep]));let me=new Array($.length).fill(0);if(J!==null){let _e=le&&this instanceof ze?[this.sep]:[],Ne=le?[this.sep]:[];$=(0,i.mergeArrays)($,_e,J,Ne),me=(0,i.mergeArrays)(me,new Array(J.length+_e.length+Ne.length).fill(1))}return{tokens:$,token_type_ids:me}}}class ze extends Ee{}class Se extends De{constructor($){super($),this.single=$.single,this.pair=$.pair}post_process($,J=null,{add_special_tokens:le=!0}={}){let me=J===null?this.single:this.pair,_e=[],Ne=[];for(let nt of me)"SpecialToken"in nt?le&&(_e.push(nt.SpecialToken.id),Ne.push(nt.SpecialToken.type_id)):"Sequence"in nt&&(nt.Sequence.id==="A"?(_e=(0,i.mergeArrays)(_e,$),Ne=(0,i.mergeArrays)(Ne,new Array($.length).fill(nt.Sequence.type_id))):nt.Sequence.id==="B"&&(_e=(0,i.mergeArrays)(_e,J),Ne=(0,i.mergeArrays)(Ne,new Array(J.length).fill(nt.Sequence.type_id))));return{tokens:_e,token_type_ids:Ne}}}class $e extends De{post_process($,J=null){return J&&($=(0,i.mergeArrays)($,J)),{tokens:$}}}class et extends De{constructor($){super($),this.processors=$.processors.map(J=>De.fromConfig(J))}post_process($,J=null,le={}){let me;for(let _e of this.processors)if(_e instanceof $e)$=_e.post_process($).tokens,J&&(J=_e.post_process(J).tokens);else{let Ne=_e.post_process($,J,le);$=Ne.tokens,me=Ne.token_type_ids}return{tokens:$,token_type_ids:me}}}class Ge extends n.Callable{constructor($){super(),this.config=$,this.added_tokens=[],this.end_of_word_suffix=null,this.trim_offsets=$.trim_offsets}static fromConfig($){if($===null)return null;switch($.type){case"WordPiece":return new at($);case"Metaspace":return new ds($);case"ByteLevel":return new Qe($);case"Replace":return new Ye($);case"ByteFallback":return new Xe($);case"Fuse":return new gt($);case"Strip":return new We($);case"Sequence":return new st($);case"CTC":return new Pt($);case"BPEDecoder":return new zt($);default:throw new Error(`Unknown Decoder type: ${$.type}`)}}_call($){return this.decode($)}decode($){return this.decode_chain($).join("")}decode_chain($){throw Error("`decode_chain` should be implemented in subclass.")}}class Ye extends Ge{decode_chain($){let J=p(this.config.pattern);return J===null?$:$.map(le=>le.replaceAll(J,this.config.content))}}class Xe extends Ge{constructor($){super($),this.text_decoder=new TextDecoder}decode_chain($){let J=[],le=[];for(let me of $){let _e=null;if(me.length===6&&me.startsWith("<0x")&&me.endsWith(">")){let Ne=parseInt(me.slice(3,5),16);isNaN(Ne)||(_e=Ne)}if(_e!==null)le.push(_e);else{if(le.length>0){let Ne=this.text_decoder.decode(Uint8Array.from(le));J.push(Ne),le=[]}J.push(me)}}if(le.length>0){let me=this.text_decoder.decode(Uint8Array.from(le));J.push(me),le=[]}return J}}class gt extends Ge{decode_chain($){return[$.join("")]}}class We extends Ge{constructor($){super($),this.content=this.config.content,this.start=this.config.start,this.stop=this.config.stop}decode_chain($){return $.map(J=>{let le=0;for(let _e=0;_e<this.start&&J[_e]===this.content;++_e){le=_e+1;continue}let me=J.length;for(let _e=0;_e<this.stop;++_e){let Ne=J.length-_e-1;if(J[Ne]===this.content){me=Ne;continue}else break}return J.slice(le,me)})}}class at extends Ge{constructor($){super($),this.cleanup=$.cleanup}decode_chain($){return $.map((J,le)=>(le!==0&&(J.startsWith(this.config.prefix)?J=J.replace(this.config.prefix,""):J=" "+J),this.cleanup&&(J=b(J)),J))}}class Qe extends Ge{constructor($){super($),this.byte_decoder=re,this.text_decoder=new TextDecoder("utf-8",{fatal:!1,ignoreBOM:!0}),this.end_of_word_suffix=null}convert_tokens_to_string($){let J=$.join(""),le=new Uint8Array([...J].map(_e=>this.byte_decoder[_e]));return this.text_decoder.decode(le)}decode_chain($){let J=[],le=[];for(let me of $)this.added_tokens.find(_e=>_e.content===me)!==void 0?(le.length>0&&(J.push(this.convert_tokens_to_string(le)),le=[]),J.push(me)):le.push(me);return le.length>0&&J.push(this.convert_tokens_to_string(le)),J}}class Pt extends Ge{constructor($){super($),this.pad_token=this.config.pad_token,this.word_delimiter_token=this.config.word_delimiter_token,this.cleanup=this.config.cleanup}convert_tokens_to_string($){if($.length===0)return"";let J=[$[0]];for(let _e=1;_e<$.length;++_e)$[_e]!==J.at(-1)&&J.push($[_e]);let me=J.filter(_e=>_e!==this.pad_token).join("");return this.cleanup&&(me=b(me).replaceAll(this.word_delimiter_token," ").trim()),me}decode_chain($){return[this.convert_tokens_to_string($)]}}class st extends Ge{constructor($){super($),this.decoders=$.decoders.map(J=>Ge.fromConfig(J))}decode_chain($){return this.decoders.reduce((J,le)=>le.decode_chain(J),$)}}class zt extends Ge{constructor($){super($),this.suffix=this.config.suffix}decode_chain($){return $.map((J,le)=>J.replaceAll(this.suffix,le===$.length-1?"":" "))}}class rn extends Ge{decode_chain($){let J="";for(let le=1;le<$.length;le+=2)J+=$[le];return[J]}}class un extends Re{constructor($){super(),this.replacement=$.replacement,this.strRep=$.str_rep||this.replacement,this.prepend_scheme=$.prepend_scheme??"always"}pre_tokenize_text($,{section_index:J=void 0}={}){let le=$.replaceAll(" ",this.strRep);return!le.startsWith(this.replacement)&&(this.prepend_scheme==="always"||this.prepend_scheme==="first"&&J===0)&&(le=this.strRep+le),[le]}}class ds extends Ge{constructor($){super($),this.replacement=$.replacement}decode_chain($){let J=[];for(let le=0;le<$.length;++le){let me=$[le].replaceAll(this.replacement," ");le==0&&me.startsWith(" ")&&(me=me.substring(1)),J.push(me)}return J}}class _n extends ue{constructor($){super($),this.charsmap=$.precompiled_charsmap}normalize($){return $=$.replace(/[\u0001-\u0008\u000B\u000E-\u001F\u007F\u008F\u009F]/gm,""),$=$.replace(/[\u0009\u000A\u000C\u000D\u00A0\u1680\u2000-\u200F\u2028\u2029\u202F\u205F\u2581\u3000\uFEFF\uFFFD]/gm," "),$.includes("\uFF5E")?$=$.split("\uFF5E").map(le=>le.normalize("NFKC")).join("\uFF5E"):$=$.normalize("NFKC"),$}}class xs extends Re{constructor($){super(),this.tokenizers=$.pretokenizers.map(J=>Re.fromConfig(J))}pre_tokenize_text($,J){return this.tokenizers.reduce((le,me)=>me.pre_tokenize(le,J),[$])}}class Ia extends Re{constructor($){super()}pre_tokenize_text($,J){return $.match(/\w+|[^\w\s]+/g)||[]}}class Dl extends Re{constructor($){super()}pre_tokenize_text($,J){return S($)}}class Rl extends Re{constructor($){super(),this.config=$,this.pattern=p(this.config.pattern),this.content=this.config.content}pre_tokenize_text($,J){return this.pattern===null?[$]:[$.replaceAll(this.pattern,this.config.content)]}}class Yn extends Re{constructor($){super(),this._length=$.length}pre_tokenize_text($,J){let le=[];for(let me=0;me<$.length;me+=this._length)le.push($.slice(me,me+this._length));return le}}let Ws=["bos_token","eos_token","unk_token","sep_token","pad_token","cls_token","mask_token"];function sr(ve,$,J,le){for(let me of Object.keys(ve)){let _e=$-ve[me].length,Ne=J(me),nt=new Array(_e).fill(Ne);ve[me]=le==="right"?(0,i.mergeArrays)(ve[me],nt):(0,i.mergeArrays)(nt,ve[me])}}function Da(ve,$){for(let J of Object.keys(ve))ve[J].length=$}class Rt extends n.Callable{constructor(J,le){super();Z(this,"return_token_type_ids",!1);Z(this,"padding_side","right");this.config=le,this.normalizer=ue.fromConfig(J.normalizer),this.pre_tokenizer=Re.fromConfig(J.pre_tokenizer),this.model=H.fromConfig(J.model,le),this.post_processor=De.fromConfig(J.post_processor),this.decoder=Ge.fromConfig(J.decoder),this.special_tokens=[],this.all_special_ids=[],this.added_tokens=[];for(let me of J.added_tokens){let _e=new O(me);this.added_tokens.push(_e),this.model.tokens_to_ids.set(_e.content,_e.id),this.model.vocab[_e.id]=_e.content,_e.special&&(this.special_tokens.push(_e.content),this.all_special_ids.push(_e.id))}if(this.additional_special_tokens=le.additional_special_tokens??[],this.special_tokens.push(...this.additional_special_tokens),this.special_tokens=[...new Set(this.special_tokens)],this.decoder&&(this.decoder.added_tokens=this.added_tokens,this.decoder.end_of_word_suffix=this.model.end_of_word_suffix),this.added_tokens_splitter=new l.DictionarySplitter(this.added_tokens.map(me=>me.content)),this.added_tokens_map=new Map(this.added_tokens.map(me=>[me.content,me])),this.mask_token=this.getToken("mask_token"),this.mask_token_id=this.model.tokens_to_ids.get(this.mask_token),this.pad_token=this.getToken("pad_token","eos_token"),this.pad_token_id=this.model.tokens_to_ids.get(this.pad_token),this.sep_token=this.getToken("sep_token"),this.sep_token_id=this.model.tokens_to_ids.get(this.sep_token),this.unk_token=this.getToken("unk_token"),this.unk_token_id=this.model.tokens_to_ids.get(this.unk_token),this.bos_token=this.getToken("bos_token"),this.bos_token_id=this.model.tokens_to_ids.get(this.bos_token),this.eos_token=this.getToken("eos_token"),this.eos_token_id=this.model.tokens_to_ids.get(this.eos_token),this.model_max_length=le.model_max_length,this.remove_space=le.remove_space,this.clean_up_tokenization_spaces=le.clean_up_tokenization_spaces??!0,this.do_lowercase_and_remove_accent=le.do_lowercase_and_remove_accent??!1,le.padding_side&&(this.padding_side=le.padding_side),this.add_bos_token=le.add_bos_token,this.add_eos_token=le.add_eos_token,this.legacy=!1,this.chat_template=le.chat_template??null,Array.isArray(this.chat_template)){let me=Object.create(null);for(let{name:_e,template:Ne}of this.chat_template){if(typeof _e!="string"||typeof Ne!="string")throw new Error('Chat template must be a list of objects with "name" and "template" properties');me[_e]=Ne}this.chat_template=me}this._compiled_template_cache=new Map}getToken(...J){for(let le of J){let me=this.config[le];if(me)if(typeof me=="object"){if(me.__type==="AddedToken")return me.content;throw Error(`Unknown token: ${me}`)}else return me}return null}static async from_pretrained(J,{progress_callback:le=null,config:me=null,cache_dir:_e=null,local_files_only:Ne=!1,revision:nt="main",legacy:ct=null}={}){let it=await u(J,{progress_callback:le,config:me,cache_dir:_e,local_files_only:Ne,revision:nt,legacy:ct});return new this(...it)}_call(J,{text_pair:le=null,add_special_tokens:me=!0,padding:_e=!1,truncation:Ne=null,max_length:nt=null,return_tensor:ct=!0,return_token_type_ids:it=null}={}){let pt=Array.isArray(J),Bt;if(pt){if(J.length===0)throw Error("text array must be non-empty");if(le!==null){if(Array.isArray(le)){if(J.length!==le.length)throw Error("text and text_pair must have the same length")}else throw Error("text_pair must also be an array");Bt=J.map((ln,Gn)=>this._encode_plus(ln,{text_pair:le[Gn],add_special_tokens:me,return_token_type_ids:it}))}else Bt=J.map(ln=>this._encode_plus(ln,{add_special_tokens:me,return_token_type_ids:it}))}else{if(J==null)throw Error("text may not be null or undefined");if(Array.isArray(le))throw Error("When specifying `text_pair`, since `text` is a string, `text_pair` must also be a string (i.e., not an array).");Bt=[this._encode_plus(J,{text_pair:le,add_special_tokens:me,return_token_type_ids:it})]}if(nt===null?nt=this.model_max_length:Ne===null&&(_e===!0?(console.warn("`max_length` is ignored when `padding: true` and there is no truncation strategy. To pad to max length, use `padding: 'max_length'`."),nt=this.model_max_length):_e===!1&&(console.warn("Truncation was not explicitly activated but `max_length` is provided a specific value, please use `truncation: true` to explicitly truncate examples to max length."),Ne=!0)),_e===!0&&(nt=Math.min((0,o.max)(Bt.map(ln=>ln.input_ids.length))[0],nt??1/0)),nt=Math.min(nt,this.model_max_length??1/0),_e||Ne)for(let ln=0;ln<Bt.length;++ln)Bt[ln].input_ids.length!==nt&&(Bt[ln].input_ids.length>nt?Ne&&Da(Bt[ln],nt):_e&&sr(Bt[ln],nt,Gn=>Gn==="input_ids"?this.pad_token_id:0,this.padding_side));let pn={};if(ct){if(!(_e&&Ne)&&Bt.some(Gn=>{for(let Cn of Object.keys(Gn))if(Gn[Cn].length!==Bt[0][Cn]?.length)return!0;return!1}))throw Error("Unable to create tensor, you should probably activate truncation and/or padding with 'padding=true' and 'truncation=true' to have batched tensors with the same length.");let ln=[Bt.length,Bt[0].input_ids.length];for(let Gn of Object.keys(Bt[0]))pn[Gn]=new a.Tensor("int64",BigInt64Array.from(Bt.flatMap(Cn=>Cn[Gn]).map(BigInt)),ln)}else{for(let ln of Object.keys(Bt[0]))pn[ln]=Bt.map(Gn=>Gn[ln]);if(!pt)for(let ln of Object.keys(pn))pn[ln]=pn[ln][0]}return pn}_encode_text(J){if(J===null)return null;let le=this.added_tokens_splitter.split(J);for(let _e=0;_e<le.length;++_e){let Ne=this.added_tokens_map.get(le[_e]);Ne&&(Ne.lstrip&&_e>0&&(le[_e-1]=le[_e-1].trimEnd()),Ne.rstrip&&_e<le.length-1&&(le[_e+1]=le[_e+1].trimStart()))}return le.flatMap((_e,Ne)=>{if(_e.length===0)return[];if(this.added_tokens_map.has(_e))return[_e];if(this.remove_space===!0&&(_e=_e.trim().split(/\s+/).join(" ")),this.do_lowercase_and_remove_accent&&(_e=w(_e)),this.normalizer!==null&&(_e=this.normalizer(_e)),_e.length===0)return[];let nt=this.pre_tokenizer!==null?this.pre_tokenizer(_e,{section_index:Ne}):[_e];return this.model(nt)})}_encode_plus(J,{text_pair:le=null,add_special_tokens:me=!0,return_token_type_ids:_e=null}={}){let{tokens:Ne,token_type_ids:nt}=this._tokenize_helper(J,{pair:le,add_special_tokens:me}),ct=this.model.convert_tokens_to_ids(Ne),it={input_ids:ct,attention_mask:new Array(ct.length).fill(1)};return(_e??this.return_token_type_ids)&&nt&&(it.token_type_ids=nt),it}_tokenize_helper(J,{pair:le=null,add_special_tokens:me=!1}={}){let _e=this._encode_text(J),Ne=this._encode_text(le);return this.post_processor?this.post_processor(_e,Ne,{add_special_tokens:me}):{tokens:(0,i.mergeArrays)(_e??[],Ne??[])}}tokenize(J,{pair:le=null,add_special_tokens:me=!1}={}){return this._tokenize_helper(J,{pair:le,add_special_tokens:me}).tokens}encode(J,{text_pair:le=null,add_special_tokens:me=!0,return_token_type_ids:_e=null}={}){return this._encode_plus(J,{text_pair:le,add_special_tokens:me,return_token_type_ids:_e}).input_ids}batch_decode(J,le={}){return J instanceof a.Tensor&&(J=J.tolist()),J.map(me=>this.decode(me,le))}decode(J,le={}){if(J instanceof a.Tensor&&(J=_(J)),!Array.isArray(J)||J.length===0||!(0,i.isIntegralNumber)(J[0]))throw Error("token_ids must be a non-empty array of integers.");return this.decode_single(J,le)}decode_single(J,{skip_special_tokens:le=!1,clean_up_tokenization_spaces:me=null}){let _e=this.model.convert_ids_to_tokens(J);le&&(_e=_e.filter(nt=>!this.special_tokens.includes(nt)));let Ne=this.decoder?this.decoder(_e):_e.join(" ");return this.decoder&&this.decoder.end_of_word_suffix&&(Ne=Ne.replaceAll(this.decoder.end_of_word_suffix," "),le&&(Ne=Ne.trim())),(me??this.clean_up_tokenization_spaces)&&(Ne=b(Ne)),Ne}get_chat_template({chat_template:J=null,tools:le=null}={}){if(this.chat_template&&typeof this.chat_template=="object"){let me=this.chat_template;if(J!==null&&Object.hasOwn(me,J))J=me[J];else if(J===null)if(le!==null&&"tool_use"in me)J=me.tool_use;else if("default"in me)J=me.default;else throw Error(`This model has multiple chat templates with no default specified! Please either pass a chat template or the name of the template you wish to use to the 'chat_template' argument. Available template names are ${Object.keys(me).sort()}.`)}else if(J===null)if(this.chat_template)J=this.chat_template;else throw Error("Cannot use apply_chat_template() because tokenizer.chat_template is not set and no template argument was passed! For information about writing templates and setting the tokenizer.chat_template attribute, please see the documentation at https://huggingface.co/docs/transformers/main/en/chat_templating");return J}apply_chat_template(J,{tools:le=null,documents:me=null,chat_template:_e=null,add_generation_prompt:Ne=!1,tokenize:nt=!0,padding:ct=!1,truncation:it=!1,max_length:pt=null,return_tensor:Bt=!0,return_dict:pn=!1,tokenizer_kwargs:ln={},...Gn}={}){if(_e=this.get_chat_template({chat_template:_e,tools:le}),typeof _e!="string")throw Error(`chat_template must be a string, but got ${typeof _e}`);let Cn=this._compiled_template_cache.get(_e);Cn===void 0&&(Cn=new c.Template(_e),this._compiled_template_cache.set(_e,Cn));let qs=Object.create(null);for(let is of Ws){let _s=this.getToken(is);_s&&(qs[is]=_s)}let gs=Cn.render({messages:J,add_generation_prompt:Ne,tools:le,documents:me,...qs,...Gn});if(nt){let is=this._call(gs,{add_special_tokens:!1,padding:ct,truncation:it,max_length:pt,return_tensor:Bt,...ln});return pn?is:is.input_ids}return gs}}class zo extends Rt{constructor(){super(...arguments);Z(this,"return_token_type_ids",!0)}}class In extends Rt{constructor(){super(...arguments);Z(this,"return_token_type_ids",!0)}}class Uo extends Rt{constructor(){super(...arguments);Z(this,"return_token_type_ids",!0)}}class Bi extends Rt{constructor(){super(...arguments);Z(this,"return_token_type_ids",!0)}}class Kt extends Rt{constructor(){super(...arguments);Z(this,"return_token_type_ids",!0)}}class zi extends Rt{constructor(){super(...arguments);Z(this,"return_token_type_ids",!0)}}class F extends Rt{constructor(){super(...arguments);Z(this,"return_token_type_ids",!0)}}class ie extends Rt{constructor(){super(...arguments);Z(this,"return_token_type_ids",!0)}}class q extends Rt{constructor(){super(...arguments);Z(this,"return_token_type_ids",!0)}}class ee extends Rt{}class ae extends Rt{}class ye extends Rt{constructor(J,le){super(J,le);Z(this,"return_token_type_ids",!0);console.warn('WARNING: `XLMTokenizer` is not yet supported by Hugging Face\'s "fast" tokenizers library. Therefore, you may experience slightly inaccurate results.')}}class Le extends Rt{constructor(){super(...arguments);Z(this,"return_token_type_ids",!0)}}class ht extends Rt{}class wt extends Rt{}class rt extends Rt{}class Lt extends Rt{constructor($,J){super($,J),this.languageRegex=/^[a-z]{2}_[A-Z]{2}$/,this.language_codes=this.special_tokens.filter(le=>this.languageRegex.test(le)),this.lang_to_token=le=>le}_build_translation_inputs($,J,le){return Ai(this,$,J,le)}}class ut extends Lt{}class Nt extends Rt{}class hn extends Rt{}let Fn="\u2581";class ns extends Rt{constructor(J,le){super(J,le);Z(this,"padding_side","left");this.legacy=le.legacy??!0,this.legacy||(this.normalizer=null,this.pre_tokenizer=new un({replacement:Fn,prepend_scheme:"first"}))}_encode_text(J){if(J===null)return null;if(this.legacy||J.length===0)return super._encode_text(J);let le=super._encode_text(Fn+J.replaceAll(Fn," "));return le.length>1&&le[0]===Fn&&this.special_tokens.includes(le[1])&&(le=le.slice(1)),le}}class Hs extends Rt{}class Fs extends Rt{}class js extends Rt{}class Qr extends Rt{}class Vo extends Rt{}class us extends Rt{}class Ra extends Rt{}class Pr extends Rt{}class si extends Rt{}function Ai(ve,$,J,le){if(!("language_codes"in ve)||!Array.isArray(ve.language_codes))throw new Error("Tokenizer must have `language_codes` attribute set and it should be an array of language ids.");if(!("languageRegex"in ve)||!(ve.languageRegex instanceof RegExp))throw new Error("Tokenizer must have `languageRegex` attribute set and it should be a regular expression.");if(!("lang_to_token"in ve)||typeof ve.lang_to_token!="function")throw new Error("Tokenizer must have `lang_to_token` attribute set and it should be a function.");let me=le.src_lang,_e=le.tgt_lang;if(!ve.language_codes.includes(_e))throw new Error(`Target language code "${_e}" is not valid. Must be one of: {${ve.language_codes.join(", ")}}`);if(me!==void 0){if(!ve.language_codes.includes(me))throw new Error(`Source language code "${me}" is not valid. Must be one of: {${ve.language_codes.join(", ")}}`);for(let Ne of ve.post_processor.config.single)if("SpecialToken"in Ne&&ve.languageRegex.test(Ne.SpecialToken.id)){Ne.SpecialToken.id=ve.lang_to_token(me);break}}return le.forced_bos_token_id=ve.model.convert_tokens_to_ids([ve.lang_to_token(_e)])[0],ve._call($,J)}class Xn extends Rt{constructor($,J){super($,J),this.languageRegex=/^[a-z]{3}_[A-Z][a-z]{3}$/,this.language_codes=this.special_tokens.filter(le=>this.languageRegex.test(le)),this.lang_to_token=le=>le}_build_translation_inputs($,J,le){return Ai(this,$,J,le)}}class ss extends Rt{constructor($,J){super($,J),this.languageRegex=/^__[a-z]{2,3}__$/,this.language_codes=this.special_tokens.filter(le=>this.languageRegex.test(le)).map(le=>le.slice(2,-2)),this.lang_to_token=le=>`__${le}__`}_build_translation_inputs($,J,le){return Ai(this,$,J,le)}}class Jr extends Rt{get timestamp_begin(){return this.model.convert_tokens_to_ids(["<|notimestamps|>"])[0]+1}_decode_asr($,{return_timestamps:J=!1,return_language:le=!1,time_precision:me=null,force_full_sequences:_e=!0}={}){if(me===null)throw Error("Must specify time_precision");let Ne=null,nt=J==="word";function ct(){return{language:Ne,timestamp:[null,null],text:""}}let it=[],pt=ct(),Bt=0,pn=this.timestamp_begin,Gn=pn+1500,Cn=[],qs=[],gs=!1,is=null,_s=new Set(this.all_special_ids);for(let On of $){let ys=On.tokens,Ls=nt?On.token_timestamps:null,Ui=null,Zr=pn;if("stride"in On){let[Qn,rs,hs]=On.stride;if(Bt-=rs,is=Qn-hs,rs&&(Zr=rs/me+pn),hs)for(let Wn=ys.length-1;Wn>=0;--Wn){let Pi=Number(ys[Wn]);if(Pi>=pn){if(Ui!==null&&(Pi-pn)*me<is)break;Ui=Pi}}}let Ns=[],Ir=[];for(let Qn=0;Qn<ys.length;++Qn){let rs=Number(ys[Qn]);if(_s.has(rs)){let hs=this.decode([rs]),Wn=d.WHISPER_LANGUAGE_MAPPING.get(hs.slice(2,-2));if(Wn!==void 0){if(Ne!==null&&Wn!==Ne&&!J){Cn.push(Ns);let Pi=this.findLongestCommonSequence(Cn)[0],Na=this.decode(Pi);pt.text=Na,it.push(pt),Cn=[],Ns=[],pt=ct()}Ne=pt.language=Wn}}else if(rs>=pn&&rs<=Gn){let hs=(rs-pn)*me+Bt,Wn=(0,o.round)(hs,2);if(Ui!==null&&rs>=Ui)gs=!0;else if(gs||Cn.length>0&&rs<Zr)gs=!1;else if(pt.timestamp[0]===null)pt.timestamp[0]=Wn;else if(Wn!==pt.timestamp[0]){pt.timestamp[1]=Wn,Cn.push(Ns),nt&&qs.push(Ir);let[Pi,Na]=this.findLongestCommonSequence(Cn,qs),qo=this.decode(Pi);pt.text=qo,nt&&(pt.words=this.collateWordTimestamps(Pi,Na,Ne)),it.push(pt),Cn=[],Ns=[],qs=[],Ir=[],pt=ct()}}else if(Ns.push(rs),nt){let hs=(0,o.round)(Ls[Qn]+Bt,2),Wn;if(Qn+1<Ls.length){Wn=(0,o.round)(Ls[Qn+1]+Bt,2);let Pi=this.decode([rs]);T.test(Pi)&&(Wn=(0,o.round)(Math.min(hs+me,Wn),2))}else Wn=null;Ir.push([hs,Wn])}}if("stride"in On){let[Qn,rs,hs]=On.stride;Bt+=Qn-hs}Ns.length>0?(Cn.push(Ns),nt&&qs.push(Ir)):Cn.every(Qn=>Qn.length===0)&&(pt=ct(),Cn=[],Ns=[],qs=[],Ir=[])}if(Cn.length>0){if(_e&&J)throw new Error("Whisper did not predict an ending timestamp, which can happen if audio is cut off in the middle of a word. Also make sure WhisperTimeStampLogitsProcessor was used during generation.");let[On,ys]=this.findLongestCommonSequence(Cn,qs),Ls=this.decode(On);pt.text=Ls,nt&&(pt.words=this.collateWordTimestamps(On,ys,Ne)),it.push(pt)}let Ss=Object.create(null),ir=it.map(On=>On.text).join("");if(J||le){for(let On=0;On<it.length;++On){let ys=it[On];J||delete ys.timestamp,le||delete ys.language}if(nt){let On=[];for(let ys of it)for(let Ls of ys.words)On.push(Ls);Ss={chunks:On}}else Ss={chunks:it}}return[ir,Ss]}findLongestCommonSequence($,J=null){let le=$[0],me=le.length,_e=[],Ne=Array.isArray(J)&&J.length>0,nt=Ne?[]:null,ct=Ne?J[0]:null;for(let it=1;it<$.length;++it){let pt=$[it],Bt=0,pn=[me,me,0,0],ln=pt.length;for(let Ss=1;Ss<me+ln;++Ss){let ir=Math.max(0,me-Ss),On=Math.min(me,me+ln-Ss),ys=le.slice(ir,On),Ls=Math.max(0,Ss-me),Ui=Math.min(ln,Ss),Zr=pt.slice(Ls,Ui);if(ys.length!==Zr.length)throw new Error("There is a bug within whisper `decode_asr` function, please report it. Dropping to prevent bad inference.");let Ns;Ne?Ns=ys.filter((rs,hs)=>rs===Zr[hs]&&ct[ir+hs]<=J[it][Ls+hs]).length:Ns=ys.filter((rs,hs)=>rs===Zr[hs]).length;let Ir=Ss/1e4,Qn=Ns/Ss+Ir;Ns>1&&Qn>Bt&&(Bt=Qn,pn=[ir,On,Ls,Ui])}let[Gn,Cn,qs,gs]=pn,is=Math.floor((Cn+Gn)/2),_s=Math.floor((gs+qs)/2);_e.push(...le.slice(0,is)),le=pt.slice(_s),me=le.length,Ne&&(nt.push(...ct.slice(0,is)),ct=J[it].slice(_s))}return _e.push(...le),Ne?(nt.push(...ct),[_e,nt]):[_e,[]]}collateWordTimestamps($,J,le){let[me,_e,Ne]=this.combineTokensIntoWords($,le),nt=[];for(let ct=0;ct<me.length;++ct){let it=Ne[ct];nt.push({text:me[ct],timestamp:[J[it.at(0)][0],J[it.at(-1)][1]]})}return nt}combineTokensIntoWords($,J,le=`"'\u201C\xA1\xBF([{-`,me=`"'.\u3002,\uFF0C!\uFF01?\uFF1F:\uFF1A\u201D)]}\u3001`){J=J??"english";let _e,Ne,nt;return["chinese","japanese","thai","lao","myanmar"].includes(J)?[_e,Ne,nt]=this.splitTokensOnUnicode($):[_e,Ne,nt]=this.splitTokensOnSpaces($),this.mergePunctuations(_e,Ne,nt,le,me)}decode($,J){let le;return J?.decode_with_timestamps?($ instanceof a.Tensor&&($=_($)),le=this.decodeWithTimestamps($,J)):le=super.decode($,J),le}decodeWithTimestamps($,J){let le=J?.time_precision??.02,me=Array.from(this.all_special_ids).at(-1)+1,_e=[[]];for(let Ne of $)if(Ne=Number(Ne),Ne>=me){let nt=((Ne-me)*le).toFixed(2);_e.push(`<|${nt}|>`),_e.push([])}else _e[_e.length-1].push(Ne);return _e=_e.map(Ne=>typeof Ne=="string"?Ne:super.decode(Ne,J)),_e.join("")}splitTokensOnUnicode($){let J=this.decode($,{decode_with_timestamps:!0}),le="\uFFFD",me=[],_e=[],Ne=[],nt=[],ct=[],it=0;for(let pt=0;pt<$.length;++pt){let Bt=$[pt];nt.push(Bt),ct.push(pt);let pn=this.decode(nt,{decode_with_timestamps:!0});(!pn.includes(le)||J[it+pn.indexOf(le)]===le)&&(me.push(pn),_e.push(nt),Ne.push(ct),nt=[],ct=[],it+=pn.length)}return[me,_e,Ne]}splitTokensOnSpaces($){let[J,le,me]=this.splitTokensOnUnicode($),_e=[],Ne=[],nt=[],ct=new RegExp(`^[${k}]$`,"gu");for(let it=0;it<J.length;++it){let pt=J[it],Bt=le[it],pn=me[it],ln=Bt[0]>=this.model.tokens_to_ids.get("<|endoftext|>"),Gn=pt.startsWith(" "),Cn=pt.trim(),qs=ct.test(Cn);if(ln||Gn||qs||_e.length===0)_e.push(pt),Ne.push(Bt),nt.push(pn);else{let gs=_e.length-1;_e[gs]+=pt,Ne[gs].push(...Bt),nt[gs].push(...pn)}}return[_e,Ne,nt]}mergePunctuations($,J,le,me,_e){let Ne=structuredClone($),nt=structuredClone(J),ct=structuredClone(le),it=Ne.length-2,pt=Ne.length-1;for(;it>=0;)Ne[it].startsWith(" ")&&me.includes(Ne[it].trim())?(Ne[pt]=Ne[it]+Ne[pt],nt[pt]=(0,i.mergeArrays)(nt[it],nt[pt]),ct[pt]=(0,i.mergeArrays)(ct[it],ct[pt]),Ne[it]="",nt[it]=[],ct[it]=[]):pt=it,--it;for(it=0,pt=1;pt<Ne.length;)!Ne[it].endsWith(" ")&&_e.includes(Ne[pt])?(Ne[it]+=Ne[pt],nt[it]=(0,i.mergeArrays)(nt[it],nt[pt]),ct[it]=(0,i.mergeArrays)(ct[it],ct[pt]),Ne[pt]="",nt[pt]=[],ct[pt]=[]):it=pt,++pt;return[Ne.filter(Bt=>Bt),nt.filter(Bt=>Bt.length>0),ct.filter(Bt=>Bt.length>0)]}}class Go extends Rt{}class Wo extends Rt{}class Ho extends Rt{}class kr extends Rt{constructor($,J){super($,J),this.languageRegex=/^(>>\w+<<)\s*/g,this.supported_language_codes=this.model.vocab.filter(le=>this.languageRegex.test(le)),console.warn('WARNING: `MarianTokenizer` is not yet supported by Hugging Face\'s "fast" tokenizers library. Therefore, you may experience slightly inaccurate results.')}_encode_text($){if($===null)return null;let[J,...le]=$.trim().split(this.languageRegex);if(le.length===0)return super._encode_text(J);if(le.length===2){let[me,_e]=le;return this.supported_language_codes.includes(me)||console.warn(`Unsupported language code "${me}" detected, which may lead to unexpected behavior. Should be one of: ${JSON.stringify(this.supported_language_codes)}`),(0,i.mergeArrays)([me],super._encode_text(_e))}}}class mi extends Rt{}class Ke extends Rt{}class tt extends Rt{}class _t extends Rt{}class kn extends Rt{}class Fa extends Rt{constructor($,J){super($,J),this.decoder=new rn({})}}class jo extends Rt{}class La extends Rt{}class ed{static async from_pretrained($,{progress_callback:J=null,config:le=null,cache_dir:me=null,local_files_only:_e=!1,revision:Ne="main",legacy:nt=null}={}){let[ct,it]=await u($,{progress_callback:J,config:le,cache_dir:me,local_files_only:_e,revision:Ne,legacy:nt}),pt=it.tokenizer_class?.replace(/Fast$/,"")??"PreTrainedTokenizer",Bt=this.TOKENIZER_CLASS_MAPPING[pt];return Bt||(console.warn(`Unknown tokenizer class "${pt}", attempting to construct from base class.`),Bt=Rt),new Bt(ct,it)}}Z(ed,"TOKENIZER_CLASS_MAPPING",{T5Tokenizer:ht,DistilBertTokenizer:ee,CamembertTokenizer:ae,DebertaTokenizer:Kt,DebertaV2Tokenizer:zi,BertTokenizer:zo,HerbertTokenizer:F,ConvBertTokenizer:ie,RoFormerTokenizer:q,XLMTokenizer:ye,ElectraTokenizer:Le,MobileBertTokenizer:Uo,SqueezeBertTokenizer:Bi,AlbertTokenizer:In,GPT2Tokenizer:wt,BartTokenizer:rt,MBartTokenizer:Lt,MBart50Tokenizer:ut,RobertaTokenizer:Nt,WhisperTokenizer:Jr,CodeGenTokenizer:Go,CLIPTokenizer:Wo,SiglipTokenizer:Ho,MarianTokenizer:kr,BloomTokenizer:hn,NllbTokenizer:Xn,M2M100Tokenizer:ss,LlamaTokenizer:ns,CodeLlamaTokenizer:Hs,XLMRobertaTokenizer:Fs,MPNetTokenizer:js,FalconTokenizer:Qr,GPTNeoXTokenizer:Vo,EsmTokenizer:us,Wav2Vec2CTCTokenizer:mi,BlenderbotTokenizer:Ke,BlenderbotSmallTokenizer:tt,SpeechT5Tokenizer:_t,NougatTokenizer:kn,VitsTokenizer:Fa,Qwen2Tokenizer:Ra,GemmaTokenizer:Pr,Grok1Tokenizer:si,CohereTokenizer:jo,MgpstrTokenizer:La,PreTrainedTokenizer:Rt})},"./src/utils/audio.js":(s,e,t)=>{t.r(e),t.d(e,{RawAudio:()=>X,hamming:()=>h,hanning:()=>u,mel_filter_bank:()=>C,read_audio:()=>c,spectrogram:()=>P,window_function:()=>R});var n=t("./src/utils/hub.js"),i=t("./src/utils/maths.js"),r=t("./src/utils/core.js"),o=t("./src/env.js"),a=t("./src/utils/tensor.js"),l=t("?7992");async function c(z,ne){if(typeof AudioContext>"u")throw Error("Unable to load audio from path/URL since `AudioContext` is not available in your environment. Instead, audio data should be passed directly to the pipeline/processor. For more information and some example code, see https://huggingface.co/docs/transformers.js/guides/node-audio-processing.");let re=await(await(0,n.getFile)(z)).arrayBuffer(),Y=new AudioContext({sampleRate:ne});typeof ne>"u"&&console.warn(`No sampling rate provided, using default of ${Y.sampleRate}Hz.`);let se=await Y.decodeAudioData(re),ue;if(se.numberOfChannels===2){let fe=Math.sqrt(2),Pe=se.getChannelData(0),oe=se.getChannelData(1);ue=new Float32Array(Pe.length);for(let te=0;te<se.length;++te)ue[te]=fe*(Pe[te]+oe[te])/2}else ue=se.getChannelData(0);return ue}function d(z,ne){if(z<1)return new Float64Array;if(z===1)return new Float64Array([1]);let re=1-ne,Y=2*Math.PI/(z-1),se=new Float64Array(z);for(let ue=0;ue<z;++ue)se[ue]=ne-re*Math.cos(ue*Y);return se}function u(z){return d(z,.5)}function h(z){return d(z,.54)}let p={htk:z=>2595*Math.log10(1+z/700),kaldi:z=>1127*Math.log(1+z/700),slaney:(z,ne=1e3,re=15,Y=27/Math.log(6.4))=>z>=ne?re+Math.log(z/ne)*Y:3*z/200};function f(z,ne="htk"){let re=p[ne];if(!re)throw new Error('mel_scale should be one of "htk", "slaney" or "kaldi".');return typeof z=="number"?re(z):z.map(Y=>re(Y))}let _={htk:z=>700*(10**(z/2595)-1),kaldi:z=>700*(Math.exp(z/1127)-1),slaney:(z,ne=1e3,re=15,Y=Math.log(6.4)/27)=>z>=re?ne*Math.exp(Y*(z-re)):200*z/3};function b(z,ne="htk"){let re=_[ne];if(!re)throw new Error('mel_scale should be one of "htk", "slaney" or "kaldi".');return typeof z=="number"?re(z):z.map(Y=>re(Y))}function y(z,ne){let re=Float64Array.from({length:ne.length-1},(fe,Pe)=>ne[Pe+1]-ne[Pe]),Y=Array.from({length:z.length},()=>new Array(ne.length));for(let fe=0;fe<z.length;++fe){let Pe=Y[fe];for(let oe=0;oe<ne.length;++oe)Pe[oe]=ne[oe]-z[fe]}let se=ne.length-2,ue=Array.from({length:se},()=>new Array(z.length));for(let fe=0;fe<z.length;++fe){let Pe=Y[fe];for(let oe=0;oe<se;++oe){let te=-Pe[oe]/re[oe],j=Pe[oe+2]/re[oe+1];ue[oe][fe]=Math.max(0,Math.min(te,j))}}return ue}function w(z,ne,re){let Y=(ne-z)/(re-1);return Float64Array.from({length:re},(se,ue)=>z+Y*ue)}function C(z,ne,re,Y,se,ue=null,fe="htk",Pe=!1){if(ue!==null&&ue!=="slaney")throw new Error('norm must be one of null or "slaney"');if(z<2)throw new Error(`Require num_frequency_bins: ${z} >= 2`);if(re>Y)throw new Error(`Require min_frequency: ${re} <= max_frequency: ${Y}`);let oe=f(re,fe),te=f(Y,fe),j=w(oe,te,ne+2),G=b(j,fe),de;if(Pe){let xe=se/((z-1)*2);de=f(Float64Array.from({length:z},(Oe,je)=>je*xe),fe),G=j}else de=w(0,Math.floor(se/2),z);let be=y(de,G);if(ue!==null&&ue==="slaney")for(let xe=0;xe<ne;++xe){let Oe=be[xe],je=2/(G[xe+2]-G[xe]);for(let dt=0;dt<z;++dt)Oe[dt]*=je}return be}function M(z,ne,re){let Y=new z.constructor(z.length+ne+re),se=z.length-1;for(let ue=0;ue<z.length;++ue)Y[ne+ue]=z[ue];for(let ue=1;ue<=ne;++ue)Y[ne-ue]=z[(0,r.calculateReflectOffset)(ue,se)];for(let ue=1;ue<=re;++ue)Y[se+ne+ue]=z[(0,r.calculateReflectOffset)(se-ue,se)];return Y}function S(z,ne,re,Y,se){if(re<=0)throw new Error("reference must be greater than zero");if(Y<=0)throw new Error("min_value must be greater than zero");re=Math.max(Y,re);let ue=Math.log10(re);for(let fe=0;fe<z.length;++fe)z[fe]=ne*Math.log10(Math.max(Y,z[fe])-ue);if(se!==null){if(se<=0)throw new Error("db_range must be greater than zero");let fe=(0,i.max)(z)[0]-se;for(let Pe=0;Pe<z.length;++Pe)z[Pe]=Math.max(z[Pe],fe)}return z}function k(z,ne=1,re=1e-5,Y=null){return S(z,20,ne,re,Y)}function T(z,ne=1,re=1e-10,Y=null){return S(z,10,ne,re,Y)}async function P(z,ne,re,Y,{fft_length:se=null,power:ue=1,center:fe=!0,pad_mode:Pe="reflect",onesided:oe=!0,preemphasis:te=null,preemphasis_htk_flavor:j=!0,mel_filters:G=null,mel_floor:de=1e-10,log_mel:be=null,reference:xe=1,min_value:Oe=1e-10,db_range:je=null,remove_dc_offset:dt=null,min_num_frames:Re=null,max_num_frames:U=null,do_pad:pe=!0,transpose:Ce=!1,mel_offset:Fe=0}={}){let Ve=ne.length;if(se===null&&(se=re),re>se)throw Error(`frame_length (${re}) may not be larger than fft_length (${se})`);if(Ve!==re)throw new Error(`Length of the window (${Ve}) must equal frame_length (${re})`);if(Y<=0)throw new Error("hop_length must be greater than zero");if(ue===null&&G!==null)throw new Error("You have provided `mel_filters` but `power` is `None`. Mel spectrogram computation is not yet supported for complex-valued spectrogram. Specify `power` to fix this issue.");if(!j)throw new Error("`preemphasis_htk_flavor=false` is not currently supported.");if(fe)switch(Pe){case"reflect":{let at=Math.floor((se-1)/2)+1;z=M(z,at,at);break}case"constant":{let at=Math.floor(se/2),Qe=new z.constructor(z.length+2*at);Qe.set(z,at),z=Qe;break}default:throw new Error(`pad_mode="${Pe}" not implemented yet.`)}let De=Math.floor(1+Math.floor((z.length-re)/Y));Re!==null&&De<Re&&(De=Re);let Ee=oe?Math.floor(se/2)+1:se,ze=De,Se=De;U!==null&&(U>De?pe&&(Se=U):Se=ze=U);let $e=new i.FFT(se),et=new Float64Array(se),Ge=new Float64Array($e.outputBufferSize),Ye=new Float32Array(Ee*Se);for(let at=0;at<ze;++at){let Qe=at*Y,Pt=Math.min(z.length-Qe,re);Pt!==re&&et.fill(0,0,re);for(let st=0;st<Pt;++st)et[st]=z[Qe+st];if(dt){let st=0;for(let rn=0;rn<Pt;++rn)st+=et[rn];let zt=st/Pt;for(let rn=0;rn<Pt;++rn)et[rn]-=zt}if(te!==null){for(let st=Pt-1;st>=1;--st)et[st]-=te*et[st-1];et[0]*=1-te}for(let st=0;st<ne.length;++st)et[st]*=ne[st];$e.realTransform(Ge,et);for(let st=0;st<Ee;++st){let zt=st<<1;Ye[st*Se+at]=Ge[zt]**2+Ge[zt+1]**2}}if(ue!==null&&ue!==2){let at=ue/2;for(let Qe=0;Qe<Ye.length;++Qe)Ye[Qe]**=at}let Xe=G.length,gt=await(0,a.matmul)(new a.Tensor("float32",G.flat(),[Xe,Ee]),new a.Tensor("float32",Ye,[Ee,Se]));Ce&&(gt=gt.transpose(1,0));let We=gt.data;for(let at=0;at<We.length;++at)We[at]=Fe+Math.max(de,We[at]);if(ue!==null&&be!==null){let at=Math.min(We.length,ze*Xe);switch(be){case"log":for(let Qe=0;Qe<at;++Qe)We[Qe]=Math.log(We[Qe]);break;case"log10":for(let Qe=0;Qe<at;++Qe)We[Qe]=Math.log10(We[Qe]);break;case"dB":if(ue===1)k(We,xe,Oe,je);else if(ue===2)T(We,xe,Oe,je);else throw new Error(`Cannot use log_mel option '${be}' with power ${ue}`);break;default:throw new Error(`log_mel must be one of null, 'log', 'log10' or 'dB'. Got '${be}'`)}}return gt}function R(z,ne,{periodic:re=!0,frame_length:Y=null,center:se=!0}={}){let ue=re?z+1:z,fe;switch(ne){case"boxcar":fe=new Float64Array(ue).fill(1);break;case"hann":case"hann_window":fe=u(ue);break;case"hamming":fe=h(ue);break;case"povey":fe=u(ue).map(Pe=>Math.pow(Pe,.85));break;default:throw new Error(`Unknown window type ${ne}.`)}if(re&&(fe=fe.subarray(0,z)),Y===null)return fe;if(z>Y)throw new Error(`Length of the window (${z}) may not be larger than frame_length (${Y})`);return fe}function O(z,ne){let re=44,Y=new ArrayBuffer(re+z.length*4),se=new DataView(Y);H(se,0,"RIFF"),se.setUint32(4,36+z.length*4,!0),H(se,8,"WAVE"),H(se,12,"fmt "),se.setUint32(16,16,!0),se.setUint16(20,3,!0),se.setUint16(22,1,!0),se.setUint32(24,ne,!0),se.setUint32(28,ne*4,!0),se.setUint16(32,4,!0),se.setUint16(34,32,!0),H(se,36,"data"),se.setUint32(40,z.length*4,!0);for(let ue=0;ue<z.length;++ue,re+=4)se.setFloat32(re,z[ue],!0);return Y}function H(z,ne,re){for(let Y=0;Y<re.length;++Y)z.setUint8(ne+Y,re.charCodeAt(Y))}class X{constructor(ne,re){this.audio=ne,this.sampling_rate=re}toWav(){return O(this.audio,this.sampling_rate)}toBlob(){let ne=this.toWav();return new Blob([ne],{type:"audio/wav"})}async save(ne){let re;if(o.apis.IS_BROWSER_ENV){if(o.apis.IS_WEBWORKER_ENV)throw new Error("Unable to save a file from a Web Worker.");re=r.saveBlob}else if(o.apis.IS_FS_AVAILABLE)re=async(Y,se)=>{let ue=await se.arrayBuffer();l.writeFileSync(Y,Buffer.from(ue))};else throw new Error("Unable to save because filesystem is disabled in this environment.");await re(ne,this.toBlob())}}},"./src/utils/constants.js":(s,e,t)=>{t.r(e),t.d(e,{CHAT_TEMPLATE_NAME:()=>l,CONFIG_NAME:()=>i,FEATURE_EXTRACTOR_NAME:()=>r,GENERATION_CONFIG_NAME:()=>c,GITHUB_ISSUE_URL:()=>n,IMAGE_PROCESSOR_NAME:()=>o,PROCESSOR_NAME:()=>a});let n="https://github.com/huggingface/transformers.js/issues/new/choose",i="config.json",r="preprocessor_config.json",o=r,a="processor_config.json",l="chat_template.jinja",c="generation_config.json"},"./src/utils/core.js":(s,e,t)=>{t.r(e),t.d(e,{calculateDimensions:()=>c,calculateReflectOffset:()=>p,count:()=>y,dispatchCallback:()=>n,escapeRegExp:()=>r,isIntegralNumber:()=>a,isNullishDimension:()=>l,isTypedArray:()=>o,len:()=>b,mergeArrays:()=>u,pick:()=>_,pop:()=>d,product:()=>h,reverseDictionary:()=>i,saveBlob:()=>f});function n(w,C){w&&w(C)}function i(w){return Object.fromEntries(Object.entries(w).map(([C,M])=>[M,C]))}function r(w){return w.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function o(w){return w?.prototype?.__proto__?.constructor?.name==="TypedArray"}function a(w){return Number.isInteger(w)||typeof w=="bigint"}function l(w){return w==null||w===-1}function c(w){let C=[],M=w;for(;Array.isArray(M);)C.push(M.length),M=M[0];return C}function d(w,C,M=void 0){let S=w[C];if(S!==void 0)return delete w[C],S;if(M===void 0)throw Error(`Key ${C} does not exist in object.`);return M}function u(...w){return Array.prototype.concat.apply([],w)}function h(...w){return w.reduce((C,M)=>C.flatMap(S=>M.map(k=>[S,k])))}function p(w,C){return Math.abs((w+C)%(2*C)-C)}function f(w,C){let M=URL.createObjectURL(C),S=document.createElement("a");S.href=M,S.download=w,S.click(),S.remove(),URL.revokeObjectURL(M)}function _(w,C){return Object.assign({},...C.map(M=>{if(w[M]!==void 0)return{[M]:w[M]}}))}function b(w){let C=0;for(let M of w)++C;return C}function y(w,C){let M=0;for(let S of w)S===C&&++M;return M}},"./src/utils/data-structures.js":(s,e,t)=>{t.r(e),t.d(e,{CharTrie:()=>i,DictionarySplitter:()=>l,LRUCache:()=>c,PriorityQueue:()=>n,TokenLattice:()=>o});class n{constructor(u=(p,f)=>p>f,h=1/0){this._heap=[],this._comparator=u,this._maxSize=h}get size(){return this._heap.length}isEmpty(){return this.size===0}peek(){return this._heap[0]}push(...u){return this.extend(u)}extend(u){for(let h of u)if(this.size<this._maxSize)this._heap.push(h),this._siftUp();else{let p=this._smallest();this._comparator(h,this._heap[p])&&(this._heap[p]=h,this._siftUpFrom(p))}return this.size}pop(){let u=this.peek(),h=this.size-1;return h>0&&this._swap(0,h),this._heap.pop(),this._siftDown(),u}replace(u){let h=this.peek();return this._heap[0]=u,this._siftDown(),h}_parent(u){return(u+1>>>1)-1}_left(u){return(u<<1)+1}_right(u){return u+1<<1}_greater(u,h){return this._comparator(this._heap[u],this._heap[h])}_swap(u,h){let p=this._heap[u];this._heap[u]=this._heap[h],this._heap[h]=p}_siftUp(){this._siftUpFrom(this.size-1)}_siftUpFrom(u){for(;u>0&&this._greater(u,this._parent(u));)this._swap(u,this._parent(u)),u=this._parent(u)}_siftDown(){let u=0;for(;this._left(u)<this.size&&this._greater(this._left(u),u)||this._right(u)<this.size&&this._greater(this._right(u),u);){let h=this._right(u)<this.size&&this._greater(this._right(u),this._left(u))?this._right(u):this._left(u);this._swap(u,h),u=h}}_smallest(){return 2**Math.floor(Math.log2(this.size))-1}}class i{constructor(){this.root=r.default()}extend(u){for(let h of u)this.push(h)}push(u){let h=this.root;for(let p of u){let f=h.children.get(p);f===void 0&&(f=r.default(),h.children.set(p,f)),h=f}h.isLeaf=!0}*commonPrefixSearch(u){let h=this.root;if(h===void 0)return;let p="";for(let f of u){if(p+=f,h=h.children.get(f),h===void 0)return;h.isLeaf&&(yield p)}}}class r{constructor(u,h){this.isLeaf=u,this.children=h}static default(){return new r(!1,new Map)}}class o{constructor(u,h,p){this.chars=Array.from(u),this.len=this.chars.length,this.bosTokenId=h,this.eosTokenId=p,this.nodes=[],this.beginNodes=Array.from({length:this.len+1},()=>[]),this.endNodes=Array.from({length:this.len+1},()=>[]);let f=new a(this.bosTokenId,0,0,0,0),_=new a(this.eosTokenId,1,this.len,0,0);this.nodes.push(f.clone()),this.nodes.push(_.clone()),this.beginNodes[this.len].push(_),this.endNodes[0].push(f)}insert(u,h,p,f){let _=this.nodes.length,b=new a(f,_,u,h,p);this.beginNodes[u].push(b),this.endNodes[u+h].push(b),this.nodes.push(b)}viterbi(){let u=this.len,h=0;for(;h<=u;){if(this.beginNodes[h].length==0)return[];for(let y of this.beginNodes[h]){y.prev=null;let w=0,C=null;for(let M of this.endNodes[h]){let S=M.backtraceScore+y.score;(C===null||S>w)&&(C=M.clone(),w=S)}if(C!==null)y.prev=C,y.backtraceScore=w;else return[]}++h}let p=[],_=this.beginNodes[u][0].prev;if(_===null)return[];let b=_.clone();for(;b.prev!==null;)p.push(b.clone()),b=b.clone().prev.clone();return p.reverse(),p}piece(u){return this.chars.slice(u.pos,u.pos+u.length).join("")}tokens(){return this.viterbi().map(h=>this.piece(h))}tokenIds(){return this.viterbi().map(h=>h.tokenId)}}class a{constructor(u,h,p,f,_){this.tokenId=u,this.nodeId=h,this.pos=p,this.length=f,this.score=_,this.prev=null,this.backtraceScore=0}clone(){let u=new a(this.tokenId,this.nodeId,this.pos,this.length,this.score);return u.prev=this.prev,u.backtraceScore=this.backtraceScore,u}}class l{constructor(u){this.trie=this._buildTrie(u)}_buildTrie(u){var p;let h=Object.create(null);for(let f of u){let _=h;for(let b=0;b<f.length;++b)_=_[p=f[b]]??(_[p]=Object.create(null));_.end=f}return h}split(u){let h=[],p=u.length,f=0,_=0;for(;_<p;){let b=this.trie,y=null,w=_;for(;w<p&&(b=b[u[w]]);)b.end&&(y=b.end),++w;y?(_>f&&h.push(u.slice(f,_)),h.push(y),_+=y.length,f=_):++_}return f<p&&h.push(u.slice(f)),h}}class c{constructor(u){this.capacity=u,this.cache=new Map}get(u){if(!this.cache.has(u))return;let h=this.cache.get(u);return this.cache.delete(u),this.cache.set(u,h),h}put(u,h){this.cache.has(u)&&this.cache.delete(u),this.cache.set(u,h),this.cache.size>this.capacity&&this.cache.delete(this.cache.keys().next().value)}clear(){this.cache.clear()}}},"./src/utils/devices.js":(s,e,t)=>{t.r(e),t.d(e,{DEVICE_TYPES:()=>n});let n=Object.freeze({auto:"auto",gpu:"gpu",cpu:"cpu",wasm:"wasm",webgpu:"webgpu",cuda:"cuda",dml:"dml",webnn:"webnn","webnn-npu":"webnn-npu","webnn-gpu":"webnn-gpu","webnn-cpu":"webnn-cpu"})},"./src/utils/dtypes.js":(s,e,t)=>{t.r(e),t.d(e,{DATA_TYPES:()=>o,DEFAULT_DEVICE_DTYPE_MAPPING:()=>a,DEFAULT_DTYPE_SUFFIX_MAPPING:()=>l,isWebGpuFp16Supported:()=>r});var n=t("./src/env.js"),i=t("./src/utils/devices.js");let r=function(){let c;return async function(){if(c===void 0)if(!n.apis.IS_WEBGPU_AVAILABLE)c=!1;else try{c=(await navigator.gpu.requestAdapter()).features.has("shader-f16")}catch{c=!1}return c}}(),o=Object.freeze({auto:"auto",fp32:"fp32",fp16:"fp16",q8:"q8",int8:"int8",uint8:"uint8",q4:"q4",bnb4:"bnb4",q4f16:"q4f16"}),a=Object.freeze({[i.DEVICE_TYPES.wasm]:o.q8}),l=Object.freeze({[o.fp32]:"",[o.fp16]:"_fp16",[o.int8]:"_int8",[o.uint8]:"_uint8",[o.q8]:"_quantized",[o.q4]:"_q4",[o.q4f16]:"_q4f16",[o.bnb4]:"_bnb4"})},"./src/utils/generic.js":(s,e,t)=>{t.r(e),t.d(e,{Callable:()=>n});let n=class{constructor(){let i=function(...r){return i._call(...r)};return Object.setPrototypeOf(i,new.target.prototype)}_call(...i){throw Error("Must implement _call method in subclass")}}},"./src/utils/hub.js":(s,e,t)=>{t.r(e),t.d(e,{MAX_EXTERNAL_DATA_CHUNKS:()=>a,getFile:()=>p,getModelFile:()=>w,getModelJSON:()=>M,getModelText:()=>C});var n=t("?7992"),i=t("?5af5"),r=t("./src/env.js"),o=t("./src/utils/core.js");let a=100,l={txt:"text/plain",html:"text/html",css:"text/css",js:"text/javascript",json:"application/json",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif"};class c{constructor(P){if(this.filePath=P,this.headers=new Headers,this.exists=n.existsSync(P),this.exists){this.status=200,this.statusText="OK";let R=n.statSync(P);this.headers.set("content-length",R.size.toString()),this.updateContentType();let O=n.createReadStream(P);this.body=new ReadableStream({start(H){O.on("data",X=>H.enqueue(X)),O.on("end",()=>H.close()),O.on("error",X=>H.error(X))},cancel(){O.destroy()}})}else this.status=404,this.statusText="Not Found",this.body=null}updateContentType(){let P=this.filePath.toString().split(".").pop().toLowerCase();this.headers.set("content-type",l[P]??"application/octet-stream")}clone(){let P=new c(this.filePath);return P.exists=this.exists,P.status=this.status,P.statusText=this.statusText,P.headers=new Headers(this.headers),P}async arrayBuffer(){return(await n.promises.readFile(this.filePath)).buffer}async blob(){let P=await n.promises.readFile(this.filePath);return new Blob([P],{type:this.headers.get("content-type")})}async text(){return await n.promises.readFile(this.filePath,"utf8")}async json(){return JSON.parse(await this.text())}}function d(T,P=null,R=null){let O;try{O=new URL(T)}catch{return!1}return!(P&&!P.includes(O.protocol)||R&&!R.includes(O.hostname))}let u=/^(\b[\w\-.]+\b\/)?\b[\w\-.]{1,96}\b$/;function h(T){return!(!u.test(T)||T.includes("..")||T.includes("--")||T.endsWith(".git")||T.endsWith(".ipynb"))}async function p(T){if(r.env.useFS&&!d(T,["http:","https:","blob:"]))return new c(T instanceof URL?T.protocol==="file:"?T.pathname:T.toString():T);if(typeof process<"u"&&process?.release?.name==="node"){let P=!!process.env?.TESTING_REMOTELY,R=r.env.version,O=new Headers;if(O.set("User-Agent",`transformers.js/${R}; is_ci/${P};`),d(T,["http:","https:"],["huggingface.co","hf.co"])){let X=process.env?.HF_TOKEN??process.env?.HF_ACCESS_TOKEN;X&&O.set("Authorization",`Bearer ${X}`)}return fetch(T,{headers:O})}else return fetch(T)}let f={400:"Bad request error occurred while trying to load file",401:"Unauthorized access to file",403:"Forbidden access to file",404:"Could not locate file",408:"Request timeout error occurred while trying to load file",500:"Internal server error error occurred while trying to load file",502:"Bad gateway error occurred while trying to load file",503:"Service unavailable error occurred while trying to load file",504:"Gateway timeout error occurred while trying to load file"};function _(T,P,R){if(!R)return null;let O=f[T]??`Error (${T}) occurred while trying to load file`;throw Error(`${O}: "${P}".`)}class b{constructor(P){this.path=P}async match(P){let R=i.join(this.path,P),O=new c(R);if(O.exists)return O}async put(P,R,O=void 0){let H=i.join(this.path,P);try{let X=R.headers.get("Content-Length"),z=parseInt(X??"0"),ne=0;await n.promises.mkdir(i.dirname(H),{recursive:!0});let re=n.createWriteStream(H),Y=R.body.getReader();for(;;){let{done:se,value:ue}=await Y.read();if(se)break;await new Promise((Pe,oe)=>{re.write(ue,te=>{if(te){oe(te);return}Pe()})}),ne+=ue.length;let fe=z?ne/z*100:0;O?.({progress:fe,loaded:ne,total:z})}re.close()}catch(X){try{await n.promises.unlink(H)}catch{}throw X}}}async function y(T,...P){for(let R of P)try{let O=await T.match(R);if(O)return O}catch{continue}}async function w(T,P,R=!0,O={},H=!1){if(!r.env.allowLocalModels){if(O.local_files_only)throw Error("Invalid configuration detected: local models are disabled (`env.allowLocalModels=false`) but you have requested to only use local models (`local_files_only=true`).");if(!r.env.allowRemoteModels)throw Error("Invalid configuration detected: both local and remote models are disabled. Fix by setting `env.allowLocalModels` or `env.allowRemoteModels` to `true`.")}(0,o.dispatchCallback)(O.progress_callback,{status:"initiate",name:T,file:P});let X;if(!X&&r.env.useCustomCache){if(!r.env.customCache)throw Error("`env.useCustomCache=true`, but `env.customCache` is not defined.");if(!r.env.customCache.match||!r.env.customCache.put)throw new Error("`env.customCache` must be an object which implements the `match` and `put` functions of the Web Cache API. For more information, see https://developer.mozilla.org/en-US/docs/Web/API/Cache");X=r.env.customCache}if(!X&&r.env.useBrowserCache){if(typeof caches>"u")throw Error("Browser cache is not available in this environment.");try{X=await caches.open("transformers-cache")}catch(de){console.warn("An error occurred while opening the browser cache:",de)}}if(!X&&r.env.useFSCache){if(!r.apis.IS_FS_AVAILABLE)throw Error("File System Cache is not available in this environment.");X=new b(O.cache_dir??r.env.cacheDir)}let z=O.revision??"main",ne=k(T,P),re=h(T),Y=re?k(r.env.localModelPath,ne):ne,se=k(r.env.remoteHost,r.env.remotePathTemplate.replaceAll("{model}",T).replaceAll("{revision}",encodeURIComponent(z)),P),ue,fe=X instanceof b?z==="main"?ne:k(T,z,P):se,Pe=!1,oe;X&&(oe=await y(X,Y,fe));let te=oe!==void 0;if(oe===void 0){if(r.env.allowLocalModels)if(d(ne,["http:","https:"])){if(O.local_files_only)throw new Error(`\`local_files_only=true\`, but attempted to load a remote file from: ${ne}.`);if(!r.env.allowRemoteModels)throw new Error(`\`env.allowRemoteModels=false\`, but attempted to load a remote file from: ${ne}.`)}else try{oe=await p(Y),ue=Y}catch(be){console.warn(`Unable to load from local path "${Y}": "${be}"`)}if(oe===void 0||oe.status===404){if(O.local_files_only||!r.env.allowRemoteModels){if(R)throw Error(`\`local_files_only=true\` or \`env.allowRemoteModels=false\` and file was not found locally at "${Y}".`);return null}if(!re)throw Error(`Local file missing at "${Y}" and download aborted due to invalid model ID "${T}".`);if(oe=await p(se),oe.status!==200)return _(oe.status,se,R);ue=fe}Pe=X&&typeof Response<"u"&&oe instanceof Response&&oe.status===200}(0,o.dispatchCallback)(O.progress_callback,{status:"download",name:T,file:P});let j;if(!(r.apis.IS_NODE_ENV&&H)){let de;O.progress_callback?te&&typeof navigator<"u"&&/firefox/i.test(navigator.userAgent)?(de=new Uint8Array(await oe.arrayBuffer()),(0,o.dispatchCallback)(O.progress_callback,{status:"progress",name:T,file:P,progress:100,loaded:de.length,total:de.length})):de=await S(oe,be=>{(0,o.dispatchCallback)(O.progress_callback,{status:"progress",name:T,file:P,...be})}):de=new Uint8Array(await oe.arrayBuffer()),j=de}if(Pe&&ue&&await X.match(ue)===void 0)if(j)await X.put(ue,new Response(j,{headers:oe.headers})).catch(de=>{console.warn(`Unable to add response to browser cache: ${de}.`)});else{let de=O.progress_callback?be=>(0,o.dispatchCallback)(O.progress_callback,{status:"progress",name:T,file:P,...be}):void 0;await X.put(ue,oe,de)}if((0,o.dispatchCallback)(O.progress_callback,{status:"done",name:T,file:P}),j){if(!r.apis.IS_NODE_ENV&&H)throw new Error("Cannot return path in a browser environment.");return j}if(oe instanceof c)return oe.filePath;let G=await X?.match(ue);if(G instanceof c)return G.filePath;if(G instanceof Response)return new Uint8Array(await G.arrayBuffer());if(typeof G=="string")return G;throw new Error("Unable to get model file path or buffer.")}async function C(T,P,R=!0,O={}){let H=await w(T,P,R,O,!1);return H===null?null:new TextDecoder("utf-8").decode(H)}async function M(T,P,R=!0,O={}){let H=await C(T,P,R,O);return H===null?{}:JSON.parse(H)}async function S(T,P){let R=T.headers.get("Content-Length");R===null&&console.warn("Unable to determine content-length from response headers. Will expand buffer when needed.");let O=parseInt(R??"0"),H=new Uint8Array(O),X=0,z=T.body.getReader();async function ne(){let{done:re,value:Y}=await z.read();if(re)return;let se=X+Y.length;if(se>O){O=se;let fe=new Uint8Array(O);fe.set(H),H=fe}H.set(Y,X),X=se;let ue=X/O*100;return P({progress:ue,loaded:X,total:O}),ne()}return await ne(),H}function k(...T){return T=T.map((P,R)=>(R&&(P=P.replace(new RegExp("^/"),"")),R!==T.length-1&&(P=P.replace(new RegExp("/$"),"")),P)),T.join("/")}},"./src/utils/image.js":(s,e,t)=>{t.r(e),t.d(e,{RawImage:()=>f,load_image:()=>_});var n=t("./src/utils/core.js"),i=t("./src/utils/hub.js"),r=t("./src/env.js"),o=t("./src/utils/tensor.js"),a=t("?2b25");let l,c,d,u=r.apis.IS_BROWSER_ENV||r.apis.IS_WEBWORKER_ENV;if(u)l=(b,y)=>{if(!self.OffscreenCanvas)throw new Error("OffscreenCanvas not supported by this browser.");return new self.OffscreenCanvas(b,y)},d=self.createImageBitmap,c=self.ImageData;else if(a)d=async b=>{let w=(await b.metadata()).channels,{data:C,info:M}=await b.rotate().raw().toBuffer({resolveWithObject:!0}),S=new f(new Uint8ClampedArray(C),M.width,M.height,M.channels);return w!==void 0&&w!==M.channels&&S.convert(w),S};else throw new Error("Unable to load image processing library.");let h={0:"nearest",1:"lanczos",2:"bilinear",3:"bicubic",4:"box",5:"hamming"},p=new Map([["png","image/png"],["jpg","image/jpeg"],["jpeg","image/jpeg"],["gif","image/gif"]]);class f{constructor(y,w,C,M){this.data=y,this.width=w,this.height=C,this.channels=M}get size(){return[this.width,this.height]}static async read(y){if(y instanceof f)return y;if(typeof y=="string"||y instanceof URL)return await this.fromURL(y);if(y instanceof Blob)return await this.fromBlob(y);if(typeof HTMLCanvasElement<"u"&&y instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&y instanceof OffscreenCanvas)return this.fromCanvas(y);throw new Error(`Unsupported input type: ${typeof y}`)}static fromCanvas(y){if(!u)throw new Error("fromCanvas() is only supported in browser environments.");let C=y.getContext("2d").getImageData(0,0,y.width,y.height).data;return new f(C,y.width,y.height,4)}static async fromURL(y){let w=await(0,i.getFile)(y);if(w.status!==200)throw new Error(`Unable to read image from "${y}" (${w.status} ${w.statusText})`);let C=await w.blob();return this.fromBlob(C)}static async fromBlob(y){if(u){let w=await d(y),C=l(w.width,w.height).getContext("2d");return C.drawImage(w,0,0),new this(C.getImageData(0,0,w.width,w.height).data,w.width,w.height,4)}else{let w=a(await y.arrayBuffer());return await d(w)}}static fromTensor(y,w="CHW"){if(y.dims.length!==3)throw new Error(`Tensor should have 3 dimensions, but has ${y.dims.length} dimensions.`);if(w==="CHW")y=y.transpose(1,2,0);else if(w!=="HWC")throw new Error(`Unsupported channel format: ${w}`);if(!(y.data instanceof Uint8ClampedArray||y.data instanceof Uint8Array))throw new Error(`Unsupported tensor type: ${y.type}`);switch(y.dims[2]){case 1:case 2:case 3:case 4:return new f(y.data,y.dims[1],y.dims[0],y.dims[2]);default:throw new Error(`Unsupported number of channels: ${y.dims[2]}`)}}grayscale(){if(this.channels===1)return this;let y=new Uint8ClampedArray(this.width*this.height*1);switch(this.channels){case 3:case 4:for(let w=0,C=0;w<this.data.length;w+=this.channels){let M=this.data[w],S=this.data[w+1],k=this.data[w+2];y[C++]=Math.round(.2989*M+.587*S+.114*k)}break;default:throw new Error(`Conversion failed due to unsupported number of channels: ${this.channels}`)}return this._update(y,this.width,this.height,1)}rgb(){if(this.channels===3)return this;let y=new Uint8ClampedArray(this.width*this.height*3);switch(this.channels){case 1:for(let w=0,C=0;w<this.data.length;++w)y[C++]=this.data[w],y[C++]=this.data[w],y[C++]=this.data[w];break;case 4:for(let w=0,C=0;w<this.data.length;w+=4)y[C++]=this.data[w],y[C++]=this.data[w+1],y[C++]=this.data[w+2];break;default:throw new Error(`Conversion failed due to unsupported number of channels: ${this.channels}`)}return this._update(y,this.width,this.height,3)}rgba(){if(this.channels===4)return this;let y=new Uint8ClampedArray(this.width*this.height*4);switch(this.channels){case 1:for(let w=0,C=0;w<this.data.length;++w)y[C++]=this.data[w],y[C++]=this.data[w],y[C++]=this.data[w],y[C++]=255;break;case 3:for(let w=0,C=0;w<this.data.length;w+=3)y[C++]=this.data[w],y[C++]=this.data[w+1],y[C++]=this.data[w+2],y[C++]=255;break;default:throw new Error(`Conversion failed due to unsupported number of channels: ${this.channels}`)}return this._update(y,this.width,this.height,4)}putAlpha(y){if(y.width!==this.width||y.height!==this.height)throw new Error(`Expected mask size to be ${this.width}x${this.height}, but got ${y.width}x${y.height}`);if(y.channels!==1)throw new Error(`Expected mask to have 1 channel, but got ${y.channels}`);let w=this.data,C=y.data,M=this.width*this.height;if(this.channels===3){let S=new Uint8ClampedArray(M*4);for(let k=0,T=0,P=0;k<M;++k)S[P++]=w[T++],S[P++]=w[T++],S[P++]=w[T++],S[P++]=C[k];return this._update(S,this.width,this.height,4)}else if(this.channels===4){for(let S=0;S<M;++S)w[4*S+3]=C[S];return this}throw new Error(`Expected image to have 3 or 4 channels, but got ${this.channels}`)}async resize(y,w,{resample:C=2}={}){if(this.width===y&&this.height===w)return this;let M=h[C]??C,S=(0,n.isNullishDimension)(y),k=(0,n.isNullishDimension)(w);if(S&&k)return this;if(S?y=w/this.height*this.width:k&&(w=y/this.width*this.height),u){let T=this.channels,P=this.toCanvas(),R=l(y,w).getContext("2d");return R.drawImage(P,0,0,y,w),new f(R.getImageData(0,0,y,w).data,y,w,4).convert(T)}else{let T=this.toSharp();switch(M){case"box":case"hamming":(M==="box"||M==="hamming")&&(console.warn(`Resampling method ${M} is not yet supported. Using bilinear instead.`),M="bilinear");case"nearest":case"bilinear":case"bicubic":T=T.affine([y/this.width,0,0,w/this.height],{interpolator:M});break;case"lanczos":T=T.resize({width:y,height:w,fit:"fill",kernel:"lanczos3"});break;default:throw new Error(`Resampling method ${M} is not supported.`)}return await d(T)}}async pad([y,w,C,M]){if(y=Math.max(y,0),w=Math.max(w,0),C=Math.max(C,0),M=Math.max(M,0),y===0&&w===0&&C===0&&M===0)return this;if(u){let S=this.channels,k=this.toCanvas(),T=this.width+y+w,P=this.height+C+M,R=l(T,P).getContext("2d");return R.drawImage(k,0,0,this.width,this.height,y,C,this.width,this.height),new f(R.getImageData(0,0,T,P).data,T,P,4).convert(S)}else{let S=this.toSharp().extend({left:y,right:w,top:C,bottom:M});return await d(S)}}async crop([y,w,C,M]){if(y=Math.max(y,0),w=Math.max(w,0),C=Math.min(C,this.width-1),M=Math.min(M,this.height-1),y===0&&w===0&&C===this.width-1&&M===this.height-1)return this;let S=C-y+1,k=M-w+1;if(u){let T=this.channels,P=this.toCanvas(),R=l(S,k).getContext("2d");return R.drawImage(P,y,w,S,k,0,0,S,k),new f(R.getImageData(0,0,S,k).data,S,k,4).convert(T)}else{let T=this.toSharp().extract({left:y,top:w,width:S,height:k});return await d(T)}}async center_crop(y,w){if(this.width===y&&this.height===w)return this;let C=(this.width-y)/2,M=(this.height-w)/2;if(u){let S=this.channels,k=this.toCanvas(),T=l(y,w).getContext("2d"),P=0,R=0,O=0,H=0;return C>=0?P=C:O=-C,M>=0?R=M:H=-M,T.drawImage(k,P,R,y,w,O,H,y,w),new f(T.getImageData(0,0,y,w).data,y,w,4).convert(S)}else{let S=this.toSharp();if(C>=0&&M>=0)S=S.extract({left:Math.floor(C),top:Math.floor(M),width:y,height:w});else if(C<=0&&M<=0){let k=Math.floor(-M),T=Math.floor(-C);S=S.extend({top:k,left:T,right:y-this.width-T,bottom:w-this.height-k})}else{let k=[0,0],T=0;M<0?(k[0]=Math.floor(-M),k[1]=w-this.height-k[0]):T=Math.floor(M);let P=[0,0],R=0;C<0?(P[0]=Math.floor(-C),P[1]=y-this.width-P[0]):R=Math.floor(C),S=S.extend({top:k[0],bottom:k[1],left:P[0],right:P[1]}).extract({left:R,top:T,width:y,height:w})}return await d(S)}}async toBlob(y="image/png",w=1){if(!u)throw new Error("toBlob() is only supported in browser environments.");return await this.toCanvas().convertToBlob({type:y,quality:w})}toTensor(y="CHW"){let w=new o.Tensor("uint8",new Uint8Array(this.data),[this.height,this.width,this.channels]);if(y!=="HWC")if(y==="CHW")w=w.permute(2,0,1);else throw new Error(`Unsupported channel format: ${y}`);return w}toCanvas(){if(!u)throw new Error("toCanvas() is only supported in browser environments.");let y=this.clone().rgba(),w=l(y.width,y.height),C=new c(y.data,y.width,y.height);return w.getContext("2d").putImageData(C,0,0),w}split(){let{data:y,width:w,height:C,channels:M}=this,S=y.constructor,k=y.length/M,T=Array.from({length:M},()=>new S(k));for(let P=0;P<k;++P){let R=M*P;for(let O=0;O<M;++O)T[O][P]=y[R+O]}return T.map(P=>new f(P,w,C,1))}_update(y,w,C,M=null){return this.data=y,this.width=w,this.height=C,M!==null&&(this.channels=M),this}clone(){return new f(this.data.slice(),this.width,this.height,this.channels)}convert(y){if(this.channels===y)return this;switch(y){case 1:this.grayscale();break;case 3:this.rgb();break;case 4:this.rgba();break;default:throw new Error(`Conversion failed due to unsupported number of channels: ${this.channels}`)}return this}async save(y){if(u){if(r.apis.IS_WEBWORKER_ENV)throw new Error("Unable to save an image from a Web Worker.");let w=y.split(".").pop().toLowerCase(),C=p.get(w)??"image/png",M=await this.toBlob(C);(0,n.saveBlob)(y,M)}else{if(r.apis.IS_FS_AVAILABLE)return await this.toSharp().toFile(y);throw new Error("Unable to save the image because filesystem is disabled in this environment.")}}toSharp(){if(u)throw new Error("toSharp() is only supported in server-side environments.");return a(this.data,{raw:{width:this.width,height:this.height,channels:this.channels}})}}let _=f.read.bind(f)},"./src/utils/maths.js":(s,e,t)=>{t.r(e),t.d(e,{FFT:()=>_,bankers_round:()=>w,cos_sim:()=>l,dot:()=>a,dynamic_time_warping:()=>C,interpolate_data:()=>n,log_softmax:()=>o,magnitude:()=>c,max:()=>u,medianFilter:()=>b,min:()=>d,permute_data:()=>i,round:()=>y,softmax:()=>r});function n(M,[S,k,T],[P,R],O="bilinear",H=!1){let X=R/T,z=P/k,ne=new M.constructor(P*R*S),re=k*T,Y=P*R;for(let se=0;se<P;++se)for(let ue=0;ue<R;++ue){let fe=se*R+ue,Pe=(ue+.5)/X-.5,oe=(se+.5)/z-.5,te=Math.floor(Pe),j=Math.floor(oe),G=Math.min(te+1,T-1),de=Math.min(j+1,k-1);te=Math.max(te,0),j=Math.max(j,0);let be=Pe-te,xe=oe-j,Oe=(1-be)*(1-xe),je=be*(1-xe),dt=(1-be)*xe,Re=be*xe,U=j*T,pe=de*T,Ce=U+te,Fe=U+G,Ve=pe+te,De=pe+G;for(let Ee=0;Ee<S;++Ee){let ze=Ee*re;ne[Ee*Y+fe]=Oe*M[ze+Ce]+je*M[ze+Fe]+dt*M[ze+Ve]+Re*M[ze+De]}}return ne}function i(M,S,k){let T=new Array(k.length),P=new Array(k.length);for(let H=k.length-1,X=1;H>=0;--H)P[H]=X,T[H]=S[k[H]],X*=T[H];let R=k.map((H,X)=>P[k.indexOf(X)]),O=new M.constructor(M.length);for(let H=0;H<M.length;++H){let X=0;for(let z=S.length-1,ne=H;z>=0;--z)X+=ne%S[z]*R[z],ne=Math.floor(ne/S[z]);O[X]=M[H]}return[O,T]}function r(M){let S=u(M)[0],k=M.map(R=>Math.exp(R-S)),T=k.reduce((R,O)=>R+O,0);return k.map(R=>R/T)}function o(M){let S=u(M)[0],k=0;for(let R=0;R<M.length;++R)k+=Math.exp(M[R]-S);let T=Math.log(k);return M.map(R=>R-S-T)}function a(M,S){let k=0;for(let T=0;T<M.length;++T)k+=M[T]*S[T];return k}function l(M,S){let k=a(M,S),T=c(M),P=c(S);return k/(T*P)}function c(M){return Math.sqrt(M.reduce((S,k)=>S+k*k,0))}function d(M){if(M.length===0)throw Error("Array must not be empty");let S=M[0],k=0;for(let T=1;T<M.length;++T)M[T]<S&&(S=M[T],k=T);return[S,k]}function u(M){if(M.length===0)throw Error("Array must not be empty");let S=M[0],k=0;for(let T=1;T<M.length;++T)M[T]>S&&(S=M[T],k=T);return[S,k]}function h(M){return M>0&&(M&M-1)===0}class p{constructor(S){if(this.size=S|0,this.size<=1||!h(this.size))throw new Error("FFT size must be a power of two larger than 1");this._csize=S<<1,this.table=new Float64Array(this.size*2);for(let T=0;T<this.table.length;T+=2){let P=Math.PI*T/this.size;this.table[T]=Math.cos(P),this.table[T+1]=-Math.sin(P)}let k=0;for(let T=1;this.size>T;T<<=1)++k;this._width=k%2===0?k-1:k,this._bitrev=new Int32Array(1<<this._width);for(let T=0;T<this._bitrev.length;++T){this._bitrev[T]=0;for(let P=0;P<this._width;P+=2){let R=this._width-P-2;this._bitrev[T]|=(T>>>P&3)<<R}}}createComplexArray(){return new Float64Array(this._csize)}fromComplexArray(S,k){let T=k||new Array(S.length>>>1);for(let P=0;P<S.length;P+=2)T[P>>>1]=S[P];return T}toComplexArray(S,k){let T=k||this.createComplexArray();for(let P=0;P<T.length;P+=2)T[P]=S[P>>>1],T[P+1]=0;return T}transform(S,k){if(S===k)throw new Error("Input and output buffers must be different");this._transform4(S,k,1)}realTransform(S,k){if(S===k)throw new Error("Input and output buffers must be different");this._realTransform4(S,k,1)}inverseTransform(S,k){if(S===k)throw new Error("Input and output buffers must be different");this._transform4(S,k,-1);for(let T=0;T<S.length;++T)S[T]/=this.size}_transform4(S,k,T){let P=this._csize,O=1<<this._width,H=P/O<<1,X,z,ne=this._bitrev;if(H===4)for(X=0,z=0;X<P;X+=H,++z){let Y=ne[z];this._singleTransform2(k,S,X,Y,O)}else for(X=0,z=0;X<P;X+=H,++z){let Y=ne[z];this._singleTransform4(k,S,X,Y,O,T)}let re=this.table;for(O>>=2;O>=2;O>>=2){H=P/O<<1;let Y=H>>>2;for(X=0;X<P;X+=H){let se=X+Y-1;for(let ue=X,fe=0;ue<se;ue+=2,fe+=O){let Pe=ue,oe=Pe+Y,te=oe+Y,j=te+Y,G=S[Pe],de=S[Pe+1],be=S[oe],xe=S[oe+1],Oe=S[te],je=S[te+1],dt=S[j],Re=S[j+1],U=re[fe],pe=T*re[fe+1],Ce=be*U-xe*pe,Fe=be*pe+xe*U,Ve=re[2*fe],De=T*re[2*fe+1],Ee=Oe*Ve-je*De,ze=Oe*De+je*Ve,Se=re[3*fe],$e=T*re[3*fe+1],et=dt*Se-Re*$e,Ge=dt*$e+Re*Se,Ye=G+Ee,Xe=de+ze,gt=G-Ee,We=de-ze,at=Ce+et,Qe=Fe+Ge,Pt=T*(Ce-et),st=T*(Fe-Ge);S[Pe]=Ye+at,S[Pe+1]=Xe+Qe,S[oe]=gt+st,S[oe+1]=We-Pt,S[te]=Ye-at,S[te+1]=Xe-Qe,S[j]=gt-st,S[j+1]=We+Pt}}}}_singleTransform2(S,k,T,P,R){let O=S[P],H=S[P+1],X=S[P+R],z=S[P+R+1];k[T]=O+X,k[T+1]=H+z,k[T+2]=O-X,k[T+3]=H-z}_singleTransform4(S,k,T,P,R,O){let H=R*2,X=R*3,z=S[P],ne=S[P+1],re=S[P+R],Y=S[P+R+1],se=S[P+H],ue=S[P+H+1],fe=S[P+X],Pe=S[P+X+1],oe=z+se,te=ne+ue,j=z-se,G=ne-ue,de=re+fe,be=Y+Pe,xe=O*(re-fe),Oe=O*(Y-Pe);k[T]=oe+de,k[T+1]=te+be,k[T+2]=j+Oe,k[T+3]=G-xe,k[T+4]=oe-de,k[T+5]=te-be,k[T+6]=j-Oe,k[T+7]=G+xe}_realTransform4(S,k,T){let P=this._csize,O=1<<this._width,H=P/O<<1,X,z,ne=this._bitrev;if(H===4)for(X=0,z=0;X<P;X+=H,++z){let se=ne[z];this._singleRealTransform2(k,S,X,se>>>1,O>>>1)}else for(X=0,z=0;X<P;X+=H,++z){let se=ne[z];this._singleRealTransform4(k,S,X,se>>>1,O>>>1,T)}let re=this.table;for(O>>=2;O>=2;O>>=2){H=P/O<<1;let se=H>>>1,ue=se>>>1,fe=ue>>>1;for(X=0;X<P;X+=H)for(let Pe=0,oe=0;Pe<=fe;Pe+=2,oe+=O){let te=X+Pe,j=te+ue,G=j+ue,de=G+ue,be=S[te],xe=S[te+1],Oe=S[j],je=S[j+1],dt=S[G],Re=S[G+1],U=S[de],pe=S[de+1],Ce=be,Fe=xe,Ve=re[oe],De=T*re[oe+1],Ee=Oe*Ve-je*De,ze=Oe*De+je*Ve,Se=re[2*oe],$e=T*re[2*oe+1],et=dt*Se-Re*$e,Ge=dt*$e+Re*Se,Ye=re[3*oe],Xe=T*re[3*oe+1],gt=U*Ye-pe*Xe,We=U*Xe+pe*Ye,at=Ce+et,Qe=Fe+Ge,Pt=Ce-et,st=Fe-Ge,zt=Ee+gt,rn=ze+We,un=T*(Ee-gt),ds=T*(ze-We);if(S[te]=at+zt,S[te+1]=Qe+rn,S[j]=Pt+ds,S[j+1]=st-un,Pe===0){S[G]=at-zt,S[G+1]=Qe-rn;continue}if(Pe===fe)continue;let _n=X+ue-Pe,xs=X+se-Pe;S[_n]=Pt-T*ds,S[_n+1]=-st-T*un,S[xs]=at-T*zt,S[xs+1]=-Qe+T*rn}}let Y=P>>>1;for(let se=2;se<Y;se+=2)S[P-se]=S[se],S[P-se+1]=-S[se+1]}_singleRealTransform2(S,k,T,P,R){let O=S[P],H=S[P+R];k[T]=O+H,k[T+1]=0,k[T+2]=O-H,k[T+3]=0}_singleRealTransform4(S,k,T,P,R,O){let H=R*2,X=R*3,z=S[P],ne=S[P+R],re=S[P+H],Y=S[P+X],se=z+re,ue=z-re,fe=ne+Y,Pe=O*(ne-Y);k[T]=se+fe,k[T+1]=0,k[T+2]=ue,k[T+3]=-Pe,k[T+4]=se-fe,k[T+5]=0,k[T+6]=ue,k[T+7]=Pe}}class f{constructor(S){let k=2*(S-1),T=2*(2*S-1),P=2**Math.ceil(Math.log2(T));this.bufferSize=P,this._a=k;let R=new Float64Array(T),O=new Float64Array(P);this._chirpBuffer=new Float64Array(P),this._buffer1=new Float64Array(P),this._buffer2=new Float64Array(P),this._outBuffer1=new Float64Array(P),this._outBuffer2=new Float64Array(P);let H=-2*Math.PI/S,X=Math.cos(H),z=Math.sin(H);for(let ne=0;ne<T>>1;++ne){let re=(ne+1-S)**2/2,Y=Math.sqrt(X**2+z**2)**re,se=re*Math.atan2(z,X),ue=2*ne;R[ue]=Y*Math.cos(se),R[ue+1]=Y*Math.sin(se),O[ue]=R[ue],O[ue+1]=-R[ue+1]}this._slicedChirpBuffer=R.subarray(k,T),this._f=new p(P>>1),this._f.transform(this._chirpBuffer,O)}_transform(S,k,T){let P=this._buffer1,R=this._buffer2,O=this._outBuffer1,H=this._outBuffer2,X=this._chirpBuffer,z=this._slicedChirpBuffer,ne=this._a;if(T)for(let re=0;re<z.length;re+=2){let Y=re+1,se=re>>1,ue=k[se];P[re]=ue*z[re],P[Y]=ue*z[Y]}else for(let re=0;re<z.length;re+=2){let Y=re+1;P[re]=k[re]*z[re]-k[Y]*z[Y],P[Y]=k[re]*z[Y]+k[Y]*z[re]}this._f.transform(O,P);for(let re=0;re<X.length;re+=2){let Y=re+1;R[re]=O[re]*X[re]-O[Y]*X[Y],R[Y]=O[re]*X[Y]+O[Y]*X[re]}this._f.inverseTransform(H,R);for(let re=0;re<H.length;re+=2){let Y=H[re+ne],se=H[re+ne+1],ue=z[re],fe=z[re+1];S[re]=Y*ue-se*fe,S[re+1]=Y*fe+se*ue}}transform(S,k){this._transform(S,k,!1)}realTransform(S,k){this._transform(S,k,!0)}}class _{constructor(S){this.fft_length=S,this.isPowerOfTwo=h(S),this.isPowerOfTwo?(this.fft=new p(S),this.outputBufferSize=2*S):(this.fft=new f(S),this.outputBufferSize=this.fft.bufferSize)}realTransform(S,k){this.fft.realTransform(S,k)}transform(S,k){this.fft.transform(S,k)}}function b(M,S){if(S%2===0||S<=0)throw new Error("Window size must be a positive odd number");let k=new M.constructor(M.length),T=new M.constructor(S),P=Math.floor(S/2);for(let R=0;R<M.length;++R){let O=0;for(let H=-P;H<=P;++H){let X=R+H;X<0?X=Math.abs(X):X>=M.length&&(X=2*(M.length-1)-X),T[O++]=M[X]}T.sort(),k[R]=T[P]}return k}function y(M,S){let k=Math.pow(10,S);return Math.round(M*k)/k}function w(M){let S=Math.round(M);return Math.abs(M)%1===.5?S%2===0?S:S-1:S}function C(M){let S=M.length,k=M[0].length,T=[S+1,k+1],P=Array.from({length:T[0]},()=>Array(T[1]).fill(1/0));P[0][0]=0;let R=Array.from({length:T[0]},()=>Array(T[1]).fill(-1));for(let ne=1;ne<T[1];++ne)for(let re=1;re<T[0];++re){let Y=P[re-1][ne-1],se=P[re-1][ne],ue=P[re][ne-1],fe,Pe;Y<se&&Y<ue?(fe=Y,Pe=0):se<Y&&se<ue?(fe=se,Pe=1):(fe=ue,Pe=2),P[re][ne]=M[re-1][ne-1]+fe,R[re][ne]=Pe}for(let ne=0;ne<T[1];++ne)R[0][ne]=2;for(let ne=0;ne<T[0];++ne)R[ne][0]=1;let O=S,H=k,X=[],z=[];for(;O>0||H>0;)switch(X.push(O-1),z.push(H-1),R[O][H]){case 0:--O,--H;break;case 1:--O;break;case 2:--H;break;default:throw new Error(`Internal error in dynamic time warping. Unexpected trace[${O}, ${H}]. Please file a bug report.`)}return X.reverse(),z.reverse(),[X,z]}},"./src/utils/tensor.js":(s,e,t)=>{t.r(e),t.d(e,{DataTypeMap:()=>o,Tensor:()=>a,cat:()=>k,full:()=>z,full_like:()=>ne,interpolate:()=>d,interpolate_4d:()=>u,layer_norm:()=>w,matmul:()=>h,mean:()=>O,mean_pooling:()=>y,ones:()=>re,ones_like:()=>Y,permute:()=>c,quantize_embeddings:()=>oe,rand:()=>fe,randn:()=>Pe,rfft:()=>p,slice:()=>b,stack:()=>T,std_mean:()=>R,topk:()=>f,zeros:()=>se,zeros_like:()=>ue});var n=t("./src/utils/maths.js"),i=t("./src/backends/onnx.js"),r=t("./src/ops/registry.js");let o=Object.freeze({float32:Float32Array,float16:typeof Float16Array<"u"?Float16Array:Uint16Array,float64:Float64Array,string:Array,int8:Int8Array,uint8:Uint8Array,int16:Int16Array,uint16:Uint16Array,int32:Int32Array,uint32:Uint32Array,int64:BigInt64Array,uint64:BigUint64Array,bool:Uint8Array,uint4:Uint8Array,int4:Int8Array});class a{constructor(...j){Z(this,"ort_tensor");return(0,i.isONNXTensor)(j[0])?this.ort_tensor=j[0]:this.ort_tensor=new i.Tensor(j[0],j[1],j[2]),new Proxy(this,{get:(G,de)=>{if(typeof de=="string"){let be=Number(de);if(Number.isInteger(be))return G._getitem(be)}return G[de]},set:(G,de,be)=>G[de]=be})}get dims(){return this.ort_tensor.dims}set dims(j){this.ort_tensor.dims=j}get type(){return this.ort_tensor.type}get data(){return this.ort_tensor.data}get size(){return this.ort_tensor.size}get location(){return this.ort_tensor.location}dispose(){this.ort_tensor.dispose()}*[Symbol.iterator](){let[j,...G]=this.dims;if(G.length>0){let de=G.reduce((be,xe)=>be*xe);for(let be=0;be<j;++be)yield this._subarray(be,de,G)}else yield*this.data}_getitem(j){let[G,...de]=this.dims;if(j=S(j,G),de.length>0){let be=de.reduce((xe,Oe)=>xe*Oe);return this._subarray(j,be,de)}else return new a(this.type,[this.data[j]],de)}indexOf(j){let G=this.data;for(let de=0;de<G.length;++de)if(G[de]==j)return de;return-1}_subarray(j,G,de){let be=j*G,xe=(j+1)*G,Oe="subarray"in this.data?this.data.subarray(be,xe):this.data.slice(be,xe);return new a(this.type,Oe,de)}item(){let j=this.data;if(j.length!==1)throw new Error(`a Tensor with ${j.length} elements cannot be converted to Scalar`);return j[0]}tolist(){return l(this.data,this.dims)}sigmoid(){return this.clone().sigmoid_()}sigmoid_(){let j=this.data;for(let G=0;G<j.length;++G)j[G]=1/(1+Math.exp(-j[G]));return this}map(j){return this.clone().map_(j)}map_(j){let G=this.data;for(let de=0;de<G.length;++de)G[de]=j(G[de],de,G);return this}mul(j){return this.clone().mul_(j)}mul_(j){let G=this.data;for(let de=0;de<G.length;++de)G[de]*=j;return this}div(j){return this.clone().div_(j)}div_(j){let G=this.data;for(let de=0;de<G.length;++de)G[de]/=j;return this}add(j){return this.clone().add_(j)}add_(j){let G=this.data;for(let de=0;de<G.length;++de)G[de]+=j;return this}sub(j){return this.clone().sub_(j)}sub_(j){let G=this.data;for(let de=0;de<G.length;++de)G[de]-=j;return this}clone(){return new a(this.type,this.data.slice(),this.dims.slice())}slice(...j){let G=[],de=[];for(let U=0;U<this.dims.length;++U){let pe=j[U];if(pe==null)de.push([0,this.dims[U]]),G.push(this.dims[U]);else if(typeof pe=="number")pe=S(pe,this.dims[U],U),de.push([pe,pe+1]);else if(Array.isArray(pe)&&pe.length===2){let[Ce,Fe]=pe;if(Ce=Ce===null?0:S(Ce,this.dims[U],U,!1),Fe=Fe===null?this.dims[U]:S(Fe,this.dims[U],U,!1),Ce>Fe)throw new Error(`Invalid slice: ${pe}`);let Ve=[Math.max(Ce,0),Math.min(Fe,this.dims[U])];de.push(Ve),G.push(Ve[1]-Ve[0])}else throw new Error(`Invalid slice: ${pe}`)}let be=de.map(([U,pe])=>pe-U),xe=be.reduce((U,pe)=>U*pe),Oe=this.data,je=new Oe.constructor(xe),dt=this.stride(),Re=!0;for(let U=1;U<be.length;++U)if(de[U][0]!==0||de[U][1]!==this.dims[U]){Re=!1;break}if(Re){let U=de[0][0]*dt[0],pe=de[0][1]*dt[0];if(ArrayBuffer.isView(Oe))je.set(Oe.subarray(U,pe));else if(Array.isArray(Oe)){let Ce=Oe.slice(U,pe);for(let Fe=0;Fe<Ce.length;++Fe)je[Fe]=Ce[Fe]}else throw new Error("Unsupported data type for slicing")}else for(let U=0;U<xe;++U){let pe=0;for(let Ce=be.length-1,Fe=U;Ce>=0;--Ce){let Ve=be[Ce];pe+=(Fe%Ve+de[Ce][0])*dt[Ce],Fe=Math.floor(Fe/Ve)}je[U]=Oe[pe]}return new a(this.type,je,G)}permute(...j){return c(this,j)}transpose(...j){return this.permute(...j)}sum(j=null,G=!1){return this.norm(1,j,G)}norm(j="fro",G=null,de=!1){if(j==="fro")j=2;else if(typeof j=="string")throw Error(`Unsupported norm: ${j}`);let be=this.data,xe=(Re,U)=>Re+U**j;if(G===null){let Re=be.reduce(xe,0)**(1/j);return new a(this.type,[Re],[])}let[Oe,je,dt]=P(xe,this,G,de);if(j!==1)for(let Re=0;Re<je.length;++Re)je[Re]=je[Re]**(1/j);return new a(Oe,je,dt)}normalize_(j=2,G=1){G=S(G,this.dims.length);let de=this.norm(j,G,!0),be=this.data,xe=de.data;for(let Oe=0;Oe<be.length;++Oe){let je=0;for(let dt=this.dims.length-1,Re=Oe,U=1;dt>=0;--dt){let pe=this.dims[dt];if(dt!==G){let Ce=Re%pe;je+=Ce*U,U*=this.dims[dt]}Re=Math.floor(Re/pe)}be[Oe]/=xe[je]}return this}normalize(j=2,G=1){return this.clone().normalize_(j,G)}stride(){return H(this.dims)}squeeze(j=null){return new a(this.type,this.data,C(this.dims,j))}squeeze_(j=null){return this.dims=C(this.dims,j),this}unsqueeze(j=null){return new a(this.type,this.data,M(this.dims,j))}unsqueeze_(j=null){return this.dims=M(this.dims,j),this}flatten_(j=0,G=-1){G=(G+this.dims.length)%this.dims.length;let de=this.dims.slice(0,j),be=this.dims.slice(j,G+1),xe=this.dims.slice(G+1);return this.dims=[...de,be.reduce((Oe,je)=>Oe*je,1),...xe],this}flatten(j=0,G=-1){return this.clone().flatten_(j,G)}view(...j){let G=-1;for(let be=0;be<j.length;++be)if(j[be]===-1){if(G!==-1)throw new Error("Only one dimension can be inferred");G=be}let de=this.data;if(G!==-1){let be=j.reduce((xe,Oe,je)=>je!==G?xe*Oe:xe,1);j[G]=de.length/be}return new a(this.type,de,j)}neg_(){let j=this.data;for(let G=0;G<j.length;++G)j[G]=-j[G];return this}neg(){return this.clone().neg_()}gt(j){let G=new Uint8Array(this.data.length),de=this.data;for(let be=0;be<de.length;++be)G[be]=de[be]>j?1:0;return new a("bool",G,this.dims)}lt(j){let G=new Uint8Array(this.data.length),de=this.data;for(let be=0;be<de.length;++be)G[be]=de[be]<j?1:0;return new a("bool",G,this.dims)}clamp_(j,G){let de=this.data;for(let be=0;be<de.length;++be)de[be]=Math.min(Math.max(de[be],j),G);return this}clamp(j,G){return this.clone().clamp_(j,G)}round_(){let j=this.data;for(let G=0;G<j.length;++G)j[G]=Math.round(j[G]);return this}round(){return this.clone().round_()}mean(j=null,G=!1){return O(this,j,G)}min(j=null,G=!1){if(j===null){let Oe=(0,n.min)(this.data)[0];return new a(this.type,[Oe],[])}let[de,be,xe]=P((Oe,je)=>Math.min(Oe,je),this,j,G,1/0);return new a(de,be,xe)}max(j=null,G=!1){if(j===null){let Oe=(0,n.max)(this.data)[0];return new a(this.type,[Oe],[])}let[de,be,xe]=P((Oe,je)=>Math.max(Oe,je),this,j,G,-1/0);return new a(de,be,xe)}argmin(j=null,G=!1){if(j!==null)throw new Error("`dim !== null` not yet implemented.");let de=(0,n.min)(this.data)[1];return new a("int64",[BigInt(de)],[])}argmax(j=null,G=!1){if(j!==null)throw new Error("`dim !== null` not yet implemented.");let de=(0,n.max)(this.data)[1];return new a("int64",[BigInt(de)],[])}to(j){if(this.type===j)return this;if(!o.hasOwnProperty(j))throw new Error(`Unsupported type: ${j}`);let G,de=["int64","uint64"].includes(this.type),be=["int64","uint64"].includes(j);return de&&!be?G=Number:!de&&be&&(["float16","float32","float64"].includes(this.type)?G=xe=>BigInt(Math.floor(xe)):G=BigInt),new a(j,o[j].from(this.data,G),this.dims)}}function l(te,j){let G=te.length,de=j.reduce((xe,Oe)=>xe*Oe);if(G!==de)throw Error(`cannot reshape array of size ${G} into shape (${j})`);let be=te;for(let xe=j.length-1;xe>=0;xe--)be=be.reduce((Oe,je)=>{let dt=Oe[Oe.length-1];return dt.length<j[xe]?dt.push(je):Oe.push([je]),Oe},[[]]);return be[0]}function c(te,j){let[G,de]=(0,n.permute_data)(te.data,te.dims,j);return new a(te.type,G,de)}function d(te,[j,G],de="bilinear",be=!1){let xe=te.dims.at(-3)??1,Oe=te.dims.at(-2),je=te.dims.at(-1),dt=(0,n.interpolate_data)(te.data,[xe,Oe,je],[j,G],de,be);return new a(te.type,dt,[xe,j,G])}async function u(te,{size:j=null,mode:G="bilinear"}={}){if(te.dims.length!==4)throw new Error("`interpolate_4d` currently only supports 4D input.");if(!j)throw new Error("`interpolate_4d` requires a `size` argument.");let de;if(j.length===2)de=[...te.dims.slice(0,2),...j];else if(j.length===3)de=[te.dims[0],...j];else if(j.length===4)de=j;else throw new Error("`size` must be of length 2, 3, or 4.");let be;if(G==="nearest")be=await r.TensorOpRegistry.nearest_interpolate_4d;else if(G==="bilinear")be=await r.TensorOpRegistry.bilinear_interpolate_4d;else if(G==="bicubic")be=await r.TensorOpRegistry.bicubic_interpolate_4d;else throw new Error(`Unsupported mode: ${G}`);let xe=new a("int64",new BigInt64Array(de.map(BigInt)),[de.length]);return await be({x:te,s:xe})}async function h(te,j){return await(await r.TensorOpRegistry.matmul)({a:te,b:j})}async function p(te,j){return await(await r.TensorOpRegistry.rfft)({x:te,a:j})}async function f(te,j){let G=await r.TensorOpRegistry.top_k;return j==null?j=te.dims.at(-1):j=Math.min(j,te.dims.at(-1)),await G({x:te,k:new a("int64",[BigInt(j)],[1])})}let _=te=>new a("int64",te,[te.length]);async function b(te,j,G,de,be){return await(await r.TensorOpRegistry.slice)({x:te,s:_(j),e:_(G),a:_(de),t:_(be??new Array(de.length).fill(1))})}function y(te,j){let G=te.data,de=j.data,be=[te.dims[0],te.dims[2]],xe=new G.constructor(be[0]*be[1]),[Oe,je,dt]=te.dims,Re=0;for(let U=0;U<Oe;++U){let pe=U*dt*je;for(let Ce=0;Ce<dt;++Ce){let Fe=0,Ve=0,De=U*je,Ee=pe+Ce;for(let Se=0;Se<je;++Se){let $e=Number(de[De+Se]);Ve+=$e,Fe+=G[Ee+Se*dt]*$e}let ze=Fe/Ve;xe[Re++]=ze}}return new a(te.type,xe,be)}function w(te,j,{eps:G=1e-5}={}){if(te.dims.length!==2)throw new Error("`layer_norm` currently only supports 2D input.");let[de,be]=te.dims;if(j.length!==1&&j[0]!==be)throw new Error("`normalized_shape` must be a 1D array with shape `[input.dims[1]]`.");let[xe,Oe]=R(te,1,0,!0),je=xe.data,dt=Oe.data,Re=te.data,U=new Re.constructor(Re.length);for(let pe=0;pe<de;++pe){let Ce=pe*be;for(let Fe=0;Fe<be;++Fe){let Ve=Ce+Fe;U[Ve]=(Re[Ve]-dt[pe])/(je[pe]+G)}}return new a(te.type,U,te.dims)}function C(te,j){return te=te.slice(),j===null?te=te.filter(G=>G!==1):typeof j=="number"?te[j]===1&&te.splice(j,1):Array.isArray(j)&&(te=te.filter((G,de)=>G!==1||!j.includes(de))),te}function M(te,j){return j=S(j,te.length+1),te=te.slice(),te.splice(j,0,1),te}function S(te,j,G=null,de=!0){if(te<-j||te>=j){if(de)throw new Error(`IndexError: index ${te} is out of bounds for dimension${G===null?"":" "+G} with size ${j}`);return te<-j?0:j}return te<0&&(te=(te%j+j)%j),te}function k(te,j=0){j=S(j,te[0].dims.length);let G=te[0].dims.slice();G[j]=te.reduce((Oe,je)=>Oe+je.dims[j],0);let de=G.reduce((Oe,je)=>Oe*je,1),be=new te[0].data.constructor(de),xe=te[0].type;if(j===0){let Oe=0;for(let je of te){let dt=je.data;be.set(dt,Oe),Oe+=dt.length}}else{let Oe=0;for(let je=0;je<te.length;++je){let{data:dt,dims:Re}=te[je];for(let U=0;U<dt.length;++U){let pe=0;for(let Ce=Re.length-1,Fe=U,Ve=1;Ce>=0;--Ce){let De=Re[Ce],Ee=Fe%De;Ce===j&&(Ee+=Oe),pe+=Ee*Ve,Ve*=G[Ce],Fe=Math.floor(Fe/De)}be[pe]=dt[U]}Oe+=Re[j]}}return new a(xe,be,G)}function T(te,j=0){return k(te.map(G=>G.unsqueeze(j)),j)}function P(te,j,G=null,de=!1,be=null){let xe=j.data,Oe=j.dims;G=S(G,Oe.length);let je=Oe.slice();je[G]=1;let dt=new xe.constructor(xe.length/Oe[G]);be!==null&&dt.fill(be);for(let Re=0;Re<xe.length;++Re){let U=0;for(let pe=Oe.length-1,Ce=Re,Fe=1;pe>=0;--pe){let Ve=Oe[pe];if(pe!==G){let De=Ce%Ve;U+=De*Fe,Fe*=je[pe]}Ce=Math.floor(Ce/Ve)}dt[U]=te(dt[U],xe[Re],Re,U)}return de||je.splice(G,1),[j.type,dt,je]}function R(te,j=null,G=1,de=!1){let be=te.data,xe=te.dims;if(j===null){let Fe=be.reduce((ze,Se)=>ze+Se,0)/be.length,Ve=Math.sqrt(be.reduce((ze,Se)=>ze+(Se-Fe)**2,0)/(be.length-G)),De=new a(te.type,[Fe],[]);return[new a(te.type,[Ve],[]),De]}j=S(j,xe.length);let Oe=O(te,j,de),je=Oe.data,[dt,Re,U]=P((Ce,Fe,Ve,De)=>Ce+(Fe-je[De])**2,te,j,de);for(let Ce=0;Ce<Re.length;++Ce)Re[Ce]=Math.sqrt(Re[Ce]/(xe[j]-G));return[new a(dt,Re,U),Oe]}function O(te,j=null,G=!1){let de=te.dims,be=te.data;if(j===null){let dt=be.reduce((Re,U)=>Re+U,0);return new a(te.type,[dt/be.length],[])}j=S(j,de.length);let[xe,Oe,je]=P((dt,Re)=>dt+Re,te,j,G);if(de[j]!==1)for(let dt=0;dt<Oe.length;++dt)Oe[dt]/=de[j];return new a(xe,Oe,je)}function H(te){let j=new Array(te.length);for(let G=te.length-1,de=1;G>=0;--G)j[G]=de,de*=te[G];return j}function X(te,j,G,de){let be=te.reduce((xe,Oe)=>xe*Oe,1);return new a(G,new de(be).fill(j),te)}function z(te,j){let G,de;if(typeof j=="number")G="float32",de=Float32Array;else if(typeof j=="bigint")G="int64",de=BigInt64Array;else if(typeof j=="boolean")G="bool",de=Uint8Array;else throw new Error(`Unsupported data type: ${typeof j}`);return X(te,j,G,de)}function ne(te,j){return z(te.dims,j)}function re(te){return X(te,1n,"int64",BigInt64Array)}function Y(te){return re(te.dims)}function se(te){return X(te,0n,"int64",BigInt64Array)}function ue(te){return se(te.dims)}function fe(te){let j=te.reduce((G,de)=>G*de,1);return new a("float32",Float32Array.from({length:j},()=>Math.random()),te)}function Pe(te){let j=te.reduce((de,be)=>de*be,1);function G(){let de=1-Math.random(),be=1-Math.random();return Math.sqrt(-2*Math.log(de))*Math.cos(2*Math.PI*be)}return new a("float32",Float32Array.from({length:j},()=>G()),te)}function oe(te,j){if(te.dims.length!==2)throw new Error("The tensor must have 2 dimensions");if(te.dims.at(-1)%8!==0)throw new Error("The last dimension of the tensor must be a multiple of 8");if(!["binary","ubinary"].includes(j))throw new Error("The precision must be either 'binary' or 'ubinary'");let G=j==="binary",de=G?"int8":"uint8",be=G?Int8Array:Uint8Array,xe=te.data,Oe=new be(xe.length/8);for(let je=0;je<xe.length;++je){let dt=xe[je]>0?1:0,Re=Math.floor(je/8),U=je%8;Oe[Re]|=dt<<7-U,G&&U===0&&(Oe[Re]-=128)}return new a(de,Oe,[te.dims[0],te.dims[1]/8])}},"./src/utils/video.js":(s,e,t)=>{t.r(e),t.d(e,{RawVideo:()=>o,RawVideoFrame:()=>r,load_video:()=>a});var n=t("./src/utils/image.js"),i=t("./src/env.js");class r{constructor(c,d){this.image=c,this.timestamp=d}}class o{constructor(c,d){c.length>0&&c[0]instanceof n.RawImage&&(c=c.map((u,h)=>new r(u,(h+1)/(c.length+1)*d))),this.frames=c,this.duration=d}get width(){return this.frames[0].image.width}get height(){return this.frames[0].image.height}get fps(){return this.frames.length/this.duration}}async function a(l,{num_frames:c=null,fps:d=null}={}){if(!i.apis.IS_BROWSER_ENV)throw new Error("`load_video` is currently only supported in browser environments.");if(c==null&&d==null)throw new Error("Either num_frames or fps must be provided.");let u=[],h=document.createElement("video");if(h.crossOrigin="anonymous",h.muted=!0,typeof l=="string")h.src=l;else if(l instanceof Blob)h.src=URL.createObjectURL(l);else if(l instanceof HTMLVideoElement)h.src=l.src;else throw new Error("Invalid URL or video element provided.");if(await new Promise(C=>h.onloadedmetadata=C),h.seekable.start(0)===h.seekable.end(0)){let M=await(await fetch(h.src)).blob();h.src=URL.createObjectURL(M),await new Promise(S=>h.onloadedmetadata=S)}let p=h.duration,f,_;c!=null?(f=c,_=c===1?0:p/(c-1)):(_=1/d,f=Math.floor(p/_));let b=[];for(let C=0;C<f;++C)b.push(c===1?p/2:C*_);let y=document.createElement("canvas");y.width=h.videoWidth,y.height=h.videoHeight;let w=y.getContext("2d",{willReadFrequently:!0});for(let C of b){h.currentTime=C,await new Promise(T=>{h.onseeked=T}),w.drawImage(h,0,0,y.width,y.height);let M=w.getImageData(0,0,y.width,y.height),S=new n.RawImage(M.data,y.width,y.height,4),k=new r(S,C);u.push(k)}return h.remove(),new o(u,p)}}},V5={};function Tn(s){var e=V5[s];if(e!==void 0)return e.exports;var t=V5[s]={exports:{}};return ose[s](t,t.exports,Tn),t.exports}(()=>{var s=Object.getPrototypeOf?t=>Object.getPrototypeOf(t):t=>t.__proto__,e;Tn.t=function(t,n){if(n&1&&(t=this(t)),n&8||typeof t=="object"&&t&&(n&4&&t.__esModule||n&16&&typeof t.then=="function"))return t;var i=Object.create(null);Tn.r(i);var r={};e=e||[null,s({}),s([]),s(s)];for(var o=n&2&&t;typeof o=="object"&&!~e.indexOf(o);o=s(o))Object.getOwnPropertyNames(o).forEach(a=>r[a]=()=>t[a]);return r.default=()=>t,Tn.d(i,r),i}})();Tn.d=(s,e)=>{for(var t in e)Tn.o(e,t)&&!Tn.o(s,t)&&Object.defineProperty(s,t,{enumerable:!0,get:e[t]})};Tn.o=(s,e)=>Object.prototype.hasOwnProperty.call(s,e);Tn.r=s=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(s,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(s,"__esModule",{value:!0})};var E={};(()=>{Tn.r(E),Tn.d(E,{ASTFeatureExtractor:()=>u.ASTFeatureExtractor,ASTForAudioClassification:()=>t.ASTForAudioClassification,ASTModel:()=>t.ASTModel,ASTPreTrainedModel:()=>t.ASTPreTrainedModel,AlbertForMaskedLM:()=>t.AlbertForMaskedLM,AlbertForQuestionAnswering:()=>t.AlbertForQuestionAnswering,AlbertForSequenceClassification:()=>t.AlbertForSequenceClassification,AlbertModel:()=>t.AlbertModel,AlbertPreTrainedModel:()=>t.AlbertPreTrainedModel,AlbertTokenizer:()=>n.AlbertTokenizer,ArceeForCausalLM:()=>t.ArceeForCausalLM,ArceeModel:()=>t.ArceeModel,ArceePreTrainedModel:()=>t.ArceePreTrainedModel,AudioClassificationPipeline:()=>e.AudioClassificationPipeline,AutoConfig:()=>i.AutoConfig,AutoFeatureExtractor:()=>h.AutoFeatureExtractor,AutoImageProcessor:()=>_.AutoImageProcessor,AutoModel:()=>t.AutoModel,AutoModelForAudioClassification:()=>t.AutoModelForAudioClassification,AutoModelForAudioFrameClassification:()=>t.AutoModelForAudioFrameClassification,AutoModelForAudioTextToText:()=>t.AutoModelForAudioTextToText,AutoModelForCTC:()=>t.AutoModelForCTC,AutoModelForCausalLM:()=>t.AutoModelForCausalLM,AutoModelForDepthEstimation:()=>t.AutoModelForDepthEstimation,AutoModelForDocumentQuestionAnswering:()=>t.AutoModelForDocumentQuestionAnswering,AutoModelForImageClassification:()=>t.AutoModelForImageClassification,AutoModelForImageFeatureExtraction:()=>t.AutoModelForImageFeatureExtraction,AutoModelForImageMatting:()=>t.AutoModelForImageMatting,AutoModelForImageSegmentation:()=>t.AutoModelForImageSegmentation,AutoModelForImageTextToText:()=>t.AutoModelForImageTextToText,AutoModelForImageToImage:()=>t.AutoModelForImageToImage,AutoModelForMaskGeneration:()=>t.AutoModelForMaskGeneration,AutoModelForMaskedLM:()=>t.AutoModelForMaskedLM,AutoModelForNormalEstimation:()=>t.AutoModelForNormalEstimation,AutoModelForObjectDetection:()=>t.AutoModelForObjectDetection,AutoModelForPoseEstimation:()=>t.AutoModelForPoseEstimation,AutoModelForQuestionAnswering:()=>t.AutoModelForQuestionAnswering,AutoModelForSemanticSegmentation:()=>t.AutoModelForSemanticSegmentation,AutoModelForSeq2SeqLM:()=>t.AutoModelForSeq2SeqLM,AutoModelForSequenceClassification:()=>t.AutoModelForSequenceClassification,AutoModelForSpeechSeq2Seq:()=>t.AutoModelForSpeechSeq2Seq,AutoModelForTextToSpectrogram:()=>t.AutoModelForTextToSpectrogram,AutoModelForTextToWaveform:()=>t.AutoModelForTextToWaveform,AutoModelForTokenClassification:()=>t.AutoModelForTokenClassification,AutoModelForUniversalSegmentation:()=>t.AutoModelForUniversalSegmentation,AutoModelForVision2Seq:()=>t.AutoModelForVision2Seq,AutoModelForXVector:()=>t.AutoModelForXVector,AutoModelForZeroShotObjectDetection:()=>t.AutoModelForZeroShotObjectDetection,AutoProcessor:()=>w.AutoProcessor,AutoTokenizer:()=>n.AutoTokenizer,AutomaticSpeechRecognitionPipeline:()=>e.AutomaticSpeechRecognitionPipeline,BackgroundRemovalPipeline:()=>e.BackgroundRemovalPipeline,BartForConditionalGeneration:()=>t.BartForConditionalGeneration,BartForSequenceClassification:()=>t.BartForSequenceClassification,BartModel:()=>t.BartModel,BartPretrainedModel:()=>t.BartPretrainedModel,BartTokenizer:()=>n.BartTokenizer,BaseModelOutput:()=>t.BaseModelOutput,BaseStreamer:()=>C.BaseStreamer,BeitFeatureExtractor:()=>f.BeitFeatureExtractor,BeitForImageClassification:()=>t.BeitForImageClassification,BeitModel:()=>t.BeitModel,BeitPreTrainedModel:()=>t.BeitPreTrainedModel,BertForMaskedLM:()=>t.BertForMaskedLM,BertForQuestionAnswering:()=>t.BertForQuestionAnswering,BertForSequenceClassification:()=>t.BertForSequenceClassification,BertForTokenClassification:()=>t.BertForTokenClassification,BertModel:()=>t.BertModel,BertPreTrainedModel:()=>t.BertPreTrainedModel,BertTokenizer:()=>n.BertTokenizer,BitImageProcessor:()=>f.BitImageProcessor,BlenderbotForConditionalGeneration:()=>t.BlenderbotForConditionalGeneration,BlenderbotModel:()=>t.BlenderbotModel,BlenderbotPreTrainedModel:()=>t.BlenderbotPreTrainedModel,BlenderbotSmallForConditionalGeneration:()=>t.BlenderbotSmallForConditionalGeneration,BlenderbotSmallModel:()=>t.BlenderbotSmallModel,BlenderbotSmallPreTrainedModel:()=>t.BlenderbotSmallPreTrainedModel,BlenderbotSmallTokenizer:()=>n.BlenderbotSmallTokenizer,BlenderbotTokenizer:()=>n.BlenderbotTokenizer,BloomForCausalLM:()=>t.BloomForCausalLM,BloomModel:()=>t.BloomModel,BloomPreTrainedModel:()=>t.BloomPreTrainedModel,BloomTokenizer:()=>n.BloomTokenizer,CLIPFeatureExtractor:()=>f.CLIPFeatureExtractor,CLIPImageProcessor:()=>f.CLIPImageProcessor,CLIPModel:()=>t.CLIPModel,CLIPPreTrainedModel:()=>t.CLIPPreTrainedModel,CLIPSegForImageSegmentation:()=>t.CLIPSegForImageSegmentation,CLIPSegModel:()=>t.CLIPSegModel,CLIPSegPreTrainedModel:()=>t.CLIPSegPreTrainedModel,CLIPTextModel:()=>t.CLIPTextModel,CLIPTextModelWithProjection:()=>t.CLIPTextModelWithProjection,CLIPTokenizer:()=>n.CLIPTokenizer,CLIPVisionModel:()=>t.CLIPVisionModel,CLIPVisionModelWithProjection:()=>t.CLIPVisionModelWithProjection,CamembertForMaskedLM:()=>t.CamembertForMaskedLM,CamembertForQuestionAnswering:()=>t.CamembertForQuestionAnswering,CamembertForSequenceClassification:()=>t.CamembertForSequenceClassification,CamembertForTokenClassification:()=>t.CamembertForTokenClassification,CamembertModel:()=>t.CamembertModel,CamembertPreTrainedModel:()=>t.CamembertPreTrainedModel,CamembertTokenizer:()=>n.CamembertTokenizer,CausalLMOutput:()=>t.CausalLMOutput,CausalLMOutputWithPast:()=>t.CausalLMOutputWithPast,ChineseCLIPFeatureExtractor:()=>f.ChineseCLIPFeatureExtractor,ChineseCLIPModel:()=>t.ChineseCLIPModel,ChineseCLIPPreTrainedModel:()=>t.ChineseCLIPPreTrainedModel,ClapAudioModelWithProjection:()=>t.ClapAudioModelWithProjection,ClapFeatureExtractor:()=>u.ClapFeatureExtractor,ClapModel:()=>t.ClapModel,ClapPreTrainedModel:()=>t.ClapPreTrainedModel,ClapTextModelWithProjection:()=>t.ClapTextModelWithProjection,ClassifierFreeGuidanceLogitsProcessor:()=>S.ClassifierFreeGuidanceLogitsProcessor,CodeGenForCausalLM:()=>t.CodeGenForCausalLM,CodeGenModel:()=>t.CodeGenModel,CodeGenPreTrainedModel:()=>t.CodeGenPreTrainedModel,CodeGenTokenizer:()=>n.CodeGenTokenizer,CodeLlamaTokenizer:()=>n.CodeLlamaTokenizer,CohereForCausalLM:()=>t.CohereForCausalLM,CohereModel:()=>t.CohereModel,CoherePreTrainedModel:()=>t.CoherePreTrainedModel,CohereTokenizer:()=>n.CohereTokenizer,ConvBertForMaskedLM:()=>t.ConvBertForMaskedLM,ConvBertForQuestionAnswering:()=>t.ConvBertForQuestionAnswering,ConvBertForSequenceClassification:()=>t.ConvBertForSequenceClassification,ConvBertForTokenClassification:()=>t.ConvBertForTokenClassification,ConvBertModel:()=>t.ConvBertModel,ConvBertPreTrainedModel:()=>t.ConvBertPreTrainedModel,ConvBertTokenizer:()=>n.ConvBertTokenizer,ConvNextFeatureExtractor:()=>f.ConvNextFeatureExtractor,ConvNextForImageClassification:()=>t.ConvNextForImageClassification,ConvNextImageProcessor:()=>f.ConvNextImageProcessor,ConvNextModel:()=>t.ConvNextModel,ConvNextPreTrainedModel:()=>t.ConvNextPreTrainedModel,ConvNextV2ForImageClassification:()=>t.ConvNextV2ForImageClassification,ConvNextV2Model:()=>t.ConvNextV2Model,ConvNextV2PreTrainedModel:()=>t.ConvNextV2PreTrainedModel,DFineForObjectDetection:()=>t.DFineForObjectDetection,DFineModel:()=>t.DFineModel,DFinePreTrainedModel:()=>t.DFinePreTrainedModel,DINOv3ConvNextModel:()=>t.DINOv3ConvNextModel,DINOv3ConvNextPreTrainedModel:()=>t.DINOv3ConvNextPreTrainedModel,DINOv3ViTImageProcessor:()=>f.DINOv3ViTImageProcessor,DINOv3ViTModel:()=>t.DINOv3ViTModel,DINOv3ViTPreTrainedModel:()=>t.DINOv3ViTPreTrainedModel,DPTFeatureExtractor:()=>f.DPTFeatureExtractor,DPTForDepthEstimation:()=>t.DPTForDepthEstimation,DPTImageProcessor:()=>f.DPTImageProcessor,DPTModel:()=>t.DPTModel,DPTPreTrainedModel:()=>t.DPTPreTrainedModel,DacDecoderModel:()=>t.DacDecoderModel,DacDecoderOutput:()=>t.DacDecoderOutput,DacEncoderModel:()=>t.DacEncoderModel,DacEncoderOutput:()=>t.DacEncoderOutput,DacFeatureExtractor:()=>u.DacFeatureExtractor,DacModel:()=>t.DacModel,DacPreTrainedModel:()=>t.DacPreTrainedModel,DataTypeMap:()=>l.DataTypeMap,DebertaForMaskedLM:()=>t.DebertaForMaskedLM,DebertaForQuestionAnswering:()=>t.DebertaForQuestionAnswering,DebertaForSequenceClassification:()=>t.DebertaForSequenceClassification,DebertaForTokenClassification:()=>t.DebertaForTokenClassification,DebertaModel:()=>t.DebertaModel,DebertaPreTrainedModel:()=>t.DebertaPreTrainedModel,DebertaTokenizer:()=>n.DebertaTokenizer,DebertaV2ForMaskedLM:()=>t.DebertaV2ForMaskedLM,DebertaV2ForQuestionAnswering:()=>t.DebertaV2ForQuestionAnswering,DebertaV2ForSequenceClassification:()=>t.DebertaV2ForSequenceClassification,DebertaV2ForTokenClassification:()=>t.DebertaV2ForTokenClassification,DebertaV2Model:()=>t.DebertaV2Model,DebertaV2PreTrainedModel:()=>t.DebertaV2PreTrainedModel,DebertaV2Tokenizer:()=>n.DebertaV2Tokenizer,DecisionTransformerModel:()=>t.DecisionTransformerModel,DecisionTransformerPreTrainedModel:()=>t.DecisionTransformerPreTrainedModel,DeiTFeatureExtractor:()=>f.DeiTFeatureExtractor,DeiTForImageClassification:()=>t.DeiTForImageClassification,DeiTImageProcessor:()=>f.DeiTImageProcessor,DeiTModel:()=>t.DeiTModel,DeiTPreTrainedModel:()=>t.DeiTPreTrainedModel,DepthAnythingForDepthEstimation:()=>t.DepthAnythingForDepthEstimation,DepthAnythingPreTrainedModel:()=>t.DepthAnythingPreTrainedModel,DepthEstimationPipeline:()=>e.DepthEstimationPipeline,DepthProForDepthEstimation:()=>t.DepthProForDepthEstimation,DepthProPreTrainedModel:()=>t.DepthProPreTrainedModel,DetrFeatureExtractor:()=>f.DetrFeatureExtractor,DetrForObjectDetection:()=>t.DetrForObjectDetection,DetrForSegmentation:()=>t.DetrForSegmentation,DetrImageProcessor:()=>f.DetrImageProcessor,DetrModel:()=>t.DetrModel,DetrObjectDetectionOutput:()=>t.DetrObjectDetectionOutput,DetrPreTrainedModel:()=>t.DetrPreTrainedModel,DetrSegmentationOutput:()=>t.DetrSegmentationOutput,Dinov2ForImageClassification:()=>t.Dinov2ForImageClassification,Dinov2Model:()=>t.Dinov2Model,Dinov2PreTrainedModel:()=>t.Dinov2PreTrainedModel,Dinov2WithRegistersForImageClassification:()=>t.Dinov2WithRegistersForImageClassification,Dinov2WithRegistersModel:()=>t.Dinov2WithRegistersModel,Dinov2WithRegistersPreTrainedModel:()=>t.Dinov2WithRegistersPreTrainedModel,DistilBertForMaskedLM:()=>t.DistilBertForMaskedLM,DistilBertForQuestionAnswering:()=>t.DistilBertForQuestionAnswering,DistilBertForSequenceClassification:()=>t.DistilBertForSequenceClassification,DistilBertForTokenClassification:()=>t.DistilBertForTokenClassification,DistilBertModel:()=>t.DistilBertModel,DistilBertPreTrainedModel:()=>t.DistilBertPreTrainedModel,DistilBertTokenizer:()=>n.DistilBertTokenizer,DocumentQuestionAnsweringPipeline:()=>e.DocumentQuestionAnsweringPipeline,DonutFeatureExtractor:()=>f.DonutFeatureExtractor,DonutImageProcessor:()=>f.DonutImageProcessor,DonutSwinModel:()=>t.DonutSwinModel,DonutSwinPreTrainedModel:()=>t.DonutSwinPreTrainedModel,EdgeTamModel:()=>t.EdgeTamModel,EfficientNetForImageClassification:()=>t.EfficientNetForImageClassification,EfficientNetImageProcessor:()=>f.EfficientNetImageProcessor,EfficientNetModel:()=>t.EfficientNetModel,EfficientNetPreTrainedModel:()=>t.EfficientNetPreTrainedModel,ElectraForMaskedLM:()=>t.ElectraForMaskedLM,ElectraForQuestionAnswering:()=>t.ElectraForQuestionAnswering,ElectraForSequenceClassification:()=>t.ElectraForSequenceClassification,ElectraForTokenClassification:()=>t.ElectraForTokenClassification,ElectraModel:()=>t.ElectraModel,ElectraPreTrainedModel:()=>t.ElectraPreTrainedModel,ElectraTokenizer:()=>n.ElectraTokenizer,EncodecFeatureExtractor:()=>u.EncodecFeatureExtractor,EosTokenCriteria:()=>M.EosTokenCriteria,Ernie4_5ForCausalLM:()=>t.Ernie4_5ForCausalLM,Ernie4_5Model:()=>t.Ernie4_5Model,Ernie4_5PreTrainedModel:()=>t.Ernie4_5PreTrainedModel,EsmForMaskedLM:()=>t.EsmForMaskedLM,EsmForSequenceClassification:()=>t.EsmForSequenceClassification,EsmForTokenClassification:()=>t.EsmForTokenClassification,EsmModel:()=>t.EsmModel,EsmPreTrainedModel:()=>t.EsmPreTrainedModel,EsmTokenizer:()=>n.EsmTokenizer,ExaoneForCausalLM:()=>t.ExaoneForCausalLM,ExaoneModel:()=>t.ExaoneModel,ExaonePreTrainedModel:()=>t.ExaonePreTrainedModel,FFT:()=>c.FFT,FalconForCausalLM:()=>t.FalconForCausalLM,FalconModel:()=>t.FalconModel,FalconPreTrainedModel:()=>t.FalconPreTrainedModel,FalconTokenizer:()=>n.FalconTokenizer,FastViTForImageClassification:()=>t.FastViTForImageClassification,FastViTModel:()=>t.FastViTModel,FastViTPreTrainedModel:()=>t.FastViTPreTrainedModel,FeatureExtractionPipeline:()=>e.FeatureExtractionPipeline,FeatureExtractor:()=>d.FeatureExtractor,FillMaskPipeline:()=>e.FillMaskPipeline,Florence2ForConditionalGeneration:()=>t.Florence2ForConditionalGeneration,Florence2PreTrainedModel:()=>t.Florence2PreTrainedModel,Florence2Processor:()=>y.Florence2Processor,ForcedBOSTokenLogitsProcessor:()=>S.ForcedBOSTokenLogitsProcessor,ForcedEOSTokenLogitsProcessor:()=>S.ForcedEOSTokenLogitsProcessor,GLPNFeatureExtractor:()=>f.GLPNFeatureExtractor,GLPNForDepthEstimation:()=>t.GLPNForDepthEstimation,GLPNModel:()=>t.GLPNModel,GLPNPreTrainedModel:()=>t.GLPNPreTrainedModel,GPT2LMHeadModel:()=>t.GPT2LMHeadModel,GPT2Model:()=>t.GPT2Model,GPT2PreTrainedModel:()=>t.GPT2PreTrainedModel,GPT2Tokenizer:()=>n.GPT2Tokenizer,GPTBigCodeForCausalLM:()=>t.GPTBigCodeForCausalLM,GPTBigCodeModel:()=>t.GPTBigCodeModel,GPTBigCodePreTrainedModel:()=>t.GPTBigCodePreTrainedModel,GPTJForCausalLM:()=>t.GPTJForCausalLM,GPTJModel:()=>t.GPTJModel,GPTJPreTrainedModel:()=>t.GPTJPreTrainedModel,GPTNeoForCausalLM:()=>t.GPTNeoForCausalLM,GPTNeoModel:()=>t.GPTNeoModel,GPTNeoPreTrainedModel:()=>t.GPTNeoPreTrainedModel,GPTNeoXForCausalLM:()=>t.GPTNeoXForCausalLM,GPTNeoXModel:()=>t.GPTNeoXModel,GPTNeoXPreTrainedModel:()=>t.GPTNeoXPreTrainedModel,GPTNeoXTokenizer:()=>n.GPTNeoXTokenizer,Gemma2ForCausalLM:()=>t.Gemma2ForCausalLM,Gemma2Model:()=>t.Gemma2Model,Gemma2PreTrainedModel:()=>t.Gemma2PreTrainedModel,Gemma3ForCausalLM:()=>t.Gemma3ForCausalLM,Gemma3Model:()=>t.Gemma3Model,Gemma3PreTrainedModel:()=>t.Gemma3PreTrainedModel,Gemma3nAudioFeatureExtractor:()=>u.Gemma3nAudioFeatureExtractor,Gemma3nForConditionalGeneration:()=>t.Gemma3nForConditionalGeneration,Gemma3nPreTrainedModel:()=>t.Gemma3nPreTrainedModel,Gemma3nProcessor:()=>y.Gemma3nProcessor,GemmaForCausalLM:()=>t.GemmaForCausalLM,GemmaModel:()=>t.GemmaModel,GemmaPreTrainedModel:()=>t.GemmaPreTrainedModel,GemmaTokenizer:()=>n.GemmaTokenizer,GlmForCausalLM:()=>t.GlmForCausalLM,GlmModel:()=>t.GlmModel,GlmPreTrainedModel:()=>t.GlmPreTrainedModel,GraniteForCausalLM:()=>t.GraniteForCausalLM,GraniteModel:()=>t.GraniteModel,GraniteMoeHybridForCausalLM:()=>t.GraniteMoeHybridForCausalLM,GraniteMoeHybridModel:()=>t.GraniteMoeHybridModel,GraniteMoeHybridPreTrainedModel:()=>t.GraniteMoeHybridPreTrainedModel,GranitePreTrainedModel:()=>t.GranitePreTrainedModel,Grok1Tokenizer:()=>n.Grok1Tokenizer,GroundingDinoForObjectDetection:()=>t.GroundingDinoForObjectDetection,GroundingDinoImageProcessor:()=>f.GroundingDinoImageProcessor,GroundingDinoPreTrainedModel:()=>t.GroundingDinoPreTrainedModel,GroundingDinoProcessor:()=>y.GroundingDinoProcessor,GroupViTModel:()=>t.GroupViTModel,GroupViTPreTrainedModel:()=>t.GroupViTPreTrainedModel,HeliumForCausalLM:()=>t.HeliumForCausalLM,HeliumModel:()=>t.HeliumModel,HeliumPreTrainedModel:()=>t.HeliumPreTrainedModel,HerbertTokenizer:()=>n.HerbertTokenizer,HieraForImageClassification:()=>t.HieraForImageClassification,HieraModel:()=>t.HieraModel,HieraPreTrainedModel:()=>t.HieraPreTrainedModel,HubertForCTC:()=>t.HubertForCTC,HubertForSequenceClassification:()=>t.HubertForSequenceClassification,HubertModel:()=>t.HubertModel,HubertPreTrainedModel:()=>t.HubertPreTrainedModel,IJepaForImageClassification:()=>t.IJepaForImageClassification,IJepaModel:()=>t.IJepaModel,IJepaPreTrainedModel:()=>t.IJepaPreTrainedModel,Idefics3ForConditionalGeneration:()=>t.Idefics3ForConditionalGeneration,Idefics3ImageProcessor:()=>f.Idefics3ImageProcessor,Idefics3PreTrainedModel:()=>t.Idefics3PreTrainedModel,Idefics3Processor:()=>y.Idefics3Processor,ImageClassificationPipeline:()=>e.ImageClassificationPipeline,ImageFeatureExtractionPipeline:()=>e.ImageFeatureExtractionPipeline,ImageFeatureExtractor:()=>u.ImageFeatureExtractor,ImageMattingOutput:()=>t.ImageMattingOutput,ImageProcessor:()=>p.ImageProcessor,ImageSegmentationPipeline:()=>e.ImageSegmentationPipeline,ImageToImagePipeline:()=>e.ImageToImagePipeline,ImageToTextPipeline:()=>e.ImageToTextPipeline,InterruptableStoppingCriteria:()=>M.InterruptableStoppingCriteria,JAISLMHeadModel:()=>t.JAISLMHeadModel,JAISModel:()=>t.JAISModel,JAISPreTrainedModel:()=>t.JAISPreTrainedModel,JinaCLIPImageProcessor:()=>f.JinaCLIPImageProcessor,JinaCLIPModel:()=>t.JinaCLIPModel,JinaCLIPPreTrainedModel:()=>t.JinaCLIPPreTrainedModel,JinaCLIPProcessor:()=>y.JinaCLIPProcessor,JinaCLIPTextModel:()=>t.JinaCLIPTextModel,JinaCLIPVisionModel:()=>t.JinaCLIPVisionModel,Lfm2ForCausalLM:()=>t.Lfm2ForCausalLM,Lfm2Model:()=>t.Lfm2Model,Lfm2PreTrainedModel:()=>t.Lfm2PreTrainedModel,LiteWhisperForConditionalGeneration:()=>t.LiteWhisperForConditionalGeneration,Llama4ForCausalLM:()=>t.Llama4ForCausalLM,Llama4PreTrainedModel:()=>t.Llama4PreTrainedModel,LlamaForCausalLM:()=>t.LlamaForCausalLM,LlamaModel:()=>t.LlamaModel,LlamaPreTrainedModel:()=>t.LlamaPreTrainedModel,LlamaTokenizer:()=>n.LlamaTokenizer,LlavaForConditionalGeneration:()=>t.LlavaForConditionalGeneration,LlavaOnevisionForConditionalGeneration:()=>t.LlavaOnevisionForConditionalGeneration,LlavaOnevisionImageProcessor:()=>f.LlavaOnevisionImageProcessor,LlavaPreTrainedModel:()=>t.LlavaPreTrainedModel,LlavaProcessor:()=>y.LlavaProcessor,LlavaQwen2ForCausalLM:()=>t.LlavaQwen2ForCausalLM,LogitsProcessor:()=>S.LogitsProcessor,LogitsProcessorList:()=>S.LogitsProcessorList,LogitsWarper:()=>S.LogitsWarper,LongT5ForConditionalGeneration:()=>t.LongT5ForConditionalGeneration,LongT5Model:()=>t.LongT5Model,LongT5PreTrainedModel:()=>t.LongT5PreTrainedModel,M2M100ForConditionalGeneration:()=>t.M2M100ForConditionalGeneration,M2M100Model:()=>t.M2M100Model,M2M100PreTrainedModel:()=>t.M2M100PreTrainedModel,M2M100Tokenizer:()=>n.M2M100Tokenizer,MBart50Tokenizer:()=>n.MBart50Tokenizer,MBartForCausalLM:()=>t.MBartForCausalLM,MBartForConditionalGeneration:()=>t.MBartForConditionalGeneration,MBartForSequenceClassification:()=>t.MBartForSequenceClassification,MBartModel:()=>t.MBartModel,MBartPreTrainedModel:()=>t.MBartPreTrainedModel,MBartTokenizer:()=>n.MBartTokenizer,MPNetForMaskedLM:()=>t.MPNetForMaskedLM,MPNetForQuestionAnswering:()=>t.MPNetForQuestionAnswering,MPNetForSequenceClassification:()=>t.MPNetForSequenceClassification,MPNetForTokenClassification:()=>t.MPNetForTokenClassification,MPNetModel:()=>t.MPNetModel,MPNetPreTrainedModel:()=>t.MPNetPreTrainedModel,MPNetTokenizer:()=>n.MPNetTokenizer,MT5ForConditionalGeneration:()=>t.MT5ForConditionalGeneration,MT5Model:()=>t.MT5Model,MT5PreTrainedModel:()=>t.MT5PreTrainedModel,MarianMTModel:()=>t.MarianMTModel,MarianModel:()=>t.MarianModel,MarianPreTrainedModel:()=>t.MarianPreTrainedModel,MarianTokenizer:()=>n.MarianTokenizer,Mask2FormerImageProcessor:()=>f.Mask2FormerImageProcessor,MaskFormerFeatureExtractor:()=>f.MaskFormerFeatureExtractor,MaskFormerForInstanceSegmentation:()=>t.MaskFormerForInstanceSegmentation,MaskFormerImageProcessor:()=>f.MaskFormerImageProcessor,MaskFormerModel:()=>t.MaskFormerModel,MaskFormerPreTrainedModel:()=>t.MaskFormerPreTrainedModel,MaskedLMOutput:()=>t.MaskedLMOutput,MaxLengthCriteria:()=>M.MaxLengthCriteria,Metric3DForDepthEstimation:()=>t.Metric3DForDepthEstimation,Metric3DPreTrainedModel:()=>t.Metric3DPreTrainedModel,Metric3Dv2ForDepthEstimation:()=>t.Metric3Dv2ForDepthEstimation,Metric3Dv2PreTrainedModel:()=>t.Metric3Dv2PreTrainedModel,MgpstrForSceneTextRecognition:()=>t.MgpstrForSceneTextRecognition,MgpstrModelOutput:()=>t.MgpstrModelOutput,MgpstrPreTrainedModel:()=>t.MgpstrPreTrainedModel,MgpstrProcessor:()=>y.MgpstrProcessor,MgpstrTokenizer:()=>n.MgpstrTokenizer,MimiDecoderModel:()=>t.MimiDecoderModel,MimiDecoderOutput:()=>t.MimiDecoderOutput,MimiEncoderModel:()=>t.MimiEncoderModel,MimiEncoderOutput:()=>t.MimiEncoderOutput,MimiModel:()=>t.MimiModel,MimiPreTrainedModel:()=>t.MimiPreTrainedModel,MinLengthLogitsProcessor:()=>S.MinLengthLogitsProcessor,MinNewTokensLengthLogitsProcessor:()=>S.MinNewTokensLengthLogitsProcessor,Ministral3ForCausalLM:()=>t.Ministral3ForCausalLM,Ministral3Model:()=>t.Ministral3Model,Ministral3PreTrainedModel:()=>t.Ministral3PreTrainedModel,MinistralForCausalLM:()=>t.MinistralForCausalLM,MinistralModel:()=>t.MinistralModel,MinistralPreTrainedModel:()=>t.MinistralPreTrainedModel,Mistral3ForConditionalGeneration:()=>t.Mistral3ForConditionalGeneration,MistralForCausalLM:()=>t.MistralForCausalLM,MistralModel:()=>t.MistralModel,MistralPreTrainedModel:()=>t.MistralPreTrainedModel,MobileBertForMaskedLM:()=>t.MobileBertForMaskedLM,MobileBertForQuestionAnswering:()=>t.MobileBertForQuestionAnswering,MobileBertForSequenceClassification:()=>t.MobileBertForSequenceClassification,MobileBertModel:()=>t.MobileBertModel,MobileBertPreTrainedModel:()=>t.MobileBertPreTrainedModel,MobileBertTokenizer:()=>n.MobileBertTokenizer,MobileLLMForCausalLM:()=>t.MobileLLMForCausalLM,MobileLLMModel:()=>t.MobileLLMModel,MobileLLMPreTrainedModel:()=>t.MobileLLMPreTrainedModel,MobileNetV1FeatureExtractor:()=>f.MobileNetV1FeatureExtractor,MobileNetV1ForImageClassification:()=>t.MobileNetV1ForImageClassification,MobileNetV1ForSemanticSegmentation:()=>t.MobileNetV1ForSemanticSegmentation,MobileNetV1ImageProcessor:()=>f.MobileNetV1ImageProcessor,MobileNetV1Model:()=>t.MobileNetV1Model,MobileNetV1PreTrainedModel:()=>t.MobileNetV1PreTrainedModel,MobileNetV2FeatureExtractor:()=>f.MobileNetV2FeatureExtractor,MobileNetV2ForImageClassification:()=>t.MobileNetV2ForImageClassification,MobileNetV2ForSemanticSegmentation:()=>t.MobileNetV2ForSemanticSegmentation,MobileNetV2ImageProcessor:()=>f.MobileNetV2ImageProcessor,MobileNetV2Model:()=>t.MobileNetV2Model,MobileNetV2PreTrainedModel:()=>t.MobileNetV2PreTrainedModel,MobileNetV3FeatureExtractor:()=>f.MobileNetV3FeatureExtractor,MobileNetV3ForImageClassification:()=>t.MobileNetV3ForImageClassification,MobileNetV3ForSemanticSegmentation:()=>t.MobileNetV3ForSemanticSegmentation,MobileNetV3ImageProcessor:()=>f.MobileNetV3ImageProcessor,MobileNetV3Model:()=>t.MobileNetV3Model,MobileNetV3PreTrainedModel:()=>t.MobileNetV3PreTrainedModel,MobileNetV4FeatureExtractor:()=>f.MobileNetV4FeatureExtractor,MobileNetV4ForImageClassification:()=>t.MobileNetV4ForImageClassification,MobileNetV4ForSemanticSegmentation:()=>t.MobileNetV4ForSemanticSegmentation,MobileNetV4ImageProcessor:()=>f.MobileNetV4ImageProcessor,MobileNetV4Model:()=>t.MobileNetV4Model,MobileNetV4PreTrainedModel:()=>t.MobileNetV4PreTrainedModel,MobileViTFeatureExtractor:()=>f.MobileViTFeatureExtractor,MobileViTForImageClassification:()=>t.MobileViTForImageClassification,MobileViTImageProcessor:()=>f.MobileViTImageProcessor,MobileViTModel:()=>t.MobileViTModel,MobileViTPreTrainedModel:()=>t.MobileViTPreTrainedModel,MobileViTV2ForImageClassification:()=>t.MobileViTV2ForImageClassification,MobileViTV2Model:()=>t.MobileViTV2Model,MobileViTV2PreTrainedModel:()=>t.MobileViTV2PreTrainedModel,ModelOutput:()=>t.ModelOutput,ModernBertDecoderForCausalLM:()=>t.ModernBertDecoderForCausalLM,ModernBertDecoderModel:()=>t.ModernBertDecoderModel,ModernBertDecoderPreTrainedModel:()=>t.ModernBertDecoderPreTrainedModel,ModernBertForMaskedLM:()=>t.ModernBertForMaskedLM,ModernBertForSequenceClassification:()=>t.ModernBertForSequenceClassification,ModernBertForTokenClassification:()=>t.ModernBertForTokenClassification,ModernBertModel:()=>t.ModernBertModel,ModernBertPreTrainedModel:()=>t.ModernBertPreTrainedModel,Moondream1ForConditionalGeneration:()=>t.Moondream1ForConditionalGeneration,MoonshineFeatureExtractor:()=>u.MoonshineFeatureExtractor,MoonshineForConditionalGeneration:()=>t.MoonshineForConditionalGeneration,MoonshineModel:()=>t.MoonshineModel,MoonshinePreTrainedModel:()=>t.MoonshinePreTrainedModel,MoonshineProcessor:()=>y.MoonshineProcessor,MptForCausalLM:()=>t.MptForCausalLM,MptModel:()=>t.MptModel,MptPreTrainedModel:()=>t.MptPreTrainedModel,MultiModalityCausalLM:()=>t.MultiModalityCausalLM,MultiModalityPreTrainedModel:()=>t.MultiModalityPreTrainedModel,MusicgenForCausalLM:()=>t.MusicgenForCausalLM,MusicgenForConditionalGeneration:()=>t.MusicgenForConditionalGeneration,MusicgenModel:()=>t.MusicgenModel,MusicgenPreTrainedModel:()=>t.MusicgenPreTrainedModel,NanoChatForCausalLM:()=>t.NanoChatForCausalLM,NanoChatModel:()=>t.NanoChatModel,NanoChatPreTrainedModel:()=>t.NanoChatPreTrainedModel,NeoBertForMaskedLM:()=>t.NeoBertForMaskedLM,NeoBertForQuestionAnswering:()=>t.NeoBertForQuestionAnswering,NeoBertForSequenceClassification:()=>t.NeoBertForSequenceClassification,NeoBertForTokenClassification:()=>t.NeoBertForTokenClassification,NeoBertModel:()=>t.NeoBertModel,NeoBertPreTrainedModel:()=>t.NeoBertPreTrainedModel,NllbTokenizer:()=>n.NllbTokenizer,NoBadWordsLogitsProcessor:()=>S.NoBadWordsLogitsProcessor,NoRepeatNGramLogitsProcessor:()=>S.NoRepeatNGramLogitsProcessor,NomicBertModel:()=>t.NomicBertModel,NomicBertPreTrainedModel:()=>t.NomicBertPreTrainedModel,NougatImageProcessor:()=>f.NougatImageProcessor,NougatTokenizer:()=>n.NougatTokenizer,OPTForCausalLM:()=>t.OPTForCausalLM,OPTModel:()=>t.OPTModel,OPTPreTrainedModel:()=>t.OPTPreTrainedModel,ObjectDetectionPipeline:()=>e.ObjectDetectionPipeline,Olmo2ForCausalLM:()=>t.Olmo2ForCausalLM,Olmo2Model:()=>t.Olmo2Model,Olmo2PreTrainedModel:()=>t.Olmo2PreTrainedModel,OlmoForCausalLM:()=>t.OlmoForCausalLM,OlmoModel:()=>t.OlmoModel,OlmoPreTrainedModel:()=>t.OlmoPreTrainedModel,OpenELMForCausalLM:()=>t.OpenELMForCausalLM,OpenELMModel:()=>t.OpenELMModel,OpenELMPreTrainedModel:()=>t.OpenELMPreTrainedModel,OwlViTFeatureExtractor:()=>f.OwlViTFeatureExtractor,OwlViTForObjectDetection:()=>t.OwlViTForObjectDetection,OwlViTImageProcessor:()=>f.OwlViTImageProcessor,OwlViTModel:()=>t.OwlViTModel,OwlViTPreTrainedModel:()=>t.OwlViTPreTrainedModel,OwlViTProcessor:()=>y.OwlViTProcessor,Owlv2ForObjectDetection:()=>t.Owlv2ForObjectDetection,Owlv2ImageProcessor:()=>f.Owlv2ImageProcessor,Owlv2Model:()=>t.Owlv2Model,Owlv2PreTrainedModel:()=>t.Owlv2PreTrainedModel,PaliGemmaForConditionalGeneration:()=>t.PaliGemmaForConditionalGeneration,PaliGemmaPreTrainedModel:()=>t.PaliGemmaPreTrainedModel,PaliGemmaProcessor:()=>y.PaliGemmaProcessor,ParakeetFeatureExtractor:()=>u.ParakeetFeatureExtractor,ParakeetForCTC:()=>t.ParakeetForCTC,ParakeetPreTrainedModel:()=>t.ParakeetPreTrainedModel,PatchTSMixerForPrediction:()=>t.PatchTSMixerForPrediction,PatchTSMixerModel:()=>t.PatchTSMixerModel,PatchTSMixerPreTrainedModel:()=>t.PatchTSMixerPreTrainedModel,PatchTSTForPrediction:()=>t.PatchTSTForPrediction,PatchTSTModel:()=>t.PatchTSTModel,PatchTSTPreTrainedModel:()=>t.PatchTSTPreTrainedModel,Phi3ForCausalLM:()=>t.Phi3ForCausalLM,Phi3Model:()=>t.Phi3Model,Phi3PreTrainedModel:()=>t.Phi3PreTrainedModel,Phi3VForCausalLM:()=>t.Phi3VForCausalLM,Phi3VImageProcessor:()=>f.Phi3VImageProcessor,Phi3VPreTrainedModel:()=>t.Phi3VPreTrainedModel,Phi3VProcessor:()=>y.Phi3VProcessor,PhiForCausalLM:()=>t.PhiForCausalLM,PhiModel:()=>t.PhiModel,PhiPreTrainedModel:()=>t.PhiPreTrainedModel,Pipeline:()=>e.Pipeline,PixtralImageProcessor:()=>f.PixtralImageProcessor,PixtralProcessor:()=>y.PixtralProcessor,PreTrainedModel:()=>t.PreTrainedModel,PreTrainedTokenizer:()=>n.PreTrainedTokenizer,PretrainedConfig:()=>i.PretrainedConfig,PretrainedMixin:()=>t.PretrainedMixin,Processor:()=>b.Processor,PvtForImageClassification:()=>t.PvtForImageClassification,PvtImageProcessor:()=>f.PvtImageProcessor,PvtModel:()=>t.PvtModel,PvtPreTrainedModel:()=>t.PvtPreTrainedModel,PyAnnoteFeatureExtractor:()=>u.PyAnnoteFeatureExtractor,PyAnnoteForAudioFrameClassification:()=>t.PyAnnoteForAudioFrameClassification,PyAnnoteModel:()=>t.PyAnnoteModel,PyAnnotePreTrainedModel:()=>t.PyAnnotePreTrainedModel,PyAnnoteProcessor:()=>y.PyAnnoteProcessor,QuestionAnsweringModelOutput:()=>t.QuestionAnsweringModelOutput,QuestionAnsweringPipeline:()=>e.QuestionAnsweringPipeline,Qwen2ForCausalLM:()=>t.Qwen2ForCausalLM,Qwen2Model:()=>t.Qwen2Model,Qwen2PreTrainedModel:()=>t.Qwen2PreTrainedModel,Qwen2Tokenizer:()=>n.Qwen2Tokenizer,Qwen2VLForConditionalGeneration:()=>t.Qwen2VLForConditionalGeneration,Qwen2VLImageProcessor:()=>f.Qwen2VLImageProcessor,Qwen2VLPreTrainedModel:()=>t.Qwen2VLPreTrainedModel,Qwen2VLProcessor:()=>y.Qwen2VLProcessor,Qwen3ForCausalLM:()=>t.Qwen3ForCausalLM,Qwen3Model:()=>t.Qwen3Model,Qwen3PreTrainedModel:()=>t.Qwen3PreTrainedModel,RFDetrForObjectDetection:()=>t.RFDetrForObjectDetection,RFDetrModel:()=>t.RFDetrModel,RFDetrObjectDetectionOutput:()=>t.RFDetrObjectDetectionOutput,RFDetrPreTrainedModel:()=>t.RFDetrPreTrainedModel,RTDetrForObjectDetection:()=>t.RTDetrForObjectDetection,RTDetrImageProcessor:()=>f.RTDetrImageProcessor,RTDetrModel:()=>t.RTDetrModel,RTDetrObjectDetectionOutput:()=>t.RTDetrObjectDetectionOutput,RTDetrPreTrainedModel:()=>t.RTDetrPreTrainedModel,RTDetrV2ForObjectDetection:()=>t.RTDetrV2ForObjectDetection,RTDetrV2Model:()=>t.RTDetrV2Model,RTDetrV2ObjectDetectionOutput:()=>t.RTDetrV2ObjectDetectionOutput,RTDetrV2PreTrainedModel:()=>t.RTDetrV2PreTrainedModel,RawAudio:()=>r.RawAudio,RawImage:()=>o.RawImage,RawVideo:()=>a.RawVideo,RawVideoFrame:()=>a.RawVideoFrame,RepetitionPenaltyLogitsProcessor:()=>S.RepetitionPenaltyLogitsProcessor,ResNetForImageClassification:()=>t.ResNetForImageClassification,ResNetModel:()=>t.ResNetModel,ResNetPreTrainedModel:()=>t.ResNetPreTrainedModel,RoFormerForMaskedLM:()=>t.RoFormerForMaskedLM,RoFormerForQuestionAnswering:()=>t.RoFormerForQuestionAnswering,RoFormerForSequenceClassification:()=>t.RoFormerForSequenceClassification,RoFormerForTokenClassification:()=>t.RoFormerForTokenClassification,RoFormerModel:()=>t.RoFormerModel,RoFormerPreTrainedModel:()=>t.RoFormerPreTrainedModel,RoFormerTokenizer:()=>n.RoFormerTokenizer,RobertaForMaskedLM:()=>t.RobertaForMaskedLM,RobertaForQuestionAnswering:()=>t.RobertaForQuestionAnswering,RobertaForSequenceClassification:()=>t.RobertaForSequenceClassification,RobertaForTokenClassification:()=>t.RobertaForTokenClassification,RobertaModel:()=>t.RobertaModel,RobertaPreTrainedModel:()=>t.RobertaPreTrainedModel,RobertaTokenizer:()=>n.RobertaTokenizer,Sam2ImageProcessor:()=>f.Sam2ImageProcessor,Sam2ImageSegmentationOutput:()=>t.Sam2ImageSegmentationOutput,Sam2Model:()=>t.Sam2Model,Sam2PreTrainedModel:()=>t.Sam2PreTrainedModel,Sam2Processor:()=>y.Sam2Processor,Sam2VideoProcessor:()=>y.Sam2VideoProcessor,Sam3ImageProcessor:()=>f.Sam3ImageProcessor,Sam3TrackerModel:()=>t.Sam3TrackerModel,SamImageProcessor:()=>f.SamImageProcessor,SamImageSegmentationOutput:()=>t.SamImageSegmentationOutput,SamModel:()=>t.SamModel,SamPreTrainedModel:()=>t.SamPreTrainedModel,SamProcessor:()=>y.SamProcessor,SapiensForDepthEstimation:()=>t.SapiensForDepthEstimation,SapiensForNormalEstimation:()=>t.SapiensForNormalEstimation,SapiensForSemanticSegmentation:()=>t.SapiensForSemanticSegmentation,SapiensPreTrainedModel:()=>t.SapiensPreTrainedModel,SeamlessM4TFeatureExtractor:()=>u.SeamlessM4TFeatureExtractor,SegformerFeatureExtractor:()=>f.SegformerFeatureExtractor,SegformerForImageClassification:()=>t.SegformerForImageClassification,SegformerForSemanticSegmentation:()=>t.SegformerForSemanticSegmentation,SegformerImageProcessor:()=>f.SegformerImageProcessor,SegformerModel:()=>t.SegformerModel,SegformerPreTrainedModel:()=>t.SegformerPreTrainedModel,Seq2SeqLMOutput:()=>t.Seq2SeqLMOutput,SequenceClassifierOutput:()=>t.SequenceClassifierOutput,SiglipImageProcessor:()=>f.SiglipImageProcessor,SiglipModel:()=>t.SiglipModel,SiglipPreTrainedModel:()=>t.SiglipPreTrainedModel,SiglipTextModel:()=>t.SiglipTextModel,SiglipTokenizer:()=>n.SiglipTokenizer,SiglipVisionModel:()=>t.SiglipVisionModel,SmolLM3ForCausalLM:()=>t.SmolLM3ForCausalLM,SmolLM3Model:()=>t.SmolLM3Model,SmolLM3PreTrainedModel:()=>t.SmolLM3PreTrainedModel,SmolVLMForConditionalGeneration:()=>t.SmolVLMForConditionalGeneration,SmolVLMImageProcessor:()=>f.SmolVLMImageProcessor,SmolVLMProcessor:()=>y.SmolVLMProcessor,SnacDecoderModel:()=>t.SnacDecoderModel,SnacEncoderModel:()=>t.SnacEncoderModel,SnacFeatureExtractor:()=>u.SnacFeatureExtractor,SnacModel:()=>t.SnacModel,SnacPreTrainedModel:()=>t.SnacPreTrainedModel,SpeechT5FeatureExtractor:()=>u.SpeechT5FeatureExtractor,SpeechT5ForSpeechToText:()=>t.SpeechT5ForSpeechToText,SpeechT5ForTextToSpeech:()=>t.SpeechT5ForTextToSpeech,SpeechT5HifiGan:()=>t.SpeechT5HifiGan,SpeechT5Model:()=>t.SpeechT5Model,SpeechT5PreTrainedModel:()=>t.SpeechT5PreTrainedModel,SpeechT5Processor:()=>y.SpeechT5Processor,SpeechT5Tokenizer:()=>n.SpeechT5Tokenizer,SqueezeBertForMaskedLM:()=>t.SqueezeBertForMaskedLM,SqueezeBertForQuestionAnswering:()=>t.SqueezeBertForQuestionAnswering,SqueezeBertForSequenceClassification:()=>t.SqueezeBertForSequenceClassification,SqueezeBertModel:()=>t.SqueezeBertModel,SqueezeBertPreTrainedModel:()=>t.SqueezeBertPreTrainedModel,SqueezeBertTokenizer:()=>n.SqueezeBertTokenizer,StableLmForCausalLM:()=>t.StableLmForCausalLM,StableLmModel:()=>t.StableLmModel,StableLmPreTrainedModel:()=>t.StableLmPreTrainedModel,Starcoder2ForCausalLM:()=>t.Starcoder2ForCausalLM,Starcoder2Model:()=>t.Starcoder2Model,Starcoder2PreTrainedModel:()=>t.Starcoder2PreTrainedModel,StoppingCriteria:()=>M.StoppingCriteria,StoppingCriteriaList:()=>M.StoppingCriteriaList,StyleTextToSpeech2Model:()=>t.StyleTextToSpeech2Model,StyleTextToSpeech2PreTrainedModel:()=>t.StyleTextToSpeech2PreTrainedModel,SummarizationPipeline:()=>e.SummarizationPipeline,SupertonicForConditionalGeneration:()=>t.SupertonicForConditionalGeneration,SupertonicPreTrainedModel:()=>t.SupertonicPreTrainedModel,SuppressTokensAtBeginLogitsProcessor:()=>S.SuppressTokensAtBeginLogitsProcessor,Swin2SRForImageSuperResolution:()=>t.Swin2SRForImageSuperResolution,Swin2SRImageProcessor:()=>f.Swin2SRImageProcessor,Swin2SRModel:()=>t.Swin2SRModel,Swin2SRPreTrainedModel:()=>t.Swin2SRPreTrainedModel,SwinForImageClassification:()=>t.SwinForImageClassification,SwinForSemanticSegmentation:()=>t.SwinForSemanticSegmentation,SwinModel:()=>t.SwinModel,SwinPreTrainedModel:()=>t.SwinPreTrainedModel,T5ForConditionalGeneration:()=>t.T5ForConditionalGeneration,T5Model:()=>t.T5Model,T5PreTrainedModel:()=>t.T5PreTrainedModel,T5Tokenizer:()=>n.T5Tokenizer,TableTransformerForObjectDetection:()=>t.TableTransformerForObjectDetection,TableTransformerModel:()=>t.TableTransformerModel,TableTransformerObjectDetectionOutput:()=>t.TableTransformerObjectDetectionOutput,TableTransformerPreTrainedModel:()=>t.TableTransformerPreTrainedModel,TemperatureLogitsWarper:()=>S.TemperatureLogitsWarper,Tensor:()=>l.Tensor,Text2TextGenerationPipeline:()=>e.Text2TextGenerationPipeline,TextClassificationPipeline:()=>e.TextClassificationPipeline,TextGenerationPipeline:()=>e.TextGenerationPipeline,TextStreamer:()=>C.TextStreamer,TextToAudioPipeline:()=>e.TextToAudioPipeline,TokenClassificationPipeline:()=>e.TokenClassificationPipeline,TokenClassifierOutput:()=>t.TokenClassifierOutput,TokenizerModel:()=>n.TokenizerModel,TopKLogitsWarper:()=>S.TopKLogitsWarper,TopPLogitsWarper:()=>S.TopPLogitsWarper,TrOCRForCausalLM:()=>t.TrOCRForCausalLM,TrOCRPreTrainedModel:()=>t.TrOCRPreTrainedModel,TranslationPipeline:()=>e.TranslationPipeline,UltravoxModel:()=>t.UltravoxModel,UltravoxPreTrainedModel:()=>t.UltravoxPreTrainedModel,UltravoxProcessor:()=>y.UltravoxProcessor,UniSpeechForCTC:()=>t.UniSpeechForCTC,UniSpeechForSequenceClassification:()=>t.UniSpeechForSequenceClassification,UniSpeechModel:()=>t.UniSpeechModel,UniSpeechPreTrainedModel:()=>t.UniSpeechPreTrainedModel,UniSpeechSatForAudioFrameClassification:()=>t.UniSpeechSatForAudioFrameClassification,UniSpeechSatForCTC:()=>t.UniSpeechSatForCTC,UniSpeechSatForSequenceClassification:()=>t.UniSpeechSatForSequenceClassification,UniSpeechSatModel:()=>t.UniSpeechSatModel,UniSpeechSatPreTrainedModel:()=>t.UniSpeechSatPreTrainedModel,VLChatProcessor:()=>y.VLChatProcessor,VLMImageProcessor:()=>f.VLMImageProcessor,VaultGemmaForCausalLM:()=>t.VaultGemmaForCausalLM,VaultGemmaModel:()=>t.VaultGemmaModel,VaultGemmaPreTrainedModel:()=>t.VaultGemmaPreTrainedModel,ViTFeatureExtractor:()=>f.ViTFeatureExtractor,ViTForImageClassification:()=>t.ViTForImageClassification,ViTImageProcessor:()=>f.ViTImageProcessor,ViTMAEModel:()=>t.ViTMAEModel,ViTMAEPreTrainedModel:()=>t.ViTMAEPreTrainedModel,ViTMSNForImageClassification:()=>t.ViTMSNForImageClassification,ViTMSNModel:()=>t.ViTMSNModel,ViTMSNPreTrainedModel:()=>t.ViTMSNPreTrainedModel,ViTModel:()=>t.ViTModel,ViTPreTrainedModel:()=>t.ViTPreTrainedModel,VisionEncoderDecoderModel:()=>t.VisionEncoderDecoderModel,VitMatteForImageMatting:()=>t.VitMatteForImageMatting,VitMatteImageProcessor:()=>f.VitMatteImageProcessor,VitMattePreTrainedModel:()=>t.VitMattePreTrainedModel,VitPoseForPoseEstimation:()=>t.VitPoseForPoseEstimation,VitPoseImageProcessor:()=>f.VitPoseImageProcessor,VitPosePreTrainedModel:()=>t.VitPosePreTrainedModel,VitsModel:()=>t.VitsModel,VitsModelOutput:()=>t.VitsModelOutput,VitsPreTrainedModel:()=>t.VitsPreTrainedModel,VitsTokenizer:()=>n.VitsTokenizer,VoxtralForConditionalGeneration:()=>t.VoxtralForConditionalGeneration,VoxtralProcessor:()=>y.VoxtralProcessor,Wav2Vec2BertForCTC:()=>t.Wav2Vec2BertForCTC,Wav2Vec2BertForSequenceClassification:()=>t.Wav2Vec2BertForSequenceClassification,Wav2Vec2BertModel:()=>t.Wav2Vec2BertModel,Wav2Vec2BertPreTrainedModel:()=>t.Wav2Vec2BertPreTrainedModel,Wav2Vec2CTCTokenizer:()=>n.Wav2Vec2CTCTokenizer,Wav2Vec2FeatureExtractor:()=>u.Wav2Vec2FeatureExtractor,Wav2Vec2ForAudioFrameClassification:()=>t.Wav2Vec2ForAudioFrameClassification,Wav2Vec2ForCTC:()=>t.Wav2Vec2ForCTC,Wav2Vec2ForSequenceClassification:()=>t.Wav2Vec2ForSequenceClassification,Wav2Vec2Model:()=>t.Wav2Vec2Model,Wav2Vec2PreTrainedModel:()=>t.Wav2Vec2PreTrainedModel,Wav2Vec2Processor:()=>y.Wav2Vec2Processor,Wav2Vec2ProcessorWithLM:()=>y.Wav2Vec2ProcessorWithLM,WavLMForAudioFrameClassification:()=>t.WavLMForAudioFrameClassification,WavLMForCTC:()=>t.WavLMForCTC,WavLMForSequenceClassification:()=>t.WavLMForSequenceClassification,WavLMForXVector:()=>t.WavLMForXVector,WavLMModel:()=>t.WavLMModel,WavLMPreTrainedModel:()=>t.WavLMPreTrainedModel,WeSpeakerFeatureExtractor:()=>u.WeSpeakerFeatureExtractor,WeSpeakerResNetModel:()=>t.WeSpeakerResNetModel,WeSpeakerResNetPreTrainedModel:()=>t.WeSpeakerResNetPreTrainedModel,WhisperFeatureExtractor:()=>u.WhisperFeatureExtractor,WhisperForConditionalGeneration:()=>t.WhisperForConditionalGeneration,WhisperModel:()=>t.WhisperModel,WhisperPreTrainedModel:()=>t.WhisperPreTrainedModel,WhisperProcessor:()=>y.WhisperProcessor,WhisperTextStreamer:()=>C.WhisperTextStreamer,WhisperTimeStampLogitsProcessor:()=>S.WhisperTimeStampLogitsProcessor,WhisperTokenizer:()=>n.WhisperTokenizer,XLMForQuestionAnswering:()=>t.XLMForQuestionAnswering,XLMForSequenceClassification:()=>t.XLMForSequenceClassification,XLMForTokenClassification:()=>t.XLMForTokenClassification,XLMModel:()=>t.XLMModel,XLMPreTrainedModel:()=>t.XLMPreTrainedModel,XLMRobertaForMaskedLM:()=>t.XLMRobertaForMaskedLM,XLMRobertaForQuestionAnswering:()=>t.XLMRobertaForQuestionAnswering,XLMRobertaForSequenceClassification:()=>t.XLMRobertaForSequenceClassification,XLMRobertaForTokenClassification:()=>t.XLMRobertaForTokenClassification,XLMRobertaModel:()=>t.XLMRobertaModel,XLMRobertaPreTrainedModel:()=>t.XLMRobertaPreTrainedModel,XLMRobertaTokenizer:()=>n.XLMRobertaTokenizer,XLMTokenizer:()=>n.XLMTokenizer,XLMWithLMHeadModel:()=>t.XLMWithLMHeadModel,XVectorOutput:()=>t.XVectorOutput,YolosFeatureExtractor:()=>f.YolosFeatureExtractor,YolosForObjectDetection:()=>t.YolosForObjectDetection,YolosImageProcessor:()=>f.YolosImageProcessor,YolosModel:()=>t.YolosModel,YolosObjectDetectionOutput:()=>t.YolosObjectDetectionOutput,YolosPreTrainedModel:()=>t.YolosPreTrainedModel,ZeroShotAudioClassificationPipeline:()=>e.ZeroShotAudioClassificationPipeline,ZeroShotClassificationPipeline:()=>e.ZeroShotClassificationPipeline,ZeroShotImageClassificationPipeline:()=>e.ZeroShotImageClassificationPipeline,ZeroShotObjectDetectionPipeline:()=>e.ZeroShotObjectDetectionPipeline,bankers_round:()=>c.bankers_round,cat:()=>l.cat,cos_sim:()=>c.cos_sim,dot:()=>c.dot,dynamic_time_warping:()=>c.dynamic_time_warping,env:()=>s.env,full:()=>l.full,full_like:()=>l.full_like,getCacheShapes:()=>i.getCacheShapes,hamming:()=>r.hamming,hanning:()=>r.hanning,interpolate:()=>l.interpolate,interpolate_4d:()=>l.interpolate_4d,interpolate_data:()=>c.interpolate_data,is_chinese_char:()=>n.is_chinese_char,layer_norm:()=>l.layer_norm,load_image:()=>o.load_image,load_video:()=>a.load_video,log_softmax:()=>c.log_softmax,magnitude:()=>c.magnitude,matmul:()=>l.matmul,max:()=>c.max,mean:()=>l.mean,mean_pooling:()=>l.mean_pooling,medianFilter:()=>c.medianFilter,mel_filter_bank:()=>r.mel_filter_bank,min:()=>c.min,ones:()=>l.ones,ones_like:()=>l.ones_like,permute:()=>l.permute,permute_data:()=>c.permute_data,pipeline:()=>e.pipeline,quantize_embeddings:()=>l.quantize_embeddings,rand:()=>l.rand,randn:()=>l.randn,read_audio:()=>r.read_audio,rfft:()=>l.rfft,round:()=>c.round,slice:()=>l.slice,softmax:()=>c.softmax,spectrogram:()=>r.spectrogram,stack:()=>l.stack,std_mean:()=>l.std_mean,topk:()=>l.topk,window_function:()=>r.window_function,zeros:()=>l.zeros,zeros_like:()=>l.zeros_like});var s=Tn("./src/env.js"),e=Tn("./src/pipelines.js"),t=Tn("./src/models.js"),n=Tn("./src/tokenizers.js"),i=Tn("./src/configs.js"),r=Tn("./src/utils/audio.js"),o=Tn("./src/utils/image.js"),a=Tn("./src/utils/video.js"),l=Tn("./src/utils/tensor.js"),c=Tn("./src/utils/maths.js"),d=Tn("./src/base/feature_extraction_utils.js"),u=Tn("./src/models/feature_extractors.js"),h=Tn("./src/models/auto/feature_extraction_auto.js"),p=Tn("./src/base/image_processors_utils.js"),f=Tn("./src/models/image_processors.js"),_=Tn("./src/models/auto/image_processing_auto.js"),b=Tn("./src/base/processing_utils.js"),y=Tn("./src/models/processors.js"),w=Tn("./src/models/auto/processing_auto.js"),C=Tn("./src/generation/streamers.js"),M=Tn("./src/generation/stopping_criteria.js"),S=Tn("./src/generation/logits_process.js")})();var Vue=E.ASTFeatureExtractor,Gue=E.ASTForAudioClassification,Wue=E.ASTModel,Hue=E.ASTPreTrainedModel,jue=E.AlbertForMaskedLM,que=E.AlbertForQuestionAnswering,Kue=E.AlbertForSequenceClassification,Yue=E.AlbertModel,Xue=E.AlbertPreTrainedModel,Que=E.AlbertTokenizer,Jue=E.ArceeForCausalLM,Zue=E.ArceeModel,ehe=E.ArceePreTrainedModel,the=E.AudioClassificationPipeline,nhe=E.AutoConfig,she=E.AutoFeatureExtractor,ihe=E.AutoImageProcessor,rhe=E.AutoModel,ohe=E.AutoModelForAudioClassification,ahe=E.AutoModelForAudioFrameClassification,lhe=E.AutoModelForAudioTextToText,che=E.AutoModelForCTC,dhe=E.AutoModelForCausalLM,uhe=E.AutoModelForDepthEstimation,hhe=E.AutoModelForDocumentQuestionAnswering,phe=E.AutoModelForImageClassification,fhe=E.AutoModelForImageFeatureExtraction,mhe=E.AutoModelForImageMatting,ghe=E.AutoModelForImageSegmentation,_he=E.AutoModelForImageTextToText,yhe=E.AutoModelForImageToImage,vhe=E.AutoModelForMaskGeneration,bhe=E.AutoModelForMaskedLM,whe=E.AutoModelForNormalEstimation,Mhe=E.AutoModelForObjectDetection,The=E.AutoModelForPoseEstimation,Ehe=E.AutoModelForQuestionAnswering,xhe=E.AutoModelForSemanticSegmentation,She=E.AutoModelForSeq2SeqLM,Che=E.AutoModelForSequenceClassification,Ahe=E.AutoModelForSpeechSeq2Seq,Phe=E.AutoModelForTextToSpectrogram,khe=E.AutoModelForTextToWaveform,Ihe=E.AutoModelForTokenClassification,Dhe=E.AutoModelForUniversalSegmentation,Rhe=E.AutoModelForVision2Seq,Fhe=E.AutoModelForXVector,Lhe=E.AutoModelForZeroShotObjectDetection,Nhe=E.AutoProcessor,Ohe=E.AutoTokenizer,$he=E.AutomaticSpeechRecognitionPipeline,Bhe=E.BackgroundRemovalPipeline,zhe=E.BartForConditionalGeneration,Uhe=E.BartForSequenceClassification,Vhe=E.BartModel,Ghe=E.BartPretrainedModel,Whe=E.BartTokenizer,Hhe=E.BaseModelOutput,jhe=E.BaseStreamer,qhe=E.BeitFeatureExtractor,Khe=E.BeitForImageClassification,Yhe=E.BeitModel,Xhe=E.BeitPreTrainedModel,Qhe=E.BertForMaskedLM,Jhe=E.BertForQuestionAnswering,Zhe=E.BertForSequenceClassification,epe=E.BertForTokenClassification,tpe=E.BertModel,npe=E.BertPreTrainedModel,spe=E.BertTokenizer,ipe=E.BitImageProcessor,rpe=E.BlenderbotForConditionalGeneration,ope=E.BlenderbotModel,ape=E.BlenderbotPreTrainedModel,lpe=E.BlenderbotSmallForConditionalGeneration,cpe=E.BlenderbotSmallModel,dpe=E.BlenderbotSmallPreTrainedModel,upe=E.BlenderbotSmallTokenizer,hpe=E.BlenderbotTokenizer,ppe=E.BloomForCausalLM,fpe=E.BloomModel,mpe=E.BloomPreTrainedModel,gpe=E.BloomTokenizer,_pe=E.CLIPFeatureExtractor,ype=E.CLIPImageProcessor,vpe=E.CLIPModel,bpe=E.CLIPPreTrainedModel,wpe=E.CLIPSegForImageSegmentation,Mpe=E.CLIPSegModel,Tpe=E.CLIPSegPreTrainedModel,Epe=E.CLIPTextModel,xpe=E.CLIPTextModelWithProjection,Spe=E.CLIPTokenizer,Cpe=E.CLIPVisionModel,Ape=E.CLIPVisionModelWithProjection,Ppe=E.CamembertForMaskedLM,kpe=E.CamembertForQuestionAnswering,Ipe=E.CamembertForSequenceClassification,Dpe=E.CamembertForTokenClassification,Rpe=E.CamembertModel,Fpe=E.CamembertPreTrainedModel,Lpe=E.CamembertTokenizer,Npe=E.CausalLMOutput,Ope=E.CausalLMOutputWithPast,$pe=E.ChineseCLIPFeatureExtractor,Bpe=E.ChineseCLIPModel,zpe=E.ChineseCLIPPreTrainedModel,Upe=E.ClapAudioModelWithProjection,Vpe=E.ClapFeatureExtractor,Gpe=E.ClapModel,Wpe=E.ClapPreTrainedModel,Hpe=E.ClapTextModelWithProjection,jpe=E.ClassifierFreeGuidanceLogitsProcessor,qpe=E.CodeGenForCausalLM,Kpe=E.CodeGenModel,Ype=E.CodeGenPreTrainedModel,Xpe=E.CodeGenTokenizer,Qpe=E.CodeLlamaTokenizer,Jpe=E.CohereForCausalLM,Zpe=E.CohereModel,efe=E.CoherePreTrainedModel,tfe=E.CohereTokenizer,nfe=E.ConvBertForMaskedLM,sfe=E.ConvBertForQuestionAnswering,ife=E.ConvBertForSequenceClassification,rfe=E.ConvBertForTokenClassification,ofe=E.ConvBertModel,afe=E.ConvBertPreTrainedModel,lfe=E.ConvBertTokenizer,cfe=E.ConvNextFeatureExtractor,dfe=E.ConvNextForImageClassification,ufe=E.ConvNextImageProcessor,hfe=E.ConvNextModel,pfe=E.ConvNextPreTrainedModel,ffe=E.ConvNextV2ForImageClassification,mfe=E.ConvNextV2Model,gfe=E.ConvNextV2PreTrainedModel,_fe=E.DFineForObjectDetection,yfe=E.DFineModel,vfe=E.DFinePreTrainedModel,bfe=E.DINOv3ConvNextModel,wfe=E.DINOv3ConvNextPreTrainedModel,Mfe=E.DINOv3ViTImageProcessor,Tfe=E.DINOv3ViTModel,Efe=E.DINOv3ViTPreTrainedModel,xfe=E.DPTFeatureExtractor,Sfe=E.DPTForDepthEstimation,Cfe=E.DPTImageProcessor,Afe=E.DPTModel,Pfe=E.DPTPreTrainedModel,kfe=E.DacDecoderModel,Ife=E.DacDecoderOutput,Dfe=E.DacEncoderModel,Rfe=E.DacEncoderOutput,Ffe=E.DacFeatureExtractor,Lfe=E.DacModel,Nfe=E.DacPreTrainedModel,Ofe=E.DataTypeMap,$fe=E.DebertaForMaskedLM,Bfe=E.DebertaForQuestionAnswering,zfe=E.DebertaForSequenceClassification,Ufe=E.DebertaForTokenClassification,Vfe=E.DebertaModel,Gfe=E.DebertaPreTrainedModel,Wfe=E.DebertaTokenizer,Hfe=E.DebertaV2ForMaskedLM,jfe=E.DebertaV2ForQuestionAnswering,qfe=E.DebertaV2ForSequenceClassification,Kfe=E.DebertaV2ForTokenClassification,Yfe=E.DebertaV2Model,Xfe=E.DebertaV2PreTrainedModel,Qfe=E.DebertaV2Tokenizer,Jfe=E.DecisionTransformerModel,Zfe=E.DecisionTransformerPreTrainedModel,eme=E.DeiTFeatureExtractor,tme=E.DeiTForImageClassification,nme=E.DeiTImageProcessor,sme=E.DeiTModel,ime=E.DeiTPreTrainedModel,rme=E.DepthAnythingForDepthEstimation,ome=E.DepthAnythingPreTrainedModel,ame=E.DepthEstimationPipeline,lme=E.DepthProForDepthEstimation,cme=E.DepthProPreTrainedModel,dme=E.DetrFeatureExtractor,ume=E.DetrForObjectDetection,hme=E.DetrForSegmentation,pme=E.DetrImageProcessor,fme=E.DetrModel,mme=E.DetrObjectDetectionOutput,gme=E.DetrPreTrainedModel,_me=E.DetrSegmentationOutput,yme=E.Dinov2ForImageClassification,vme=E.Dinov2Model,bme=E.Dinov2PreTrainedModel,wme=E.Dinov2WithRegistersForImageClassification,Mme=E.Dinov2WithRegistersModel,Tme=E.Dinov2WithRegistersPreTrainedModel,Eme=E.DistilBertForMaskedLM,xme=E.DistilBertForQuestionAnswering,Sme=E.DistilBertForSequenceClassification,Cme=E.DistilBertForTokenClassification,Ame=E.DistilBertModel,Pme=E.DistilBertPreTrainedModel,kme=E.DistilBertTokenizer,Ime=E.DocumentQuestionAnsweringPipeline,Dme=E.DonutFeatureExtractor,Rme=E.DonutImageProcessor,Fme=E.DonutSwinModel,Lme=E.DonutSwinPreTrainedModel,Nme=E.EdgeTamModel,Ome=E.EfficientNetForImageClassification,$me=E.EfficientNetImageProcessor,Bme=E.EfficientNetModel,zme=E.EfficientNetPreTrainedModel,Ume=E.ElectraForMaskedLM,Vme=E.ElectraForQuestionAnswering,Gme=E.ElectraForSequenceClassification,Wme=E.ElectraForTokenClassification,Hme=E.ElectraModel,jme=E.ElectraPreTrainedModel,qme=E.ElectraTokenizer,Kme=E.EncodecFeatureExtractor,Yme=E.EosTokenCriteria,Xme=E.Ernie4_5ForCausalLM,Qme=E.Ernie4_5Model,Jme=E.Ernie4_5PreTrainedModel,Zme=E.EsmForMaskedLM,ege=E.EsmForSequenceClassification,tge=E.EsmForTokenClassification,nge=E.EsmModel,sge=E.EsmPreTrainedModel,ige=E.EsmTokenizer,rge=E.ExaoneForCausalLM,oge=E.ExaoneModel,age=E.ExaonePreTrainedModel,lge=E.FFT,cge=E.FalconForCausalLM,dge=E.FalconModel,uge=E.FalconPreTrainedModel,hge=E.FalconTokenizer,pge=E.FastViTForImageClassification,fge=E.FastViTModel,mge=E.FastViTPreTrainedModel,gge=E.FeatureExtractionPipeline,_ge=E.FeatureExtractor,yge=E.FillMaskPipeline,vge=E.Florence2ForConditionalGeneration,bge=E.Florence2PreTrainedModel,wge=E.Florence2Processor,Mge=E.ForcedBOSTokenLogitsProcessor,Tge=E.ForcedEOSTokenLogitsProcessor,Ege=E.GLPNFeatureExtractor,xge=E.GLPNForDepthEstimation,Sge=E.GLPNModel,Cge=E.GLPNPreTrainedModel,Age=E.GPT2LMHeadModel,Pge=E.GPT2Model,kge=E.GPT2PreTrainedModel,Ige=E.GPT2Tokenizer,Dge=E.GPTBigCodeForCausalLM,Rge=E.GPTBigCodeModel,Fge=E.GPTBigCodePreTrainedModel,Lge=E.GPTJForCausalLM,Nge=E.GPTJModel,Oge=E.GPTJPreTrainedModel,$ge=E.GPTNeoForCausalLM,Bge=E.GPTNeoModel,zge=E.GPTNeoPreTrainedModel,Uge=E.GPTNeoXForCausalLM,Vge=E.GPTNeoXModel,Gge=E.GPTNeoXPreTrainedModel,Wge=E.GPTNeoXTokenizer,Hge=E.Gemma2ForCausalLM,jge=E.Gemma2Model,qge=E.Gemma2PreTrainedModel,Kge=E.Gemma3ForCausalLM,Yge=E.Gemma3Model,Xge=E.Gemma3PreTrainedModel,Qge=E.Gemma3nAudioFeatureExtractor,Jge=E.Gemma3nForConditionalGeneration,Zge=E.Gemma3nPreTrainedModel,e_e=E.Gemma3nProcessor,t_e=E.GemmaForCausalLM,n_e=E.GemmaModel,s_e=E.GemmaPreTrainedModel,i_e=E.GemmaTokenizer,r_e=E.GlmForCausalLM,o_e=E.GlmModel,a_e=E.GlmPreTrainedModel,l_e=E.GraniteForCausalLM,c_e=E.GraniteModel,d_e=E.GraniteMoeHybridForCausalLM,u_e=E.GraniteMoeHybridModel,h_e=E.GraniteMoeHybridPreTrainedModel,p_e=E.GranitePreTrainedModel,f_e=E.Grok1Tokenizer,m_e=E.GroundingDinoForObjectDetection,g_e=E.GroundingDinoImageProcessor,__e=E.GroundingDinoPreTrainedModel,y_e=E.GroundingDinoProcessor,v_e=E.GroupViTModel,b_e=E.GroupViTPreTrainedModel,w_e=E.HeliumForCausalLM,M_e=E.HeliumModel,T_e=E.HeliumPreTrainedModel,E_e=E.HerbertTokenizer,x_e=E.HieraForImageClassification,S_e=E.HieraModel,C_e=E.HieraPreTrainedModel,A_e=E.HubertForCTC,P_e=E.HubertForSequenceClassification,k_e=E.HubertModel,I_e=E.HubertPreTrainedModel,D_e=E.IJepaForImageClassification,R_e=E.IJepaModel,F_e=E.IJepaPreTrainedModel,L_e=E.Idefics3ForConditionalGeneration,N_e=E.Idefics3ImageProcessor,O_e=E.Idefics3PreTrainedModel,$_e=E.Idefics3Processor,B_e=E.ImageClassificationPipeline,z_e=E.ImageFeatureExtractionPipeline,U_e=E.ImageFeatureExtractor,V_e=E.ImageMattingOutput,G_e=E.ImageProcessor,W_e=E.ImageSegmentationPipeline,H_e=E.ImageToImagePipeline,j_e=E.ImageToTextPipeline,q_e=E.InterruptableStoppingCriteria,K_e=E.JAISLMHeadModel,Y_e=E.JAISModel,X_e=E.JAISPreTrainedModel,Q_e=E.JinaCLIPImageProcessor,J_e=E.JinaCLIPModel,Z_e=E.JinaCLIPPreTrainedModel,eye=E.JinaCLIPProcessor,tye=E.JinaCLIPTextModel,nye=E.JinaCLIPVisionModel,sye=E.Lfm2ForCausalLM,iye=E.Lfm2Model,rye=E.Lfm2PreTrainedModel,oye=E.LiteWhisperForConditionalGeneration,aye=E.Llama4ForCausalLM,lye=E.Llama4PreTrainedModel,cye=E.LlamaForCausalLM,dye=E.LlamaModel,uye=E.LlamaPreTrainedModel,hye=E.LlamaTokenizer,pye=E.LlavaForConditionalGeneration,fye=E.LlavaOnevisionForConditionalGeneration,mye=E.LlavaOnevisionImageProcessor,gye=E.LlavaPreTrainedModel,_ye=E.LlavaProcessor,yye=E.LlavaQwen2ForCausalLM,vye=E.LogitsProcessor,bye=E.LogitsProcessorList,wye=E.LogitsWarper,Mye=E.LongT5ForConditionalGeneration,Tye=E.LongT5Model,Eye=E.LongT5PreTrainedModel,xye=E.M2M100ForConditionalGeneration,Sye=E.M2M100Model,Cye=E.M2M100PreTrainedModel,Aye=E.M2M100Tokenizer,Pye=E.MBart50Tokenizer,kye=E.MBartForCausalLM,Iye=E.MBartForConditionalGeneration,Dye=E.MBartForSequenceClassification,Rye=E.MBartModel,Fye=E.MBartPreTrainedModel,Lye=E.MBartTokenizer,Nye=E.MPNetForMaskedLM,Oye=E.MPNetForQuestionAnswering,$ye=E.MPNetForSequenceClassification,Bye=E.MPNetForTokenClassification,zye=E.MPNetModel,Uye=E.MPNetPreTrainedModel,Vye=E.MPNetTokenizer,Gye=E.MT5ForConditionalGeneration,Wye=E.MT5Model,Hye=E.MT5PreTrainedModel,jye=E.MarianMTModel,qye=E.MarianModel,Kye=E.MarianPreTrainedModel,Yye=E.MarianTokenizer,Xye=E.Mask2FormerImageProcessor,Qye=E.MaskFormerFeatureExtractor,Jye=E.MaskFormerForInstanceSegmentation,Zye=E.MaskFormerImageProcessor,eve=E.MaskFormerModel,tve=E.MaskFormerPreTrainedModel,nve=E.MaskedLMOutput,sve=E.MaxLengthCriteria,ive=E.Metric3DForDepthEstimation,rve=E.Metric3DPreTrainedModel,ove=E.Metric3Dv2ForDepthEstimation,ave=E.Metric3Dv2PreTrainedModel,lve=E.MgpstrForSceneTextRecognition,cve=E.MgpstrModelOutput,dve=E.MgpstrPreTrainedModel,uve=E.MgpstrProcessor,hve=E.MgpstrTokenizer,pve=E.MimiDecoderModel,fve=E.MimiDecoderOutput,mve=E.MimiEncoderModel,gve=E.MimiEncoderOutput,_ve=E.MimiModel,yve=E.MimiPreTrainedModel,vve=E.MinLengthLogitsProcessor,bve=E.MinNewTokensLengthLogitsProcessor,wve=E.Ministral3ForCausalLM,Mve=E.Ministral3Model,Tve=E.Ministral3PreTrainedModel,Eve=E.MinistralForCausalLM,xve=E.MinistralModel,Sve=E.MinistralPreTrainedModel,Cve=E.Mistral3ForConditionalGeneration,Ave=E.MistralForCausalLM,Pve=E.MistralModel,kve=E.MistralPreTrainedModel,Ive=E.MobileBertForMaskedLM,Dve=E.MobileBertForQuestionAnswering,Rve=E.MobileBertForSequenceClassification,Fve=E.MobileBertModel,Lve=E.MobileBertPreTrainedModel,Nve=E.MobileBertTokenizer,Ove=E.MobileLLMForCausalLM,$ve=E.MobileLLMModel,Bve=E.MobileLLMPreTrainedModel,zve=E.MobileNetV1FeatureExtractor,Uve=E.MobileNetV1ForImageClassification,Vve=E.MobileNetV1ForSemanticSegmentation,Gve=E.MobileNetV1ImageProcessor,Wve=E.MobileNetV1Model,Hve=E.MobileNetV1PreTrainedModel,jve=E.MobileNetV2FeatureExtractor,qve=E.MobileNetV2ForImageClassification,Kve=E.MobileNetV2ForSemanticSegmentation,Yve=E.MobileNetV2ImageProcessor,Xve=E.MobileNetV2Model,Qve=E.MobileNetV2PreTrainedModel,Jve=E.MobileNetV3FeatureExtractor,Zve=E.MobileNetV3ForImageClassification,ebe=E.MobileNetV3ForSemanticSegmentation,tbe=E.MobileNetV3ImageProcessor,nbe=E.MobileNetV3Model,sbe=E.MobileNetV3PreTrainedModel,ibe=E.MobileNetV4FeatureExtractor,rbe=E.MobileNetV4ForImageClassification,obe=E.MobileNetV4ForSemanticSegmentation,abe=E.MobileNetV4ImageProcessor,lbe=E.MobileNetV4Model,cbe=E.MobileNetV4PreTrainedModel,dbe=E.MobileViTFeatureExtractor,ube=E.MobileViTForImageClassification,hbe=E.MobileViTImageProcessor,pbe=E.MobileViTModel,fbe=E.MobileViTPreTrainedModel,mbe=E.MobileViTV2ForImageClassification,gbe=E.MobileViTV2Model,_be=E.MobileViTV2PreTrainedModel,ybe=E.ModelOutput,vbe=E.ModernBertDecoderForCausalLM,bbe=E.ModernBertDecoderModel,wbe=E.ModernBertDecoderPreTrainedModel,Mbe=E.ModernBertForMaskedLM,Tbe=E.ModernBertForSequenceClassification,Ebe=E.ModernBertForTokenClassification,xbe=E.ModernBertModel,Sbe=E.ModernBertPreTrainedModel,Cbe=E.Moondream1ForConditionalGeneration,Abe=E.MoonshineFeatureExtractor,Pbe=E.MoonshineForConditionalGeneration,kbe=E.MoonshineModel,Ibe=E.MoonshinePreTrainedModel,Dbe=E.MoonshineProcessor,Rbe=E.MptForCausalLM,Fbe=E.MptModel,Lbe=E.MptPreTrainedModel,Nbe=E.MultiModalityCausalLM,Obe=E.MultiModalityPreTrainedModel,$be=E.MusicgenForCausalLM,Bbe=E.MusicgenForConditionalGeneration,zbe=E.MusicgenModel,Ube=E.MusicgenPreTrainedModel,Vbe=E.NanoChatForCausalLM,Gbe=E.NanoChatModel,Wbe=E.NanoChatPreTrainedModel,Hbe=E.NeoBertForMaskedLM,jbe=E.NeoBertForQuestionAnswering,qbe=E.NeoBertForSequenceClassification,Kbe=E.NeoBertForTokenClassification,Ybe=E.NeoBertModel,Xbe=E.NeoBertPreTrainedModel,Qbe=E.NllbTokenizer,Jbe=E.NoBadWordsLogitsProcessor,Zbe=E.NoRepeatNGramLogitsProcessor,ewe=E.NomicBertModel,twe=E.NomicBertPreTrainedModel,nwe=E.NougatImageProcessor,swe=E.NougatTokenizer,iwe=E.OPTForCausalLM,rwe=E.OPTModel,owe=E.OPTPreTrainedModel,awe=E.ObjectDetectionPipeline,lwe=E.Olmo2ForCausalLM,cwe=E.Olmo2Model,dwe=E.Olmo2PreTrainedModel,uwe=E.OlmoForCausalLM,hwe=E.OlmoModel,pwe=E.OlmoPreTrainedModel,fwe=E.OpenELMForCausalLM,mwe=E.OpenELMModel,gwe=E.OpenELMPreTrainedModel,_we=E.OwlViTFeatureExtractor,ywe=E.OwlViTForObjectDetection,vwe=E.OwlViTImageProcessor,bwe=E.OwlViTModel,wwe=E.OwlViTPreTrainedModel,Mwe=E.OwlViTProcessor,Twe=E.Owlv2ForObjectDetection,Ewe=E.Owlv2ImageProcessor,xwe=E.Owlv2Model,Swe=E.Owlv2PreTrainedModel,Cwe=E.PaliGemmaForConditionalGeneration,Awe=E.PaliGemmaPreTrainedModel,Pwe=E.PaliGemmaProcessor,kwe=E.ParakeetFeatureExtractor,Iwe=E.ParakeetForCTC,Dwe=E.ParakeetPreTrainedModel,Rwe=E.PatchTSMixerForPrediction,Fwe=E.PatchTSMixerModel,Lwe=E.PatchTSMixerPreTrainedModel,Nwe=E.PatchTSTForPrediction,Owe=E.PatchTSTModel,$we=E.PatchTSTPreTrainedModel,Bwe=E.Phi3ForCausalLM,zwe=E.Phi3Model,Uwe=E.Phi3PreTrainedModel,Vwe=E.Phi3VForCausalLM,Gwe=E.Phi3VImageProcessor,Wwe=E.Phi3VPreTrainedModel,Hwe=E.Phi3VProcessor,jwe=E.PhiForCausalLM,qwe=E.PhiModel,Kwe=E.PhiPreTrainedModel,Ywe=E.Pipeline,Xwe=E.PixtralImageProcessor,Qwe=E.PixtralProcessor,Jwe=E.PreTrainedModel,Zwe=E.PreTrainedTokenizer,eMe=E.PretrainedConfig,tMe=E.PretrainedMixin,nMe=E.Processor,sMe=E.PvtForImageClassification,iMe=E.PvtImageProcessor,rMe=E.PvtModel,oMe=E.PvtPreTrainedModel,aMe=E.PyAnnoteFeatureExtractor,lMe=E.PyAnnoteForAudioFrameClassification,cMe=E.PyAnnoteModel,dMe=E.PyAnnotePreTrainedModel,uMe=E.PyAnnoteProcessor,hMe=E.QuestionAnsweringModelOutput,pMe=E.QuestionAnsweringPipeline,fMe=E.Qwen2ForCausalLM,mMe=E.Qwen2Model,gMe=E.Qwen2PreTrainedModel,_Me=E.Qwen2Tokenizer,yMe=E.Qwen2VLForConditionalGeneration,vMe=E.Qwen2VLImageProcessor,bMe=E.Qwen2VLPreTrainedModel,wMe=E.Qwen2VLProcessor,MMe=E.Qwen3ForCausalLM,TMe=E.Qwen3Model,EMe=E.Qwen3PreTrainedModel,xMe=E.RFDetrForObjectDetection,SMe=E.RFDetrModel,CMe=E.RFDetrObjectDetectionOutput,AMe=E.RFDetrPreTrainedModel,PMe=E.RTDetrForObjectDetection,kMe=E.RTDetrImageProcessor,IMe=E.RTDetrModel,DMe=E.RTDetrObjectDetectionOutput,RMe=E.RTDetrPreTrainedModel,FMe=E.RTDetrV2ForObjectDetection,LMe=E.RTDetrV2Model,NMe=E.RTDetrV2ObjectDetectionOutput,OMe=E.RTDetrV2PreTrainedModel,$Me=E.RawAudio,BMe=E.RawImage,zMe=E.RawVideo,UMe=E.RawVideoFrame,VMe=E.RepetitionPenaltyLogitsProcessor,GMe=E.ResNetForImageClassification,WMe=E.ResNetModel,HMe=E.ResNetPreTrainedModel,jMe=E.RoFormerForMaskedLM,qMe=E.RoFormerForQuestionAnswering,KMe=E.RoFormerForSequenceClassification,YMe=E.RoFormerForTokenClassification,XMe=E.RoFormerModel,QMe=E.RoFormerPreTrainedModel,JMe=E.RoFormerTokenizer,ZMe=E.RobertaForMaskedLM,eTe=E.RobertaForQuestionAnswering,tTe=E.RobertaForSequenceClassification,nTe=E.RobertaForTokenClassification,sTe=E.RobertaModel,iTe=E.RobertaPreTrainedModel,rTe=E.RobertaTokenizer,oTe=E.Sam2ImageProcessor,aTe=E.Sam2ImageSegmentationOutput,lTe=E.Sam2Model,cTe=E.Sam2PreTrainedModel,dTe=E.Sam2Processor,uTe=E.Sam2VideoProcessor,hTe=E.Sam3ImageProcessor,pTe=E.Sam3TrackerModel,fTe=E.SamImageProcessor,mTe=E.SamImageSegmentationOutput,gTe=E.SamModel,_Te=E.SamPreTrainedModel,yTe=E.SamProcessor,vTe=E.SapiensForDepthEstimation,bTe=E.SapiensForNormalEstimation,wTe=E.SapiensForSemanticSegmentation,MTe=E.SapiensPreTrainedModel,TTe=E.SeamlessM4TFeatureExtractor,ETe=E.SegformerFeatureExtractor,xTe=E.SegformerForImageClassification,STe=E.SegformerForSemanticSegmentation,CTe=E.SegformerImageProcessor,ATe=E.SegformerModel,PTe=E.SegformerPreTrainedModel,kTe=E.Seq2SeqLMOutput,ITe=E.SequenceClassifierOutput,DTe=E.SiglipImageProcessor,RTe=E.SiglipModel,FTe=E.SiglipPreTrainedModel,LTe=E.SiglipTextModel,NTe=E.SiglipTokenizer,OTe=E.SiglipVisionModel,$Te=E.SmolLM3ForCausalLM,BTe=E.SmolLM3Model,zTe=E.SmolLM3PreTrainedModel,UTe=E.SmolVLMForConditionalGeneration,VTe=E.SmolVLMImageProcessor,GTe=E.SmolVLMProcessor,WTe=E.SnacDecoderModel,HTe=E.SnacEncoderModel,jTe=E.SnacFeatureExtractor,qTe=E.SnacModel,KTe=E.SnacPreTrainedModel,YTe=E.SpeechT5FeatureExtractor,XTe=E.SpeechT5ForSpeechToText,QTe=E.SpeechT5ForTextToSpeech,JTe=E.SpeechT5HifiGan,ZTe=E.SpeechT5Model,eEe=E.SpeechT5PreTrainedModel,tEe=E.SpeechT5Processor,nEe=E.SpeechT5Tokenizer,sEe=E.SqueezeBertForMaskedLM,iEe=E.SqueezeBertForQuestionAnswering,rEe=E.SqueezeBertForSequenceClassification,oEe=E.SqueezeBertModel,aEe=E.SqueezeBertPreTrainedModel,lEe=E.SqueezeBertTokenizer,cEe=E.StableLmForCausalLM,dEe=E.StableLmModel,uEe=E.StableLmPreTrainedModel,hEe=E.Starcoder2ForCausalLM,pEe=E.Starcoder2Model,fEe=E.Starcoder2PreTrainedModel,mEe=E.StoppingCriteria,gEe=E.StoppingCriteriaList,_Ee=E.StyleTextToSpeech2Model,yEe=E.StyleTextToSpeech2PreTrainedModel,vEe=E.SummarizationPipeline,bEe=E.SupertonicForConditionalGeneration,wEe=E.SupertonicPreTrainedModel,MEe=E.SuppressTokensAtBeginLogitsProcessor,TEe=E.Swin2SRForImageSuperResolution,EEe=E.Swin2SRImageProcessor,xEe=E.Swin2SRModel,SEe=E.Swin2SRPreTrainedModel,CEe=E.SwinForImageClassification,AEe=E.SwinForSemanticSegmentation,PEe=E.SwinModel,kEe=E.SwinPreTrainedModel,IEe=E.T5ForConditionalGeneration,DEe=E.T5Model,REe=E.T5PreTrainedModel,FEe=E.T5Tokenizer,LEe=E.TableTransformerForObjectDetection,NEe=E.TableTransformerModel,OEe=E.TableTransformerObjectDetectionOutput,$Ee=E.TableTransformerPreTrainedModel,BEe=E.TemperatureLogitsWarper,zEe=E.Tensor,UEe=E.Text2TextGenerationPipeline,VEe=E.TextClassificationPipeline,GEe=E.TextGenerationPipeline,WEe=E.TextStreamer,HEe=E.TextToAudioPipeline,jEe=E.TokenClassificationPipeline,qEe=E.TokenClassifierOutput,KEe=E.TokenizerModel,YEe=E.TopKLogitsWarper,XEe=E.TopPLogitsWarper,QEe=E.TrOCRForCausalLM,JEe=E.TrOCRPreTrainedModel,ZEe=E.TranslationPipeline,e0e=E.UltravoxModel,t0e=E.UltravoxPreTrainedModel,n0e=E.UltravoxProcessor,s0e=E.UniSpeechForCTC,i0e=E.UniSpeechForSequenceClassification,r0e=E.UniSpeechModel,o0e=E.UniSpeechPreTrainedModel,a0e=E.UniSpeechSatForAudioFrameClassification,l0e=E.UniSpeechSatForCTC,c0e=E.UniSpeechSatForSequenceClassification,d0e=E.UniSpeechSatModel,u0e=E.UniSpeechSatPreTrainedModel,h0e=E.VLChatProcessor,p0e=E.VLMImageProcessor,f0e=E.VaultGemmaForCausalLM,m0e=E.VaultGemmaModel,g0e=E.VaultGemmaPreTrainedModel,_0e=E.ViTFeatureExtractor,y0e=E.ViTForImageClassification,v0e=E.ViTImageProcessor,b0e=E.ViTMAEModel,w0e=E.ViTMAEPreTrainedModel,M0e=E.ViTMSNForImageClassification,T0e=E.ViTMSNModel,E0e=E.ViTMSNPreTrainedModel,x0e=E.ViTModel,S0e=E.ViTPreTrainedModel,C0e=E.VisionEncoderDecoderModel,A0e=E.VitMatteForImageMatting,P0e=E.VitMatteImageProcessor,k0e=E.VitMattePreTrainedModel,I0e=E.VitPoseForPoseEstimation,D0e=E.VitPoseImageProcessor,R0e=E.VitPosePreTrainedModel,F0e=E.VitsModel,L0e=E.VitsModelOutput,N0e=E.VitsPreTrainedModel,O0e=E.VitsTokenizer,$0e=E.VoxtralForConditionalGeneration,B0e=E.VoxtralProcessor,z0e=E.Wav2Vec2BertForCTC,U0e=E.Wav2Vec2BertForSequenceClassification,V0e=E.Wav2Vec2BertModel,G0e=E.Wav2Vec2BertPreTrainedModel,W0e=E.Wav2Vec2CTCTokenizer,H0e=E.Wav2Vec2FeatureExtractor,j0e=E.Wav2Vec2ForAudioFrameClassification,q0e=E.Wav2Vec2ForCTC,K0e=E.Wav2Vec2ForSequenceClassification,Y0e=E.Wav2Vec2Model,X0e=E.Wav2Vec2PreTrainedModel,Q0e=E.Wav2Vec2Processor,J0e=E.Wav2Vec2ProcessorWithLM,Z0e=E.WavLMForAudioFrameClassification,exe=E.WavLMForCTC,txe=E.WavLMForSequenceClassification,nxe=E.WavLMForXVector,sxe=E.WavLMModel,ixe=E.WavLMPreTrainedModel,rxe=E.WeSpeakerFeatureExtractor,oxe=E.WeSpeakerResNetModel,axe=E.WeSpeakerResNetPreTrainedModel,lxe=E.WhisperFeatureExtractor,cxe=E.WhisperForConditionalGeneration,dxe=E.WhisperModel,uxe=E.WhisperPreTrainedModel,hxe=E.WhisperProcessor,pxe=E.WhisperTextStreamer,fxe=E.WhisperTimeStampLogitsProcessor,mxe=E.WhisperTokenizer,gxe=E.XLMForQuestionAnswering,_xe=E.XLMForSequenceClassification,yxe=E.XLMForTokenClassification,vxe=E.XLMModel,bxe=E.XLMPreTrainedModel,wxe=E.XLMRobertaForMaskedLM,Mxe=E.XLMRobertaForQuestionAnswering,Txe=E.XLMRobertaForSequenceClassification,Exe=E.XLMRobertaForTokenClassification,xxe=E.XLMRobertaModel,Sxe=E.XLMRobertaPreTrainedModel,Cxe=E.XLMRobertaTokenizer,Axe=E.XLMTokenizer,Pxe=E.XLMWithLMHeadModel,kxe=E.XVectorOutput,Ixe=E.YolosFeatureExtractor,Dxe=E.YolosForObjectDetection,Rxe=E.YolosImageProcessor,Fxe=E.YolosModel,Lxe=E.YolosObjectDetectionOutput,Nxe=E.YolosPreTrainedModel,Oxe=E.ZeroShotAudioClassificationPipeline,$xe=E.ZeroShotClassificationPipeline,Bxe=E.ZeroShotImageClassificationPipeline,zxe=E.ZeroShotObjectDetectionPipeline,Uxe=E.bankers_round,Vxe=E.cat,Gxe=E.cos_sim,Wxe=E.dot,Hxe=E.dynamic_time_warping,dv=E.env,jxe=E.full,qxe=E.full_like,Kxe=E.getCacheShapes,Yxe=E.hamming,Xxe=E.hanning,Qxe=E.interpolate,Jxe=E.interpolate_4d,Zxe=E.interpolate_data,eSe=E.is_chinese_char,tSe=E.layer_norm,nSe=E.load_image,sSe=E.load_video,iSe=E.log_softmax,rSe=E.magnitude,oSe=E.matmul,aSe=E.max,lSe=E.mean,cSe=E.mean_pooling,dSe=E.medianFilter,uSe=E.mel_filter_bank,hSe=E.min,pSe=E.ones,fSe=E.ones_like,mSe=E.permute,gSe=E.permute_data,Z0=E.pipeline,_Se=E.quantize_embeddings,ySe=E.rand,vSe=E.randn,bSe=E.read_audio,wSe=E.rfft,MSe=E.round,TSe=E.slice,ESe=E.softmax,xSe=E.spectrogram,SSe=E.stack,CSe=E.std_mean,ASe=E.topk,PSe=E.window_function,kSe=E.zeros,ISe=E.zeros_like;dv.allowLocalModels=!0;dv.useBrowserCache=!0;var A1="onnx-community/embeddinggemma-300m-ONNX",P1={dtype:"q8",device:"cpu"};async function lse(){console.log("[PoC] Step 1: Transformers.js \uB85C\uB4DC \uD14C\uC2A4\uD2B8");try{if(typeof Z0!="function")throw new Error("pipeline \uD568\uC218\uB97C \uCC3E\uC744 \uC218 \uC5C6\uC74C");return console.log("[PoC] Transformers.js \uB85C\uB4DC \uC131\uACF5"),console.log("[PoC] env.allowLocalModels:",dv.allowLocalModels),console.log("[PoC] env.useBrowserCache:",dv.useBrowserCache),{success:!0}}catch(s){return console.error("[PoC] Transformers.js \uB85C\uB4DC \uC2E4\uD328:",s),{success:!1,error:s instanceof Error?s.message:String(s)}}}async function cse(s="\uC81C\uD154\uCE74\uC2A4\uD150\uC740 \uC9C0\uC2DD \uAD00\uB9AC \uC2DC\uC2A4\uD15C\uC785\uB2C8\uB2E4."){console.log("[PoC] Step 2: EmbeddingGemma \uBAA8\uB378 \uB85C\uB4DC \uBC0F \uCD94\uB860 \uD14C\uC2A4\uD2B8"),console.log("[PoC] \uD14C\uC2A4\uD2B8 \uD14D\uC2A4\uD2B8:",s),console.log("[PoC] \uBAA8\uB378:",A1),console.log("[PoC] \uC635\uC158:",P1);try{let e=performance.now(),t=await Z0("feature-extraction",A1,P1),n=performance.now(),i=Math.round(n-e);console.log(`[PoC] \uBAA8\uB378 \uB85C\uB4DC \uC644\uB8CC: ${i}ms`);let r=performance.now(),o=await t(s,{pooling:"mean",normalize:!0}),a=performance.now(),l=Math.round(a-r);console.log(`[PoC] \uCD94\uB860 \uC644\uB8CC: ${l}ms`);let c=Array.from(o.data),d=c.length;return console.log(`[PoC] \uC784\uBCA0\uB529 \uCC28\uC6D0: ${d}`),console.log("[PoC] \uC784\uBCA0\uB529 \uC0D8\uD50C (\uCC98\uC74C 5\uAC1C):",c.slice(0,5)),{success:!0,loadTimeMs:i,inferenceTimeMs:l,embedding:c,dimensions:d}}catch(e){return console.error("[PoC] EmbeddingGemma \uD14C\uC2A4\uD2B8 \uC2E4\uD328:",e),{success:!1,error:e instanceof Error?e.message:String(e)}}}async function dse(){console.log("[PoC] Step 3: \uD488\uC9C8 \uBE44\uAD50\uC6A9 \uD14C\uC2A4\uD2B8 \uC784\uBCA0\uB529 \uC0DD\uC131");let s=["\uC81C\uD154\uCE74\uC2A4\uD150\uC740 \uC9C0\uC2DD \uAD00\uB9AC \uC2DC\uC2A4\uD15C\uC785\uB2C8\uB2E4.","Zettelkasten is a knowledge management system.","\uC2A4\uB9C8\uD2B8\uD31C\uC5D0\uC11C \uC13C\uC11C \uB370\uC774\uD130\uB97C \uC218\uC9D1\uD569\uB2C8\uB2E4.","\uB18D\uC5C5 IoT \uC2DC\uC2A4\uD15C\uC758 \uC628\uB3C4 \uBAA8\uB2C8\uD130\uB9C1","Python\uC73C\uB85C \uC6F9 \uC2A4\uD06C\uB798\uD551\uD558\uAE30","TypeScript \uD0C0\uC785 \uC2DC\uC2A4\uD15C \uC774\uD574\uD558\uAE30"];try{let e=await Z0("feature-extraction",A1,P1),t=new Map;for(let i of s){let r=await e(i,{pooling:"mean",normalize:!0}),o=Array.from(r.data);t.set(i,o),console.log(`[PoC] "${i.slice(0,20)}..." \uC784\uBCA0\uB529 \uC644\uB8CC`)}console.log(`
[PoC] \uC720\uC0AC\uB3C4 \uC0D8\uD50C:`);let n=Array.from(t.keys());for(let i=0;i<Math.min(3,n.length);i++)for(let r=i+1;r<Math.min(4,n.length);r++){let o=use(t.get(n[i]),t.get(n[r]));console.log(`[PoC] "${n[i].slice(0,15)}..." \u2194 "${n[r].slice(0,15)}...": ${(o*100).toFixed(1)}%`)}return{embeddings:t,success:!0}}catch(e){return console.error("[PoC] \uD14C\uC2A4\uD2B8 \uC784\uBCA0\uB529 \uC0DD\uC131 \uC2E4\uD328:",e),{embeddings:new Map,success:!1,error:e instanceof Error?e.message:String(e)}}}function use(s,e){let t=0,n=0,i=0;for(let r=0;r<s.length;r++)t+=s[r]*e[r],n+=s[r]*s[r],i+=e[r]*e[r];return t/(Math.sqrt(n)*Math.sqrt(i))}async function G5(){if(console.log("=".repeat(60)),console.log("[PoC] Local Embedding PoC \uC2DC\uC791"),console.log("=".repeat(60)),!(await lse()).success){console.error("[PoC] Step 1 \uC2E4\uD328 - \uC911\uB2E8");return}let e=await cse();if(!e.success){console.error("[PoC] Step 2 \uC2E4\uD328 - \uC911\uB2E8");return}if(console.log(`
[PoC] Step 2 \uACB0\uACFC:`),console.log(`  - \uBAA8\uB378 \uB85C\uB4DC: ${e.loadTimeMs}ms`),console.log(`  - \uCD94\uB860 \uC2DC\uAC04: ${e.inferenceTimeMs}ms`),console.log(`  - \uCC28\uC6D0 \uC218: ${e.dimensions} (expected: 768)`),!(await dse()).success){console.error("[PoC] Step 3 \uC2E4\uD328");return}console.log(`
`+"=".repeat(60)),console.log("[PoC] PoC \uC644\uB8CC - \uBAA8\uB4E0 \uD14C\uC2A4\uD2B8 \uD1B5\uACFC!"),console.log("=".repeat(60))}Yo();var uv=10,W5=100,H5=20,ex=class{constructor(e,t){this.app=e,this.settings=t,this.store={...Bm}}async load(){try{let e=this.getFilePath(),t=this.app.vault.adapter;if(await t.exists(e)){let n=await t.read(e),i=JSON.parse(n);this.store=this.migrate(i)}else this.store={...Bm}}catch(e){console.error("Failed to load feedback store:",e),this.store={...Bm}}}async save(){try{let e=this.getFilePath(),t=this.app.vault.adapter;if(this.settings.dataStorageLocation==="vault"){let n=this.settings.dataFolderPath;await t.exists(n)||await t.mkdir(n)}this.store.lastUpdated=new Date().toISOString(),await t.write(e,JSON.stringify(this.store,null,2))}catch(e){console.error("Failed to save feedback store:",e)}}getFilePath(){return this.settings.dataStorageLocation==="vault"?`${this.settings.dataFolderPath}/${Dr.FEEDBACK}`:`${zh}/${Dr.FEEDBACK}`}migrate(e){return!e.version||e.version<1?{version:1,entries:e.entries||[],preferences:this.migratePreferences(e.preferences),lastUpdated:e.lastUpdated||new Date().toISOString()}:(e.preferences=this.migratePreferences(e.preferences),e)}migratePreferences(e){let t={...iw};return e?{version:e.version||t.version,feedback:{referenceLocation:{...t.feedback.referenceLocation,...e.feedback?.referenceLocation},scheduleDetection:{...t.feedback.scheduleDetection,...e.feedback?.scheduleDetection},projectClassification:{...t.feedback.projectClassification,...e.feedback?.projectClassification}},restructure:{...t.restructure,...e.restructure},embedding:{...t.embedding,...e.embedding},rag:{...t.rag,...e.rag,feedbackOnAnswers:{...t.rag.feedbackOnAnswers,...e.rag?.feedbackOnAnswers}}}:t}addFeedback(e){this.store.entries.push(e),this.store.entries.length>W5&&(this.store.entries=this.store.entries.slice(-W5)),this.updatePreferences(e),this.save()}updatePreferences(e){if(!e.userChoice.dismissed)switch(e.type){case"reference_location":this.updateReferencePreference(e);break;case"schedule_detection":this.updateSchedulePreference(e);break;case"related_notes":this.updateRelatedNotesPreference(e);break;case"project_classification":this.updateProjectClassificationPreference(e);break;case"content_restructure":this.updateRestructurePreference(e);break;case"rag_chat":this.updateRAGPreference(e);break}}updateReferencePreference(e){let t=this.store.preferences.feedback.referenceLocation;e.userChoice.modified==="library"?t.toLibrary++:e.userChoice.modified==="project"&&t.toProject++;let n=t.toLibrary+t.toProject;if(n>=5){let i=t.toLibrary/n;i>.7?t.preference="library":i<.3?t.preference="project":t.preference="neutral"}}updateSchedulePreference(e){let t=this.store.preferences.feedback.scheduleDetection;e.userChoice.accepted?t.accepted++:t.rejected++,e.userChoice.rejectedItems&&e.userChoice.rejectedItems.length>0}updateRelatedNotesPreference(e){}updateProjectClassificationPreference(e){let t=this.store.preferences.feedback.projectClassification;e.userChoice.modified&&e.aiSuggestion.projectName&&(t.corrections.push({original:e.aiSuggestion.projectName,corrected:e.userChoice.modified,keywords:[]}),t.corrections.length>H5&&(t.corrections=t.corrections.slice(-H5)))}updateRestructurePreference(e){let t=this.store.preferences.restructure;e.userChoice.accepted?t.accepted++:t.rejected++;let n=t.accepted+t.rejected;if(n>=5){let i=t.accepted/n;i>.7?t.preference="restructure":i<.3?t.preference="original":t.preference="neutral"}}updateRAGPreference(e){let t=this.store.preferences.rag;if(e.userChoice.accepted){if(t.feedbackOnAnswers.helpful++,e.aiSuggestion.sources)for(let n of e.aiSuggestion.sources)t.preferredNotes.includes(n)||(t.preferredNotes.push(n),t.preferredNotes.length>10&&t.preferredNotes.shift())}else t.feedbackOnAnswers.notHelpful++}generatePromptContext(){let e=this.store.preferences,t=[],n=e.feedback.referenceLocation;if(n.preference!=="neutral"){let a=n.toLibrary+n.toProject;a>=5&&(n.preference==="library"?t.push(`- \uC678\uBD80 \uCC38\uACE0\uC790\uB8CC\uB294 Library \uC120\uD638 (${a}\uD68C \uC911 ${n.toLibrary}\uD68C)`):t.push(`- \uC678\uBD80 \uCC38\uACE0\uC790\uB8CC\uB294 \uD504\uB85C\uC81D\uD2B8 \uD3F4\uB354 \uC120\uD638 (${a}\uD68C \uC911 ${n.toProject}\uD68C)`))}let i=e.feedback.scheduleDetection;i.falsePositivePatterns.length>0&&t.push(`- \uB2E4\uC74C \uD45C\uD604\uC740 \uC77C\uC815\uC73C\uB85C \uAC10\uC9C0\uD558\uC9C0 \uC54A\uC74C: ${i.falsePositivePatterns.join(", ")}`);let r=e.feedback.projectClassification;r.corrections.length>0&&r.corrections.slice(-3).forEach(l=>{l.keywords.length>0&&t.push(`- "${l.keywords.join(", ")}" \uAD00\uB828 \uB0B4\uC6A9\uC740 ${l.corrected} \uD504\uB85C\uC81D\uD2B8\uB85C \uBD84\uB958`)});let o=e.restructure;if(o.preference!=="neutral"){let a=o.accepted+o.rejected;a>=5&&(o.preference==="restructure"?t.push(`- \uCF58\uD150\uCE20 \uC7AC\uAD6C\uC131 \uC120\uD638 (${a}\uD68C \uC911 ${o.accepted}\uD68C \uC218\uB77D)`):t.push(`- \uC6D0\uBCF8 \uC720\uC9C0 \uC120\uD638 (${a}\uD68C \uC911 ${o.rejected}\uD68C \uAC70\uBD80)`))}return t.length>0?`

## \uC0AC\uC6A9\uC790 \uC120\uD638\uB3C4 (\uC774\uC804 \uD53C\uB4DC\uBC31 \uAE30\uBC18)
${t.join(`
`)}`:""}getPreferences(){return this.store.preferences}getEntries(){return this.store.entries}getStats(){let e=this.store.preferences.feedback.referenceLocation,t=this.store.preferences.feedback.scheduleDetection;return{totalEntries:this.store.entries.length,referenceDecisions:e.toLibrary+e.toProject,scheduleDecisions:t.accepted+t.rejected,lastUpdated:this.store.lastUpdated}}};var Oc=require("obsidian");var tx=class extends Oc.Modal{constructor(t,n,i){super(t);this.currentStep=1;this.settings={...n},this.onComplete=i}onOpen(){this.contentEl.addClass("zfb-onboarding"),this.renderStep(1)}onClose(){this.contentEl.empty()}renderStep(t){this.currentStep=t;let{contentEl:n}=this;switch(n.empty(),this.renderProgress(n,t),t){case 1:this.renderStep1(n);break;case 2:this.renderStep2(n);break;case 3:this.renderStep3(n);break;case 4:this.renderStep4(n);break}}renderProgress(t,n){let i=t.createDiv({cls:"onboarding-progress"});for(let r=1;r<=KC;r++)i.createSpan({cls:`progress-dot ${r===n?"active":""} ${r<n?"completed":""}`}).setText(r.toString())}renderStep1(t){t.createEl("h2",{text:"1\uB2E8\uACC4: Gemini API \uD0A4 \uC124\uC815"}),t.createEl("p",{text:"\uC774 \uD50C\uB7EC\uADF8\uC778\uC740 Google Gemini AI\uB97C \uC0AC\uC6A9\uD569\uB2C8\uB2E4. \uBB34\uB8CC\uB85C API \uD0A4\uB97C \uBC1C\uAE09\uBC1B\uC744 \uC218 \uC788\uC2B5\uB2C8\uB2E4."}),t.createEl("a",{text:"\u{1F4D6} API \uD0A4 \uBC1C\uAE09 \uAC00\uC774\uB4DC (Google AI Studio)",href:$B}).setAttr("target","_blank"),new Oc.Setting(t).setName("Gemini API \uD0A4").setDesc("Google AI Studio\uC5D0\uC11C \uBC1C\uAE09\uBC1B\uC740 \uD0A4\uB97C \uC785\uB825\uD558\uC138\uC694").addText(i=>i.setPlaceholder("AIza...").setValue(this.settings.geminiApiKey).onChange(r=>{this.settings.geminiApiKey=r})),this.renderNavButtons(t,1)}renderStep2(t){t.createEl("h2",{text:"2\uB2E8\uACC4: \uD3F4\uB354 \uAD6C\uC870 \uC124\uC815"}),t.createEl("p",{text:"\uB178\uD2B8\uB97C \uC815\uB9AC\uD560 \uD3F4\uB354 \uAD6C\uC870\uB97C \uC790\uB3D9\uC73C\uB85C \uC0DD\uC131\uD569\uB2C8\uB2E4."});let n=t.createDiv({cls:"folder-preview"});n.innerHTML=`
			<pre>\u{1F4C1} 00 _Inbox/        \u2190 \uC5EC\uAE30\uC5D0 \uC4F0\uAE30\uB9CC \uD558\uC138\uC694
\u{1F4C1} 01 Projects/      \u2190 AI\uAC00 \uD504\uB85C\uC81D\uD2B8\uBCC4\uB85C \uC815\uB9AC
\u{1F4C1} 02 Library/       \u2190 \uCC38\uACE0\uC790\uB8CC \uBAA8\uC74C
\u{1F4C1} 03 Archives/      \u2190 \uC644\uB8CC\uB41C \uD56D\uBAA9
\u{1F4C1} 10 Zettelkasten/  \u2190 \uC601\uAD6C \uB178\uD2B8</pre>
		`,new Oc.Setting(t).setName("\uD3F4\uB354 \uAD6C\uC870 \uC0DD\uC131").setDesc("\uC704 \uAD6C\uC870\uB85C \uD3F4\uB354\uB97C \uC790\uB3D9 \uC0DD\uC131\uD569\uB2C8\uB2E4").addButton(i=>i.setButtonText("\uD3F4\uB354 \uC0DD\uC131").setCta().onClick(async()=>{await this.createFolderStructure(),new Oc.Notice("\uD3F4\uB354 \uAD6C\uC870\uAC00 \uC0DD\uC131\uB418\uC5C8\uC2B5\uB2C8\uB2E4!"),i.setButtonText("\u2713 \uC644\uB8CC"),i.setDisabled(!0)})),this.renderNavButtons(t,2)}renderStep3(t){t.createEl("h2",{text:"3\uB2E8\uACC4: \uC0AC\uC6A9 \uBAA8\uB4DC \uC120\uD0DD"}),t.createEl("p",{text:"\uC0AC\uC6A9 \uD328\uD134\uC5D0 \uB9DE\uB294 \uBAA8\uB4DC\uB97C \uC120\uD0DD\uD558\uC138\uC694. \uB098\uC911\uC5D0 \uC124\uC815\uC5D0\uC11C \uBCC0\uACBD\uD560 \uC218 \uC788\uC2B5\uB2C8\uB2E4."});let n=t.createDiv({cls:"preset-cards"}),i=["basic","power","experimental"];for(let r of i){let o=Vi[r],a=this.settings.preset===r,l=n.createDiv({cls:`preset-card ${a?"selected":""}`});l.createDiv({text:o.icon,cls:"preset-icon"}),l.createDiv({text:o.label,cls:"preset-label"}),l.createDiv({text:o.longDesc,cls:"preset-desc"}),l.addEventListener("click",()=>{n.querySelectorAll(".preset-card").forEach(c=>c.removeClass("selected")),l.addClass("selected"),this.applyPreset(r)})}this.renderNavButtons(t,3)}renderStep4(t){t.createEl("h2",{text:"4\uB2E8\uACC4: \uC2DC\uC791\uD558\uAE30"}),t.createEl("p",{text:"\uC124\uC815\uC774 \uC644\uB8CC\uB418\uC5C8\uC2B5\uB2C8\uB2E4! \uC774\uC81C \uC0AC\uC6A9\uD574\uBCF4\uC138\uC694."});let n=t.createDiv({cls:"tips-container"});n.innerHTML=`
			<div class="tip">
				<strong>\u{1F4DD} \uB178\uD2B8 \uBD84\uB958</strong>
				<p>_Inbox\uC5D0 \uB178\uD2B8 \uC791\uC131 \u2192 <kbd>Ctrl+Shift+G</kbd></p>
			</div>
			<div class="tip">
				<strong>\u{1F517} URL \uC694\uC57D</strong>
				<p>\uB178\uD2B8\uC5D0 URL \uBD99\uC5EC\uB123\uAE30 \u2192 <kbd>Ctrl+Shift+U</kbd></p>
			</div>
			<div class="tip">
				<strong>\u{1F916} AI \uCC57\uBD07</strong>
				<p><kbd>Ctrl+Shift+'</kbd>\uB85C \uCC57\uBD07 \uC5F4\uAE30</p>
			</div>
		`;let i=t.createDiv({cls:"modal-button-container"});i.createEl("button",{text:"\uC774\uC804"}).addEventListener("click",()=>this.renderStep(3)),i.createEl("button",{text:"\uC2DC\uC791\uD558\uAE30",cls:"mod-cta"}).addEventListener("click",()=>{this.settings.onboardingCompleted=!0,this.onComplete(this.settings),this.close()})}renderNavButtons(t,n){let i=t.createDiv({cls:"modal-button-container"});n>1&&i.createEl("button",{text:"\uC774\uC804"}).addEventListener("click",()=>this.renderStep(n-1)),n<KC&&i.createEl("button",{text:"\uB2E4\uC74C",cls:"mod-cta"}).addEventListener("click",()=>{if(n===1&&!this.settings.geminiApiKey){new Oc.Notice("API \uD0A4\uB97C \uC785\uB825\uD574\uC8FC\uC138\uC694");return}this.renderStep(n+1)})}async createFolderStructure(){let t=[this.settings.inboxFolder,this.settings.projectsFolder,this.settings.libraryFolder,this.settings.archivesFolder,this.settings.zettelFolder];for(let n of t)await this.app.vault.adapter.exists(n)||await this.app.vault.createFolder(n)}applyPreset(t){this.settings.preset=t;let n=dw[t];for(let[i,r]of Object.entries(n))uw.includes(i)||(this.settings[i]=r)}};var ba=require("obsidian");var hv=class{constructor(e,t){this.dayCache=new Map;this.allEventsCache=[];this.fileEventMap=new Map;this.initialized=!1;this.changeListeners=new Set;this.vaultEventRefs=[];this.app=e,this.settings=t}async initialize(){if(this.initialized)return;let e=this.app.vault.getMarkdownFiles();for(let t of e){let n=await this.extractEventsFromFile(t);n.length>0&&(this.fileEventMap.set(t.path,n),this.allEventsCache.push(...n))}this.initialized=!0,this.registerVaultEvents()}registerVaultEvents(){let e=this.app.vault.on("create",async r=>{r instanceof ba.TFile&&r.extension==="md"&&await this.reloadFile(r)});this.vaultEventRefs.push(e);let t=this.app.vault.on("modify",async r=>{r instanceof ba.TFile&&r.extension==="md"&&await this.reloadFile(r)});this.vaultEventRefs.push(t);let n=this.app.vault.on("delete",r=>{r instanceof ba.TFile&&(this.invalidateFile(r.path),this.notifyListeners())});this.vaultEventRefs.push(n);let i=this.app.vault.on("rename",async(r,o)=>{r instanceof ba.TFile&&r.extension==="md"&&(this.invalidateFile(o),await this.reloadFile(r))});this.vaultEventRefs.push(i)}unregisterVaultEvents(){for(let e of this.vaultEventRefs)this.app.vault.offref(e);this.vaultEventRefs=[]}async reloadFile(e){this.invalidateFile(e.path);let t=await this.extractEventsFromFile(e);t.length>0&&(this.fileEventMap.set(e.path,t),this.allEventsCache.push(...t)),this.dayCache.clear(),this.notifyListeners()}invalidateFile(e){this.fileEventMap.get(e)&&(this.allEventsCache=this.allEventsCache.filter(n=>!n.source.path.startsWith(e)),this.fileEventMap.delete(e)),this.dayCache.clear()}addChangeListener(e){this.changeListeners.add(e)}removeChangeListener(e){this.changeListeners.delete(e)}notifyListeners(){for(let e of this.changeListeners)e()}updateSettings(e){this.settings=e}invalidateCache(){this.dayCache.clear(),this.allEventsCache=[],this.fileEventMap.clear(),this.initialized=!1}async getEventsForRange(e,t){return this.initialized||await this.initialize(),this.allEventsCache.filter(n=>n.start>=e&&n.start<=t)}async getEventsForDay(e){if(this.dayCache.has(e))return this.dayCache.get(e);let t=await this.getEventsForRange(new Date(e+"T00:00:00"),new Date(e+"T23:59:59")),n={date:e,notes:t.filter(i=>i.type==="note"),schedules:t.filter(i=>i.type==="schedule"),meetings:t.filter(i=>i.type==="meeting"),total:t.length};return this.dayCache.set(e,n),n}async getEventCountsForMonth(e,t){let n=new Map,i=new Date(e,t,1),r=new Date(e,t+1,0,23,59,59),o=await this.getEventsForRange(i,r);for(let a of o){let l=$s(a.start,this.settings.timezone);n.set(l,(n.get(l)||0)+1)}return n}async extractEventsFromFile(e){let t=[],n=await this.app.vault.cachedRead(e),i=this.parseFrontmatter(n),r=this.determineFileType(e,i),o=this.getEventDate(e,i);if(!o)return t;if(r==="meeting")t.push(this.createEvent(e,i,o,"meeting"));else if(this.isDailyNote(e)){let a=this.extractSchedulesFromDailyNote(e,n,o);t.push(...a)}else t.push(this.createEvent(e,i,o,"note"));return t}parseFrontmatter(e){let t=e.match(/^---\n([\s\S]*?)\n---/);if(!t)return{};try{return(0,ba.parseYaml)(t[1])||{}}catch{return{}}}determineFileType(e,t){return t.type==="meeting"||e.path.includes("\uD68C\uC758\uB85D")||e.path.includes("Meeting")?"meeting":this.isDailyNote(e)?"schedule":"note"}isDailyNote(e){let t=this.settings.dailyNotesFolder;return e.path.startsWith(t)}getEventDate(e,t){let n=["date","created","meetingDate"];for(let r of n){let o=t[r];if(o){let a=this.parseDate(o);if(a)return a}}let i=e.basename.match(/^(\d{4}-\d{2}-\d{2})$/);return i?new Date(i[1]+"T00:00:00"):new Date(e.stat.ctime)}parseDate(e){let t=e.match(/^(\d{4}-\d{2}-\d{2})/);if(t)return new Date(t[1]+"T00:00:00");let n=new Date(e);return isNaN(n.getTime())?null:n}createEvent(e,t,n,i){let r=t.title||e.basename,o=this.getProjectFromPath(e.path),a={note:"var(--interactive-accent)",schedule:"var(--text-success)",meeting:"var(--text-warning)"};return{id:e.path,title:r,start:n,allDay:i==="note"||i==="meeting",type:i,color:a[i],source:{path:e.path},metadata:{project:o,tags:t.tags||[],summary:t.summary||void 0}}}extractSchedulesFromDailyNote(e,t,n){let i=[],r=t.split(`
`);for(let o=0;o<r.length;o++){let a=r[o];if(a.match(/^- \[[ x]\]/)){let l=a.match(/^- \[[ x]\] (\d{1,2}:\d{2})?\s*(.+?)(?:\s+[]\s*(\d{4}-\d{2}-\d{2}))?$/);if(l){let c=l[1],u=l[2].trim().replace(/\s*\(from \[\[.+?\]\]\)\s*$/,"").trim(),h=l[3],p;if(h?p=new Date(h+"T00:00:00"):p=new Date(n),c){let[f,_]=c.split(":").map(Number);p.setHours(f,_,0,0)}i.push({id:`${e.path}:${o}`,title:u,start:p,allDay:!c,type:"schedule",color:"var(--text-success)",source:{path:e.path,lineNumber:o+1},metadata:{project:this.getProjectFromPath(e.path)}})}}}return i}getProjectFromPath(e){let t=this.settings.projectsFolder;if(e.startsWith(t+"/")){let n=e.substring(t.length+1),i=n.indexOf("/");if(i>0)return n.substring(0,i)}}hasTimeComponent(e){return e.getHours()!==0||e.getMinutes()!==0}async moveEvent(e,t){let[n,i]=e.split(":"),r=this.app.vault.getAbstractFileByPath(n);if(!(r instanceof ba.TFile))return!1;let o=await this.app.vault.read(r);if(i){let a=parseInt(i)-1,l=o.split(`
`);if(a>=0&&a<l.length){let c=l[a],d=$s(t,this.settings.timezone),u=c.replace(/[]\s*\d{4}-\d{2}-\d{2}/,`\u{1F4C5} ${d}`);if(u!==c)return l[a]=u,await this.app.vault.modify(r,l.join(`
`)),this.invalidateCache(),!0}}else{let a=$s(t,this.settings.timezone),l=this.updateFrontmatterDate(o,a);if(l!==o)return await this.app.vault.modify(r,l),this.invalidateCache(),!0}return!1}updateFrontmatterDate(e,t){let n=e.match(/^---\n([\s\S]*?)\n---/);if(!n)return e;let i=n[1],r;return i.includes("date:")?r=i.replace(/date:\s*.*/,`date: ${t}`):r=`date: ${t}
${i}`,e.replace(/^---\n[\s\S]*?\n---/,`---
${r}
---`)}async deleteEvent(e){let[t,n]=e.split(":"),i=this.app.vault.getAbstractFileByPath(t);if(!(i instanceof ba.TFile))return!1;if(n){let r=parseInt(n)-1,a=(await this.app.vault.read(i)).split(`
`);if(r>=0&&r<a.length)return a.splice(r,1),await this.app.vault.modify(i,a.join(`
`)),this.invalidateCache(),!0}else return!1;return!1}async openEvent(e){let[t,n]=e.split(":"),i=this.app.vault.getAbstractFileByPath(t);if(i instanceof ba.TFile){let r=this.app.workspace.getLeaf();if(await r.openFile(i),n){let o=parseInt(n)-1,a=r.view;"editor"in a&&a.editor&&a.editor.setCursor({line:o,ch:0})}}}};var j5=require("obsidian");var $c=require("obsidian"),wa=class extends $c.Modal{constructor(t,n,i,r){super(t);this.onEventClick=null;this.isMobileView=!1;this.modalWidth=400;this.date=n,this.dataProvider=i,this.settings=r}setOnEventClick(t){this.onEventClick=t}async onOpen(){let{contentEl:t,modalEl:n}=this;t.empty(),t.addClass("zfb-calendar-day-modal"),n.addClass("zfb-calendar-day-modal-container");let i=document.querySelector(".workspace"),r=i?.offsetWidth||window.innerWidth,o=Math.min(window.innerWidth,r);if(this.isMobileView=$c.Platform.isMobile||o<500,this.modalWidth=Math.min(o-32,400),this.isMobileView){document.documentElement.style.overflowX="hidden",document.body.style.overflowX="hidden",i&&(i.style.overflowX="hidden");let b=n.parentElement;b&&(b.style.setProperty("overflow-x","hidden","important"),b.style.setProperty("width",`${r}px`,"important"),b.style.setProperty("max-width",`${r}px`,"important"),b.style.setProperty("left","auto","important"),b.style.setProperty("right","0","important")),n.style.setProperty("width",`${this.modalWidth}px`,"important"),n.style.setProperty("max-width",`${this.modalWidth}px`,"important"),n.style.setProperty("min-width","0","important"),n.style.setProperty("overflow","hidden","important"),n.style.setProperty("position","relative","important"),n.style.setProperty("left","auto","important"),n.style.setProperty("right","auto","important"),n.style.setProperty("margin","auto","important"),t.style.setProperty("width","100%","important"),t.style.setProperty("max-width","100%","important"),t.style.setProperty("min-width","0","important"),t.style.setProperty("padding","16px","important"),t.style.setProperty("overflow","hidden","important"),t.style.setProperty("box-sizing","border-box","important"),t.style.setProperty("word-break","break-word","important")}t.createEl("p",{text:"\uB85C\uB529 \uC911..."});let a=await this.dataProvider.getEventsForDay(this.date);t.empty();let l=new Date(this.date+"T00:00:00"),d=["\uC77C","\uC6D4","\uD654","\uC218","\uBAA9","\uAE08","\uD1A0"][l.getDay()],u=t.createDiv({cls:"day-modal-header"});u.style.marginBottom="16px",u.style.overflow="hidden",u.style.maxWidth="100%",this.isMobileView&&u.style.setProperty("width",`${this.modalWidth-32}px`,"important");let h=u.createEl("h2",{text:`${this.date} (${d}\uC694\uC77C)`});if(h.style.margin="0",h.style.overflow="hidden",h.style.textOverflow="ellipsis",h.style.whiteSpace="nowrap",this.isMobileView&&h.style.setProperty("max-width",`${this.modalWidth-48}px`,"important"),u.createEl("p",{text:`\uCD1D ${a.total}\uAC1C \uD56D\uBAA9`,cls:"setting-item-description"}).style.margin="4px 0 0 0",a.total===0){let b=t.createDiv({cls:"day-modal-empty"});b.style.padding="32px",b.style.textAlign="center",b.style.color="var(--text-muted)",b.setText("\uC774 \uB0A0\uC9DC\uC5D0 \uB4F1\uB85D\uB41C \uD56D\uBAA9\uC774 \uC5C6\uC2B5\uB2C8\uB2E4.");return}let p=t.createDiv({cls:"day-modal-sections"});p.style.maxHeight=this.isMobileView?"50vh":"400px",p.style.overflowY="auto",p.style.overflowX="hidden",this.isMobileView&&(p.style.setProperty("width",`${this.modalWidth-32}px`,"important"),p.style.setProperty("max-width",`${this.modalWidth-32}px`,"important")),a.schedules.length>0&&this.renderSection(p,"\uC77C\uC815",a.schedules,"schedule"),a.notes.length>0&&this.renderSection(p,"\uB178\uD2B8",a.notes,"note"),a.meetings.length>0&&this.renderSection(p,"\uD68C\uC758\uB85D",a.meetings,"meeting");let f=t.createDiv({cls:"modal-button-container"});f.style.display="flex",f.style.justifyContent="flex-end",f.style.marginTop="16px",f.createEl("button",{text:"\uB2EB\uAE30"}).addEventListener("click",()=>this.close())}renderSection(t,n,i,r){let o={note:"\u{1F4DD}",schedule:"\u23F0",meeting:"\u{1F399}"},a=this.isMobileView?this.modalWidth-56:void 0,l=t.createDiv({cls:"day-section"});l.style.marginBottom="16px",l.style.overflow="hidden",l.style.maxWidth="100%",this.isMobileView&&l.style.setProperty("width",`${this.modalWidth-32}px`,"important");let c=l.createDiv({cls:"section-header"});c.style.display="flex",c.style.alignItems="center",c.style.gap="8px",c.style.marginBottom="8px",c.createEl("span",{text:o[r]}),c.createEl("span",{text:`${n} (${i.length})`}).style.fontWeight="500";let d=l.createDiv({cls:"section-list"});d.style.overflow="hidden",d.style.maxWidth="100%",this.isMobileView&&d.style.setProperty("width",`${this.modalWidth-32}px`,"important");for(let u of i){let h=d.createDiv({cls:"event-item"});h.style.display="flex",h.style.alignItems="center",h.style.padding="8px 12px",h.style.marginBottom="4px",h.style.border="1px solid var(--background-modifier-border)",h.style.borderRadius="6px",h.style.cursor="pointer",h.style.transition="background-color 0.15s",h.style.overflow="hidden",h.style.maxWidth="100%",h.style.boxSizing="border-box",this.isMobileView&&a&&(h.style.setProperty("width",`${a}px`,"important"),h.style.setProperty("max-width",`${a}px`,"important"));let p=h.createDiv({cls:"event-indicator"});p.style.width="4px",p.style.height="24px",p.style.borderRadius="2px",p.style.marginRight="12px",p.style.flexShrink="0",p.style.backgroundColor=u.color||"var(--interactive-accent)";let f=h.createDiv({cls:"event-info"});f.createEl("div",{text:u.title,cls:"event-title"});let _=f.createEl("div",{cls:"event-detail"}),b=[];if(u.allDay)b.push("\uC885\uC77C");else{let y=u.start.getHours().toString().padStart(2,"0"),w=u.start.getMinutes().toString().padStart(2,"0");b.push(`${y}:${w}`)}if(u.metadata?.project&&b.push(u.metadata.project),_.setText(b.join(" | ")),h.addEventListener("mouseenter",()=>{h.style.backgroundColor="var(--background-modifier-hover)"}),h.addEventListener("mouseleave",()=>{h.style.backgroundColor=""}),h.setAttribute("title",u.title),$c.Platform.isMobile||h.addEventListener("mouseover",y=>{(y.ctrlKey||y.metaKey)&&this.app.workspace.trigger("hover-link",{event:y,source:"calendar-day-modal",hoverParent:h,targetEl:h,linktext:u.id})}),$c.Platform.isMobile){let y=null,w=!1;h.addEventListener("touchstart",C=>{w=!1,y=setTimeout(()=>{w=!0,new $c.Notice(u.title,3e3)},500)}),h.addEventListener("touchend",()=>{y&&(clearTimeout(y),y=null)}),h.addEventListener("touchmove",()=>{y&&(clearTimeout(y),y=null)})}h.addEventListener("click",async()=>{this.onEventClick?this.onEventClick(u):(await this.dataProvider.openEvent(u.id),this.close())})}}onClose(){if(this.isMobileView){document.documentElement.style.overflowX="",document.body.style.overflowX="";let t=document.querySelector(".workspace");t&&(t.style.overflowX="")}this.contentEl.empty()}};var Yf="zfb-mini-calendar",pv=class extends j5.ItemView{constructor(t,n,i){super(t);this.eventCounts=new Map;this.settings=n,this.dataProvider=i;let r=new Date;this.currentYear=r.getFullYear(),this.currentMonth=r.getMonth(),this.refreshCallback=()=>this.renderCalendar()}getViewType(){return Yf}getDisplayText(){return"\uCE98\uB9B0\uB354"}getIcon(){return"calendar"}async onOpen(){this.dataProvider.addChangeListener(this.refreshCallback),await this.renderCalendar()}async onClose(){this.dataProvider.removeChangeListener(this.refreshCallback),this.contentEl.empty()}updateSettings(t){this.settings=t,this.renderCalendar()}async renderCalendar(){let t=this.contentEl;t.empty(),t.addClass("zfb-mini-calendar"),this.eventCounts=await this.dataProvider.getEventCountsForMonth(this.currentYear,this.currentMonth),this.renderHeader(t),this.renderWeekdayHeader(t),this.renderDateGrid(t),this.renderTodayButton(t)}renderHeader(t){let n=t.createDiv({cls:"mini-calendar-header"});n.createEl("button",{cls:"nav-btn",text:"<"}).addEventListener("click",()=>this.navigateMonth(-1));let r=["1\uC6D4","2\uC6D4","3\uC6D4","4\uC6D4","5\uC6D4","6\uC6D4","7\uC6D4","8\uC6D4","9\uC6D4","10\uC6D4","11\uC6D4","12\uC6D4"];n.createEl("span",{cls:"month-title",text:`${this.currentYear}\uB144 ${r[this.currentMonth]}`}),n.createEl("button",{cls:"nav-btn",text:">"}).addEventListener("click",()=>this.navigateMonth(1))}renderWeekdayHeader(t){let n=t.createDiv({cls:"weekday-header"}),i=this.settings.calendarFirstDayOfWeek===1?["\uC6D4","\uD654","\uC218","\uBAA9","\uAE08","\uD1A0","\uC77C"]:["\uC77C","\uC6D4","\uD654","\uC218","\uBAA9","\uAE08","\uD1A0"];for(let r of i)n.createEl("span",{text:r})}renderDateGrid(t){let n=t.createDiv({cls:"date-grid"}),i=new Date(this.currentYear,this.currentMonth,1),r=new Date(this.currentYear,this.currentMonth+1,0),o=i.getDay();this.settings.calendarFirstDayOfWeek===1&&(o=o===0?6:o-1);let a=$s(new Date,this.settings.timezone);for(let l=0;l<o;l++)n.createDiv({cls:"date-cell empty"});for(let l=1;l<=r.getDate();l++){let c=`${this.currentYear}-${String(this.currentMonth+1).padStart(2,"0")}-${String(l).padStart(2,"0")}`,d=this.eventCounts.get(c)||0,u=c===a,h=n.createDiv({cls:"date-cell"});if(u&&h.addClass("today"),h.createEl("span",{cls:"day-number",text:String(l)}),d>0){let p=h.createDiv({cls:"event-dots"}),f=Math.min(d,3);for(let _=0;_<f;_++)p.createDiv({cls:"event-dot"})}h.addEventListener("click",()=>{this.openDayModal(c)})}}renderTodayButton(t){t.createDiv({cls:"today-btn-container"}).createEl("button",{cls:"today-btn",text:"\uC624\uB298"}).addEventListener("click",()=>{let r=new Date;this.currentYear=r.getFullYear(),this.currentMonth=r.getMonth(),this.renderCalendar()})}navigateMonth(t){this.currentMonth+=t,this.currentMonth<0?(this.currentMonth=11,this.currentYear--):this.currentMonth>11&&(this.currentMonth=0,this.currentYear++),this.renderCalendar()}openDayModal(t){new wa(this.app,t,this.dataProvider,this.settings).open()}};var bY=require("obsidian");var ox,Ft,Q5,I1,Xf,ih,q5,J5,Z5,sx={},e6=[],hse=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i;function Bc(s,e){for(var t in e)s[t]=e[t];return s}function t6(s){var e=s.parentNode;e&&e.removeChild(s)}function ce(s,e,t){var n,i,r,o={};for(r in e)r=="key"?n=e[r]:r=="ref"?i=e[r]:o[r]=e[r];if(arguments.length>2&&(o.children=arguments.length>3?ox.call(arguments,2):t),typeof s=="function"&&s.defaultProps!=null)for(r in s.defaultProps)o[r]===void 0&&(o[r]=s.defaultProps[r]);return nx(s,o,n,i,null)}function nx(s,e,t,n,i){var r={type:s,props:e,key:t,ref:n,__k:null,__:null,__b:0,__e:null,__d:void 0,__c:null,__h:null,constructor:void 0,__v:i??++Q5};return i==null&&Ft.vnode!=null&&Ft.vnode(r),r}function Rs(){return{current:null}}function gn(s){return s.children}function pse(s,e,t,n,i){var r;for(r in t)r==="children"||r==="key"||r in e||ix(s,r,null,t[r],n);for(r in e)i&&typeof e[r]!="function"||r==="children"||r==="key"||r==="value"||r==="checked"||t[r]===e[r]||ix(s,r,e[r],t[r],n)}function K5(s,e,t){e[0]==="-"?s.setProperty(e,t??""):s[e]=t==null?"":typeof t!="number"||hse.test(e)?t:t+"px"}function ix(s,e,t,n,i){var r;e:if(e==="style")if(typeof t=="string")s.style.cssText=t;else{if(typeof n=="string"&&(s.style.cssText=n=""),n)for(e in n)t&&e in t||K5(s.style,e,"");if(t)for(e in t)n&&t[e]===n[e]||K5(s.style,e,t[e])}else if(e[0]==="o"&&e[1]==="n")r=e!==(e=e.replace(/Capture$/,"")),e=e.toLowerCase()in s?e.toLowerCase().slice(2):e.slice(2),s.l||(s.l={}),s.l[e+r]=t,t?n||s.addEventListener(e,r?X5:Y5,r):s.removeEventListener(e,r?X5:Y5,r);else if(e!=="dangerouslySetInnerHTML"){if(i)e=e.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if(e!=="width"&&e!=="height"&&e!=="href"&&e!=="list"&&e!=="form"&&e!=="tabIndex"&&e!=="download"&&e in s)try{s[e]=t??"";break e}catch{}typeof t=="function"||(t==null||t===!1&&e.indexOf("-")==-1?s.removeAttribute(e):s.setAttribute(e,t))}}function Y5(s){Xf=!0;try{return this.l[s.type+!1](Ft.event?Ft.event(s):s)}finally{Xf=!1}}function X5(s){Xf=!0;try{return this.l[s.type+!0](Ft.event?Ft.event(s):s)}finally{Xf=!1}}function pi(s,e){this.props=s,this.context=e}function fv(s,e){if(e==null)return s.__?fv(s.__,s.__.__k.indexOf(s)+1):null;for(var t;e<s.__k.length;e++)if((t=s.__k[e])!=null&&t.__e!=null)return t.__e;return typeof s.type=="function"?fv(s):null}function n6(s){var e,t;if((s=s.__)!=null&&s.__c!=null){for(s.__e=s.__c.base=null,e=0;e<s.__k.length;e++)if((t=s.__k[e])!=null&&t.__e!=null){s.__e=s.__c.base=t.__e;break}return n6(s)}}function fse(s){Xf?setTimeout(s):J5(s)}function k1(s){(!s.__d&&(s.__d=!0)&&ih.push(s)&&!rx.__r++||q5!==Ft.debounceRendering)&&((q5=Ft.debounceRendering)||fse)(rx)}function rx(){var s,e,t,n,i,r,o,a;for(ih.sort(function(l,c){return l.__v.__b-c.__v.__b});s=ih.shift();)s.__d&&(e=ih.length,n=void 0,i=void 0,o=(r=(t=s).__v).__e,(a=t.__P)&&(n=[],(i=Bc({},r)).__v=r.__v+1,D1(a,r,i,t.__n,a.ownerSVGElement!==void 0,r.__h!=null?[o]:null,n,o??fv(r),r.__h),a6(n,r),r.__e!=o&&n6(r)),ih.length>e&&ih.sort(function(l,c){return l.__v.__b-c.__v.__b}));rx.__r=0}function s6(s,e,t,n,i,r,o,a,l,c){var d,u,h,p,f,_,b,y=n&&n.__k||e6,w=y.length;for(t.__k=[],d=0;d<e.length;d++)if((p=t.__k[d]=(p=e[d])==null||typeof p=="boolean"?null:typeof p=="string"||typeof p=="number"||typeof p=="bigint"?nx(null,p,null,null,p):Array.isArray(p)?nx(gn,{children:p},null,null,null):p.__b>0?nx(p.type,p.props,p.key,p.ref?p.ref:null,p.__v):p)!=null){if(p.__=t,p.__b=t.__b+1,(h=y[d])===null||h&&p.key==h.key&&p.type===h.type)y[d]=void 0;else for(u=0;u<w;u++){if((h=y[u])&&p.key==h.key&&p.type===h.type){y[u]=void 0;break}h=null}D1(s,p,h=h||sx,i,r,o,a,l,c),f=p.__e,(u=p.ref)&&h.ref!=u&&(b||(b=[]),h.ref&&b.push(h.ref,null,p),b.push(u,p.__c||f,p)),f!=null?(_==null&&(_=f),typeof p.type=="function"&&p.__k===h.__k?p.__d=l=i6(p,l,s):l=r6(s,p,h,y,f,l),typeof t.type=="function"&&(t.__d=l)):l&&h.__e==l&&l.parentNode!=s&&(l=fv(h))}for(t.__e=_,d=w;d--;)y[d]!=null&&(typeof t.type=="function"&&y[d].__e!=null&&y[d].__e==t.__d&&(t.__d=o6(n).nextSibling),c6(y[d],y[d]));if(b)for(d=0;d<b.length;d++)l6(b[d],b[++d],b[++d])}function i6(s,e,t){for(var n,i=s.__k,r=0;i&&r<i.length;r++)(n=i[r])&&(n.__=s,e=typeof n.type=="function"?i6(n,e,t):r6(t,n,n,i,n.__e,e));return e}function mv(s,e){return e=e||[],s==null||typeof s=="boolean"||(Array.isArray(s)?s.some(function(t){mv(t,e)}):e.push(s)),e}function r6(s,e,t,n,i,r){var o,a,l;if(e.__d!==void 0)o=e.__d,e.__d=void 0;else if(t==null||i!=r||i.parentNode==null)e:if(r==null||r.parentNode!==s)s.appendChild(i),o=null;else{for(a=r,l=0;(a=a.nextSibling)&&l<n.length;l+=1)if(a==i)break e;s.insertBefore(i,r),o=r}return o!==void 0?o:i.nextSibling}function o6(s){var e,t,n;if(s.type==null||typeof s.type=="string")return s.__e;if(s.__k){for(e=s.__k.length-1;e>=0;e--)if((t=s.__k[e])&&(n=o6(t)))return n}return null}function D1(s,e,t,n,i,r,o,a,l){var c,d,u,h,p,f,_,b,y,w,C,M,S,k,T,P=e.type;if(e.constructor!==void 0)return null;t.__h!=null&&(l=t.__h,a=e.__e=t.__e,e.__h=null,r=[a]),(c=Ft.__b)&&c(e);try{e:if(typeof P=="function"){if(b=e.props,y=(c=P.contextType)&&n[c.__c],w=c?y?y.props.value:c.__:n,t.__c?_=(d=e.__c=t.__c).__=d.__E:("prototype"in P&&P.prototype.render?e.__c=d=new P(b,w):(e.__c=d=new pi(b,w),d.constructor=P,d.render=gse),y&&y.sub(d),d.props=b,d.state||(d.state={}),d.context=w,d.__n=n,u=d.__d=!0,d.__h=[],d._sb=[]),d.__s==null&&(d.__s=d.state),P.getDerivedStateFromProps!=null&&(d.__s==d.state&&(d.__s=Bc({},d.__s)),Bc(d.__s,P.getDerivedStateFromProps(b,d.__s))),h=d.props,p=d.state,d.__v=e,u)P.getDerivedStateFromProps==null&&d.componentWillMount!=null&&d.componentWillMount(),d.componentDidMount!=null&&d.__h.push(d.componentDidMount);else{if(P.getDerivedStateFromProps==null&&b!==h&&d.componentWillReceiveProps!=null&&d.componentWillReceiveProps(b,w),!d.__e&&d.shouldComponentUpdate!=null&&d.shouldComponentUpdate(b,d.__s,w)===!1||e.__v===t.__v){for(e.__v!==t.__v&&(d.props=b,d.state=d.__s,d.__d=!1),e.__e=t.__e,e.__k=t.__k,e.__k.forEach(function(R){R&&(R.__=e)}),C=0;C<d._sb.length;C++)d.__h.push(d._sb[C]);d._sb=[],d.__h.length&&o.push(d);break e}d.componentWillUpdate!=null&&d.componentWillUpdate(b,d.__s,w),d.componentDidUpdate!=null&&d.__h.push(function(){d.componentDidUpdate(h,p,f)})}if(d.context=w,d.props=b,d.__P=s,M=Ft.__r,S=0,"prototype"in P&&P.prototype.render){for(d.state=d.__s,d.__d=!1,M&&M(e),c=d.render(d.props,d.state,d.context),k=0;k<d._sb.length;k++)d.__h.push(d._sb[k]);d._sb=[]}else do d.__d=!1,M&&M(e),c=d.render(d.props,d.state,d.context),d.state=d.__s;while(d.__d&&++S<25);d.state=d.__s,d.getChildContext!=null&&(n=Bc(Bc({},n),d.getChildContext())),u||d.getSnapshotBeforeUpdate==null||(f=d.getSnapshotBeforeUpdate(h,p)),T=c!=null&&c.type===gn&&c.key==null?c.props.children:c,s6(s,Array.isArray(T)?T:[T],e,t,n,i,r,o,a,l),d.base=e.__e,e.__h=null,d.__h.length&&o.push(d),_&&(d.__E=d.__=null),d.__e=!1}else r==null&&e.__v===t.__v?(e.__k=t.__k,e.__e=t.__e):e.__e=mse(t.__e,e,t,n,i,r,o,l);(c=Ft.diffed)&&c(e)}catch(R){e.__v=null,(l||r!=null)&&(e.__e=a,e.__h=!!l,r[r.indexOf(a)]=null),Ft.__e(R,e,t)}}function a6(s,e){Ft.__c&&Ft.__c(e,s),s.some(function(t){try{s=t.__h,t.__h=[],s.some(function(n){n.call(t)})}catch(n){Ft.__e(n,t.__v)}})}function mse(s,e,t,n,i,r,o,a){var l,c,d,u=t.props,h=e.props,p=e.type,f=0;if(p==="svg"&&(i=!0),r!=null){for(;f<r.length;f++)if((l=r[f])&&"setAttribute"in l==!!p&&(p?l.localName===p:l.nodeType===3)){s=l,r[f]=null;break}}if(s==null){if(p===null)return document.createTextNode(h);s=i?document.createElementNS("http://www.w3.org/2000/svg",p):document.createElement(p,h.is&&h),r=null,a=!1}if(p===null)u===h||a&&s.data===h||(s.data=h);else{if(r=r&&ox.call(s.childNodes),c=(u=t.props||sx).dangerouslySetInnerHTML,d=h.dangerouslySetInnerHTML,!a){if(r!=null)for(u={},f=0;f<s.attributes.length;f++)u[s.attributes[f].name]=s.attributes[f].value;(d||c)&&(d&&(c&&d.__html==c.__html||d.__html===s.innerHTML)||(s.innerHTML=d&&d.__html||""))}if(pse(s,h,u,i,a),d)e.__k=[];else if(f=e.props.children,s6(s,Array.isArray(f)?f:[f],e,t,n,i&&p!=="foreignObject",r,o,r?r[0]:t.__k&&fv(t,0),a),r!=null)for(f=r.length;f--;)r[f]!=null&&t6(r[f]);a||("value"in h&&(f=h.value)!==void 0&&(f!==s.value||p==="progress"&&!f||p==="option"&&f!==u.value)&&ix(s,"value",f,u.value,!1),"checked"in h&&(f=h.checked)!==void 0&&f!==s.checked&&ix(s,"checked",f,u.checked,!1))}return s}function l6(s,e,t){try{typeof s=="function"?s(e):s.current=e}catch(n){Ft.__e(n,t)}}function c6(s,e,t){var n,i;if(Ft.unmount&&Ft.unmount(s),(n=s.ref)&&(n.current&&n.current!==s.__e||l6(n,null,e)),(n=s.__c)!=null){if(n.componentWillUnmount)try{n.componentWillUnmount()}catch(r){Ft.__e(r,e)}n.base=n.__P=null,s.__c=void 0}if(n=s.__k)for(i=0;i<n.length;i++)n[i]&&c6(n[i],e,t||typeof s.type!="function");t||s.__e==null||t6(s.__e),s.__=s.__e=s.__d=void 0}function gse(s,e,t){return this.constructor(s,t)}function zc(s,e,t){var n,i,r;Ft.__&&Ft.__(s,e),i=(n=typeof t=="function")?null:t&&t.__k||e.__k,r=[],D1(e,s=(!n&&t||e).__k=ce(gn,null,[s]),i||sx,sx,e.ownerSVGElement!==void 0,!n&&t?[t]:i?null:e.firstChild?ox.call(e.childNodes):null,r,!n&&t?t:i?i.__e:e.firstChild,n),a6(r,s)}function ax(s,e){var t={__c:e="__cC"+Z5++,__:s,Consumer:function(n,i){return n.children(i)},Provider:function(n){var i,r;return this.getChildContext||(i=[],(r={})[e]=this,this.getChildContext=function(){return r},this.shouldComponentUpdate=function(o){this.props.value!==o.value&&i.some(function(a){a.__e=!0,k1(a)})},this.sub=function(o){i.push(o);var a=o.componentWillUnmount;o.componentWillUnmount=function(){i.splice(i.indexOf(o),1),a&&a.call(o)}}),n.children}};return t.Provider.__=t.Consumer.contextType=t}ox=e6.slice,Ft={__e:function(s,e,t,n){for(var i,r,o;e=e.__;)if((i=e.__c)&&!i.__)try{if((r=i.constructor)&&r.getDerivedStateFromError!=null&&(i.setState(r.getDerivedStateFromError(s)),o=i.__d),i.componentDidCatch!=null&&(i.componentDidCatch(s,n||{}),o=i.__d),o)return i.__E=i}catch(a){s=a}throw s}},Q5=0,I1=function(s){return s!=null&&s.constructor===void 0},Xf=!1,pi.prototype.setState=function(s,e){var t;t=this.__s!=null&&this.__s!==this.state?this.__s:this.__s=Bc({},this.state),typeof s=="function"&&(s=s(Bc({},t),this.props)),s&&Bc(t,s),s!=null&&this.__v&&(e&&this._sb.push(e),k1(this))},pi.prototype.forceUpdate=function(s){this.__v&&(this.__e=!0,s&&this.__h.push(s),k1(this))},pi.prototype.render=gn,ih=[],J5=typeof Promise=="function"?Promise.prototype.then.bind(Promise.resolve()):setTimeout,rx.__r=0,Z5=0;var yse,Ma,R1,d6;var _6=[],F1=[],u6=Ft.__b,h6=Ft.__r,p6=Ft.diffed,f6=Ft.__c,m6=Ft.unmount;function vse(){for(var s;s=_6.shift();)if(s.__P&&s.__H)try{s.__H.__h.forEach(lx),s.__H.__h.forEach(L1),s.__H.__h=[]}catch(e){s.__H.__h=[],Ft.__e(e,s.__v)}}Ft.__b=function(s){Ma=null,u6&&u6(s)},Ft.__r=function(s){h6&&h6(s),yse=0;var e=(Ma=s.__c).__H;e&&(R1===Ma?(e.__h=[],Ma.__h=[],e.__.forEach(function(t){t.__N&&(t.__=t.__N),t.__V=F1,t.__N=t.i=void 0})):(e.__h.forEach(lx),e.__h.forEach(L1),e.__h=[])),R1=Ma},Ft.diffed=function(s){p6&&p6(s);var e=s.__c;e&&e.__H&&(e.__H.__h.length&&(_6.push(e)!==1&&d6===Ft.requestAnimationFrame||((d6=Ft.requestAnimationFrame)||bse)(vse)),e.__H.__.forEach(function(t){t.i&&(t.__H=t.i),t.__V!==F1&&(t.__=t.__V),t.i=void 0,t.__V=F1})),R1=Ma=null},Ft.__c=function(s,e){e.some(function(t){try{t.__h.forEach(lx),t.__h=t.__h.filter(function(n){return!n.__||L1(n)})}catch(n){e.some(function(i){i.__h&&(i.__h=[])}),e=[],Ft.__e(n,t.__v)}}),f6&&f6(s,e)},Ft.unmount=function(s){m6&&m6(s);var e,t=s.__c;t&&t.__H&&(t.__H.__.forEach(function(n){try{lx(n)}catch(i){e=i}}),t.__H=void 0,e&&Ft.__e(e,t.__v))};var g6=typeof requestAnimationFrame=="function";function bse(s){var e,t=function(){clearTimeout(n),g6&&cancelAnimationFrame(e),setTimeout(s)},n=setTimeout(t,100);g6&&(e=requestAnimationFrame(t))}function lx(s){var e=Ma,t=s.__c;typeof t=="function"&&(s.__c=void 0,t()),Ma=e}function L1(s){var e=Ma;s.__c=s.__(),Ma=e}function wse(s,e){for(var t in e)s[t]=e[t];return s}function y6(s,e){for(var t in s)if(t!=="__source"&&!(t in e))return!0;for(var n in e)if(n!=="__source"&&s[n]!==e[n])return!0;return!1}function v6(s){this.props=s}(v6.prototype=new pi).isPureReactComponent=!0,v6.prototype.shouldComponentUpdate=function(s,e){return y6(this.props,s)||y6(this.state,e)};var b6=Ft.__b;Ft.__b=function(s){s.type&&s.type.__f&&s.ref&&(s.props.ref=s.ref,s.ref=null),b6&&b6(s)};var gAe=typeof Symbol<"u"&&Symbol.for&&Symbol.for("react.forward_ref")||3911;var Mse=Ft.__e;Ft.__e=function(s,e,t,n){if(s.then){for(var i,r=e;r=r.__;)if((i=r.__c)&&i.__c)return e.__e==null&&(e.__e=t.__e,e.__k=t.__k),i.__c(s,e)}Mse(s,e,t,n)};var w6=Ft.unmount;function C6(s,e,t){return s&&(s.__c&&s.__c.__H&&(s.__c.__H.__.forEach(function(n){typeof n.__c=="function"&&n.__c()}),s.__c.__H=null),(s=wse({},s)).__c!=null&&(s.__c.__P===t&&(s.__c.__P=e),s.__c=null),s.__k=s.__k&&s.__k.map(function(n){return C6(n,e,t)})),s}function A6(s,e,t){return s&&(s.__v=null,s.__k=s.__k&&s.__k.map(function(n){return A6(n,e,t)}),s.__c&&s.__c.__P===e&&(s.__e&&t.insertBefore(s.__e,s.__d),s.__c.__e=!0,s.__c.__P=t)),s}function N1(){this.__u=0,this.t=null,this.__b=null}function P6(s){var e=s.__.__c;return e&&e.__a&&e.__a(s)}function cx(){this.u=null,this.o=null}Ft.unmount=function(s){var e=s.__c;e&&e.__R&&e.__R(),e&&s.__h===!0&&(s.type=null),w6&&w6(s)},(N1.prototype=new pi).__c=function(s,e){var t=e.__c,n=this;n.t==null&&(n.t=[]),n.t.push(t);var i=P6(n.__v),r=!1,o=function(){r||(r=!0,t.__R=null,i?i(a):a())};t.__R=o;var a=function(){if(!--n.__u){if(n.state.__a){var c=n.state.__a;n.__v.__k[0]=A6(c,c.__c.__P,c.__c.__O)}var d;for(n.setState({__a:n.__b=null});d=n.t.pop();)d.forceUpdate()}},l=e.__h===!0;n.__u++||l||n.setState({__a:n.__b=n.__v.__k[0]}),s.then(o,o)},N1.prototype.componentWillUnmount=function(){this.t=[]},N1.prototype.render=function(s,e){if(this.__b){if(this.__v.__k){var t=document.createElement("div"),n=this.__v.__k[0].__c;this.__v.__k[0]=C6(this.__b,t,n.__O=n.__P)}this.__b=null}var i=e.__a&&ce(gn,null,s.fallback);return i&&(i.__h=null),[ce(gn,null,e.__a?null:s.children),i]};var M6=function(s,e,t){if(++t[1]===t[0]&&s.o.delete(e),s.props.revealOrder&&(s.props.revealOrder[0]!=="t"||!s.o.size))for(t=s.u;t;){for(;t.length>3;)t.pop()();if(t[1]<t[0])break;s.u=t=t[2]}};function Tse(s){return this.getChildContext=function(){return s.context},s.children}function Ese(s){var e=this,t=s.i;e.componentWillUnmount=function(){zc(null,e.l),e.l=null,e.i=null},e.i&&e.i!==t&&e.componentWillUnmount(),s.__v?(e.l||(e.i=t,e.l={nodeType:1,parentNode:t,childNodes:[],appendChild:function(n){this.childNodes.push(n),e.i.appendChild(n)},insertBefore:function(n,i){this.childNodes.push(n),e.i.appendChild(n)},removeChild:function(n){this.childNodes.splice(this.childNodes.indexOf(n)>>>1,1),e.i.removeChild(n)}}),zc(ce(Tse,{context:e.context},s.__v),e.l)):e.l&&e.componentWillUnmount()}function k6(s,e){var t=ce(Ese,{__v:s,i:e});return t.containerInfo=e,t}(cx.prototype=new pi).__a=function(s){var e=this,t=P6(e.__v),n=e.o.get(s);return n[0]++,function(i){var r=function(){e.props.revealOrder?(n.push(i),M6(e,s,n)):i()};t?t(r):r()}},cx.prototype.render=function(s){this.u=null,this.o=new Map;var e=mv(s.children);s.revealOrder&&s.revealOrder[0]==="b"&&e.reverse();for(var t=e.length;t--;)this.o.set(e[t],this.u=[1,0,this.u]);return s.children},cx.prototype.componentDidUpdate=cx.prototype.componentDidMount=function(){var s=this;this.o.forEach(function(e,t){M6(s,t,e)})};var xse=typeof Symbol<"u"&&Symbol.for&&Symbol.for("react.element")||60103,Sse=/^(?:accent|alignment|arabic|baseline|cap|clip(?!PathU)|color|dominant|fill|flood|font|glyph(?!R)|horiz|image|letter|lighting|marker(?!H|W|U)|overline|paint|pointer|shape|stop|strikethrough|stroke|text(?!L)|transform|underline|unicode|units|v|vector|vert|word|writing|x(?!C))[A-Z]/,Cse=typeof document<"u",Ase=function(s){return(typeof Symbol<"u"&&typeof Symbol()=="symbol"?/fil|che|rad/i:/fil|che|ra/i).test(s)};pi.prototype.isReactComponent={},["componentWillMount","componentWillReceiveProps","componentWillUpdate"].forEach(function(s){Object.defineProperty(pi.prototype,s,{configurable:!0,get:function(){return this["UNSAFE_"+s]},set:function(e){Object.defineProperty(this,s,{configurable:!0,writable:!0,value:e})}})});var T6=Ft.event;function Pse(){}function kse(){return this.cancelBubble}function Ise(){return this.defaultPrevented}Ft.event=function(s){return T6&&(s=T6(s)),s.persist=Pse,s.isPropagationStopped=kse,s.isDefaultPrevented=Ise,s.nativeEvent=s};var Dse,E6={configurable:!0,get:function(){return this.class}},x6=Ft.vnode;Ft.vnode=function(s){var e=s.type,t=s.props,n=t;if(typeof e=="string"){var i=e.indexOf("-")===-1;for(var r in n={},t){var o=t[r];Cse&&r==="children"&&e==="noscript"||r==="value"&&"defaultValue"in t&&o==null||(r==="defaultValue"&&"value"in t&&t.value==null?r="value":r==="download"&&o===!0?o="":/ondoubleclick/i.test(r)?r="ondblclick":/^onchange(textarea|input)/i.test(r+e)&&!Ase(t.type)?r="oninput":/^onfocus$/i.test(r)?r="onfocusin":/^onblur$/i.test(r)?r="onfocusout":/^on(Ani|Tra|Tou|BeforeInp|Compo)/.test(r)?r=r.toLowerCase():i&&Sse.test(r)?r=r.replace(/[A-Z0-9]/g,"-$&").toLowerCase():o===null&&(o=void 0),/^oninput$/i.test(r)&&(r=r.toLowerCase(),n[r]&&(r="oninputCapture")),n[r]=o)}e=="select"&&n.multiple&&Array.isArray(n.value)&&(n.value=mv(t.children).forEach(function(a){a.props.selected=n.value.indexOf(a.props.value)!=-1})),e=="select"&&n.defaultValue!=null&&(n.value=mv(t.children).forEach(function(a){a.props.selected=n.multiple?n.defaultValue.indexOf(a.props.value)!=-1:n.defaultValue==a.props.value})),s.props=n,t.class!=t.className&&(E6.enumerable="className"in t,t.className!=null&&(n.class=t.className),Object.defineProperty(n,"className",E6))}s.$$typeof=xse,x6&&x6(s)};var S6=Ft.__r;Ft.__r=function(s){S6&&S6(s),Dse=s.__c};var W6=[],q1=new Map;function Kc(s){W6.push(s),q1.forEach(e=>{q6(e,s)})}function H6(s){s.isConnected&&s.getRootNode&&j6(s.getRootNode())}function j6(s){let e=q1.get(s);if(!e||!e.isConnected){if(e=s.querySelector("style[data-fullcalendar]"),!e){e=document.createElement("style"),e.setAttribute("data-fullcalendar","");let t=Fse();t&&(e.nonce=t);let n=s===document?document.head:s,i=s===document?n.querySelector("script,link[rel=stylesheet],link[as=style],style"):n.firstChild;n.insertBefore(e,i)}q1.set(s,e),Rse(e)}}function Rse(s){for(let e of W6)q6(s,e)}function q6(s,e){let{sheet:t}=s,n=t.cssRules.length;e.split("}").forEach((i,r)=>{i=i.trim(),i&&t.insertRule(i+"}",n+r)})}var O1;function Fse(){return O1===void 0&&(O1=Lse()),O1}function Lse(){let s=document.querySelector('meta[name="csp-nonce"]');if(s&&s.hasAttribute("content"))return s.getAttribute("content");let e=document.querySelector("script[nonce]");return e&&e.nonce||""}typeof document<"u"&&j6(document);var Nse=':root{--fc-small-font-size:.85em;--fc-page-bg-color:#fff;--fc-neutral-bg-color:hsla(0,0%,82%,.3);--fc-neutral-text-color:grey;--fc-border-color:#ddd;--fc-button-text-color:#fff;--fc-button-bg-color:#2c3e50;--fc-button-border-color:#2c3e50;--fc-button-hover-bg-color:#1e2b37;--fc-button-hover-border-color:#1a252f;--fc-button-active-bg-color:#1a252f;--fc-button-active-border-color:#151e27;--fc-event-bg-color:#3788d8;--fc-event-border-color:#3788d8;--fc-event-text-color:#fff;--fc-event-selected-overlay-color:rgba(0,0,0,.25);--fc-more-link-bg-color:#d0d0d0;--fc-more-link-text-color:inherit;--fc-event-resizer-thickness:8px;--fc-event-resizer-dot-total-width:8px;--fc-event-resizer-dot-border-width:1px;--fc-non-business-color:hsla(0,0%,84%,.3);--fc-bg-event-color:#8fdf82;--fc-bg-event-opacity:0.3;--fc-highlight-color:rgba(188,232,241,.3);--fc-today-bg-color:rgba(255,220,40,.15);--fc-now-indicator-color:red}.fc-not-allowed,.fc-not-allowed .fc-event{cursor:not-allowed}.fc{display:flex;flex-direction:column;font-size:1em}.fc,.fc *,.fc :after,.fc :before{box-sizing:border-box}.fc table{border-collapse:collapse;border-spacing:0;font-size:1em}.fc th{text-align:center}.fc td,.fc th{padding:0;vertical-align:top}.fc a[data-navlink]{cursor:pointer}.fc a[data-navlink]:hover{text-decoration:underline}.fc-direction-ltr{direction:ltr;text-align:left}.fc-direction-rtl{direction:rtl;text-align:right}.fc-theme-standard td,.fc-theme-standard th{border:1px solid var(--fc-border-color)}.fc-liquid-hack td,.fc-liquid-hack th{position:relative}@font-face{font-family:fcicons;font-style:normal;font-weight:400;src:url("data:application/x-font-ttf;charset=utf-8;base64,AAEAAAALAIAAAwAwT1MvMg8SBfAAAAC8AAAAYGNtYXAXVtKNAAABHAAAAFRnYXNwAAAAEAAAAXAAAAAIZ2x5ZgYydxIAAAF4AAAFNGhlYWQUJ7cIAAAGrAAAADZoaGVhB20DzAAABuQAAAAkaG10eCIABhQAAAcIAAAALGxvY2ED4AU6AAAHNAAAABhtYXhwAA8AjAAAB0wAAAAgbmFtZXsr690AAAdsAAABhnBvc3QAAwAAAAAI9AAAACAAAwPAAZAABQAAApkCzAAAAI8CmQLMAAAB6wAzAQkAAAAAAAAAAAAAAAAAAAABEAAAAAAAAAAAAAAAAAAAAABAAADpBgPA/8AAQAPAAEAAAAABAAAAAAAAAAAAAAAgAAAAAAADAAAAAwAAABwAAQADAAAAHAADAAEAAAAcAAQAOAAAAAoACAACAAIAAQAg6Qb//f//AAAAAAAg6QD//f//AAH/4xcEAAMAAQAAAAAAAAAAAAAAAQAB//8ADwABAAAAAAAAAAAAAgAANzkBAAAAAAEAAAAAAAAAAAACAAA3OQEAAAAAAQAAAAAAAAAAAAIAADc5AQAAAAABAWIAjQKeAskAEwAAJSc3NjQnJiIHAQYUFwEWMjc2NCcCnuLiDQ0MJAz/AA0NAQAMJAwNDcni4gwjDQwM/wANIwz/AA0NDCMNAAAAAQFiAI0CngLJABMAACUBNjQnASYiBwYUHwEHBhQXFjI3AZ4BAA0N/wAMJAwNDeLiDQ0MJAyNAQAMIw0BAAwMDSMM4uINIwwNDQAAAAIA4gC3Ax4CngATACcAACUnNzY0JyYiDwEGFB8BFjI3NjQnISc3NjQnJiIPAQYUHwEWMjc2NCcB87e3DQ0MIw3VDQ3VDSMMDQ0BK7e3DQ0MJAzVDQ3VDCQMDQ3zuLcMJAwNDdUNIwzWDAwNIwy4twwkDA0N1Q0jDNYMDA0jDAAAAgDiALcDHgKeABMAJwAAJTc2NC8BJiIHBhQfAQcGFBcWMjchNzY0LwEmIgcGFB8BBwYUFxYyNwJJ1Q0N1Q0jDA0Nt7cNDQwjDf7V1Q0N1QwkDA0Nt7cNDQwkDLfWDCMN1Q0NDCQMt7gMIw0MDNYMIw3VDQ0MJAy3uAwjDQwMAAADAFUAAAOrA1UAMwBoAHcAABMiBgcOAQcOAQcOARURFBYXHgEXHgEXHgEzITI2Nz4BNz4BNz4BNRE0JicuAScuAScuASMFITIWFx4BFx4BFx4BFREUBgcOAQcOAQcOASMhIiYnLgEnLgEnLgE1ETQ2Nz4BNz4BNz4BMxMhMjY1NCYjISIGFRQWM9UNGAwLFQkJDgUFBQUFBQ4JCRULDBgNAlYNGAwLFQkJDgUFBQUFBQ4JCRULDBgN/aoCVgQIBAQHAwMFAQIBAQIBBQMDBwQECAT9qgQIBAQHAwMFAQIBAQIBBQMDBwQECASAAVYRGRkR/qoRGRkRA1UFBAUOCQkVDAsZDf2rDRkLDBUJCA4FBQUFBQUOCQgVDAsZDQJVDRkLDBUJCQ4FBAVVAgECBQMCBwQECAX9qwQJAwQHAwMFAQICAgIBBQMDBwQDCQQCVQUIBAQHAgMFAgEC/oAZEhEZGRESGQAAAAADAFUAAAOrA1UAMwBoAIkAABMiBgcOAQcOAQcOARURFBYXHgEXHgEXHgEzITI2Nz4BNz4BNz4BNRE0JicuAScuAScuASMFITIWFx4BFx4BFx4BFREUBgcOAQcOAQcOASMhIiYnLgEnLgEnLgE1ETQ2Nz4BNz4BNz4BMxMzFRQWMzI2PQEzMjY1NCYrATU0JiMiBh0BIyIGFRQWM9UNGAwLFQkJDgUFBQUFBQ4JCRULDBgNAlYNGAwLFQkJDgUFBQUFBQ4JCRULDBgN/aoCVgQIBAQHAwMFAQIBAQIBBQMDBwQECAT9qgQIBAQHAwMFAQIBAQIBBQMDBwQECASAgBkSEhmAERkZEYAZEhIZgBEZGREDVQUEBQ4JCRUMCxkN/asNGQsMFQkIDgUFBQUFBQ4JCBUMCxkNAlUNGQsMFQkJDgUEBVUCAQIFAwIHBAQIBf2rBAkDBAcDAwUBAgICAgEFAwMHBAMJBAJVBQgEBAcCAwUCAQL+gIASGRkSgBkSERmAEhkZEoAZERIZAAABAOIAjQMeAskAIAAAExcHBhQXFjI/ARcWMjc2NC8BNzY0JyYiDwEnJiIHBhQX4uLiDQ0MJAzi4gwkDA0N4uINDQwkDOLiDCQMDQ0CjeLiDSMMDQ3h4Q0NDCMN4uIMIw0MDOLiDAwNIwwAAAABAAAAAQAAa5n0y18PPPUACwQAAAAAANivOVsAAAAA2K85WwAAAAADqwNVAAAACAACAAAAAAAAAAEAAAPA/8AAAAQAAAAAAAOrAAEAAAAAAAAAAAAAAAAAAAALBAAAAAAAAAAAAAAAAgAAAAQAAWIEAAFiBAAA4gQAAOIEAABVBAAAVQQAAOIAAAAAAAoAFAAeAEQAagCqAOoBngJkApoAAQAAAAsAigADAAAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAA4ArgABAAAAAAABAAcAAAABAAAAAAACAAcAYAABAAAAAAADAAcANgABAAAAAAAEAAcAdQABAAAAAAAFAAsAFQABAAAAAAAGAAcASwABAAAAAAAKABoAigADAAEECQABAA4ABwADAAEECQACAA4AZwADAAEECQADAA4APQADAAEECQAEAA4AfAADAAEECQAFABYAIAADAAEECQAGAA4AUgADAAEECQAKADQApGZjaWNvbnMAZgBjAGkAYwBvAG4Ac1ZlcnNpb24gMS4wAFYAZQByAHMAaQBvAG4AIAAxAC4AMGZjaWNvbnMAZgBjAGkAYwBvAG4Ac2ZjaWNvbnMAZgBjAGkAYwBvAG4Ac1JlZ3VsYXIAUgBlAGcAdQBsAGEAcmZjaWNvbnMAZgBjAGkAYwBvAG4Ac0ZvbnQgZ2VuZXJhdGVkIGJ5IEljb01vb24uAEYAbwBuAHQAIABnAGUAbgBlAHIAYQB0AGUAZAAgAGIAeQAgAEkAYwBvAE0AbwBvAG4ALgAAAAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=") format("truetype")}.fc-icon{speak:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;display:inline-block;font-family:fcicons!important;font-style:normal;font-variant:normal;font-weight:400;height:1em;line-height:1;text-align:center;text-transform:none;-webkit-user-select:none;-moz-user-select:none;user-select:none;width:1em}.fc-icon-chevron-left:before{content:"\\e900"}.fc-icon-chevron-right:before{content:"\\e901"}.fc-icon-chevrons-left:before{content:"\\e902"}.fc-icon-chevrons-right:before{content:"\\e903"}.fc-icon-minus-square:before{content:"\\e904"}.fc-icon-plus-square:before{content:"\\e905"}.fc-icon-x:before{content:"\\e906"}.fc .fc-button{border-radius:0;font-family:inherit;font-size:inherit;line-height:inherit;margin:0;overflow:visible;text-transform:none}.fc .fc-button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}.fc .fc-button{-webkit-appearance:button}.fc .fc-button:not(:disabled){cursor:pointer}.fc .fc-button{background-color:transparent;border:1px solid transparent;border-radius:.25em;display:inline-block;font-size:1em;font-weight:400;line-height:1.5;padding:.4em .65em;text-align:center;-webkit-user-select:none;-moz-user-select:none;user-select:none;vertical-align:middle}.fc .fc-button:hover{text-decoration:none}.fc .fc-button:focus{box-shadow:0 0 0 .2rem rgba(44,62,80,.25);outline:0}.fc .fc-button:disabled{opacity:.65}.fc .fc-button-primary{background-color:var(--fc-button-bg-color);border-color:var(--fc-button-border-color);color:var(--fc-button-text-color)}.fc .fc-button-primary:hover{background-color:var(--fc-button-hover-bg-color);border-color:var(--fc-button-hover-border-color);color:var(--fc-button-text-color)}.fc .fc-button-primary:disabled{background-color:var(--fc-button-bg-color);border-color:var(--fc-button-border-color);color:var(--fc-button-text-color)}.fc .fc-button-primary:focus{box-shadow:0 0 0 .2rem rgba(76,91,106,.5)}.fc .fc-button-primary:not(:disabled).fc-button-active,.fc .fc-button-primary:not(:disabled):active{background-color:var(--fc-button-active-bg-color);border-color:var(--fc-button-active-border-color);color:var(--fc-button-text-color)}.fc .fc-button-primary:not(:disabled).fc-button-active:focus,.fc .fc-button-primary:not(:disabled):active:focus{box-shadow:0 0 0 .2rem rgba(76,91,106,.5)}.fc .fc-button .fc-icon{font-size:1.5em;vertical-align:middle}.fc .fc-button-group{display:inline-flex;position:relative;vertical-align:middle}.fc .fc-button-group>.fc-button{flex:1 1 auto;position:relative}.fc .fc-button-group>.fc-button.fc-button-active,.fc .fc-button-group>.fc-button:active,.fc .fc-button-group>.fc-button:focus,.fc .fc-button-group>.fc-button:hover{z-index:1}.fc-direction-ltr .fc-button-group>.fc-button:not(:first-child){border-bottom-left-radius:0;border-top-left-radius:0;margin-left:-1px}.fc-direction-ltr .fc-button-group>.fc-button:not(:last-child){border-bottom-right-radius:0;border-top-right-radius:0}.fc-direction-rtl .fc-button-group>.fc-button:not(:first-child){border-bottom-right-radius:0;border-top-right-radius:0;margin-right:-1px}.fc-direction-rtl .fc-button-group>.fc-button:not(:last-child){border-bottom-left-radius:0;border-top-left-radius:0}.fc .fc-toolbar{align-items:center;display:flex;justify-content:space-between}.fc .fc-toolbar.fc-header-toolbar{margin-bottom:1.5em}.fc .fc-toolbar.fc-footer-toolbar{margin-top:1.5em}.fc .fc-toolbar-title{font-size:1.75em;margin:0}.fc-direction-ltr .fc-toolbar>*>:not(:first-child){margin-left:.75em}.fc-direction-rtl .fc-toolbar>*>:not(:first-child){margin-right:.75em}.fc-direction-rtl .fc-toolbar-ltr{flex-direction:row-reverse}.fc .fc-scroller{-webkit-overflow-scrolling:touch;position:relative}.fc .fc-scroller-liquid{height:100%}.fc .fc-scroller-liquid-absolute{bottom:0;left:0;position:absolute;right:0;top:0}.fc .fc-scroller-harness{direction:ltr;overflow:hidden;position:relative}.fc .fc-scroller-harness-liquid{height:100%}.fc-direction-rtl .fc-scroller-harness>.fc-scroller{direction:rtl}.fc-theme-standard .fc-scrollgrid{border:1px solid var(--fc-border-color)}.fc .fc-scrollgrid,.fc .fc-scrollgrid table{table-layout:fixed;width:100%}.fc .fc-scrollgrid table{border-left-style:hidden;border-right-style:hidden;border-top-style:hidden}.fc .fc-scrollgrid{border-bottom-width:0;border-collapse:separate;border-right-width:0}.fc .fc-scrollgrid-liquid{height:100%}.fc .fc-scrollgrid-section,.fc .fc-scrollgrid-section table,.fc .fc-scrollgrid-section>td{height:1px}.fc .fc-scrollgrid-section-liquid>td{height:100%}.fc .fc-scrollgrid-section>*{border-left-width:0;border-top-width:0}.fc .fc-scrollgrid-section-footer>*,.fc .fc-scrollgrid-section-header>*{border-bottom-width:0}.fc .fc-scrollgrid-section-body table,.fc .fc-scrollgrid-section-footer table{border-bottom-style:hidden}.fc .fc-scrollgrid-section-sticky>*{background:var(--fc-page-bg-color);position:sticky;z-index:3}.fc .fc-scrollgrid-section-header.fc-scrollgrid-section-sticky>*{top:0}.fc .fc-scrollgrid-section-footer.fc-scrollgrid-section-sticky>*{bottom:0}.fc .fc-scrollgrid-sticky-shim{height:1px;margin-bottom:-1px}.fc-sticky{position:sticky}.fc .fc-view-harness{flex-grow:1;position:relative}.fc .fc-view-harness-active>.fc-view{bottom:0;left:0;position:absolute;right:0;top:0}.fc .fc-col-header-cell-cushion{display:inline-block;padding:2px 4px}.fc .fc-bg-event,.fc .fc-highlight,.fc .fc-non-business{bottom:0;left:0;position:absolute;right:0;top:0}.fc .fc-non-business{background:var(--fc-non-business-color)}.fc .fc-bg-event{background:var(--fc-bg-event-color);opacity:var(--fc-bg-event-opacity)}.fc .fc-bg-event .fc-event-title{font-size:var(--fc-small-font-size);font-style:italic;margin:.5em}.fc .fc-highlight{background:var(--fc-highlight-color)}.fc .fc-cell-shaded,.fc .fc-day-disabled{background:var(--fc-neutral-bg-color)}a.fc-event,a.fc-event:hover{text-decoration:none}.fc-event.fc-event-draggable,.fc-event[href]{cursor:pointer}.fc-event .fc-event-main{position:relative;z-index:2}.fc-event-dragging:not(.fc-event-selected){opacity:.75}.fc-event-dragging.fc-event-selected{box-shadow:0 2px 7px rgba(0,0,0,.3)}.fc-event .fc-event-resizer{display:none;position:absolute;z-index:4}.fc-event-selected .fc-event-resizer,.fc-event:hover .fc-event-resizer{display:block}.fc-event-selected .fc-event-resizer{background:var(--fc-page-bg-color);border-color:inherit;border-radius:calc(var(--fc-event-resizer-dot-total-width)/2);border-style:solid;border-width:var(--fc-event-resizer-dot-border-width);height:var(--fc-event-resizer-dot-total-width);width:var(--fc-event-resizer-dot-total-width)}.fc-event-selected .fc-event-resizer:before{bottom:-20px;content:"";left:-20px;position:absolute;right:-20px;top:-20px}.fc-event-selected,.fc-event:focus{box-shadow:0 2px 5px rgba(0,0,0,.2)}.fc-event-selected:before,.fc-event:focus:before{bottom:0;content:"";left:0;position:absolute;right:0;top:0;z-index:3}.fc-event-selected:after,.fc-event:focus:after{background:var(--fc-event-selected-overlay-color);bottom:-1px;content:"";left:-1px;position:absolute;right:-1px;top:-1px;z-index:1}.fc-h-event{background-color:var(--fc-event-bg-color);border:1px solid var(--fc-event-border-color);display:block}.fc-h-event .fc-event-main{color:var(--fc-event-text-color)}.fc-h-event .fc-event-main-frame{display:flex}.fc-h-event .fc-event-time{max-width:100%;overflow:hidden}.fc-h-event .fc-event-title-container{flex-grow:1;flex-shrink:1;min-width:0}.fc-h-event .fc-event-title{display:inline-block;left:0;max-width:100%;overflow:hidden;right:0;vertical-align:top}.fc-h-event.fc-event-selected:before{bottom:-10px;top:-10px}.fc-direction-ltr .fc-daygrid-block-event:not(.fc-event-start),.fc-direction-rtl .fc-daygrid-block-event:not(.fc-event-end){border-bottom-left-radius:0;border-left-width:0;border-top-left-radius:0}.fc-direction-ltr .fc-daygrid-block-event:not(.fc-event-end),.fc-direction-rtl .fc-daygrid-block-event:not(.fc-event-start){border-bottom-right-radius:0;border-right-width:0;border-top-right-radius:0}.fc-h-event:not(.fc-event-selected) .fc-event-resizer{bottom:0;top:0;width:var(--fc-event-resizer-thickness)}.fc-direction-ltr .fc-h-event:not(.fc-event-selected) .fc-event-resizer-start,.fc-direction-rtl .fc-h-event:not(.fc-event-selected) .fc-event-resizer-end{cursor:w-resize;left:calc(var(--fc-event-resizer-thickness)*-.5)}.fc-direction-ltr .fc-h-event:not(.fc-event-selected) .fc-event-resizer-end,.fc-direction-rtl .fc-h-event:not(.fc-event-selected) .fc-event-resizer-start{cursor:e-resize;right:calc(var(--fc-event-resizer-thickness)*-.5)}.fc-h-event.fc-event-selected .fc-event-resizer{margin-top:calc(var(--fc-event-resizer-dot-total-width)*-.5);top:50%}.fc-direction-ltr .fc-h-event.fc-event-selected .fc-event-resizer-start,.fc-direction-rtl .fc-h-event.fc-event-selected .fc-event-resizer-end{left:calc(var(--fc-event-resizer-dot-total-width)*-.5)}.fc-direction-ltr .fc-h-event.fc-event-selected .fc-event-resizer-end,.fc-direction-rtl .fc-h-event.fc-event-selected .fc-event-resizer-start{right:calc(var(--fc-event-resizer-dot-total-width)*-.5)}.fc .fc-popover{box-shadow:0 2px 6px rgba(0,0,0,.15);position:absolute;z-index:9999}.fc .fc-popover-header{align-items:center;display:flex;flex-direction:row;justify-content:space-between;padding:3px 4px}.fc .fc-popover-title{margin:0 2px}.fc .fc-popover-close{cursor:pointer;font-size:1.1em;opacity:.65}.fc-theme-standard .fc-popover{background:var(--fc-page-bg-color);border:1px solid var(--fc-border-color)}.fc-theme-standard .fc-popover-header{background:var(--fc-neutral-bg-color)}';Kc(Nse);var ah=class{constructor(e){this.drainedOption=e,this.isRunning=!1,this.isDirty=!1,this.pauseDepths={},this.timeoutId=0}request(e){this.isDirty=!0,this.isPaused()||(this.clearTimeout(),e==null?this.tryDrain():this.timeoutId=setTimeout(this.tryDrain.bind(this),e))}pause(e=""){let{pauseDepths:t}=this;t[e]=(t[e]||0)+1,this.clearTimeout()}resume(e="",t){let{pauseDepths:n}=this;e in n&&(t?delete n[e]:(n[e]-=1,n[e]<=0&&delete n[e]),this.tryDrain())}isPaused(){return Object.keys(this.pauseDepths).length}tryDrain(){if(!this.isRunning&&!this.isPaused()){for(this.isRunning=!0;this.isDirty;)this.isDirty=!1,this.drained();this.isRunning=!1}}clear(){this.clearTimeout(),this.isDirty=!1,this.pauseDepths={}}clearTimeout(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=0)}drained(){this.drainedOption&&this.drainedOption()}};function Dv(s){s.parentNode&&s.parentNode.removeChild(s)}function Gs(s,e){if(s.closest)return s.closest(e);if(!document.documentElement.contains(s))return null;do{if(sR(s,e))return s;s=s.parentElement||s.parentNode}while(s!==null&&s.nodeType===1);return null}function sR(s,e){return(s.matches||s.matchesSelector||s.msMatchesSelector).call(s,e)}function K6(s,e){let t=s instanceof HTMLElement?[s]:s,n=[];for(let i=0;i<t.length;i+=1){let r=t[i].querySelectorAll(e);for(let o=0;o<r.length;o+=1)n.push(r[o])}return n}var Ose=/(top|left|right|bottom|width|height)$/i;function yh(s,e){for(let t in e)iR(s,t,e[t])}function iR(s,e,t){t==null?s.style[e]="":typeof t=="number"&&Ose.test(e)?s.style[e]=`${t}px`:s.style[e]=t}function Cx(s){var e,t;return(t=(e=s.composedPath)===null||e===void 0?void 0:e.call(s)[0])!==null&&t!==void 0?t:s.target}var I6=0;function Kr(){return I6+=1,"fc-dom-"+I6}function Rv(s){s.preventDefault()}function $se(s,e){return t=>{let n=Gs(t.target,s);n&&e.call(n,t,n)}}function rR(s,e,t,n){let i=$se(t,n);return s.addEventListener(e,i),()=>{s.removeEventListener(e,i)}}function Y6(s,e,t,n){let i;return rR(s,"mouseover",e,(r,o)=>{if(o!==i){i=o,t(r,o);let a=l=>{i=null,n(l,o),o.removeEventListener("mouseleave",a)};o.addEventListener("mouseleave",a)}})}var D6=["webkitTransitionEnd","otransitionend","oTransitionEnd","msTransitionEnd","transitionend"];function oR(s,e){let t=n=>{e(n),D6.forEach(i=>{s.removeEventListener(i,t)})};D6.forEach(n=>{s.addEventListener(n,t)})}function X6(s){return Object.assign({onClick:s},Q6(s))}function Q6(s){return{tabIndex:0,onKeyDown(e){(e.key==="Enter"||e.key===" ")&&(s(e),e.preventDefault())}}}var R6=0;function kl(){return R6+=1,String(R6)}function Fv(){document.body.classList.add("fc-not-allowed")}function Lv(){document.body.classList.remove("fc-not-allowed")}function aR(s){s.style.userSelect="none",s.style.webkitUserSelect="none",s.addEventListener("selectstart",Rv)}function lR(s){s.style.userSelect="",s.style.webkitUserSelect="",s.removeEventListener("selectstart",Rv)}function cR(s){s.addEventListener("contextmenu",Rv)}function dR(s){s.removeEventListener("contextmenu",Rv)}function J6(s){let e=[],t=[],n,i;for(typeof s=="string"?t=s.split(/\s*,\s*/):typeof s=="function"?t=[s]:Array.isArray(s)&&(t=s),n=0;n<t.length;n+=1)i=t[n],typeof i=="string"?e.push(i.charAt(0)==="-"?{field:i.substring(1),order:-1}:{field:i,order:1}):typeof i=="function"&&e.push({func:i});return e}function Z6(s,e,t){let n,i;for(n=0;n<t.length;n+=1)if(i=Bse(s,e,t[n]),i)return i;return 0}function Bse(s,e,t){return t.func?t.func(s,e):e8(s[t.field],e[t.field])*(t.order||1)}function e8(s,e){return!s&&!e?0:e==null?-1:s==null?1:typeof s=="string"||typeof e=="string"?String(s).localeCompare(String(e)):s-e}function oh(s,e){let t=String(s);return"000".substr(0,e-t.length)+t}function tm(s,e,t){return typeof s=="function"?s(...e):typeof s=="string"?e.reduce((n,i,r)=>n.replace("$"+r,i||""),s):t}function uR(s,e){return s-e}function gv(s){return s%1===0}function zse(s){let e=s.querySelector(".fc-scrollgrid-shrink-frame"),t=s.querySelector(".fc-scrollgrid-shrink-cushion");if(!e)throw new Error("needs fc-scrollgrid-shrink-frame className");if(!t)throw new Error("needs fc-scrollgrid-shrink-cushion className");return s.getBoundingClientRect().width-e.getBoundingClientRect().width+t.getBoundingClientRect().width}var F6=["years","months","days","milliseconds"],Use=/^(-?)(?:(\d+)\.)?(\d+):(\d\d)(?::(\d\d)(?:\.(\d\d\d))?)?/;function nn(s,e){return typeof s=="string"?Vse(s):typeof s=="object"&&s?L6(s):typeof s=="number"?L6({[e||"milliseconds"]:s}):null}function Vse(s){let e=Use.exec(s);if(e){let t=e[1]?-1:1;return{years:0,months:0,days:t*(e[2]?parseInt(e[2],10):0),milliseconds:t*((e[3]?parseInt(e[3],10):0)*60*60*1e3+(e[4]?parseInt(e[4],10):0)*60*1e3+(e[5]?parseInt(e[5],10):0)*1e3+(e[6]?parseInt(e[6],10):0))}}return null}function L6(s){let e={years:s.years||s.year||0,months:s.months||s.month||0,days:s.days||s.day||0,milliseconds:(s.hours||s.hour||0)*60*60*1e3+(s.minutes||s.minute||0)*60*1e3+(s.seconds||s.second||0)*1e3+(s.milliseconds||s.millisecond||s.ms||0)},t=s.weeks||s.week;return t&&(e.days+=t*7,e.specifiedWeeks=!0),e}function Gse(s,e){return s.years===e.years&&s.months===e.months&&s.days===e.days&&s.milliseconds===e.milliseconds}function Nv(s,e){return{years:s.years+e.years,months:s.months+e.months,days:s.days+e.days,milliseconds:s.milliseconds+e.milliseconds}}function t8(s,e){return{years:s.years-e.years,months:s.months-e.months,days:s.days-e.days,milliseconds:s.milliseconds-e.milliseconds}}function hR(s,e){return{years:s.years*e,months:s.months*e,days:s.days*e,milliseconds:s.milliseconds*e}}function Wse(s){return Qf(s)/365}function Hse(s){return Qf(s)/30}function Qf(s){return xr(s)/864e5}function xr(s){return s.years*(365*864e5)+s.months*(30*864e5)+s.days*864e5+s.milliseconds}function Ov(s,e){let t=null;for(let n=0;n<F6.length;n+=1){let i=F6[n];if(e[i]){let r=s[i]/e[i];if(!gv(r)||t!==null&&t!==r)return null;t=r}else if(s[i])return null}return t}function _v(s){let e=s.milliseconds;if(e){if(e%1e3!==0)return{unit:"millisecond",value:e};if(e%(1e3*60)!==0)return{unit:"second",value:e/1e3};if(e%(1e3*60*60)!==0)return{unit:"minute",value:e/(1e3*60)};if(e)return{unit:"hour",value:e/(1e3*60*60)}}return s.days?s.specifiedWeeks&&s.days%7===0?{unit:"week",value:s.days/7}:{unit:"day",value:s.days}:s.months?{unit:"month",value:s.months}:s.years?{unit:"year",value:s.years}:{unit:"millisecond",value:0}}function Sa(s,e,t){if(s===e)return!0;let n=s.length,i;if(n!==e.length)return!1;for(i=0;i<n;i+=1)if(!(t?t(s[i],e[i]):s[i]===e[i]))return!1;return!0}var jse=["sun","mon","tue","wed","thu","fri","sat"];function Ax(s,e){let t=Vc(s);return t[2]+=e*7,Ji(t)}function ts(s,e){let t=Vc(s);return t[2]+=e,Ji(t)}function Ta(s,e){let t=Vc(s);return t[6]+=e,Ji(t)}function pR(s,e){return Ca(s,e)/7}function Ca(s,e){return(e.valueOf()-s.valueOf())/(1e3*60*60*24)}function qse(s,e){return(e.valueOf()-s.valueOf())/(1e3*60*60)}function Kse(s,e){return(e.valueOf()-s.valueOf())/(1e3*60)}function Yse(s,e){return(e.valueOf()-s.valueOf())/1e3}function n8(s,e){let t=Sn(s),n=Sn(e);return{years:0,months:0,days:Math.round(Ca(t,n)),milliseconds:e.valueOf()-n.valueOf()-(s.valueOf()-t.valueOf())}}function s8(s,e){let t=Jf(s,e);return t!==null&&t%7===0?t/7:null}function Jf(s,e){return Gc(s)===Gc(e)?Math.round(Ca(s,e)):null}function Sn(s){return Ji([s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate()])}function Xse(s){return Ji([s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate(),s.getUTCHours()])}function Qse(s){return Ji([s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate(),s.getUTCHours(),s.getUTCMinutes()])}function Jse(s){return Ji([s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate(),s.getUTCHours(),s.getUTCMinutes(),s.getUTCSeconds()])}function Zse(s,e,t){let n=s.getUTCFullYear(),i=$1(s,n,e,t);if(i<1)return $1(s,n-1,e,t);let r=$1(s,n+1,e,t);return r>=1?Math.min(i,r):i}function $1(s,e,t,n){let i=Ji([e,0,1+eie(e,t,n)]),r=Sn(s),o=Math.round(Ca(i,r));return Math.floor(o/7)+1}function eie(s,e,t){let n=7+e-t;return-((7+Ji([s,0,n]).getUTCDay()-e)%7)+n-1}function N6(s){return[s.getFullYear(),s.getMonth(),s.getDate(),s.getHours(),s.getMinutes(),s.getSeconds(),s.getMilliseconds()]}function O6(s){return new Date(s[0],s[1]||0,s[2]==null?1:s[2],s[3]||0,s[4]||0,s[5]||0)}function Vc(s){return[s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate(),s.getUTCHours(),s.getUTCMinutes(),s.getUTCSeconds(),s.getUTCMilliseconds()]}function Ji(s){return s.length===1&&(s=s.concat([0])),new Date(Date.UTC(...s))}function fR(s){return!isNaN(s.valueOf())}function Gc(s){return s.getUTCHours()*1e3*60*60+s.getUTCMinutes()*1e3*60+s.getUTCSeconds()*1e3+s.getUTCMilliseconds()}function Px(s,e,t=!1){let n=s.toISOString();return n=n.replace(".000",""),t&&(n=n.replace("T00:00:00Z","")),n.length>10&&(e==null?n=n.replace("Z",""):e!==0&&(n=n.replace("Z",_R(e,!0)))),n}function Yc(s){return s.toISOString().replace(/T.*$/,"")}function mR(s){return s.toISOString().match(/^\d{4}-\d{2}/)[0]}function gR(s){return oh(s.getUTCHours(),2)+":"+oh(s.getUTCMinutes(),2)+":"+oh(s.getUTCSeconds(),2)}function _R(s,e=!1){let t=s<0?"-":"+",n=Math.abs(s),i=Math.floor(n/60),r=Math.round(n%60);return e?`${t+oh(i,2)}:${oh(r,2)}`:`GMT${t}${i}${r?`:${oh(r,2)}`:""}`}function Dt(s,e,t){let n,i;return function(...r){if(!n)i=s.apply(this,r);else if(!Sa(n,r)){t&&t(i);let o=s.apply(this,r);(!e||!e(o,i))&&(i=o)}return n=r,i}}function nm(s,e,t){let n,i;return r=>{if(!n)i=s.call(this,r);else if(!Zi(n,r)){t&&t(i);let o=s.call(this,r);(!e||!e(o,i))&&(i=o)}return n=r,i}}var B1={week:3,separator:9,omitZeroMinute:9,meridiem:9,omitCommas:9},_x={timeZoneName:7,era:6,year:5,month:4,day:2,weekday:2,hour:1,minute:1,second:1},dx=/\s*([ap])\.?m\.?/i,tie=/,/g,nie=/\s+/g,sie=/\u200e/g,iie=/UTC|GMT/,K1=class{constructor(e){let t={},n={},i=9;for(let r in e)r in B1?(n[r]=e[r],B1[r]<9&&(i=Math.min(B1[r],i))):(t[r]=e[r],r in _x&&(i=Math.min(_x[r],i)));this.standardDateProps=t,this.extendedSettings=n,this.smallestUnitNum=i,this.buildFormattingFunc=Dt($6)}format(e,t){return this.buildFormattingFunc(this.standardDateProps,this.extendedSettings,t)(e)}formatRange(e,t,n,i){let{standardDateProps:r,extendedSettings:o}=this,a=die(e.marker,t.marker,n.calendarSystem);if(!a)return this.format(e,n);let l=a;l>1&&(r.year==="numeric"||r.year==="2-digit")&&(r.month==="numeric"||r.month==="2-digit")&&(r.day==="numeric"||r.day==="2-digit")&&(l=1);let c=this.format(e,n),d=this.format(t,n);if(c===d)return c;let u=uie(r,l),h=$6(u,o,n),p=h(e),f=h(t),_=hie(c,p,d,f),b=o.separator||i||n.defaultSeparator||"";return _?_.before+p+b+f+_.after:c+b+d}getSmallestUnit(){switch(this.smallestUnitNum){case 7:case 6:case 5:return"year";case 4:return"month";case 3:return"week";case 2:return"day";default:return"time"}}};function $6(s,e,t){let n=Object.keys(s).length;return n===1&&s.timeZoneName==="short"?i=>_R(i.timeZoneOffset):n===0&&e.week?i=>cie(t.computeWeekNumber(i.marker),t.weekText,t.weekTextLong,t.locale,e.week):rie(s,e,t)}function rie(s,e,t){s=Object.assign({},s),e=Object.assign({},e),oie(s,e),s.timeZone="UTC";let n=new Intl.DateTimeFormat(t.locale.codes,s),i;if(e.omitZeroMinute){let r=Object.assign({},s);delete r.minute,i=new Intl.DateTimeFormat(t.locale.codes,r)}return r=>{let{marker:o}=r,a;i&&!o.getUTCMinutes()?a=i:a=n;let l=a.format(o);return aie(l,r,s,e,t)}}function oie(s,e){s.timeZoneName&&(s.hour||(s.hour="2-digit"),s.minute||(s.minute="2-digit")),s.timeZoneName==="long"&&(s.timeZoneName="short"),e.omitZeroMinute&&(s.second||s.millisecond)&&delete e.omitZeroMinute}function aie(s,e,t,n,i){return s=s.replace(sie,""),t.timeZoneName==="short"&&(s=lie(s,i.timeZone==="UTC"||e.timeZoneOffset==null?"UTC":_R(e.timeZoneOffset))),n.omitCommas&&(s=s.replace(tie,"").trim()),n.omitZeroMinute&&(s=s.replace(":00","")),n.meridiem===!1?s=s.replace(dx,"").trim():n.meridiem==="narrow"?s=s.replace(dx,(r,o)=>o.toLocaleLowerCase()):n.meridiem==="short"?s=s.replace(dx,(r,o)=>`${o.toLocaleLowerCase()}m`):n.meridiem==="lowercase"&&(s=s.replace(dx,r=>r.toLocaleLowerCase())),s=s.replace(nie," "),s=s.trim(),s}function lie(s,e){let t=!1;return s=s.replace(iie,()=>(t=!0,e)),t||(s+=` ${e}`),s}function cie(s,e,t,n,i){let r=[];return i==="long"?r.push(t):(i==="short"||i==="narrow")&&r.push(e),(i==="long"||i==="short")&&r.push(" "),r.push(n.simpleNumberFormat.format(s)),n.options.direction==="rtl"&&r.reverse(),r.join("")}function die(s,e,t){return t.getMarkerYear(s)!==t.getMarkerYear(e)?5:t.getMarkerMonth(s)!==t.getMarkerMonth(e)?4:t.getMarkerDay(s)!==t.getMarkerDay(e)?2:Gc(s)!==Gc(e)?1:0}function uie(s,e){let t={};for(let n in s)(!(n in _x)||_x[n]<=e)&&(t[n]=s[n]);return t}function hie(s,e,t,n){let i=0;for(;i<s.length;){let r=s.indexOf(e,i);if(r===-1)break;let o=s.substr(0,r);i=r+e.length;let a=s.substr(i),l=0;for(;l<t.length;){let c=t.indexOf(n,l);if(c===-1)break;let d=t.substr(0,c);l=c+n.length;let u=t.substr(l);if(o===d&&a===u)return{before:o,after:a}}}return null}function B6(s,e){let t=e.markerToArray(s.marker);return{marker:s.marker,timeZoneOffset:s.timeZoneOffset,array:t,year:t[0],month:t[1],day:t[2],hour:t[3],minute:t[4],second:t[5],millisecond:t[6]}}function yx(s,e,t,n){let i=B6(s,t.calendarSystem),r=e?B6(e,t.calendarSystem):null;return{date:i,start:i,end:r,timeZone:t.timeZone,localeCodes:t.locale.codes,defaultSeparator:n||t.defaultSeparator}}var Y1=class{constructor(e){this.cmdStr=e}format(e,t,n){return t.cmdFormatter(this.cmdStr,yx(e,null,t,n))}formatRange(e,t,n,i){return n.cmdFormatter(this.cmdStr,yx(e,t,n,i))}},X1=class{constructor(e){this.func=e}format(e,t,n){return this.func(yx(e,null,t,n))}formatRange(e,t,n,i){return this.func(yx(e,t,n,i))}};function Pn(s){return typeof s=="object"&&s?new K1(s):typeof s=="string"?new Y1(s):typeof s=="function"?new X1(s):null}var yR={navLinkDayClick:Ae,navLinkWeekClick:Ae,duration:nn,bootstrapFontAwesome:Ae,buttonIcons:Ae,customButtons:Ae,defaultAllDayEventDuration:nn,defaultTimedEventDuration:nn,nextDayThreshold:nn,scrollTime:nn,scrollTimeReset:Boolean,slotMinTime:nn,slotMaxTime:nn,dayPopoverFormat:Pn,slotDuration:nn,snapDuration:nn,headerToolbar:Ae,footerToolbar:Ae,defaultRangeSeparator:String,titleRangeSeparator:String,forceEventDuration:Boolean,dayHeaders:Boolean,dayHeaderFormat:Pn,dayHeaderClassNames:Ae,dayHeaderContent:Ae,dayHeaderDidMount:Ae,dayHeaderWillUnmount:Ae,dayCellClassNames:Ae,dayCellContent:Ae,dayCellDidMount:Ae,dayCellWillUnmount:Ae,initialView:String,aspectRatio:Number,weekends:Boolean,weekNumberCalculation:Ae,weekNumbers:Boolean,weekNumberClassNames:Ae,weekNumberContent:Ae,weekNumberDidMount:Ae,weekNumberWillUnmount:Ae,editable:Boolean,viewClassNames:Ae,viewDidMount:Ae,viewWillUnmount:Ae,nowIndicator:Boolean,nowIndicatorSnap:Ae,nowIndicatorClassNames:Ae,nowIndicatorContent:Ae,nowIndicatorDidMount:Ae,nowIndicatorWillUnmount:Ae,showNonCurrentDates:Boolean,lazyFetching:Boolean,startParam:String,endParam:String,timeZoneParam:String,timeZone:String,locales:Ae,locale:Ae,themeSystem:String,dragRevertDuration:Number,dragScroll:Boolean,allDayMaintainDuration:Boolean,unselectAuto:Boolean,dropAccept:Ae,eventOrder:J6,eventOrderStrict:Boolean,handleWindowResize:Boolean,windowResizeDelay:Number,longPressDelay:Number,eventDragMinDistance:Number,expandRows:Boolean,height:Ae,contentHeight:Ae,direction:String,weekNumberFormat:Pn,eventResizableFromStart:Boolean,displayEventTime:Boolean,displayEventEnd:Boolean,weekText:String,weekTextLong:String,progressiveEventRendering:Boolean,businessHours:Ae,initialDate:Ae,now:Ae,eventDataTransform:Ae,stickyHeaderDates:Ae,stickyFooterScrollbar:Ae,viewHeight:Ae,defaultAllDay:Boolean,eventSourceFailure:Ae,eventSourceSuccess:Ae,eventDisplay:String,eventStartEditable:Boolean,eventDurationEditable:Boolean,eventOverlap:Ae,eventConstraint:Ae,eventAllow:Ae,eventBackgroundColor:String,eventBorderColor:String,eventTextColor:String,eventColor:String,eventClassNames:Ae,eventContent:Ae,eventDidMount:Ae,eventWillUnmount:Ae,selectConstraint:Ae,selectOverlap:Ae,selectAllow:Ae,droppable:Boolean,unselectCancel:String,slotLabelFormat:Ae,slotLaneClassNames:Ae,slotLaneContent:Ae,slotLaneDidMount:Ae,slotLaneWillUnmount:Ae,slotLabelClassNames:Ae,slotLabelContent:Ae,slotLabelDidMount:Ae,slotLabelWillUnmount:Ae,dayMaxEvents:Ae,dayMaxEventRows:Ae,dayMinWidth:Number,slotLabelInterval:nn,allDayText:String,allDayClassNames:Ae,allDayContent:Ae,allDayDidMount:Ae,allDayWillUnmount:Ae,slotMinWidth:Number,navLinks:Boolean,eventTimeFormat:Pn,rerenderDelay:Number,moreLinkText:Ae,moreLinkHint:Ae,selectMinDistance:Number,selectable:Boolean,selectLongPressDelay:Number,eventLongPressDelay:Number,selectMirror:Boolean,eventMaxStack:Number,eventMinHeight:Number,eventMinWidth:Number,eventShortHeight:Number,slotEventOverlap:Boolean,plugins:Ae,firstDay:Number,dayCount:Number,dateAlignment:String,dateIncrement:nn,hiddenDays:Ae,fixedWeekCount:Boolean,validRange:Ae,visibleRange:Ae,titleFormat:Ae,eventInteractive:Boolean,noEventsText:String,viewHint:Ae,navLinkHint:Ae,closeHint:String,timeHint:String,eventHint:String,moreLinkClick:Ae,moreLinkClassNames:Ae,moreLinkContent:Ae,moreLinkDidMount:Ae,moreLinkWillUnmount:Ae,monthStartFormat:Pn,handleCustomRendering:Ae,customRenderingMetaMap:Ae,customRenderingReplaces:Boolean},Xc={eventDisplay:"auto",defaultRangeSeparator:" - ",titleRangeSeparator:" \u2013 ",defaultTimedEventDuration:"01:00:00",defaultAllDayEventDuration:{day:1},forceEventDuration:!1,nextDayThreshold:"00:00:00",dayHeaders:!0,initialView:"",aspectRatio:1.35,headerToolbar:{start:"title",center:"",end:"today prev,next"},weekends:!0,weekNumbers:!1,weekNumberCalculation:"local",editable:!1,nowIndicator:!1,scrollTime:"06:00:00",scrollTimeReset:!0,slotMinTime:"00:00:00",slotMaxTime:"24:00:00",showNonCurrentDates:!0,lazyFetching:!0,startParam:"start",endParam:"end",timeZoneParam:"timeZone",timeZone:"local",locales:[],locale:"",themeSystem:"standard",dragRevertDuration:500,dragScroll:!0,allDayMaintainDuration:!1,unselectAuto:!0,dropAccept:"*",eventOrder:"start,-duration,allDay,title",dayPopoverFormat:{month:"long",day:"numeric",year:"numeric"},handleWindowResize:!0,windowResizeDelay:100,longPressDelay:1e3,eventDragMinDistance:5,expandRows:!1,navLinks:!1,selectable:!1,eventMinHeight:15,eventMinWidth:30,eventShortHeight:30,monthStartFormat:{month:"long",day:"numeric"},nowIndicatorSnap:"auto"},vR={datesSet:Ae,eventsSet:Ae,eventAdd:Ae,eventChange:Ae,eventRemove:Ae,windowResize:Ae,eventClick:Ae,eventMouseEnter:Ae,eventMouseLeave:Ae,select:Ae,unselect:Ae,loading:Ae,_unmount:Ae,_beforeprint:Ae,_afterprint:Ae,_noEventDrop:Ae,_noEventResize:Ae,_resize:Ae,_scrollRequest:Ae},bR={buttonText:Ae,buttonHints:Ae,views:Ae,plugins:Ae,initialEvents:Ae,events:Ae,eventSources:Ae},Qc={headerToolbar:rh,footerToolbar:rh,buttonText:rh,buttonHints:rh,buttonIcons:rh,dateIncrement:rh,plugins:ux,events:ux,eventSources:ux,resources:ux};function rh(s,e){return typeof s=="object"&&typeof e=="object"&&s&&e?Zi(s,e):s===e}function ux(s,e){return Array.isArray(s)&&Array.isArray(e)?Sa(s,e):s===e}var i8={type:String,component:Ae,buttonText:String,buttonTextKey:String,dateProfileGeneratorClass:Ae,usesMinMaxTime:Boolean,classNames:Ae,content:Ae,didMount:Ae,willUnmount:Ae};function kx(s){return Dx(s,Qc)}function Ix(s,e){let t={},n={};for(let i in e)i in s&&(t[i]=e[i](s[i]));for(let i in s)i in e||(n[i]=s[i]);return{refined:t,extra:n}}function Ae(s){return s}var{hasOwnProperty:vx}=Object.prototype;function Dx(s,e){let t={};if(e){for(let n in e)if(e[n]===rh){let i=[];for(let r=s.length-1;r>=0;r-=1){let o=s[r][n];if(typeof o=="object"&&o)i.unshift(o);else if(o!==void 0){t[n]=o;break}}i.length&&(t[n]=Dx(i))}}for(let n=s.length-1;n>=0;n-=1){let i=s[n];for(let r in i)r in t||(t[r]=i[r])}return t}function Sl(s,e){let t={};for(let n in s)e(s[n],n)&&(t[n]=s[n]);return t}function qr(s,e){let t={};for(let n in s)t[n]=e(s[n],n);return t}function wR(s){let e={};for(let t of s)e[t]=!0;return e}function Rx(s){let e=[];for(let t in s)e.push(s[t]);return e}function Zi(s,e){if(s===e)return!0;for(let t in s)if(vx.call(s,t)&&!(t in e))return!1;for(let t in e)if(vx.call(e,t)&&s[t]!==e[t])return!1;return!0}var pie=/^on[A-Z]/;function fie(s,e){let t=mie(s,e);for(let n of t)if(!pie.test(n))return!1;return!0}function mie(s,e){let t=[];for(let n in s)vx.call(s,n)&&(n in e||t.push(n));for(let n in e)vx.call(e,n)&&s[n]!==e[n]&&t.push(n);return t}function mx(s,e,t={}){if(s===e)return!0;for(let n in e)if(!(n in s&&gie(s[n],e[n],t[n])))return!1;for(let n in s)if(!(n in e))return!1;return!0}function gie(s,e,t){return s===e||t===!0?!0:t?t(s,e):!1}function r8(s,e=0,t,n=1){let i=[];t==null&&(t=Object.keys(s).length);for(let r=e;r<t;r+=n){let o=s[r];o!==void 0&&i.push(o)}return i}var o8={};function _ie(s,e){o8[s]=e}function yie(s){return new o8[s]}var Q1=class{getMarkerYear(e){return e.getUTCFullYear()}getMarkerMonth(e){return e.getUTCMonth()}getMarkerDay(e){return e.getUTCDate()}arrayToMarker(e){return Ji(e)}markerToArray(e){return Vc(e)}};_ie("gregory",Q1);var vie=/^\s*(\d{4})(-?(\d{2})(-?(\d{2})([T ](\d{2}):?(\d{2})(:?(\d{2})(\.(\d+))?)?(Z|(([-+])(\d{2})(:?(\d{2}))?))?)?)?)?$/;function a8(s){let e=vie.exec(s);if(e){let t=new Date(Date.UTC(Number(e[1]),e[3]?Number(e[3])-1:0,Number(e[5]||1),Number(e[7]||0),Number(e[8]||0),Number(e[10]||0),e[12]?+`0.${e[12]}`*1e3:0));if(fR(t)){let n=null;return e[13]&&(n=(e[15]==="-"?-1:1)*(Number(e[16]||0)*60+Number(e[18]||0))),{marker:t,isTimeUnspecified:!e[6],timeZoneOffset:n}}}return null}var yv=class{constructor(e){let t=this.timeZone=e.timeZone,n=t!=="local"&&t!=="UTC";e.namedTimeZoneImpl&&n&&(this.namedTimeZoneImpl=new e.namedTimeZoneImpl(t)),this.canComputeOffset=!!(!n||this.namedTimeZoneImpl),this.calendarSystem=yie(e.calendarSystem),this.locale=e.locale,this.weekDow=e.locale.week.dow,this.weekDoy=e.locale.week.doy,e.weekNumberCalculation==="ISO"&&(this.weekDow=1,this.weekDoy=4),typeof e.firstDay=="number"&&(this.weekDow=e.firstDay),typeof e.weekNumberCalculation=="function"&&(this.weekNumberFunc=e.weekNumberCalculation),this.weekText=e.weekText!=null?e.weekText:e.locale.options.weekText,this.weekTextLong=(e.weekTextLong!=null?e.weekTextLong:e.locale.options.weekTextLong)||this.weekText,this.cmdFormatter=e.cmdFormatter,this.defaultSeparator=e.defaultSeparator}createMarker(e){let t=this.createMarkerMeta(e);return t===null?null:t.marker}createNowMarker(){return this.canComputeOffset?this.timestampToMarker(new Date().valueOf()):Ji(N6(new Date))}createMarkerMeta(e){if(typeof e=="string")return this.parse(e);let t=null;return typeof e=="number"?t=this.timestampToMarker(e):e instanceof Date?(e=e.valueOf(),isNaN(e)||(t=this.timestampToMarker(e))):Array.isArray(e)&&(t=Ji(e)),t===null||!fR(t)?null:{marker:t,isTimeUnspecified:!1,forcedTzo:null}}parse(e){let t=a8(e);if(t===null)return null;let{marker:n}=t,i=null;return t.timeZoneOffset!==null&&(this.canComputeOffset?n=this.timestampToMarker(n.valueOf()-t.timeZoneOffset*60*1e3):i=t.timeZoneOffset),{marker:n,isTimeUnspecified:t.isTimeUnspecified,forcedTzo:i}}getYear(e){return this.calendarSystem.getMarkerYear(e)}getMonth(e){return this.calendarSystem.getMarkerMonth(e)}getDay(e){return this.calendarSystem.getMarkerDay(e)}add(e,t){let n=this.calendarSystem.markerToArray(e);return n[0]+=t.years,n[1]+=t.months,n[2]+=t.days,n[6]+=t.milliseconds,this.calendarSystem.arrayToMarker(n)}subtract(e,t){let n=this.calendarSystem.markerToArray(e);return n[0]-=t.years,n[1]-=t.months,n[2]-=t.days,n[6]-=t.milliseconds,this.calendarSystem.arrayToMarker(n)}addYears(e,t){let n=this.calendarSystem.markerToArray(e);return n[0]+=t,this.calendarSystem.arrayToMarker(n)}addMonths(e,t){let n=this.calendarSystem.markerToArray(e);return n[1]+=t,this.calendarSystem.arrayToMarker(n)}diffWholeYears(e,t){let{calendarSystem:n}=this;return Gc(e)===Gc(t)&&n.getMarkerDay(e)===n.getMarkerDay(t)&&n.getMarkerMonth(e)===n.getMarkerMonth(t)?n.getMarkerYear(t)-n.getMarkerYear(e):null}diffWholeMonths(e,t){let{calendarSystem:n}=this;return Gc(e)===Gc(t)&&n.getMarkerDay(e)===n.getMarkerDay(t)?n.getMarkerMonth(t)-n.getMarkerMonth(e)+(n.getMarkerYear(t)-n.getMarkerYear(e))*12:null}greatestWholeUnit(e,t){let n=this.diffWholeYears(e,t);return n!==null?{unit:"year",value:n}:(n=this.diffWholeMonths(e,t),n!==null?{unit:"month",value:n}:(n=s8(e,t),n!==null?{unit:"week",value:n}:(n=Jf(e,t),n!==null?{unit:"day",value:n}:(n=qse(e,t),gv(n)?{unit:"hour",value:n}:(n=Kse(e,t),gv(n)?{unit:"minute",value:n}:(n=Yse(e,t),gv(n)?{unit:"second",value:n}:{unit:"millisecond",value:t.valueOf()-e.valueOf()}))))))}countDurationsBetween(e,t,n){let i;return n.years&&(i=this.diffWholeYears(e,t),i!==null)?i/Wse(n):n.months&&(i=this.diffWholeMonths(e,t),i!==null)?i/Hse(n):n.days&&(i=Jf(e,t),i!==null)?i/Qf(n):(t.valueOf()-e.valueOf())/xr(n)}startOf(e,t){return t==="year"?this.startOfYear(e):t==="month"?this.startOfMonth(e):t==="week"?this.startOfWeek(e):t==="day"?Sn(e):t==="hour"?Xse(e):t==="minute"?Qse(e):t==="second"?Jse(e):null}startOfYear(e){return this.calendarSystem.arrayToMarker([this.calendarSystem.getMarkerYear(e)])}startOfMonth(e){return this.calendarSystem.arrayToMarker([this.calendarSystem.getMarkerYear(e),this.calendarSystem.getMarkerMonth(e)])}startOfWeek(e){return this.calendarSystem.arrayToMarker([this.calendarSystem.getMarkerYear(e),this.calendarSystem.getMarkerMonth(e),e.getUTCDate()-(e.getUTCDay()-this.weekDow+7)%7])}computeWeekNumber(e){return this.weekNumberFunc?this.weekNumberFunc(this.toDate(e)):Zse(e,this.weekDow,this.weekDoy)}format(e,t,n={}){return t.format({marker:e,timeZoneOffset:n.forcedTzo!=null?n.forcedTzo:this.offsetForMarker(e)},this)}formatRange(e,t,n,i={}){return i.isEndExclusive&&(t=Ta(t,-1)),n.formatRange({marker:e,timeZoneOffset:i.forcedStartTzo!=null?i.forcedStartTzo:this.offsetForMarker(e)},{marker:t,timeZoneOffset:i.forcedEndTzo!=null?i.forcedEndTzo:this.offsetForMarker(t)},this,i.defaultSeparator)}formatIso(e,t={}){let n=null;return t.omitTimeZoneOffset||(t.forcedTzo!=null?n=t.forcedTzo:n=this.offsetForMarker(e)),Px(e,n,t.omitTime)}timestampToMarker(e){return this.timeZone==="local"?Ji(N6(new Date(e))):this.timeZone==="UTC"||!this.namedTimeZoneImpl?new Date(e):Ji(this.namedTimeZoneImpl.timestampToArray(e))}offsetForMarker(e){return this.timeZone==="local"?-O6(Vc(e)).getTimezoneOffset():this.timeZone==="UTC"?0:this.namedTimeZoneImpl?this.namedTimeZoneImpl.offsetForArray(Vc(e)):null}toDate(e,t){return this.timeZone==="local"?O6(Vc(e)):this.timeZone==="UTC"?new Date(e.valueOf()):this.namedTimeZoneImpl?new Date(e.valueOf()-this.namedTimeZoneImpl.offsetForArray(Vc(e))*1e3*60):new Date(e.valueOf()-(t||0))}},Cl=class{constructor(e){this.iconOverrideOption&&this.setIconOverride(e[this.iconOverrideOption])}setIconOverride(e){let t,n;if(typeof e=="object"&&e){t=Object.assign({},this.iconClasses);for(n in e)t[n]=this.applyIconOverridePrefix(e[n]);this.iconClasses=t}else e===!1&&(this.iconClasses={})}applyIconOverridePrefix(e){let t=this.iconOverridePrefix;return t&&e.indexOf(t)!==0&&(e=t+e),e}getClass(e){return this.classes[e]||""}getIconClass(e,t){let n;return t&&this.rtlIconClasses?n=this.rtlIconClasses[e]||this.iconClasses[e]:n=this.iconClasses[e],n?`${this.baseIconClass} ${n}`:""}getCustomButtonIconClass(e){let t;return this.iconOverrideCustomButtonOption&&(t=e[this.iconOverrideCustomButtonOption],t)?`${this.baseIconClass} ${this.applyIconOverridePrefix(t)}`:""}};Cl.prototype.classes={};Cl.prototype.iconClasses={};Cl.prototype.baseIconClass="";Cl.prototype.iconOverridePrefix="";function vv(s){s();let e=Ft.debounceRendering,t=[];function n(i){t.push(i)}for(Ft.debounceRendering=n,zc(ce(J1,{}),document.createElement("div"));t.length;)t.shift()();Ft.debounceRendering=e}var J1=class extends pi{render(){return ce("div",{})}componentDidMount(){this.setState({})}};function l8(s){let e=ax(s),t=e.Provider;return e.Provider=function(){let n=!this.getChildContext,i=t.apply(this,arguments);if(n){let r=[];this.shouldComponentUpdate=o=>{this.props.value!==o.value&&r.forEach(a=>{a.context=o.value,a.forceUpdate()})},this.sub=o=>{r.push(o);let a=o.componentWillUnmount;o.componentWillUnmount=()=>{r.splice(r.indexOf(o),1),a&&a.call(o)}}}return i},e}var bx=class{constructor(e,t,n,i){this.execFunc=e,this.emitter=t,this.scrollTime=n,this.scrollTimeReset=i,this.handleScrollRequest=r=>{this.queuedRequest=Object.assign({},this.queuedRequest||{},r),this.drain()},t.on("_scrollRequest",this.handleScrollRequest),this.fireInitialScroll()}detach(){this.emitter.off("_scrollRequest",this.handleScrollRequest)}update(e){e&&this.scrollTimeReset?this.fireInitialScroll():this.drain()}fireInitialScroll(){this.handleScrollRequest({time:this.scrollTime})}drain(){this.queuedRequest&&this.execFunc(this.queuedRequest)&&(this.queuedRequest=null)}},Yr=l8({});function c8(s,e,t,n,i,r,o,a,l,c,d,u,h,p){return{dateEnv:i,nowManager:r,options:t,pluginHooks:a,emitter:d,dispatch:l,getCurrentData:c,calendarApi:u,viewSpec:s,viewApi:e,dateProfileGenerator:n,theme:o,isRtl:t.direction==="rtl",addResizeHandler(f){d.on("_resize",f)},removeResizeHandler(f){d.off("_resize",f)},createScrollResponder(f){return new bx(f,d,nn(t.scrollTime),t.scrollTimeReset)},registerInteractiveComponent:h,unregisterInteractiveComponent:p}}var Ea=class extends pi{shouldComponentUpdate(e,t){return!mx(this.props,e,this.propEquality)||!mx(this.state,t,this.stateEquality)}safeSetState(e){mx(this.state,Object.assign(Object.assign({},this.state),e),this.stateEquality)||this.setState(e)}};Ea.addPropsEquality=bie;Ea.addStateEquality=wie;Ea.contextType=Yr;Ea.prototype.propEquality={};Ea.prototype.stateEquality={};var sn=class extends Ea{};sn.contextType=Yr;function bie(s){let e=Object.create(this.prototype.propEquality);Object.assign(e,s),this.prototype.propEquality=e}function wie(s){let e=Object.create(this.prototype.stateEquality);Object.assign(e,s),this.prototype.stateEquality=e}function Cr(s,e){typeof s=="function"?s(e):s&&(s.current=e)}var bv=class extends sn{constructor(){super(...arguments),this.id=kl(),this.queuedDomNodes=[],this.currentDomNodes=[],this.handleEl=e=>{let{options:t}=this.context,{generatorName:n}=this.props;(!t.customRenderingReplaces||!Z1(n,t))&&this.updateElRef(e)},this.updateElRef=e=>{this.props.elRef&&Cr(this.props.elRef,e)}}render(){let{props:e,context:t}=this,{options:n}=t,{customGenerator:i,defaultGenerator:r,renderProps:o}=e,a=MR(e,[],this.handleEl),l=!1,c,d=[],u;if(i!=null){let h=typeof i=="function"?i(o,ce):i;if(h===!0)l=!0;else{let p=h&&typeof h=="object";p&&"html"in h?a.dangerouslySetInnerHTML={__html:h.html}:p&&"domNodes"in h?d=Array.prototype.slice.call(h.domNodes):(p?I1(h):typeof h!="function")?c=h:u=h}}else l=!Z1(e.generatorName,n);return l&&r&&(c=r(o)),this.queuedDomNodes=d,this.currentGeneratorMeta=u,ce(e.elTag,a,c)}componentDidMount(){this.applyQueueudDomNodes(),this.triggerCustomRendering(!0)}componentDidUpdate(){this.applyQueueudDomNodes(),this.triggerCustomRendering(!0)}componentWillUnmount(){this.triggerCustomRendering(!1)}triggerCustomRendering(e){var t;let{props:n,context:i}=this,{handleCustomRendering:r,customRenderingMetaMap:o}=i.options;if(r){let a=(t=this.currentGeneratorMeta)!==null&&t!==void 0?t:o?.[n.generatorName];a&&r(Object.assign(Object.assign({id:this.id,isActive:e,containerEl:this.base,reportNewContainerEl:this.updateElRef,generatorMeta:a},n),{elClasses:(n.elClasses||[]).filter(Mie)}))}}applyQueueudDomNodes(){let{queuedDomNodes:e,currentDomNodes:t}=this,n=this.base;if(!Sa(e,t)){t.forEach(Dv);for(let i of e)n.appendChild(i);this.currentDomNodes=e}}};bv.addPropsEquality({elClasses:Sa,elStyle:Zi,elAttrs:fie,renderProps:Zi});function Z1(s,e){var t;return!!(e.handleCustomRendering&&s&&(!((t=e.customRenderingMetaMap)===null||t===void 0)&&t[s]))}function MR(s,e,t){let n=Object.assign(Object.assign({},s.elAttrs),{ref:t});return(s.elClasses||e)&&(n.className=(s.elClasses||[]).concat(e||[]).concat(n.className||[]).filter(Boolean).join(" ")),s.elStyle&&(n.style=s.elStyle),n}function Mie(s){return!!s}var TR=l8(0),ms=class extends pi{constructor(){super(...arguments),this.InnerContent=Tie.bind(void 0,this),this.handleEl=e=>{this.el=e,this.props.elRef&&(Cr(this.props.elRef,e),e&&this.didMountMisfire&&this.componentDidMount())}}render(){let{props:e}=this,t=Eie(e.classNameGenerator,e.renderProps);if(e.children){let n=MR(e,t,this.handleEl),i=e.children(this.InnerContent,e.renderProps,n);return e.elTag?ce(e.elTag,n,i):i}else return ce(bv,Object.assign(Object.assign({},e),{elRef:this.handleEl,elTag:e.elTag||"div",elClasses:(e.elClasses||[]).concat(t),renderId:this.context}))}componentDidMount(){var e,t;this.el?(t=(e=this.props).didMount)===null||t===void 0||t.call(e,Object.assign(Object.assign({},this.props.renderProps),{el:this.el})):this.didMountMisfire=!0}componentWillUnmount(){var e,t;(t=(e=this.props).willUnmount)===null||t===void 0||t.call(e,Object.assign(Object.assign({},this.props.renderProps),{el:this.el}))}};ms.contextType=TR;function Tie(s,e){let t=s.props;return ce(bv,Object.assign({renderProps:t.renderProps,generatorName:t.generatorName,customGenerator:t.customGenerator,defaultGenerator:t.defaultGenerator,renderId:s.context},e))}function Eie(s,e){let t=typeof s=="function"?s(e):s||[];return typeof t=="string"?[t]:t}var Oo=class extends sn{render(){let{props:e,context:t}=this,{options:n}=t,i={view:t.viewApi};return ce(ms,{elRef:e.elRef,elTag:e.elTag||"div",elAttrs:e.elAttrs,elClasses:[...ER(e.viewSpec),...e.elClasses||[]],elStyle:e.elStyle,renderProps:i,classNameGenerator:n.viewClassNames,generatorName:void 0,didMount:n.viewDidMount,willUnmount:n.viewWillUnmount},()=>e.children)}};function ER(s){return[`fc-${s.type}-view`,"fc-view"]}function xie(s,e){let t=null,n=null;return s.start&&(t=e.createMarker(s.start)),s.end&&(n=e.createMarker(s.end)),!t&&!n||t&&n&&n<t?null:{start:t,end:n}}function z6(s,e){let t=[],{start:n}=e,i,r;for(s.sort(Sie),i=0;i<s.length;i+=1)r=s[i],r.start>n&&t.push({start:n,end:r.start}),r.end>n&&(n=r.end);return n<e.end&&t.push({start:n,end:e.end}),t}function Sie(s,e){return s.start.valueOf()-e.start.valueOf()}function Sr(s,e){let{start:t,end:n}=s,i=null;return e.start!==null&&(t===null?t=e.start:t=new Date(Math.max(t.valueOf(),e.start.valueOf()))),e.end!=null&&(n===null?n=e.end:n=new Date(Math.min(n.valueOf(),e.end.valueOf()))),(t===null||n===null||t<n)&&(i={start:t,end:n}),i}function d8(s,e){return(s.start===null?null:s.start.valueOf())===(e.start===null?null:e.start.valueOf())&&(s.end===null?null:s.end.valueOf())===(e.end===null?null:e.end.valueOf())}function Fx(s,e){return(s.end===null||e.start===null||s.end>e.start)&&(s.start===null||e.end===null||s.start<e.end)}function sm(s,e){return(s.start===null||e.start!==null&&e.start>=s.start)&&(s.end===null||e.end!==null&&e.end<=s.end)}function jr(s,e){return(s.start===null||e>=s.start)&&(s.end===null||e<s.end)}function Cie(s,e){return e.start!=null&&s<e.start?e.start:e.end!=null&&s>=e.end?new Date(e.end.valueOf()-1):s}function u8(s){let e=Math.floor(Ca(s.start,s.end))||1,t=Sn(s.start),n=ts(t,e);return{start:t,end:n}}function Lx(s,e=nn(0)){let t=null,n=null;if(s.end){n=Sn(s.end);let i=s.end.valueOf()-n.valueOf();i&&i>=xr(e)&&(n=ts(n,1))}return s.start&&(t=Sn(s.start),n&&n<=t&&(n=ts(t,1))),{start:t,end:n}}function xR(s){let e=Lx(s);return Ca(e.start,e.end)>1}function Wc(s,e,t,n){return n==="year"?nn(t.diffWholeYears(s,e),"year"):n==="month"?nn(t.diffWholeMonths(s,e),"month"):n8(s,e)}var lh=class{constructor(e){this.props=e,this.initHiddenDays()}buildPrev(e,t,n){let{dateEnv:i}=this.props,r=i.subtract(i.startOf(t,e.currentRangeUnit),e.dateIncrement);return this.build(r,-1,n)}buildNext(e,t,n){let{dateEnv:i}=this.props,r=i.add(i.startOf(t,e.currentRangeUnit),e.dateIncrement);return this.build(r,1,n)}build(e,t,n=!0){let{props:i}=this,r,o,a,l,c,d;return r=this.buildValidRange(),r=this.trimHiddenDays(r),n&&(e=Cie(e,r)),o=this.buildCurrentRangeInfo(e,t),a=/^(year|month|week|day)$/.test(o.unit),l=this.buildRenderRange(this.trimHiddenDays(o.range),o.unit,a),l=this.trimHiddenDays(l),c=l,i.showNonCurrentDates||(c=Sr(c,o.range)),c=this.adjustActiveRange(c),c=Sr(c,r),d=Fx(o.range,r),jr(l,e)||(e=l.start),{currentDate:e,validRange:r,currentRange:o.range,currentRangeUnit:o.unit,isRangeAllDay:a,activeRange:c,renderRange:l,slotMinTime:i.slotMinTime,slotMaxTime:i.slotMaxTime,isValid:d,dateIncrement:this.buildDateIncrement(o.duration)}}buildValidRange(){let e=this.props.validRangeInput,t=typeof e=="function"?e.call(this.props.calendarApi,this.props.dateEnv.toDate(this.props.nowManager.getDateMarker())):e;return this.refineRange(t)||{start:null,end:null}}buildCurrentRangeInfo(e,t){let{props:n}=this,i=null,r=null,o=null,a;return n.duration?(i=n.duration,r=n.durationUnit,o=this.buildRangeFromDuration(e,t,i,r)):(a=this.props.dayCount)?(r="day",o=this.buildRangeFromDayCount(e,t,a)):(o=this.buildCustomVisibleRange(e))?r=n.dateEnv.greatestWholeUnit(o.start,o.end).unit:(i=this.getFallbackDuration(),r=_v(i).unit,o=this.buildRangeFromDuration(e,t,i,r)),{duration:i,unit:r,range:o}}getFallbackDuration(){return nn({day:1})}adjustActiveRange(e){let{dateEnv:t,usesMinMaxTime:n,slotMinTime:i,slotMaxTime:r}=this.props,{start:o,end:a}=e;return n&&(Qf(i)<0&&(o=Sn(o),o=t.add(o,i)),Qf(r)>1&&(a=Sn(a),a=ts(a,-1),a=t.add(a,r))),{start:o,end:a}}buildRangeFromDuration(e,t,n,i){let{dateEnv:r,dateAlignment:o}=this.props,a,l,c;if(!o){let{dateIncrement:u}=this.props;u&&xr(u)<xr(n)?o=_v(u).unit:o=i}Qf(n)<=1&&this.isHiddenDay(a)&&(a=this.skipHiddenDays(a,t),a=Sn(a));function d(){a=r.startOf(e,o),l=r.add(a,n),c={start:a,end:l}}return d(),this.trimHiddenDays(c)||(e=this.skipHiddenDays(e,t),d()),c}buildRangeFromDayCount(e,t,n){let{dateEnv:i,dateAlignment:r}=this.props,o=0,a=e,l;r&&(a=i.startOf(a,r)),a=Sn(a),a=this.skipHiddenDays(a,t),l=a;do l=ts(l,1),this.isHiddenDay(l)||(o+=1);while(o<n);return{start:a,end:l}}buildCustomVisibleRange(e){let{props:t}=this,n=t.visibleRangeInput,i=typeof n=="function"?n.call(t.calendarApi,t.dateEnv.toDate(e)):n,r=this.refineRange(i);return r&&(r.start==null||r.end==null)?null:r}buildRenderRange(e,t,n){return e}buildDateIncrement(e){let{dateIncrement:t}=this.props,n;return t||((n=this.props.dateAlignment)?nn(1,n):e||nn({days:1}))}refineRange(e){if(e){let t=xie(e,this.props.dateEnv);return t&&(t=Lx(t)),t}return null}initHiddenDays(){let e=this.props.hiddenDays||[],t=[],n=0,i;for(this.props.weekends===!1&&e.push(0,6),i=0;i<7;i+=1)(t[i]=e.indexOf(i)!==-1)||(n+=1);if(!n)throw new Error("invalid hiddenDays");this.isHiddenDayHash=t}trimHiddenDays(e){let{start:t,end:n}=e;return t&&(t=this.skipHiddenDays(t)),n&&(n=this.skipHiddenDays(n,-1,!0)),t==null||n==null||t<n?{start:t,end:n}:null}isHiddenDay(e){return e instanceof Date&&(e=e.getUTCDay()),this.isHiddenDayHash[e]}skipHiddenDays(e,t=1,n=!1){for(;this.isHiddenDayHash[(e.getUTCDay()+(n?t:0)+7)%7];)e=ts(e,t);return e}};function $v(s,e,t,n){return{instanceId:kl(),defId:s,range:e,forcedStartTzo:t??null,forcedEndTzo:n??null}}function Aie(s,e,t,n){for(let i=0;i<n.length;i+=1){let r=n[i].parse(s,t);if(r){let{allDay:o}=s;return o==null&&(o=e,o==null&&(o=r.allDayGuess,o==null&&(o=!1))),{allDay:o,duration:r.duration,typeData:r.typeData,typeId:i}}}return null}function ch(s,e,t){let{dateEnv:n,pluginHooks:i,options:r}=t,{defs:o,instances:a}=s;a=Sl(a,l=>!o[l.defId].recurringDef);for(let l in o){let c=o[l];if(c.recurringDef){let{duration:d}=c.recurringDef;d||(d=c.allDay?r.defaultAllDayEventDuration:r.defaultTimedEventDuration);let u=Pie(c,d,e,n,i.recurringTypes);for(let h of u){let p=$v(l,{start:h,end:n.add(h,d)});a[p.instanceId]=p}}}return{defs:o,instances:a}}function Pie(s,e,t,n,i){let o=i[s.recurringDef.typeId].expand(s.recurringDef.typeData,{start:n.subtract(t.start,e),end:t.end},n);return s.allDay&&(o=o.map(Sn)),o}var gx={id:String,groupId:String,title:String,url:String,interactive:Boolean},h8={start:Ae,end:Ae,date:Ae,allDay:Boolean},kie=Object.assign(Object.assign(Object.assign({},gx),h8),{extendedProps:Ae});function p8(s,e,t,n,i=SR(t),r,o){let{refined:a,extra:l}=Nx(s,t,i),c=Die(e,t),d=Aie(a,c,t.dateEnv,t.pluginHooks.recurringTypes);if(d){let h=wv(a,l,e?e.sourceId:"",d.allDay,!!d.duration,t,r);return h.recurringDef={typeId:d.typeId,typeData:d.typeData,duration:d.duration},{def:h,instance:null}}let u=Iie(a,c,t,n);if(u){let h=wv(a,l,e?e.sourceId:"",u.allDay,u.hasEnd,t,r),p=$v(h.defId,u.range,u.forcedStartTzo,u.forcedEndTzo);return o&&h.publicId&&o[h.publicId]&&(p.instanceId=o[h.publicId]),{def:h,instance:p}}return null}function Nx(s,e,t=SR(e)){return Ix(s,t)}function SR(s){return Object.assign(Object.assign(Object.assign({},wx),kie),s.pluginHooks.eventRefiners)}function wv(s,e,t,n,i,r,o){let a={title:s.title||"",groupId:s.groupId||"",publicId:s.id||"",url:s.url||"",recurringDef:null,defId:(o&&s.id?o[s.id]:"")||kl(),sourceId:t,allDay:n,hasEnd:i,interactive:s.interactive,ui:im(s,r),extendedProps:Object.assign(Object.assign({},s.extendedProps||{}),e)};for(let l of r.pluginHooks.eventDefMemberAdders)Object.assign(a,l(s));return Object.freeze(a.ui.classNames),Object.freeze(a.extendedProps),a}function Iie(s,e,t,n){let{allDay:i}=s,r,o=null,a=!1,l,c=null,d=s.start!=null?s.start:s.date;if(r=t.dateEnv.createMarkerMeta(d),r)o=r.marker;else if(!n)return null;return s.end!=null&&(l=t.dateEnv.createMarkerMeta(s.end)),i==null&&(e!=null?i=e:i=(!r||r.isTimeUnspecified)&&(!l||l.isTimeUnspecified)),i&&o&&(o=Sn(o)),l&&(c=l.marker,i&&(c=Sn(c)),o&&c<=o&&(c=null)),c?a=!0:n||(a=t.options.forceEventDuration||!1,c=t.dateEnv.add(o,i?t.options.defaultAllDayEventDuration:t.options.defaultTimedEventDuration)),{allDay:i,hasEnd:a,range:{start:o,end:c},forcedStartTzo:r?r.forcedTzo:null,forcedEndTzo:l?l.forcedTzo:null}}function Die(s,e){let t=null;return s&&(t=s.defaultAllDay),t==null&&(t=e.options.defaultAllDay),t}function Mv(s,e,t,n,i,r){let o=Ci(),a=SR(t);for(let l of s){let c=p8(l,e,t,n,a,i,r);c&&Tv(c,o)}return o}function Tv(s,e=Ci()){return e.defs[s.def.defId]=s.def,s.instance&&(e.instances[s.instance.instanceId]=s.instance),e}function Bv(s,e){let t=s.instances[e];if(t){let n=s.defs[t.defId],i=$x(s,r=>Rie(n,r));return i.defs[n.defId]=n,i.instances[t.instanceId]=t,i}return Ci()}function Rie(s,e){return!!(s.groupId&&s.groupId===e.groupId)}function Ci(){return{defs:{},instances:{}}}function Ox(s,e){return{defs:Object.assign(Object.assign({},s.defs),e.defs),instances:Object.assign(Object.assign({},s.instances),e.instances)}}function $x(s,e){let t=Sl(s.defs,e),n=Sl(s.instances,i=>t[i.defId]);return{defs:t,instances:n}}function Fie(s,e){let{defs:t,instances:n}=s,i={},r={};for(let o in t)e.defs[o]||(i[o]=t[o]);for(let o in n)!e.instances[o]&&i[n[o].defId]&&(r[o]=n[o]);return{defs:i,instances:r}}function Lie(s,e){return Array.isArray(s)?Mv(s,null,e,!0):typeof s=="object"&&s?Mv([s],null,e,!0):s!=null?String(s):null}function eR(s){return Array.isArray(s)?s:typeof s=="string"?s.split(/\s+/):[]}var wx={display:String,editable:Boolean,startEditable:Boolean,durationEditable:Boolean,constraint:Ae,overlap:Ae,allow:Ae,className:eR,classNames:eR,color:String,backgroundColor:String,borderColor:String,textColor:String},Nie={display:null,startEditable:null,durationEditable:null,constraints:[],overlap:null,allows:[],backgroundColor:"",borderColor:"",textColor:"",classNames:[]};function im(s,e){let t=Lie(s.constraint,e);return{display:s.display||null,startEditable:s.startEditable!=null?s.startEditable:s.editable,durationEditable:s.durationEditable!=null?s.durationEditable:s.editable,constraints:t!=null?[t]:[],overlap:s.overlap!=null?s.overlap:null,allows:s.allow!=null?[s.allow]:[],backgroundColor:s.backgroundColor||s.color||"",borderColor:s.borderColor||s.color||"",textColor:s.textColor||"",classNames:(s.className||[]).concat(s.classNames||[])}}function CR(s){return s.reduce(Oie,Nie)}function Oie(s,e){return{display:e.display!=null?e.display:s.display,startEditable:e.startEditable!=null?e.startEditable:s.startEditable,durationEditable:e.durationEditable!=null?e.durationEditable:s.durationEditable,constraints:s.constraints.concat(e.constraints),overlap:typeof e.overlap=="boolean"?e.overlap:s.overlap,allows:s.allows.concat(e.allows),backgroundColor:e.backgroundColor||s.backgroundColor,borderColor:e.borderColor||s.borderColor,textColor:e.textColor||s.textColor,classNames:s.classNames.concat(e.classNames)}}var $ie={id:String,defaultAllDay:Boolean,url:String,format:String,events:Ae,eventDataTransform:Ae,success:Ae,failure:Ae};function AR(s,e,t=PR(e)){let n;if(typeof s=="string"?n={url:s}:typeof s=="function"||Array.isArray(s)?n={events:s}:typeof s=="object"&&s&&(n=s),n){let{refined:i,extra:r}=Ix(n,t),o=Bie(i,e);if(o)return{_raw:s,isFetching:!1,latestFetchId:"",fetchRange:null,defaultAllDay:i.defaultAllDay,eventDataTransform:i.eventDataTransform,success:i.success,failure:i.failure,publicId:i.id||"",sourceId:kl(),sourceDefId:o.sourceDefId,meta:o.meta,ui:im(i,e),extendedProps:r}}return null}function PR(s){return Object.assign(Object.assign(Object.assign({},wx),$ie),s.pluginHooks.eventSourceRefiners)}function Bie(s,e){let t=e.pluginHooks.eventSourceDefs;for(let n=t.length-1;n>=0;n-=1){let r=t[n].parseMeta(s);if(r)return{sourceDefId:n,meta:r}}return null}function f8(s,e,t,n,i){switch(e.type){case"RECEIVE_EVENTS":return zie(s,t[e.sourceId],e.fetchId,e.fetchRange,e.rawEvents,i);case"RESET_RAW_EVENTS":return Uie(s,t[e.sourceId],e.rawEvents,n.activeRange,i);case"ADD_EVENTS":return Vie(s,e.eventStore,n?n.activeRange:null,i);case"RESET_EVENTS":return e.eventStore;case"MERGE_EVENTS":return Ox(s,e.eventStore);case"PREV":case"NEXT":case"CHANGE_DATE":case"CHANGE_VIEW_TYPE":return n?ch(s,n.activeRange,i):s;case"REMOVE_EVENTS":return Fie(s,e.eventStore);case"REMOVE_EVENT_SOURCE":return g8(s,e.sourceId);case"REMOVE_ALL_EVENT_SOURCES":return $x(s,r=>!r.sourceId);case"REMOVE_ALL_EVENTS":return Ci();default:return s}}function zie(s,e,t,n,i,r){if(e&&t===e.latestFetchId){let o=Mv(m8(i,e,r),e,r);return n&&(o=ch(o,n,r)),Ox(g8(s,e.sourceId),o)}return s}function Uie(s,e,t,n,i){let{defIdMap:r,instanceIdMap:o}=Wie(s),a=Mv(m8(t,e,i),e,i,!1,r,o);return ch(a,n,i)}function m8(s,e,t){let n=t.options.eventDataTransform,i=e?e.eventDataTransform:null;return i&&(s=U6(s,i)),n&&(s=U6(s,n)),s}function U6(s,e){let t;if(!e)t=s;else{t=[];for(let n of s){let i=e(n);i?t.push(i):i==null&&t.push(n)}}return t}function Vie(s,e,t,n){return t&&(e=ch(e,t,n)),Ox(s,e)}function kR(s,e,t){let{defs:n}=s,i=qr(s.instances,r=>n[r.defId].allDay?r:Object.assign(Object.assign({},r),{range:{start:t.createMarker(e.toDate(r.range.start,r.forcedStartTzo)),end:t.createMarker(e.toDate(r.range.end,r.forcedEndTzo))},forcedStartTzo:t.canComputeOffset?null:r.forcedStartTzo,forcedEndTzo:t.canComputeOffset?null:r.forcedEndTzo}));return{defs:n,instances:i}}function g8(s,e){return $x(s,t=>t.sourceId!==e)}function Gie(s,e){return{defs:s.defs,instances:Sl(s.instances,t=>!e[t.instanceId])}}function Wie(s){let{defs:e,instances:t}=s,n={},i={};for(let r in e){let o=e[r],{publicId:a}=o;a&&(n[a]=r)}for(let r in t){let o=t[r],a=e[o.defId],{publicId:l}=a;l&&(i[l]=r)}return{defIdMap:n,instanceIdMap:i}}var Al=class{constructor(){this.handlers={},this.thisContext=null}setThisContext(e){this.thisContext=e}setOptions(e){this.options=e}on(e,t){Hie(this.handlers,e,t)}off(e,t){jie(this.handlers,e,t)}trigger(e,...t){let n=this.handlers[e]||[],i=this.options&&this.options[e],r=[].concat(i||[],n);for(let o of r)o.apply(this.thisContext,t)}hasHandlers(e){return!!(this.handlers[e]&&this.handlers[e].length||this.options&&this.options[e])}};function Hie(s,e,t){(s[e]||(s[e]=[])).push(t)}function jie(s,e,t){t?s[e]&&(s[e]=s[e].filter(n=>n!==t)):delete s[e]}var qie={startTime:"09:00",endTime:"17:00",daysOfWeek:[1,2,3,4,5],display:"inverse-background",classNames:"fc-non-business",groupId:"_businessHours"};function IR(s,e){return Mv(Kie(s),null,e)}function Kie(s){let e;return s===!0?e=[{}]:Array.isArray(s)?e=s.filter(t=>t.daysOfWeek):typeof s=="object"&&s?e=[s]:e=[],e=e.map(t=>Object.assign(Object.assign({},qie),t)),e}function Bx(s,e,t){t.emitter.trigger("select",Object.assign(Object.assign({},DR(s,t)),{jsEvent:e?e.origEvent:null,view:t.viewApi||t.calendarApi.view}))}function Yie(s,e){e.emitter.trigger("unselect",{jsEvent:s?s.origEvent:null,view:e.viewApi||e.calendarApi.view})}function DR(s,e){let t={};for(let n of e.pluginHooks.dateSpanTransforms)Object.assign(t,n(s,e));return Object.assign(t,are(s,e.dateEnv)),t}function Mx(s,e,t){let{dateEnv:n,options:i}=t,r=e;return s?(r=Sn(r),r=n.add(r,i.defaultAllDayEventDuration)):r=n.add(r,i.defaultTimedEventDuration),r}function zv(s,e,t,n){let i=Tx(s.defs,e),r=Ci();for(let o in s.defs){let a=s.defs[o];r.defs[o]=Xie(a,i[o],t,n)}for(let o in s.instances){let a=s.instances[o],l=r.defs[a.defId];r.instances[o]=Qie(a,l,i[a.defId],t,n)}return r}function Xie(s,e,t,n){let i=t.standardProps||{};i.hasEnd==null&&e.durationEditable&&(t.startDelta||t.endDelta)&&(i.hasEnd=!0);let r=Object.assign(Object.assign(Object.assign({},s),i),{ui:Object.assign(Object.assign({},s.ui),i.ui)});t.extendedProps&&(r.extendedProps=Object.assign(Object.assign({},r.extendedProps),t.extendedProps));for(let o of n.pluginHooks.eventDefMutationAppliers)o(r,t,n);return!r.hasEnd&&n.options.forceEventDuration&&(r.hasEnd=!0),r}function Qie(s,e,t,n,i){let{dateEnv:r}=i,o=n.standardProps&&n.standardProps.allDay===!0,a=n.standardProps&&n.standardProps.hasEnd===!1,l=Object.assign({},s);return o&&(l.range=u8(l.range)),n.datesDelta&&t.startEditable&&(l.range={start:r.add(l.range.start,n.datesDelta),end:r.add(l.range.end,n.datesDelta)}),n.startDelta&&t.durationEditable&&(l.range={start:r.add(l.range.start,n.startDelta),end:l.range.end}),n.endDelta&&t.durationEditable&&(l.range={start:l.range.start,end:r.add(l.range.end,n.endDelta)}),a&&(l.range={start:l.range.start,end:Mx(e.allDay,l.range.start,i)}),e.allDay&&(l.range={start:Sn(l.range.start),end:Sn(l.range.end)}),l.range.end<l.range.start&&(l.range.end=Mx(e.allDay,l.range.start,i)),l}var Uc=class{constructor(e,t){this.context=e,this.internalEventSource=t}remove(){this.context.dispatch({type:"REMOVE_EVENT_SOURCE",sourceId:this.internalEventSource.sourceId})}refetch(){this.context.dispatch({type:"FETCH_EVENT_SOURCES",sourceIds:[this.internalEventSource.sourceId],isRefetch:!0})}get id(){return this.internalEventSource.publicId}get url(){return this.internalEventSource.meta.url}get format(){return this.internalEventSource.meta.format}},Vn=class s{constructor(e,t,n){this._context=e,this._def=t,this._instance=n||null}setProp(e,t){if(e in h8)console.warn("Could not set date-related prop 'name'. Use one of the date-related methods instead.");else if(e==="id")t=gx[e](t),this.mutate({standardProps:{publicId:t}});else if(e in gx)t=gx[e](t),this.mutate({standardProps:{[e]:t}});else if(e in wx){let n=wx[e](t);e==="color"?n={backgroundColor:t,borderColor:t}:e==="editable"?n={startEditable:t,durationEditable:t}:n={[e]:t},this.mutate({standardProps:{ui:n}})}else console.warn(`Could not set prop '${e}'. Use setExtendedProp instead.`)}setExtendedProp(e,t){this.mutate({extendedProps:{[e]:t}})}setStart(e,t={}){let{dateEnv:n}=this._context,i=n.createMarker(e);if(i&&this._instance){let r=this._instance.range,o=Wc(r.start,i,n,t.granularity);t.maintainDuration?this.mutate({datesDelta:o}):this.mutate({startDelta:o})}}setEnd(e,t={}){let{dateEnv:n}=this._context,i;if(!(e!=null&&(i=n.createMarker(e),!i))&&this._instance)if(i){let r=Wc(this._instance.range.end,i,n,t.granularity);this.mutate({endDelta:r})}else this.mutate({standardProps:{hasEnd:!1}})}setDates(e,t,n={}){let{dateEnv:i}=this._context,r={allDay:n.allDay},o=i.createMarker(e),a;if(o&&!(t!=null&&(a=i.createMarker(t),!a))&&this._instance){let l=this._instance.range;n.allDay===!0&&(l=u8(l));let c=Wc(l.start,o,i,n.granularity);if(a){let d=Wc(l.end,a,i,n.granularity);Gse(c,d)?this.mutate({datesDelta:c,standardProps:r}):this.mutate({startDelta:c,endDelta:d,standardProps:r})}else r.hasEnd=!1,this.mutate({datesDelta:c,standardProps:r})}}moveStart(e){let t=nn(e);t&&this.mutate({startDelta:t})}moveEnd(e){let t=nn(e);t&&this.mutate({endDelta:t})}moveDates(e){let t=nn(e);t&&this.mutate({datesDelta:t})}setAllDay(e,t={}){let n={allDay:e},{maintainDuration:i}=t;i==null&&(i=this._context.options.allDayMaintainDuration),this._def.allDay!==e&&(n.hasEnd=i),this.mutate({standardProps:n})}formatRange(e){let{dateEnv:t}=this._context,n=this._instance,i=Pn(e);return this._def.hasEnd?t.formatRange(n.range.start,n.range.end,i,{forcedStartTzo:n.forcedStartTzo,forcedEndTzo:n.forcedEndTzo}):t.format(n.range.start,i,{forcedTzo:n.forcedStartTzo})}mutate(e){let t=this._instance;if(t){let n=this._def,i=this._context,{eventStore:r}=i.getCurrentData(),o=Bv(r,t.instanceId);o=zv(o,{"":{display:"",startEditable:!0,durationEditable:!0,constraints:[],overlap:null,allows:[],backgroundColor:"",borderColor:"",textColor:"",classNames:[]}},e,i);let l=new s(i,n,t);this._def=o.defs[n.defId],this._instance=o.instances[t.instanceId],i.dispatch({type:"MERGE_EVENTS",eventStore:o}),i.emitter.trigger("eventChange",{oldEvent:l,event:this,relatedEvents:Aa(o,i,t),revert(){i.dispatch({type:"RESET_EVENTS",eventStore:r})}})}}remove(){let e=this._context,t=_8(this);e.dispatch({type:"REMOVE_EVENTS",eventStore:t}),e.emitter.trigger("eventRemove",{event:this,relatedEvents:[],revert(){e.dispatch({type:"MERGE_EVENTS",eventStore:t})}})}get source(){let{sourceId:e}=this._def;return e?new Uc(this._context,this._context.getCurrentData().eventSources[e]):null}get start(){return this._instance?this._context.dateEnv.toDate(this._instance.range.start):null}get end(){return this._instance&&this._def.hasEnd?this._context.dateEnv.toDate(this._instance.range.end):null}get startStr(){let e=this._instance;return e?this._context.dateEnv.formatIso(e.range.start,{omitTime:this._def.allDay,forcedTzo:e.forcedStartTzo}):""}get endStr(){let e=this._instance;return e&&this._def.hasEnd?this._context.dateEnv.formatIso(e.range.end,{omitTime:this._def.allDay,forcedTzo:e.forcedEndTzo}):""}get id(){return this._def.publicId}get groupId(){return this._def.groupId}get allDay(){return this._def.allDay}get title(){return this._def.title}get url(){return this._def.url}get display(){return this._def.ui.display||"auto"}get startEditable(){return this._def.ui.startEditable}get durationEditable(){return this._def.ui.durationEditable}get constraint(){return this._def.ui.constraints[0]||null}get overlap(){return this._def.ui.overlap}get allow(){return this._def.ui.allows[0]||null}get backgroundColor(){return this._def.ui.backgroundColor}get borderColor(){return this._def.ui.borderColor}get textColor(){return this._def.ui.textColor}get classNames(){return this._def.ui.classNames}get extendedProps(){return this._def.extendedProps}toPlainObject(e={}){let t=this._def,{ui:n}=t,{startStr:i,endStr:r}=this,o={allDay:t.allDay};return t.title&&(o.title=t.title),i&&(o.start=i),r&&(o.end=r),t.publicId&&(o.id=t.publicId),t.groupId&&(o.groupId=t.groupId),t.url&&(o.url=t.url),n.display&&n.display!=="auto"&&(o.display=n.display),e.collapseColor&&n.backgroundColor&&n.backgroundColor===n.borderColor?o.color=n.backgroundColor:(n.backgroundColor&&(o.backgroundColor=n.backgroundColor),n.borderColor&&(o.borderColor=n.borderColor)),n.textColor&&(o.textColor=n.textColor),n.classNames.length&&(o.classNames=n.classNames),Object.keys(t.extendedProps).length&&(e.collapseExtendedProps?Object.assign(o,t.extendedProps):o.extendedProps=t.extendedProps),o}toJSON(){return this.toPlainObject()}};function _8(s){let e=s._def,t=s._instance;return{defs:{[e.defId]:e},instances:t?{[t.instanceId]:t}:{}}}function Aa(s,e,t){let{defs:n,instances:i}=s,r=[],o=t?t.instanceId:"";for(let a in i){let l=i[a],c=n[l.defId];l.instanceId!==o&&r.push(new Vn(e,c,l))}return r}function Zf(s,e,t,n){let i={},r={},o={},a=[],l=[],c=Tx(s.defs,e);for(let d in s.defs){let u=s.defs[d];c[u.defId].display==="inverse-background"&&(u.groupId?(i[u.groupId]=[],o[u.groupId]||(o[u.groupId]=u)):r[d]=[])}for(let d in s.instances){let u=s.instances[d],h=s.defs[u.defId],p=c[h.defId],f=u.range,_=!h.allDay&&n?Lx(f,n):f,b=Sr(_,t);b&&(p.display==="inverse-background"?h.groupId?i[h.groupId].push(b):r[u.defId].push(b):p.display!=="none"&&(p.display==="background"?a:l).push({def:h,ui:p,instance:u,range:b,isStart:_.start&&_.start.valueOf()===b.start.valueOf(),isEnd:_.end&&_.end.valueOf()===b.end.valueOf()}))}for(let d in i){let u=i[d],h=z6(u,t);for(let p of h){let f=o[d],_=c[f.defId];a.push({def:f,ui:_,instance:null,range:p,isStart:!1,isEnd:!1})}}for(let d in r){let u=r[d],h=z6(u,t);for(let p of h)a.push({def:s.defs[d],ui:c[d],instance:null,range:p,isStart:!1,isEnd:!1})}return{bg:a,fg:l}}function RR(s){return s.ui.display==="background"||s.ui.display==="inverse-background"}function V6(s,e){s.fcSeg=e}function Il(s){return s.fcSeg||s.parentNode.fcSeg||null}function Tx(s,e){return qr(s,t=>y8(t,e))}function y8(s,e){let t=[];return e[""]&&t.push(e[""]),e[s.defId]&&t.push(e[s.defId]),t.push(s.ui),CR(t)}function vh(s,e){let t=s.map(Jie);return t.sort((n,i)=>Z6(n,i,e)),t.map(n=>n._seg)}function Jie(s){let{eventRange:e}=s,t=e.def,n=e.instance?e.instance.range:e.range,i=n.start?n.start.valueOf():0,r=n.end?n.end.valueOf():0;return Object.assign(Object.assign(Object.assign({},t.extendedProps),t),{id:t.publicId,start:i,end:r,duration:r-i,allDay:Number(t.allDay),_seg:s})}function Zie(s,e){let{pluginHooks:t}=e,n=t.isDraggableTransformers,{def:i,ui:r}=s.eventRange,o=r.startEditable;for(let a of n)o=a(o,i,r,e);return o}function ere(s,e){return s.isStart&&s.eventRange.ui.durationEditable&&e.options.eventResizableFromStart}function tre(s,e){return s.isEnd&&s.eventRange.ui.durationEditable}function Jc(s,e,t,n,i,r,o){let{dateEnv:a,options:l}=t,{displayEventTime:c,displayEventEnd:d}=l,u=s.eventRange.def,h=s.eventRange.instance;c==null&&(c=n!==!1),d==null&&(d=i!==!1);let p=h.range.start,f=h.range.end,_=r||s.start||s.eventRange.range.start,b=o||s.end||s.eventRange.range.end,y=Sn(p).valueOf()===Sn(_).valueOf(),w=Sn(Ta(f,-1)).valueOf()===Sn(Ta(b,-1)).valueOf();return c&&!u.allDay&&(y||w)?(_=y?p:_,b=w?f:b,d&&u.hasEnd?a.formatRange(_,b,e,{forcedStartTzo:r?null:h.forcedStartTzo,forcedEndTzo:o?null:h.forcedEndTzo}):a.format(_,e,{forcedTzo:r?null:h.forcedStartTzo})):""}function Ar(s,e,t){let n=s.eventRange.range;return{isPast:n.end<=(t||e.start),isFuture:n.start>=(t||e.end),isToday:e&&jr(e,n.start)}}function nre(s){let e=["fc-event"];return s.isMirror&&e.push("fc-event-mirror"),s.isDraggable&&e.push("fc-event-draggable"),(s.isStartResizable||s.isEndResizable)&&e.push("fc-event-resizable"),s.isDragging&&e.push("fc-event-dragging"),s.isResizing&&e.push("fc-event-resizing"),s.isSelected&&e.push("fc-event-selected"),s.isStart&&e.push("fc-event-start"),s.isEnd&&e.push("fc-event-end"),s.isPast&&e.push("fc-event-past"),s.isToday&&e.push("fc-event-today"),s.isFuture&&e.push("fc-event-future"),e}function Uv(s){return s.instance?s.instance.instanceId:`${s.def.defId}:${s.range.start.toISOString()}`}function rm(s,e){let{def:t,instance:n}=s.eventRange,{url:i}=t;if(i)return{href:i};let{emitter:r,options:o}=e,{eventInteractive:a}=o;return a==null&&(a=t.interactive,a==null&&(a=!!r.hasHandlers("eventClick"))),a?Q6(l=>{r.trigger("eventClick",{el:l.target,event:new Vn(e,t,n),jsEvent:l,view:e.viewApi})}):{}}var sre={start:Ae,end:Ae,allDay:Boolean};function ire(s,e,t){let n=rre(s,e),{range:i}=n;if(!i.start)return null;if(!i.end){if(t==null)return null;i.end=e.add(i.start,t)}return n}function rre(s,e){let{refined:t,extra:n}=Ix(s,sre),i=t.start?e.createMarkerMeta(t.start):null,r=t.end?e.createMarkerMeta(t.end):null,{allDay:o}=t;return o==null&&(o=i&&i.isTimeUnspecified&&(!r||r.isTimeUnspecified)),Object.assign({range:{start:i?i.marker:null,end:r?r.marker:null},allDay:o},n)}function FR(s,e){return d8(s.range,e.range)&&s.allDay===e.allDay&&ore(s,e)}function ore(s,e){for(let t in e)if(t!=="range"&&t!=="allDay"&&s[t]!==e[t])return!1;for(let t in s)if(!(t in e))return!1;return!0}function are(s,e){return Object.assign(Object.assign({},v8(s.range,e,s.allDay)),{allDay:s.allDay})}function LR(s,e,t){return Object.assign(Object.assign({},v8(s,e,t)),{timeZone:e.timeZone})}function v8(s,e,t){return{start:e.toDate(s.start),end:e.toDate(s.end),startStr:e.formatIso(s.start,{omitTime:t}),endStr:e.formatIso(s.end,{omitTime:t})}}function lre(s,e,t){let n=Nx({editable:!1},t),i=wv(n.refined,n.extra,"",s.allDay,!0,t);return{def:i,ui:y8(i,e),instance:$v(i.defId,s.range),range:s.range,isStart:!0,isEnd:!0}}function NR(s,e,t){let n=!1,i=function(a){n||(n=!0,e(a))},r=function(a){n||(n=!0,t(a))},o=s(i,r);o&&typeof o.then=="function"&&o.then(i,r)}var Ex=class extends Error{constructor(e,t){super(e),this.response=t}};function OR(s,e,t){s=s.toUpperCase();let n={method:s};return s==="GET"?e+=(e.indexOf("?")===-1?"?":"&")+new URLSearchParams(t):(n.body=new URLSearchParams(t),n.headers={"Content-Type":"application/x-www-form-urlencoded"}),fetch(e,n).then(i=>{if(i.ok)return i.json().then(r=>[r,i],()=>{throw new Ex("Failure parsing JSON",i)});throw new Ex("Request failed",i)})}var z1;function $R(){return z1==null&&(z1=cre()),z1}function cre(){if(typeof document>"u")return!0;let s=document.createElement("div");s.style.position="absolute",s.style.top="0px",s.style.left="0px",s.innerHTML="<table><tr><td><div></div></td></tr></table>",s.querySelector("table").style.height="100px",s.querySelector("div").style.height="100%",document.body.appendChild(s);let t=s.querySelector("div").offsetHeight>0;return document.body.removeChild(s),t}var Ev=class extends sn{constructor(){super(...arguments),this.state={forPrint:!1},this.handleBeforePrint=()=>{vv(()=>{this.setState({forPrint:!0})})},this.handleAfterPrint=()=>{vv(()=>{this.setState({forPrint:!1})})}}render(){let{props:e}=this,{options:t}=e,{forPrint:n}=this.state,i=n||t.height==="auto"||t.contentHeight==="auto",r=!i&&t.height!=null?t.height:"",o=["fc",n?"fc-media-print":"fc-media-screen",`fc-direction-${t.direction}`,e.theme.getClass("root")];return $R()||o.push("fc-liquid-hack"),e.children(o,r,i,n)}componentDidMount(){let{emitter:e}=this.props;e.on("_beforeprint",this.handleBeforePrint),e.on("_afterprint",this.handleAfterPrint)}componentWillUnmount(){let{emitter:e}=this.props;e.off("_beforeprint",this.handleBeforePrint),e.off("_afterprint",this.handleAfterPrint)}},$o=class{constructor(e){this.component=e.component,this.isHitComboAllowed=e.isHitComboAllowed||null}destroy(){}};function b8(s,e){return{component:s,el:e.el,useEventCenter:e.useEventCenter!=null?e.useEventCenter:!0,isHitComboAllowed:e.isHitComboAllowed||null}}function Vv(s){return{[s.component.uid]:s}}var om={},er=class extends pi{constructor(e,t){super(e,t),this.handleRefresh=()=>{let n=this.computeTiming();n.state.nowDate.valueOf()!==this.state.nowDate.valueOf()&&this.setState(n.state),this.clearTimeout(),this.setTimeout(n.waitMs)},this.handleVisibilityChange=()=>{document.hidden||this.handleRefresh()},this.state=this.computeTiming().state}render(){let{props:e,state:t}=this;return e.children(t.nowDate,t.todayRange)}componentDidMount(){this.setTimeout(),this.context.nowManager.addResetListener(this.handleRefresh),document.addEventListener("visibilitychange",this.handleVisibilityChange)}componentDidUpdate(e){e.unit!==this.props.unit&&(this.clearTimeout(),this.setTimeout())}componentWillUnmount(){this.clearTimeout(),this.context.nowManager.removeResetListener(this.handleRefresh),document.removeEventListener("visibilitychange",this.handleVisibilityChange)}computeTiming(){let{props:e,context:t}=this,n=t.nowManager.getDateMarker(),{nowIndicatorSnap:i}=t.options;i==="auto"&&(i=/year|month|week|day/.test(e.unit)||(e.unitValue||1)===1);let r,o;return i?(r=t.dateEnv.startOf(n,e.unit),o=t.dateEnv.add(r,nn(1,e.unit)).valueOf()-n.valueOf()):(r=n,o=1e3*60),o=Math.min(1e3*60*60*24,o),{state:{nowDate:r,todayRange:dre(r)},waitMs:o}}setTimeout(e=this.computeTiming().waitMs){this.timeoutId=setTimeout(()=>{let t=this.computeTiming();this.setState(t.state,()=>{this.setTimeout(t.waitMs)})},e)}clearTimeout(){this.timeoutId&&clearTimeout(this.timeoutId)}};er.contextType=Yr;function dre(s){let e=Sn(s),t=ts(e,1);return{start:e,end:t}}var xv=class{getCurrentData(){return this.currentDataManager.getCurrentData()}dispatch(e){this.currentDataManager.dispatch(e)}get view(){return this.getCurrentData().viewApi}batchRendering(e){e()}updateSize(){this.trigger("_resize",!0)}setOption(e,t){this.dispatch({type:"SET_OPTION",optionName:e,rawOptionValue:t})}getOption(e){return this.currentDataManager.currentCalendarOptionsInput[e]}getAvailableLocaleCodes(){return Object.keys(this.getCurrentData().availableRawLocales)}on(e,t){let{currentDataManager:n}=this;n.currentCalendarOptionsRefiners[e]?n.emitter.on(e,t):console.warn(`Unknown listener name '${e}'`)}off(e,t){this.currentDataManager.emitter.off(e,t)}trigger(e,...t){this.currentDataManager.emitter.trigger(e,...t)}changeView(e,t){this.batchRendering(()=>{if(this.unselect(),t)if(t.start&&t.end)this.dispatch({type:"CHANGE_VIEW_TYPE",viewType:e}),this.dispatch({type:"SET_OPTION",optionName:"visibleRange",rawOptionValue:t});else{let{dateEnv:n}=this.getCurrentData();this.dispatch({type:"CHANGE_VIEW_TYPE",viewType:e,dateMarker:n.createMarker(t)})}else this.dispatch({type:"CHANGE_VIEW_TYPE",viewType:e})})}zoomTo(e,t){let n=this.getCurrentData(),i;t=t||"day",i=n.viewSpecs[t]||this.getUnitViewSpec(t),this.unselect(),i?this.dispatch({type:"CHANGE_VIEW_TYPE",viewType:i.type,dateMarker:e}):this.dispatch({type:"CHANGE_DATE",dateMarker:e})}getUnitViewSpec(e){let{viewSpecs:t,toolbarConfig:n}=this.getCurrentData(),i=[].concat(n.header?n.header.viewsWithButtons:[],n.footer?n.footer.viewsWithButtons:[]),r,o;for(let a in t)i.push(a);for(r=0;r<i.length;r+=1)if(o=t[i[r]],o&&o.singleUnit===e)return o;return null}prev(){this.unselect(),this.dispatch({type:"PREV"})}next(){this.unselect(),this.dispatch({type:"NEXT"})}prevYear(){let e=this.getCurrentData();this.unselect(),this.dispatch({type:"CHANGE_DATE",dateMarker:e.dateEnv.addYears(e.currentDate,-1)})}nextYear(){let e=this.getCurrentData();this.unselect(),this.dispatch({type:"CHANGE_DATE",dateMarker:e.dateEnv.addYears(e.currentDate,1)})}today(){let e=this.getCurrentData();this.unselect(),this.dispatch({type:"CHANGE_DATE",dateMarker:e.nowManager.getDateMarker()})}gotoDate(e){let t=this.getCurrentData();this.unselect(),this.dispatch({type:"CHANGE_DATE",dateMarker:t.dateEnv.createMarker(e)})}incrementDate(e){let t=this.getCurrentData(),n=nn(e);n&&(this.unselect(),this.dispatch({type:"CHANGE_DATE",dateMarker:t.dateEnv.add(t.currentDate,n)}))}getDate(){let e=this.getCurrentData();return e.dateEnv.toDate(e.currentDate)}formatDate(e,t){let{dateEnv:n}=this.getCurrentData();return n.format(n.createMarker(e),Pn(t))}formatRange(e,t,n){let{dateEnv:i}=this.getCurrentData();return i.formatRange(i.createMarker(e),i.createMarker(t),Pn(n),n)}formatIso(e,t){let{dateEnv:n}=this.getCurrentData();return n.formatIso(n.createMarker(e),{omitTime:t})}select(e,t){let n;t==null?e.start!=null?n=e:n={start:e,end:null}:n={start:e,end:t};let i=this.getCurrentData(),r=ire(n,i.dateEnv,nn({days:1}));r&&(this.dispatch({type:"SELECT_DATES",selection:r}),Bx(r,null,i))}unselect(e){let t=this.getCurrentData();t.dateSelection&&(this.dispatch({type:"UNSELECT_DATES"}),Yie(e,t))}addEvent(e,t){if(e instanceof Vn){let o=e._def,a=e._instance;return this.getCurrentData().eventStore.defs[o.defId]||(this.dispatch({type:"ADD_EVENTS",eventStore:Tv({def:o,instance:a})}),this.triggerEventAdd(e)),e}let n=this.getCurrentData(),i;if(t instanceof Uc)i=t.internalEventSource;else if(typeof t=="boolean")t&&([i]=Rx(n.eventSources));else if(t!=null){let o=this.getEventSourceById(t);if(!o)return console.warn(`Could not find an event source with ID "${t}"`),null;i=o.internalEventSource}let r=p8(e,i,n,!1);if(r){let o=new Vn(n,r.def,r.def.recurringDef?null:r.instance);return this.dispatch({type:"ADD_EVENTS",eventStore:Tv(r)}),this.triggerEventAdd(o),o}return null}triggerEventAdd(e){let{emitter:t}=this.getCurrentData();t.trigger("eventAdd",{event:e,relatedEvents:[],revert:()=>{this.dispatch({type:"REMOVE_EVENTS",eventStore:_8(e)})}})}getEventById(e){let t=this.getCurrentData(),{defs:n,instances:i}=t.eventStore;e=String(e);for(let r in n){let o=n[r];if(o.publicId===e){if(o.recurringDef)return new Vn(t,o,null);for(let a in i){let l=i[a];if(l.defId===o.defId)return new Vn(t,o,l)}}}return null}getEvents(){let e=this.getCurrentData();return Aa(e.eventStore,e)}removeAllEvents(){this.dispatch({type:"REMOVE_ALL_EVENTS"})}getEventSources(){let e=this.getCurrentData(),t=e.eventSources,n=[];for(let i in t)n.push(new Uc(e,t[i]));return n}getEventSourceById(e){let t=this.getCurrentData(),n=t.eventSources;e=String(e);for(let i in n)if(n[i].publicId===e)return new Uc(t,n[i]);return null}addEventSource(e){let t=this.getCurrentData();if(e instanceof Uc)return t.eventSources[e.internalEventSource.sourceId]||this.dispatch({type:"ADD_EVENT_SOURCES",sources:[e.internalEventSource]}),e;let n=AR(e,t);return n?(this.dispatch({type:"ADD_EVENT_SOURCES",sources:[n]}),new Uc(t,n)):null}removeAllEventSources(){this.dispatch({type:"REMOVE_ALL_EVENT_SOURCES"})}refetchEvents(){this.dispatch({type:"FETCH_EVENT_SOURCES",isRefetch:!0})}scrollToTime(e){let t=nn(e);t&&this.trigger("_scrollRequest",{time:t})}};function BR(s,e){return s.left>=e.left&&s.left<e.right&&s.top>=e.top&&s.top<e.bottom}function zx(s,e){let t={left:Math.max(s.left,e.left),right:Math.min(s.right,e.right),top:Math.max(s.top,e.top),bottom:Math.min(s.bottom,e.bottom)};return t.left<t.right&&t.top<t.bottom?t:!1}function zR(s,e){return{left:Math.min(Math.max(s.left,e.left),e.right),top:Math.min(Math.max(s.top,e.top),e.bottom)}}function UR(s){return{left:(s.left+s.right)/2,top:(s.top+s.bottom)/2}}function VR(s,e){return{left:s.left-e.left,top:s.top-e.top}}var U1=Ci(),Sv=class{constructor(){this.getKeysForEventDefs=Dt(this._getKeysForEventDefs),this.splitDateSelection=Dt(this._splitDateSpan),this.splitEventStore=Dt(this._splitEventStore),this.splitIndividualUi=Dt(this._splitIndividualUi),this.splitEventDrag=Dt(this._splitInteraction),this.splitEventResize=Dt(this._splitInteraction),this.eventUiBuilders={}}splitProps(e){let t=this.getKeyInfo(e),n=this.getKeysForEventDefs(e.eventStore),i=this.splitDateSelection(e.dateSelection),r=this.splitIndividualUi(e.eventUiBases,n),o=this.splitEventStore(e.eventStore,n),a=this.splitEventDrag(e.eventDrag),l=this.splitEventResize(e.eventResize),c={};this.eventUiBuilders=qr(t,(d,u)=>this.eventUiBuilders[u]||Dt(ure));for(let d in t){let u=t[d],h=o[d]||U1,p=this.eventUiBuilders[d];c[d]={businessHours:u.businessHours||e.businessHours,dateSelection:i[d]||null,eventStore:h,eventUiBases:p(e.eventUiBases[""],u.ui,r[d]),eventSelection:h.instances[e.eventSelection]?e.eventSelection:"",eventDrag:a[d]||null,eventResize:l[d]||null}}return c}_splitDateSpan(e){let t={};if(e){let n=this.getKeysForDateSpan(e);for(let i of n)t[i]=e}return t}_getKeysForEventDefs(e){return qr(e.defs,t=>this.getKeysForEventDef(t))}_splitEventStore(e,t){let{defs:n,instances:i}=e,r={};for(let o in n)for(let a of t[o])r[a]||(r[a]=Ci()),r[a].defs[o]=n[o];for(let o in i){let a=i[o];for(let l of t[a.defId])r[l]&&(r[l].instances[o]=a)}return r}_splitIndividualUi(e,t){let n={};for(let i in e)if(i)for(let r of t[i])n[r]||(n[r]={}),n[r][i]=e[i];return n}_splitInteraction(e){let t={};if(e){let n=this._splitEventStore(e.affectedEvents,this._getKeysForEventDefs(e.affectedEvents)),i=this._getKeysForEventDefs(e.mutatedEvents),r=this._splitEventStore(e.mutatedEvents,i),o=a=>{t[a]||(t[a]={affectedEvents:n[a]||U1,mutatedEvents:r[a]||U1,isEvent:e.isEvent})};for(let a in n)o(a);for(let a in r)o(a)}return t}};function ure(s,e,t){let n=[];s&&n.push(s),e&&n.push(e);let i={"":CR(n)};return t&&Object.assign(i,t),i}function Gv(s,e,t,n){return{dow:s.getUTCDay(),isDisabled:!!(n&&(!n.activeRange||!jr(n.activeRange,s))),isOther:!!(n&&!jr(n.currentRange,s)),isToday:!!(e&&jr(e,s)),isPast:!!(t?s<t:e&&s<e.start),isFuture:!!(t?s>t:e&&s>=e.end)}}function am(s,e){let t=["fc-day",`fc-day-${jse[s.dow]}`];return s.isDisabled?t.push("fc-day-disabled"):(s.isToday&&(t.push("fc-day-today"),t.push(e.getClass("today"))),s.isPast&&t.push("fc-day-past"),s.isFuture&&t.push("fc-day-future"),s.isOther&&t.push("fc-day-other")),t}var hre=Pn({year:"numeric",month:"long",day:"numeric"}),pre=Pn({week:"long"});function Pa(s,e,t="day",n=!0){let{dateEnv:i,options:r,calendarApi:o}=s,a=i.format(e,t==="week"?pre:hre);if(r.navLinks){let l=i.toDate(e),c=d=>{let u=t==="day"?r.navLinkDayClick:t==="week"?r.navLinkWeekClick:null;typeof u=="function"?u.call(o,i.toDate(e),d):(typeof u=="string"&&(t=u),o.zoomTo(e,t))};return Object.assign({title:tm(r.navLinkHint,[a,l],a),"data-navlink":""},n?X6(c):{onClick:c})}return{"aria-label":a}}var V1=null;function w8(){return V1===null&&(V1=fre()),V1}function fre(){let s=document.createElement("div");yh(s,{position:"absolute",top:-1e3,left:0,border:0,padding:0,overflow:"scroll",direction:"rtl"}),s.innerHTML="<div></div>",document.body.appendChild(s);let t=s.firstChild.getBoundingClientRect().left>s.getBoundingClientRect().left;return Dv(s),t}var G1;function M8(){return G1||(G1=mre()),G1}function mre(){let s=document.createElement("div");s.style.overflow="scroll",s.style.position="absolute",s.style.top="-9999px",s.style.left="-9999px",document.body.appendChild(s);let e=T8(s);return document.body.removeChild(s),e}function T8(s){return{x:s.offsetHeight-s.clientHeight,y:s.offsetWidth-s.clientWidth}}function E8(s,e=!1){let t=window.getComputedStyle(s),n=parseInt(t.borderLeftWidth,10)||0,i=parseInt(t.borderRightWidth,10)||0,r=parseInt(t.borderTopWidth,10)||0,o=parseInt(t.borderBottomWidth,10)||0,a=T8(s),l=a.y-n-i,c=a.x-r-o,d={borderLeft:n,borderRight:i,borderTop:r,borderBottom:o,scrollbarBottom:c,scrollbarLeft:0,scrollbarRight:0};return w8()&&t.direction==="rtl"?d.scrollbarLeft=l:d.scrollbarRight=l,e&&(d.paddingLeft=parseInt(t.paddingLeft,10)||0,d.paddingRight=parseInt(t.paddingRight,10)||0,d.paddingTop=parseInt(t.paddingTop,10)||0,d.paddingBottom=parseInt(t.paddingBottom,10)||0),d}function GR(s,e=!1,t){let n=t?s.getBoundingClientRect():Wv(s),i=E8(s,e),r={left:n.left+i.borderLeft+i.scrollbarLeft,right:n.right-i.borderRight-i.scrollbarRight,top:n.top+i.borderTop,bottom:n.bottom-i.borderBottom-i.scrollbarBottom};return e&&(r.left+=i.paddingLeft,r.right-=i.paddingRight,r.top+=i.paddingTop,r.bottom-=i.paddingBottom),r}function Wv(s){let e=s.getBoundingClientRect();return{left:e.left+window.scrollX,top:e.top+window.scrollY,right:e.right+window.scrollX,bottom:e.bottom+window.scrollY}}function gre(s){let e=Ux(s),t=s.getBoundingClientRect();for(let n of e){let i=zx(t,n.getBoundingClientRect());if(i)t=i;else return null}return t}function Ux(s){let e=[];for(;s instanceof HTMLElement;){let t=window.getComputedStyle(s);if(t.position==="fixed")break;/(auto|scroll)/.test(t.overflow+t.overflowY+t.overflowX)&&e.push(s),s=s.parentNode}return e}var Bo=class{constructor(e,t,n,i){this.els=t;let r=this.originClientRect=e.getBoundingClientRect();n&&this.buildElHorizontals(r.left),i&&this.buildElVerticals(r.top)}buildElHorizontals(e){let t=[],n=[];for(let i of this.els){let r=i.getBoundingClientRect();t.push(r.left-e),n.push(r.right-e)}this.lefts=t,this.rights=n}buildElVerticals(e){let t=[],n=[];for(let i of this.els){let r=i.getBoundingClientRect();t.push(r.top-e),n.push(r.bottom-e)}this.tops=t,this.bottoms=n}leftToIndex(e){let{lefts:t,rights:n}=this,i=t.length,r;for(r=0;r<i;r+=1)if(e>=t[r]&&e<n[r])return r}topToIndex(e){let{tops:t,bottoms:n}=this,i=t.length,r;for(r=0;r<i;r+=1)if(e>=t[r]&&e<n[r])return r}getWidth(e){return this.rights[e]-this.lefts[e]}getHeight(e){return this.bottoms[e]-this.tops[e]}similarTo(e){return hx(this.tops||[],e.tops||[])&&hx(this.bottoms||[],e.bottoms||[])&&hx(this.lefts||[],e.lefts||[])&&hx(this.rights||[],e.rights||[])}};function hx(s,e){let t=s.length;if(t!==e.length)return!1;for(let n=0;n<t;n++)if(Math.round(s[n])!==Math.round(e[n]))return!1;return!0}var dh=class{getMaxScrollTop(){return this.getScrollHeight()-this.getClientHeight()}getMaxScrollLeft(){return this.getScrollWidth()-this.getClientWidth()}canScrollVertically(){return this.getMaxScrollTop()>0}canScrollHorizontally(){return this.getMaxScrollLeft()>0}canScrollUp(){return this.getScrollTop()>0}canScrollDown(){return this.getScrollTop()<this.getMaxScrollTop()}canScrollLeft(){return this.getScrollLeft()>0}canScrollRight(){return this.getScrollLeft()<this.getMaxScrollLeft()}},Cv=class extends dh{constructor(e){super(),this.el=e}getScrollTop(){return this.el.scrollTop}getScrollLeft(){return this.el.scrollLeft}setScrollTop(e){this.el.scrollTop=e}setScrollLeft(e){this.el.scrollLeft=e}getScrollWidth(){return this.el.scrollWidth}getScrollHeight(){return this.el.scrollHeight}getClientHeight(){return this.el.clientHeight}getClientWidth(){return this.el.clientWidth}},Av=class extends dh{getScrollTop(){return window.scrollY}getScrollLeft(){return window.scrollX}setScrollTop(e){window.scroll(window.scrollX,e)}setScrollLeft(e){window.scroll(e,window.scrollY)}getScrollWidth(){return document.documentElement.scrollWidth}getScrollHeight(){return document.documentElement.scrollHeight}getClientHeight(){return document.documentElement.clientHeight}getClientWidth(){return document.documentElement.clientWidth}},fi=class extends sn{constructor(){super(...arguments),this.uid=kl()}prepareHits(){}queryHit(e,t,n,i){return null}isValidSegDownEl(e){return!this.props.eventDrag&&!this.props.eventResize&&!Gs(e,".fc-event-mirror")}isValidDateDownEl(e){return!Gs(e,".fc-event:not(.fc-bg-event)")&&!Gs(e,".fc-more-link")&&!Gs(e,"a[data-navlink]")&&!Gs(e,".fc-popover")}};var uh=class{constructor(e=t=>t.thickness||1){this.getEntryThickness=e,this.strictOrder=!1,this.allowReslicing=!1,this.maxCoord=-1,this.maxStackCnt=-1,this.levelCoords=[],this.entriesByLevel=[],this.stackCnts={}}addSegs(e){let t=[];for(let n of e)this.insertEntry(n,t);return t}insertEntry(e,t){let n=this.findInsertion(e);this.isInsertionValid(n,e)?this.insertEntryAt(e,n):this.handleInvalidInsertion(n,e,t)}isInsertionValid(e,t){return(this.maxCoord===-1||e.levelCoord+this.getEntryThickness(t)<=this.maxCoord)&&(this.maxStackCnt===-1||e.stackCnt<this.maxStackCnt)}handleInvalidInsertion(e,t,n){if(this.allowReslicing&&e.touchingEntry){let i=Object.assign(Object.assign({},t),{span:Hv(t.span,e.touchingEntry.span)});n.push(i),this.splitEntry(t,e.touchingEntry,n)}else n.push(t)}splitEntry(e,t,n){let i=e.span,r=t.span;i.start<r.start&&this.insertEntry({index:e.index,thickness:e.thickness,span:{start:i.start,end:r.start}},n),i.end>r.end&&this.insertEntry({index:e.index,thickness:e.thickness,span:{start:r.end,end:i.end}},n)}insertEntryAt(e,t){let{entriesByLevel:n,levelCoords:i}=this;t.lateral===-1?(W1(i,t.level,t.levelCoord),W1(n,t.level,[e])):W1(n[t.level],t.lateral,e),this.stackCnts[xa(e)]=t.stackCnt}findInsertion(e){let{levelCoords:t,entriesByLevel:n,strictOrder:i,stackCnts:r}=this,o=t.length,a=0,l=-1,c=-1,d=null,u=0;for(let f=0;f<o;f+=1){let _=t[f];if(!i&&_>=a+this.getEntryThickness(e))break;let b=n[f],y,w=kv(b,e.span.start,Pv),C=w[0]+w[1];for(;(y=b[C])&&y.span.start<e.span.end;){let M=_+this.getEntryThickness(y);M>a&&(a=M,d=y,l=f,c=C),M===a&&(u=Math.max(u,r[xa(y)]+1)),C+=1}}let h=0;if(d)for(h=l+1;h<o&&t[h]<a;)h+=1;let p=-1;return h<o&&t[h]===a&&(p=kv(n[h],e.span.end,Pv)[0]),{touchingLevel:l,touchingLateral:c,touchingEntry:d,stackCnt:u,levelCoord:a,level:h,lateral:p}}toRects(){let{entriesByLevel:e,levelCoords:t}=this,n=e.length,i=[];for(let r=0;r<n;r+=1){let o=e[r],a=t[r];for(let l of o)i.push(Object.assign(Object.assign({},l),{thickness:this.getEntryThickness(l),levelCoord:a}))}return i}};function Pv(s){return s.span.end}function xa(s){return s.index+":"+s.span.start}function WR(s){let e=[];for(let t of s){let n=[],i={span:t.span,entries:[t]};for(let r of e)Hv(r.span,i.span)?i={entries:r.entries.concat(i.entries),span:_re(r.span,i.span)}:n.push(r);n.push(i),e=n}return e}function _re(s,e){return{start:Math.min(s.start,e.start),end:Math.max(s.end,e.end)}}function Hv(s,e){let t=Math.max(s.start,e.start),n=Math.min(s.end,e.end);return t<n?{start:t,end:n}:null}function W1(s,e,t){s.splice(e,0,t)}function kv(s,e,t){let n=0,i=s.length;if(!i||e<t(s[n]))return[0,0];if(e>t(s[i-1]))return[i,0];for(;n<i;){let r=Math.floor(n+(i-n)/2),o=t(s[r]);if(e<o)i=r;else if(e>o)n=r+1;else return[r,1]}return[n,0]}var Iv=class{constructor(e,t){this.emitter=new Al}destroy(){}setMirrorIsVisible(e){}setMirrorNeedsRevert(e){}setAutoScrollEnabled(e){}},jv={};function x8(s,e){return!s||e>10?Pn({weekday:"short"}):e>1?Pn({weekday:"short",month:"numeric",day:"numeric",omitCommas:!0}):Pn({weekday:"long"})}var S8="fc-col-header-cell";function C8(s){return s.text}var xx=class extends sn{render(){let{dateEnv:e,options:t,theme:n,viewApi:i}=this.context,{props:r}=this,{date:o,dateProfile:a}=r,l=Gv(o,r.todayRange,null,a),c=[S8].concat(am(l,n)),d=e.format(o,r.dayHeaderFormat),u=!l.isDisabled&&r.colCnt>1?Pa(this.context,o):{},h=e.toDate(o);e.namedTimeZoneImpl&&(h=Ta(h,36e5));let p=Object.assign(Object.assign(Object.assign({date:h,view:i},r.extraRenderProps),{text:d}),l);return ce(ms,{elTag:"th",elClasses:c,elAttrs:Object.assign({role:"columnheader",colSpan:r.colSpan,"data-date":l.isDisabled?void 0:Yc(o)},r.extraDataAttrs),renderProps:p,generatorName:"dayHeaderContent",customGenerator:t.dayHeaderContent,defaultGenerator:C8,classNameGenerator:t.dayHeaderClassNames,didMount:t.dayHeaderDidMount,willUnmount:t.dayHeaderWillUnmount},f=>ce("div",{className:"fc-scrollgrid-sync-inner"},!l.isDisabled&&ce(f,{elTag:"a",elAttrs:u,elClasses:["fc-col-header-cell-cushion",r.isSticky&&"fc-sticky"]})))}},yre=Pn({weekday:"long"}),Sx=class extends sn{render(){let{props:e}=this,{dateEnv:t,theme:n,viewApi:i,options:r}=this.context,o=ts(new Date(2592e5),e.dow),a={dow:e.dow,isDisabled:!1,isFuture:!1,isPast:!1,isToday:!1,isOther:!1},l=t.format(o,e.dayHeaderFormat),c=Object.assign(Object.assign(Object.assign(Object.assign({date:o},a),{view:i}),e.extraRenderProps),{text:l});return ce(ms,{elTag:"th",elClasses:[S8,...am(a,n),...e.extraClassNames||[]],elAttrs:Object.assign({role:"columnheader",colSpan:e.colSpan},e.extraDataAttrs),renderProps:c,generatorName:"dayHeaderContent",customGenerator:r.dayHeaderContent,defaultGenerator:C8,classNameGenerator:r.dayHeaderClassNames,didMount:r.dayHeaderDidMount,willUnmount:r.dayHeaderWillUnmount},d=>ce("div",{className:"fc-scrollgrid-sync-inner"},ce(d,{elTag:"a",elClasses:["fc-col-header-cell-cushion",e.isSticky&&"fc-sticky"],elAttrs:{"aria-label":t.format(o,yre)}})))}},hh=class extends sn{constructor(){super(...arguments),this.createDayHeaderFormatter=Dt(vre)}render(){let{context:e}=this,{dates:t,dateProfile:n,datesRepDistinctDays:i,renderIntro:r}=this.props,o=this.createDayHeaderFormatter(e.options.dayHeaderFormat,i,t.length);return ce(er,{unit:"day"},(a,l)=>ce("tr",{role:"row"},r&&r("day"),t.map(c=>i?ce(xx,{key:c.toISOString(),date:c,dateProfile:n,todayRange:l,colCnt:t.length,dayHeaderFormat:o}):ce(Sx,{key:c.getUTCDay(),dow:c.getUTCDay(),dayHeaderFormat:o}))))}};function vre(s,e,t){return s||x8(e,t)}var ph=class{constructor(e,t){let n=e.start,{end:i}=e,r=[],o=[],a=-1;for(;n<i;)t.isHiddenDay(n)?r.push(a+.5):(a+=1,r.push(a),o.push(n)),n=ts(n,1);this.dates=o,this.indices=r,this.cnt=o.length}sliceRange(e){let t=this.getDateDayIndex(e.start),n=this.getDateDayIndex(ts(e.end,-1)),i=Math.max(0,t),r=Math.min(this.cnt-1,n);return i=Math.ceil(i),r=Math.floor(r),i<=r?{firstIndex:i,lastIndex:r,isStart:t===i,isEnd:n===r}:null}getDateDayIndex(e){let{indices:t}=this,n=Math.floor(Ca(this.dates[0],e));return n<0?t[0]-1:n>=t.length?t[t.length-1]+1:t[n]}},fh=class{constructor(e,t){let{dates:n}=e,i,r,o;if(t){for(r=n[0].getUTCDay(),i=1;i<n.length&&n[i].getUTCDay()!==r;i+=1);o=Math.ceil(n.length/i)}else o=1,i=n.length;this.rowCnt=o,this.colCnt=i,this.daySeries=e,this.cells=this.buildCells(),this.headerDates=this.buildHeaderDates()}buildCells(){let e=[];for(let t=0;t<this.rowCnt;t+=1){let n=[];for(let i=0;i<this.colCnt;i+=1)n.push(this.buildCell(t,i));e.push(n)}return e}buildCell(e,t){let n=this.daySeries.dates[e*this.colCnt+t];return{key:n.toISOString(),date:n}}buildHeaderDates(){let e=[];for(let t=0;t<this.colCnt;t+=1)e.push(this.cells[0][t].date);return e}sliceRange(e){let{colCnt:t}=this,n=this.daySeries.sliceRange(e),i=[];if(n){let{firstIndex:r,lastIndex:o}=n,a=r;for(;a<=o;){let l=Math.floor(a/t),c=Math.min((l+1)*t,o+1);i.push({row:l,firstCol:a%t,lastCol:(c-1)%t,isStart:n.isStart&&a===r,isEnd:n.isEnd&&c-1===o}),a=c}}return i}},mh=class{constructor(){this.sliceBusinessHours=Dt(this._sliceBusinessHours),this.sliceDateSelection=Dt(this._sliceDateSpan),this.sliceEventStore=Dt(this._sliceEventStore),this.sliceEventDrag=Dt(this._sliceInteraction),this.sliceEventResize=Dt(this._sliceInteraction),this.forceDayIfListItem=!1}sliceProps(e,t,n,i,...r){let{eventUiBases:o}=e,a=this.sliceEventStore(e.eventStore,o,t,n,...r);return{dateSelectionSegs:this.sliceDateSelection(e.dateSelection,t,n,o,i,...r),businessHourSegs:this.sliceBusinessHours(e.businessHours,t,n,i,...r),fgEventSegs:a.fg,bgEventSegs:a.bg,eventDrag:this.sliceEventDrag(e.eventDrag,o,t,n,...r),eventResize:this.sliceEventResize(e.eventResize,o,t,n,...r),eventSelection:e.eventSelection}}sliceNowDate(e,t,n,i,...r){return this._sliceDateSpan({range:{start:e,end:Ta(e,1)},allDay:!1},t,n,{},i,...r)}_sliceBusinessHours(e,t,n,i,...r){return e?this._sliceEventStore(ch(e,px(t,!!n),i),{},t,n,...r).bg:[]}_sliceEventStore(e,t,n,i,...r){if(e){let o=Zf(e,t,px(n,!!i),i);return{bg:this.sliceEventRanges(o.bg,r),fg:this.sliceEventRanges(o.fg,r)}}return{bg:[],fg:[]}}_sliceInteraction(e,t,n,i,...r){if(!e)return null;let o=Zf(e.mutatedEvents,t,px(n,!!i),i);return{segs:this.sliceEventRanges(o.fg,r),affectedInstances:e.affectedEvents.instances,isEvent:e.isEvent}}_sliceDateSpan(e,t,n,i,r,...o){if(!e)return[];let a=px(t,!!n),l=Sr(e.range,a);if(l){e=Object.assign(Object.assign({},e),{range:l});let c=lre(e,i,r),d=this.sliceRange(e.range,...o);for(let u of d)u.eventRange=c;return d}return[]}sliceEventRanges(e,t){let n=[];for(let i of e)n.push(...this.sliceEventRange(i,t));return n}sliceEventRange(e,t){let n=e.range;this.forceDayIfListItem&&e.ui.display==="list-item"&&(n={start:n.start,end:ts(n.start,1)});let i=this.sliceRange(n,...t);for(let r of i)r.eventRange=e,r.isStart=e.isStart&&r.isStart,r.isEnd=e.isEnd&&r.isEnd;return i}};function px(s,e){let t=s.activeRange;return e?t:{start:Ta(t.start,s.slotMinTime.milliseconds),end:Ta(t.end,s.slotMaxTime.milliseconds-864e5)}}function Vx(s,e,t){let{instances:n}=s.mutatedEvents;for(let i in n)if(!sm(e.validRange,n[i].range))return!1;return A8({eventDrag:s},t)}function HR(s,e,t){return sm(e.validRange,s.range)?A8({dateSelection:s},t):!1}function A8(s,e){let t=e.getCurrentData(),n=Object.assign({businessHours:t.businessHours,dateSelection:"",eventStore:t.eventStore,eventUiBases:t.eventUiBases,eventSelection:"",eventDrag:null,eventResize:null},s);return(e.pluginHooks.isPropsValid||P8)(n,e)}function P8(s,e,t={},n){return!(s.eventDrag&&!bre(s,e,t,n)||s.dateSelection&&!wre(s,e,t,n))}function bre(s,e,t,n){let i=e.getCurrentData(),r=s.eventDrag,o=r.mutatedEvents,a=o.defs,l=o.instances,c=Tx(a,r.isEvent?s.eventUiBases:{"":i.selectionConfig});n&&(c=qr(c,n));let d=Gie(s.eventStore,r.affectedEvents.instances),u=d.defs,h=d.instances,p=Tx(u,s.eventUiBases);for(let f in l){let _=l[f],b=_.range,y=c[_.defId],w=a[_.defId];if(!k8(y.constraints,b,d,s.businessHours,e))return!1;let{eventOverlap:C}=e.options,M=typeof C=="function"?C:null;for(let k in h){let T=h[k];if(Fx(b,T.range)&&(p[T.defId].overlap===!1&&r.isEvent||y.overlap===!1||M&&!M(new Vn(e,u[T.defId],T),new Vn(e,w,_))))return!1}let S=i.eventStore;for(let k of y.allows){let T=Object.assign(Object.assign({},t),{range:_.range,allDay:w.allDay}),P=S.defs[w.defId],R=S.instances[f],O;if(P?O=new Vn(e,P,R):O=new Vn(e,w),!k(DR(T,e),O))return!1}}return!0}function wre(s,e,t,n){let i=s.eventStore,r=i.defs,o=i.instances,a=s.dateSelection,l=a.range,{selectionConfig:c}=e.getCurrentData();if(n&&(c=n(c)),!k8(c.constraints,l,i,s.businessHours,e))return!1;let{selectOverlap:d}=e.options,u=typeof d=="function"?d:null;for(let h in o){let p=o[h];if(Fx(l,p.range)&&(c.overlap===!1||u&&!u(new Vn(e,r[p.defId],p),null)))return!1}for(let h of c.allows){let p=Object.assign(Object.assign({},t),a);if(!h(DR(p,e),null))return!1}return!0}function k8(s,e,t,n,i){for(let r of s)if(!Tre(Mre(r,e,t,n,i),e))return!1;return!0}function Mre(s,e,t,n,i){return s==="businessHours"?H1(ch(n,e,i)):typeof s=="string"?H1($x(t,r=>r.groupId===s)):typeof s=="object"&&s?H1(ch(s,e,i)):[]}function H1(s){let{instances:e}=s,t=[];for(let n in e)t.push(e[n].range);return t}function Tre(s,e){for(let t of s)if(sm(t,e))return!0;return!1}var fx=/^(visible|hidden)$/,em=class extends sn{constructor(){super(...arguments),this.handleEl=e=>{this.el=e,Cr(this.props.elRef,e)}}render(){let{props:e}=this,{liquid:t,liquidIsAbsolute:n}=e,i=t&&n,r=["fc-scroller"];return t&&(n?r.push("fc-scroller-liquid-absolute"):r.push("fc-scroller-liquid")),ce("div",{ref:this.handleEl,className:r.join(" "),style:{overflowX:e.overflowX,overflowY:e.overflowY,left:i&&-(e.overcomeLeft||0)||"",right:i&&-(e.overcomeRight||0)||"",bottom:i&&-(e.overcomeBottom||0)||"",marginLeft:!i&&-(e.overcomeLeft||0)||"",marginRight:!i&&-(e.overcomeRight||0)||"",marginBottom:!i&&-(e.overcomeBottom||0)||"",maxHeight:e.maxHeight||""}},e.children)}needsXScrolling(){if(fx.test(this.props.overflowX))return!1;let{el:e}=this,t=this.el.getBoundingClientRect().width-this.getYScrollbarWidth(),{children:n}=e;for(let i=0;i<n.length;i+=1)if(n[i].getBoundingClientRect().width>t)return!0;return!1}needsYScrolling(){if(fx.test(this.props.overflowY))return!1;let{el:e}=this,t=this.el.getBoundingClientRect().height-this.getXScrollbarWidth(),{children:n}=e;for(let i=0;i<n.length;i+=1)if(n[i].getBoundingClientRect().height>t)return!0;return!1}getXScrollbarWidth(){return fx.test(this.props.overflowX)?0:this.el.offsetHeight-this.el.clientHeight}getYScrollbarWidth(){return fx.test(this.props.overflowY)?0:this.el.offsetWidth-this.el.clientWidth}},tr=class{constructor(e){this.masterCallback=e,this.currentMap={},this.depths={},this.callbackMap={},this.handleValue=(t,n)=>{let{depths:i,currentMap:r}=this,o=!1,a=!1;t!==null?(o=n in r,r[n]=t,i[n]=(i[n]||0)+1,a=!0):(i[n]-=1,i[n]||(delete r[n],delete this.callbackMap[n],o=!0)),this.masterCallback&&(o&&this.masterCallback(null,String(n)),a&&this.masterCallback(t,String(n)))}}createRef(e){let t=this.callbackMap[e];return t||(t=this.callbackMap[e]=n=>{this.handleValue(n,String(e))}),t}collect(e,t,n){return r8(this.currentMap,e,t,n)}getAll(){return Rx(this.currentMap)}};function I8(s){let e=K6(s,".fc-scrollgrid-shrink"),t=0;for(let n of e)t=Math.max(t,zse(n));return Math.ceil(t)}function jR(s,e){return s.liquid&&e.liquid}function D8(s,e){return e.maxHeight!=null||jR(s,e)}function R8(s,e,t,n){let{expandRows:i}=t;return typeof e.content=="function"?e.content(t):ce("table",{role:"presentation",className:[e.tableClassName,s.syncRowHeights?"fc-scrollgrid-sync-table":""].join(" "),style:{minWidth:t.tableMinWidth,width:t.clientWidth,height:i?t.clientHeight:""}},t.tableColGroupNode,ce(n?"thead":"tbody",{role:"presentation"},typeof e.rowContent=="function"?e.rowContent(t):e.rowContent))}function F8(s,e){return Sa(s,e,Zi)}function L8(s,e){let t=[];for(let n of s){let i=n.span||1;for(let r=0;r<i;r+=1)t.push(ce("col",{style:{width:n.width==="shrink"?N8(e):n.width||"",minWidth:n.minWidth||""}}))}return ce("colgroup",{},...t)}function N8(s){return s??4}function O8(s){for(let e of s)if(e.width==="shrink")return!0;return!1}function $8(s,e){let t=["fc-scrollgrid",e.theme.getClass("table")];return s&&t.push("fc-scrollgrid-liquid"),t}function B8(s,e){let t=["fc-scrollgrid-section",`fc-scrollgrid-section-${s.type}`,s.className];return e&&s.liquid&&s.maxHeight==null&&t.push("fc-scrollgrid-section-liquid"),s.isSticky&&t.push("fc-scrollgrid-section-sticky"),t}function lm(s){return ce("div",{className:"fc-scrollgrid-sticky-shim",style:{width:s.clientWidth,minWidth:s.tableMinWidth}})}function bh(s){let{stickyHeaderDates:e}=s;return(e==null||e==="auto")&&(e=s.height==="auto"||s.viewHeight==="auto"),e}function qv(s){let{stickyFooterScrollbar:e}=s;return(e==null||e==="auto")&&(e=s.height==="auto"||s.viewHeight==="auto"),e}var Hc=class extends sn{constructor(){super(...arguments),this.processCols=Dt(e=>e,F8),this.renderMicroColGroup=Dt(L8),this.scrollerRefs=new tr,this.scrollerElRefs=new tr(this._handleScrollerEl.bind(this)),this.state={shrinkWidth:null,forceYScrollbars:!1,scrollerClientWidths:{},scrollerClientHeights:{}},this.handleSizing=()=>{this.safeSetState(Object.assign({shrinkWidth:this.computeShrinkWidth()},this.computeScrollerDims()))}}render(){let{props:e,state:t,context:n}=this,i=e.sections||[],r=this.processCols(e.cols),o=this.renderMicroColGroup(r,t.shrinkWidth),a=$8(e.liquid,n);e.collapsibleWidth&&a.push("fc-scrollgrid-collapsible");let l=i.length,c=0,d,u=[],h=[],p=[];for(;c<l&&(d=i[c]).type==="header";)u.push(this.renderSection(d,o,!0)),c+=1;for(;c<l&&(d=i[c]).type==="body";)h.push(this.renderSection(d,o,!1)),c+=1;for(;c<l&&(d=i[c]).type==="footer";)p.push(this.renderSection(d,o,!0)),c+=1;let f=!$R(),_={role:"rowgroup"};return ce("table",{role:"grid",className:a.join(" "),style:{height:e.height}},!!(!f&&u.length)&&ce("thead",_,...u),!!(!f&&h.length)&&ce("tbody",_,...h),!!(!f&&p.length)&&ce("tfoot",_,...p),f&&ce("tbody",_,...u,...h,...p))}renderSection(e,t,n){return"outerContent"in e?ce(gn,{key:e.key},e.outerContent):ce("tr",{key:e.key,role:"presentation",className:B8(e,this.props.liquid).join(" ")},this.renderChunkTd(e,t,e.chunk,n))}renderChunkTd(e,t,n,i){if("outerContent"in n)return n.outerContent;let{props:r}=this,{forceYScrollbars:o,scrollerClientWidths:a,scrollerClientHeights:l}=this.state,c=D8(r,e),d=jR(r,e),u=r.liquid?o?"scroll":c?"auto":"hidden":"visible",h=e.key,p=R8(e,n,{tableColGroupNode:t,tableMinWidth:"",clientWidth:!r.collapsibleWidth&&a[h]!==void 0?a[h]:null,clientHeight:l[h]!==void 0?l[h]:null,expandRows:e.expandRows,syncRowHeights:!1,rowSyncHeights:[],reportRowHeightChange:()=>{}},i);return ce(i?"th":"td",{ref:n.elRef,role:"presentation"},ce("div",{className:`fc-scroller-harness${d?" fc-scroller-harness-liquid":""}`},ce(em,{ref:this.scrollerRefs.createRef(h),elRef:this.scrollerElRefs.createRef(h),overflowY:u,overflowX:r.liquid?"hidden":"visible",maxHeight:e.maxHeight,liquid:d,liquidIsAbsolute:!0},p)))}_handleScrollerEl(e,t){let n=Ere(this.props.sections,t);n&&Cr(n.chunk.scrollerElRef,e)}componentDidMount(){this.handleSizing(),this.context.addResizeHandler(this.handleSizing)}componentDidUpdate(){this.handleSizing()}componentWillUnmount(){this.context.removeResizeHandler(this.handleSizing)}computeShrinkWidth(){return O8(this.props.cols)?I8(this.scrollerElRefs.getAll()):0}computeScrollerDims(){let e=M8(),{scrollerRefs:t,scrollerElRefs:n}=this,i=!1,r={},o={};for(let a in t.currentMap){let l=t.currentMap[a];if(l&&l.needsYScrolling()){i=!0;break}}for(let a of this.props.sections){let l=a.key,c=n.currentMap[l];if(c){let d=c.parentNode;r[l]=Math.floor(d.getBoundingClientRect().width-(i?e.y:0)),o[l]=Math.floor(d.getBoundingClientRect().height)}}return{forceYScrollbars:i,scrollerClientWidths:r,scrollerClientHeights:o}}};Hc.addStateEquality({scrollerClientWidths:Zi,scrollerClientHeights:Zi});function Ere(s,e){for(let t of s)if(t.key===e)return t;return null}var Pl=class extends sn{constructor(){super(...arguments),this.buildPublicEvent=Dt((e,t,n)=>new Vn(e,t,n)),this.handleEl=e=>{this.el=e,Cr(this.props.elRef,e),e&&V6(e,this.props.seg)}}render(){let{props:e,context:t}=this,{options:n}=t,{seg:i}=e,{eventRange:r}=i,{ui:o}=r,a={event:this.buildPublicEvent(t,r.def,r.instance),view:t.viewApi,timeText:e.timeText,textColor:o.textColor,backgroundColor:o.backgroundColor,borderColor:o.borderColor,isDraggable:!e.disableDragging&&Zie(i,t),isStartResizable:!e.disableResizing&&ere(i,t),isEndResizable:!e.disableResizing&&tre(i),isMirror:!!(e.isDragging||e.isResizing||e.isDateSelecting),isStart:!!i.isStart,isEnd:!!i.isEnd,isPast:!!e.isPast,isFuture:!!e.isFuture,isToday:!!e.isToday,isSelected:!!e.isSelected,isDragging:!!e.isDragging,isResizing:!!e.isResizing};return ce(ms,{elRef:this.handleEl,elTag:e.elTag,elAttrs:e.elAttrs,elClasses:[...nre(a),...i.eventRange.ui.classNames,...e.elClasses||[]],elStyle:e.elStyle,renderProps:a,generatorName:"eventContent",customGenerator:n.eventContent,defaultGenerator:e.defaultGenerator,classNameGenerator:n.eventClassNames,didMount:n.eventDidMount,willUnmount:n.eventWillUnmount},e.children)}componentDidUpdate(e){this.el&&this.props.seg!==e.seg&&V6(this.el,this.props.seg)}},jc=class extends sn{render(){let{props:e,context:t}=this,{options:n}=t,{seg:i}=e,{ui:r}=i.eventRange,o=n.eventTimeFormat||e.defaultTimeFormat,a=Jc(i,o,t,e.defaultDisplayEventTime,e.defaultDisplayEventEnd);return ce(Pl,Object.assign({},e,{elTag:"a",elStyle:{borderColor:r.borderColor,backgroundColor:r.backgroundColor},elAttrs:rm(i,t),defaultGenerator:xre,timeText:a}),(l,c)=>ce(gn,null,ce(l,{elTag:"div",elClasses:["fc-event-main"],elStyle:{color:c.textColor}}),!!c.isStartResizable&&ce("div",{className:"fc-event-resizer fc-event-resizer-start"}),!!c.isEndResizable&&ce("div",{className:"fc-event-resizer fc-event-resizer-end"})))}};jc.addPropsEquality({seg:Zi});function xre(s){return ce("div",{className:"fc-event-main-frame"},s.timeText&&ce("div",{className:"fc-event-time"},s.timeText),ce("div",{className:"fc-event-title-container"},ce("div",{className:"fc-event-title fc-sticky"},s.event.title||ce(gn,null,"\xA0"))))}var Kv=s=>ce(Yr.Consumer,null,e=>{let{options:t}=e,n={isAxis:s.isAxis,date:e.dateEnv.toDate(s.date),view:e.viewApi};return ce(ms,{elRef:s.elRef,elTag:s.elTag||"div",elAttrs:s.elAttrs,elClasses:s.elClasses,elStyle:s.elStyle,renderProps:n,generatorName:"nowIndicatorContent",customGenerator:t.nowIndicatorContent,classNameGenerator:t.nowIndicatorClassNames,didMount:t.nowIndicatorDidMount,willUnmount:t.nowIndicatorWillUnmount},s.children)}),Sre=Pn({day:"numeric"}),qc=class extends sn{constructor(){super(...arguments),this.refineRenderProps=nm(Cre)}render(){let{props:e,context:t}=this,{options:n}=t,i=this.refineRenderProps({date:e.date,dateProfile:e.dateProfile,todayRange:e.todayRange,isMonthStart:e.isMonthStart||!1,showDayNumber:e.showDayNumber,extraRenderProps:e.extraRenderProps,viewApi:t.viewApi,dateEnv:t.dateEnv,monthStartFormat:n.monthStartFormat});return ce(ms,{elRef:e.elRef,elTag:e.elTag,elAttrs:Object.assign(Object.assign({},e.elAttrs),i.isDisabled?{}:{"data-date":Yc(e.date)}),elClasses:[...am(i,t.theme),...e.elClasses||[]],elStyle:e.elStyle,renderProps:i,generatorName:"dayCellContent",customGenerator:n.dayCellContent,defaultGenerator:e.defaultGenerator,classNameGenerator:i.isDisabled?void 0:n.dayCellClassNames,didMount:n.dayCellDidMount,willUnmount:n.dayCellWillUnmount},e.children)}};function cm(s){return!!(s.dayCellContent||Z1("dayCellContent",s))}function Cre(s){let{date:e,dateEnv:t,dateProfile:n,isMonthStart:i}=s,r=Gv(e,s.todayRange,null,n),o=s.showDayNumber?t.format(e,i?s.monthStartFormat:Sre):"";return Object.assign(Object.assign(Object.assign({date:t.toDate(e),view:s.viewApi},r),{isMonthStart:i,dayNumberText:o}),s.extraRenderProps)}var gh=class extends sn{render(){let{props:e}=this,{seg:t}=e;return ce(Pl,{elTag:"div",elClasses:["fc-bg-event"],elStyle:{backgroundColor:t.eventRange.ui.backgroundColor},defaultGenerator:Are,seg:t,timeText:"",isDragging:!1,isResizing:!1,isDateSelecting:!1,isSelected:!1,isPast:e.isPast,isFuture:e.isFuture,isToday:e.isToday,disableDragging:!0,disableResizing:!0})}};function Are(s){let{title:e}=s.event;return e&&ce("div",{className:"fc-event-title"},s.event.title)}function Yv(s){return ce("div",{className:`fc-${s}`})}var Xv=s=>ce(Yr.Consumer,null,e=>{let{dateEnv:t,options:n}=e,{date:i}=s,r=n.weekNumberFormat||s.defaultFormat,o=t.computeWeekNumber(i),a=t.format(i,r),l={num:o,text:a,date:i};return ce(ms,{elRef:s.elRef,elTag:s.elTag,elAttrs:s.elAttrs,elClasses:s.elClasses,elStyle:s.elStyle,renderProps:l,generatorName:"weekNumberContent",customGenerator:n.weekNumberContent,defaultGenerator:Pre,classNameGenerator:n.weekNumberClassNames,didMount:n.weekNumberDidMount,willUnmount:n.weekNumberWillUnmount},s.children)});function Pre(s){return s.text}var j1=10,tR=class extends sn{constructor(){super(...arguments),this.state={titleId:Kr()},this.handleRootEl=e=>{this.rootEl=e,this.props.elRef&&Cr(this.props.elRef,e)},this.handleDocumentMouseDown=e=>{let t=Cx(e);this.rootEl.contains(t)||this.handleCloseClick()},this.handleDocumentKeyDown=e=>{e.key==="Escape"&&this.handleCloseClick()},this.handleCloseClick=()=>{let{onClose:e}=this.props;e&&e()}}render(){let{theme:e,options:t}=this.context,{props:n,state:i}=this,r=["fc-popover",e.getClass("popover")].concat(n.extraClassNames||[]);return k6(ce("div",Object.assign({},n.extraAttrs,{id:n.id,className:r.join(" "),"aria-labelledby":i.titleId,ref:this.handleRootEl}),ce("div",{className:"fc-popover-header "+e.getClass("popoverHeader")},ce("span",{className:"fc-popover-title",id:i.titleId},n.title),ce("span",{className:"fc-popover-close "+e.getIconClass("close"),title:t.closeHint,onClick:this.handleCloseClick})),ce("div",{className:"fc-popover-body "+e.getClass("popoverContent")},n.children)),n.parentEl)}componentDidMount(){document.addEventListener("mousedown",this.handleDocumentMouseDown),document.addEventListener("keydown",this.handleDocumentKeyDown),this.updateSize()}componentWillUnmount(){document.removeEventListener("mousedown",this.handleDocumentMouseDown),document.removeEventListener("keydown",this.handleDocumentKeyDown)}updateSize(){let{isRtl:e}=this.context,{alignmentEl:t,alignGridTop:n}=this.props,{rootEl:i}=this,r=gre(t);if(r){let o=i.getBoundingClientRect(),a=n?Gs(t,".fc-scrollgrid").getBoundingClientRect().top:r.top,l=e?r.right-o.width:r.left;a=Math.max(a,j1),l=Math.min(l,document.documentElement.clientWidth-j1-o.width),l=Math.max(l,j1);let c=i.offsetParent.getBoundingClientRect();yh(i,{top:a-c.top,left:l-c.left})}}},nR=class extends fi{constructor(){super(...arguments),this.handleRootEl=e=>{this.rootEl=e,e?this.context.registerInteractiveComponent(this,{el:e,useEventCenter:!1}):this.context.unregisterInteractiveComponent(this)}}render(){let{options:e,dateEnv:t}=this.context,{props:n}=this,{startDate:i,todayRange:r,dateProfile:o}=n,a=t.format(i,e.dayPopoverFormat);return ce(qc,{elRef:this.handleRootEl,date:i,dateProfile:o,todayRange:r},(l,c,d)=>ce(tR,{elRef:d.ref,id:n.id,title:a,extraClassNames:["fc-more-popover"].concat(d.className||[]),extraAttrs:d,parentEl:n.parentEl,alignmentEl:n.alignmentEl,alignGridTop:n.alignGridTop,onClose:n.onClose},cm(e)&&ce(l,{elTag:"div",elClasses:["fc-more-popover-misc"]}),n.children))}queryHit(e,t,n,i){let{rootEl:r,props:o}=this;return e>=0&&e<n&&t>=0&&t<i?{dateProfile:o.dateProfile,dateSpan:Object.assign({allDay:!o.forceTimed,range:{start:o.startDate,end:o.endDate}},o.extraDateSpan),dayEl:r,rect:{left:0,top:0,right:n,bottom:i},layer:1}:null}},_h=class extends sn{constructor(){super(...arguments),this.state={isPopoverOpen:!1,popoverId:Kr()},this.handleLinkEl=e=>{this.linkEl=e,this.props.elRef&&Cr(this.props.elRef,e)},this.handleClick=e=>{let{props:t,context:n}=this,{moreLinkClick:i}=n.options,r=G6(t).start;function o(a){let{def:l,instance:c,range:d}=a.eventRange;return{event:new Vn(n,l,c),start:n.dateEnv.toDate(d.start),end:n.dateEnv.toDate(d.end),isStart:a.isStart,isEnd:a.isEnd}}typeof i=="function"&&(i=i({date:r,allDay:!!t.allDayDate,allSegs:t.allSegs.map(o),hiddenSegs:t.hiddenSegs.map(o),jsEvent:e,view:n.viewApi})),!i||i==="popover"?this.setState({isPopoverOpen:!0}):typeof i=="string"&&n.calendarApi.zoomTo(r,i)},this.handlePopoverClose=()=>{this.setState({isPopoverOpen:!1})}}render(){let{props:e,state:t}=this;return ce(Yr.Consumer,null,n=>{let{viewApi:i,options:r,calendarApi:o}=n,{moreLinkText:a}=r,{moreCnt:l}=e,c=G6(e),d=typeof a=="function"?a.call(o,l):`+${l} ${a}`,u=tm(r.moreLinkHint,[l],d),h={num:l,shortText:`+${l}`,text:d,view:i};return ce(gn,null,!!e.moreCnt&&ce(ms,{elTag:e.elTag||"a",elRef:this.handleLinkEl,elClasses:[...e.elClasses||[],"fc-more-link"],elStyle:e.elStyle,elAttrs:Object.assign(Object.assign(Object.assign({},e.elAttrs),X6(this.handleClick)),{title:u,"aria-expanded":t.isPopoverOpen,"aria-controls":t.isPopoverOpen?t.popoverId:""}),renderProps:h,generatorName:"moreLinkContent",customGenerator:r.moreLinkContent,defaultGenerator:e.defaultGenerator||kre,classNameGenerator:r.moreLinkClassNames,didMount:r.moreLinkDidMount,willUnmount:r.moreLinkWillUnmount},e.children),t.isPopoverOpen&&ce(nR,{id:t.popoverId,startDate:c.start,endDate:c.end,dateProfile:e.dateProfile,todayRange:e.todayRange,extraDateSpan:e.extraDateSpan,parentEl:this.parentEl,alignmentEl:e.alignmentElRef?e.alignmentElRef.current:this.linkEl,alignGridTop:e.alignGridTop,forceTimed:e.forceTimed,onClose:this.handlePopoverClose},e.popoverContent()))})}componentDidMount(){this.updateParentEl()}componentDidUpdate(){this.updateParentEl()}updateParentEl(){this.linkEl&&(this.parentEl=Gs(this.linkEl,".fc-view-harness"))}};function kre(s){return s.text}function G6(s){if(s.allDayDate)return{start:s.allDayDate,end:ts(s.allDayDate,1)};let{hiddenSegs:e}=s;return{start:Gx(e),end:Dre(e)}}function Gx(s){return s.reduce(Ire).eventRange.range.start}function Ire(s,e){return s.eventRange.range.start<e.eventRange.range.start?s:e}function Dre(s){return s.reduce(Rre).eventRange.range.end}function Rre(s,e){return s.eventRange.range.end>e.eventRange.range.end?s:e}var Fre=[],j8={code:"en",week:{dow:0,doy:4},direction:"ltr",buttonText:{prev:"prev",next:"next",prevYear:"prev year",nextYear:"next year",year:"year",today:"today",month:"month",week:"week",day:"day",list:"list"},weekText:"W",weekTextLong:"Week",closeHint:"Close",timeHint:"Time",eventHint:"Event",allDayText:"all-day",moreLinkText:"more",noEventsText:"No events to display"},q8=Object.assign(Object.assign({},j8),{buttonHints:{prev:"Previous $0",next:"Next $0",today(s,e){return e==="day"?"Today":`This ${s}`}},viewHint:"$0 view",navLinkHint:"Go to $0",moreLinkHint(s){return`Show ${s} more event${s===1?"":"s"}`}});function Lre(s){let e=s.length>0?s[0].code:"en",t=Fre.concat(s),n={en:q8};for(let i of t)n[i.code]=i;return{map:n,defaultCode:e}}function K8(s,e){return typeof s=="object"&&!Array.isArray(s)?Y8(s.code,[s.code],s):Nre(s,e)}function Nre(s,e){let t=[].concat(s||[]),n=Ore(t,e)||q8;return Y8(s,t,n)}function Ore(s,e){for(let t=0;t<s.length;t+=1){let n=s[t].toLocaleLowerCase().split("-");for(let i=n.length;i>0;i-=1){let r=n.slice(0,i).join("-");if(e[r])return e[r]}}return null}function Y8(s,e,t){let n=Dx([j8,t],["buttonText"]);delete n.code;let{week:i}=n;return delete n.week,{codeArg:s,codes:e,week:i,simpleNumberFormat:new Intl.NumberFormat(s),options:n}}function nr(s){return{id:kl(),name:s.name,premiumReleaseDate:s.premiumReleaseDate?new Date(s.premiumReleaseDate):void 0,deps:s.deps||[],reducers:s.reducers||[],isLoadingFuncs:s.isLoadingFuncs||[],contextInit:[].concat(s.contextInit||[]),eventRefiners:s.eventRefiners||{},eventDefMemberAdders:s.eventDefMemberAdders||[],eventSourceRefiners:s.eventSourceRefiners||{},isDraggableTransformers:s.isDraggableTransformers||[],eventDragMutationMassagers:s.eventDragMutationMassagers||[],eventDefMutationAppliers:s.eventDefMutationAppliers||[],dateSelectionTransformers:s.dateSelectionTransformers||[],datePointTransforms:s.datePointTransforms||[],dateSpanTransforms:s.dateSpanTransforms||[],views:s.views||{},viewPropsTransformers:s.viewPropsTransformers||[],isPropsValid:s.isPropsValid||null,externalDefTransforms:s.externalDefTransforms||[],viewContainerAppends:s.viewContainerAppends||[],eventDropTransformers:s.eventDropTransformers||[],componentInteractions:s.componentInteractions||[],calendarInteractions:s.calendarInteractions||[],themeClasses:s.themeClasses||{},eventSourceDefs:s.eventSourceDefs||[],cmdFormatter:s.cmdFormatter,recurringTypes:s.recurringTypes||[],namedTimeZonedImpl:s.namedTimeZonedImpl,initialView:s.initialView||"",elementDraggingImpl:s.elementDraggingImpl,optionChangeHandlers:s.optionChangeHandlers||{},scrollGridImpl:s.scrollGridImpl||null,listenerRefiners:s.listenerRefiners||{},optionRefiners:s.optionRefiners||{},propSetHandlers:s.propSetHandlers||{}}}function $re(s,e){let t={},n={premiumReleaseDate:void 0,reducers:[],isLoadingFuncs:[],contextInit:[],eventRefiners:{},eventDefMemberAdders:[],eventSourceRefiners:{},isDraggableTransformers:[],eventDragMutationMassagers:[],eventDefMutationAppliers:[],dateSelectionTransformers:[],datePointTransforms:[],dateSpanTransforms:[],views:{},viewPropsTransformers:[],isPropsValid:null,externalDefTransforms:[],viewContainerAppends:[],eventDropTransformers:[],componentInteractions:[],calendarInteractions:[],themeClasses:{},eventSourceDefs:[],cmdFormatter:null,recurringTypes:[],namedTimeZonedImpl:null,initialView:"",elementDraggingImpl:null,optionChangeHandlers:{},scrollGridImpl:null,listenerRefiners:{},optionRefiners:{},propSetHandlers:{}};function i(r){for(let o of r){let a=o.name,l=t[a];l===void 0?(t[a]=o.id,i(o.deps),n=zre(n,o)):l!==o.id&&console.warn(`Duplicate plugin '${a}'`)}}return s&&i(s),i(e),n}function Bre(){let s=[],e=[],t;return(n,i)=>((!t||!Sa(n,s)||!Sa(i,e))&&(t=$re(n,i)),s=n,e=i,t)}function zre(s,e){return{premiumReleaseDate:Ure(s.premiumReleaseDate,e.premiumReleaseDate),reducers:s.reducers.concat(e.reducers),isLoadingFuncs:s.isLoadingFuncs.concat(e.isLoadingFuncs),contextInit:s.contextInit.concat(e.contextInit),eventRefiners:Object.assign(Object.assign({},s.eventRefiners),e.eventRefiners),eventDefMemberAdders:s.eventDefMemberAdders.concat(e.eventDefMemberAdders),eventSourceRefiners:Object.assign(Object.assign({},s.eventSourceRefiners),e.eventSourceRefiners),isDraggableTransformers:s.isDraggableTransformers.concat(e.isDraggableTransformers),eventDragMutationMassagers:s.eventDragMutationMassagers.concat(e.eventDragMutationMassagers),eventDefMutationAppliers:s.eventDefMutationAppliers.concat(e.eventDefMutationAppliers),dateSelectionTransformers:s.dateSelectionTransformers.concat(e.dateSelectionTransformers),datePointTransforms:s.datePointTransforms.concat(e.datePointTransforms),dateSpanTransforms:s.dateSpanTransforms.concat(e.dateSpanTransforms),views:Object.assign(Object.assign({},s.views),e.views),viewPropsTransformers:s.viewPropsTransformers.concat(e.viewPropsTransformers),isPropsValid:e.isPropsValid||s.isPropsValid,externalDefTransforms:s.externalDefTransforms.concat(e.externalDefTransforms),viewContainerAppends:s.viewContainerAppends.concat(e.viewContainerAppends),eventDropTransformers:s.eventDropTransformers.concat(e.eventDropTransformers),calendarInteractions:s.calendarInteractions.concat(e.calendarInteractions),componentInteractions:s.componentInteractions.concat(e.componentInteractions),themeClasses:Object.assign(Object.assign({},s.themeClasses),e.themeClasses),eventSourceDefs:s.eventSourceDefs.concat(e.eventSourceDefs),cmdFormatter:e.cmdFormatter||s.cmdFormatter,recurringTypes:s.recurringTypes.concat(e.recurringTypes),namedTimeZonedImpl:e.namedTimeZonedImpl||s.namedTimeZonedImpl,initialView:s.initialView||e.initialView,elementDraggingImpl:s.elementDraggingImpl||e.elementDraggingImpl,optionChangeHandlers:Object.assign(Object.assign({},s.optionChangeHandlers),e.optionChangeHandlers),scrollGridImpl:e.scrollGridImpl||s.scrollGridImpl,listenerRefiners:Object.assign(Object.assign({},s.listenerRefiners),e.listenerRefiners),optionRefiners:Object.assign(Object.assign({},s.optionRefiners),e.optionRefiners),propSetHandlers:Object.assign(Object.assign({},s.propSetHandlers),e.propSetHandlers)}}function Ure(s,e){return s===void 0?e:e===void 0?s:new Date(Math.max(s.valueOf(),e.valueOf()))}var ka=class extends Cl{};ka.prototype.classes={root:"fc-theme-standard",tableCellShaded:"fc-cell-shaded",buttonGroup:"fc-button-group",button:"fc-button fc-button-primary",buttonActive:"fc-button-active"};ka.prototype.baseIconClass="fc-icon";ka.prototype.iconClasses={close:"fc-icon-x",prev:"fc-icon-chevron-left",next:"fc-icon-chevron-right",prevYear:"fc-icon-chevrons-left",nextYear:"fc-icon-chevrons-right"};ka.prototype.rtlIconClasses={prev:"fc-icon-chevron-right",next:"fc-icon-chevron-left",prevYear:"fc-icon-chevrons-right",nextYear:"fc-icon-chevrons-left"};ka.prototype.iconOverrideOption="buttonIcons";ka.prototype.iconOverrideCustomButtonOption="icon";ka.prototype.iconOverridePrefix="fc-icon-";function Vre(s,e){let t={},n;for(n in s)KR(n,t,s,e);for(n in e)KR(n,t,s,e);return t}function KR(s,e,t,n){if(e[s])return e[s];let i=Gre(s,e,t,n);return i&&(e[s]=i),i}function Gre(s,e,t,n){let i=t[s],r=n[s],o=d=>i&&i[d]!==null?i[d]:r&&r[d]!==null?r[d]:null,a=o("component"),l=o("superType"),c=null;if(l){if(l===s)throw new Error("Can't have a custom view type that references itself");c=KR(l,e,t,n)}return!a&&c&&(a=c.component),a?{type:s,component:a,defaults:Object.assign(Object.assign({},c?c.defaults:{}),i?i.rawOptions:{}),overrides:Object.assign(Object.assign({},c?c.overrides:{}),r?r.rawOptions:{})}:null}function z8(s){return qr(s,Wre)}function Wre(s){let e=typeof s=="function"?{component:s}:s,{component:t}=e;return e.content?t=U8(e):t&&!(t.prototype instanceof sn)&&(t=U8(Object.assign(Object.assign({},e),{content:t}))),{superType:e.type,component:t,rawOptions:e}}function U8(s){return e=>ce(Yr.Consumer,null,t=>ce(ms,{elTag:"div",elClasses:ER(t.viewSpec),renderProps:Object.assign(Object.assign({},e),{nextDayThreshold:t.options.nextDayThreshold}),generatorName:void 0,customGenerator:s.content,classNameGenerator:s.classNames,didMount:s.didMount,willUnmount:s.willUnmount}))}function Hre(s,e,t,n){let i=z8(s),r=z8(e.views),o=Vre(i,r);return qr(o,a=>jre(a,r,e,t,n))}function jre(s,e,t,n,i){let r=s.overrides.duration||s.defaults.duration||n.duration||t.duration,o=null,a="",l="",c={};if(r&&(o=qre(r),o)){let h=_v(o);a=h.unit,h.value===1&&(l=a,c=e[a]?e[a].rawOptions:{})}let d=h=>{let p=h.buttonText||{},f=s.defaults.buttonTextKey;return f!=null&&p[f]!=null?p[f]:p[s.type]!=null?p[s.type]:p[l]!=null?p[l]:null},u=h=>{let p=h.buttonHints||{},f=s.defaults.buttonTextKey;return f!=null&&p[f]!=null?p[f]:p[s.type]!=null?p[s.type]:p[l]!=null?p[l]:null};return{type:s.type,component:s.component,duration:o,durationUnit:a,singleUnit:l,optionDefaults:s.defaults,optionOverrides:Object.assign(Object.assign({},c),s.overrides),buttonTextOverride:d(n)||d(t)||s.overrides.buttonText,buttonTextDefault:d(i)||s.defaults.buttonText||d(Xc)||s.type,buttonTitleOverride:u(n)||u(t)||s.overrides.buttonHint,buttonTitleDefault:u(i)||s.defaults.buttonHint||u(Xc)}}var V8={};function qre(s){let e=JSON.stringify(s),t=V8[e];return t===void 0&&(t=nn(s),V8[e]=t),t}function Kre(s,e){switch(e.type){case"CHANGE_VIEW_TYPE":s=e.viewType}return s}function Yre(s,e){switch(e.type){case"CHANGE_DATE":return e.dateMarker;default:return s}}function Xre(s,e,t){let n=s.initialDate;return n!=null?e.createMarker(n):t.getDateMarker()}function Qre(s,e){switch(e.type){case"SET_OPTION":return Object.assign(Object.assign({},s),{[e.optionName]:e.rawOptionValue});default:return s}}function Jre(s,e,t,n){let i;switch(e.type){case"CHANGE_VIEW_TYPE":return n.build(e.dateMarker||t);case"CHANGE_DATE":return n.build(e.dateMarker);case"PREV":if(i=n.buildPrev(s,t),i.isValid)return i;break;case"NEXT":if(i=n.buildNext(s,t),i.isValid)return i;break}return s}function Zre(s,e,t){let n=e?e.activeRange:null;return Q8({},ooe(s,t),n,t)}function eoe(s,e,t,n){let i=t?t.activeRange:null;switch(e.type){case"ADD_EVENT_SOURCES":return Q8(s,e.sources,i,n);case"REMOVE_EVENT_SOURCE":return noe(s,e.sourceId);case"PREV":case"NEXT":case"CHANGE_DATE":case"CHANGE_VIEW_TYPE":return t?J8(s,i,n):s;case"FETCH_EVENT_SOURCES":return sF(s,e.sourceIds?wR(e.sourceIds):Z8(s,n),i,e.isRefetch||!1,n);case"RECEIVE_EVENTS":case"RECEIVE_EVENT_ERROR":return roe(s,e.sourceId,e.fetchId,e.fetchRange);case"REMOVE_ALL_EVENT_SOURCES":return{};default:return s}}function toe(s,e,t){let n=e?e.activeRange:null;return sF(s,Z8(s,t),n,!0,t)}function X8(s){for(let e in s)if(s[e].isFetching)return!0;return!1}function Q8(s,e,t,n){let i={};for(let r of e)i[r.sourceId]=r;return t&&(i=J8(i,t,n)),Object.assign(Object.assign({},s),i)}function noe(s,e){return Sl(s,t=>t.sourceId!==e)}function J8(s,e,t){return sF(s,Sl(s,n=>soe(n,e,t)),e,!1,t)}function soe(s,e,t){return eY(s,t)?!t.options.lazyFetching||!s.fetchRange||s.isFetching||e.start<s.fetchRange.start||e.end>s.fetchRange.end:!s.latestFetchId}function sF(s,e,t,n,i){let r={};for(let o in s){let a=s[o];e[o]?r[o]=ioe(a,t,n,i):r[o]=a}return r}function ioe(s,e,t,n){let{options:i,calendarApi:r}=n,o=n.pluginHooks.eventSourceDefs[s.sourceDefId],a=kl();return o.fetch({eventSource:s,range:e,isRefetch:t,context:n},l=>{let{rawEvents:c}=l;i.eventSourceSuccess&&(c=i.eventSourceSuccess.call(r,c,l.response)||c),s.success&&(c=s.success.call(r,c,l.response)||c),n.dispatch({type:"RECEIVE_EVENTS",sourceId:s.sourceId,fetchId:a,fetchRange:e,rawEvents:c})},l=>{let c=!1;i.eventSourceFailure&&(i.eventSourceFailure.call(r,l),c=!0),s.failure&&(s.failure(l),c=!0),c||console.warn(l.message,l),n.dispatch({type:"RECEIVE_EVENT_ERROR",sourceId:s.sourceId,fetchId:a,fetchRange:e,error:l})}),Object.assign(Object.assign({},s),{isFetching:!0,latestFetchId:a})}function roe(s,e,t,n){let i=s[e];return i&&t===i.latestFetchId?Object.assign(Object.assign({},s),{[e]:Object.assign(Object.assign({},i),{isFetching:!1,fetchRange:n})}):s}function Z8(s,e){return Sl(s,t=>eY(t,e))}function ooe(s,e){let t=PR(e),n=[].concat(s.eventSources||[]),i=[];s.initialEvents&&n.unshift(s.initialEvents),s.events&&n.unshift(s.events);for(let r of n){let o=AR(r,e,t);o&&i.push(o)}return i}function eY(s,e){return!e.pluginHooks.eventSourceDefs[s.sourceDefId].ignoreRange}function aoe(s,e){switch(e.type){case"UNSELECT_DATES":return null;case"SELECT_DATES":return e.selection;default:return s}}function loe(s,e){switch(e.type){case"UNSELECT_EVENT":return"";case"SELECT_EVENT":return e.eventInstanceId;default:return s}}function coe(s,e){let t;switch(e.type){case"UNSET_EVENT_DRAG":return null;case"SET_EVENT_DRAG":return t=e.state,{affectedEvents:t.affectedEvents,mutatedEvents:t.mutatedEvents,isEvent:t.isEvent};default:return s}}function doe(s,e){let t;switch(e.type){case"UNSET_EVENT_RESIZE":return null;case"SET_EVENT_RESIZE":return t=e.state,{affectedEvents:t.affectedEvents,mutatedEvents:t.mutatedEvents,isEvent:t.isEvent};default:return s}}function uoe(s,e,t,n,i){let r=s.headerToolbar?G8(s.headerToolbar,s,e,t,n,i):null,o=s.footerToolbar?G8(s.footerToolbar,s,e,t,n,i):null;return{header:r,footer:o}}function G8(s,e,t,n,i,r){let o={},a=[],l=!1;for(let c in s){let d=s[c],u=hoe(d,e,t,n,i,r);o[c]=u.widgets,a.push(...u.viewsWithButtons),l=l||u.hasTitle}return{sectionWidgets:o,viewsWithButtons:a,hasTitle:l}}function hoe(s,e,t,n,i,r){let o=e.direction==="rtl",a=e.customButtons||{},l=t.buttonText||{},c=e.buttonText||{},d=t.buttonHints||{},u=e.buttonHints||{},h=s?s.split(" "):[],p=[],f=!1;return{widgets:h.map(b=>b.split(",").map(y=>{if(y==="title")return f=!0,{buttonName:y};let w,C,M,S,k,T;if(w=a[y])M=P=>{w.click&&w.click.call(P.target,P,P.target)},(S=n.getCustomButtonIconClass(w))||(S=n.getIconClass(y,o))||(k=w.text),T=w.hint||w.text;else if(C=i[y]){p.push(y),M=()=>{r.changeView(y)},(k=C.buttonTextOverride)||(S=n.getIconClass(y,o))||(k=C.buttonTextDefault);let P=C.buttonTextOverride||C.buttonTextDefault;T=tm(C.buttonTitleOverride||C.buttonTitleDefault||e.viewHint,[P,y],P)}else if(r[y])if(M=()=>{r[y]()},(k=l[y])||(S=n.getIconClass(y,o))||(k=c[y]),y==="prevYear"||y==="nextYear"){let P=y==="prevYear"?"prev":"next";T=tm(d[P]||u[P],[c.year||"year","year"],c[y])}else T=P=>tm(d[y]||u[y],[c[P]||P,P],c[y]);return{buttonName:y,buttonClick:M,buttonIcon:S,buttonText:k,buttonHint:T}})),viewsWithButtons:p,hasTitle:f}}var YR=class{constructor(e,t,n){this.type=e,this.getCurrentData=t,this.dateEnv=n}get calendar(){return this.getCurrentData().calendarApi}get title(){return this.getCurrentData().viewTitle}get activeStart(){return this.dateEnv.toDate(this.getCurrentData().dateProfile.activeRange.start)}get activeEnd(){return this.dateEnv.toDate(this.getCurrentData().dateProfile.activeRange.end)}get currentStart(){return this.dateEnv.toDate(this.getCurrentData().dateProfile.currentRange.start)}get currentEnd(){return this.dateEnv.toDate(this.getCurrentData().dateProfile.currentRange.end)}getOption(e){return this.getCurrentData().options[e]}},poe={ignoreRange:!0,parseMeta(s){return Array.isArray(s.events)?s.events:null},fetch(s,e){e({rawEvents:s.eventSource.meta})}},foe=nr({name:"array-event-source",eventSourceDefs:[poe]}),moe={parseMeta(s){return typeof s.events=="function"?s.events:null},fetch(s,e,t){let{dateEnv:n}=s.context,i=s.eventSource.meta;NR(i.bind(null,LR(s.range,n)),r=>e({rawEvents:r}),t)}},goe=nr({name:"func-event-source",eventSourceDefs:[moe]}),_oe={method:String,extraParams:Ae,startParam:String,endParam:String,timeZoneParam:String},yoe={parseMeta(s){return s.url&&(s.format==="json"||!s.format)?{url:s.url,format:"json",method:(s.method||"GET").toUpperCase(),extraParams:s.extraParams,startParam:s.startParam,endParam:s.endParam,timeZoneParam:s.timeZoneParam}:null},fetch(s,e,t){let{meta:n}=s.eventSource,i=boe(n,s.range,s.context);OR(n.method,n.url,i).then(([r,o])=>{e({rawEvents:r,response:o})},t)}},voe=nr({name:"json-event-source",eventSourceRefiners:_oe,eventSourceDefs:[yoe]});function boe(s,e,t){let{dateEnv:n,options:i}=t,r,o,a,l,c={};return r=s.startParam,r==null&&(r=i.startParam),o=s.endParam,o==null&&(o=i.endParam),a=s.timeZoneParam,a==null&&(a=i.timeZoneParam),typeof s.extraParams=="function"?l=s.extraParams():l=s.extraParams||{},Object.assign(c,l),c[r]=n.formatIso(e.start),c[o]=n.formatIso(e.end),n.timeZone!=="local"&&(c[a]=n.timeZone),c}var woe={daysOfWeek:Ae,startTime:nn,endTime:nn,duration:nn,startRecur:Ae,endRecur:Ae},Moe={parse(s,e){if(s.daysOfWeek||s.startTime||s.endTime||s.startRecur||s.endRecur){let t={daysOfWeek:s.daysOfWeek||null,startTime:s.startTime||null,endTime:s.endTime||null,startRecur:s.startRecur?e.createMarker(s.startRecur):null,endRecur:s.endRecur?e.createMarker(s.endRecur):null,dateEnv:e},n;return s.duration&&(n=s.duration),!n&&s.startTime&&s.endTime&&(n=t8(s.endTime,s.startTime)),{allDayGuess:!s.startTime&&!s.endTime,duration:n,typeData:t}}return null},expand(s,e,t){let n=Sr(e,{start:s.startRecur,end:s.endRecur});return n?Eoe(s.daysOfWeek,s.startTime,s.dateEnv,t,n):[]}},Toe=nr({name:"simple-recurring-event",recurringTypes:[Moe],eventRefiners:woe});function Eoe(s,e,t,n,i){let r=s?wR(s):null,o=Sn(i.start),a=i.end,l=[];for(e&&(e.milliseconds<0?a=ts(a,1):e.milliseconds>=1e3*60*60*24&&(o=ts(o,-1)));o<a;){let c;(!r||r[o.getUTCDay()])&&(e?c=n.add(o,e):c=o,l.push(n.createMarker(t.toDate(c)))),o=ts(o,1)}return l}var xoe=nr({name:"change-handler",optionChangeHandlers:{events(s,e){W8([s],e)},eventSources:W8}});function W8(s,e){let t=Rx(e.getCurrentData().eventSources);if(t.length===1&&s.length===1&&Array.isArray(t[0]._raw)&&Array.isArray(s[0])){e.dispatch({type:"RESET_RAW_EVENTS",sourceId:t[0].sourceId,rawEvents:s[0]});return}let n=[];for(let i of s){let r=!1;for(let o=0;o<t.length;o+=1)if(t[o]._raw===i){t.splice(o,1),r=!0;break}r||n.push(i)}for(let i of t)e.dispatch({type:"REMOVE_EVENT_SOURCE",sourceId:i.sourceId});for(let i of n)e.calendarApi.addEventSource(i)}function Soe(s,e){e.emitter.trigger("datesSet",Object.assign(Object.assign({},LR(s.activeRange,e.dateEnv)),{view:e.viewApi}))}function Coe(s,e){let{emitter:t}=e;t.hasHandlers("eventsSet")&&t.trigger("eventsSet",Aa(s,e))}var Aoe=[foe,goe,voe,Toe,xoe,nr({name:"misc",isLoadingFuncs:[s=>X8(s.eventSources)],propSetHandlers:{dateProfile:Soe,eventStore:Coe}})],XR=class{constructor(e,t){this.runTaskOption=e,this.drainedOption=t,this.queue=[],this.delayedRunner=new ah(this.drain.bind(this))}request(e,t){this.queue.push(e),this.delayedRunner.request(t)}pause(e){this.delayedRunner.pause(e)}resume(e,t){this.delayedRunner.resume(e,t)}drain(){let{queue:e}=this;for(;e.length;){let t=[],n;for(;n=e.shift();)this.runTask(n),t.push(n);this.drained(t)}}runTask(e){this.runTaskOption&&this.runTaskOption(e)}drained(e){this.drainedOption&&this.drainedOption(e)}};function Poe(s,e,t){let n;return/^(year|month)$/.test(s.currentRangeUnit)?n=s.currentRange:n=s.activeRange,t.formatRange(n.start,n.end,Pn(e.titleFormat||koe(s)),{isEndExclusive:s.isRangeAllDay,defaultSeparator:e.titleRangeSeparator})}function koe(s){let{currentRangeUnit:e}=s;if(e==="year")return{year:"numeric"};if(e==="month")return{year:"numeric",month:"long"};let t=Jf(s.currentRange.start,s.currentRange.end);return t!==null&&t>1?{year:"numeric",month:"short",day:"numeric"}:{year:"numeric",month:"long",day:"numeric"}}var Wx=class{constructor(){this.resetListeners=new Set}handleInput(e,t){let n=this.dateEnv;if(e!==n&&(typeof t=="function"?this.nowFn=t:n||(this.nowAnchorDate=e.toDate(t?e.createMarker(t):e.createNowMarker()),this.nowAnchorQueried=Date.now()),this.dateEnv=e,n))for(let i of this.resetListeners.values())i()}getDateMarker(){return this.nowAnchorDate?this.dateEnv.timestampToMarker(this.nowAnchorDate.valueOf()+(Date.now()-this.nowAnchorQueried)):this.dateEnv.createMarker(this.nowFn())}addResetListener(e){this.resetListeners.add(e)}removeResetListener(e){this.resetListeners.delete(e)}},QR=class{constructor(e){this.computeCurrentViewData=Dt(this._computeCurrentViewData),this.organizeRawLocales=Dt(Lre),this.buildLocale=Dt(K8),this.buildPluginHooks=Bre(),this.buildDateEnv=Dt(Ioe),this.buildTheme=Dt(Doe),this.parseToolbars=Dt(uoe),this.buildViewSpecs=Dt(Hre),this.buildDateProfileGenerator=nm(Roe),this.buildViewApi=Dt(Foe),this.buildViewUiProps=nm(Ooe),this.buildEventUiBySource=Dt(Loe,Zi),this.buildEventUiBases=Dt(Noe),this.parseContextBusinessHours=nm($oe),this.buildTitle=Dt(Poe),this.nowManager=new Wx,this.emitter=new Al,this.actionRunner=new XR(this._handleAction.bind(this),this.updateData.bind(this)),this.currentCalendarOptionsInput={},this.currentCalendarOptionsRefined={},this.currentViewOptionsInput={},this.currentViewOptionsRefined={},this.currentCalendarOptionsRefiners={},this.optionsForRefining=[],this.optionsForHandling=[],this.getCurrentData=()=>this.data,this.dispatch=h=>{this.actionRunner.request(h)},this.props=e,this.actionRunner.pause(),this.nowManager=new Wx;let t={},n=this.computeOptionsData(e.optionOverrides,t,e.calendarApi),i=n.calendarOptions.initialView||n.pluginHooks.initialView,r=this.computeCurrentViewData(i,n,e.optionOverrides,t);e.calendarApi.currentDataManager=this,this.emitter.setThisContext(e.calendarApi),this.emitter.setOptions(r.options);let o={nowManager:this.nowManager,dateEnv:n.dateEnv,options:n.calendarOptions,pluginHooks:n.pluginHooks,calendarApi:e.calendarApi,dispatch:this.dispatch,emitter:this.emitter,getCurrentData:this.getCurrentData},a=Xre(n.calendarOptions,n.dateEnv,this.nowManager),l=r.dateProfileGenerator.build(a);jr(l.activeRange,a)||(a=l.currentRange.start);for(let h of n.pluginHooks.contextInit)h(o);let c=Zre(n.calendarOptions,l,o),d={dynamicOptionOverrides:t,currentViewType:i,currentDate:a,dateProfile:l,businessHours:this.parseContextBusinessHours(o),eventSources:c,eventUiBases:{},eventStore:Ci(),renderableEventStore:Ci(),dateSelection:null,eventSelection:"",eventDrag:null,eventResize:null,selectionConfig:this.buildViewUiProps(o).selectionConfig},u=Object.assign(Object.assign({},o),d);for(let h of n.pluginHooks.reducers)Object.assign(d,h(null,null,u));qR(d,o)&&this.emitter.trigger("loading",!0),this.state=d,this.updateData(),this.actionRunner.resume()}resetOptions(e,t){let{props:n}=this;t===void 0?n.optionOverrides=e:(n.optionOverrides=Object.assign(Object.assign({},n.optionOverrides||{}),e),this.optionsForRefining.push(...t)),(t===void 0||t.length)&&this.actionRunner.request({type:"NOTHING"})}_handleAction(e){let{props:t,state:n,emitter:i}=this,r=Qre(n.dynamicOptionOverrides,e),o=this.computeOptionsData(t.optionOverrides,r,t.calendarApi),a=Kre(n.currentViewType,e),l=this.computeCurrentViewData(a,o,t.optionOverrides,r);t.calendarApi.currentDataManager=this,i.setThisContext(t.calendarApi),i.setOptions(l.options);let c={nowManager:this.nowManager,dateEnv:o.dateEnv,options:o.calendarOptions,pluginHooks:o.pluginHooks,calendarApi:t.calendarApi,dispatch:this.dispatch,emitter:i,getCurrentData:this.getCurrentData},{currentDate:d,dateProfile:u}=n;this.data&&this.data.dateProfileGenerator!==l.dateProfileGenerator&&(u=l.dateProfileGenerator.build(d)),d=Yre(d,e),u=Jre(u,e,d,l.dateProfileGenerator),(e.type==="PREV"||e.type==="NEXT"||!jr(u.currentRange,d))&&(d=u.currentRange.start);let h=eoe(n.eventSources,e,u,c),p=f8(n.eventStore,e,h,u,c),_=X8(h)&&!l.options.progressiveEventRendering&&n.renderableEventStore||p,{eventUiSingleBase:b,selectionConfig:y}=this.buildViewUiProps(c),w=this.buildEventUiBySource(h),C=this.buildEventUiBases(_.defs,b,w),M={dynamicOptionOverrides:r,currentViewType:a,currentDate:d,dateProfile:u,eventSources:h,eventStore:p,renderableEventStore:_,selectionConfig:y,eventUiBases:C,businessHours:this.parseContextBusinessHours(c),dateSelection:aoe(n.dateSelection,e),eventSelection:loe(n.eventSelection,e),eventDrag:coe(n.eventDrag,e),eventResize:doe(n.eventResize,e)},S=Object.assign(Object.assign({},c),M);for(let P of o.pluginHooks.reducers)Object.assign(M,P(n,e,S));let k=qR(n,c),T=qR(M,c);!k&&T?i.trigger("loading",!0):k&&!T&&i.trigger("loading",!1),this.state=M,t.onAction&&t.onAction(e)}updateData(){let{props:e,state:t}=this,n=this.data,i=this.computeOptionsData(e.optionOverrides,t.dynamicOptionOverrides,e.calendarApi),r=this.computeCurrentViewData(t.currentViewType,i,e.optionOverrides,t.dynamicOptionOverrides),o=this.data=Object.assign(Object.assign(Object.assign({nowManager:this.nowManager,viewTitle:this.buildTitle(t.dateProfile,r.options,i.dateEnv),calendarApi:e.calendarApi,dispatch:this.dispatch,emitter:this.emitter,getCurrentData:this.getCurrentData},i),r),t),a=i.pluginHooks.optionChangeHandlers,l=n&&n.calendarOptions,c=i.calendarOptions;if(l&&l!==c){l.timeZone!==c.timeZone&&(t.eventSources=o.eventSources=toe(o.eventSources,t.dateProfile,o),t.eventStore=o.eventStore=kR(o.eventStore,n.dateEnv,o.dateEnv),t.renderableEventStore=o.renderableEventStore=kR(o.renderableEventStore,n.dateEnv,o.dateEnv));for(let d in a)(this.optionsForHandling.indexOf(d)!==-1||l[d]!==c[d])&&a[d](c[d],o)}this.optionsForHandling=[],e.onData&&e.onData(o)}computeOptionsData(e,t,n){if(!this.optionsForRefining.length&&e===this.stableOptionOverrides&&t===this.stableDynamicOptionOverrides)return this.stableCalendarOptionsData;let{refinedOptions:i,pluginHooks:r,localeDefaults:o,availableLocaleData:a,extra:l}=this.processRawCalendarOptions(e,t);H8(l);let c=this.buildDateEnv(i.timeZone,i.locale,i.weekNumberCalculation,i.firstDay,i.weekText,r,a,i.defaultRangeSeparator),d=this.buildViewSpecs(r.views,this.stableOptionOverrides,this.stableDynamicOptionOverrides,o),u=this.buildTheme(i,r),h=this.parseToolbars(i,this.stableOptionOverrides,u,d,n);return this.stableCalendarOptionsData={calendarOptions:i,pluginHooks:r,dateEnv:c,viewSpecs:d,theme:u,toolbarConfig:h,localeDefaults:o,availableRawLocales:a.map}}processRawCalendarOptions(e,t){let{locales:n,locale:i}=kx([Xc,e,t]),r=this.organizeRawLocales(n),o=r.map,a=this.buildLocale(i||r.defaultCode,o).options,l=this.buildPluginHooks(e.plugins||[],Aoe),c=this.currentCalendarOptionsRefiners=Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},yR),vR),bR),l.listenerRefiners),l.optionRefiners),d={},u=kx([Xc,a,e,t]),h={},p=this.currentCalendarOptionsInput,f=this.currentCalendarOptionsRefined,_=!1;for(let b in u)this.optionsForRefining.indexOf(b)===-1&&(u[b]===p[b]||Qc[b]&&b in p&&Qc[b](p[b],u[b]))?h[b]=f[b]:c[b]?(h[b]=c[b](u[b]),_=!0):d[b]=p[b];return _&&(this.currentCalendarOptionsInput=u,this.currentCalendarOptionsRefined=h,this.stableOptionOverrides=e,this.stableDynamicOptionOverrides=t),this.optionsForHandling.push(...this.optionsForRefining),this.optionsForRefining=[],{rawOptions:this.currentCalendarOptionsInput,refinedOptions:this.currentCalendarOptionsRefined,pluginHooks:l,availableLocaleData:r,localeDefaults:a,extra:d}}_computeCurrentViewData(e,t,n,i){let r=t.viewSpecs[e];if(!r)throw new Error(`viewType "${e}" is not available. Please make sure you've loaded all neccessary plugins`);let{refinedOptions:o,extra:a}=this.processRawViewOptions(r,t.pluginHooks,t.localeDefaults,n,i);H8(a),this.nowManager.handleInput(t.dateEnv,o.now);let l=this.buildDateProfileGenerator({dateProfileGeneratorClass:r.optionDefaults.dateProfileGeneratorClass,nowManager:this.nowManager,duration:r.duration,durationUnit:r.durationUnit,usesMinMaxTime:r.optionDefaults.usesMinMaxTime,dateEnv:t.dateEnv,calendarApi:this.props.calendarApi,slotMinTime:o.slotMinTime,slotMaxTime:o.slotMaxTime,showNonCurrentDates:o.showNonCurrentDates,dayCount:o.dayCount,dateAlignment:o.dateAlignment,dateIncrement:o.dateIncrement,hiddenDays:o.hiddenDays,weekends:o.weekends,validRangeInput:o.validRange,visibleRangeInput:o.visibleRange,fixedWeekCount:o.fixedWeekCount}),c=this.buildViewApi(e,this.getCurrentData,t.dateEnv);return{viewSpec:r,options:o,dateProfileGenerator:l,viewApi:c}}processRawViewOptions(e,t,n,i,r){let o=kx([Xc,e.optionDefaults,n,i,e.optionOverrides,r]),a=Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},yR),vR),bR),i8),t.listenerRefiners),t.optionRefiners),l={},c=this.currentViewOptionsInput,d=this.currentViewOptionsRefined,u=!1,h={};for(let p in o)o[p]===c[p]||Qc[p]&&Qc[p](o[p],c[p])?l[p]=d[p]:(o[p]===this.currentCalendarOptionsInput[p]||Qc[p]&&Qc[p](o[p],this.currentCalendarOptionsInput[p])?p in this.currentCalendarOptionsRefined&&(l[p]=this.currentCalendarOptionsRefined[p]):a[p]?l[p]=a[p](o[p]):h[p]=o[p],u=!0);return u&&(this.currentViewOptionsInput=o,this.currentViewOptionsRefined=l),{rawOptions:this.currentViewOptionsInput,refinedOptions:this.currentViewOptionsRefined,extra:h}}};function Ioe(s,e,t,n,i,r,o,a){let l=K8(e||o.defaultCode,o.map);return new yv({calendarSystem:"gregory",timeZone:s,namedTimeZoneImpl:r.namedTimeZonedImpl,locale:l,weekNumberCalculation:t,firstDay:n,weekText:i,cmdFormatter:r.cmdFormatter,defaultSeparator:a})}function Doe(s,e){let t=e.themeClasses[s.themeSystem]||ka;return new t(s)}function Roe(s){let e=s.dateProfileGeneratorClass||lh;return new e(s)}function Foe(s,e,t){return new YR(s,e,t)}function Loe(s){return qr(s,e=>e.ui)}function Noe(s,e,t){let n={"":e};for(let i in s){let r=s[i];r.sourceId&&t[r.sourceId]&&(n[i]=t[r.sourceId])}return n}function Ooe(s){let{options:e}=s;return{eventUiSingleBase:im({display:e.eventDisplay,editable:e.editable,startEditable:e.eventStartEditable,durationEditable:e.eventDurationEditable,constraint:e.eventConstraint,overlap:typeof e.eventOverlap=="boolean"?e.eventOverlap:void 0,allow:e.eventAllow,backgroundColor:e.eventBackgroundColor,borderColor:e.eventBorderColor,textColor:e.eventTextColor,color:e.eventColor},s),selectionConfig:im({constraint:e.selectConstraint,overlap:typeof e.selectOverlap=="boolean"?e.selectOverlap:void 0,allow:e.selectAllow},s)}}function qR(s,e){for(let t of e.pluginHooks.isLoadingFuncs)if(t(s))return!0;return!1}function $oe(s){return IR(s.options.businessHours,s)}function H8(s,e){for(let t in s)console.warn(`Unknown option '${t}'`+(e?` for view '${e}'`:""))}var JR=class extends sn{render(){let e=this.props.widgetGroups.map(t=>this.renderWidgetGroup(t));return ce("div",{className:"fc-toolbar-chunk"},...e)}renderWidgetGroup(e){let{props:t}=this,{theme:n}=this.context,i=[],r=!0;for(let o of e){let{buttonName:a,buttonClick:l,buttonText:c,buttonIcon:d,buttonHint:u}=o;if(a==="title")r=!1,i.push(ce("h2",{className:"fc-toolbar-title",id:t.titleId},t.title));else{let h=a===t.activeButton,p=!t.isTodayEnabled&&a==="today"||!t.isPrevEnabled&&a==="prev"||!t.isNextEnabled&&a==="next",f=[`fc-${a}-button`,n.getClass("button")];h&&f.push(n.getClass("buttonActive")),i.push(ce("button",{type:"button",title:typeof u=="function"?u(t.navUnit):u,disabled:p,"aria-pressed":h,className:f.join(" "),onClick:l},c||(d?ce("span",{className:d,role:"img"}):"")))}}if(i.length>1){let o=r&&n.getClass("buttonGroup")||"";return ce("div",{className:o},...i)}return i[0]}},Hx=class extends sn{render(){let{model:e,extraClassName:t}=this.props,n=!1,i,r,o=e.sectionWidgets,a=o.center;return o.left?(n=!0,i=o.left):i=o.start,o.right?(n=!0,r=o.right):r=o.end,ce("div",{className:[t||"","fc-toolbar",n?"fc-toolbar-ltr":""].join(" ")},this.renderSection("start",i||[]),this.renderSection("center",a||[]),this.renderSection("end",r||[]))}renderSection(e,t){let{props:n}=this;return ce(JR,{key:e,widgetGroups:t,title:n.title,navUnit:n.navUnit,activeButton:n.activeButton,isTodayEnabled:n.isTodayEnabled,isPrevEnabled:n.isPrevEnabled,isNextEnabled:n.isNextEnabled,titleId:n.titleId})}},ZR=class extends sn{constructor(){super(...arguments),this.state={availableWidth:null},this.handleEl=e=>{this.el=e,Cr(this.props.elRef,e),this.updateAvailableWidth()},this.handleResize=()=>{this.updateAvailableWidth()}}render(){let{props:e,state:t}=this,{aspectRatio:n}=e,i=["fc-view-harness",n||e.liquid||e.height?"fc-view-harness-active":"fc-view-harness-passive"],r="",o="";return n?t.availableWidth!==null?r=t.availableWidth/n:o=`${1/n*100}%`:r=e.height||"",ce("div",{"aria-labelledby":e.labeledById,ref:this.handleEl,className:i.join(" "),style:{height:r,paddingBottom:o}},e.children)}componentDidMount(){this.context.addResizeHandler(this.handleResize)}componentWillUnmount(){this.context.removeResizeHandler(this.handleResize)}updateAvailableWidth(){this.el&&this.props.aspectRatio&&this.setState({availableWidth:this.el.offsetWidth})}},eF=class extends $o{constructor(e){super(e),this.handleSegClick=(t,n)=>{let{component:i}=this,{context:r}=i,o=Il(n);if(o&&i.isValidSegDownEl(t.target)){let a=Gs(t.target,".fc-event-forced-url"),l=a?a.querySelector("a[href]").href:"";r.emitter.trigger("eventClick",{el:n,event:new Vn(i.context,o.eventRange.def,o.eventRange.instance),jsEvent:t,view:r.viewApi}),l&&!t.defaultPrevented&&(window.location.href=l)}},this.destroy=rR(e.el,"click",".fc-event",this.handleSegClick)}},tF=class extends $o{constructor(e){super(e),this.handleEventElRemove=t=>{t===this.currentSegEl&&this.handleSegLeave(null,this.currentSegEl)},this.handleSegEnter=(t,n)=>{Il(n)&&(this.currentSegEl=n,this.triggerEvent("eventMouseEnter",t,n))},this.handleSegLeave=(t,n)=>{this.currentSegEl&&(this.currentSegEl=null,this.triggerEvent("eventMouseLeave",t,n))},this.removeHoverListeners=Y6(e.el,".fc-event",this.handleSegEnter,this.handleSegLeave)}destroy(){this.removeHoverListeners()}triggerEvent(e,t,n){let{component:i}=this,{context:r}=i,o=Il(n);(!t||i.isValidSegDownEl(t.target))&&r.emitter.trigger(e,{el:n,event:new Vn(r,o.eventRange.def,o.eventRange.instance),jsEvent:t,view:r.viewApi})}},nF=class extends Ea{constructor(){super(...arguments),this.buildViewContext=Dt(c8),this.buildViewPropTransformers=Dt(zoe),this.buildToolbarProps=Dt(Boe),this.headerRef=Rs(),this.footerRef=Rs(),this.interactionsStore={},this.state={viewLabelId:Kr()},this.registerInteractiveComponent=(e,t)=>{let n=b8(e,t),o=[eF,tF].concat(this.props.pluginHooks.componentInteractions).map(a=>new a(n));this.interactionsStore[e.uid]=o,om[e.uid]=n},this.unregisterInteractiveComponent=e=>{let t=this.interactionsStore[e.uid];if(t){for(let n of t)n.destroy();delete this.interactionsStore[e.uid]}delete om[e.uid]},this.resizeRunner=new ah(()=>{this.props.emitter.trigger("_resize",!0),this.props.emitter.trigger("windowResize",{view:this.props.viewApi})}),this.handleWindowResize=e=>{let{options:t}=this.props;t.handleWindowResize&&e.target===window&&this.resizeRunner.request(t.windowResizeDelay)}}render(){let{props:e}=this,{toolbarConfig:t,options:n}=e,i=!1,r="",o;e.isHeightAuto||e.forPrint?r="":n.height!=null?i=!0:n.contentHeight!=null?r=n.contentHeight:o=Math.max(n.aspectRatio,.5);let a=this.buildViewContext(e.viewSpec,e.viewApi,e.options,e.dateProfileGenerator,e.dateEnv,e.nowManager,e.theme,e.pluginHooks,e.dispatch,e.getCurrentData,e.emitter,e.calendarApi,this.registerInteractiveComponent,this.unregisterInteractiveComponent),l=t.header&&t.header.hasTitle?this.state.viewLabelId:void 0;return ce(Yr.Provider,{value:a},ce(er,{unit:"day"},c=>{let d=this.buildToolbarProps(e.viewSpec,e.dateProfile,e.dateProfileGenerator,e.currentDate,c,e.viewTitle);return ce(gn,null,t.header&&ce(Hx,Object.assign({ref:this.headerRef,extraClassName:"fc-header-toolbar",model:t.header,titleId:l},d)),ce(ZR,{liquid:i,height:r,aspectRatio:o,labeledById:l},this.renderView(e),this.buildAppendContent()),t.footer&&ce(Hx,Object.assign({ref:this.footerRef,extraClassName:"fc-footer-toolbar",model:t.footer,titleId:""},d)))}))}componentDidMount(){let{props:e}=this;this.calendarInteractions=e.pluginHooks.calendarInteractions.map(n=>new n(e)),window.addEventListener("resize",this.handleWindowResize);let{propSetHandlers:t}=e.pluginHooks;for(let n in t)t[n](e[n],e)}componentDidUpdate(e){let{props:t}=this,{propSetHandlers:n}=t.pluginHooks;for(let i in n)t[i]!==e[i]&&n[i](t[i],t)}componentWillUnmount(){window.removeEventListener("resize",this.handleWindowResize),this.resizeRunner.clear();for(let e of this.calendarInteractions)e.destroy();this.props.emitter.trigger("_unmount")}buildAppendContent(){let{props:e}=this,t=e.pluginHooks.viewContainerAppends.map(n=>n(e));return ce(gn,{},...t)}renderView(e){let{pluginHooks:t}=e,{viewSpec:n}=e,i={dateProfile:e.dateProfile,businessHours:e.businessHours,eventStore:e.renderableEventStore,eventUiBases:e.eventUiBases,dateSelection:e.dateSelection,eventSelection:e.eventSelection,eventDrag:e.eventDrag,eventResize:e.eventResize,isHeightAuto:e.isHeightAuto,forPrint:e.forPrint},r=this.buildViewPropTransformers(t.viewPropsTransformers);for(let a of r)Object.assign(i,a.transform(i,e));let o=n.component;return ce(o,Object.assign({},i))}};function Boe(s,e,t,n,i,r){let o=t.build(i,void 0,!1),a=t.buildPrev(e,n,!1),l=t.buildNext(e,n,!1);return{title:r,activeButton:s.type,navUnit:s.singleUnit,isTodayEnabled:o.isValid&&!jr(e.currentRange,i),isPrevEnabled:a.isValid,isNextEnabled:l.isValid}}function zoe(s){return s.map(e=>new e)}var Qv=class extends xv{constructor(e,t={}){super(),this.isRendering=!1,this.isRendered=!1,this.currentClassNames=[],this.customContentRenderId=0,this.handleAction=n=>{switch(n.type){case"SET_EVENT_DRAG":case"SET_EVENT_RESIZE":this.renderRunner.tryDrain()}},this.handleData=n=>{this.currentData=n,this.renderRunner.request(n.calendarOptions.rerenderDelay)},this.handleRenderRequest=()=>{if(this.isRendering){this.isRendered=!0;let{currentData:n}=this;vv(()=>{zc(ce(Ev,{options:n.calendarOptions,theme:n.theme,emitter:n.emitter},(i,r,o,a)=>(this.setClassNames(i),this.setHeight(r),ce(TR.Provider,{value:this.customContentRenderId},ce(nF,Object.assign({isHeightAuto:o,forPrint:a},n))))),this.el)})}else this.isRendered&&(this.isRendered=!1,zc(null,this.el),this.setClassNames([]),this.setHeight(""))},H6(e),this.el=e,this.renderRunner=new ah(this.handleRenderRequest),new QR({optionOverrides:t,calendarApi:this,onAction:this.handleAction,onData:this.handleData})}render(){let e=this.isRendering;e?this.customContentRenderId+=1:this.isRendering=!0,this.renderRunner.request(),e&&this.updateSize()}destroy(){this.isRendering&&(this.isRendering=!1,this.renderRunner.request())}updateSize(){vv(()=>{super.updateSize()})}batchRendering(e){this.renderRunner.pause("batchRendering"),e(),this.renderRunner.resume("batchRendering")}pauseRendering(){this.renderRunner.pause("pauseRendering")}resumeRendering(){this.renderRunner.resume("pauseRendering",!0)}resetOptions(e,t){this.currentDataManager.resetOptions(e,t)}setClassNames(e){if(!Sa(e,this.currentClassNames)){let{classList:t}=this.el;for(let n of this.currentClassNames)t.remove(n);for(let n of e)t.add(n);this.currentClassNames=e}}setHeight(e){iR(this.el,"height",e)}};var iF=class extends fi{constructor(){super(...arguments),this.headerElRef=Rs()}renderSimpleLayout(e,t){let{props:n,context:i}=this,r=[],o=bh(i.options);return e&&r.push({type:"header",key:"header",isSticky:o,chunk:{elRef:this.headerElRef,tableClassName:"fc-col-header",rowContent:e}}),r.push({type:"body",key:"body",liquid:!0,chunk:{content:t}}),ce(Oo,{elClasses:["fc-daygrid"],viewSpec:i.viewSpec},ce(Hc,{liquid:!n.isHeightAuto&&!n.forPrint,collapsibleWidth:n.forPrint,cols:[],sections:r}))}renderHScrollLayout(e,t,n,i){let r=this.context.pluginHooks.scrollGridImpl;if(!r)throw new Error("No ScrollGrid implementation");let{props:o,context:a}=this,l=!o.forPrint&&bh(a.options),c=!o.forPrint&&qv(a.options),d=[];return e&&d.push({type:"header",key:"header",isSticky:l,chunks:[{key:"main",elRef:this.headerElRef,tableClassName:"fc-col-header",rowContent:e}]}),d.push({type:"body",key:"body",liquid:!0,chunks:[{key:"main",content:t}]}),c&&d.push({type:"footer",key:"footer",isSticky:!0,chunks:[{key:"main",content:lm}]}),ce(Oo,{elClasses:["fc-daygrid"],viewSpec:a.viewSpec},ce(r,{liquid:!o.isHeightAuto&&!o.forPrint,forPrint:o.forPrint,collapsibleWidth:o.forPrint,colGroups:[{cols:[{span:n,minWidth:i}]}],sections:d}))}};function qx(s,e){let t=[];for(let n=0;n<e;n+=1)t[n]=[];for(let n of s)t[n.row].push(n);return t}function jx(s,e){let t=[];for(let n=0;n<e;n+=1)t[n]=[];for(let n of s)t[n.firstCol].push(n);return t}function tY(s,e){let t=[];if(s){for(let n=0;n<e;n+=1)t[n]={affectedInstances:s.affectedInstances,isEvent:s.isEvent,segs:[]};for(let n of s.segs)t[n.row].segs.push(n)}else for(let n=0;n<e;n+=1)t[n]=null;return t}var nY=Pn({hour:"numeric",minute:"2-digit",omitZeroMinute:!0,meridiem:"narrow"});function sY(s){let{display:e}=s.eventRange.ui;return e==="list-item"||e==="auto"&&!s.eventRange.def.allDay&&s.firstCol===s.lastCol&&s.isStart&&s.isEnd}var Kx=class extends sn{render(){let{props:e}=this;return ce(jc,Object.assign({},e,{elClasses:["fc-daygrid-event","fc-daygrid-block-event","fc-h-event"],defaultTimeFormat:nY,defaultDisplayEventEnd:e.defaultDisplayEventEnd,disableResizing:!e.seg.eventRange.def.allDay}))}},Yx=class extends sn{render(){let{props:e,context:t}=this,{options:n}=t,{seg:i}=e,r=n.eventTimeFormat||nY,o=Jc(i,r,t,!0,e.defaultDisplayEventEnd);return ce(Pl,Object.assign({},e,{elTag:"a",elClasses:["fc-daygrid-event","fc-daygrid-dot-event"],elAttrs:rm(e.seg,t),defaultGenerator:Voe,timeText:o,isResizing:!1,isDateSelecting:!1}))}};function Voe(s){return ce(gn,null,ce("div",{className:"fc-daygrid-event-dot",style:{borderColor:s.borderColor||s.backgroundColor}}),s.timeText&&ce("div",{className:"fc-event-time"},s.timeText),ce("div",{className:"fc-event-title"},s.event.title||ce(gn,null,"\xA0")))}var rF=class extends sn{constructor(){super(...arguments),this.compileSegs=Dt(Goe)}render(){let{props:e}=this,{allSegs:t,invisibleSegs:n}=this.compileSegs(e.singlePlacements);return ce(_h,{elClasses:["fc-daygrid-more-link"],dateProfile:e.dateProfile,todayRange:e.todayRange,allDayDate:e.allDayDate,moreCnt:e.moreCnt,allSegs:t,hiddenSegs:n,alignmentElRef:e.alignmentElRef,alignGridTop:e.alignGridTop,extraDateSpan:e.extraDateSpan,popoverContent:()=>{let i=(e.eventDrag?e.eventDrag.affectedInstances:null)||(e.eventResize?e.eventResize.affectedInstances:null)||{};return ce(gn,null,t.map(r=>{let o=r.eventRange.instance.instanceId;return ce("div",{className:"fc-daygrid-event-harness",key:o,style:{visibility:i[o]?"hidden":""}},sY(r)?ce(Yx,Object.assign({seg:r,isDragging:!1,isSelected:o===e.eventSelection,defaultDisplayEventEnd:!1},Ar(r,e.todayRange))):ce(Kx,Object.assign({seg:r,isDragging:!1,isResizing:!1,isDateSelecting:!1,isSelected:o===e.eventSelection,defaultDisplayEventEnd:!1},Ar(r,e.todayRange))))}))}})}};function Goe(s){let e=[],t=[];for(let n of s)e.push(n.seg),n.isVisible||t.push(n.seg);return{allSegs:e,invisibleSegs:t}}var Woe=Pn({week:"narrow"}),oF=class extends fi{constructor(){super(...arguments),this.rootElRef=Rs(),this.state={dayNumberId:Kr()},this.handleRootEl=e=>{Cr(this.rootElRef,e),Cr(this.props.elRef,e)}}render(){let{context:e,props:t,state:n,rootElRef:i}=this,{options:r,dateEnv:o}=e,{date:a,dateProfile:l}=t,c=t.showDayNumber&&joe(a,l.currentRange,o);return ce(qc,{elTag:"td",elRef:this.handleRootEl,elClasses:["fc-daygrid-day",...t.extraClassNames||[]],elAttrs:Object.assign(Object.assign(Object.assign({},t.extraDataAttrs),t.showDayNumber?{"aria-labelledby":n.dayNumberId}:{}),{role:"gridcell"}),defaultGenerator:Hoe,date:a,dateProfile:l,todayRange:t.todayRange,showDayNumber:t.showDayNumber,isMonthStart:c,extraRenderProps:t.extraRenderProps},(d,u)=>ce("div",{ref:t.innerElRef,className:"fc-daygrid-day-frame fc-scrollgrid-sync-inner",style:{minHeight:t.minHeight}},t.showWeekNumber&&ce(Xv,{elTag:"a",elClasses:["fc-daygrid-week-number"],elAttrs:Pa(e,a,"week"),date:a,defaultFormat:Woe}),!u.isDisabled&&(t.showDayNumber||cm(r)||t.forceDayTop)?ce("div",{className:"fc-daygrid-day-top"},ce(d,{elTag:"a",elClasses:["fc-daygrid-day-number",c&&"fc-daygrid-month-start"],elAttrs:Object.assign(Object.assign({},Pa(e,a)),{id:n.dayNumberId})})):t.showDayNumber?ce("div",{className:"fc-daygrid-day-top",style:{visibility:"hidden"}},ce("a",{className:"fc-daygrid-day-number"},"\xA0")):void 0,ce("div",{className:"fc-daygrid-day-events",ref:t.fgContentElRef},t.fgContent,ce("div",{className:"fc-daygrid-day-bottom",style:{marginTop:t.moreMarginTop}},ce(rF,{allDayDate:a,singlePlacements:t.singlePlacements,moreCnt:t.moreCnt,alignmentElRef:i,alignGridTop:!t.showDayNumber,extraDateSpan:t.extraDateSpan,dateProfile:t.dateProfile,eventSelection:t.eventSelection,eventDrag:t.eventDrag,eventResize:t.eventResize,todayRange:t.todayRange}))),ce("div",{className:"fc-daygrid-day-bg"},t.bgContent)))}};function Hoe(s){return s.dayNumberText||ce(gn,null,"\xA0")}function joe(s,e,t){let{start:n,end:i}=e,r=Ta(i,-1),o=t.getYear(n),a=t.getMonth(n),l=t.getYear(r),c=t.getMonth(r);return!(o===l&&a===c)&&(s.valueOf()===n.valueOf()||t.getDay(s)===1&&s.valueOf()<i.valueOf())}function iY(s){return s.eventRange.instance.instanceId+":"+s.firstCol}function rY(s){return iY(s)+":"+s.lastCol}function qoe(s,e,t,n,i,r,o){let a=new aF(y=>{let w=s[y.index].eventRange.instance.instanceId+":"+y.span.start+":"+(y.span.end-1);return i[w]||1});a.allowReslicing=!0,a.strictOrder=n,e===!0||t===!0?(a.maxCoord=r,a.hiddenConsumes=!0):typeof e=="number"?a.maxStackCnt=e:typeof t=="number"&&(a.maxStackCnt=t,a.hiddenConsumes=!0);let l=[],c=[];for(let y=0;y<s.length;y+=1){let w=s[y],C=rY(w);i[C]!=null?l.push({index:y,span:{start:w.firstCol,end:w.lastCol+1}}):c.push(w)}let d=a.addSegs(l),u=a.toRects(),{singleColPlacements:h,multiColPlacements:p,leftoverMargins:f}=Koe(u,s,o),_=[],b=[];for(let y of c){p[y.firstCol].push({seg:y,isVisible:!1,isAbsolute:!0,absoluteTop:0,marginTop:0});for(let w=y.firstCol;w<=y.lastCol;w+=1)h[w].push({seg:dm(y,w,w+1,o),isVisible:!1,isAbsolute:!1,absoluteTop:0,marginTop:0})}for(let y=0;y<o.length;y+=1)_.push(0);for(let y of d){let w=s[y.index],C=y.span;p[C.start].push({seg:dm(w,C.start,C.end,o),isVisible:!1,isAbsolute:!0,absoluteTop:0,marginTop:0});for(let M=C.start;M<C.end;M+=1)_[M]+=1,h[M].push({seg:dm(w,M,M+1,o),isVisible:!1,isAbsolute:!1,absoluteTop:0,marginTop:0})}for(let y=0;y<o.length;y+=1)b.push(f[y]);return{singleColPlacements:h,multiColPlacements:p,moreCnts:_,moreMarginTops:b}}function Koe(s,e,t){let n=Yoe(s,t.length),i=[],r=[],o=[];for(let a=0;a<t.length;a+=1){let l=n[a],c=[],d=0,u=0;for(let p of l){let f=e[p.index];c.push({seg:dm(f,a,a+1,t),isVisible:!0,isAbsolute:!1,absoluteTop:p.levelCoord,marginTop:p.levelCoord-d}),d=p.levelCoord+p.thickness}let h=[];d=0,u=0;for(let p of l){let f=e[p.index],_=p.span.end-p.span.start>1,b=p.span.start===a;u+=p.levelCoord-d,d=p.levelCoord+p.thickness,_?(u+=p.thickness,b&&h.push({seg:dm(f,p.span.start,p.span.end,t),isVisible:!0,isAbsolute:!0,absoluteTop:p.levelCoord,marginTop:0})):b&&(h.push({seg:dm(f,p.span.start,p.span.end,t),isVisible:!0,isAbsolute:!1,absoluteTop:p.levelCoord,marginTop:u}),u=0)}i.push(c),r.push(h),o.push(u)}return{singleColPlacements:i,multiColPlacements:r,leftoverMargins:o}}function Yoe(s,e){let t=[];for(let n=0;n<e;n+=1)t.push([]);for(let n of s)for(let i=n.span.start;i<n.span.end;i+=1)t[i].push(n);return t}function dm(s,e,t,n){if(s.firstCol===e&&s.lastCol===t-1)return s;let i=s.eventRange,r=i.range,o=Sr(r,{start:n[e].date,end:ts(n[t-1].date,1)});return Object.assign(Object.assign({},s),{firstCol:e,lastCol:t-1,eventRange:{def:i.def,ui:Object.assign(Object.assign({},i.ui),{durationEditable:!1}),instance:i.instance,range:o},isStart:s.isStart&&o.start.valueOf()===r.start.valueOf(),isEnd:s.isEnd&&o.end.valueOf()===r.end.valueOf()})}var aF=class extends uh{constructor(){super(...arguments),this.hiddenConsumes=!1,this.forceHidden={}}addSegs(e){let t=super.addSegs(e),{entriesByLevel:n}=this,i=r=>!this.forceHidden[xa(r)];for(let r=0;r<n.length;r+=1)n[r]=n[r].filter(i);return t}handleInvalidInsertion(e,t,n){let{entriesByLevel:i,forceHidden:r}=this,{touchingEntry:o,touchingLevel:a,touchingLateral:l}=e;if(this.hiddenConsumes&&o){let c=xa(o);if(!r[c])if(this.allowReslicing){let d=Object.assign(Object.assign({},o),{span:Hv(o.span,t.span)}),u=xa(d);r[u]=!0,i[a][l]=d,n.push(d),this.splitEntry(o,t,n)}else r[c]=!0,n.push(o)}super.handleInvalidInsertion(e,t,n)}},Xx=class extends fi{constructor(){super(...arguments),this.cellElRefs=new tr,this.frameElRefs=new tr,this.fgElRefs=new tr,this.segHarnessRefs=new tr,this.rootElRef=Rs(),this.state={framePositions:null,maxContentHeight:null,segHeights:{}},this.handleResize=e=>{e&&this.updateSizing(!0)}}render(){let{props:e,state:t,context:n}=this,{options:i}=n,r=e.cells.length,o=jx(e.businessHourSegs,r),a=jx(e.bgEventSegs,r),l=jx(this.getHighlightSegs(),r),c=jx(this.getMirrorSegs(),r),{singleColPlacements:d,multiColPlacements:u,moreCnts:h,moreMarginTops:p}=qoe(vh(e.fgEventSegs,i.eventOrder),e.dayMaxEvents,e.dayMaxEventRows,i.eventOrderStrict,t.segHeights,t.maxContentHeight,e.cells),f=e.eventDrag&&e.eventDrag.affectedInstances||e.eventResize&&e.eventResize.affectedInstances||{};return ce("tr",{ref:this.rootElRef,role:"row"},e.renderIntro&&e.renderIntro(),e.cells.map((_,b)=>{let y=this.renderFgSegs(b,e.forPrint?d[b]:u[b],e.todayRange,f),w=this.renderFgSegs(b,Xoe(c[b],u),e.todayRange,{},!!e.eventDrag,!!e.eventResize,!1);return ce(oF,{key:_.key,elRef:this.cellElRefs.createRef(_.key),innerElRef:this.frameElRefs.createRef(_.key),dateProfile:e.dateProfile,date:_.date,showDayNumber:e.showDayNumbers,showWeekNumber:e.showWeekNumbers&&b===0,forceDayTop:e.showWeekNumbers,todayRange:e.todayRange,eventSelection:e.eventSelection,eventDrag:e.eventDrag,eventResize:e.eventResize,extraRenderProps:_.extraRenderProps,extraDataAttrs:_.extraDataAttrs,extraClassNames:_.extraClassNames,extraDateSpan:_.extraDateSpan,moreCnt:h[b],moreMarginTop:p[b],singlePlacements:d[b],fgContentElRef:this.fgElRefs.createRef(_.key),fgContent:ce(gn,null,ce(gn,null,y),ce(gn,null,w)),bgContent:ce(gn,null,this.renderFillSegs(l[b],"highlight"),this.renderFillSegs(o[b],"non-business"),this.renderFillSegs(a[b],"bg-event")),minHeight:e.cellMinHeight})}))}componentDidMount(){this.updateSizing(!0),this.context.addResizeHandler(this.handleResize)}componentDidUpdate(e,t){let n=this.props;this.updateSizing(!Zi(e,n))}componentWillUnmount(){this.context.removeResizeHandler(this.handleResize)}getHighlightSegs(){let{props:e}=this;return e.eventDrag&&e.eventDrag.segs.length?e.eventDrag.segs:e.eventResize&&e.eventResize.segs.length?e.eventResize.segs:e.dateSelectionSegs}getMirrorSegs(){let{props:e}=this;return e.eventResize&&e.eventResize.segs.length?e.eventResize.segs:[]}renderFgSegs(e,t,n,i,r,o,a){let{context:l}=this,{eventSelection:c}=this.props,{framePositions:d}=this.state,u=this.props.cells.length===1,h=r||o||a,p=[];if(d)for(let f of t){let{seg:_}=f,{instanceId:b}=_.eventRange.instance,y=f.isVisible&&!i[b],w=f.isAbsolute,C="",M="";w&&(l.isRtl?(M=0,C=d.lefts[_.lastCol]-d.lefts[_.firstCol]):(C=0,M=d.rights[_.firstCol]-d.rights[_.lastCol])),p.push(ce("div",{className:"fc-daygrid-event-harness"+(w?" fc-daygrid-event-harness-abs":""),key:iY(_),ref:h?null:this.segHarnessRefs.createRef(rY(_)),style:{visibility:y?"":"hidden",marginTop:w?"":f.marginTop,top:w?f.absoluteTop:"",left:C,right:M}},sY(_)?ce(Yx,Object.assign({seg:_,isDragging:r,isSelected:b===c,defaultDisplayEventEnd:u},Ar(_,n))):ce(Kx,Object.assign({seg:_,isDragging:r,isResizing:o,isDateSelecting:a,isSelected:b===c,defaultDisplayEventEnd:u},Ar(_,n)))))}return p}renderFillSegs(e,t){let{isRtl:n}=this.context,{todayRange:i}=this.props,{framePositions:r}=this.state,o=[];if(r)for(let a of e){let l=n?{right:0,left:r.lefts[a.lastCol]-r.lefts[a.firstCol]}:{left:0,right:r.rights[a.firstCol]-r.rights[a.lastCol]};o.push(ce("div",{key:Uv(a.eventRange),className:"fc-daygrid-bg-harness",style:l},t==="bg-event"?ce(gh,Object.assign({seg:a},Ar(a,i))):Yv(t)))}return ce(gn,{},...o)}updateSizing(e){let{props:t,state:n,frameElRefs:i}=this;if(!t.forPrint&&t.clientWidth!==null){if(e){let l=t.cells.map(c=>i.currentMap[c.key]);if(l.length){let c=this.rootElRef.current,d=new Bo(c,l,!0,!1);(!n.framePositions||!n.framePositions.similarTo(d))&&this.setState({framePositions:new Bo(c,l,!0,!1)})}}let r=this.state.segHeights,o=this.querySegHeights(),a=t.dayMaxEvents===!0||t.dayMaxEventRows===!0;this.safeSetState({segHeights:Object.assign(Object.assign({},r),o),maxContentHeight:a?this.computeMaxContentHeight():null})}}querySegHeights(){let e=this.segHarnessRefs.currentMap,t={};for(let n in e){let i=Math.round(e[n].getBoundingClientRect().height);t[n]=Math.max(t[n]||0,i)}return t}computeMaxContentHeight(){let e=this.props.cells[0].key,t=this.cellElRefs.currentMap[e],n=this.fgElRefs.currentMap[e];return t.getBoundingClientRect().bottom-n.getBoundingClientRect().top}getCellEls(){let e=this.cellElRefs.currentMap;return this.props.cells.map(t=>e[t.key])}};Xx.addStateEquality({segHeights:Zi});function Xoe(s,e){if(!s.length)return[];let t=Qoe(e);return s.map(n=>({seg:n,isVisible:!0,isAbsolute:!0,absoluteTop:t[n.eventRange.instance.instanceId],marginTop:0}))}function Qoe(s){let e={};for(let t of s)for(let n of t)e[n.seg.eventRange.instance.instanceId]=n.absoluteTop;return e}var lF=class extends fi{constructor(){super(...arguments),this.splitBusinessHourSegs=Dt(qx),this.splitBgEventSegs=Dt(Joe),this.splitFgEventSegs=Dt(qx),this.splitDateSelectionSegs=Dt(qx),this.splitEventDrag=Dt(tY),this.splitEventResize=Dt(tY),this.rowRefs=new tr}render(){let{props:e,context:t}=this,n=e.cells.length,i=this.splitBusinessHourSegs(e.businessHourSegs,n),r=this.splitBgEventSegs(e.bgEventSegs,n),o=this.splitFgEventSegs(e.fgEventSegs,n),a=this.splitDateSelectionSegs(e.dateSelectionSegs,n),l=this.splitEventDrag(e.eventDrag,n),c=this.splitEventResize(e.eventResize,n),d=n>=7&&e.clientWidth?e.clientWidth/t.options.aspectRatio/6:null;return ce(er,{unit:"day"},(u,h)=>ce(gn,null,e.cells.map((p,f)=>ce(Xx,{ref:this.rowRefs.createRef(f),key:p.length?p[0].date.toISOString():f,showDayNumbers:n>1,showWeekNumbers:e.showWeekNumbers,todayRange:h,dateProfile:e.dateProfile,cells:p,renderIntro:e.renderRowIntro,businessHourSegs:i[f],eventSelection:e.eventSelection,bgEventSegs:r[f],fgEventSegs:o[f],dateSelectionSegs:a[f],eventDrag:l[f],eventResize:c[f],dayMaxEvents:e.dayMaxEvents,dayMaxEventRows:e.dayMaxEventRows,clientWidth:e.clientWidth,clientHeight:e.clientHeight,cellMinHeight:d,forPrint:e.forPrint}))))}componentDidMount(){this.registerInteractiveComponent()}componentDidUpdate(){this.registerInteractiveComponent()}registerInteractiveComponent(){if(!this.rootEl){let e=this.rowRefs.currentMap[0].getCellEls()[0],t=e?e.closest(".fc-daygrid-body"):null;t&&(this.rootEl=t,this.context.registerInteractiveComponent(this,{el:t,isHitComboAllowed:this.props.isHitComboAllowed}))}}componentWillUnmount(){this.rootEl&&(this.context.unregisterInteractiveComponent(this),this.rootEl=null)}prepareHits(){this.rowPositions=new Bo(this.rootEl,this.rowRefs.collect().map(e=>e.getCellEls()[0]),!1,!0),this.colPositions=new Bo(this.rootEl,this.rowRefs.currentMap[0].getCellEls(),!0,!1)}queryHit(e,t){let{colPositions:n,rowPositions:i}=this,r=n.leftToIndex(e),o=i.topToIndex(t);if(o!=null&&r!=null){let a=this.props.cells[o][r];return{dateProfile:this.props.dateProfile,dateSpan:Object.assign({range:this.getCellRange(o,r),allDay:!0},a.extraDateSpan),dayEl:this.getCellEl(o,r),rect:{left:n.lefts[r],right:n.rights[r],top:i.tops[o],bottom:i.bottoms[o]},layer:0}}return null}getCellEl(e,t){return this.rowRefs.currentMap[e].getCellEls()[t]}getCellRange(e,t){let n=this.props.cells[e][t].date,i=ts(n,1);return{start:n,end:i}}};function Joe(s,e){return qx(s.filter(Zoe),e)}function Zoe(s){return s.eventRange.def.allDay}var cF=class extends fi{constructor(){super(...arguments),this.elRef=Rs(),this.needsScrollReset=!1}render(){let{props:e}=this,{dayMaxEventRows:t,dayMaxEvents:n,expandRows:i}=e,r=n===!0||t===!0;r&&!i&&(r=!1,t=null,n=null);let o=["fc-daygrid-body",r?"fc-daygrid-body-balanced":"fc-daygrid-body-unbalanced",i?"":"fc-daygrid-body-natural"];return ce("div",{ref:this.elRef,className:o.join(" "),style:{width:e.clientWidth,minWidth:e.tableMinWidth}},ce("table",{role:"presentation",className:"fc-scrollgrid-sync-table",style:{width:e.clientWidth,minWidth:e.tableMinWidth,height:i?e.clientHeight:""}},e.colGroupNode,ce("tbody",{role:"presentation"},ce(lF,{dateProfile:e.dateProfile,cells:e.cells,renderRowIntro:e.renderRowIntro,showWeekNumbers:e.showWeekNumbers,clientWidth:e.clientWidth,clientHeight:e.clientHeight,businessHourSegs:e.businessHourSegs,bgEventSegs:e.bgEventSegs,fgEventSegs:e.fgEventSegs,dateSelectionSegs:e.dateSelectionSegs,eventSelection:e.eventSelection,eventDrag:e.eventDrag,eventResize:e.eventResize,dayMaxEvents:n,dayMaxEventRows:t,forPrint:e.forPrint,isHitComboAllowed:e.isHitComboAllowed}))))}componentDidMount(){this.requestScrollReset()}componentDidUpdate(e){e.dateProfile!==this.props.dateProfile?this.requestScrollReset():this.flushScrollReset()}requestScrollReset(){this.needsScrollReset=!0,this.flushScrollReset()}flushScrollReset(){if(this.needsScrollReset&&this.props.clientWidth){let e=eae(this.elRef.current,this.props.dateProfile);if(e){let t=e.closest(".fc-daygrid-body"),n=t.closest(".fc-scroller"),i=e.getBoundingClientRect().top-t.getBoundingClientRect().top;n.scrollTop=i?i+1:0}this.needsScrollReset=!1}}};function eae(s,e){let t;return e.currentRangeUnit.match(/year|month/)&&(t=s.querySelector(`[data-date="${mR(e.currentDate)}-01"]`)),t||(t=s.querySelector(`[data-date="${Yc(e.currentDate)}"]`)),t}var dF=class extends mh{constructor(){super(...arguments),this.forceDayIfListItem=!0}sliceRange(e,t){return t.sliceRange(e)}},Jv=class extends fi{constructor(){super(...arguments),this.slicer=new dF,this.tableRef=Rs()}render(){let{props:e,context:t}=this;return ce(cF,Object.assign({ref:this.tableRef},this.slicer.sliceProps(e,e.dateProfile,e.nextDayThreshold,t,e.dayTableModel),{dateProfile:e.dateProfile,cells:e.dayTableModel.cells,colGroupNode:e.colGroupNode,tableMinWidth:e.tableMinWidth,renderRowIntro:e.renderRowIntro,dayMaxEvents:e.dayMaxEvents,dayMaxEventRows:e.dayMaxEventRows,showWeekNumbers:e.showWeekNumbers,expandRows:e.expandRows,headerAlignElRef:e.headerAlignElRef,clientWidth:e.clientWidth,clientHeight:e.clientHeight,forPrint:e.forPrint}))}},Qx=class extends iF{constructor(){super(...arguments),this.buildDayTableModel=Dt(tae),this.headerRef=Rs(),this.tableRef=Rs()}render(){let{options:e,dateProfileGenerator:t}=this.context,{props:n}=this,i=this.buildDayTableModel(n.dateProfile,t),r=e.dayHeaders&&ce(hh,{ref:this.headerRef,dateProfile:n.dateProfile,dates:i.headerDates,datesRepDistinctDays:i.rowCnt===1}),o=a=>ce(Jv,{ref:this.tableRef,dateProfile:n.dateProfile,dayTableModel:i,businessHours:n.businessHours,dateSelection:n.dateSelection,eventStore:n.eventStore,eventUiBases:n.eventUiBases,eventSelection:n.eventSelection,eventDrag:n.eventDrag,eventResize:n.eventResize,nextDayThreshold:e.nextDayThreshold,colGroupNode:a.tableColGroupNode,tableMinWidth:a.tableMinWidth,dayMaxEvents:e.dayMaxEvents,dayMaxEventRows:e.dayMaxEventRows,showWeekNumbers:e.weekNumbers,expandRows:!n.isHeightAuto,headerAlignElRef:this.headerElRef,clientWidth:a.clientWidth,clientHeight:a.clientHeight,forPrint:n.forPrint});return e.dayMinWidth?this.renderHScrollLayout(r,o,i.colCnt,e.dayMinWidth):this.renderSimpleLayout(r,o)}};function tae(s,e){let t=new ph(s.renderRange,e);return new fh(t,/year|month|week/.test(s.currentRangeUnit))}var Jx=class extends lh{buildRenderRange(e,t,n){let i=super.buildRenderRange(e,t,n),{props:r}=this;return nae({currentRange:i,snapToWeek:/^(year|month)$/.test(t),fixedWeekCount:r.fixedWeekCount,dateEnv:r.dateEnv})}};function nae(s){let{dateEnv:e,currentRange:t}=s,{start:n,end:i}=t,r;if(s.snapToWeek&&(n=e.startOfWeek(n),r=e.startOfWeek(i),r.valueOf()!==i.valueOf()&&(i=Ax(r,1))),s.fixedWeekCount){let o=e.startOfWeek(e.startOfMonth(ts(t.end,-1))),a=Math.ceil(pR(o,i));i=Ax(i,6-a)}return{start:n,end:i}}var sae=':root{--fc-daygrid-event-dot-width:8px}.fc-daygrid-day-events:after,.fc-daygrid-day-events:before,.fc-daygrid-day-frame:after,.fc-daygrid-day-frame:before,.fc-daygrid-event-harness:after,.fc-daygrid-event-harness:before{clear:both;content:"";display:table}.fc .fc-daygrid-body{position:relative;z-index:1}.fc .fc-daygrid-day.fc-day-today{background-color:var(--fc-today-bg-color)}.fc .fc-daygrid-day-frame{min-height:100%;position:relative}.fc .fc-daygrid-day-top{display:flex;flex-direction:row-reverse}.fc .fc-day-other .fc-daygrid-day-top{opacity:.3}.fc .fc-daygrid-day-number{padding:4px;position:relative;z-index:4}.fc .fc-daygrid-month-start{font-size:1.1em;font-weight:700}.fc .fc-daygrid-day-events{margin-top:1px}.fc .fc-daygrid-body-balanced .fc-daygrid-day-events{left:0;position:absolute;right:0}.fc .fc-daygrid-body-unbalanced .fc-daygrid-day-events{min-height:2em;position:relative}.fc .fc-daygrid-body-natural .fc-daygrid-day-events{margin-bottom:1em}.fc .fc-daygrid-event-harness{position:relative}.fc .fc-daygrid-event-harness-abs{left:0;position:absolute;right:0;top:0}.fc .fc-daygrid-bg-harness{bottom:0;position:absolute;top:0}.fc .fc-daygrid-day-bg .fc-non-business{z-index:1}.fc .fc-daygrid-day-bg .fc-bg-event{z-index:2}.fc .fc-daygrid-day-bg .fc-highlight{z-index:3}.fc .fc-daygrid-event{margin-top:1px;z-index:6}.fc .fc-daygrid-event.fc-event-mirror{z-index:7}.fc .fc-daygrid-day-bottom{font-size:.85em;margin:0 2px}.fc .fc-daygrid-day-bottom:after,.fc .fc-daygrid-day-bottom:before{clear:both;content:"";display:table}.fc .fc-daygrid-more-link{border-radius:3px;cursor:pointer;line-height:1;margin-top:1px;max-width:100%;overflow:hidden;padding:2px;position:relative;white-space:nowrap;z-index:4}.fc .fc-daygrid-more-link:hover{background-color:rgba(0,0,0,.1)}.fc .fc-daygrid-week-number{background-color:var(--fc-neutral-bg-color);color:var(--fc-neutral-text-color);min-width:1.5em;padding:2px;position:absolute;text-align:center;top:0;z-index:5}.fc .fc-more-popover .fc-popover-body{min-width:220px;padding:10px}.fc-direction-ltr .fc-daygrid-event.fc-event-start,.fc-direction-rtl .fc-daygrid-event.fc-event-end{margin-left:2px}.fc-direction-ltr .fc-daygrid-event.fc-event-end,.fc-direction-rtl .fc-daygrid-event.fc-event-start{margin-right:2px}.fc-direction-ltr .fc-daygrid-more-link{float:left}.fc-direction-ltr .fc-daygrid-week-number{border-radius:0 0 3px 0;left:0}.fc-direction-rtl .fc-daygrid-more-link{float:right}.fc-direction-rtl .fc-daygrid-week-number{border-radius:0 0 0 3px;right:0}.fc-liquid-hack .fc-daygrid-day-frame{position:static}.fc-daygrid-event{border-radius:3px;font-size:var(--fc-small-font-size);position:relative;white-space:nowrap}.fc-daygrid-block-event .fc-event-time{font-weight:700}.fc-daygrid-block-event .fc-event-time,.fc-daygrid-block-event .fc-event-title{padding:1px}.fc-daygrid-dot-event{align-items:center;display:flex;padding:2px 0}.fc-daygrid-dot-event .fc-event-title{flex-grow:1;flex-shrink:1;font-weight:700;min-width:0;overflow:hidden}.fc-daygrid-dot-event.fc-event-mirror,.fc-daygrid-dot-event:hover{background:rgba(0,0,0,.1)}.fc-daygrid-dot-event.fc-event-selected:before{bottom:-10px;top:-10px}.fc-daygrid-event-dot{border:calc(var(--fc-daygrid-event-dot-width)/2) solid var(--fc-event-border-color);border-radius:calc(var(--fc-daygrid-event-dot-width)/2);box-sizing:content-box;height:0;margin:0 4px;width:0}.fc-direction-ltr .fc-daygrid-event .fc-event-time{margin-right:3px}.fc-direction-rtl .fc-daygrid-event .fc-event-time{margin-left:3px}';Kc(sae);var oY=nr({name:"@fullcalendar/daygrid",initialView:"dayGridMonth",views:{dayGrid:{component:Qx,dateProfileGeneratorClass:Jx},dayGridDay:{type:"dayGrid",duration:{days:1}},dayGridWeek:{type:"dayGrid",duration:{weeks:1}},dayGridMonth:{type:"dayGrid",duration:{months:1},fixedWeekCount:!0},dayGridYear:{type:"dayGrid",duration:{years:1}}}});var hF=class extends Sv{getKeyInfo(){return{allDay:{},timed:{}}}getKeysForDateSpan(e){return e.allDay?["allDay"]:["timed"]}getKeysForEventDef(e){return e.allDay?RR(e)?["timed","allDay"]:["allDay"]:["timed"]}},iae=Pn({hour:"numeric",minute:"2-digit",omitZeroMinute:!0,meridiem:"short"});function uY(s){let e=["fc-timegrid-slot","fc-timegrid-slot-label",s.isLabeled?"fc-scrollgrid-shrink":"fc-timegrid-slot-minor"];return ce(Yr.Consumer,null,t=>{if(!s.isLabeled)return ce("td",{className:e.join(" "),"data-time":s.isoTimeStr});let{dateEnv:n,options:i,viewApi:r}=t,o=i.slotLabelFormat==null?iae:Array.isArray(i.slotLabelFormat)?Pn(i.slotLabelFormat[0]):Pn(i.slotLabelFormat),a={level:0,time:s.time,date:n.toDate(s.date),view:r,text:n.format(s.date,o)};return ce(ms,{elTag:"td",elClasses:e,elAttrs:{"data-time":s.isoTimeStr},renderProps:a,generatorName:"slotLabelContent",customGenerator:i.slotLabelContent,defaultGenerator:rae,classNameGenerator:i.slotLabelClassNames,didMount:i.slotLabelDidMount,willUnmount:i.slotLabelWillUnmount},l=>ce("div",{className:"fc-timegrid-slot-label-frame fc-scrollgrid-shrink-frame"},ce(l,{elTag:"div",elClasses:["fc-timegrid-slot-label-cushion","fc-scrollgrid-shrink-cushion"]})))})}function rae(s){return s.text}var pF=class extends sn{render(){return this.props.slatMetas.map(e=>ce("tr",{key:e.key},ce(uY,Object.assign({},e))))}},oae=Pn({week:"short"}),aae=5,fF=class extends fi{constructor(){super(...arguments),this.allDaySplitter=new hF,this.headerElRef=Rs(),this.rootElRef=Rs(),this.scrollerElRef=Rs(),this.state={slatCoords:null},this.handleScrollTopRequest=e=>{let t=this.scrollerElRef.current;t&&(t.scrollTop=e)},this.renderHeadAxis=(e,t="")=>{let{options:n}=this.context,{dateProfile:i}=this.props,r=i.renderRange,a=Ca(r.start,r.end)===1?Pa(this.context,r.start,"week"):{};return n.weekNumbers&&e==="day"?ce(Xv,{elTag:"th",elClasses:["fc-timegrid-axis","fc-scrollgrid-shrink"],elAttrs:{"aria-hidden":!0},date:r.start,defaultFormat:oae},l=>ce("div",{className:["fc-timegrid-axis-frame","fc-scrollgrid-shrink-frame","fc-timegrid-axis-frame-liquid"].join(" "),style:{height:t}},ce(l,{elTag:"a",elClasses:["fc-timegrid-axis-cushion","fc-scrollgrid-shrink-cushion","fc-scrollgrid-sync-inner"],elAttrs:a}))):ce("th",{"aria-hidden":!0,className:"fc-timegrid-axis"},ce("div",{className:"fc-timegrid-axis-frame",style:{height:t}}))},this.renderTableRowAxis=e=>{let{options:t,viewApi:n}=this.context,i={text:t.allDayText,view:n};return ce(ms,{elTag:"td",elClasses:["fc-timegrid-axis","fc-scrollgrid-shrink"],elAttrs:{"aria-hidden":!0},renderProps:i,generatorName:"allDayContent",customGenerator:t.allDayContent,defaultGenerator:lae,classNameGenerator:t.allDayClassNames,didMount:t.allDayDidMount,willUnmount:t.allDayWillUnmount},r=>ce("div",{className:["fc-timegrid-axis-frame","fc-scrollgrid-shrink-frame",e==null?" fc-timegrid-axis-frame-liquid":""].join(" "),style:{height:e}},ce(r,{elTag:"span",elClasses:["fc-timegrid-axis-cushion","fc-scrollgrid-shrink-cushion","fc-scrollgrid-sync-inner"]})))},this.handleSlatCoords=e=>{this.setState({slatCoords:e})}}renderSimpleLayout(e,t,n){let{context:i,props:r}=this,o=[],a=bh(i.options);return e&&o.push({type:"header",key:"header",isSticky:a,chunk:{elRef:this.headerElRef,tableClassName:"fc-col-header",rowContent:e}}),t&&(o.push({type:"body",key:"all-day",chunk:{content:t}}),o.push({type:"body",key:"all-day-divider",outerContent:ce("tr",{role:"presentation",className:"fc-scrollgrid-section"},ce("td",{className:"fc-timegrid-divider "+i.theme.getClass("tableCellShaded")}))})),o.push({type:"body",key:"body",liquid:!0,expandRows:!!i.options.expandRows,chunk:{scrollerElRef:this.scrollerElRef,content:n}}),ce(Oo,{elRef:this.rootElRef,elClasses:["fc-timegrid"],viewSpec:i.viewSpec},ce(Hc,{liquid:!r.isHeightAuto&&!r.forPrint,collapsibleWidth:r.forPrint,cols:[{width:"shrink"}],sections:o}))}renderHScrollLayout(e,t,n,i,r,o,a){let l=this.context.pluginHooks.scrollGridImpl;if(!l)throw new Error("No ScrollGrid implementation");let{context:c,props:d}=this,u=!d.forPrint&&bh(c.options),h=!d.forPrint&&qv(c.options),p=[];e&&p.push({type:"header",key:"header",isSticky:u,syncRowHeights:!0,chunks:[{key:"axis",rowContent:_=>ce("tr",{role:"presentation"},this.renderHeadAxis("day",_.rowSyncHeights[0]))},{key:"cols",elRef:this.headerElRef,tableClassName:"fc-col-header",rowContent:e}]}),t&&(p.push({type:"body",key:"all-day",syncRowHeights:!0,chunks:[{key:"axis",rowContent:_=>ce("tr",{role:"presentation"},this.renderTableRowAxis(_.rowSyncHeights[0]))},{key:"cols",content:t}]}),p.push({key:"all-day-divider",type:"body",outerContent:ce("tr",{role:"presentation",className:"fc-scrollgrid-section"},ce("td",{colSpan:2,className:"fc-timegrid-divider "+c.theme.getClass("tableCellShaded")}))}));let f=c.options.nowIndicator;return p.push({type:"body",key:"body",liquid:!0,expandRows:!!c.options.expandRows,chunks:[{key:"axis",content:_=>ce("div",{className:"fc-timegrid-axis-chunk"},ce("table",{"aria-hidden":!0,style:{height:_.expandRows?_.clientHeight:""}},_.tableColGroupNode,ce("tbody",null,ce(pF,{slatMetas:o}))),ce("div",{className:"fc-timegrid-now-indicator-container"},ce(er,{unit:f?"minute":"day"},b=>{let y=f&&a&&a.safeComputeTop(b);return typeof y=="number"?ce(Kv,{elClasses:["fc-timegrid-now-indicator-arrow"],elStyle:{top:y},isAxis:!0,date:b}):null})))},{key:"cols",scrollerElRef:this.scrollerElRef,content:n}]}),h&&p.push({key:"footer",type:"footer",isSticky:!0,chunks:[{key:"axis",content:lm},{key:"cols",content:lm}]}),ce(Oo,{elRef:this.rootElRef,elClasses:["fc-timegrid"],viewSpec:c.viewSpec},ce(l,{liquid:!d.isHeightAuto&&!d.forPrint,forPrint:d.forPrint,collapsibleWidth:!1,colGroups:[{width:"shrink",cols:[{width:"shrink"}]},{cols:[{span:i,minWidth:r}]}],sections:p}))}getAllDayMaxEventProps(){let{dayMaxEvents:e,dayMaxEventRows:t}=this.context.options;return(e===!0||t===!0)&&(e=void 0,t=aae),{dayMaxEvents:e,dayMaxEventRows:t}}};function lae(s){return s.text}var mF=class{constructor(e,t,n){this.positions=e,this.dateProfile=t,this.slotDuration=n}safeComputeTop(e){let{dateProfile:t}=this;if(jr(t.currentRange,e)){let n=Sn(e),i=e.valueOf()-n.valueOf();if(i>=xr(t.slotMinTime)&&i<xr(t.slotMaxTime))return this.computeTimeTop(nn(i))}return null}computeDateTop(e,t){return t||(t=Sn(e)),this.computeTimeTop(nn(e.valueOf()-t.valueOf()))}computeTimeTop(e){let{positions:t,dateProfile:n}=this,i=t.els.length,r=(e.milliseconds-xr(n.slotMinTime))/xr(this.slotDuration),o,a;return r=Math.max(0,r),r=Math.min(i,r),o=Math.floor(r),o=Math.min(o,i-1),a=r-o,t.tops[o]+t.getHeight(o)*a}},gF=class extends sn{render(){let{props:e,context:t}=this,{options:n}=t,{slatElRefs:i}=e;return ce("tbody",null,e.slatMetas.map((r,o)=>{let a={time:r.time,date:t.dateEnv.toDate(r.date),view:t.viewApi};return ce("tr",{key:r.key,ref:i.createRef(r.key)},e.axis&&ce(uY,Object.assign({},r)),ce(ms,{elTag:"td",elClasses:["fc-timegrid-slot","fc-timegrid-slot-lane",!r.isLabeled&&"fc-timegrid-slot-minor"],elAttrs:{"data-time":r.isoTimeStr},renderProps:a,generatorName:"slotLaneContent",customGenerator:n.slotLaneContent,classNameGenerator:n.slotLaneClassNames,didMount:n.slotLaneDidMount,willUnmount:n.slotLaneWillUnmount}))}))}},_F=class extends sn{constructor(){super(...arguments),this.rootElRef=Rs(),this.slatElRefs=new tr}render(){let{props:e,context:t}=this;return ce("div",{ref:this.rootElRef,className:"fc-timegrid-slots"},ce("table",{"aria-hidden":!0,className:t.theme.getClass("table"),style:{minWidth:e.tableMinWidth,width:e.clientWidth,height:e.minHeight}},e.tableColGroupNode,ce(gF,{slatElRefs:this.slatElRefs,axis:e.axis,slatMetas:e.slatMetas})))}componentDidMount(){this.updateSizing()}componentDidUpdate(){this.updateSizing()}componentWillUnmount(){this.props.onCoords&&this.props.onCoords(null)}updateSizing(){let{context:e,props:t}=this;t.onCoords&&t.clientWidth!==null&&this.rootElRef.current.offsetHeight&&t.onCoords(new mF(new Bo(this.rootElRef.current,cae(this.slatElRefs.currentMap,t.slatMetas),!1,!0),this.props.dateProfile,e.options.slotDuration))}};function cae(s,e){return e.map(t=>s[t.key])}function Zv(s,e){let t=[],n;for(n=0;n<e;n+=1)t.push([]);if(s)for(n=0;n<s.length;n+=1)t[s[n].col].push(s[n]);return t}function aY(s,e){let t=[];if(s){for(let n=0;n<e;n+=1)t[n]={affectedInstances:s.affectedInstances,isEvent:s.isEvent,segs:[]};for(let n of s.segs)t[n.col].segs.push(n)}else for(let n=0;n<e;n+=1)t[n]=null;return t}var yF=class extends sn{render(){let{props:e}=this;return ce(_h,{elClasses:["fc-timegrid-more-link"],elStyle:{top:e.top,bottom:e.bottom},allDayDate:null,moreCnt:e.hiddenSegs.length,allSegs:e.hiddenSegs,hiddenSegs:e.hiddenSegs,extraDateSpan:e.extraDateSpan,dateProfile:e.dateProfile,todayRange:e.todayRange,popoverContent:()=>hY(e.hiddenSegs,e),defaultGenerator:dae,forceTimed:!0},t=>ce(t,{elTag:"div",elClasses:["fc-timegrid-more-link-inner","fc-sticky"]}))}};function dae(s){return s.shortText}function uae(s,e,t){let n=new uh;e!=null&&(n.strictOrder=e),t!=null&&(n.maxStackCnt=t);let i=n.addSegs(s),r=WR(i),o=hae(n);return o=gae(o,1),{segRects:_ae(o),hiddenGroups:r}}function hae(s){let{entriesByLevel:e}=s,t=EF((n,i)=>n+":"+i,(n,i)=>{let r=mae(s,n,i),o=lY(r,t),a=e[n][i];return[Object.assign(Object.assign({},a),{nextLevelNodes:o[0]}),a.thickness+o[1]]});return lY(e.length?{level:0,lateralStart:0,lateralEnd:e[0].length}:null,t)[0]}function lY(s,e){if(!s)return[[],0];let{level:t,lateralStart:n,lateralEnd:i}=s,r=n,o=[];for(;r<i;)o.push(e(t,r)),r+=1;return o.sort(pae),[o.map(fae),o[0][1]]}function pae(s,e){return e[1]-s[1]}function fae(s){return s[0]}function mae(s,e,t){let{levelCoords:n,entriesByLevel:i}=s,r=i[e][t],o=n[e]+r.thickness,a=n.length,l=e;for(;l<a&&n[l]<o;l+=1);for(;l<a;l+=1){let c=i[l],d,u=kv(c,r.span.start,Pv),h=u[0]+u[1],p=h;for(;(d=c[p])&&d.span.start<r.span.end;)p+=1;if(h<p)return{level:l,lateralStart:h,lateralEnd:p}}return null}function gae(s,e){let t=EF((n,i,r)=>xa(n),(n,i,r)=>{let{nextLevelNodes:o,thickness:a}=n,l=a+r,c=a/l,d,u=[];if(!o.length)d=e;else for(let p of o)if(d===void 0){let f=t(p,i,l);d=f[0],u.push(f[1])}else{let f=t(p,d,0);u.push(f[1])}let h=(d-i)*c;return[d-h,Object.assign(Object.assign({},n),{thickness:h,nextLevelNodes:u})]});return s.map(n=>t(n,0,0)[1])}function _ae(s){let e=[],t=EF((i,r,o)=>xa(i),(i,r,o)=>{let a=Object.assign(Object.assign({},i),{levelCoord:r,stackDepth:o,stackForward:0});return e.push(a),a.stackForward=n(i.nextLevelNodes,r+i.thickness,o+1)+1});function n(i,r,o){let a=0;for(let l of i)a=Math.max(t(l,r,o),a);return a}return n(s,0,0),e}function EF(s,e){let t={};return(...n)=>{let i=s(...n);return i in t?t[i]:t[i]=e(...n)}}function cY(s,e,t=null,n=0){let i=[];if(t)for(let r=0;r<s.length;r+=1){let o=s[r],a=t.computeDateTop(o.start,e),l=Math.max(a+(n||0),t.computeDateTop(o.end,e));i.push({start:Math.round(a),end:Math.round(l)})}return i}function yae(s,e,t,n){let i=[],r=[];for(let c=0;c<s.length;c+=1){let d=e[c];d?i.push({index:c,thickness:1,span:d}):r.push(s[c])}let{segRects:o,hiddenGroups:a}=uae(i,t,n),l=[];for(let c of o)l.push({seg:s[c.index],rect:c});for(let c of r)l.push({seg:c,rect:null});return{segPlacements:l,hiddenGroups:a}}var vae=Pn({hour:"numeric",minute:"2-digit",meridiem:!1}),Zx=class extends sn{render(){return ce(jc,Object.assign({},this.props,{elClasses:["fc-timegrid-event","fc-v-event",this.props.isShort&&"fc-timegrid-event-short"],defaultTimeFormat:vae}))}},vF=class extends sn{constructor(){super(...arguments),this.sortEventSegs=Dt(vh)}render(){let{props:e,context:t}=this,{options:n}=t,i=n.selectMirror,r=e.eventDrag&&e.eventDrag.segs||e.eventResize&&e.eventResize.segs||i&&e.dateSelectionSegs||[],o=e.eventDrag&&e.eventDrag.affectedInstances||e.eventResize&&e.eventResize.affectedInstances||{},a=this.sortEventSegs(e.fgEventSegs,n.eventOrder);return ce(qc,{elTag:"td",elRef:e.elRef,elClasses:["fc-timegrid-col",...e.extraClassNames||[]],elAttrs:Object.assign({role:"gridcell"},e.extraDataAttrs),date:e.date,dateProfile:e.dateProfile,todayRange:e.todayRange,extraRenderProps:e.extraRenderProps},l=>ce("div",{className:"fc-timegrid-col-frame"},ce("div",{className:"fc-timegrid-col-bg"},this.renderFillSegs(e.businessHourSegs,"non-business"),this.renderFillSegs(e.bgEventSegs,"bg-event"),this.renderFillSegs(e.dateSelectionSegs,"highlight")),ce("div",{className:"fc-timegrid-col-events"},this.renderFgSegs(a,o,!1,!1,!1)),ce("div",{className:"fc-timegrid-col-events"},this.renderFgSegs(r,{},!!e.eventDrag,!!e.eventResize,!!i,"mirror")),ce("div",{className:"fc-timegrid-now-indicator-container"},this.renderNowIndicator(e.nowIndicatorSegs)),cm(n)&&ce(l,{elTag:"div",elClasses:["fc-timegrid-col-misc"]})))}renderFgSegs(e,t,n,i,r,o){let{props:a}=this;return a.forPrint?hY(e,a):this.renderPositionedFgSegs(e,t,n,i,r,o)}renderPositionedFgSegs(e,t,n,i,r,o){let{eventMaxStack:a,eventShortHeight:l,eventOrderStrict:c,eventMinHeight:d}=this.context.options,{date:u,slatCoords:h,eventSelection:p,todayRange:f,nowDate:_}=this.props,b=n||i||r,y=cY(e,u,h,d),{segPlacements:w,hiddenGroups:C}=yae(e,y,c,a);return ce(gn,null,this.renderHiddenGroups(C,e),w.map(M=>{let{seg:S,rect:k}=M,T=S.eventRange.instance.instanceId,P=b||!!(!t[T]&&k),R=uF(k&&k.span),O=!b&&k?this.computeSegHStyle(k):{left:0,right:0},H=!!k&&k.stackForward>0,X=!!k&&k.span.end-k.span.start<l;return ce("div",{className:"fc-timegrid-event-harness"+(H?" fc-timegrid-event-harness-inset":""),key:o||T,style:Object.assign(Object.assign({visibility:P?"":"hidden"},R),O)},ce(Zx,Object.assign({seg:S,isDragging:n,isResizing:i,isDateSelecting:r,isSelected:T===p,isShort:X},Ar(S,f,_))))}))}renderHiddenGroups(e,t){let{extraDateSpan:n,dateProfile:i,todayRange:r,nowDate:o,eventSelection:a,eventDrag:l,eventResize:c}=this.props;return ce(gn,null,e.map(d=>{let u=uF(d.span),h=bae(d.entries,t);return ce(yF,{key:Px(Gx(h)),hiddenSegs:h,top:u.top,bottom:u.bottom,extraDateSpan:n,dateProfile:i,todayRange:r,nowDate:o,eventSelection:a,eventDrag:l,eventResize:c})}))}renderFillSegs(e,t){let{props:n,context:i}=this,o=cY(e,n.date,n.slatCoords,i.options.eventMinHeight).map((a,l)=>{let c=e[l];return ce("div",{key:Uv(c.eventRange),className:"fc-timegrid-bg-harness",style:uF(a)},t==="bg-event"?ce(gh,Object.assign({seg:c},Ar(c,n.todayRange,n.nowDate))):Yv(t))});return ce(gn,null,o)}renderNowIndicator(e){let{slatCoords:t,date:n}=this.props;return t?e.map((i,r)=>ce(Kv,{key:r,elClasses:["fc-timegrid-now-indicator-line"],elStyle:{top:t.computeDateTop(i.start,n)},isAxis:!1,date:n})):null}computeSegHStyle(e){let{isRtl:t,options:n}=this.context,i=n.slotEventOverlap,r=e.levelCoord,o=e.levelCoord+e.thickness,a,l;i&&(o=Math.min(1,r+(o-r)*2)),t?(a=1-o,l=r):(a=r,l=1-o);let c={zIndex:e.stackDepth+1,left:a*100+"%",right:l*100+"%"};return i&&!e.stackForward&&(c[t?"marginLeft":"marginRight"]=10*2),c}};function hY(s,{todayRange:e,nowDate:t,eventSelection:n,eventDrag:i,eventResize:r}){let o=(i?i.affectedInstances:null)||(r?r.affectedInstances:null)||{};return ce(gn,null,s.map(a=>{let l=a.eventRange.instance.instanceId;return ce("div",{key:l,style:{visibility:o[l]?"hidden":""}},ce(Zx,Object.assign({seg:a,isDragging:!1,isResizing:!1,isDateSelecting:!1,isSelected:l===n,isShort:!1},Ar(a,e,t))))}))}function uF(s){return s?{top:s.start,bottom:-s.end}:{top:"",bottom:""}}function bae(s,e){return s.map(t=>e[t.index])}var bF=class extends sn{constructor(){super(...arguments),this.splitFgEventSegs=Dt(Zv),this.splitBgEventSegs=Dt(Zv),this.splitBusinessHourSegs=Dt(Zv),this.splitNowIndicatorSegs=Dt(Zv),this.splitDateSelectionSegs=Dt(Zv),this.splitEventDrag=Dt(aY),this.splitEventResize=Dt(aY),this.rootElRef=Rs(),this.cellElRefs=new tr}render(){let{props:e,context:t}=this,n=t.options.nowIndicator&&e.slatCoords&&e.slatCoords.safeComputeTop(e.nowDate),i=e.cells.length,r=this.splitFgEventSegs(e.fgEventSegs,i),o=this.splitBgEventSegs(e.bgEventSegs,i),a=this.splitBusinessHourSegs(e.businessHourSegs,i),l=this.splitNowIndicatorSegs(e.nowIndicatorSegs,i),c=this.splitDateSelectionSegs(e.dateSelectionSegs,i),d=this.splitEventDrag(e.eventDrag,i),u=this.splitEventResize(e.eventResize,i);return ce("div",{className:"fc-timegrid-cols",ref:this.rootElRef},ce("table",{role:"presentation",style:{minWidth:e.tableMinWidth,width:e.clientWidth}},e.tableColGroupNode,ce("tbody",{role:"presentation"},ce("tr",{role:"row"},e.axis&&ce("td",{"aria-hidden":!0,className:"fc-timegrid-col fc-timegrid-axis"},ce("div",{className:"fc-timegrid-col-frame"},ce("div",{className:"fc-timegrid-now-indicator-container"},typeof n=="number"&&ce(Kv,{elClasses:["fc-timegrid-now-indicator-arrow"],elStyle:{top:n},isAxis:!0,date:e.nowDate})))),e.cells.map((h,p)=>ce(vF,{key:h.key,elRef:this.cellElRefs.createRef(h.key),dateProfile:e.dateProfile,date:h.date,nowDate:e.nowDate,todayRange:e.todayRange,extraRenderProps:h.extraRenderProps,extraDataAttrs:h.extraDataAttrs,extraClassNames:h.extraClassNames,extraDateSpan:h.extraDateSpan,fgEventSegs:r[p],bgEventSegs:o[p],businessHourSegs:a[p],nowIndicatorSegs:l[p],dateSelectionSegs:c[p],eventDrag:d[p],eventResize:u[p],slatCoords:e.slatCoords,eventSelection:e.eventSelection,forPrint:e.forPrint}))))))}componentDidMount(){this.updateCoords()}componentDidUpdate(){this.updateCoords()}updateCoords(){let{props:e}=this;e.onColCoords&&e.clientWidth!==null&&e.onColCoords(new Bo(this.rootElRef.current,wae(this.cellElRefs.currentMap,e.cells),!0,!1))}};function wae(s,e){return e.map(t=>s[t.key])}var wF=class extends fi{constructor(){super(...arguments),this.processSlotOptions=Dt(Mae),this.state={slatCoords:null},this.handleRootEl=e=>{e?this.context.registerInteractiveComponent(this,{el:e,isHitComboAllowed:this.props.isHitComboAllowed}):this.context.unregisterInteractiveComponent(this)},this.handleScrollRequest=e=>{let{onScrollTopRequest:t}=this.props,{slatCoords:n}=this.state;if(t&&n){if(e.time){let i=n.computeTimeTop(e.time);i=Math.ceil(i),i&&(i+=1),t(i)}return!0}return!1},this.handleColCoords=e=>{this.colCoords=e},this.handleSlatCoords=e=>{this.setState({slatCoords:e}),this.props.onSlatCoords&&this.props.onSlatCoords(e)}}render(){let{props:e,state:t}=this;return ce("div",{className:"fc-timegrid-body",ref:this.handleRootEl,style:{width:e.clientWidth,minWidth:e.tableMinWidth}},ce(_F,{axis:e.axis,dateProfile:e.dateProfile,slatMetas:e.slatMetas,clientWidth:e.clientWidth,minHeight:e.expandRows?e.clientHeight:"",tableMinWidth:e.tableMinWidth,tableColGroupNode:e.axis?e.tableColGroupNode:null,onCoords:this.handleSlatCoords}),ce(bF,{cells:e.cells,axis:e.axis,dateProfile:e.dateProfile,businessHourSegs:e.businessHourSegs,bgEventSegs:e.bgEventSegs,fgEventSegs:e.fgEventSegs,dateSelectionSegs:e.dateSelectionSegs,eventSelection:e.eventSelection,eventDrag:e.eventDrag,eventResize:e.eventResize,todayRange:e.todayRange,nowDate:e.nowDate,nowIndicatorSegs:e.nowIndicatorSegs,clientWidth:e.clientWidth,tableMinWidth:e.tableMinWidth,tableColGroupNode:e.tableColGroupNode,slatCoords:t.slatCoords,onColCoords:this.handleColCoords,forPrint:e.forPrint}))}componentDidMount(){this.scrollResponder=this.context.createScrollResponder(this.handleScrollRequest)}componentDidUpdate(e){this.scrollResponder.update(e.dateProfile!==this.props.dateProfile)}componentWillUnmount(){this.scrollResponder.detach()}queryHit(e,t){let{dateEnv:n,options:i}=this.context,{colCoords:r}=this,{dateProfile:o}=this.props,{slatCoords:a}=this.state,{snapDuration:l,snapsPerSlot:c}=this.processSlotOptions(this.props.slotDuration,i.snapDuration),d=r.leftToIndex(e),u=a.positions.topToIndex(t);if(d!=null&&u!=null){let h=this.props.cells[d],p=a.positions.tops[u],f=a.positions.getHeight(u),_=(t-p)/f,b=Math.floor(_*c),y=u*c+b,w=this.props.cells[d].date,C=Nv(o.slotMinTime,hR(l,y)),M=n.add(w,C),S=n.add(M,l);return{dateProfile:o,dateSpan:Object.assign({range:{start:M,end:S},allDay:!1},h.extraDateSpan),dayEl:r.els[d],rect:{left:r.lefts[d],right:r.rights[d],top:p,bottom:p+f},layer:0}}return null}};function Mae(s,e){let t=e||s,n=Ov(s,t);return n===null&&(t=s,n=1),{snapDuration:t,snapsPerSlot:n}}var MF=class extends mh{sliceRange(e,t){let n=[];for(let i=0;i<t.length;i+=1){let r=Sr(e,t[i]);r&&n.push({start:r.start,end:r.end,isStart:r.start.valueOf()===e.start.valueOf(),isEnd:r.end.valueOf()===e.end.valueOf(),col:i})}return n}},TF=class extends fi{constructor(){super(...arguments),this.buildDayRanges=Dt(Tae),this.slicer=new MF,this.timeColsRef=Rs()}render(){let{props:e,context:t}=this,{dateProfile:n,dayTableModel:i}=e,{nowIndicator:r,nextDayThreshold:o}=t.options,a=this.buildDayRanges(i,n,t.dateEnv);return ce(er,{unit:r?"minute":"day"},(l,c)=>ce(wF,Object.assign({ref:this.timeColsRef},this.slicer.sliceProps(e,n,null,t,a),{forPrint:e.forPrint,axis:e.axis,dateProfile:n,slatMetas:e.slatMetas,slotDuration:e.slotDuration,cells:i.cells[0],tableColGroupNode:e.tableColGroupNode,tableMinWidth:e.tableMinWidth,clientWidth:e.clientWidth,clientHeight:e.clientHeight,expandRows:e.expandRows,nowDate:l,nowIndicatorSegs:r&&this.slicer.sliceNowDate(l,n,o,t,a),todayRange:c,onScrollTopRequest:e.onScrollTopRequest,onSlatCoords:e.onSlatCoords})))}};function Tae(s,e,t){let n=[];for(let i of s.headerDates)n.push({start:t.add(i,e.slotMinTime),end:t.add(i,e.slotMaxTime)});return n}var dY=[{hours:1},{minutes:30},{minutes:15},{seconds:30},{seconds:15}];function Eae(s,e,t,n,i){let r=new Date(0),o=s,a=nn(0),l=t||xae(n),c=[];for(;xr(o)<xr(e);){let d=i.add(r,o),u=Ov(a,l)!==null;c.push({date:d,time:o,key:d.toISOString(),isoTimeStr:gR(d),isLabeled:u}),o=Nv(o,n),a=Nv(a,n)}return c}function xae(s){let e,t,n;for(e=dY.length-1;e>=0;e-=1)if(t=nn(dY[e]),n=Ov(t,s),n!==null&&n>1)return t;return s}var eS=class extends fF{constructor(){super(...arguments),this.buildTimeColsModel=Dt(Sae),this.buildSlatMetas=Dt(Eae)}render(){let{options:e,dateEnv:t,dateProfileGenerator:n}=this.context,{props:i}=this,{dateProfile:r}=i,o=this.buildTimeColsModel(r,n),a=this.allDaySplitter.splitProps(i),l=this.buildSlatMetas(r.slotMinTime,r.slotMaxTime,e.slotLabelInterval,e.slotDuration,t),{dayMinWidth:c}=e,d=!c,u=c,h=e.dayHeaders&&ce(hh,{dates:o.headerDates,dateProfile:r,datesRepDistinctDays:!0,renderIntro:d?this.renderHeadAxis:null}),p=e.allDaySlot!==!1&&(_=>ce(Jv,Object.assign({},a.allDay,{dateProfile:r,dayTableModel:o,nextDayThreshold:e.nextDayThreshold,tableMinWidth:_.tableMinWidth,colGroupNode:_.tableColGroupNode,renderRowIntro:d?this.renderTableRowAxis:null,showWeekNumbers:!1,expandRows:!1,headerAlignElRef:this.headerElRef,clientWidth:_.clientWidth,clientHeight:_.clientHeight,forPrint:i.forPrint},this.getAllDayMaxEventProps()))),f=_=>ce(TF,Object.assign({},a.timed,{dayTableModel:o,dateProfile:r,axis:d,slotDuration:e.slotDuration,slatMetas:l,forPrint:i.forPrint,tableColGroupNode:_.tableColGroupNode,tableMinWidth:_.tableMinWidth,clientWidth:_.clientWidth,clientHeight:_.clientHeight,onSlatCoords:this.handleSlatCoords,expandRows:_.expandRows,onScrollTopRequest:this.handleScrollTopRequest}));return u?this.renderHScrollLayout(h,p,f,o.colCnt,c,l,this.state.slatCoords):this.renderSimpleLayout(h,p,f)}};function Sae(s,e){let t=new ph(s.renderRange,e);return new fh(t,!1)}var Cae='.fc-v-event{background-color:var(--fc-event-bg-color);border:1px solid var(--fc-event-border-color);display:block}.fc-v-event .fc-event-main{color:var(--fc-event-text-color);height:100%}.fc-v-event .fc-event-main-frame{display:flex;flex-direction:column;height:100%}.fc-v-event .fc-event-time{flex-grow:0;flex-shrink:0;max-height:100%;overflow:hidden}.fc-v-event .fc-event-title-container{flex-grow:1;flex-shrink:1;min-height:0}.fc-v-event .fc-event-title{bottom:0;max-height:100%;overflow:hidden;top:0}.fc-v-event:not(.fc-event-start){border-top-left-radius:0;border-top-right-radius:0;border-top-width:0}.fc-v-event:not(.fc-event-end){border-bottom-left-radius:0;border-bottom-right-radius:0;border-bottom-width:0}.fc-v-event.fc-event-selected:before{left:-10px;right:-10px}.fc-v-event .fc-event-resizer-start{cursor:n-resize}.fc-v-event .fc-event-resizer-end{cursor:s-resize}.fc-v-event:not(.fc-event-selected) .fc-event-resizer{height:var(--fc-event-resizer-thickness);left:0;right:0}.fc-v-event:not(.fc-event-selected) .fc-event-resizer-start{top:calc(var(--fc-event-resizer-thickness)/-2)}.fc-v-event:not(.fc-event-selected) .fc-event-resizer-end{bottom:calc(var(--fc-event-resizer-thickness)/-2)}.fc-v-event.fc-event-selected .fc-event-resizer{left:50%;margin-left:calc(var(--fc-event-resizer-dot-total-width)/-2)}.fc-v-event.fc-event-selected .fc-event-resizer-start{top:calc(var(--fc-event-resizer-dot-total-width)/-2)}.fc-v-event.fc-event-selected .fc-event-resizer-end{bottom:calc(var(--fc-event-resizer-dot-total-width)/-2)}.fc .fc-timegrid .fc-daygrid-body{z-index:2}.fc .fc-timegrid-divider{padding:0 0 2px}.fc .fc-timegrid-body{min-height:100%;position:relative;z-index:1}.fc .fc-timegrid-axis-chunk{position:relative}.fc .fc-timegrid-axis-chunk>table,.fc .fc-timegrid-slots{position:relative;z-index:1}.fc .fc-timegrid-slot{border-bottom:0;height:1.5em}.fc .fc-timegrid-slot:empty:before{content:"\\00a0"}.fc .fc-timegrid-slot-minor{border-top-style:dotted}.fc .fc-timegrid-slot-label-cushion{display:inline-block;white-space:nowrap}.fc .fc-timegrid-slot-label{vertical-align:middle}.fc .fc-timegrid-axis-cushion,.fc .fc-timegrid-slot-label-cushion{padding:0 4px}.fc .fc-timegrid-axis-frame-liquid{height:100%}.fc .fc-timegrid-axis-frame{align-items:center;display:flex;justify-content:flex-end;overflow:hidden}.fc .fc-timegrid-axis-cushion{flex-shrink:0;max-width:60px}.fc-direction-ltr .fc-timegrid-slot-label-frame{text-align:right}.fc-direction-rtl .fc-timegrid-slot-label-frame{text-align:left}.fc-liquid-hack .fc-timegrid-axis-frame-liquid{bottom:0;height:auto;left:0;position:absolute;right:0;top:0}.fc .fc-timegrid-col.fc-day-today{background-color:var(--fc-today-bg-color)}.fc .fc-timegrid-col-frame{min-height:100%;position:relative}.fc-media-screen.fc-liquid-hack .fc-timegrid-col-frame{bottom:0;height:auto;left:0;position:absolute;right:0;top:0}.fc-media-screen .fc-timegrid-cols{bottom:0;left:0;position:absolute;right:0;top:0}.fc-media-screen .fc-timegrid-cols>table{height:100%}.fc-media-screen .fc-timegrid-col-bg,.fc-media-screen .fc-timegrid-col-events,.fc-media-screen .fc-timegrid-now-indicator-container{left:0;position:absolute;right:0;top:0}.fc .fc-timegrid-col-bg{z-index:2}.fc .fc-timegrid-col-bg .fc-non-business{z-index:1}.fc .fc-timegrid-col-bg .fc-bg-event{z-index:2}.fc .fc-timegrid-col-bg .fc-highlight{z-index:3}.fc .fc-timegrid-bg-harness{left:0;position:absolute;right:0}.fc .fc-timegrid-col-events{z-index:3}.fc .fc-timegrid-now-indicator-container{bottom:0;overflow:hidden}.fc-direction-ltr .fc-timegrid-col-events{margin:0 2.5% 0 2px}.fc-direction-rtl .fc-timegrid-col-events{margin:0 2px 0 2.5%}.fc-timegrid-event-harness{position:absolute}.fc-timegrid-event-harness>.fc-timegrid-event{bottom:0;left:0;position:absolute;right:0;top:0}.fc-timegrid-event-harness-inset .fc-timegrid-event,.fc-timegrid-event.fc-event-mirror,.fc-timegrid-more-link{box-shadow:0 0 0 1px var(--fc-page-bg-color)}.fc-timegrid-event,.fc-timegrid-more-link{border-radius:3px;font-size:var(--fc-small-font-size)}.fc-timegrid-event{margin-bottom:1px}.fc-timegrid-event .fc-event-main{padding:1px 1px 0}.fc-timegrid-event .fc-event-time{font-size:var(--fc-small-font-size);margin-bottom:1px;white-space:nowrap}.fc-timegrid-event-short .fc-event-main-frame{flex-direction:row;overflow:hidden}.fc-timegrid-event-short .fc-event-time:after{content:"\\00a0-\\00a0"}.fc-timegrid-event-short .fc-event-title{font-size:var(--fc-small-font-size)}.fc-timegrid-more-link{background:var(--fc-more-link-bg-color);color:var(--fc-more-link-text-color);cursor:pointer;margin-bottom:1px;position:absolute;z-index:9999}.fc-timegrid-more-link-inner{padding:3px 2px;top:0}.fc-direction-ltr .fc-timegrid-more-link{right:0}.fc-direction-rtl .fc-timegrid-more-link{left:0}.fc .fc-timegrid-now-indicator-arrow,.fc .fc-timegrid-now-indicator-line{pointer-events:none}.fc .fc-timegrid-now-indicator-line{border-color:var(--fc-now-indicator-color);border-style:solid;border-width:1px 0 0;left:0;position:absolute;right:0;z-index:4}.fc .fc-timegrid-now-indicator-arrow{border-color:var(--fc-now-indicator-color);border-style:solid;margin-top:-5px;position:absolute;z-index:4}.fc-direction-ltr .fc-timegrid-now-indicator-arrow{border-bottom-color:transparent;border-top-color:transparent;border-width:5px 0 5px 6px;left:0}.fc-direction-rtl .fc-timegrid-now-indicator-arrow{border-bottom-color:transparent;border-top-color:transparent;border-width:5px 6px 5px 0;right:0}';Kc(Cae);var Aae={allDaySlot:Boolean},pY=nr({name:"@fullcalendar/timegrid",initialView:"timeGridWeek",optionRefiners:Aae,views:{timeGrid:{component:eS,usesMinMaxTime:!0,allDaySlot:!0,slotDuration:"00:30:00",slotEventOverlap:!0},timeGridDay:{type:"timeGrid",duration:{days:1}},timeGridWeek:{type:"timeGrid",duration:{weeks:1}}}});var xF=class extends sn{constructor(){super(...arguments),this.state={textId:Kr()}}render(){let{theme:e,dateEnv:t,options:n,viewApi:i}=this.context,{cellId:r,dayDate:o,todayRange:a}=this.props,{textId:l}=this.state,c=Gv(o,a),d=n.listDayFormat?t.format(o,n.listDayFormat):"",u=n.listDaySideFormat?t.format(o,n.listDaySideFormat):"",h=Object.assign({date:t.toDate(o),view:i,textId:l,text:d,sideText:u,navLinkAttrs:Pa(this.context,o),sideNavLinkAttrs:Pa(this.context,o,"day",!1)},c);return ce(ms,{elTag:"tr",elClasses:["fc-list-day",...am(c,e)],elAttrs:{"data-date":Yc(o)},renderProps:h,generatorName:"dayHeaderContent",customGenerator:n.dayHeaderContent,defaultGenerator:Pae,classNameGenerator:n.dayHeaderClassNames,didMount:n.dayHeaderDidMount,willUnmount:n.dayHeaderWillUnmount},p=>ce("th",{scope:"colgroup",colSpan:3,id:r,"aria-labelledby":l},ce(p,{elTag:"div",elClasses:["fc-list-day-cushion",e.getClass("tableCellShaded")]})))}};function Pae(s){return ce(gn,null,s.text&&ce("a",Object.assign({id:s.textId,className:"fc-list-day-text"},s.navLinkAttrs),s.text),s.sideText&&ce("a",Object.assign({"aria-hidden":!0,className:"fc-list-day-side-text"},s.sideNavLinkAttrs),s.sideText))}var kae=Pn({hour:"numeric",minute:"2-digit",meridiem:"short"}),SF=class extends sn{render(){let{props:e,context:t}=this,{options:n}=t,{seg:i,timeHeaderId:r,eventHeaderId:o,dateHeaderId:a}=e,l=n.eventTimeFormat||kae;return ce(Pl,Object.assign({},e,{elTag:"tr",elClasses:["fc-list-event",i.eventRange.def.url&&"fc-event-forced-url"],defaultGenerator:()=>Iae(i,t),seg:i,timeText:"",disableDragging:!0,disableResizing:!0}),(c,d)=>ce(gn,null,Dae(i,l,t,r,a),ce("td",{"aria-hidden":!0,className:"fc-list-event-graphic"},ce("span",{className:"fc-list-event-dot",style:{borderColor:d.borderColor||d.backgroundColor}})),ce(c,{elTag:"td",elClasses:["fc-list-event-title"],elAttrs:{headers:`${o} ${a}`}})))}};function Iae(s,e){let t=rm(s,e);return ce("a",Object.assign({},t),s.eventRange.def.title)}function Dae(s,e,t,n,i){let{options:r}=t;if(r.displayEventTime!==!1){let o=s.eventRange.def,a=s.eventRange.instance,l=!1,c;if(o.allDay?l=!0:xR(s.eventRange.range)?s.isStart?c=Jc(s,e,t,null,null,a.range.start,s.end):s.isEnd?c=Jc(s,e,t,null,null,s.start,a.range.end):l=!0:c=Jc(s,e,t),l){let d={text:t.options.allDayText,view:t.viewApi};return ce(ms,{elTag:"td",elClasses:["fc-list-event-time"],elAttrs:{headers:`${n} ${i}`},renderProps:d,generatorName:"allDayContent",customGenerator:r.allDayContent,defaultGenerator:Rae,classNameGenerator:r.allDayClassNames,didMount:r.allDayDidMount,willUnmount:r.allDayWillUnmount})}return ce("td",{className:"fc-list-event-time"},c)}return null}function Rae(s){return s.text}var tS=class extends fi{constructor(){super(...arguments),this.computeDateVars=Dt(Lae),this.eventStoreToSegs=Dt(this._eventStoreToSegs),this.state={timeHeaderId:Kr(),eventHeaderId:Kr(),dateHeaderIdRoot:Kr()},this.setRootEl=e=>{e?this.context.registerInteractiveComponent(this,{el:e}):this.context.unregisterInteractiveComponent(this)}}render(){let{props:e,context:t}=this,{dayDates:n,dayRanges:i}=this.computeDateVars(e.dateProfile),r=this.eventStoreToSegs(e.eventStore,e.eventUiBases,i);return ce(Oo,{elRef:this.setRootEl,elClasses:["fc-list",t.theme.getClass("table"),t.options.stickyHeaderDates!==!1?"fc-list-sticky":""],viewSpec:t.viewSpec},ce(em,{liquid:!e.isHeightAuto,overflowX:e.isHeightAuto?"visible":"hidden",overflowY:e.isHeightAuto?"visible":"auto"},r.length>0?this.renderSegList(r,n):this.renderEmptyMessage()))}renderEmptyMessage(){let{options:e,viewApi:t}=this.context,n={text:e.noEventsText,view:t};return ce(ms,{elTag:"div",elClasses:["fc-list-empty"],renderProps:n,generatorName:"noEventsContent",customGenerator:e.noEventsContent,defaultGenerator:Fae,classNameGenerator:e.noEventsClassNames,didMount:e.noEventsDidMount,willUnmount:e.noEventsWillUnmount},i=>ce(i,{elTag:"div",elClasses:["fc-list-empty-cushion"]}))}renderSegList(e,t){let{theme:n,options:i}=this.context,{timeHeaderId:r,eventHeaderId:o,dateHeaderIdRoot:a}=this.state,l=Nae(e);return ce(er,{unit:"day"},(c,d)=>{let u=[];for(let h=0;h<l.length;h+=1){let p=l[h];if(p){let f=Yc(t[h]),_=a+"-"+f;u.push(ce(xF,{key:f,cellId:_,dayDate:t[h],todayRange:d})),p=vh(p,i.eventOrder);for(let b of p)u.push(ce(SF,Object.assign({key:f+":"+b.eventRange.instance.instanceId,seg:b,isDragging:!1,isResizing:!1,isDateSelecting:!1,isSelected:!1,timeHeaderId:r,eventHeaderId:o,dateHeaderId:_},Ar(b,d,c))))}}return ce("table",{className:"fc-list-table "+n.getClass("table")},ce("thead",null,ce("tr",null,ce("th",{scope:"col",id:r},i.timeHint),ce("th",{scope:"col","aria-hidden":!0}),ce("th",{scope:"col",id:o},i.eventHint))),ce("tbody",null,u))})}_eventStoreToSegs(e,t,n){return this.eventRangesToSegs(Zf(e,t,this.props.dateProfile.activeRange,this.context.options.nextDayThreshold).fg,n)}eventRangesToSegs(e,t){let n=[];for(let i of e)n.push(...this.eventRangeToSegs(i,t));return n}eventRangeToSegs(e,t){let{dateEnv:n}=this.context,{nextDayThreshold:i}=this.context.options,r=e.range,o=e.def.allDay,a,l,c,d=[];for(a=0;a<t.length;a+=1)if(l=Sr(r,t[a]),l&&(c={component:this,eventRange:e,start:l.start,end:l.end,isStart:e.isStart&&l.start.valueOf()===r.start.valueOf(),isEnd:e.isEnd&&l.end.valueOf()===r.end.valueOf(),dayIndex:a},d.push(c),!c.isEnd&&!o&&a+1<t.length&&r.end<n.add(t[a+1].start,i))){c.end=r.end,c.isEnd=!0;break}return d}};function Fae(s){return s.text}function Lae(s){let e=Sn(s.renderRange.start),t=s.renderRange.end,n=[],i=[];for(;e<t;)n.push(e),i.push({start:e,end:ts(e,1)}),e=ts(e,1);return{dayDates:n,dayRanges:i}}function Nae(s){let e=[],t,n;for(t=0;t<s.length;t+=1)n=s[t],(e[n.dayIndex]||(e[n.dayIndex]=[])).push(n);return e}var Oae=':root{--fc-list-event-dot-width:10px;--fc-list-event-hover-bg-color:#f5f5f5}.fc-theme-standard .fc-list{border:1px solid var(--fc-border-color)}.fc .fc-list-empty{align-items:center;background-color:var(--fc-neutral-bg-color);display:flex;height:100%;justify-content:center}.fc .fc-list-empty-cushion{margin:5em 0}.fc .fc-list-table{border-style:hidden;width:100%}.fc .fc-list-table tr>*{border-left:0;border-right:0}.fc .fc-list-sticky .fc-list-day>*{background:var(--fc-page-bg-color);position:sticky;top:0}.fc .fc-list-table thead{left:-10000px;position:absolute}.fc .fc-list-table tbody>tr:first-child th{border-top:0}.fc .fc-list-table th{padding:0}.fc .fc-list-day-cushion,.fc .fc-list-table td{padding:8px 14px}.fc .fc-list-day-cushion:after{clear:both;content:"";display:table}.fc-theme-standard .fc-list-day-cushion{background-color:var(--fc-neutral-bg-color)}.fc-direction-ltr .fc-list-day-text,.fc-direction-rtl .fc-list-day-side-text{float:left}.fc-direction-ltr .fc-list-day-side-text,.fc-direction-rtl .fc-list-day-text{float:right}.fc-direction-ltr .fc-list-table .fc-list-event-graphic{padding-right:0}.fc-direction-rtl .fc-list-table .fc-list-event-graphic{padding-left:0}.fc .fc-list-event.fc-event-forced-url{cursor:pointer}.fc .fc-list-event:hover td{background-color:var(--fc-list-event-hover-bg-color)}.fc .fc-list-event-graphic,.fc .fc-list-event-time{white-space:nowrap;width:1px}.fc .fc-list-event-dot{border:calc(var(--fc-list-event-dot-width)/2) solid var(--fc-event-border-color);border-radius:calc(var(--fc-list-event-dot-width)/2);box-sizing:content-box;display:inline-block;height:0;width:0}.fc .fc-list-event-title a{color:inherit;text-decoration:none}.fc .fc-list-event.fc-event-forced-url:hover a{text-decoration:underline}';Kc(Oae);var $ae={listDayFormat:fY,listDaySideFormat:fY,noEventsClassNames:Ae,noEventsContent:Ae,noEventsDidMount:Ae,noEventsWillUnmount:Ae};function fY(s){return s===!1?null:Pn(s)}var mY=nr({name:"@fullcalendar/list",optionRefiners:$ae,views:{list:{component:tS,buttonTextKey:"list",listDayFormat:{month:"long",day:"numeric",year:"numeric"}},listDay:{type:"list",duration:{days:1},listDayFormat:{weekday:"long"}},listWeek:{type:"list",duration:{weeks:1},listDayFormat:{weekday:"long"},listDaySideFormat:{month:"long",day:"numeric",year:"numeric"}},listMonth:{type:"list",duration:{month:1},listDaySideFormat:{weekday:"long"}},listYear:{type:"list",duration:{year:1},listDaySideFormat:{weekday:"long"}}}});jv.touchMouseIgnoreWait=500;var CF=0,nS=0,AF=!1,sS=class{constructor(e){this.subjectEl=null,this.selector="",this.handleSelector="",this.shouldIgnoreMove=!1,this.shouldWatchScroll=!0,this.isDragging=!1,this.isTouchDragging=!1,this.wasTouchScroll=!1,this.handleMouseDown=t=>{if(!this.shouldIgnoreMouse()&&Bae(t)&&this.tryStart(t)){let n=this.createEventFromMouse(t,!0);this.emitter.trigger("pointerdown",n),this.initScrollWatch(n),this.shouldIgnoreMove||document.addEventListener("mousemove",this.handleMouseMove),document.addEventListener("mouseup",this.handleMouseUp)}},this.handleMouseMove=t=>{let n=this.createEventFromMouse(t);this.recordCoords(n),this.emitter.trigger("pointermove",n)},this.handleMouseUp=t=>{document.removeEventListener("mousemove",this.handleMouseMove),document.removeEventListener("mouseup",this.handleMouseUp),this.emitter.trigger("pointerup",this.createEventFromMouse(t)),this.cleanup()},this.handleTouchStart=t=>{if(this.tryStart(t)){this.isTouchDragging=!0;let n=this.createEventFromTouch(t,!0);this.emitter.trigger("pointerdown",n),this.initScrollWatch(n);let i=t.target;this.shouldIgnoreMove||i.addEventListener("touchmove",this.handleTouchMove),i.addEventListener("touchend",this.handleTouchEnd),i.addEventListener("touchcancel",this.handleTouchEnd),window.addEventListener("scroll",this.handleTouchScroll,!0)}},this.handleTouchMove=t=>{let n=this.createEventFromTouch(t);this.recordCoords(n),this.emitter.trigger("pointermove",n)},this.handleTouchEnd=t=>{if(this.isDragging){let n=t.target;n.removeEventListener("touchmove",this.handleTouchMove),n.removeEventListener("touchend",this.handleTouchEnd),n.removeEventListener("touchcancel",this.handleTouchEnd),window.removeEventListener("scroll",this.handleTouchScroll,!0),this.emitter.trigger("pointerup",this.createEventFromTouch(t)),this.cleanup(),this.isTouchDragging=!1,zae()}},this.handleTouchScroll=()=>{this.wasTouchScroll=!0},this.handleScroll=t=>{if(!this.shouldIgnoreMove){let n=window.scrollX-this.prevScrollX+this.prevPageX,i=window.scrollY-this.prevScrollY+this.prevPageY;this.emitter.trigger("pointermove",{origEvent:t,isTouch:this.isTouchDragging,subjectEl:this.subjectEl,pageX:n,pageY:i,deltaX:n-this.origPageX,deltaY:i-this.origPageY})}},this.containerEl=e,this.emitter=new Al,e.addEventListener("mousedown",this.handleMouseDown),e.addEventListener("touchstart",this.handleTouchStart,{passive:!0}),Uae()}destroy(){this.containerEl.removeEventListener("mousedown",this.handleMouseDown),this.containerEl.removeEventListener("touchstart",this.handleTouchStart,{passive:!0}),Vae()}tryStart(e){let t=this.querySubjectEl(e),n=e.target;return t&&(!this.handleSelector||Gs(n,this.handleSelector))?(this.subjectEl=t,this.isDragging=!0,this.wasTouchScroll=!1,!0):!1}cleanup(){AF=!1,this.isDragging=!1,this.subjectEl=null,this.destroyScrollWatch()}querySubjectEl(e){return this.selector?Gs(e.target,this.selector):this.containerEl}shouldIgnoreMouse(){return CF||this.isTouchDragging}cancelTouchScroll(){this.isDragging&&(AF=!0)}initScrollWatch(e){this.shouldWatchScroll&&(this.recordCoords(e),window.addEventListener("scroll",this.handleScroll,!0))}recordCoords(e){this.shouldWatchScroll&&(this.prevPageX=e.pageX,this.prevPageY=e.pageY,this.prevScrollX=window.scrollX,this.prevScrollY=window.scrollY)}destroyScrollWatch(){this.shouldWatchScroll&&window.removeEventListener("scroll",this.handleScroll,!0)}createEventFromMouse(e,t){let n=0,i=0;return t?(this.origPageX=e.pageX,this.origPageY=e.pageY):(n=e.pageX-this.origPageX,i=e.pageY-this.origPageY),{origEvent:e,isTouch:!1,subjectEl:this.subjectEl,pageX:e.pageX,pageY:e.pageY,deltaX:n,deltaY:i}}createEventFromTouch(e,t){let n=e.touches,i,r,o=0,a=0;return n&&n.length?(i=n[0].pageX,r=n[0].pageY):(i=e.pageX,r=e.pageY),t?(this.origPageX=i,this.origPageY=r):(o=i-this.origPageX,a=r-this.origPageY),{origEvent:e,isTouch:!0,subjectEl:this.subjectEl,pageX:i,pageY:r,deltaX:o,deltaY:a}}};function Bae(s){return s.button===0&&!s.ctrlKey}function zae(){CF+=1,setTimeout(()=>{CF-=1},jv.touchMouseIgnoreWait)}function Uae(){nS+=1,nS===1&&window.addEventListener("touchmove",_Y,{passive:!1})}function Vae(){nS-=1,nS||window.removeEventListener("touchmove",_Y,{passive:!1})}function _Y(s){AF&&s.preventDefault()}var PF=class{constructor(){this.isVisible=!1,this.sourceEl=null,this.mirrorEl=null,this.sourceElRect=null,this.parentNode=document.body,this.zIndex=9999,this.revertDuration=0}start(e,t,n){this.sourceEl=e,this.sourceElRect=this.sourceEl.getBoundingClientRect(),this.origScreenX=t-window.scrollX,this.origScreenY=n-window.scrollY,this.deltaX=0,this.deltaY=0,this.updateElPosition()}handleMove(e,t){this.deltaX=e-window.scrollX-this.origScreenX,this.deltaY=t-window.scrollY-this.origScreenY,this.updateElPosition()}setIsVisible(e){e?this.isVisible||(this.mirrorEl&&(this.mirrorEl.style.display=""),this.isVisible=e,this.updateElPosition()):this.isVisible&&(this.mirrorEl&&(this.mirrorEl.style.display="none"),this.isVisible=e)}stop(e,t){let n=()=>{this.cleanup(),t()};e&&this.mirrorEl&&this.isVisible&&this.revertDuration&&(this.deltaX||this.deltaY)?this.doRevertAnimation(n,this.revertDuration):setTimeout(n,0)}doRevertAnimation(e,t){let n=this.mirrorEl,i=this.sourceEl.getBoundingClientRect();n.style.transition="top "+t+"ms,left "+t+"ms",yh(n,{left:i.left,top:i.top}),oR(n,()=>{n.style.transition="",e()})}cleanup(){this.mirrorEl&&(Dv(this.mirrorEl),this.mirrorEl=null),this.sourceEl=null}updateElPosition(){this.sourceEl&&this.isVisible&&yh(this.getMirrorEl(),{left:this.sourceElRect.left+this.deltaX,top:this.sourceElRect.top+this.deltaY})}getMirrorEl(){let e=this.sourceElRect,t=this.mirrorEl;return t||(t=this.mirrorEl=this.sourceEl.cloneNode(!0),t.style.userSelect="none",t.style.webkitUserSelect="none",t.style.pointerEvents="none",t.classList.add("fc-event-dragging"),yh(t,{position:"fixed",zIndex:this.zIndex,visibility:"",boxSizing:"border-box",width:e.right-e.left,height:e.bottom-e.top,right:"auto",bottom:"auto",margin:0}),this.parentNode.appendChild(t)),t}},iS=class extends dh{constructor(e,t){super(),this.handleScroll=()=>{this.scrollTop=this.scrollController.getScrollTop(),this.scrollLeft=this.scrollController.getScrollLeft(),this.handleScrollChange()},this.scrollController=e,this.doesListening=t,this.scrollTop=this.origScrollTop=e.getScrollTop(),this.scrollLeft=this.origScrollLeft=e.getScrollLeft(),this.scrollWidth=e.getScrollWidth(),this.scrollHeight=e.getScrollHeight(),this.clientWidth=e.getClientWidth(),this.clientHeight=e.getClientHeight(),this.clientRect=this.computeClientRect(),this.doesListening&&this.getEventTarget().addEventListener("scroll",this.handleScroll)}destroy(){this.doesListening&&this.getEventTarget().removeEventListener("scroll",this.handleScroll)}getScrollTop(){return this.scrollTop}getScrollLeft(){return this.scrollLeft}setScrollTop(e){this.scrollController.setScrollTop(e),this.doesListening||(this.scrollTop=Math.max(Math.min(e,this.getMaxScrollTop()),0),this.handleScrollChange())}setScrollLeft(e){this.scrollController.setScrollLeft(e),this.doesListening||(this.scrollLeft=Math.max(Math.min(e,this.getMaxScrollLeft()),0),this.handleScrollChange())}getClientWidth(){return this.clientWidth}getClientHeight(){return this.clientHeight}getScrollWidth(){return this.scrollWidth}getScrollHeight(){return this.scrollHeight}handleScrollChange(){}},rS=class extends iS{constructor(e,t){super(new Cv(e),t)}getEventTarget(){return this.scrollController.el}computeClientRect(){return GR(this.scrollController.el)}},kF=class extends iS{constructor(e){super(new Av,e)}getEventTarget(){return window}computeClientRect(){return{left:this.scrollLeft,right:this.scrollLeft+this.clientWidth,top:this.scrollTop,bottom:this.scrollTop+this.clientHeight}}handleScrollChange(){this.clientRect=this.computeClientRect()}},gY=typeof performance=="function"?performance.now:Date.now,IF=class{constructor(){this.isEnabled=!0,this.scrollQuery=[window,".fc-scroller"],this.edgeThreshold=50,this.maxVelocity=300,this.pointerScreenX=null,this.pointerScreenY=null,this.isAnimating=!1,this.scrollCaches=null,this.everMovedUp=!1,this.everMovedDown=!1,this.everMovedLeft=!1,this.everMovedRight=!1,this.animate=()=>{if(this.isAnimating){let e=this.computeBestEdge(this.pointerScreenX+window.scrollX,this.pointerScreenY+window.scrollY);if(e){let t=gY();this.handleSide(e,(t-this.msSinceRequest)/1e3),this.requestAnimation(t)}else this.isAnimating=!1}}}start(e,t,n){this.isEnabled&&(this.scrollCaches=this.buildCaches(n),this.pointerScreenX=null,this.pointerScreenY=null,this.everMovedUp=!1,this.everMovedDown=!1,this.everMovedLeft=!1,this.everMovedRight=!1,this.handleMove(e,t))}handleMove(e,t){if(this.isEnabled){let n=e-window.scrollX,i=t-window.scrollY,r=this.pointerScreenY===null?0:i-this.pointerScreenY,o=this.pointerScreenX===null?0:n-this.pointerScreenX;r<0?this.everMovedUp=!0:r>0&&(this.everMovedDown=!0),o<0?this.everMovedLeft=!0:o>0&&(this.everMovedRight=!0),this.pointerScreenX=n,this.pointerScreenY=i,this.isAnimating||(this.isAnimating=!0,this.requestAnimation(gY()))}}stop(){if(this.isEnabled){this.isAnimating=!1;for(let e of this.scrollCaches)e.destroy();this.scrollCaches=null}}requestAnimation(e){this.msSinceRequest=e,requestAnimationFrame(this.animate)}handleSide(e,t){let{scrollCache:n}=e,{edgeThreshold:i}=this,r=i-e.distance,o=r*r/(i*i)*this.maxVelocity*t,a=1;switch(e.name){case"left":a=-1;case"right":n.setScrollLeft(n.getScrollLeft()+o*a);break;case"top":a=-1;case"bottom":n.setScrollTop(n.getScrollTop()+o*a);break}}computeBestEdge(e,t){let{edgeThreshold:n}=this,i=null,r=this.scrollCaches||[];for(let o of r){let a=o.clientRect,l=e-a.left,c=a.right-e,d=t-a.top,u=a.bottom-t;l>=0&&c>=0&&d>=0&&u>=0&&(d<=n&&this.everMovedUp&&o.canScrollUp()&&(!i||i.distance>d)&&(i={scrollCache:o,name:"top",distance:d}),u<=n&&this.everMovedDown&&o.canScrollDown()&&(!i||i.distance>u)&&(i={scrollCache:o,name:"bottom",distance:u}),l<=n&&this.everMovedLeft&&o.canScrollLeft()&&(!i||i.distance>l)&&(i={scrollCache:o,name:"left",distance:l}),c<=n&&this.everMovedRight&&o.canScrollRight()&&(!i||i.distance>c)&&(i={scrollCache:o,name:"right",distance:c}))}return i}buildCaches(e){return this.queryScrollEls(e).map(t=>t===window?new kF(!1):new rS(t,!1))}queryScrollEls(e){let t=[];for(let n of this.scrollQuery)typeof n=="object"?t.push(n):t.push(...Array.prototype.slice.call(e.getRootNode().querySelectorAll(n)));return t}},wh=class extends Iv{constructor(e,t){super(e),this.containerEl=e,this.delay=null,this.minDistance=0,this.touchScrollAllowed=!0,this.mirrorNeedsRevert=!1,this.isInteracting=!1,this.isDragging=!1,this.isDelayEnded=!1,this.isDistanceSurpassed=!1,this.delayTimeoutId=null,this.onPointerDown=i=>{this.isDragging||(this.isInteracting=!0,this.isDelayEnded=!1,this.isDistanceSurpassed=!1,aR(document.body),cR(document.body),i.isTouch||i.origEvent.preventDefault(),this.emitter.trigger("pointerdown",i),this.isInteracting&&!this.pointer.shouldIgnoreMove&&(this.mirror.setIsVisible(!1),this.mirror.start(i.subjectEl,i.pageX,i.pageY),this.startDelay(i),this.minDistance||this.handleDistanceSurpassed(i)))},this.onPointerMove=i=>{if(this.isInteracting){if(this.emitter.trigger("pointermove",i),!this.isDistanceSurpassed){let r=this.minDistance,o,{deltaX:a,deltaY:l}=i;o=a*a+l*l,o>=r*r&&this.handleDistanceSurpassed(i)}this.isDragging&&(i.origEvent.type!=="scroll"&&(this.mirror.handleMove(i.pageX,i.pageY),this.autoScroller.handleMove(i.pageX,i.pageY)),this.emitter.trigger("dragmove",i))}},this.onPointerUp=i=>{this.isInteracting&&(this.isInteracting=!1,lR(document.body),dR(document.body),this.emitter.trigger("pointerup",i),this.isDragging&&(this.autoScroller.stop(),this.tryStopDrag(i)),this.delayTimeoutId&&(clearTimeout(this.delayTimeoutId),this.delayTimeoutId=null))};let n=this.pointer=new sS(e);n.emitter.on("pointerdown",this.onPointerDown),n.emitter.on("pointermove",this.onPointerMove),n.emitter.on("pointerup",this.onPointerUp),t&&(n.selector=t),this.mirror=new PF,this.autoScroller=new IF}destroy(){this.pointer.destroy(),this.onPointerUp({})}startDelay(e){typeof this.delay=="number"?this.delayTimeoutId=setTimeout(()=>{this.delayTimeoutId=null,this.handleDelayEnd(e)},this.delay):this.handleDelayEnd(e)}handleDelayEnd(e){this.isDelayEnded=!0,this.tryStartDrag(e)}handleDistanceSurpassed(e){this.isDistanceSurpassed=!0,this.tryStartDrag(e)}tryStartDrag(e){this.isDelayEnded&&this.isDistanceSurpassed&&(!this.pointer.wasTouchScroll||this.touchScrollAllowed)&&(this.isDragging=!0,this.mirrorNeedsRevert=!1,this.autoScroller.start(e.pageX,e.pageY,this.containerEl),this.emitter.trigger("dragstart",e),this.touchScrollAllowed===!1&&this.pointer.cancelTouchScroll())}tryStopDrag(e){this.mirror.stop(this.mirrorNeedsRevert,this.stopDrag.bind(this,e))}stopDrag(e){this.isDragging=!1,this.emitter.trigger("dragend",e)}setIgnoreMove(e){this.pointer.shouldIgnoreMove=e}setMirrorIsVisible(e){this.mirror.setIsVisible(e)}setMirrorNeedsRevert(e){this.mirrorNeedsRevert=e}setAutoScrollEnabled(e){this.autoScroller.isEnabled=e}},DF=class{constructor(e){this.el=e,this.origRect=Wv(e),this.scrollCaches=Ux(e).map(t=>new rS(t,!0))}destroy(){for(let e of this.scrollCaches)e.destroy()}computeLeft(){let e=this.origRect.left;for(let t of this.scrollCaches)e+=t.origScrollLeft-t.getScrollLeft();return e}computeTop(){let e=this.origRect.top;for(let t of this.scrollCaches)e+=t.origScrollTop-t.getScrollTop();return e}isWithinClipping(e,t){let n={left:e,top:t};for(let i of this.scrollCaches)if(!Gae(i.getEventTarget())&&!BR(n,i.clientRect))return!1;return!0}};function Gae(s){let e=s.tagName;return e==="HTML"||e==="BODY"}var um=class{constructor(e,t){this.useSubjectCenter=!1,this.requireInitial=!0,this.disablePointCheck=!1,this.initialHit=null,this.movingHit=null,this.finalHit=null,this.handlePointerDown=n=>{let{dragging:i}=this;this.initialHit=null,this.movingHit=null,this.finalHit=null,this.prepareHits(),this.processFirstCoord(n),this.initialHit||!this.requireInitial?(i.setIgnoreMove(!1),this.emitter.trigger("pointerdown",n)):i.setIgnoreMove(!0)},this.handleDragStart=n=>{this.emitter.trigger("dragstart",n),this.handleMove(n,!0)},this.handleDragMove=n=>{this.emitter.trigger("dragmove",n),this.handleMove(n)},this.handlePointerUp=n=>{this.releaseHits(),this.emitter.trigger("pointerup",n)},this.handleDragEnd=n=>{this.movingHit&&this.emitter.trigger("hitupdate",null,!0,n),this.finalHit=this.movingHit,this.movingHit=null,this.emitter.trigger("dragend",n)},this.droppableStore=t,e.emitter.on("pointerdown",this.handlePointerDown),e.emitter.on("dragstart",this.handleDragStart),e.emitter.on("dragmove",this.handleDragMove),e.emitter.on("pointerup",this.handlePointerUp),e.emitter.on("dragend",this.handleDragEnd),this.dragging=e,this.emitter=new Al}processFirstCoord(e){let t={left:e.pageX,top:e.pageY},n=t,i=e.subjectEl,r;i instanceof HTMLElement&&(r=Wv(i),n=zR(n,r));let o=this.initialHit=this.queryHitForOffset(n.left,n.top);if(o){if(this.useSubjectCenter&&r){let a=zx(r,o.rect);a&&(n=UR(a))}this.coordAdjust=VR(n,t)}else this.coordAdjust={left:0,top:0}}handleMove(e,t){let n=this.queryHitForOffset(e.pageX+this.coordAdjust.left,e.pageY+this.coordAdjust.top);(t||!oS(this.movingHit,n))&&(this.movingHit=n,this.emitter.trigger("hitupdate",n,!1,e))}prepareHits(){this.offsetTrackers=qr(this.droppableStore,e=>(e.component.prepareHits(),new DF(e.el)))}releaseHits(){let{offsetTrackers:e}=this;for(let t in e)e[t].destroy();this.offsetTrackers={}}queryHitForOffset(e,t){let{droppableStore:n,offsetTrackers:i}=this,r=null;for(let o in n){let a=n[o].component,l=i[o];if(l&&l.isWithinClipping(e,t)){let c=l.computeLeft(),d=l.computeTop(),u=e-c,h=t-d,{origRect:p}=l,f=p.right-p.left,_=p.bottom-p.top;if(u>=0&&u<f&&h>=0&&h<_){let b=a.queryHit(u,h,f,_);b&&sm(b.dateProfile.activeRange,b.dateSpan.range)&&(this.disablePointCheck||l.el.contains(l.el.getRootNode().elementFromPoint(u+c-window.scrollX,h+d-window.scrollY)))&&(!r||b.layer>r.layer)&&(b.componentId=o,b.context=a.context,b.rect.left+=c,b.rect.right+=c,b.rect.top+=d,b.rect.bottom+=d,r=b)}}}return r}};function oS(s,e){return!s&&!e?!0:!!s!=!!e?!1:FR(s.dateSpan,e.dateSpan)}function yY(s,e){let t={};for(let n of e.pluginHooks.datePointTransforms)Object.assign(t,n(s,e));return Object.assign(t,Wae(s,e.dateEnv)),t}function Wae(s,e){return{date:e.toDate(s.range.start),dateStr:e.formatIso(s.range.start,{omitTime:s.allDay}),allDay:s.allDay}}var RF=class extends $o{constructor(e){super(e),this.handlePointerDown=n=>{let{dragging:i}=this,r=n.origEvent.target;i.setIgnoreMove(!this.component.isValidDateDownEl(r))},this.handleDragEnd=n=>{let{component:i}=this,{pointer:r}=this.dragging;if(!r.wasTouchScroll){let{initialHit:o,finalHit:a}=this.hitDragging;if(o&&a&&oS(o,a)){let{context:l}=i,c=Object.assign(Object.assign({},yY(o.dateSpan,l)),{dayEl:o.dayEl,jsEvent:n.origEvent,view:l.viewApi||l.calendarApi.view});l.emitter.trigger("dateClick",c)}}},this.dragging=new wh(e.el),this.dragging.autoScroller.isEnabled=!1;let t=this.hitDragging=new um(this.dragging,Vv(e));t.emitter.on("pointerdown",this.handlePointerDown),t.emitter.on("dragend",this.handleDragEnd)}destroy(){this.dragging.destroy()}},FF=class extends $o{constructor(e){super(e),this.dragSelection=null,this.handlePointerDown=o=>{let{component:a,dragging:l}=this,{options:c}=a.context,d=c.selectable&&a.isValidDateDownEl(o.origEvent.target);l.setIgnoreMove(!d),l.delay=o.isTouch?Hae(a):null},this.handleDragStart=o=>{this.component.context.calendarApi.unselect(o)},this.handleHitUpdate=(o,a)=>{let{context:l}=this.component,c=null,d=!1;if(o){let u=this.hitDragging.initialHit;o.componentId===u.componentId&&this.isHitComboAllowed&&!this.isHitComboAllowed(u,o)||(c=jae(u,o,l.pluginHooks.dateSelectionTransformers)),(!c||!HR(c,o.dateProfile,l))&&(d=!0,c=null)}c?l.dispatch({type:"SELECT_DATES",selection:c}):a||l.dispatch({type:"UNSELECT_DATES"}),d?Fv():Lv(),a||(this.dragSelection=c)},this.handlePointerUp=o=>{this.dragSelection&&(Bx(this.dragSelection,o,this.component.context),this.dragSelection=null)};let{component:t}=e,{options:n}=t.context,i=this.dragging=new wh(e.el);i.touchScrollAllowed=!1,i.minDistance=n.selectMinDistance||0,i.autoScroller.isEnabled=n.dragScroll;let r=this.hitDragging=new um(this.dragging,Vv(e));r.emitter.on("pointerdown",this.handlePointerDown),r.emitter.on("dragstart",this.handleDragStart),r.emitter.on("hitupdate",this.handleHitUpdate),r.emitter.on("pointerup",this.handlePointerUp)}destroy(){this.dragging.destroy()}};function Hae(s){let{options:e}=s.context,t=e.selectLongPressDelay;return t==null&&(t=e.longPressDelay),t}function jae(s,e,t){let n=s.dateSpan,i=e.dateSpan,r=[n.range.start,n.range.end,i.range.start,i.range.end];r.sort(uR);let o={};for(let a of t){let l=a(s,e);if(l===!1)return null;l&&Object.assign(o,l)}return o.range={start:r[0],end:r[3]},o.allDay=n.allDay,o}var eb=class s extends $o{constructor(e){super(e),this.subjectEl=null,this.subjectSeg=null,this.isDragging=!1,this.eventRange=null,this.relevantEvents=null,this.receivingContext=null,this.validMutation=null,this.mutatedRelevantEvents=null,this.handlePointerDown=o=>{let a=o.origEvent.target,{component:l,dragging:c}=this,{mirror:d}=c,{options:u}=l.context,h=l.context;this.subjectEl=o.subjectEl;let p=this.subjectSeg=Il(o.subjectEl),_=(this.eventRange=p.eventRange).instance.instanceId;this.relevantEvents=Bv(h.getCurrentData().eventStore,_),c.minDistance=o.isTouch?0:u.eventDragMinDistance,c.delay=o.isTouch&&_!==l.props.eventSelection?Kae(l):null,u.fixedMirrorParent?d.parentNode=u.fixedMirrorParent:d.parentNode=Gs(a,".fc"),d.revertDuration=u.dragRevertDuration;let b=l.isValidSegDownEl(a)&&!Gs(a,".fc-event-resizer");c.setIgnoreMove(!b),this.isDragging=b&&o.subjectEl.classList.contains("fc-event-draggable")},this.handleDragStart=o=>{let a=this.component.context,l=this.eventRange,c=l.instance.instanceId;o.isTouch?c!==this.component.props.eventSelection&&a.dispatch({type:"SELECT_EVENT",eventInstanceId:c}):a.dispatch({type:"UNSELECT_EVENT"}),this.isDragging&&(a.calendarApi.unselect(o),a.emitter.trigger("eventDragStart",{el:this.subjectEl,event:new Vn(a,l.def,l.instance),jsEvent:o.origEvent,view:a.viewApi}))},this.handleHitUpdate=(o,a)=>{if(!this.isDragging)return;let l=this.relevantEvents,c=this.hitDragging.initialHit,d=this.component.context,u=null,h=null,p=null,f=!1,_={affectedEvents:l,mutatedEvents:Ci(),isEvent:!0};if(o){u=o.context;let b=u.options;d===u||b.editable&&b.droppable?(h=qae(c,o,this.eventRange.instance.range.start,u.getCurrentData().pluginHooks.eventDragMutationMassagers),h&&(p=zv(l,u.getCurrentData().eventUiBases,h,u),_.mutatedEvents=p,Vx(_,o.dateProfile,u)||(f=!0,h=null,p=null,_.mutatedEvents=Ci()))):u=null}this.displayDrag(u,_),f?Fv():Lv(),a||(d===u&&oS(c,o)&&(h=null),this.dragging.setMirrorNeedsRevert(!h),this.dragging.setMirrorIsVisible(!o||!this.subjectEl.getRootNode().querySelector(".fc-event-mirror")),this.receivingContext=u,this.validMutation=h,this.mutatedRelevantEvents=p)},this.handlePointerUp=()=>{this.isDragging||this.cleanup()},this.handleDragEnd=o=>{if(this.isDragging){let a=this.component.context,l=a.viewApi,{receivingContext:c,validMutation:d}=this,u=this.eventRange.def,h=this.eventRange.instance,p=new Vn(a,u,h),f=this.relevantEvents,_=this.mutatedRelevantEvents,{finalHit:b}=this.hitDragging;if(this.clearDrag(),a.emitter.trigger("eventDragStop",{el:this.subjectEl,event:p,jsEvent:o.origEvent,view:l}),d){if(c===a){let y=new Vn(a,_.defs[u.defId],h?_.instances[h.instanceId]:null);a.dispatch({type:"MERGE_EVENTS",eventStore:_});let w={oldEvent:p,event:y,relatedEvents:Aa(_,a,h),revert(){a.dispatch({type:"MERGE_EVENTS",eventStore:f})}},C={};for(let M of a.getCurrentData().pluginHooks.eventDropTransformers)Object.assign(C,M(d,a));a.emitter.trigger("eventDrop",Object.assign(Object.assign(Object.assign({},w),C),{el:o.subjectEl,delta:d.datesDelta,jsEvent:o.origEvent,view:l})),a.emitter.trigger("eventChange",w)}else if(c){let y={event:p,relatedEvents:Aa(f,a,h),revert(){a.dispatch({type:"MERGE_EVENTS",eventStore:f})}};a.emitter.trigger("eventLeave",Object.assign(Object.assign({},y),{draggedEl:o.subjectEl,view:l})),a.dispatch({type:"REMOVE_EVENTS",eventStore:f}),a.emitter.trigger("eventRemove",y);let w=_.defs[u.defId],C=_.instances[h.instanceId],M=new Vn(c,w,C);c.dispatch({type:"MERGE_EVENTS",eventStore:_});let S={event:M,relatedEvents:Aa(_,c,C),revert(){c.dispatch({type:"REMOVE_EVENTS",eventStore:_})}};c.emitter.trigger("eventAdd",S),o.isTouch&&c.dispatch({type:"SELECT_EVENT",eventInstanceId:h.instanceId}),c.emitter.trigger("drop",Object.assign(Object.assign({},yY(b.dateSpan,c)),{draggedEl:o.subjectEl,jsEvent:o.origEvent,view:b.context.viewApi})),c.emitter.trigger("eventReceive",Object.assign(Object.assign({},S),{draggedEl:o.subjectEl,view:b.context.viewApi}))}}else a.emitter.trigger("_noEventDrop")}this.cleanup()};let{component:t}=this,{options:n}=t.context,i=this.dragging=new wh(e.el);i.pointer.selector=s.SELECTOR,i.touchScrollAllowed=!1,i.autoScroller.isEnabled=n.dragScroll;let r=this.hitDragging=new um(this.dragging,om);r.useSubjectCenter=e.useEventCenter,r.emitter.on("pointerdown",this.handlePointerDown),r.emitter.on("dragstart",this.handleDragStart),r.emitter.on("hitupdate",this.handleHitUpdate),r.emitter.on("pointerup",this.handlePointerUp),r.emitter.on("dragend",this.handleDragEnd)}destroy(){this.dragging.destroy()}displayDrag(e,t){let n=this.component.context,i=this.receivingContext;i&&i!==e&&(i===n?i.dispatch({type:"SET_EVENT_DRAG",state:{affectedEvents:t.affectedEvents,mutatedEvents:Ci(),isEvent:!0}}):i.dispatch({type:"UNSET_EVENT_DRAG"})),e&&e.dispatch({type:"SET_EVENT_DRAG",state:t})}clearDrag(){let e=this.component.context,{receivingContext:t}=this;t&&t.dispatch({type:"UNSET_EVENT_DRAG"}),e!==t&&e.dispatch({type:"UNSET_EVENT_DRAG"})}cleanup(){this.subjectSeg=null,this.isDragging=!1,this.eventRange=null,this.relevantEvents=null,this.receivingContext=null,this.validMutation=null,this.mutatedRelevantEvents=null}};eb.SELECTOR=".fc-event-draggable, .fc-event-resizable";function qae(s,e,t,n){let i=s.dateSpan,r=e.dateSpan,o=i.range.start,a=r.range.start,l={};i.allDay!==r.allDay&&(l.allDay=r.allDay,l.hasEnd=e.context.options.allDayMaintainDuration,r.allDay?o=Sn(t):o=t);let c=Wc(o,a,s.context.dateEnv,s.componentId===e.componentId?s.largeUnit:null);c.milliseconds&&(l.allDay=!1);let d={datesDelta:c,standardProps:l};for(let u of n)u(d,s,e);return d}function Kae(s){let{options:e}=s.context,t=e.eventLongPressDelay;return t==null&&(t=e.longPressDelay),t}var LF=class extends $o{constructor(e){super(e),this.draggingSegEl=null,this.draggingSeg=null,this.eventRange=null,this.relevantEvents=null,this.validMutation=null,this.mutatedRelevantEvents=null,this.handlePointerDown=r=>{let{component:o}=this,a=this.querySegEl(r),l=Il(a),c=this.eventRange=l.eventRange;this.dragging.minDistance=o.context.options.eventDragMinDistance,this.dragging.setIgnoreMove(!this.component.isValidSegDownEl(r.origEvent.target)||r.isTouch&&this.component.props.eventSelection!==c.instance.instanceId)},this.handleDragStart=r=>{let{context:o}=this.component,a=this.eventRange;this.relevantEvents=Bv(o.getCurrentData().eventStore,this.eventRange.instance.instanceId);let l=this.querySegEl(r);this.draggingSegEl=l,this.draggingSeg=Il(l),o.calendarApi.unselect(),o.emitter.trigger("eventResizeStart",{el:l,event:new Vn(o,a.def,a.instance),jsEvent:r.origEvent,view:o.viewApi})},this.handleHitUpdate=(r,o,a)=>{let{context:l}=this.component,c=this.relevantEvents,d=this.hitDragging.initialHit,u=this.eventRange.instance,h=null,p=null,f=!1,_={affectedEvents:c,mutatedEvents:Ci(),isEvent:!0};r&&(r.componentId===d.componentId&&this.isHitComboAllowed&&!this.isHitComboAllowed(d,r)||(h=Yae(d,r,a.subjectEl.classList.contains("fc-event-resizer-start"),u.range))),h&&(p=zv(c,l.getCurrentData().eventUiBases,h,l),_.mutatedEvents=p,Vx(_,r.dateProfile,l)||(f=!0,h=null,p=null,_.mutatedEvents=null)),p?l.dispatch({type:"SET_EVENT_RESIZE",state:_}):l.dispatch({type:"UNSET_EVENT_RESIZE"}),f?Fv():Lv(),o||(h&&oS(d,r)&&(h=null),this.validMutation=h,this.mutatedRelevantEvents=p)},this.handleDragEnd=r=>{let{context:o}=this.component,a=this.eventRange.def,l=this.eventRange.instance,c=new Vn(o,a,l),d=this.relevantEvents,u=this.mutatedRelevantEvents;if(o.emitter.trigger("eventResizeStop",{el:this.draggingSegEl,event:c,jsEvent:r.origEvent,view:o.viewApi}),this.validMutation){let h=new Vn(o,u.defs[a.defId],l?u.instances[l.instanceId]:null);o.dispatch({type:"MERGE_EVENTS",eventStore:u});let p={oldEvent:c,event:h,relatedEvents:Aa(u,o,l),revert(){o.dispatch({type:"MERGE_EVENTS",eventStore:d})}};o.emitter.trigger("eventResize",Object.assign(Object.assign({},p),{el:this.draggingSegEl,startDelta:this.validMutation.startDelta||nn(0),endDelta:this.validMutation.endDelta||nn(0),jsEvent:r.origEvent,view:o.viewApi})),o.emitter.trigger("eventChange",p)}else o.emitter.trigger("_noEventResize");this.draggingSeg=null,this.relevantEvents=null,this.validMutation=null};let{component:t}=e,n=this.dragging=new wh(e.el);n.pointer.selector=".fc-event-resizer",n.touchScrollAllowed=!1,n.autoScroller.isEnabled=t.context.options.dragScroll;let i=this.hitDragging=new um(this.dragging,Vv(e));i.emitter.on("pointerdown",this.handlePointerDown),i.emitter.on("dragstart",this.handleDragStart),i.emitter.on("hitupdate",this.handleHitUpdate),i.emitter.on("dragend",this.handleDragEnd)}destroy(){this.dragging.destroy()}querySegEl(e){return Gs(e.subjectEl,".fc-event")}};function Yae(s,e,t,n){let i=s.context.dateEnv,r=s.dateSpan.range.start,o=e.dateSpan.range.start,a=Wc(r,o,i,s.largeUnit);if(t){if(i.add(n.start,a)<n.end)return{startDelta:a}}else if(i.add(n.end,a)>n.start)return{endDelta:a};return null}var NF=class{constructor(e){this.context=e,this.isRecentPointerDateSelect=!1,this.matchesCancel=!1,this.matchesEvent=!1,this.onSelect=n=>{n.jsEvent&&(this.isRecentPointerDateSelect=!0)},this.onDocumentPointerDown=n=>{let i=this.context.options.unselectCancel,r=Cx(n.origEvent);this.matchesCancel=!!Gs(r,i),this.matchesEvent=!!Gs(r,eb.SELECTOR)},this.onDocumentPointerUp=n=>{let{context:i}=this,{documentPointer:r}=this,o=i.getCurrentData();if(!r.wasTouchScroll){if(o.dateSelection&&!this.isRecentPointerDateSelect){let a=i.options.unselectAuto;a&&(!a||!this.matchesCancel)&&i.calendarApi.unselect(n)}o.eventSelection&&!this.matchesEvent&&i.dispatch({type:"UNSELECT_EVENT"})}this.isRecentPointerDateSelect=!1};let t=this.documentPointer=new sS(document);t.shouldIgnoreMove=!0,t.shouldWatchScroll=!1,t.emitter.on("pointerdown",this.onDocumentPointerDown),t.emitter.on("pointerup",this.onDocumentPointerUp),e.emitter.on("select",this.onSelect)}destroy(){this.context.emitter.off("select",this.onSelect),this.documentPointer.destroy()}},Xae={fixedMirrorParent:Ae},Qae={dateClick:Ae,eventDragStart:Ae,eventDragStop:Ae,eventDrop:Ae,eventResizeStart:Ae,eventResizeStop:Ae,eventResize:Ae,drop:Ae,eventReceive:Ae,eventLeave:Ae};jv.dataAttrPrefix="";var vY=nr({name:"@fullcalendar/interaction",componentInteractions:[RF,FF,eb,LF],calendarInteractions:[NF],elementDraggingImpl:wh,optionRefiners:Xae,listenerRefiners:Qae});var tb=require("obsidian");var Mh=class extends tb.Modal{constructor(t,n,i,r){super(t);this.saveCallback=null;this.event=n,this.dataProvider=i,this.settings=r}onSave(t){this.saveCallback=t}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("zfb-event-modal");let n={note:"\u{1F4DD}",schedule:"\u23F0",meeting:"\u{1F399}"},i={note:"\uB178\uD2B8",schedule:"\uC77C\uC815",meeting:"\uD68C\uC758\uB85D"},r=t.createDiv({cls:"event-modal-header"});r.style.display="flex",r.style.alignItems="center",r.style.gap="12px",r.style.marginBottom="16px";let o=r.createEl("span",{text:`${n[this.event.type]} ${i[this.event.type]}`});o.style.padding="4px 8px",o.style.backgroundColor=this.event.color||"var(--interactive-accent)",o.style.color="var(--text-on-accent)",o.style.borderRadius="4px",o.style.fontSize="12px",r.createEl("h2",{text:this.event.title}).style.margin="0";let a=t.createDiv({cls:"event-details"});a.style.padding="16px",a.style.backgroundColor="var(--background-secondary)",a.style.borderRadius="8px",a.style.marginBottom="16px";let l=a.createDiv({cls:"detail-row"});l.style.display="flex",l.style.alignItems="center",l.style.gap="8px",l.style.marginBottom="8px",l.createEl("span",{text:"\u{1F4C5}"});let c=$s(this.event.start,this.settings.timezone),d="";if(this.event.allDay)d=" (\uC885\uC77C)";else{let y=this.event.start.getHours().toString().padStart(2,"0"),w=this.event.start.getMinutes().toString().padStart(2,"0");d=` ${y}:${w}`}if(l.createEl("span",{text:c+d}),this.event.metadata?.project){let y=a.createDiv({cls:"detail-row"});y.style.display="flex",y.style.alignItems="center",y.style.gap="8px",y.style.marginBottom="8px",y.createEl("span",{text:"\u{1F4C1}"}),y.createEl("span",{text:this.event.metadata.project})}if(this.event.metadata?.tags&&this.event.metadata.tags.length>0){let y=a.createDiv({cls:"detail-row"});y.style.display="flex",y.style.alignItems="center",y.style.gap="8px",y.style.marginBottom="8px",y.createEl("span",{text:"\u{1F3F7}"});let w=y.createDiv({cls:"tags"});w.style.display="flex",w.style.gap="4px",w.style.flexWrap="wrap";for(let C of this.event.metadata.tags){let M=w.createEl("span",{text:`#${C}`});M.style.padding="2px 6px",M.style.backgroundColor="var(--background-modifier-border)",M.style.borderRadius="4px",M.style.fontSize="12px"}}if(this.event.metadata?.summary){let y=a.createDiv({cls:"detail-row"});y.style.marginTop="12px",y.style.paddingTop="12px",y.style.borderTop="1px solid var(--background-modifier-border)",y.createEl("div",{text:"\uC694\uC57D"}).style.fontWeight="500",y.createEl("p",{text:this.event.metadata.summary}).style.margin="4px 0 0 0"}let u=a.createDiv({cls:"detail-row"});u.style.marginTop="12px",u.style.fontSize="12px",u.style.color="var(--text-muted)",u.setText(`\uD30C\uC77C: ${this.event.source.path}`),this.event.source.lineNumber&&u.appendText(` (\uB77C\uC778 ${this.event.source.lineNumber})`);let h=t.createDiv({cls:"modal-button-container"});h.style.display="flex",h.style.justifyContent="space-between",h.style.marginTop="16px";let p=h.createDiv();if(this.event.type==="schedule"&&this.event.source.lineNumber){let y=p.createEl("button",{text:"\uC0AD\uC81C"});y.style.color="var(--text-error)",y.addEventListener("click",async()=>{confirm("\uC774 \uC77C\uC815\uC744 \uC0AD\uC81C\uD558\uC2DC\uACA0\uC2B5\uB2C8\uAE4C?")&&(await this.dataProvider.deleteEvent(this.event.id)?(new tb.Notice("\uC77C\uC815\uC774 \uC0AD\uC81C\uB418\uC5C8\uC2B5\uB2C8\uB2E4."),this.saveCallback&&this.saveCallback(),this.close()):new tb.Notice("\uC77C\uC815 \uC0AD\uC81C\uC5D0 \uC2E4\uD328\uD588\uC2B5\uB2C8\uB2E4."))})}let f=h.createDiv();f.style.display="flex",f.style.gap="8px",f.createEl("button",{text:"\uD30C\uC77C \uC5F4\uAE30",cls:"mod-cta"}).addEventListener("click",async()=>{await this.dataProvider.openEvent(this.event.id),this.close()}),f.createEl("button",{text:"\uB2EB\uAE30"}).addEventListener("click",()=>this.close())}onClose(){this.contentEl.empty()}};var Zc="zfb-calendar",nb=class extends bY.ItemView{constructor(t,n,i){super(t);this.calendar=null;this.refreshTimeout=null;this.isRefreshing=!1;this.resizeObserver=null;this.settings=n,this.dataProvider=i,this.refreshCallback=()=>this.debouncedRefresh()}debouncedRefresh(){this.isRefreshing||(this.refreshTimeout&&clearTimeout(this.refreshTimeout),this.refreshTimeout=setTimeout(async()=>{await this.refreshEvents()},1e3))}getViewType(){return Zc}getDisplayText(){return"Zero Friction \uCE98\uB9B0\uB354"}getIcon(){return"calendar"}async onOpen(){this.dataProvider.addChangeListener(this.refreshCallback);let t=this.contentEl;t.empty(),t.addClass("zfb-full-calendar");let n=t.createDiv({cls:"calendar-container"});n.style.height="100%",n.style.padding="16px",this.calendar=new Qv(n,this.getCalendarOptions()),this.calendar.render(),this.resizeObserver=new ResizeObserver(()=>{this.calendar&&this.calendar.updateSize()}),this.resizeObserver.observe(t)}getCalendarOptions(){return{plugins:[oY,pY,mY,vY],initialView:this.getInitialView(),locale:"ko",firstDay:this.settings.calendarFirstDayOfWeek,headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay,listWeek"},buttonText:{today:"\uC624\uB298",month:"\uC6D4",week:"\uC8FC",day:"\uC77C",list:"\uBAA9\uB85D"},events:async(t,n)=>{let i=await this.loadEvents();n(i)},editable:!0,selectable:!0,selectMirror:!0,dayMaxEvents:!0,weekends:!0,moreLinkClick:t=>{let n=t.date.toISOString().split("T")[0];return new wa(this.app,n,this.dataProvider,this.settings).open(),"none"},eventOrder:(t,n)=>{let i={schedule:0,note:1,meeting:2},r=t.extendedProps?.type||"note",o=n.extendedProps?.type||"note";return(i[r]??2)-(i[o]??2)},eventTimeFormat:{hour:"2-digit",minute:"2-digit",hour12:!1},eventClick:t=>{this.handleEventClick(t)},eventDrop:async t=>{await this.handleEventDrop(t)},select:t=>{this.handleDateSelect(t)},eventDidMount:t=>{let n=t.event,i=n.extendedProps;if(i?.project&&(t.el.title=`${n.title}
\uD504\uB85C\uC81D\uD2B8: ${i.project}`),t.el.classList.contains("fc-daygrid-dot-event")){let r=n.backgroundColor||"var(--text-success)";t.el.style.backgroundColor=r}}}}async onClose(){this.refreshTimeout&&(clearTimeout(this.refreshTimeout),this.refreshTimeout=null),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.dataProvider.removeChangeListener(this.refreshCallback),this.calendar&&(this.calendar.destroy(),this.calendar=null),this.contentEl.empty()}updateSettings(t){this.settings=t,this.calendar&&this.calendar.setOption("firstDay",t.calendarFirstDayOfWeek)}async refreshEvents(){if(!(!this.calendar||this.isRefreshing)){this.isRefreshing=!0;try{let t=this.calendar.view.type,n=this.calendar.getDate(),i=this.contentEl.querySelector(".calendar-container");if(!i)return;this.calendar.destroy(),this.calendar=new Qv(i,this.getCalendarOptions()),this.calendar.render(),this.calendar.changeView(t,n)}finally{this.isRefreshing=!1}}}getInitialView(){switch(this.settings.calendarDefaultView){case"month":return"dayGridMonth";case"week":return"timeGridWeek";case"day":return"timeGridDay";case"list":return"listWeek";default:return"dayGridMonth"}}async loadEvents(){let t=new Date,n=new Date(t.getFullYear(),t.getMonth()-3,1),i=new Date(t.getFullYear(),t.getMonth()+3,0);return(await this.dataProvider.getEventsForRange(n,i)).map(o=>this.convertToFullCalendarEvent(o))}convertToFullCalendarEvent(t){return{id:t.id,title:t.title,start:t.start,end:t.end,allDay:t.allDay,backgroundColor:t.color,borderColor:t.color,extendedProps:{type:t.type,source:t.source,...t.metadata}}}handleEventClick(t){let n=t.event.id,i=t.event.extendedProps,r={id:n,title:t.event.title,start:t.event.start,end:t.event.end||void 0,allDay:t.event.allDay,type:i.type,color:t.event.backgroundColor||void 0,source:i.source,metadata:{project:i.project,tags:i.tags,summary:i.summary}},o=new Mh(this.app,r,this.dataProvider,this.settings);o.onSave(async()=>{await this.refreshEvents()}),o.open()}async handleEventDrop(t){let n=t.event.id,i=t.event.start;await this.dataProvider.moveEvent(n,i)||t.revert()}handleDateSelect(t){this.calendar?.unselect();let n=t.startStr.split("T")[0];new wa(this.app,n,this.dataProvider,this.settings).open()}};var aS=require("obsidian");var Jae="zfb-calendar",sb=class extends aS.ItemView{constructor(t,n,i){super(t);this.currentView="month";this.currentDate=new Date;this.refreshTimeout=null;this.isRefreshing=!1;this.dragState={isDragging:!1,event:null,ghostEl:null,startX:0,startY:0,targetDate:null};this.DRAG_THRESHOLD=5;this.LONG_PRESS_DELAY=500;this.settings=n,this.dataProvider=i,this.currentView=n.calendarDefaultView,this.refreshCallback=()=>this.debouncedRefresh()}getViewType(){return Jae}getDisplayText(){return"Zero Friction \uCE98\uB9B0\uB354"}getIcon(){return"calendar"}async onOpen(){this.dataProvider.addChangeListener(this.refreshCallback),await this.render()}async onClose(){this.refreshTimeout&&(clearTimeout(this.refreshTimeout),this.refreshTimeout=null),this.dataProvider.removeChangeListener(this.refreshCallback),this.contentEl.empty()}updateSettings(t){this.settings=t}debouncedRefresh(){this.isRefreshing||(this.refreshTimeout&&clearTimeout(this.refreshTimeout),this.refreshTimeout=setTimeout(async()=>{await this.render()},1e3))}async render(){if(!this.isRefreshing){this.isRefreshing=!0;try{let t=this.contentEl;t.empty(),t.addClass("zfb-native-calendar"),this.renderToolbar(t);let n=t.createDiv({cls:"zfb-native-calendar-content"});switch(this.currentView){case"month":await this.renderMonthView(n);break;case"list":await this.renderListView(n);break;case"week":await this.renderWeekView(n);break;case"day":await this.renderDayView(n);break}}finally{this.isRefreshing=!1}}}renderToolbar(t){let n=t.createDiv({cls:"zfb-native-calendar-toolbar"}),i=n.createDiv({cls:"toolbar-nav"}),r=i.createEl("button",{cls:"nav-btn"});r.innerHTML="&#9664;",r.addEventListener("click",()=>this.navigate(-1)),i.createEl("span",{cls:"toolbar-title"}).setText(this.formatTitle());let a=i.createEl("button",{cls:"nav-btn"});a.innerHTML="&#9654;",a.addEventListener("click",()=>this.navigate(1));let l=n.createDiv({cls:"toolbar-actions"});l.createEl("button",{text:"\uC624\uB298",cls:"today-btn"}).addEventListener("click",()=>this.goToToday());let d=l.createEl("select",{cls:"view-select"}),u=[{value:"month",label:"\uC6D4"},{value:"week",label:"\uC8FC"},{value:"day",label:"\uC77C"},{value:"list",label:"\uBAA9\uB85D"}];for(let h of u){let p=d.createEl("option",{value:h.value,text:h.label});h.value===this.currentView&&(p.selected=!0)}d.addEventListener("change",()=>{this.changeView(d.value)})}formatTitle(){let t=this.currentDate.getFullYear(),n=this.currentDate.getMonth()+1;switch(this.currentView){case"month":return`${t}\uB144 ${n}\uC6D4`;case"week":case"list":let{weekStart:i,weekEnd:r}=this.getWeekRange(),o=i.getMonth()+1,a=i.getDate(),l=r.getMonth()+1,c=r.getDate();return o===l?`${o}/${a} - ${c}`:`${o}/${a} - ${l}/${c}`;case"day":let d=["\uC77C","\uC6D4","\uD654","\uC218","\uBAA9","\uAE08","\uD1A0"],u=this.currentDate.getDate(),h=d[this.currentDate.getDay()];return`${t}\uB144 ${n}\uC6D4 ${u}\uC77C (${h})`;default:return`${t}\uB144 ${n}\uC6D4`}}navigate(t){switch(this.currentView){case"month":this.currentDate.setMonth(this.currentDate.getMonth()+t);break;case"week":case"list":this.currentDate.setDate(this.currentDate.getDate()+t*7);break;case"day":this.currentDate.setDate(this.currentDate.getDate()+t);break}this.render()}goToToday(){this.currentDate=new Date,this.render()}changeView(t){this.currentView=t,this.render()}getWeekRange(){let t=new Date(this.currentDate),n=this.settings.calendarFirstDayOfWeek,r=(t.getDay()-n+7)%7,o=new Date(t);o.setDate(t.getDate()-r),o.setHours(0,0,0,0);let a=new Date(o);return a.setDate(o.getDate()+6),a.setHours(23,59,59,999),{weekStart:o,weekEnd:a}}async renderMonthView(t){let n=t.createDiv({cls:"zfb-native-calendar-month-grid"}),i=n.createDiv({cls:"weekday-header"}),r=["\uC77C","\uC6D4","\uD654","\uC218","\uBAA9","\uAE08","\uD1A0"],o=this.settings.calendarFirstDayOfWeek;for(let c=0;c<7;c++){let d=(o+c)%7,u=i.createDiv({cls:"day-name"});u.setText(r[d]),d===0&&u.addClass("sunday"),d===6&&u.addClass("saturday")}let a=await this.getMonthCells(),l=n.createDiv({cls:"date-grid"});for(let c of a){let d=l.createDiv({cls:"date-cell"});d.dataset.date=c.date,c.isCurrentMonth||d.addClass("other-month"),c.isToday&&d.addClass("today"),c.isWeekend&&d.addClass("weekend");let u=d.createDiv({cls:"day-number"});u.setText(String(c.day)),u.addEventListener("click",b=>{b.stopPropagation(),this.openDayModal(c.date)});let h=d.createDiv({cls:"events-container"}),p=3,_=this.sortEventsByType(c.events).slice(0,p);for(let b of _){let y=h.createDiv({cls:"event-item"});y.style.backgroundColor=b.color||"var(--interactive-accent)";let w={note:"\u{1F4DD}",schedule:"\u23F0",meeting:"\u{1F399}"};y.createSpan({cls:"event-icon"}).setText(w[b.type]||"\u{1F4C4}"),y.createSpan({cls:"event-title"}).setText(b.title),y.title=b.title,y.addEventListener("click",S=>{S.stopPropagation(),this.openEventModal(b)}),this.setupDragAndDrop(y,b)}if(c.events.length>p){let b=c.events.length-p,y=h.createDiv({cls:"more-events"});y.setText(`+${b} more`),y.addEventListener("click",w=>{w.stopPropagation(),this.openDayModal(c.date)})}}}async getMonthCells(){let t=this.currentDate.getFullYear(),n=this.currentDate.getMonth(),i=this.settings.calendarFirstDayOfWeek,a=(new Date(t,n,1).getDay()-i+7)%7,l=new Date(t,n,1-a),c=[],d=new Date,u=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`,h=new Date(l.getTime()+42*24*60*60*1e3),p=await this.dataProvider.getEventsForRange(l,h),f=new Map;for(let _ of p){let b=this.formatDateStr(_.start);f.has(b)||f.set(b,[]),f.get(b).push(_)}for(let _=0;_<42;_++){let b=new Date(l.getTime()+_*24*60*60*1e3),y=this.formatDateStr(b),w=b.getDay();c.push({date:y,day:b.getDate(),isCurrentMonth:b.getMonth()===n,isToday:y===u,isWeekend:w===0||w===6,events:f.get(y)||[]})}return c}async renderListView(t){let n=t.createDiv({cls:"zfb-native-calendar-list"}),{weekStart:i,weekEnd:r}=this.getWeekRange(),o=await this.dataProvider.getEventsForRange(i,r),a=this.groupEventsByDate(o),l=["\uC77C","\uC6D4","\uD654","\uC218","\uBAA9","\uAE08","\uD1A0"],c=new Date(i);for(let d=0;d<7;d++){let u=this.formatDateStr(c),h=a.get(u)||[],p=c.getDay(),f=l[p],_=n.createDiv({cls:"list-date-group"}),b=_.createDiv({cls:"list-date-header"}),y=b.createSpan({cls:"toggle-icon"});y.setText(h.length>0?"\u25BC":"\u25B6"),b.createSpan({cls:"date-text"}).setText(`${u} (${f}\uC694\uC77C)`),h.length===0&&(b.addClass("empty"),b.createSpan({cls:"empty-label",text:"\uD56D\uBAA9 \uC5C6\uC74C"}));let C=_.createDiv({cls:"list-events"});h.length===0&&(C.style.display="none");let M=this.sortEventsByType(h);for(let S of M){let k=C.createDiv({cls:"list-event-item"}),T={note:"\u{1F4DD}",schedule:"\u23F0",meeting:"\u{1F399}"};if(k.createSpan({cls:"event-icon",text:T[S.type]||"\u{1F4C4}"}),S.type==="schedule"&&!S.allDay){let R=S.start.getHours().toString().padStart(2,"0"),O=S.start.getMinutes().toString().padStart(2,"0");k.createSpan({cls:"event-time",text:`${R}:${O}`})}k.createSpan({cls:"event-title",text:S.title}),S.metadata?.project&&k.createSpan({cls:"event-project",text:`[${S.metadata.project}]`});let P=k.createDiv({cls:"event-indicator"});P.style.backgroundColor=S.color||"var(--interactive-accent)",k.addEventListener("click",async()=>{await this.dataProvider.openEvent(S.id)})}b.addEventListener("click",()=>{let S=C.style.display==="none";C.style.display=S?"block":"none",y.setText(S?"\u25BC":"\u25B6")}),c.setDate(c.getDate()+1)}}async renderWeekView(t){let n=t.createDiv({cls:"zfb-native-calendar-week-grid"}),{weekStart:i,weekEnd:r}=this.getWeekRange(),o=await this.dataProvider.getEventsForRange(i,r),a=o.filter(_=>_.allDay),l=o.filter(_=>!_.allDay),c=this.groupEventsByDate(l),d=n.createDiv({cls:"week-header-row"});d.createDiv({cls:"time-column-header"});let u=["\uC77C","\uC6D4","\uD654","\uC218","\uBAA9","\uAE08","\uD1A0"],h=this.formatDateStr(new Date),p=new Date(i);for(let _=0;_<7;_++){let b=this.formatDateStr(p),y=d.createDiv({cls:"day-header"});b===h&&y.addClass("today"),y.createDiv({cls:"day-name",text:u[p.getDay()]}),y.createDiv({cls:"day-number",text:String(p.getDate())}),p.setDate(p.getDate()+1)}if(a.length>0){let _=n.createDiv({cls:"zfb-native-calendar-all-day-row"});_.createDiv({cls:"all-day-label",text:"\uC885\uC77C"}),p.setTime(i.getTime());for(let b=0;b<7;b++){let y=this.formatDateStr(p),w=a.filter(M=>this.formatDateStr(M.start)===y),C=_.createDiv({cls:"all-day-cell"});for(let M of w){let S=C.createDiv({cls:"all-day-event"});S.style.backgroundColor=M.color||"var(--interactive-accent)",S.setText(M.title),S.title=M.title,S.addEventListener("click",()=>this.openEventModal(M))}p.setDate(p.getDate()+1)}}let f=n.createDiv({cls:"time-grid"});for(let _=0;_<24;_++){let b=f.createDiv({cls:"hour-row"});b.createDiv({cls:"time-label",text:`${_.toString().padStart(2,"0")}:00`}),p.setTime(i.getTime());for(let y=0;y<7;y++){let w=this.formatDateStr(p),C=b.createDiv({cls:"zfb-native-calendar-time-slot"});C.dataset.date=w,C.dataset.hour=String(_);let S=(c.get(w)||[]).filter(k=>k.start.getHours()===_);for(let k of S)this.renderTimedEvent(C,k);p.setDate(p.getDate()+1)}}}async renderDayView(t){let n=t.createDiv({cls:"zfb-native-calendar-day-grid"}),i=this.formatDateStr(this.currentDate),r=new Date(this.currentDate);r.setHours(0,0,0,0);let o=new Date(this.currentDate);o.setHours(23,59,59,999);let a=await this.dataProvider.getEventsForRange(r,o),l=a.filter(u=>u.allDay),c=a.filter(u=>!u.allDay);if(l.length>0){let u=n.createDiv({cls:"zfb-native-calendar-all-day-row"});u.createDiv({cls:"all-day-label",text:"\uC885\uC77C"});let h=u.createDiv({cls:"all-day-content"});for(let p of l){let f=h.createDiv({cls:"all-day-event"});f.style.backgroundColor=p.color||"var(--interactive-accent)",f.setText(p.title),f.addEventListener("click",()=>this.openEventModal(p))}}let d=n.createDiv({cls:"time-grid day-view"});for(let u=0;u<24;u++){let h=d.createDiv({cls:"hour-row"});h.createDiv({cls:"time-label",text:`${u.toString().padStart(2,"0")}:00`});let p=h.createDiv({cls:"zfb-native-calendar-time-slot"});p.dataset.date=i,p.dataset.hour=String(u);let f=c.filter(_=>_.start.getHours()===u);for(let _ of f)this.renderTimedEvent(p,_)}}renderTimedEvent(t,n){let i=t.createDiv({cls:"timed-event"}),o=n.start.getMinutes()/60*48;i.style.top=`${o}px`;let d=((n.end||new Date(n.start.getTime()+60*60*1e3)).getTime()-n.start.getTime())/(60*60*1e3)*48;i.style.height=`${Math.max(d,24)}px`,i.style.backgroundColor=n.color||"var(--interactive-accent)";let u={note:"\u{1F4DD}",schedule:"\u23F0",meeting:"\u{1F399}"};i.createSpan({cls:"event-icon",text:u[n.type]||"\u{1F4C4}"}),i.createSpan({cls:"event-title",text:n.title}),i.title=n.title;let h=n.start.getHours().toString().padStart(2,"0"),p=n.start.getMinutes().toString().padStart(2,"0");return i.createDiv({cls:"event-time",text:`${h}:${p}`}),i.addEventListener("click",f=>{f.stopPropagation(),this.openEventModal(n)}),this.setupDragAndDrop(i,n),i}setupDragAndDrop(t,n){let i=null,r=!1,o=(c,d)=>{this.dragState.startX=c,this.dragState.startY=d,this.dragState.event=n,r=!1},a=(c,d)=>{if(!this.dragState.event)return;let u=Math.abs(c-this.dragState.startX),h=Math.abs(d-this.dragState.startY);!r&&(u>this.DRAG_THRESHOLD||h>this.DRAG_THRESHOLD)&&(r=!0,this.dragState.isDragging=!0,this.createGhostElement(n,c,d),t.addClass("zfb-native-calendar-event--dragging")),this.dragState.isDragging&&this.dragState.ghostEl&&(this.dragState.ghostEl.style.left=`${c+10}px`,this.dragState.ghostEl.style.top=`${d+10}px`,this.updateDropTarget(c,d))},l=async()=>{i&&(clearTimeout(i),i=null),this.dragState.isDragging&&this.dragState.targetDate&&await this.dataProvider.moveEvent(this.dragState.event.id,new Date(this.dragState.targetDate))&&(new aS.Notice("\uC774\uBCA4\uD2B8\uAC00 \uC774\uB3D9\uB418\uC5C8\uC2B5\uB2C8\uB2E4"),await this.render()),this.cleanupDrag(t)};t.addEventListener("mousedown",c=>{if(c.button!==0)return;c.preventDefault(),o(c.clientX,c.clientY);let d=h=>a(h.clientX,h.clientY),u=async()=>{document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",u),await l()};document.addEventListener("mousemove",d),document.addEventListener("mouseup",u)}),t.addEventListener("touchstart",c=>{let d=c.touches[0];o(d.clientX,d.clientY),i=setTimeout(()=>{r=!0,this.dragState.isDragging=!0,this.createGhostElement(n,d.clientX,d.clientY),t.addClass("zfb-native-calendar-event--dragging")},this.LONG_PRESS_DELAY)},{passive:!0}),t.addEventListener("touchmove",c=>{let d=c.touches[0];a(d.clientX,d.clientY),this.dragState.isDragging&&c.preventDefault()},{passive:!1}),t.addEventListener("touchend",async()=>{await l()}),t.addEventListener("touchcancel",()=>{this.cleanupDrag(t)})}createGhostElement(t,n,i){let r=document.createElement("div");r.addClass("zfb-native-calendar-ghost"),r.style.position="fixed",r.style.left=`${n+10}px`,r.style.top=`${i+10}px`,r.style.zIndex="1000",r.style.pointerEvents="none",r.style.backgroundColor=t.color||"var(--interactive-accent)";let o={note:"\u{1F4DD}",schedule:"\u23F0",meeting:"\u{1F399}"};r.innerHTML=`<span class="event-icon">${o[t.type]||"\u{1F4C4}"}</span><span class="event-title">${t.title}</span>`,document.body.appendChild(r),this.dragState.ghostEl=r}updateDropTarget(t,n){document.querySelectorAll(".zfb-native-calendar-cell--drop-target").forEach(o=>{o.removeClass("zfb-native-calendar-cell--drop-target")});let r=document.elementFromPoint(t,n)?.closest(".zfb-native-calendar-cell");r?.dataset.date?(r.addClass("zfb-native-calendar-cell--drop-target"),this.dragState.targetDate=r.dataset.date):this.dragState.targetDate=null}cleanupDrag(t){this.dragState.ghostEl&&this.dragState.ghostEl.remove(),document.querySelectorAll(".zfb-native-calendar-cell--drop-target").forEach(n=>{n.removeClass("zfb-native-calendar-cell--drop-target")}),t.removeClass("zfb-native-calendar-event--dragging"),this.dragState={isDragging:!1,event:null,ghostEl:null,startX:0,startY:0,targetDate:null}}formatDateStr(t){let n=t.getFullYear(),i=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0");return`${n}-${i}-${r}`}groupEventsByDate(t){let n=new Map;for(let i of t){let r=this.formatDateStr(i.start);n.has(r)||n.set(r,[]),n.get(r).push(i)}return n}sortEventsByType(t){let n={schedule:0,note:1,meeting:2};return[...t].sort((i,r)=>{let o=n[i.type]??2,a=n[r.type]??2;return o!==a?o-a:i.start.getTime()-r.start.getTime()})}openDayModal(t){new wa(this.app,t,this.dataProvider,this.settings).open()}openEventModal(t){let n=new Mh(this.app,t,this.dataProvider,this.settings);n.onSave(async()=>await this.render()),n.open()}};function Xr(s,e=100){return s.replace(/[\\/:*?"<>|?#\[\]]/g,"_").replace(/\s+/g," ").trim().slice(0,e)}var lS=class extends we.Plugin{constructor(){super(...arguments);this.gemini=null;this.ocrProcessor=null;this.relatedNoteFinder=null;this.mocManager=null;this.zkIndexManager=null;this.youtubeExtractor=null;this.webPageExtractor=null;this.reviewManager=null;this.meetingProcessor=null;this.scheduleManager=null;this.googleCalendar=null;this.calendarDataProvider=null;this.feedbackManager=null;this.embeddingManager=null;this.ragEngine=null;this.chatStorage=null;this.usageTracker=null;this.usageStatusBarEl=null;this.watcherRegistered=!1;this.pendingFiles=new Map;this.zkDailyCounter=new Map;this.zkLuhmannCounter=0;this.pendingEmbeddings=new Map;this.chatbotViewRegistered=!1}async onload(){await this.loadSettings(),this.addSettingTab(new hw(this.app,this)),this.processDebounced=(0,we.debounce)(()=>this.processPendingFiles(),3e3,!0),this.feedbackManager=new ex(this.app,this.settings),await this.feedbackManager.load(),this.settings.usageTrackingEnabled&&await this.initUsageTracker(),this.calendarDataProvider=new hv(this.app,this.settings),this.registerCalendarViews(),this.registerCommands(),this.settings.autoWatch&&this.startWatcher(),this.app.workspace.onLayoutReady(async()=>{this.settings.onboardingCompleted?await this.initGemini():new tx(this.app,this.settings,async t=>{this.settings=t,await this.saveSettings(),await this.initGemini(),new we.Notice("\u{1F389} Zero Friction Brain \uC124\uC815 \uC644\uB8CC!")}).open()}),console.log("Zero Friction Brain \uD50C\uB7EC\uADF8\uC778 \uB85C\uB4DC\uB428")}async onunload(){this.stopWatcher(),this.usageTracker&&await this.usageTracker.saveUsage(),console.log("Zero Friction Brain \uD50C\uB7EC\uADF8\uC778 \uC5B8\uB85C\uB4DC\uB428")}async loadSettings(){this.settings=Object.assign({},cd,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.initGemini()}async initGemini(){this.settings.geminiApiKey?(this.gemini=new eM(this.settings.geminiApiKey),this.usageTracker&&this.gemini.setUsageTracker(this.usageTracker),this.ocrProcessor=new a0(this.gemini,this.settings,this.app.vault),this.relatedNoteFinder=new l0(this.app,this.gemini,this.settings),this.embeddingManager=new c0(this.app,this.gemini,this.settings),await this.embeddingManager.loadIndex(),this.relatedNoteFinder.setEmbeddingManager(this.embeddingManager),this.chatStorage=new u0(this.app,this.settings),await this.chatStorage.loadSessions(),this.ragEngine=new d0(this.app,this.gemini,this.embeddingManager,this.settings),this.chatbotViewRegistered||(this.registerView(Bf,t=>new Vy(t,this.settings,this.ragEngine,this.chatStorage)),this.chatbotViewRegistered=!0),this.mocManager=new h0(this.app,this.gemini,this.settings.projectsFolder,this.settings),this.zkIndexManager=new p0(this.app,this.relatedNoteFinder,this.settings.zettelFolder,this.settings,this.gemini),this.youtubeExtractor=new v0(this.gemini,this.settings),this.webPageExtractor=new b0(this.gemini,this.settings),this.reviewManager=new f0(this.app,this.gemini,this.settings),this.meetingProcessor=new m0(this.app,this.gemini,this.settings),this.scheduleManager=new g0(this.app,this.settings),this.googleCalendar=new Wy(this.app,this.settings,()=>this.saveSettings()),Promise.all([this.relatedNoteFinder.buildIndex(),this.mocManager.scanProjectMOCs()]).then(()=>{console.log(`\uB178\uD2B8 \uC778\uB371\uC2A4: ${this.relatedNoteFinder?.getIndexSize()}\uAC1C, MOC: ${this.mocManager?.getMOCCount()}\uAC1C, ZK: ${this.relatedNoteFinder?.getZettelCount()}\uAC1C`),this.initializeZKCounters()})):(this.gemini=null,this.ocrProcessor=null,this.relatedNoteFinder=null,this.embeddingManager=null,this.ragEngine=null,this.chatStorage=null,this.mocManager=null,this.youtubeExtractor=null,this.webPageExtractor=null,this.reviewManager=null,this.scheduleManager=null,this.googleCalendar=null)}checkApiKey(){return this.gemini?!0:(new we.Notice("Gemini API \uD0A4\uB97C \uC124\uC815\uD574\uC8FC\uC138\uC694"),!1)}truncateContent(t,n=5e5){let i=t.replace(/data:image\/[^;]+;base64,[A-Za-z0-9+/=]+/g,"[\uC774\uBBF8\uC9C0]");return i=i.replace(/!\[[^\]]*\]\(data:[^)]+\)/g,"[\uC774\uBBF8\uC9C0]"),i.length<=n?i:i.slice(0,n)+`

[... \uB0B4\uC6A9\uC774 \uB108\uBB34 \uAE38\uC5B4 \uC77C\uBD80\uB9CC \uBD84\uC11D\uB428 ...]`}extractEmbeddedImages(t){let n=["png","jpg","jpeg","webp","gif"],i=[],r=new Set,o=/!\[\[([^\]]+)\]\]/g,a;for(;(a=o.exec(t))!==null;){let c=a[1].split("|")[0].trim(),d=c.split(".").pop()?.toLowerCase();if(d&&n.includes(d)){let u=this.app.metadataCache.getFirstLinkpathDest(c,"");u&&u instanceof we.TFile&&!r.has(u.path)&&(i.push(u),r.add(u.path))}}let l=/!\[[^\]]*\]\(([^)]+)\)/g;for(;(a=l.exec(t))!==null;){let c=a[1].trim();if(c.startsWith("http")||c.startsWith("data:"))continue;let d=c.split(".").pop()?.toLowerCase();if(d&&n.includes(d)){let u=this.app.vault.getAbstractFileByPath(c);u&&u instanceof we.TFile&&!r.has(u.path)&&(i.push(u),r.add(u.path))}}return i}registerCommands(){this.addCommand({id:"project-classify",name:`${ws}\uD504\uB85C\uC81D\uD2B8 \uBD84\uB958`,hotkeys:[{modifiers:["Ctrl","Shift"],key:"g"}],callback:()=>this.classifyCurrentFile()}),this.addCommand({id:"zk-extract",name:`${ws}ZK \uCD94\uCD9C`,hotkeys:[{modifiers:["Ctrl","Shift"],key:"z"}],callback:()=>this.extractZKFromCurrentFile()}),this.addCommand({id:"focus-top3",name:`${ws}Focus Top 3`,hotkeys:[{modifiers:["Ctrl","Shift"],key:";"}],callback:()=>this.showFocusTop3()}),this.addCommand({id:"process-inbox",name:`${ws}Inbox \uC804\uCCB4 \uCC98\uB9AC`,callback:()=>this.processInbox()}),this.addCommand({id:"toggle-watch",name:`${ws}Watch \uD1A0\uAE00`,callback:()=>this.toggleWatch()}),this.addCommand({id:"ocr-extract",name:`${ws}OCR \uCD94\uCD9C`,hotkeys:[{modifiers:["Ctrl","Shift"],key:"o"}],callback:()=>this.ocrCurrentFile()}),this.addCommand({id:"ocr-inbox",name:`${ws}Inbox OCR \uCC98\uB9AC`,callback:()=>this.processInboxOCR()}),this.addCommand({id:"smart-process",name:`${ws}\uC2A4\uB9C8\uD2B8 \uCC98\uB9AC (OCR+\uBD84\uB958)`,hotkeys:[{modifiers:["Ctrl","Shift"],key:"s"}],callback:()=>this.smartProcessCurrentFile()}),this.addCommand({id:"create-moc",name:`${ws}\uD504\uB85C\uC81D\uD2B8 MOC \uC0DD\uC131`,callback:()=>this.showCreateMOCModal()}),this.addCommand({id:"url-import",name:`${ws}URL \uAC00\uC838\uC624\uAE30`,hotkeys:[{modifiers:["Ctrl","Shift"],key:"u"}],callback:()=>this.showURLImportModal()}),this.addCommand({id:"rebuild-zk-index",name:`${ws}ZK Index \uC7AC\uAD6C\uCD95`,callback:()=>this.rebuildZKIndex()}),this.addCommand({id:"smart-split",name:`${ws}\uC2A4\uB9C8\uD2B8 \uBD84\uB9AC`,hotkeys:[{modifiers:["Ctrl","Shift"],key:"d"}],callback:()=>this.smartSplitCurrentFile()}),this.addCommand({id:"link-related-notes",name:`${ws}\uAD00\uB828 \uB178\uD2B8 \uC5F0\uACB0`,hotkeys:[{modifiers:["Ctrl","Shift"],key:"l"}],callback:()=>this.linkRelatedNotesForCurrentFile()}),this.addCommand({id:"review-mode",name:`${ws}\uB9AC\uBDF0/\uD68C\uACE0 \uBAA8\uB4DC`,hotkeys:[{modifiers:["Ctrl","Shift"],key:"r"}],callback:()=>this.showReviewModal()}),this.addCommand({id:"show-command-list",name:`${ws}\uBA85\uB839 \uB9AC\uC2A4\uD2B8`,callback:()=>this.showCommandListModal()}),this.addCommand({id:"open-calendar",name:`${ws}\uCE98\uB9B0\uB354 \uBDF0`,hotkeys:[{modifiers:["Ctrl","Shift"],key:"c"}],callback:()=>this.openCalendarView()}),this.addCommand({id:"toggle-chatbot",name:`${ws}AI \uCC57\uBD07`,hotkeys:[{modifiers:["Ctrl","Shift"],key:"'"}],callback:()=>this.toggleChatbot()}),this.addCommand({id:"image-batch-ocr",name:`${ws}\uC774\uBBF8\uC9C0 \uD1B5\uD569 \uCC98\uB9AC`,callback:()=>this.showImageBatchModal()}),this.addCommand({id:"smart-search",name:`${ws}\uC2A4\uB9C8\uD2B8 \uAC80\uC0C9`,hotkeys:[{modifiers:["Ctrl","Shift"],key:"f"}],callback:()=>this.showSmartSearchModal()}),this.addCommand({id:"test-local-embedding",name:`${ws}[PoC] \uB85C\uCEEC \uC784\uBCA0\uB529 \uD14C\uC2A4\uD2B8`,callback:()=>this.runLocalEmbeddingPoC()}),this.addRibbonIcon("brain","Zero Friction Brain",()=>{this.showCommandListModal()}),this.settings.calendarEnabled&&this.addRibbonIcon("calendar","\uCE98\uB9B0\uB354 \uBDF0",()=>{this.openCalendarView()}),this.settings.ragEnabled&&this.settings.embeddingEnabled&&this.addRibbonIcon("bot","AI \uCC57\uBD07",()=>{this.toggleChatbot()})}registerCalendarViews(){this.settings.calendarEngine==="native"?this.registerView(Zc,t=>new sb(t,this.settings,this.calendarDataProvider)):this.registerView(Zc,t=>new nb(t,this.settings,this.calendarDataProvider)),this.registerView(Yf,t=>new pv(t,this.settings,this.calendarDataProvider))}async restartCalendarView(){this.app.workspace.detachLeavesOfType(Zc),await this.openCalendarView()}async toggleChatbot(){let t=this.app.workspace.getLeavesOfType(Bf);if(t.length>0)t[0].detach();else{let n=this.app.workspace.getRightLeaf(!1);n&&await n.setViewState({type:Bf,active:!0})}}async openCalendarView(){let t=this.app.workspace.getLeavesOfType(Zc);t.length>0?this.app.workspace.revealLeaf(t[0]):await this.app.workspace.getLeaf("tab").setViewState({type:Zc,active:!0})}async toggleMiniCalendar(){let t=this.app.workspace.getLeavesOfType(Yf);if(t.length>0)t[0].detach();else{let n=this.app.workspace.getRightLeaf(!1);n&&await n.setViewState({type:Yf,active:!0})}}showReviewModal(){if(this.checkApiKey()){if(!this.reviewManager){new we.Notice("API \uD0A4\uAC00 \uC124\uC815\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4.");return}new qF(this.app,this.reviewManager,this.settings).open()}}async connectGoogleCalendar(){this.googleCalendar||(this.googleCalendar=new Wy(this.app,this.settings,()=>this.saveSettings())),await this.googleCalendar.startOAuth()}async disconnectGoogleCalendar(){this.googleCalendar&&await this.googleCalendar.disconnect()}async detectAndSaveSchedules(t,n){if(this.settings.scheduleDetectionEnabled&&!(!this.gemini||!this.scheduleManager))try{let i=Xo(this.settings.timezone),r=await this.gemini.detectSchedules(t,i);if(r.length===0)return;n&&r.forEach(u=>u.sourceNote=n.basename);let a=await new w0(this.app,r,this.settings,u=>{this.feedbackManager&&this.feedbackManager.addFeedback({timestamp:new Date().toISOString(),type:"schedule_detection",noteTitle:n?.basename||"Unknown",aiSuggestion:{schedules:u.allSchedules},userChoice:{accepted:u.accepted,rejectedItems:u.rejectedSchedules?.map(h=>h.title),dismissed:u.dismissed}})}).openAndWait();if(!a||a.selectedSchedules.length===0)return;let l=0,c=0;if(a.saveToDaily&&(l=await this.scheduleManager.saveToDaily(a.selectedSchedules)),a.saveToGoogle&&this.googleCalendar&&this.googleCalendar.isConnected()&&(c=await this.googleCalendar.saveSchedules(a.selectedSchedules)),a.moveToArchives&&n){let u=`${this.settings.archivesFolder}/${n.name}`;await this.app.fileManager.renameFile(n,u),new we.Notice("\uC6D0\uBCF8 \uB178\uD2B8\uAC00 Archives\uB85C \uC774\uB3D9\uB418\uC5C8\uC2B5\uB2C8\uB2E4.")}let d=[];l>0&&d.push(`Daily Notes: ${l}\uAC1C`),c>0&&d.push(`Google Calendar: ${c}\uAC1C`),d.length>0&&new we.Notice(`\uC77C\uC815 \uC800\uC7A5\uB428
${d.join(", ")}`)}catch(i){console.error("\uC77C\uC815 \uAC10\uC9C0 \uC2E4\uD328:",i)}}async rebuildZKIndex(){if(!this.zkIndexManager){new we.Notice("API \uD0A4\uAC00 \uC124\uC815\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4.");return}new we.Notice("ZK Index \uC7AC\uAD6C\uCD95 \uC911...");try{await this.zkIndexManager.rebuildIndex();let t=this.relatedNoteFinder?.getZettelCount()||0;new we.Notice(`ZK Index \uC7AC\uAD6C\uCD95 \uC644\uB8CC: ${t}\uAC1C \uB178\uD2B8`)}catch(t){console.error("ZK Index \uC7AC\uAD6C\uCD95 \uC2E4\uD328:",t),new we.Notice(`\uC7AC\uAD6C\uCD95 \uC2E4\uD328: ${t}`)}}async smartSplitCurrentFile(){if(!this.checkApiKey())return;let t=this.app.workspace.getActiveFile();if(!t){new we.Notice("\uC5F4\uB9B0 \uD30C\uC77C\uC774 \uC5C6\uC2B5\uB2C8\uB2E4");return}if(t.extension!=="md"){new we.Notice("\uB9C8\uD06C\uB2E4\uC6B4 \uD30C\uC77C\uB9CC \uBD84\uB9AC\uD560 \uC218 \uC788\uC2B5\uB2C8\uB2E4");return}new we.Notice("\uBA54\uBAA8 \uBD84\uC11D \uC911...");try{let n=await this.app.vault.read(t),i=this.mocManager?.getProjectList()||[],r=await this.gemini.splitContent(n,i);if(r.length===0){new we.Notice("\uBD84\uB9AC\uD560 \uB0B4\uC6A9\uC774 \uC5C6\uC2B5\uB2C8\uB2E4");return}if(r.length===1){new we.Notice("\uB2E8\uC77C \uC8FC\uC81C\uB85C \uD310\uB2E8\uB428. \uC77C\uBC18 \uD504\uB85C\uC81D\uD2B8 \uBD84\uB958\uB97C \uC0AC\uC6A9\uD558\uC138\uC694.");return}new WF(this.app,r,t,this).open()}catch(n){console.error("\uC2A4\uB9C8\uD2B8 \uBD84\uB9AC \uC2E4\uD328:",n),new we.Notice(`\uBD84\uB9AC \uC2E4\uD328: ${n}`)}}async createSplitNotes(t,n){let i=[];for(let o of t){let a=this.getTargetFolder(o.targetType,o.project);if(o.project&&!o.project.startsWith("NEW:")){let h=`${this.settings.projectsFolder}/${o.project}`;this.app.vault.getAbstractFileByPath(h)instanceof we.TFolder&&(a=h)}let l=Xr(o.title),c=`${a}/${l}.md`,d=`---
targetType: ${o.targetType}
keywords: [${o.keywords.join(", ")}]
source: "[[${n.basename}]]"
created: ${Ps(this.settings.timezone,this.settings.dateFormat)}
${o.project?`project: "${o.project}"`:""}
---

# ${o.title}

${o.content}
`;this.app.vault.getAbstractFileByPath(a)||await this.app.vault.createFolder(a);try{let h=await this.app.vault.create(c,d);if(i.push(o.title),this.relatedNoteFinder&&await this.relatedNoteFinder.updateIndex(h),o.project&&this.mocManager)if(o.project.startsWith("NEW:")){let p=o.project.slice(4).trim();await this.mocManager.createProjectMOC(p,this.settings.projectsFolder)&&await this.mocManager.addNoteToMOC(p,o.title,h.path)}else await this.mocManager.addNoteToMOC(o.project,o.title,h.path)}catch(h){console.error(`\uB178\uD2B8 \uC0DD\uC131 \uC2E4\uD328: ${o.title}`,h)}}let r=`${this.settings.archivesFolder}/${n.name}`;try{this.app.vault.getAbstractFileByPath(this.settings.archivesFolder)||await this.app.vault.createFolder(this.settings.archivesFolder),await this.app.fileManager.renameFile(n,r)}catch(o){console.error("\uC6D0\uBCF8 \uD30C\uC77C \uC774\uB3D9 \uC2E4\uD328:",o)}new we.Notice(`${i.length}\uAC1C \uB178\uD2B8 \uC0DD\uC131\uB428, \uC6D0\uBCF8\uC740 Archives\uB85C \uC774\uB3D9`)}showCreateMOCModal(){new VF(this.app,this.mocManager,this.settings.projectsFolder).open()}showURLImportModal(){this.checkApiKey()&&new GF(this.app,"URL \uAC00\uC838\uC624\uAE30","\uC720\uD29C\uBE0C \uB610\uB294 \uC6F9\uD398\uC774\uC9C0 URL\uC744 \uC785\uB825\uD558\uC138\uC694 (\uC790\uB3D9 \uAC10\uC9C0)","https://...",async t=>{await this.processURL(t)}).open()}async processURL(t){/(?:youtube\.com|youtu\.be)/.test(t)?await this.processYouTube(t):await this.processWebPage(t)}async processYouTube(t){if(!(!this.youtubeExtractor||!this.gemini)){new we.Notice("\uC720\uD29C\uBE0C \uC601\uC0C1 \uBD84\uC11D \uC911...");try{let n=await this.youtubeExtractor.processVideo(t),i=this.youtubeExtractor.generateMarkdownNote(n),r=Xr(n.title),o=`${r}.md`,a=`${this.settings.inboxFolder}/${o}`,l=await this.app.vault.create(a,i);new we.Notice(`\uC720\uD29C\uBE0C \uB178\uD2B8 \uC0DD\uC131: ${r}`);let c=this.mocManager?.getProjectList()||[],d=this.feedbackManager?.generatePromptContext(),u=await this.gemini.classifyProject(i,c,d);l=await this.applyClassifyResultWithConfirmation(l,u),this.showFileCreatedNotice(l,"\u{1F3AC}"),this.app.workspace.getLeaf().openFile(l),this.relatedNoteFinder&&await this.findAndShowRelatedNotes(l,i,u.title)}catch(n){console.error("\uC720\uD29C\uBE0C \uCC98\uB9AC \uC624\uB958:",n),new we.Notice(`\uC720\uD29C\uBE0C \uCC98\uB9AC \uC2E4\uD328: ${n}`)}}}async processWebPage(t){if(!(!this.webPageExtractor||!this.gemini)){new we.Notice("\uC6F9\uD398\uC774\uC9C0 \uBCF8\uBB38 \uCD94\uCD9C \uC911...");try{let n=await this.webPageExtractor.processUrl(t),i=this.webPageExtractor.generateMarkdownNote(n),r=Xr(n.title),o=`${r}.md`,a=`${this.settings.inboxFolder}/${o}`,l=await this.app.vault.create(a,i);new we.Notice(`\uC6F9\uD398\uC774\uC9C0 \uB178\uD2B8 \uC0DD\uC131: ${r}`);let c=this.mocManager?.getProjectList()||[],d=this.feedbackManager?.generatePromptContext(),u=await this.gemini.classifyProject(i,c,d);l=await this.applyClassifyResultWithConfirmation(l,u),this.showFileCreatedNotice(l,"\u{1F310}"),this.app.workspace.getLeaf().openFile(l),this.relatedNoteFinder&&await this.findAndShowRelatedNotes(l,i,u.title)}catch(n){console.error("\uC6F9\uD398\uC774\uC9C0 \uCC98\uB9AC \uC624\uB958:",n),new we.Notice(`\uC6F9\uD398\uC774\uC9C0 \uCC98\uB9AC \uC2E4\uD328: ${n}`)}}}async classifyCurrentFile(){if(!this.checkApiKey())return;let t=this.app.workspace.getActiveFile();if(!t){new we.Notice("\uC5F4\uB9B0 \uD30C\uC77C\uC774 \uC5C6\uC2B5\uB2C8\uB2E4");return}let n=t.extension.toLowerCase(),i=["pdf","png","jpg","jpeg","webp","gif"];if(RI.includes(n)){if(!this.meetingProcessor){new we.Notice("\uD68C\uC758\uB85D \uD504\uB85C\uC138\uC11C\uB97C \uCD08\uAE30\uD654\uD560 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4");return}new we.Notice("\uD68C\uC758\uB85D \uBD84\uC11D \uC911...");try{let r=await this.meetingProcessor.processAudio(t),o=this.meetingProcessor.generateMarkdownNote(r),a=`\uD68C\uC758\uB85D_${Xr(r.title)}.md`,l=`${this.settings.inboxFolder}/${a}`,c=await this.app.vault.create(l,o);if(this.settings.ocrMoveOriginal){let f=this.settings.ocrOriginalFolder;this.app.vault.getAbstractFileByPath(f)||await this.app.vault.createFolder(f);let b=`${f}/${t.name}`;await this.app.fileManager.renameFile(t,b)}let d=this.mocManager?.getProjectList()||[],u=this.feedbackManager?.generatePromptContext(),h=await this.gemini.classifyProject(o,d,u),p=await this.applyClassifyResultWithConfirmation(c,h);this.showFileCreatedNotice(p,"\u{1F399}\uFE0F"),await this.findAndShowRelatedNotes(p,o,r.title),await this.detectAndSaveSchedules(o,p)}catch(r){console.error("\uD68C\uC758\uB85D \uBD84\uC11D \uC624\uB958:",r),new we.Notice(`\uD68C\uC758\uB85D \uBD84\uC11D \uC2E4\uD328: ${r}`)}return}if(i.includes(n)){if(!this.settings.ocrEnabled){new we.Notice("OCR \uAE30\uB2A5\uC774 \uBE44\uD65C\uC131\uD654\uB418\uC5B4 \uC788\uC2B5\uB2C8\uB2E4");return}if(!this.ocrProcessor){new we.Notice("OCR \uD504\uB85C\uC138\uC11C\uB97C \uCD08\uAE30\uD654\uD560 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4");return}let r=await this.ocrProcessor.checkLimits(t);if(!r.allowed){new ib(this.app,r.reason,t,this).open();return}new we.Notice("\uCC98\uB9AC \uC911: OCR \u2192 AI \uC694\uC57D \u2192 \uD504\uB85C\uC81D\uD2B8 \uBD84\uB958...");try{let o=await this.ocrProcessor.processFile(t);new we.Notice("AI \uC694\uC57D \uC0DD\uC131 \uC911...");let a=await this.gemini.summarizePDF(o.text,this.settings.detailedSummary),l=this.ocrProcessor.generateSummarizedNote(o,a),c=t.basename+"_OCR.md",d=`${this.settings.inboxFolder}/${c}`,u=await this.app.vault.create(d,l);if(this.settings.ocrMoveOriginal){let b=this.settings.ocrOriginalFolder;this.app.vault.getAbstractFileByPath(b)||await this.app.vault.createFolder(b);let w=`${b}/${t.name}`;await this.app.fileManager.renameFile(t,w)}let h=this.mocManager?.getProjectList()||[],p=this.feedbackManager?.generatePromptContext(),f=await this.gemini.classifyProject(l,h,p),_=await this.applyClassifyResultWithConfirmation(u,f);if(f.title&&_){let b=Xr(f.title),y=_.parent?.path||"",w=y?`${y}/${b}.md`:`${b}.md`;w!==_.path&&await this.app.fileManager.renameFile(_,w)}new we.Notice(`\uC644\uB8CC: OCR(${o.pages}p) \u2192 ${f.targetType}${f.projectName?` (${f.projectName})`:""}`),await this.findAndShowRelatedNotes(_,l,f.title),await this.detectAndSaveSchedules(l,_)}catch(o){console.error("\uCC98\uB9AC \uC624\uB958:",o),new we.Notice(`\uCC98\uB9AC \uC2E4\uD328: ${o}`)}return}if(n==="md"){try{let r=await this.app.vault.read(t),o=this.extractEmbeddedImages(r);if(o.length>0&&this.settings.ocrEnabled&&this.ocrProcessor){new we.Notice(`\uC784\uBCA0\uB4DC\uB41C \uC774\uBBF8\uC9C0 ${o.length}\uC7A5 \uAC10\uC9C0\uB428. OCR \uCC98\uB9AC \uC911...`);let a=this.ocrProcessor.checkLimitsForMultipleImages(o);if(!a.allowed){new we.Notice(`OCR \uC81C\uD55C: ${a.reason}`),await this.classifyMarkdownContent(t,r);return}let l=await this.ocrProcessor.processMultipleImages(o,t.basename);new we.Notice("AI \uC694\uC57D \uC0DD\uC131 \uC911...");let c=await this.gemini.summarizePDF(l.text,this.settings.detailedSummary),d=`---
type: ocr
source_note: "${t.basename}"
pages: ${l.pages}
---

# ${c.title}

## \uC694\uC57D
${c.summary}

## \uD575\uC2EC \uD3EC\uC778\uD2B8
${c.keyPoints.map(_=>`- ${_}`).join(`
`)}

---
## \uC6D0\uBCF8 \uC774\uBBF8\uC9C0
${o.map(_=>`![[${_.name}]]`).join(`
`)}
`;await this.app.vault.modify(t,d);let u=this.mocManager?.getProjectList()||[],h=this.feedbackManager?.generatePromptContext(),p=await this.gemini.classifyProject(d,u,h),f=await this.applyClassifyResultWithConfirmation(t,p);if(c.title&&f){let _=Xr(c.title),b=f.parent?.path||"",y=b?`${b}/${_}.md`:`${_}.md`;y!==f.path&&(await this.app.fileManager.renameFile(f,y),f=this.app.vault.getAbstractFileByPath(y))}new we.Notice(`\uC644\uB8CC: OCR(${l.pages}\uC7A5) \u2192 ${p.targetType}${p.projectName?` (${p.projectName})`:""}`),await this.findAndShowRelatedNotes(f,d,c.title),await this.detectAndSaveSchedules(d,f);return}await this.classifyMarkdownContent(t,r)}catch(r){console.error("\uD504\uB85C\uC81D\uD2B8 \uBD84\uB958 \uC624\uB958:",r),new we.Notice(`\uBD84\uB958 \uC2E4\uD328: ${r}`)}return}new we.Notice(`\uC9C0\uC6D0\uD558\uC9C0 \uC54A\uB294 \uD30C\uC77C \uD615\uC2DD\uC785\uB2C8\uB2E4: ${n}`)}async classifyMarkdownContent(t,n){new we.Notice("\uBD84\uB958 \uC911...");let i=this.truncateContent(n),r=this.mocManager?.getProjectList()||[],o=this.feedbackManager?.generatePromptContext(),a=await this.gemini.classifyProject(i,r,o),l=await this.applyClassifyResultWithConfirmation(t,a);if(["\uBB34\uC81C","untitled","\uC0C8 \uB178\uD2B8","new note"].some(u=>l.basename.toLowerCase().startsWith(u.toLowerCase()))&&a.title&&l){let u=Xr(a.title),h=l.parent?.path||"",p=h?`${h}/${u}.md`:`${u}.md`;p!==l.path&&(await this.app.fileManager.renameFile(l,p),l=this.app.vault.getAbstractFileByPath(p))}new we.Notice(`${a.targetType}${a.projectName?` (${a.projectName})`:""}\uB85C \uBD84\uB958\uB428`),await this.findAndShowRelatedNotes(l,n,a.title),await this.detectAndSaveSchedules(n,l)}async linkRelatedNotesForCurrentFile(){if(!this.checkApiKey())return;let t=this.app.workspace.getActiveFile();if(!t){new we.Notice("\uC5F4\uB9B0 \uD30C\uC77C\uC774 \uC5C6\uC2B5\uB2C8\uB2E4");return}if(t.extension!=="md"){new we.Notice("\uB9C8\uD06C\uB2E4\uC6B4 \uD30C\uC77C\uB9CC \uC9C0\uC6D0\uD569\uB2C8\uB2E4");return}new we.Notice("\uAD00\uB828 \uB178\uD2B8 \uAC80\uC0C9 \uC911...");try{let n=await this.app.vault.read(t),i=this.truncateContent(n),o=n.match(/^#\s+(.+)$/m)?.[1]||t.basename;await this.findAndShowRelatedNotes(t,i,o)}catch(n){console.error("\uAD00\uB828 \uB178\uD2B8 \uAC80\uC0C9 \uC624\uB958:",n),new we.Notice(`\uAC80\uC0C9 \uC2E4\uD328: ${n}`)}}showCommandListModal(){new jF(this.app,this).open()}showFileCreatedNotice(t,n="\u2705"){let i=new we.Notice("",3e3);i.noticeEl.empty(),i.noticeEl.style.cursor="pointer";let r=i.noticeEl.createDiv();r.style.display="flex",r.style.flexDirection="column",r.style.gap="2px";let o=r.createEl("span",{text:`${n} ${t.basename}`});o.style.fontWeight="500";let a=r.createEl("span",{text:`\u{1F4C1} ${t.parent?.path||"/"}`});a.style.fontSize="11px",a.style.opacity="0.7",i.noticeEl.addEventListener("click",()=>{this.app.workspace.openLinkText(t.path,""),i.hide()})}showSmartSearchModal(){if(!this.embeddingManager){new we.Notice("\uC784\uBCA0\uB529 \uB9E4\uB2C8\uC800\uAC00 \uCD08\uAE30\uD654\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4");return}if(!this.settings.embeddingEnabled){new we.Notice("Embedding \uAE30\uBC18 \uAC80\uC0C9\uC774 \uBE44\uD65C\uC131\uD654\uB418\uC5B4 \uC788\uC2B5\uB2C8\uB2E4. \uC124\uC815\uC5D0\uC11C \uD65C\uC131\uD654\uD558\uC138\uC694.");return}if(this.embeddingManager.getStats().totalNotes===0){new we.Notice("\uC778\uB371\uC2A4\uAC00 \uBE44\uC5B4 \uC788\uC2B5\uB2C8\uB2E4. \uC124\uC815\uC5D0\uC11C \uC778\uB371\uC2A4\uB97C \uAD6C\uCD95\uD558\uC138\uC694.");return}new E0(this.app,this.embeddingManager).open()}async runLocalEmbeddingPoC(){new we.Notice(`\u{1F9EA} PoC: \uB85C\uCEEC \uC784\uBCA0\uB529 \uD14C\uC2A4\uD2B8 \uC2DC\uC791
\uCF58\uC194(Ctrl+Shift+I)\uC5D0\uC11C \uACB0\uACFC \uD655\uC778`),console.log("=".repeat(60)),console.log("[PoC] \uB85C\uCEEC \uC784\uBCA0\uB529 \uD14C\uC2A4\uD2B8 \uC2DC\uC791"),console.log("=".repeat(60));try{await G5(),new we.Notice("\u2705 PoC \uC644\uB8CC! \uCF58\uC194\uC5D0\uC11C \uACB0\uACFC\uB97C \uD655\uC778\uD558\uC138\uC694")}catch(t){console.error("[PoC] \uC2E4\uD328:",t),new we.Notice(`\u274C PoC \uC2E4\uD328: ${t instanceof Error?t.message:String(t)}`)}}async showImageBatchModal(){if(!this.checkApiKey())return;if(!this.settings.ocrEnabled){new we.Notice("OCR \uAE30\uB2A5\uC774 \uBE44\uD65C\uC131\uD654\uB418\uC5B4 \uC788\uC2B5\uB2C8\uB2E4");return}if(!this.ocrProcessor){new we.Notice("OCR \uD504\uB85C\uC138\uC11C\uB97C \uCD08\uAE30\uD654\uD560 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4");return}let t=this.app.vault.getAbstractFileByPath(this.settings.inboxFolder);if(!t||!(t instanceof we.TFolder)){new we.Notice("Inbox \uD3F4\uB354\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4");return}let n=["png","jpg","jpeg","webp","gif"],i=[];for(let a of t.children){if(!(a instanceof we.TFile))continue;let l=a.extension.toLowerCase();n.includes(l)&&i.push(a)}if(i.length===0){new we.Notice("_Inbox\uC5D0 \uC774\uBBF8\uC9C0 \uD30C\uC77C\uC774 \uC5C6\uC2B5\uB2C8\uB2E4");return}i.sort((a,l)=>a.name.localeCompare(l.name));let o=await new T0(this.app,i,this.settings).openAndWait();!o||o.selectedFiles.length===0||await this.processImageBatch(o.selectedFiles)}async processImageBatch(t){if(!this.ocrProcessor||!this.gemini){new we.Notice("OCR/Gemini \uCD08\uAE30\uD654 \uC2E4\uD328");return}let n=this.ocrProcessor.checkLimitsForMultipleImages(t);if(!n.allowed){new we.Notice(`\uCC98\uB9AC \uBD88\uAC00: ${n.reason}`);return}try{new we.Notice(`${t.length}\uAC1C \uC774\uBBF8\uC9C0 OCR \uCC98\uB9AC \uC911...`);let i=await this.ocrProcessor.processMultipleImages(t,`\uD1B5\uD569\uCC98\uB9AC_${t.length}\uC7A5`);new we.Notice("AI \uC694\uC57D \uBC0F \uBD84\uB958 \uC911...");let r=await this.gemini.summarizePDF(i.text,this.settings.detailedSummary),o=Ps(this.settings.timezone,this.settings.dateFormat),a=`---
type: ocr
source_type: image_batch
images: ${t.length}
ocr_at: ${o}
---

# ${r.title}

## \uC694\uC57D
${r.summary}

## \uD575\uC2EC \uD3EC\uC778\uD2B8
${r.keyPoints.map(b=>`- ${b}`).join(`
`)}

---
## \uC6D0\uBCF8 \uC774\uBBF8\uC9C0
${t.map(b=>`![[${b.name}]]`).join(`
`)}
`,l=Xr(r.title),c=`${this.settings.inboxFolder}/${l}.md`,d=await this.app.vault.create(c,a);new we.Notice("\uD504\uB85C\uC81D\uD2B8 \uBD84\uB958 \uC911...");let u=this.mocManager?.getProjectList()||[],h=this.feedbackManager?.generatePromptContext(),p=await this.gemini.classifyProject(`# ${r.title}

${r.summary}

${r.keyPoints.join(`
`)}`,u,h),f=await this.applyClassifyResultWithConfirmation(d,p);if(p.title&&f){let b=Xr(p.title),y=f.parent?.path||"",w=y?`${y}/${b}.md`:`${b}.md`;w!==f.path&&(await this.app.fileManager.renameFile(f,w),f=this.app.vault.getAbstractFileByPath(w))}if(this.settings.ocrMoveOriginal){let b=this.settings.ocrOriginalFolder;this.app.vault.getAbstractFileByPath(b)||await this.app.vault.createFolder(b);for(let w of t){let C=`${b}/${w.name}`;try{await this.app.fileManager.renameFile(w,C)}catch(M){console.error(`\uC774\uBBF8\uC9C0 \uC774\uB3D9 \uC2E4\uD328: ${w.name}`,M)}}new we.Notice(`\uC6D0\uBCF8 \uC774\uBBF8\uC9C0 ${t.length}\uC7A5\uC774 Archives\uB85C \uC774\uB3D9\uB428`)}this.showFileCreatedNotice(f,"\u{1F5BC}\uFE0F"),await this.app.workspace.openLinkText(f.path,"");let _=await this.app.vault.read(f);await this.findAndShowRelatedNotes(f,_,p.title),await this.detectAndSaveSchedules(_,f)}catch(i){console.error("\uC774\uBBF8\uC9C0 \uBC30\uCE58 \uCC98\uB9AC \uC2E4\uD328:",i),new we.Notice(`\uCC98\uB9AC \uC2E4\uD328: ${i}`)}}async applyClassifyResult(t,n){let i=await this.app.vault.read(t),r=this.updateFrontmatter(i,{targetType:n.targetType,project:n.projectName||void 0,title:n.title,summary:n.summary,next_action:n.nextAction||void 0,processed_at:Ps(this.settings.timezone,this.settings.dateFormat)});await this.app.vault.modify(t,r);let o=this.getTargetFolder(n.targetType,n.projectName);if(o){this.app.vault.getAbstractFileByPath(o)||await this.app.vault.createFolder(o);let l=`${o}/${t.name}`;await this.app.fileManager.renameFile(t,l);let c=this.app.vault.getAbstractFileByPath(l);if(c instanceof we.TFile)return c}return t}async applyClassifyResultWithConfirmation(t,n){if(n.shouldRestructure&&n.restructuredContent){let r=this.feedbackManager?.getPreferences();if(r){let o=r.restructure,a=o.accepted+o.rejected;if(o.preference==="restructure"&&o.accepted>=uv)new we.Notice(`\u2728 \uCF58\uD150\uCE20 \uC790\uB3D9 \uC7AC\uAD6C\uC131 (\uD559\uC2B5\uB41C \uC120\uD638\uB3C4: ${o.accepted}/${a}\uD68C)`),await this.applyRestructuredContent(t,n.restructuredContent);else if(o.preference==="original"&&o.rejected>=uv)new we.Notice(`\u{1F4C4} \uC6D0\uBCF8 \uC720\uC9C0 (\uD559\uC2B5\uB41C \uC120\uD638\uB3C4: ${o.rejected}/${a}\uD68C)`);else{let l=await this.app.vault.read(t);await this.showRestructureModal(t,n,l)&&await this.applyRestructuredContent(t,n.restructuredContent)}}else{let o=await this.app.vault.read(t);await this.showRestructureModal(t,n,o)&&await this.applyRestructuredContent(t,n.restructuredContent)}}if(n.contentType!=="reference"||!n.projectName)return this.applyClassifyResult(t,n);let i=this.feedbackManager?.getPreferences();if(i){let r=i.feedback.referenceLocation,o=r.toLibrary+r.toProject;if(r.preference==="library"&&r.toLibrary>=uv){new we.Notice(`\u{1F4DA} Library\uC5D0 \uC790\uB3D9 \uC800\uC7A5 (\uD559\uC2B5\uB41C \uC120\uD638\uB3C4: ${r.toLibrary}/${o}\uD68C)`);let a={...n,targetType:"library"};return this.applyClassifyResult(t,a)}if(r.preference==="project"&&r.toProject>=uv){new we.Notice(`\u{1F4C1} \uD504\uB85C\uC81D\uD2B8\uC5D0 \uC790\uB3D9 \uC800\uC7A5 (\uD559\uC2B5\uB41C \uC120\uD638\uB3C4: ${r.toProject}/${o}\uD68C)`);let a={...n,targetType:"project"};return this.applyClassifyResult(t,a)}}return new Promise(r=>{new HF(this.app,n,async o=>{let a={...n};o==="library"?(a={...n,targetType:"library"},new we.Notice(`Library\uC5D0 \uC800\uC7A5 + ${n.projectName} \uD504\uB85C\uC81D\uD2B8 \uB9C1\uD06C`)):a={...n,targetType:"project"};let l=await this.applyClassifyResult(t,a);r(l)},this.feedbackManager).open()})}showRestructureModal(t,n,i){return new Promise(r=>{new M0(this.app,n,i,o=>{r(o)},this.feedbackManager).open()})}async applyRestructuredContent(t,n){let r=(await this.app.vault.read(t)).match(/^---\n([\s\S]*?)\n---\n?/),a=(r?r[0]:"")+n;await this.app.vault.modify(t,a)}async findAndShowRelatedNotes(t,n,i){if(!this.relatedNoteFinder||!this.gemini)return;let r=this.truncateContent(n);try{let o=await this.gemini.extractKeywords(r);o.length>0&&this.relatedNoteFinder&&await this.relatedNoteFinder.saveKeywordsToNote(t,o),this.mocManager&&this.mocManager.getMOCCount()>0&&await this.handleProjectMOC(t,i,o),new we.Notice("\uAD00\uB828 \uB178\uD2B8 \uAC80\uC0C9 \uC911...");let a=await this.relatedNoteFinder.findRelated(r,i,t.path);a.length>0?new zF(this.app,a,t,this.relatedNoteFinder,this.feedbackManager).open():o.length>0&&new we.Notice(`\uD0A4\uC6CC\uB4DC ${o.length}\uAC1C \uC800\uC7A5\uB428`)}catch(o){console.error("\uAD00\uB828 \uB178\uD2B8 \uAC80\uC0C9 \uC624\uB958:",o)}}async handleProjectMOC(t,n,i){if(!(!this.mocManager||!this.gemini))try{let r=await this.mocManager.detectProject(n,i);if(!r)return;if(r.startsWith("NEW:")){let a=r.slice(4).trim();new UF(this.app,a,t,n,this.mocManager,this.settings.projectsFolder).open();return}await this.mocManager.addNoteToMOC(r,n,t.path)&&new we.Notice(`\u{1F4C1} ${r} MOC\uC5D0 \uC5F0\uACB0\uB428`)}catch(r){console.error("MOC \uC5F0\uACB0 \uC624\uB958:",r)}}getTargetFolder(t,n){switch(t){case"project":return n?`${this.settings.projectsFolder}/${n}`:this.settings.projectsFolder;case"library":return this.settings.libraryFolder;case"archive":return this.settings.archivesFolder;default:return this.settings.libraryFolder}}updateFrontmatter(t,n){let i=/^---\n([\s\S]*?)\n---\n?/,r=t.match(i),o="",a=t;r&&(o=r[1],a=t.slice(r[0].length));let l=o.split(`
`).filter(u=>u.trim()),c=new Map;for(let u of l){let h=u.indexOf(":");if(h!==-1){let p=u.slice(0,h).trim(),f=u.slice(h+1).trim();c.set(p,f)}}for(let[u,h]of Object.entries(n))if(h!==void 0){let f=/[:\[\]{}#&*!|>'"%@`]/.test(h)&&!h.startsWith('"')?`"${h.replace(/"/g,'\\"')}"`:h;c.set(u,f)}return`---
${Array.from(c.entries()).map(([u,h])=>`${u}: ${h}`).join(`
`)}
---
${a}`}async extractZKFromCurrentFile(){if(!this.checkApiKey())return;let t=this.app.workspace.getActiveFile();if(!t){new we.Notice("\uC5F4\uB9B0 \uD30C\uC77C\uC774 \uC5C6\uC2B5\uB2C8\uB2E4");return}new we.Notice("ZK \uC544\uC774\uB514\uC5B4 \uCD94\uCD9C \uC911...");try{let n=await this.app.vault.read(t),i=await this.gemini.extractZK(n);if(i.length===0){new we.Notice("\uCD94\uCD9C\uD560 \uC544\uC774\uB514\uC5B4\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4");return}new OF(this.app,i,t,this).open()}catch(n){console.error("ZK \uCD94\uCD9C \uC624\uB958:",n),new we.Notice(`\uCD94\uCD9C \uC2E4\uD328: ${n}`)}}initializeZKCounters(){if(!this.relatedNoteFinder)return;let t=this.relatedNoteFinder.getZettelIndex();for(let[n]of t){let r=(n.split("/").pop()||"").match(/^(\d{8})-(\d{3})/);if(r){let o=r[1],a=parseInt(r[2],10),l=this.zkDailyCounter.get(o)||0;a>l&&this.zkDailyCounter.set(o,a)}this.zkLuhmannCounter=Math.max(this.zkLuhmannCounter,t.size)}console.log(`ZK \uCE74\uC6B4\uD130 \uCD08\uAE30\uD654: \uB8E8\uB9CC=${this.zkLuhmannCounter}, \uC77C\uBCC4=${this.zkDailyCounter.size}\uAC1C \uB0A0\uC9DC`)}generateZKId(){switch(this.settings.zkIdType){case"timestamp":return Date.now().toString();case"date-sequence":{let n=Xo(this.settings.timezone).replace(/-/g,""),i=(this.zkDailyCounter.get(n)||0)+1;return this.zkDailyCounter.set(n,i),`${n}-${i.toString().padStart(3,"0")}`}case"luhmann":return this.zkLuhmannCounter++,this.toLuhmannId(this.zkLuhmannCounter);default:return Date.now().toString()}}toLuhmannId(t){if(t<=0)return"1";let n=[],i=t,r=0;for(;i>0;){if(r%2===0){let o=(i-1)%9+1;n.push(o.toString()),i=Math.floor((i-1)/9)}else{let o=(i-1)%26;n.push(String.fromCharCode(97+o)),i=Math.floor((i-1)/26)}r++}return n.reverse().join("")}async createZKNotes(t,n){let i=this.settings.zettelFolder;this.app.vault.getAbstractFileByPath(i)||await this.app.vault.createFolder(i);let o=[],a=[],l=0;for(let d of t){let h=(await this.relatedNoteFinder.findRelatedZettels(d.keywords)).find(w=>w.relevance>=this.settings.zkMergeThreshold);if(h&&await this.showMergeConfirmModal(d,h)){await this.mergeToExistingZK(h.note.path,d,n),a.push(d.title);continue}let p=this.generateZKId(),f=Xr(d.title),_=`${i}/${p} ${f}.md`,b=`---
type: zettel
source: "[[${n.basename}]]"
keywords: [${d.keywords.join(", ")}]
created: ${Ps(this.settings.timezone,this.settings.dateFormat)}
---

# ${d.title}

## \uD575\uC2EC \uC544\uC774\uB514\uC5B4
${d.body}

## \uC65C \uC911\uC694\uD55C\uAC00?
${d.importance||""}

## \uB9E5\uB77D
- **\uC6D0\uBCF8**: [[${n.basename}]]
- **\uAD00\uB828 \uAC1C\uB150**: ${d.relatedConcepts?.join(", ")||""}

---
## \uC5F0\uACB0\uB41C \uB178\uD2B8
- [[${n.basename}]] (\uC6D0\uBCF8)
`;await this.app.vault.create(_,b),o.push(d.title);let y=this.app.vault.getAbstractFileByPath(_);if(y instanceof we.TFile){await this.relatedNoteFinder.updateIndex(y);let w=await this.relatedNoteFinder.findRelatedZettels(d.keywords,_);w.length>0&&(await this.addZKRelatedLinks(y,w),await this.addBacklinksToZettels(y,w),l+=w.length),this.zkIndexManager&&await this.zkIndexManager.updateIndex(y,d.keywords)}await new Promise(w=>setTimeout(w,10))}let c=[];o.length>0&&c.push(`${o.length}\uAC1C \uC0DD\uC131`),a.length>0&&c.push(`${a.length}\uAC1C \uBCD1\uD569`),l>0&&c.push(`${l}\uAC1C \uC5F0\uACB0`),new we.Notice(`ZK \uB178\uD2B8: ${c.join(", ")}`)}showMergeConfirmModal(t,n){return new Promise(i=>{new $F(this.app,t,n,o=>i(o)).open()})}async mergeToExistingZK(t,n,i){let r=this.app.vault.getAbstractFileByPath(t);if(!(r instanceof we.TFile))return;let o=await this.app.vault.read(r),a=`

---
## \uCD94\uAC00\uB41C \uB0B4\uC6A9 (${new Date().toLocaleDateString()})
*\uC6D0\uBCF8: [[${i.basename}]]*

${n.body}
`,l=/(\n---\n##  )/,c;l.test(o)?c=o.replace(l,`${a}$1`):c=o+a;let d=this.extractKeywordsFromFrontmatter(o),u=[...new Set([...d,...n.keywords])];c=this.updateFrontmatterKeywordsInContent(c,u),await this.app.vault.modify(r,c),await this.relatedNoteFinder.updateIndex(r)}extractKeywordsFromFrontmatter(t){let n=t.match(/^---\n[\s\S]*?keywords:\s*\[(.*?)\][\s\S]*?---/);return n?n[1].split(",").map(i=>i.trim().replace(/^["']|["']$/g,"")).filter(i=>i.length>0):[]}updateFrontmatterKeywordsInContent(t,n){let i=`keywords: [${n.join(", ")}]`;return t.replace(/^(---\n[\s\S]*?)(keywords:\s*\[.*?\])([\s\S]*?---)/,`$1${i}$3`)}async addZKRelatedLinks(t,n){if(n.length===0)return;let i=await this.app.vault.read(t),r=n.map(c=>{let d=c.note.path.split("/"),h=d[d.length-1].replace(/\.md$/,""),p=c.reason?`
  \u2192 ${c.reason}`:"";return`- [[${h}]] (${Math.round(c.relevance*100)}%)${p}`}).join(`
`),o=/(---\n##  \n[\s\S]*?)(\n---|\n*$)/,a=i.match(o),l;a?l=i.replace(o,`$1
${r}$2`):l=i+`
---
## \uC5F0\uACB0\uB41C \uB178\uD2B8
${r}
`,await this.app.vault.modify(t,l)}async addBacklinksToZettels(t,n){for(let i of n){let r=this.app.vault.getAbstractFileByPath(i.note.path);if(!(r instanceof we.TFile))continue;let o=await this.app.vault.read(r);if(o.includes(`[[${t.basename}]]`))continue;let a=i.reason?`
  \u2192 ${i.reason}`:"",l=`- [[${t.basename}]] (${Math.round(i.relevance*100)}%)${a}`,c=/(---\n##  \n[\s\S]*?)(\n---|\n*$)/,d=o.match(c),u;d?u=o.replace(c,`$1
${l}$2`):u=o+`
---
## \uC5F0\uACB0\uB41C \uB178\uD2B8
${l}
`,await this.app.vault.modify(r,u)}}async showFocusTop3(){if(this.checkApiKey()){new we.Notice("\uD504\uB85C\uC81D\uD2B8 \uBD84\uC11D \uC911...");try{let t=this.app.vault.getAbstractFileByPath(this.settings.projectsFolder);if(!t||!(t instanceof we.TFolder)){new we.Notice("Projects \uD3F4\uB354\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4");return}let n=await this.collectProjectsSummary(t);if(!n){new we.Notice("\uC9C4\uD589 \uC911\uC778 \uD504\uB85C\uC81D\uD2B8\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4");return}let i=await this.gemini.getFocus(n);if(i.length===0){new we.Notice("\uCD94\uCC9C\uD560 \uD504\uB85C\uC81D\uD2B8\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4");return}new BF(this.app,i).open()}catch(t){console.error("Focus \uBD84\uC11D \uC624\uB958:",t),new we.Notice(`\uBD84\uC11D \uC2E4\uD328: ${t}`)}}}async collectProjectsSummary(t){let n=[];for(let i of t.children)if(i instanceof we.TFolder){let r=i.name,o=await this.getProjectInfo(i);n.push(`- ${r}: ${o}`)}return n.join(`
`)}async getProjectInfo(t){let n=[`${t.name} (MOC).md`,`${t.name} MOC.md`,"MOC.md","README.md"];for(let a of n){let l=`${t.path}/${a}`,c=this.app.vault.getAbstractFileByPath(l);if(c instanceof we.TFile){let d=await this.app.vault.read(c),u=this.extractFrontmatter(d),h=u.summary||u.description||"",p=u.next_action||u.nextAction||"";if(h||p)return`${h} (\uB2E4\uC74C: ${p})`}}let i=[];for(let a of t.children)a instanceof we.TFile&&a.extension==="md"&&i.push({file:a,mtime:a.stat.mtime});i.sort((a,l)=>l.mtime-a.mtime);let r=i.slice(0,3);return r.length===0?"(\uB178\uD2B8 \uC5C6\uC74C)":`\uCD5C\uADFC \uC791\uC5C5: ${r.map(a=>a.file.basename).join(", ")}`}extractFrontmatter(t){let n=/^---\n([\s\S]*?)\n---/,i=t.match(n);if(!i)return{};let r={},o=i[1].split(`
`);for(let a of o){let l=a.indexOf(":");if(l!==-1){let c=a.slice(0,l).trim(),d=a.slice(l+1).trim();r[c]=d}}return r}async processInbox(){if(!this.checkApiKey())return;let t=this.app.vault.getAbstractFileByPath(this.settings.inboxFolder);if(!t||!(t instanceof we.TFolder)){new we.Notice("Inbox \uD3F4\uB354\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4");return}let n=0,i=0,r=this.settings.triggerTag,o=[];for(let c of t.children)c instanceof we.TFile&&c.extension==="md"&&(await this.app.vault.read(c)).includes(r)&&o.push(c);if(o.length===0){new we.Notice("\uCC98\uB9AC\uD560 \uD30C\uC77C\uC774 \uC5C6\uC2B5\uB2C8\uB2E4");return}new we.Notice(`${o.length}\uAC1C \uD30C\uC77C \uCC98\uB9AC \uC2DC\uC791...`);let a=this.mocManager?.getProjectList()||[],l=this.feedbackManager?.generatePromptContext();for(let c=0;c<o.length;c++){let d=o[c];try{new we.Notice(`\uCC98\uB9AC \uC911: ${c+1}/${o.length} - ${d.name}`,2e3);let u=await this.app.vault.read(d),h=await this.gemini.classifyProject(u,a,l);await this.applyClassifyResult(d,h),n++}catch(u){console.error(`\uCC98\uB9AC \uC2E4\uD328: ${d.name}`,u),i++}}new we.Notice(`\uC644\uB8CC: ${n}\uAC1C \uCC98\uB9AC, ${i}\uAC1C \uC2E4\uD328`)}toggleWatch(){this.watcherRegistered?(this.stopWatcher(),new we.Notice("Watch \uC911\uC9C0\uB428")):(this.startWatcher(),new we.Notice("Watch \uC2DC\uC791\uB428"))}startWatcher(){this.watcherRegistered||(this.registerEvent(this.app.vault.on("create",t=>{t instanceof we.TFile&&(this.onFileChange(t),this.scheduleEmbeddingUpdate(t))})),this.registerEvent(this.app.vault.on("modify",t=>{t instanceof we.TFile&&(this.onFileChange(t),this.scheduleEmbeddingUpdate(t))})),this.registerEvent(this.app.vault.on("delete",t=>{t instanceof we.TFile&&(this.relatedNoteFinder?.removeFromIndex(t.path),this.mocManager?.removeFromIndex(t.path),this.embeddingManager?.removeNote(t.path),this.embeddingManager?.saveIndex(),console.log(`\uC778\uB371\uC2A4\uC5D0\uC11C \uC81C\uAC70: ${t.path}`))})),this.registerEvent(this.app.vault.on("rename",(t,n)=>{t instanceof we.TFile&&(this.embeddingManager?.renameNote(n,t.path),this.embeddingManager?.saveIndex())})),this.watcherRegistered=!0,console.log("Inbox \uAC10\uC2DC \uC2DC\uC791"))}stopWatcher(){this.watcherRegistered=!1,this.pendingFiles.clear(),console.log("Inbox \uAC10\uC2DC \uC911\uC9C0")}scheduleEmbeddingUpdate(t){if(!this.settings.embeddingEnabled||!this.settings.autoEmbeddingEnabled||!this.embeddingManager||t.extension!=="md")return;let n=this.pendingEmbeddings.get(t.path);n&&clearTimeout(n);let i=setTimeout(async()=>{this.pendingEmbeddings.delete(t.path),await this.embeddingManager?.updateNoteEmbedding(t,!1)&&(await this.embeddingManager?.saveIndex(),console.log("Embedding \uC790\uB3D9 \uC5C5\uB370\uC774\uD2B8:",t.path))},5e3);this.pendingEmbeddings.set(t.path,i)}onFileChange(t){this.watcherRegistered&&this.gemini&&t.path.startsWith(this.settings.inboxFolder)&&t.extension==="md"&&(this.pendingFiles.set(t.path,Date.now()),this.processDebounced())}async processPendingFiles(){if(!this.gemini)return;let t=Date.now(),n=this.settings.triggerTag,i=this.mocManager?.getProjectList()||[],r=this.feedbackManager?.generatePromptContext();for(let[o,a]of this.pendingFiles.entries()){if(t-a<3e3)continue;this.pendingFiles.delete(o);let l=this.app.vault.getAbstractFileByPath(o);if(l instanceof we.TFile)try{let c=await this.app.vault.read(l);if(!c.includes(n))continue;let d=await this.gemini.classifyProject(c,i,r);await this.applyClassifyResult(l,d),new we.Notice(`\uC790\uB3D9 \uBD84\uB958: ${l.name} \u2192 ${d.targetType}${d.projectName?` (${d.projectName})`:""}`)}catch(c){console.error(`\uC790\uB3D9 \uBD84\uB958 \uC2E4\uD328: ${o}`,c)}}}async ocrCurrentFile(){if(!this.checkApiKey())return;if(!this.settings.ocrEnabled){new we.Notice("OCR \uAE30\uB2A5\uC774 \uBE44\uD65C\uC131\uD654\uB418\uC5B4 \uC788\uC2B5\uB2C8\uB2E4");return}if(!this.ocrProcessor){new we.Notice("OCR \uD504\uB85C\uC138\uC11C\uB97C \uCD08\uAE30\uD654\uD560 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4");return}let t=this.app.workspace.getActiveFile();if(!t){new we.Notice("\uC5F4\uB9B0 \uD30C\uC77C\uC774 \uC5C6\uC2B5\uB2C8\uB2E4");return}let n=t.extension.toLowerCase();if(n==="md"){try{let o=await this.app.vault.read(t),a=this.extractEmbeddedImages(o);if(a.length===0){new we.Notice("\uC784\uBCA0\uB4DC\uB41C \uC774\uBBF8\uC9C0\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4");return}new we.Notice(`\uC784\uBCA0\uB4DC\uB41C \uC774\uBBF8\uC9C0 ${a.length}\uC7A5 OCR \uCC98\uB9AC \uC911...`);let l=this.ocrProcessor.checkLimitsForMultipleImages(a);if(!l.allowed){new we.Notice(`OCR \uC81C\uD55C: ${l.reason}`);return}let c=await this.ocrProcessor.processMultipleImages(a,t.basename),u=this.ocrProcessor.generateMarkdownNote(c)+`
---
## \uC6D0\uBCF8 \uC774\uBBF8\uC9C0
${a.map(h=>`![[${h.name}]]`).join(`
`)}`;await this.app.vault.modify(t,u),new we.Notice(`OCR \uC644\uB8CC: ${a.length}\uC7A5 \uCC98\uB9AC\uB428`)}catch(o){console.error("OCR \uC624\uB958:",o),new we.Notice(`OCR \uC2E4\uD328: ${o}`)}return}if(!["png","jpg","jpeg","webp","gif","pdf"].includes(n)){new we.Notice(`\uC9C0\uC6D0\uD558\uC9C0 \uC54A\uB294 \uD30C\uC77C \uD615\uC2DD\uC785\uB2C8\uB2E4: ${n}`);return}let r=await this.ocrProcessor.checkLimits(t);if(!r.allowed){new ib(this.app,r.reason,t,this).open();return}new we.Notice("OCR \uCC98\uB9AC \uC911...");try{let o=await this.ocrProcessor.processFile(t),a=this.ocrProcessor.generateMarkdownNote(o),l=t.basename+"_OCR.md",c=`${this.settings.inboxFolder}/${l}`;if(await this.app.vault.create(c,a),this.settings.ocrMoveOriginal){let d=this.settings.ocrOriginalFolder;this.app.vault.getAbstractFileByPath(d)||await this.app.vault.createFolder(d);let h=`${d}/${t.name}`;await this.app.fileManager.renameFile(t,h)}new we.Notice(`OCR \uC644\uB8CC: ${l} \uC0DD\uC131\uB428 (${o.pages}\uD398\uC774\uC9C0)`)}catch(o){console.error("OCR \uC624\uB958:",o),new we.Notice(`OCR \uC2E4\uD328: ${o}`)}}async processInboxOCR(){if(!this.checkApiKey())return;if(!this.settings.ocrEnabled){new we.Notice("OCR \uAE30\uB2A5\uC774 \uBE44\uD65C\uC131\uD654\uB418\uC5B4 \uC788\uC2B5\uB2C8\uB2E4");return}if(!this.ocrProcessor){new we.Notice("OCR \uD504\uB85C\uC138\uC11C\uB97C \uCD08\uAE30\uD654\uD560 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4");return}let t=this.app.vault.getAbstractFileByPath(this.settings.inboxFolder);if(!t||!(t instanceof we.TFolder)){new we.Notice("Inbox \uD3F4\uB354\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4");return}let n=["png","jpg","jpeg","webp","gif","pdf"],i=[];for(let a of t.children){if(!(a instanceof we.TFile))continue;let l=a.extension.toLowerCase();if(!n.includes(l))continue;(await this.ocrProcessor.checkLimits(a)).allowed&&i.push(a)}if(i.length===0){new we.Notice("\uCC98\uB9AC\uD560 \uD30C\uC77C\uC774 \uC5C6\uC2B5\uB2C8\uB2E4");return}new we.Notice(`${i.length}\uAC1C \uD30C\uC77C OCR \uCC98\uB9AC \uC2DC\uC791...`);let r=0,o=0;for(let a=0;a<i.length;a++){let l=i[a];try{new we.Notice(`OCR \uC911: ${a+1}/${i.length} - ${l.name}`,3e3);let c=await this.ocrProcessor.processFile(l),d=this.ocrProcessor.generateMarkdownNote(c),u=l.basename+"_OCR.md",h=`${this.settings.inboxFolder}/${u}`;if(await this.app.vault.create(h,d),this.settings.ocrMoveOriginal){let p=this.settings.ocrOriginalFolder;this.app.vault.getAbstractFileByPath(p)||await this.app.vault.createFolder(p);let _=`${p}/${l.name}`;await this.app.fileManager.renameFile(l,_)}r++,a<i.length-1&&await new Promise(p=>setTimeout(p,1e3))}catch(c){console.error(`OCR \uCC98\uB9AC \uC2E4\uD328: ${l.name}`,c),o++}}new we.Notice(`OCR \uC644\uB8CC: ${r}\uAC1C \uCC98\uB9AC, ${o}\uAC1C \uC2E4\uD328`)}async smartProcessCurrentFile(){if(!this.checkApiKey())return;let t=this.app.workspace.getActiveFile();if(!t){new we.Notice("\uC5F4\uB9B0 \uD30C\uC77C\uC774 \uC5C6\uC2B5\uB2C8\uB2E4");return}let n=t.extension.toLowerCase();if(["pdf","png","jpg","jpeg","webp","gif"].includes(n)){if(!this.settings.ocrEnabled){new we.Notice("OCR \uAE30\uB2A5\uC774 \uBE44\uD65C\uC131\uD654\uB418\uC5B4 \uC788\uC2B5\uB2C8\uB2E4");return}if(!this.ocrProcessor){new we.Notice("OCR \uD504\uB85C\uC138\uC11C\uB97C \uCD08\uAE30\uD654\uD560 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4");return}let r=await this.ocrProcessor.checkLimits(t);if(!r.allowed){new ib(this.app,r.reason,t,this).open();return}new we.Notice("\uC2A4\uB9C8\uD2B8 \uCC98\uB9AC \uC911: OCR \u2192 AI \uC694\uC57D \u2192 \uD504\uB85C\uC81D\uD2B8 \uBD84\uB958...");try{let o=await this.ocrProcessor.processFile(t);new we.Notice("AI \uC694\uC57D \uC0DD\uC131 \uC911...");let a=await this.gemini.summarizePDF(o.text,this.settings.detailedSummary),l=this.ocrProcessor.generateSummarizedNote(o,a),c=t.basename+"_OCR.md",d=`${this.settings.inboxFolder}/${c}`,u=await this.app.vault.create(d,l);if(this.settings.ocrMoveOriginal){let b=this.settings.ocrOriginalFolder;this.app.vault.getAbstractFileByPath(b)||await this.app.vault.createFolder(b);let w=`${b}/${t.name}`;await this.app.fileManager.renameFile(t,w)}let h=this.mocManager?.getProjectList()||[],p=this.feedbackManager?.generatePromptContext(),f=await this.gemini.classifyProject(l,h,p),_=await this.applyClassifyResultWithConfirmation(u,f);if(f.title&&_){let b=Xr(f.title),y=_.parent?.path||"",w=y?`${y}/${b}.md`:`${b}.md`;w!==_.path&&await this.app.fileManager.renameFile(_,w)}new we.Notice(`\uC644\uB8CC: OCR(${o.pages}p) \u2192 ${f.targetType}${f.projectName?` (${f.projectName})`:""}\uB85C \uBD84\uB958\uB428`)}catch(o){console.error("\uC2A4\uB9C8\uD2B8 \uCC98\uB9AC \uC624\uB958:",o),new we.Notice(`\uCC98\uB9AC \uC2E4\uD328: ${o}`)}}else if(n==="md")try{let r=await this.app.vault.read(t),o=this.extractEmbeddedImages(r);if(o.length>0&&this.settings.ocrEnabled&&this.ocrProcessor){new we.Notice(`\uC784\uBCA0\uB4DC\uB41C \uC774\uBBF8\uC9C0 ${o.length}\uC7A5 \uAC10\uC9C0\uB428. \uC2A4\uB9C8\uD2B8 \uCC98\uB9AC \uC911...`);let a=this.ocrProcessor.checkLimitsForMultipleImages(o);if(!a.allowed){new we.Notice(`OCR \uC81C\uD55C: ${a.reason}`),await this.classifyMarkdownContent(t,r);return}let l=await this.ocrProcessor.processMultipleImages(o,t.basename);new we.Notice("AI \uC694\uC57D \uC0DD\uC131 \uC911...");let c=await this.gemini.summarizePDF(l.text,this.settings.detailedSummary),d=`---
type: ocr
source_note: "${t.basename}"
pages: ${l.pages}
---

# ${c.title}

## \uC694\uC57D
${c.summary}

## \uD575\uC2EC \uD3EC\uC778\uD2B8
${c.keyPoints.map(_=>`- ${_}`).join(`
`)}

---
## \uC6D0\uBCF8 \uC774\uBBF8\uC9C0
${o.map(_=>`![[${_.name}]]`).join(`
`)}
`;await this.app.vault.modify(t,d);let u=this.mocManager?.getProjectList()||[],h=this.feedbackManager?.generatePromptContext(),p=await this.gemini.classifyProject(d,u,h),f=await this.applyClassifyResultWithConfirmation(t,p);if(c.title&&f){let _=Xr(c.title),b=f.parent?.path||"",y=b?`${b}/${_}.md`:`${_}.md`;y!==f.path&&(await this.app.fileManager.renameFile(f,y),f=this.app.vault.getAbstractFileByPath(y))}new we.Notice(`\uC644\uB8CC: OCR(${l.pages}\uC7A5) \u2192 ${p.targetType}${p.projectName?` (${p.projectName})`:""}`),await this.findAndShowRelatedNotes(f,d,c.title),await this.detectAndSaveSchedules(d,f);return}await this.classifyMarkdownContent(t,r)}catch(r){console.error("\uC2A4\uB9C8\uD2B8 \uCC98\uB9AC \uC624\uB958:",r),new we.Notice(`\uCC98\uB9AC \uC2E4\uD328: ${r}`)}else new we.Notice(`\uC9C0\uC6D0\uD558\uC9C0 \uC54A\uB294 \uD30C\uC77C \uD615\uC2DD\uC785\uB2C8\uB2E4: ${n}`)}getOCRDailyUsage(){return this.ocrProcessor?this.ocrProcessor.getDailyUsage():{date:Xo(this.settings.timezone),pagesProcessed:0,filesProcessed:0}}async initUsageTracker(){this.usageTracker=new lw(this.app,this.settings,()=>this.getDataPath()),await this.usageTracker.loadUsage(),this.settings.usageShowStatusBar&&(this.usageStatusBarEl=this.addStatusBarItem(),this.usageStatusBarEl.addClass("zfb-usage-statusbar"),this.usageStatusBarEl.addEventListener("click",()=>{this.app.setting.open(),this.app.setting.openTabById("zero-friction-brain")}),this.usageTracker.setStatusBarEl(this.usageStatusBarEl)),this.gemini&&this.gemini.setUsageTracker(this.usageTracker)}async toggleUsageTracker(t){t&&!this.usageTracker?await this.initUsageTracker():!t&&this.usageTracker&&(await this.usageTracker.saveUsage(),this.usageTracker=null,this.gemini&&this.gemini.setUsageTracker(null),this.usageStatusBarEl&&(this.usageStatusBarEl.remove(),this.usageStatusBarEl=null))}getDataPath(){return this.settings.dataStorageLocation==="vault"?this.settings.dataFolderPath:".obsidian/plugins/zero-friction-brain"}},OF=class extends we.Modal{constructor(e,t,n,i){super(e),this.candidates=t,this.selected=new Set(t.map((r,o)=>o)),this.sourceFile=n,this.plugin=i}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"ZK \uC544\uC774\uB514\uC5B4 \uC120\uD0DD"}),e.createEl("p",{text:"\uC0DD\uC131\uD560 Zettelkasten \uB178\uD2B8\uB97C \uC120\uD0DD\uD558\uC138\uC694",cls:"setting-item-description"});let t=e.createDiv({cls:"zk-candidate-list"});this.candidates.forEach((o,a)=>{let l=t.createDiv({cls:"zk-candidate-item"}),c=l.createEl("input",{type:"checkbox",attr:{checked:!0}});c.addEventListener("change",()=>{c.checked?this.selected.add(a):this.selected.delete(a)});let d=l.createDiv({cls:"zk-candidate-label"});d.createEl("strong",{text:o.title}),d.createEl("p",{text:o.body,cls:"zk-candidate-body"}),d.createEl("small",{text:`\uD0A4\uC6CC\uB4DC: ${o.keywords.join(", ")}`,cls:"zk-candidate-keywords"})});let n=e.createDiv({cls:"modal-button-container"});n.createEl("button",{text:"\uCDE8\uC18C"}).addEventListener("click",()=>this.close()),n.createEl("button",{text:"\uC0DD\uC131",cls:"mod-cta"}).addEventListener("click",async()=>{let o=this.candidates.filter((a,l)=>this.selected.has(l));o.length>0&&await this.plugin.createZKNotes(o,this.sourceFile),this.close()})}onClose(){this.contentEl.empty()}},$F=class extends we.Modal{constructor(e,t,n,i){super(e),this.candidate=t,this.similarNote=n,this.onResult=i}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"\uC720\uC0AC\uD55C \uB178\uD2B8 \uBC1C\uACAC"}),e.createEl("p",{text:`\uC0C8 \uC544\uC774\uB514\uC5B4\uC640 ${Math.round(this.similarNote.relevance*100)}% \uC720\uC0AC\uD55C \uB178\uD2B8\uAC00 \uC788\uC2B5\uB2C8\uB2E4.`,cls:"setting-item-description"});let t=e.createDiv({cls:"merge-section"});t.createEl("h4",{text:"\uC0C8 \uC544\uC774\uB514\uC5B4"}),t.createEl("p",{text:this.candidate.title,cls:"merge-title"}),t.createEl("p",{text:this.candidate.body,cls:"merge-body"});let n=e.createDiv({cls:"merge-section"});n.createEl("h4",{text:"\uAE30\uC874 \uB178\uD2B8"});let i=this.similarNote.note.path.split("/").pop()?.replace(/\.md$/,"")||this.similarNote.note.title;n.createEl("p",{text:i,cls:"merge-title"}),n.createEl("p",{text:`\uD0A4\uC6CC\uB4DC: ${this.similarNote.note.keywords.join(", ")}`,cls:"merge-keywords"});let r=e.createDiv({cls:"merge-buttons"});r.createEl("button",{text:"\uAE30\uC874 \uB178\uD2B8\uC5D0 \uCD94\uAC00",cls:"mod-cta"}).addEventListener("click",()=>{this.onResult(!0),this.close()}),r.createEl("button",{text:"\uC0C8 \uB178\uD2B8 \uC0DD\uC131"}).addEventListener("click",()=>{this.onResult(!1),this.close()})}onClose(){this.contentEl.empty()}},BF=class extends we.Modal{constructor(e,t){super(e),this.items=t}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"\uC624\uB298 \uC9D1\uC911\uD560 \uD504\uB85C\uC81D\uD2B8 Top 3"});let t=e.createDiv({cls:"focus-list"});this.items.forEach((r,o)=>{let a=t.createDiv({cls:"focus-item"});a.createEl("h3",{text:`${o+1}. ${r.title}`}),a.createEl("p",{text:r.why,cls:"focus-why"}),a.createEl("p",{text:`\u2192 ${r.nextAction}`,cls:"focus-action"})}),e.createDiv({cls:"modal-button-container"}).createEl("button",{text:"\uB2EB\uAE30",cls:"mod-cta"}).addEventListener("click",()=>this.close())}onClose(){this.contentEl.empty()}},ib=class extends we.Modal{constructor(e,t,n,i){super(e),this.reason=t,this.file=n,this.plugin=i}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"\uD30C\uC77C\uC774 \uB108\uBB34 \uD07D\uB2C8\uB2E4"}),e.createEl("p",{text:this.reason}),e.createEl("p",{text:"\uC124\uC815\uC5D0\uC11C \uC81C\uD55C\uC744 \uC870\uC815\uD558\uAC70\uB098, \uD30C\uC77C\uC744 \uBD84\uD560\uD574\uC11C \uCC98\uB9AC\uD558\uC138\uC694.",cls:"setting-item-description"});let t=e.createDiv({cls:"modal-button-container"});t.createEl("button",{text:"\uCDE8\uC18C"}).addEventListener("click",()=>this.close()),t.createEl("button",{text:"\uC124\uC815 \uC5F4\uAE30",cls:"mod-cta"}).addEventListener("click",()=>{this.close(),this.app.setting.open()})}onClose(){this.contentEl.empty()}},zF=class extends we.Modal{constructor(t,n,i,r,o=null){super(t);this.choiceMade=!1;this.relatedNotes=n,this.selected=new Set(n.map((a,l)=>l)),this.currentFile=i,this.finder=r,this.feedbackManager=o}recordFeedback(t,n,i){this.feedbackManager&&this.feedbackManager.addFeedback({timestamp:new Date().toISOString(),type:"related_notes",noteTitle:this.currentFile.basename,aiSuggestion:{suggestedNotePaths:this.relatedNotes.map(r=>r.note.path)},userChoice:{accepted:t.length>0,rejectedItems:n.map(r=>r.note.path),dismissed:i}})}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:"\uAD00\uB828 \uB178\uD2B8 \uBC1C\uACAC"}),t.createEl("p",{text:"\uC5F0\uACB0\uD560 \uB178\uD2B8\uB97C \uC120\uD0DD\uD558\uC138\uC694",cls:"setting-item-description"});let n=t.createDiv({cls:"related-notes-list"});this.relatedNotes.forEach((a,l)=>{let c=n.createDiv({cls:"related-note-item"}),d=c.createEl("input",{type:"checkbox",attr:{checked:!0}});d.addEventListener("change",()=>{d.checked?this.selected.add(l):this.selected.delete(l)});let u=c.createDiv({cls:"related-note-label"}),h=a.note.path.split("/").pop()?.replace(/\.md$/,"")||a.note.title;u.createEl("strong",{text:h});let p=Math.round(a.relevance*100);u.createEl("span",{text:` (${p}%)`,cls:"related-note-relevance"}),a.matchedKeywords.length>0&&u.createEl("small",{text:`\uD0A4\uC6CC\uB4DC: ${a.matchedKeywords.join(", ")}`,cls:"related-note-keywords"})});let i=t.createDiv({cls:"modal-button-container"});i.createEl("button",{text:"\uAC74\uB108\uB6F0\uAE30"}).addEventListener("click",()=>{this.choiceMade=!0,this.recordFeedback([],this.relatedNotes,!1),this.close()}),i.createEl("button",{text:"\uB9C1\uD06C \uCD94\uAC00",cls:"mod-cta"}).addEventListener("click",async()=>{this.choiceMade=!0;let a=this.relatedNotes.filter((c,d)=>this.selected.has(d)),l=this.relatedNotes.filter((c,d)=>!this.selected.has(d));this.recordFeedback(a,l,!1),a.length>0&&(await this.finder.addRelatedLinks(this.currentFile,a),new we.Notice(`${a.length}\uAC1C \uAD00\uB828 \uB178\uD2B8 \uB9C1\uD06C \uCD94\uAC00\uB428`)),this.close()})}onClose(){this.choiceMade||this.recordFeedback([],this.relatedNotes,!0),this.contentEl.empty()}},UF=class extends we.Modal{constructor(e,t,n,i,r,o){super(e),this.projectName=t,this.noteFile=n,this.noteTitle=i,this.mocManager=r,this.projectsFolder=o}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"\uC0C8 \uD504\uB85C\uC81D\uD2B8 \uAC10\uC9C0"}),e.createEl("p",{text:`"${this.projectName}" \uD504\uB85C\uC81D\uD2B8\uAC00 \uC0C8\uB85C \uAC10\uC9C0\uB418\uC5C8\uC2B5\uB2C8\uB2E4.`}),e.createEl("p",{text:"\uC774 \uD504\uB85C\uC81D\uD2B8\uC758 MOC(Map of Content)\uB97C \uC0DD\uC131\uD560\uAE4C\uC694?",cls:"setting-item-description"});let t=e.createDiv({cls:"modal-button-container"});t.createEl("button",{text:"\uAC74\uB108\uB6F0\uAE30"}).addEventListener("click",()=>this.close()),t.createEl("button",{text:"MOC \uC0DD\uC131",cls:"mod-cta"}).addEventListener("click",async()=>{await this.mocManager.createProjectMOC(this.projectName,this.projectsFolder)?(await this.mocManager.addNoteToMOC(this.projectName,this.noteTitle,this.noteFile.path),new we.Notice(`\u{1F4C1} ${this.projectName} MOC \uC0DD\uC131 \uBC0F \uC5F0\uACB0 \uC644\uB8CC`)):new we.Notice("MOC\uAC00 \uC774\uBBF8 \uC874\uC7AC\uD569\uB2C8\uB2E4"),this.close()})}onClose(){this.contentEl.empty()}},VF=class extends we.Modal{constructor(e,t,n){super(e),this.mocManager=t,this.projectsFolder=n}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"\uD504\uB85C\uC81D\uD2B8 MOC \uC0DD\uC131"}),e.createEl("p",{text:"\uC0C8 \uD504\uB85C\uC81D\uD2B8 MOC\uB97C \uC0DD\uC131\uD569\uB2C8\uB2E4. \uD504\uB85C\uC81D\uD2B8 \uC774\uB984\uC744 \uC785\uB825\uD558\uC138\uC694.",cls:"setting-item-description"});let t=e.createDiv({cls:"moc-input-container"});if(t.createEl("label",{text:"\uD504\uB85C\uC81D\uD2B8 \uC774\uB984:"}),this.inputEl=t.createEl("input",{type:"text",placeholder:"\uC608: \uC2A4\uB9C8\uD2B8\uD31C"}),this.inputEl.style.width="100%",this.inputEl.style.marginTop="8px",this.inputEl.style.padding="8px",this.inputEl.addEventListener("keydown",o=>{o.key==="Enter"&&this.createMOC()}),this.mocManager&&this.mocManager.getMOCCount()>0){let o=e.createDiv({cls:"existing-mocs"});o.createEl("h4",{text:"\uAE30\uC874 \uD504\uB85C\uC81D\uD2B8 MOC:"});let a=o.createEl("ul");for(let l of this.mocManager.getProjectList())a.createEl("li",{text:l})}let n=e.createDiv({cls:"modal-button-container"});n.createEl("button",{text:"\uCDE8\uC18C"}).addEventListener("click",()=>this.close()),n.createEl("button",{text:"\uC0DD\uC131",cls:"mod-cta"}).addEventListener("click",()=>this.createMOC()),setTimeout(()=>this.inputEl.focus(),10)}async createMOC(){let e=this.inputEl.value.trim();if(!e){new we.Notice("\uD504\uB85C\uC81D\uD2B8 \uC774\uB984\uC744 \uC785\uB825\uD558\uC138\uC694");return}if(!this.mocManager){new we.Notice("MOC \uAD00\uB9AC\uC790\uAC00 \uCD08\uAE30\uD654\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4"),this.close();return}if(this.mocManager.getProjectList().includes(e)){new we.Notice(`"${e}" MOC\uAC00 \uC774\uBBF8 \uC874\uC7AC\uD569\uB2C8\uB2E4`);return}let n=await this.mocManager.createProjectMOC(e,this.projectsFolder);n?(new we.Notice(`\u{1F4C1} ${e} MOC \uC0DD\uC131 \uC644\uB8CC`),this.app.workspace.getLeaf().openFile(n)):new we.Notice("MOC \uC0DD\uC131\uC5D0 \uC2E4\uD328\uD588\uC2B5\uB2C8\uB2E4"),this.close()}onClose(){this.contentEl.empty()}},GF=class extends we.Modal{constructor(e,t,n,i,r){super(e),this.title=t,this.description=n,this.placeholder=i,this.onSubmit=r}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:this.title}),e.createEl("p",{text:this.description,cls:"setting-item-description"});let t=e.createDiv({cls:"url-input-container"});this.inputEl=t.createEl("input",{type:"text",placeholder:this.placeholder}),this.inputEl.style.width="100%",this.inputEl.style.padding="8px",navigator.clipboard.readText().then(o=>{o&&(o.startsWith("http://")||o.startsWith("https://"))&&(this.inputEl.value=o)}).catch(()=>{}),this.inputEl.addEventListener("keydown",o=>{o.key==="Enter"&&this.submit()});let n=e.createDiv({cls:"modal-button-container"});n.createEl("button",{text:"\uCDE8\uC18C"}).addEventListener("click",()=>this.close()),n.createEl("button",{text:"\uAC00\uC838\uC624\uAE30",cls:"mod-cta"}).addEventListener("click",()=>this.submit()),setTimeout(()=>this.inputEl.focus(),10)}async submit(){let e=this.inputEl.value.trim();if(!e){new we.Notice("URL\uC744 \uC785\uB825\uD558\uC138\uC694");return}this.close(),await this.onSubmit(e)}onClose(){this.contentEl.empty()}},WF=class extends we.Modal{constructor(e,t,n,i){super(e),this.sections=t,this.selected=new Set(t.map((r,o)=>o)),this.sourceFile=n,this.plugin=i}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"\uC2A4\uB9C8\uD2B8 \uBD84\uB9AC \uACB0\uACFC"}),e.createEl("p",{text:`${this.sections.length}\uAC1C\uC758 \uC139\uC158\uC73C\uB85C \uBD84\uB9AC\uB428. \uC0DD\uC131\uD560 \uB178\uD2B8\uB97C \uC120\uD0DD\uD558\uC138\uC694.`,cls:"setting-item-description"});let t=e.createDiv({cls:"split-section-list"});this.sections.forEach((o,a)=>{let l=t.createDiv({cls:"split-section-item"});l.style.marginBottom="16px",l.style.padding="12px",l.style.border="1px solid var(--background-modifier-border)",l.style.borderRadius="8px";let c=l.createDiv({cls:"split-section-header"});c.style.display="flex",c.style.alignItems="center",c.style.gap="8px";let d=c.createEl("input",{type:"checkbox",attr:{checked:!0}});d.addEventListener("change",()=>{d.checked?this.selected.add(a):this.selected.delete(a)}),c.createEl("strong",{text:o.title});let u=c.createDiv({cls:"split-section-badges"});u.style.marginLeft="auto",u.style.display="flex",u.style.gap="4px";let h=u.createEl("span",{text:o.targetType,cls:"split-category-badge"});if(h.style.padding="2px 8px",h.style.borderRadius="4px",h.style.fontSize="12px",h.style.backgroundColor=this.getTargetTypeColor(o.targetType),h.style.color="white",o.project){let _=u.createEl("span",{text:o.project.startsWith("NEW:")?`\u2728 ${o.project.slice(4)}`:`\u{1F4C1} ${o.project}`,cls:"split-project-badge"});_.style.padding="2px 8px",_.style.borderRadius="4px",_.style.fontSize="12px",_.style.backgroundColor="var(--interactive-accent)",_.style.color="white"}let p=l.createDiv({cls:"split-section-preview"});p.style.marginTop="8px",p.style.fontSize="13px",p.style.color="var(--text-muted)",p.style.maxHeight="60px",p.style.overflow="hidden",p.style.textOverflow="ellipsis";let f=o.content.length>150?o.content.slice(0,150)+"...":o.content;if(p.setText(f),o.keywords.length>0){let _=l.createDiv({cls:"split-section-keywords"});_.style.marginTop="8px",_.style.fontSize="12px",_.setText(`\uD0A4\uC6CC\uB4DC: ${o.keywords.join(", ")}`)}});let n=e.createDiv({cls:"modal-button-container"});n.style.marginTop="16px",n.createEl("button",{text:"\uCDE8\uC18C"}).addEventListener("click",()=>this.close()),n.createEl("button",{text:`${this.selected.size}\uAC1C \uB178\uD2B8 \uC0DD\uC131`,cls:"mod-cta"}).addEventListener("click",async()=>{let o=this.sections.filter((a,l)=>this.selected.has(l));o.length>0&&(this.close(),await this.plugin.createSplitNotes(o,this.sourceFile))})}getTargetTypeColor(e){switch(e){case"project":return"#e67e22";case"library":return"#27ae60";case"archive":return"#95a5a6";default:return"#7f8c8d"}}onClose(){this.contentEl.empty()}},HF=class extends we.Modal{constructor(t,n,i,r=null){super(t);this.choiceMade=!1;this.result=n,this.onChoice=i,this.feedbackManager=r}recordFeedback(t){this.feedbackManager&&this.feedbackManager.addFeedback({timestamp:new Date().toISOString(),type:"reference_location",noteTitle:this.result.title,aiSuggestion:{targetType:this.result.targetType,projectName:this.result.projectName},userChoice:{accepted:t!==null&&this.result.targetType==="project"&&t==="project",modified:t||void 0,dismissed:t===null}})}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:"\uC800\uC7A5 \uC704\uCE58 \uC120\uD0DD"});let n=t.createDiv({cls:"reference-confirm-info"});n.style.marginBottom="16px",n.style.padding="12px",n.style.backgroundColor="var(--background-secondary)",n.style.borderRadius="8px",n.createEl("p",{text:`"${this.result.title}"`,cls:"reference-title"}).style.fontWeight="bold",n.createEl("p",{text:`\uAD00\uB828 \uD504\uB85C\uC81D\uD2B8: ${this.result.projectName}`,cls:"reference-project"}).style.color="var(--text-muted)",n.createEl("p",{text:"\uC774 \uC790\uB8CC\uB294 \uC678\uBD80 \uCC38\uACE0\uC790\uB8CC\uB85C \uBCF4\uC785\uB2C8\uB2E4. \uC5B4\uB514\uC5D0 \uC800\uC7A5\uD560\uAE4C\uC694?",cls:"reference-question"}).style.marginTop="8px";let i=t.createDiv({cls:"reference-options"});i.style.display="flex",i.style.flexDirection="column",i.style.gap="12px";let r=i.createDiv({cls:"reference-option"});r.style.padding="12px",r.style.border="1px solid var(--background-modifier-border)",r.style.borderRadius="8px",r.style.cursor="pointer",r.addEventListener("mouseenter",()=>{r.style.backgroundColor="var(--background-secondary)"}),r.addEventListener("mouseleave",()=>{r.style.backgroundColor=""}),r.createEl("strong",{text:"\u{1F4C1} \uD504\uB85C\uC81D\uD2B8 \uD3F4\uB354\uC5D0 \uC800\uC7A5"}),r.createEl("p",{text:`Projects/${this.result.projectName}/ \uC5D0 \uC800\uC7A5`,cls:"option-desc"}).style.color="var(--text-muted)",r.createEl("small",{text:"\uC774 \uD504\uB85C\uC81D\uD2B8 \uC804\uC6A9 \uC790\uB8CC\uB85C \uAD00\uB9AC"}).style.color="var(--text-faint)",r.addEventListener("click",()=>{this.choiceMade=!0,this.recordFeedback("project"),this.close(),this.onChoice("project")});let o=i.createDiv({cls:"reference-option"});o.style.padding="12px",o.style.border="2px solid var(--interactive-accent)",o.style.borderRadius="8px",o.style.cursor="pointer",o.style.backgroundColor="var(--background-secondary)",o.createEl("strong",{text:"\u{1F4DA} Library\uC5D0 \uC800\uC7A5 + \uD504\uB85C\uC81D\uD2B8 \uB9C1\uD06C (\uAD8C\uC7A5)"}),o.createEl("p",{text:"Library/ \uC5D0 \uC800\uC7A5\uD558\uACE0 \uD504\uB85C\uC81D\uD2B8\uC640 \uC5F0\uACB0",cls:"option-desc"}).style.color="var(--text-muted)",o.createEl("small",{text:"\uB2E4\uB978 \uD504\uB85C\uC81D\uD2B8\uC5D0\uC11C\uB3C4 \uC7AC\uC0AC\uC6A9 \uAC00\uB2A5"}).style.color="var(--text-faint)",o.addEventListener("click",()=>{this.choiceMade=!0,this.recordFeedback("library"),this.close(),this.onChoice("library")});let a=t.createDiv({cls:"modal-button-container"});a.style.marginTop="16px",a.createEl("button",{text:"\uCDE8\uC18C"}).addEventListener("click",()=>this.close())}onClose(){this.choiceMade||this.recordFeedback(null),this.contentEl.empty()}},jF=class extends we.Modal{constructor(e,t){super(e),this.plugin=t}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("zfb-command-list-modal");let t=e.createEl("h2",{text:"\u{1F9E0} Zero Friction Brain"});t.style.marginBottom="16px",t.style.textAlign="center";let n=[{name:"\uD504\uB85C\uC81D\uD2B8 \uBD84\uB958",hotkey:"Ctrl+Shift+G",icon:"folder",action:()=>this.plugin.classifyCurrentFile()},{name:"\uAD00\uB828 \uB178\uD2B8 \uC5F0\uACB0",hotkey:"Ctrl+Shift+L",icon:"link",action:()=>this.plugin.linkRelatedNotesForCurrentFile()},{name:"\uC2A4\uB9C8\uD2B8 \uCC98\uB9AC (OCR+\uBD84\uB958)",hotkey:"Ctrl+Shift+S",icon:"sparkles",action:()=>this.plugin.smartProcessCurrentFile()},{name:"\uC2A4\uB9C8\uD2B8 \uBD84\uB9AC",hotkey:"Ctrl+Shift+D",icon:"split",action:()=>this.plugin.smartSplitCurrentFile()},{name:"ZK \uCD94\uCD9C",hotkey:"Ctrl+Shift+Z",icon:"file-plus",action:()=>this.plugin.extractZKFromCurrentFile()},{name:"URL \uAC00\uC838\uC624\uAE30",hotkey:"Ctrl+Shift+U",icon:"globe",action:()=>this.plugin.showURLImportModal()},{name:"Focus Top 3",hotkey:"Ctrl+Shift+;",icon:"target",action:()=>this.plugin.showFocusTop3()},{name:"\uB9AC\uBDF0/\uD68C\uACE0 \uBAA8\uB4DC",hotkey:"Ctrl+Shift+R",icon:"calendar-check",action:()=>this.plugin.showReviewModal()},{name:"OCR \uCD94\uCD9C",hotkey:"Ctrl+Shift+O",icon:"scan",action:()=>this.plugin.ocrCurrentFile()},{divider:!0},{name:"Inbox \uC804\uCCB4 \uCC98\uB9AC",hotkey:"",icon:"inbox",action:()=>this.plugin.processInbox()},{name:"\uD504\uB85C\uC81D\uD2B8 MOC \uC0DD\uC131",hotkey:"",icon:"map",action:()=>this.plugin.showCreateMOCModal()},{name:"ZK Index \uC7AC\uAD6C\uCD95",hotkey:"",icon:"refresh-cw",action:()=>this.plugin.rebuildZKIndex()},{name:"Watch \uD1A0\uAE00",hotkey:"",icon:"eye",action:()=>this.plugin.toggleWatch()}],i=e.createDiv({cls:"zfb-command-list"});i.style.display="flex",i.style.flexDirection="column",i.style.gap="4px";for(let a of n){if("divider"in a&&a.divider){let u=i.createEl("hr");u.style.margin="8px 0",u.style.border="none",u.style.borderTop="1px solid var(--background-modifier-border)";continue}let l=i.createDiv({cls:"zfb-command-item"});l.style.display="flex",l.style.alignItems="center",l.style.justifyContent="space-between",l.style.padding="10px 12px",l.style.borderRadius="6px",l.style.cursor="pointer",l.style.transition="background-color 0.1s",l.addEventListener("mouseenter",()=>{l.style.backgroundColor="var(--background-secondary)"}),l.addEventListener("mouseleave",()=>{l.style.backgroundColor=""});let c=l.createDiv();c.style.display="flex",c.style.alignItems="center",c.style.gap="10px";let d=c.createSpan({cls:"zfb-command-icon"});if((0,we.setIcon)(d,a.icon||"command"),d.style.opacity="0.7",c.createSpan({text:a.name}),a.hotkey){let u=l.createSpan({text:a.hotkey,cls:"zfb-command-hotkey"});u.style.fontSize="0.85em",u.style.color="var(--text-muted)",u.style.backgroundColor="var(--background-secondary)",u.style.padding="2px 8px",u.style.borderRadius="4px",u.style.fontFamily="monospace"}l.addEventListener("click",()=>{this.close(),a.action()})}let r=e.createDiv({cls:"zfb-command-footer"});r.style.marginTop="16px",r.style.paddingTop="12px",r.style.borderTop="1px solid var(--background-modifier-border)",r.style.textAlign="center",r.style.color="var(--text-muted)",r.style.fontSize="0.85em",r.createSpan({text:`v${this.plugin.manifest.version} \u2022 `});let o=r.createEl("a",{text:"\uC124\uC815"});o.style.cursor="pointer",o.addEventListener("click",()=>{this.close(),this.app.setting.open(),this.app.setting.openTabById("zero-friction-brain")})}onClose(){this.contentEl.empty()}},qF=class extends we.Modal{constructor(t,n,i){super(t);this.selectedPeriod="week";this.resultContainer=null;this.isLoading=!1;this.reviewManager=n,this.settings=i}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("zfb-review-modal"),t.createEl("h2",{text:"\uB9AC\uBDF0/\uD68C\uACE0 \uBAA8\uB4DC"});let n=t.createDiv({cls:"zfb-review-period-section"});n.createEl("label",{text:"\uAE30\uAC04 \uC120\uD0DD:",cls:"setting-item-name"});let i=n.createDiv({cls:"zfb-period-buttons"});i.style.display="flex",i.style.gap="8px",i.style.marginTop="8px",i.style.marginBottom="16px",[{value:"today",label:"\uC624\uB298"},{value:"week",label:"\uC774\uBC88 \uC8FC"},{value:"month",label:"\uC774\uBC88 \uB2EC"}].forEach(({value:p,label:f})=>{let _=i.createEl("button",{text:f});_.style.padding="8px 16px",_.style.borderRadius="6px",_.style.cursor="pointer",p===this.selectedPeriod&&_.addClass("mod-cta"),_.addEventListener("click",()=>{this.selectedPeriod=p,i.querySelectorAll("button").forEach(b=>b.removeClass("mod-cta")),_.addClass("mod-cta"),this.loadNotes()})});let o=t.createDiv({cls:"zfb-review-filter-section"});o.style.marginBottom="16px",o.createEl("label",{text:"\uD504\uB85C\uC81D\uD2B8 \uD544\uD130 (\uC120\uD0DD):",cls:"setting-item-name"});let a=o.createEl("select");a.style.marginLeft="8px",a.style.padding="4px 8px";let l=a.createEl("option",{text:"\uC804\uCCB4",value:""});l.value="",this.reviewManager.getProjectList().forEach(p=>{let f=a.createEl("option",{text:p,value:p});f.value=p}),a.addEventListener("change",()=>{this.projectFilter=a.value||void 0,this.loadNotes()}),this.resultContainer=t.createDiv({cls:"zfb-review-results"}),this.resultContainer.style.marginTop="16px",this.resultContainer.style.maxHeight="400px",this.resultContainer.style.overflowY="auto";let d=t.createDiv({cls:"modal-button-container"});d.style.marginTop="16px",d.createEl("button",{text:"\uB2EB\uAE30"}).addEventListener("click",()=>this.close()),d.createEl("button",{text:"AI \uBD84\uC11D \uBC0F \uD68C\uACE0 \uB178\uD2B8 \uC0DD\uC131",cls:"mod-cta"}).addEventListener("click",()=>this.createReviewNote()),this.loadNotes()}async loadNotes(){if(!(!this.resultContainer||this.isLoading)){this.isLoading=!0,this.resultContainer.empty(),this.resultContainer.createEl("p",{text:"\uB178\uD2B8 \uC218\uC9D1 \uC911...",cls:"zfb-loading"});try{let t={period:this.selectedPeriod,projectFilter:this.projectFilter},n=await this.reviewManager.collectNotes(t),i=this.reviewManager.groupByProject(n);this.renderResults(n,i)}catch(t){console.error("\uB178\uD2B8 \uC218\uC9D1 \uC2E4\uD328:",t),this.resultContainer.empty(),this.resultContainer.createEl("p",{text:`\uC624\uB958: ${t}`,cls:"zfb-error"})}finally{this.isLoading=!1}}}renderResults(t,n){if(!this.resultContainer)return;if(this.resultContainer.empty(),t.length===0){this.resultContainer.createEl("p",{text:"\uD574\uB2F9 \uAE30\uAC04\uC5D0 \uC791\uC5C5\uD55C \uB178\uD2B8\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.",cls:"zfb-empty-message"});return}let i=this.resultContainer.createDiv({cls:"zfb-review-summary"});i.style.padding="12px",i.style.backgroundColor="var(--background-secondary)",i.style.borderRadius="8px",i.style.marginBottom="16px";let r=Vm(this.selectedPeriod,this.settings.timezone);i.createEl("p",{text:`${r.label} \uC791\uC5C5: ${t.length}\uAC1C \uB178\uD2B8, ${n.length}\uAC1C \uD504\uB85C\uC81D\uD2B8/\uC601\uC5ED`});for(let o of n){let a=this.resultContainer.createDiv({cls:"zfb-review-group"});a.style.marginBottom="16px";let l=a.createEl("h4",{text:`\u{1F4C1} ${o.projectName} (${o.noteCount}\uAC1C)`});l.style.marginBottom="8px",l.style.borderBottom="1px solid var(--background-modifier-border)",l.style.paddingBottom="4px";let c=a.createEl("ul");c.style.listStyle="none",c.style.paddingLeft="16px",c.style.margin="0";for(let d of o.notes){let u=c.createEl("li");u.style.display="flex",u.style.justifyContent="space-between",u.style.alignItems="center",u.style.padding="4px 0";let h=u.createEl("a",{text:d.title});h.style.cursor="pointer",h.style.color="var(--text-accent)",h.addEventListener("click",async()=>{this.app.vault.getAbstractFileByPath(d.path)instanceof we.TFile&&await this.app.workspace.openLinkText(d.path,"")});let p=u.createEl("span",{text:OB(d.modified),cls:"zfb-note-time"});p.style.fontSize="0.85em",p.style.color="var(--text-muted)"}}}async createReviewNote(){if(!this.isLoading){this.isLoading=!0,new we.Notice("AI \uBD84\uC11D \uC911...");try{let t={period:this.selectedPeriod,projectFilter:this.projectFilter},n=await this.reviewManager.analyze(t),i=await this.reviewManager.createReviewNote(n);new we.Notice(`\uD68C\uACE0 \uB178\uD2B8 \uC0DD\uC131\uB428: ${i.basename}`),await this.app.workspace.openLinkText(i.path,""),this.close()}catch(t){console.error("\uD68C\uACE0 \uB178\uD2B8 \uC0DD\uC131 \uC2E4\uD328:",t),new we.Notice(`\uC0DD\uC131 \uC2E4\uD328: ${t}`)}finally{this.isLoading=!1}}}onClose(){this.contentEl.empty()}};
/*! Bundled license information:

@google/genai/dist/web/index.mjs:
  (**
   * @license
   * Copyright 2025 Google LLC
   * SPDX-License-Identifier: Apache-2.0
   *)

@google/genai/dist/web/index.mjs:
  (**
   * @license
   * Copyright 2025 Google LLC
   * SPDX-License-Identifier: Apache-2.0
   *)

@google/genai/dist/web/index.mjs:
  (**
   * @license
   * Copyright 2025 Google LLC
   * SPDX-License-Identifier: Apache-2.0
   *)

@google/genai/dist/web/index.mjs:
  (**
   * @license
   * Copyright 2025 Google LLC
   * SPDX-License-Identifier: Apache-2.0
   *)

@google/genai/dist/web/index.mjs:
  (**
   * @license
   * Copyright 2025 Google LLC
   * SPDX-License-Identifier: Apache-2.0
   *)

onnxruntime-web/dist/ort.bundle.min.mjs:
  (*!
   * ONNX Runtime Web v1.22.0-dev.20250409-89f8206ba4
   * Copyright (c) Microsoft Corporation. All rights reserved.
   * Licensed under the MIT License.
   *)

onnxruntime-web/dist/ort.bundle.min.mjs:
  (**
   * @license
   * Copyright 2021 Google LLC. All Rights Reserved.
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   * http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   * =============================================================================
   *)
  (**
   * @license
   * Copyright 2020 Google LLC. All Rights Reserved.
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   * http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   * =============================================================================
   *)
  (**
   * @license
   * Copyright 2019 Google LLC. All Rights Reserved.
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   * http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   * =============================================================================
   *)

@huggingface/transformers/dist/transformers.web.js:
  (*!*****************************!*\
    !*** ./src/transformers.js ***!
    \*****************************)
*/
